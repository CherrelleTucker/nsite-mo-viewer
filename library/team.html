<!-- Team: Internal team profiles, availability, and office meetings -->

<div class="team-viewer">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title">
      <h1>Team</h1>
      <p class="page-subtitle">NSITE MO Team &amp; Office Schedule</p>
    </div>
    <div class="page-actions">
      <div class="view-toggle">
        <button class="view-btn active" data-view="overview" onclick="Team.setView('overview')">
          <span class="material-icons">apps</span>
          <span>Overview</span>
        </button>
        <button class="view-btn" data-view="meetings" onclick="Team.setView('meetings')">
          <span class="material-icons">calendar_today</span>
          <span>Meetings</span>
        </button>
        <button class="view-btn" data-view="documents" onclick="Team.setView('documents')">
          <span class="material-icons">description</span>
          <span>Documents</span>
        </button>
      </div>
      <button class="btn btn-primary" id="addEntryBtn" onclick="Team.showAddModal()">
        <span class="material-icons">add</span>
        <span id="addEntryLabel">Add Availability</span>
      </button>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">group</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statTeamMembers">--</span>
        <span class="stat-label">Team Members</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">calendar_today</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statMeetingsThisWeek">--</span>
        <span class="stat-label">Meetings This Week</span>
      </div>
    </div>
    <div class="stat-card stat-warning">
      <div class="stat-icon"><span class="material-icons">person_off</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statOutThisWeek">--</span>
        <span class="stat-label">Out This Week</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">description</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statDocuments">--</span>
        <span class="stat-label">Directing Docs</span>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="team-content">
    <!-- Overview View (default) -->
    <div class="view-panel active" id="overviewView">
      <!-- Two column layout -->
      <div class="team-grid">
        <!-- Left: Team Profiles -->
        <div class="team-profiles-section">
          <div class="section-header">
            <h2>Team Members</h2>
            <div class="team-filter">
              <select id="teamFilterSelect" onchange="Team.filterTeam(this.value)">
                <option value="all">All Teams</option>
                <option value="Leadership">Leadership</option>
                <option value="Assessment">Assessment</option>
                <option value="SEP">SEP</option>
                <option value="Comms">Comms</option>
                <option value="Operations">Operations</option>
                <option value="Implementation">Implementation</option>
              </select>
            </div>
          </div>
          <div class="team-grid-cards" id="teamProfilesGrid">
            <div class="loading-state">
              <span class="loading-spinner"></span>
              <span>Loading team...</span>
            </div>
          </div>
        </div>

        <!-- Right: Availability Calendar -->
        <div class="availability-section">
          <div class="section-header">
            <h2>Office Availability</h2>
            <button class="btn btn-sm btn-secondary" onclick="Team.showAddAvailabilityModal()">
              <span class="material-icons">add</span>
              Add
            </button>
          </div>
          <div class="availability-list" id="availabilityList">
            <div class="loading-state">
              <span class="loading-spinner"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Meetings View -->
    <div class="view-panel" id="meetingsView">
      <div class="meetings-layout">
        <!-- Weekly Schedule Grid -->
        <div class="meetings-schedule-section">
          <div class="section-header">
            <h2>Weekly Schedule</h2>
            <div class="meeting-filters">
              <select id="meetingCategoryFilter" onchange="Team.filterMeetings()">
                <option value="all">All Categories</option>
                <option value="MO">MO</option>
                <option value="Assessment">Assessment</option>
                <option value="SEP">SEP</option>
                <option value="Comms">Comms</option>
                <option value="Implementation">Implementation</option>
                <option value="Operations">Operations</option>
                <option value="Ad Hoc">Ad Hoc</option>
              </select>
              <select id="meetingTypeFilter" onchange="Team.filterMeetings()">
                <option value="all">All Types</option>
                <option value="Planning">Planning</option>
                <option value="Working">Working</option>
                <option value="Brainstorm">Brainstorm</option>
                <option value="Status/Sync">Status/Sync</option>
                <option value="Review">Review</option>
                <option value="Training">Training</option>
              </select>
            </div>
          </div>
          <div class="weekly-grid" id="weeklyMeetingGrid">
            <div class="day-column" data-day="Monday">
              <div class="day-header">Monday</div>
              <div class="day-meetings" id="meetingsMonday"></div>
            </div>
            <div class="day-column" data-day="Tuesday">
              <div class="day-header">Tuesday</div>
              <div class="day-meetings" id="meetingsTuesday"></div>
            </div>
            <div class="day-column" data-day="Wednesday">
              <div class="day-header">Wednesday</div>
              <div class="day-meetings" id="meetingsWednesday"></div>
            </div>
            <div class="day-column" data-day="Thursday">
              <div class="day-header">Thursday</div>
              <div class="day-meetings" id="meetingsThursday"></div>
            </div>
            <div class="day-column" data-day="Friday">
              <div class="day-header">Friday</div>
              <div class="day-meetings" id="meetingsFriday"></div>
            </div>
          </div>
        </div>

        <!-- Meeting List with Expandable Details -->
        <div class="meetings-list-section">
          <div class="section-header">
            <h2>All Meetings</h2>
            <button class="btn btn-sm btn-primary" onclick="Team.showAddMeetingModal()">
              <span class="material-icons">add</span>
              Add Meeting
            </button>
          </div>
          <div class="meetings-list" id="meetingsList">
            <div class="loading-state">
              <span class="loading-spinner"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents View -->
    <div class="view-panel" id="documentsView">
      <div class="documents-section">
        <div class="section-header">
          <h2>Directing Documents</h2>
          <p class="section-description">Governing documents and policies for NSITE MO</p>
        </div>
        <div class="documents-grid" id="directingDocsList">
          <div class="loading-state">
            <span class="loading-spinner"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Availability Modal -->
<div class="modal" id="addAvailabilityModal">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h3>Add Availability Entry</h3>
      <button class="modal-close" onclick="Team.closeModal('addAvailabilityModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="availabilityForm">
        <div class="form-group" id="personSelectGroup">
          <label>Team Member</label>
          <select id="availPersonSelect">
            <option value="">Select person...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="availTypeSelect" required onchange="Team.toggleFormFields()">
            <option value="">Select type...</option>
            <optgroup label="Personal">
              <option value="vacation">Vacation</option>
              <option value="work_travel">Work Travel</option>
              <option value="ooo">Out of Office</option>
              <option value="9_80">9/80 Schedule</option>
            </optgroup>
            <optgroup label="Office-Wide">
              <option value="holiday">Holiday</option>
              <option value="special_event">Special Event</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group hidden" id="holidayNameGroup">
          <label>Holiday Name</label>
          <input type="text" id="availHolidayName" placeholder="e.g., Memorial Day, Independence Day">
        </div>
        <div class="form-group hidden" id="partnersGroup">
          <label>Affected Partners</label>
          <div class="checkbox-group" id="partnerCheckboxes">
            <label class="checkbox-label"><input type="checkbox" name="partners" value="NASA"> NASA</label>
            <label class="checkbox-label"><input type="checkbox" name="partners" value="UAH"> UAH</label>
            <label class="checkbox-label"><input type="checkbox" name="partners" value="DevSeed"> DevSeed</label>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="availStartDate" required>
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="date" id="availEndDate" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Recurrence</label>
            <select id="availRecurrence">
              <option value="none">Does not repeat</option>
              <option value="weekly">Weekly</option>
              <option value="biweekly">Every 2 weeks</option>
              <option value="monthly">Monthly</option>
              <option value="annually">Annually</option>
            </select>
          </div>
          <div class="form-group" id="locationGroup">
            <label>Location (optional)</label>
            <input type="text" id="availLocation" placeholder="e.g., AGU Conference, HQ">
          </div>
        </div>
        <div class="form-group">
          <label>Notes (optional)</label>
          <textarea id="availNotes" rows="2"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="Team.closeModal('addAvailabilityModal')">Cancel</button>
      <button class="btn btn-primary" id="saveAvailabilityBtn" onclick="Team.saveAvailability()">
        <span class="btn-text">Save</span>
        <span class="btn-loading" style="display:none;"><span class="loading-spinner-sm"></span> Saving...</span>
      </button>
    </div>
  </div>
</div>

<!-- Add Meeting Modal -->
<div class="modal" id="addMeetingModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add Meeting</h3>
      <button class="modal-close" onclick="Team.closeModal('addMeetingModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="meetingForm">
        <div class="form-group">
          <label>Meeting Name</label>
          <input type="text" id="meetingName" required placeholder="e.g., Weekly Sync">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Category</label>
            <select id="meetingCategory" required>
              <option value="MO">MO</option>
              <option value="Assessment">Assessment</option>
              <option value="SEP">SEP</option>
              <option value="Comms">Comms</option>
              <option value="Implementation">Implementation</option>
              <option value="Operations">Operations</option>
              <option value="Ad Hoc">Ad Hoc</option>
            </select>
          </div>
          <div class="form-group">
            <label>Type</label>
            <select id="meetingType" required>
              <option value="Planning">Planning</option>
              <option value="Working">Working</option>
              <option value="Brainstorm">Brainstorm</option>
              <option value="Status/Sync">Status/Sync</option>
              <option value="Review">Review</option>
              <option value="Training">Training</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Cadence</label>
            <select id="meetingCadence" required>
              <option value="Weekly">Weekly</option>
              <option value="Bi-Weekly">Bi-Weekly</option>
              <option value="Tri-Weekly">Tri-Weekly</option>
              <option value="Monthly">Monthly</option>
              <option value="Quarterly">Quarterly</option>
              <option value="Annual">Annual</option>
              <option value="Ad Hoc">Ad Hoc</option>
            </select>
          </div>
          <div class="form-group">
            <label>Day of Week</label>
            <select id="meetingDay">
              <option value="">Not set</option>
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Time</label>
            <input type="text" id="meetingTime" placeholder="e.g., 2:00 PM">
          </div>
          <div class="form-group">
            <label>Duration (minutes)</label>
            <input type="number" id="meetingDuration" value="60">
          </div>
        </div>
        <div class="form-group">
          <label>Purpose</label>
          <textarea id="meetingPurpose" rows="2" placeholder="What problem does this meeting solve?"></textarea>
        </div>
        <div class="form-group">
          <label>Online Meeting Link</label>
          <input type="url" id="meetingLink" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Drive Folder URL</label>
          <input type="url" id="meetingDriveFolder" placeholder="https://drive.google.com/...">
        </div>
        <hr style="margin: var(--space-md) 0;">
        <h4 style="margin-bottom: var(--space-sm);">Resource Links (optional)</h4>
        <div class="form-group">
          <label>Agenda URL</label>
          <input type="url" id="meetingAgendaUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Notes URL</label>
          <input type="url" id="meetingNotesUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Slides URL</label>
          <input type="url" id="meetingSlidesUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Recording URL</label>
          <input type="url" id="meetingRecordingUrl" placeholder="https://...">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="Team.closeModal('addMeetingModal')">Cancel</button>
      <button class="btn btn-primary" onclick="Team.saveMeeting()">Save</button>
    </div>
  </div>
</div>

<!-- Meeting Detail Modal (for viewing/editing with artifacts) -->
<div class="modal" id="meetingDetailModal">
  <div class="modal-content modal-lg">
    <div class="modal-header">
      <h3 id="meetingDetailTitle">Meeting Details</h3>
      <button class="modal-close" onclick="Team.closeModal('meetingDetailModal')">&times;</button>
    </div>
    <div class="modal-body" id="meetingDetailBody">
      <!-- Populated dynamically -->
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="Team.closeModal('meetingDetailModal')">Close</button>
      <button class="btn btn-primary" onclick="Team.editMeeting()">Edit</button>
    </div>
  </div>
</div>

<!-- Team Member Detail Modal -->
<div class="modal" id="memberDetailModal">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h3 id="memberDetailTitle">Team Member</h3>
      <button class="modal-close" onclick="Team.closeModal('memberDetailModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="member-detail">
        <div class="member-detail-header">
          <div class="member-avatar-lg" id="memberDetailAvatar">--</div>
          <div class="member-detail-name">
            <h2 id="memberDetailName">--</h2>
            <p id="memberDetailTitle2" class="member-role">--</p>
          </div>
        </div>
        <div class="member-detail-info">
          <div class="member-info-row">
            <span class="info-icon material-icons">email</span>
            <a id="memberDetailEmail" href="#" class="member-email">--</a>
          </div>
          <div class="member-info-row">
            <span class="info-icon material-icons">group</span>
            <span id="memberDetailTeam">--</span>
          </div>
          <div class="member-info-row" id="memberDetailPhoneRow" style="display:none;">
            <span class="info-icon material-icons">phone</span>
            <span id="memberDetailPhone">--</span>
          </div>
          <div class="member-info-row" id="memberDetailOrgRow" style="display:none;">
            <span class="info-icon material-icons">work</span>
            <span id="memberDetailOrg">--</span>
          </div>
        </div>
        <div class="member-availability-section">
          <h4>Current Availability</h4>
          <div id="memberAvailabilityList" class="member-availability-list">
            <p class="text-muted">No upcoming OOO</p>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="Team.closeModal('memberDetailModal')">Close</button>
    </div>
  </div>
</div>

<!-- Team Page Styles -->
<style>
  .team-viewer { max-width: 1600px; margin: 0 auto; }

  /* Page Header - matching SEP pattern */
  .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-lg); }
  .page-title h1 { font-size: var(--font-size-xxl); color: var(--color-primary); margin-bottom: var(--space-xs); }
  .page-subtitle { color: var(--color-text-secondary); font-size: var(--font-size-md); }
  .page-actions { display: flex; gap: var(--space-md); align-items: center; }

  /* View Toggle - matching SEP */
  .view-toggle {
    display: flex;
    gap: 2px;
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: 2px;
    box-shadow: var(--shadow-sm);
  }
  .view-btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    transition: all var(--transition-fast);
  }
  .view-btn:hover { color: var(--color-text); background: var(--color-surface-alt); }
  .view-btn.active { background: var(--color-primary); color: white; }
  .view-btn svg { width: 16px; height: 16px; }

  /* Stats Row - matching SEP */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }
  .stat-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }
  .stat-card.stat-warning .stat-icon { background: rgba(237, 108, 2, 0.1); color: var(--color-warning); }
  .stat-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(11, 61, 145, 0.1);
    border-radius: var(--radius-md);
    color: var(--color-primary);
  }
  .stat-icon svg { width: 24px; height: 24px; }
  .stat-info { display: flex; flex-direction: column; }
  .stat-value { font-size: var(--font-size-xl); font-weight: 700; color: var(--color-text); }
  .stat-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); }

  /* View Panels */
  .view-panel { display: none; }
  .view-panel.active { display: block; }

  /* Section Header */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }
  .section-header h2 { font-size: var(--font-size-lg); color: var(--color-text); margin: 0; }

  /* Team Grid Layout */
  .team-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: var(--space-lg);
  }

  .team-profiles-section,
  .availability-section {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-sm);
  }

  .team-grid-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-md);
  }

  .team-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    text-align: center;
    transition: all var(--transition-fast);
    cursor: pointer;
  }

  .team-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
    border-color: var(--color-primary);
  }

  .team-card .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-primary), #60a5fa);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 auto var(--space-sm);
  }

  .team-card .name {
    font-weight: 600;
    margin-bottom: var(--space-xs);
    color: var(--color-text);
  }

  .team-card .title {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--space-xs);
  }

  .team-card .team-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: var(--font-size-xs);
    font-weight: 500;
  }

  .team-badge.Leadership { background: #e3f2fd; color: #1565c0; }
  .team-badge.Assessment { background: #fff3e0; color: #ef6c00; }
  .team-badge.SEP { background: #e8f5e9; color: #2e7d32; }
  .team-badge.Comms { background: #fce4ec; color: #c2185b; }
  .team-badge.Operations { background: #f3e5f5; color: #7b1fa2; }
  .team-badge.Implementation { background: #e0f7fa; color: #00838f; }

  /* Availability List */
  .availability-list {
    margin-top: var(--space-md);
    max-height: 400px;
    overflow-y: auto;
  }

  .availability-item {
    display: flex;
    align-items: center;
    padding: var(--space-sm);
    border-bottom: 1px solid var(--color-border-light);
    gap: var(--space-sm);
  }

  .availability-item:last-child {
    border-bottom: none;
  }

  .avail-type-badge {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: var(--font-size-xs);
    font-weight: 500;
    text-transform: uppercase;
  }

  .avail-type-badge.vacation { background: #e8f5e9; color: #2e7d32; }
  .avail-type-badge.work_travel { background: #e3f2fd; color: #1565c0; }
  .avail-type-badge.ooo { background: #fff3e0; color: #ef6c00; }
  .avail-type-badge.nine_80 { background: #f3e5f5; color: #7b1fa2; }
  .avail-type-badge.holiday { background: #ffebee; color: #c62828; }
  .avail-type-badge.special_event { background: #fce4ec; color: #c2185b; }

  /* Partner tags for holidays */
  .partner-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }
  .partner-tag {
    font-size: 10px;
    padding: 1px 4px;
    background: var(--color-surface-alt);
    border-radius: 3px;
    color: var(--color-text-secondary);
  }

  /* Checkbox group styling */
  .checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-sm);
    cursor: pointer;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
  }
  .checkbox-label:hover {
    border-color: var(--color-primary);
  }
  .checkbox-label input[type="checkbox"] {
    width: auto;
    margin: 0;
  }
  .checkbox-label input[type="checkbox"]:checked + span,
  .checkbox-label:has(input:checked) {
    color: var(--color-primary);
  }

  /* Recurrence indicator */
  .recurrence-icon {
    color: var(--color-text-muted);
    font-size: 10px;
  }

  .avail-name {
    font-weight: 500;
    font-size: var(--font-size-sm);
  }

  .avail-dates {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  .avail-location {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  /* Meetings Layout */
  .meetings-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-lg);
  }

  .meetings-schedule-section {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-sm);
  }

  .meeting-filters {
    display: flex;
    gap: var(--space-sm);
  }

  .meeting-filters select {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
  }

  .weekly-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    margin-top: var(--space-md);
  }

  .day-column {
    min-height: 200px;
  }

  .day-header {
    font-weight: 600;
    font-size: var(--font-size-sm);
    padding: var(--space-sm);
    background: var(--color-surface);
    border-radius: var(--radius-sm);
    text-align: center;
    margin-bottom: var(--space-sm);
  }

  .day-meetings {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .meeting-chip {
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .meeting-chip:hover {
    background: rgba(11, 61, 145, 0.1);
    border-color: var(--color-primary);
  }

  .meeting-chip .meeting-time {
    font-weight: 600;
    display: block;
    color: var(--color-text);
  }

  .meeting-chip .meeting-name {
    color: var(--color-text-muted);
  }

  /* Meetings List */
  .meetings-list-section {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-sm);
  }

  .meetings-list {
    margin-top: var(--space-md);
  }

  .meeting-row {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-sm);
    overflow: hidden;
  }

  .meeting-row-header {
    display: flex;
    align-items: center;
    padding: var(--space-md);
    cursor: pointer;
    gap: var(--space-md);
    transition: background var(--transition-fast);
  }

  .meeting-row-header:hover {
    background: var(--color-surface-alt);
  }

  .meeting-row-header .expand-icon {
    transition: transform 0.2s;
    color: var(--color-text-muted);
  }

  .meeting-row.expanded .expand-icon {
    transform: rotate(90deg);
  }

  .meeting-row-details {
    display: none;
    padding: var(--space-md);
    border-top: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }

  .meeting-row.expanded .meeting-row-details {
    display: block;
  }

  .meeting-meta {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
    margin-bottom: var(--space-md);
  }

  .meeting-meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .meeting-meta-item svg { width: 14px; height: 14px; }

  .artifacts-section {
    margin-top: var(--space-md);
  }

  .artifacts-section h4 {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-sm);
  }

  .artifacts-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .artifact-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-surface);
    border-radius: var(--radius-sm);
  }

  .artifact-item svg { width: 14px; height: 14px; color: var(--color-primary); }

  .artifact-item a {
    color: var(--color-primary);
    text-decoration: none;
    font-size: var(--font-size-sm);
  }

  .artifact-item a:hover {
    text-decoration: underline;
  }

  /* Documents Grid */
  .documents-section {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-sm);
  }

  .section-description {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    margin-top: var(--space-xs);
  }

  .documents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-md);
  }

  .document-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    transition: all var(--transition-fast);
  }

  .document-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }

  .document-card .doc-icon {
    width: 40px;
    height: 40px;
    background: rgba(11, 61, 145, 0.1);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary);
    flex-shrink: 0;
  }

  .document-card .doc-icon svg { width: 20px; height: 20px; }

  .document-card .doc-info {
    flex: 1;
  }

  .document-card .doc-title {
    font-weight: 600;
    margin-bottom: var(--space-xs);
    color: var(--color-text);
  }

  .document-card .doc-description {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  /* Category badges for meetings */
  .category-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: var(--font-size-xs);
    font-weight: 500;
  }

  .category-badge.MO { background: #e3f2fd; color: #1565c0; }
  .category-badge.Assessment { background: #fff3e0; color: #ef6c00; }
  .category-badge.SEP { background: #e8f5e9; color: #2e7d32; }
  .category-badge.Comms { background: #fce4ec; color: #c2185b; }
  .category-badge.Operations { background: #f3e5f5; color: #7b1fa2; }
  .category-badge.Implementation { background: #e0f7fa; color: #00838f; }

  .type-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: var(--font-size-xs);
    font-weight: 500;
    background: var(--color-surface-alt);
    color: var(--color-text-secondary);
  }

  /* Buttons - matching SEP pattern */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: none;
  }
  .btn svg { width: 16px; height: 16px; }
  .btn-primary { background: var(--color-primary); color: white; }
  .btn-primary:hover { background: var(--color-primary-dark); }
  .btn-secondary { background: var(--color-surface-alt); color: var(--color-text); border: 1px solid var(--color-border); }
  .btn-secondary:hover { background: var(--color-border-light); }
  .btn-sm { padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-xs); }

  /* Modal Styles - matching SEP pattern */
  .modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: var(--space-md);
  }
  .modal.show { display: flex; }
  .modal-content {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .modal-content.modal-sm { max-width: 450px; }
  .modal-content.modal-lg { max-width: 900px; }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }
  .modal-header h3 { font-size: var(--font-size-lg); font-weight: 600; margin: 0; }
  .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-muted); }
  .modal-close:hover { color: var(--color-text); }
  .modal-body { padding: var(--space-lg); overflow-y: auto; }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-lg);
    border-top: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }

  /* Member Detail Modal */
  .member-detail-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
  }
  .member-avatar-lg {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-primary), #60a5fa);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    font-weight: 600;
    flex-shrink: 0;
  }
  .member-detail-name h2 {
    font-size: var(--font-size-lg);
    margin: 0 0 var(--space-xs) 0;
    color: var(--color-text);
  }
  .member-role {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    margin: 0;
  }
  .member-detail-info {
    margin-bottom: var(--space-lg);
  }
  .member-info-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) 0;
    font-size: var(--font-size-sm);
  }
  .member-info-row .info-icon {
    width: 16px;
    height: 16px;
    color: var(--color-text-muted);
  }
  .member-email {
    color: var(--color-primary);
    text-decoration: none;
  }
  .member-email:hover { text-decoration: underline; }
  .member-availability-section h4 {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-sm);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .member-availability-list {
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    padding: var(--space-sm);
  }
  .member-avail-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xs) 0;
    font-size: var(--font-size-sm);
  }
  .member-avail-item + .member-avail-item {
    border-top: 1px solid var(--color-border-light);
    padding-top: var(--space-sm);
    margin-top: var(--space-xs);
  }

  /* Form Styles - matching SEP pattern */
  .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); }
  .form-group { margin-bottom: var(--space-md); }
  .form-group label { display: block; font-size: var(--font-size-sm); font-weight: 500; margin-bottom: var(--space-xs); color: var(--color-text); }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: inherit;
    background: var(--color-surface);
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  /* Loading & Empty States */
  .loading-state { text-align: center; padding: var(--space-lg); color: var(--color-text-muted); }
  .empty-state { text-align: center; padding: var(--space-lg); color: var(--color-text-muted); }

  /* Small loading spinner for buttons */
  .loading-spinner-sm {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Button loading state */
  .btn.loading { pointer-events: none; opacity: 0.8; }
  .btn.loading .btn-text { display: none; }
  .btn.loading .btn-loading { display: inline-flex !important; align-items: center; gap: var(--space-xs); }

  /* Hidden form groups */
  .form-group.hidden { display: none; }

  /* Team filter select */
  .team-filter select {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .team-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 768px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .weekly-grid { grid-template-columns: repeat(3, 1fr); }
    .form-row { grid-template-columns: 1fr; }
  }
</style>

<!-- Team Page JavaScript -->
<script>
  // Local error handler for this page
  function handleError(error) {
    console.error('Team page error:', error);
  }

  var Team = {
    members: [],
    meetings: [],
    availability: [],
    currentView: 'overview',

    // Security: HTML escape to prevent XSS
    escapeHtml: function(text) {
      if (text === null || text === undefined) return '';
      var str = String(text);
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    },

    // Security: Validate URL (must be http/https)
    safeUrl: function(url) {
      if (!url || typeof url !== 'string') return '';
      var trimmed = url.trim();
      if (trimmed.match(/^https?:\/\//i)) {
        return Team.escapeHtml(trimmed);
      }
      return '';
    },

    init: function() {
      this.loadData();
    },

    loadData: function() {
      // Load team members
      google.script.run
        .withSuccessHandler(function(data) {
          Team.members = data || [];
          Team.renderTeamProfiles();
          Team.updateStats();
          Team.populatePersonSelect();
        })
        .withFailureHandler(handleError)
        .getInternalTeam();

      // Load meetings
      google.script.run
        .withSuccessHandler(function(data) {
          Team.meetings = data || [];
          Team.renderMeetings();
          Team.updateStats();
        })
        .withFailureHandler(handleError)
        .getAllMeetings();

      // Load availability
      google.script.run
        .withSuccessHandler(function(data) {
          Team.availability = data || [];
          Team.renderAvailability();
          Team.updateStats();
        })
        .withFailureHandler(handleError)
        .getAvailability();
    },

    setView: function(view) {
      this.currentView = view;

      // Update view buttons
      document.querySelectorAll('.view-btn').forEach(function(btn) {
        btn.classList.remove('active');
      });
      document.querySelector('[data-view="' + view + '"]').classList.add('active');

      // Show/hide view panels
      document.querySelectorAll('.view-panel').forEach(function(panel) {
        panel.classList.remove('active');
      });
      document.getElementById(view + 'View').classList.add('active');

      // Update add button label based on view
      var addBtn = document.getElementById('addEntryBtn');
      var addLabel = document.getElementById('addEntryLabel');
      if (view === 'overview') {
        addBtn.style.display = '';
        addLabel.textContent = 'Add Availability';
      } else if (view === 'meetings') {
        addBtn.style.display = '';
        addLabel.textContent = 'Add Meeting';
      } else {
        addBtn.style.display = 'none'; // Hide for documents view
      }
    },

    // Toggle form fields based on availability type
    toggleFormFields: function() {
      var typeSelect = document.getElementById('availTypeSelect');
      var personGroup = document.getElementById('personSelectGroup');
      var personSelect = document.getElementById('availPersonSelect');
      var holidayNameGroup = document.getElementById('holidayNameGroup');
      var partnersGroup = document.getElementById('partnersGroup');
      var locationGroup = document.getElementById('locationGroup');
      var recurrenceSelect = document.getElementById('availRecurrence');
      var selectedType = typeSelect.value;

      var officeWideTypes = ['holiday', 'special_event'];
      var isOfficeWide = officeWideTypes.indexOf(selectedType) !== -1;
      var isHoliday = selectedType === 'holiday';

      // Person select: hide for office-wide types
      if (isOfficeWide) {
        personGroup.classList.add('hidden');
        personSelect.removeAttribute('required');
        personSelect.value = '';
      } else {
        personGroup.classList.remove('hidden');
        personSelect.setAttribute('required', 'required');
      }

      // Holiday name and partners: show only for holidays
      if (isHoliday) {
        holidayNameGroup.classList.remove('hidden');
        partnersGroup.classList.remove('hidden');
        locationGroup.classList.add('hidden');
        // Default to annually for holidays
        recurrenceSelect.value = 'annually';
      } else {
        holidayNameGroup.classList.add('hidden');
        partnersGroup.classList.add('hidden');
        locationGroup.classList.remove('hidden');
        // Reset to none for non-holidays (unless already set)
        if (recurrenceSelect.value === 'annually') {
          recurrenceSelect.value = 'none';
        }
      }
    },

    renderTeamProfiles: function() {
      var container = document.getElementById('teamProfilesGrid');
      if (!this.members.length) {
        container.innerHTML = '<p class="text-muted">No team members found</p>';
        return;
      }

      var html = this.members.map(function(member) {
        var initials = (member.first_name || '').charAt(0) + (member.last_name || '').charAt(0);
        var teamClass = (member.internal_team || '').replace(/\s+/g, '');

        return '<div class="team-card" onclick="Team.showMemberDetail(\'' + member.contact_id + '\')">' +
          '<div class="avatar">' + initials.toUpperCase() + '</div>' +
          '<div class="name">' + (member.first_name || '') + ' ' + (member.last_name || '') + '</div>' +
          '<div class="title">' + (member.internal_title || '') + '</div>' +
          '<span class="team-badge ' + teamClass + '">' + (member.internal_team || '') + '</span>' +
        '</div>';
      }).join('');

      container.innerHTML = html;
    },

    filterTeam: function(team) {
      var cards = document.querySelectorAll('.team-card');
      cards.forEach(function(card) {
        var badge = card.querySelector('.team-badge');
        if (team === 'all' || (badge && badge.textContent === team)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    },

    // Map type codes to display labels
    typeLabels: {
      'vacation': 'Vacation',
      'work_travel': 'Travel',
      'ooo': 'OOO',
      '9_80': '9/80',
      'holiday': 'Holiday',
      'special_event': 'Event'
    },

    // Map recurrence codes to icons/labels
    recurrenceLabels: {
      'weekly': 'Weekly',
      'biweekly': 'Bi-weekly',
      'monthly': 'Monthly',
      'annually': 'Annual'
    },

    // Format date to human-friendly format (e.g., "Jan 15" or "Jan 15 - 20" or "Jan 15 - Feb 2")
    formatDateRange: function(startDateStr, endDateStr) {
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      var start = new Date(startDateStr + 'T00:00:00');
      var end = new Date(endDateStr + 'T00:00:00');

      var startMonth = months[start.getMonth()];
      var startDay = start.getDate();
      var endMonth = months[end.getMonth()];
      var endDay = end.getDate();

      // Same day
      if (startDateStr === endDateStr) {
        return startMonth + ' ' + startDay;
      }

      // Same month
      if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
        return startMonth + ' ' + startDay + ' - ' + endDay;
      }

      // Different months
      return startMonth + ' ' + startDay + ' - ' + endMonth + ' ' + endDay;
    },

    renderAvailability: function() {
      var container = document.getElementById('availabilityList');
      if (!this.availability.length) {
        container.innerHTML = '<p class="text-muted">No upcoming availability entries</p>';
        return;
      }

      // Sort by start date
      var sorted = this.availability.slice().sort(function(a, b) {
        return new Date(a.start_date) - new Date(b.start_date);
      });

      var self = this;
      var html = sorted.map(function(item) {
        var typeClass = (item.type || '').replace(/\s+/g, '_').replace('9_80', 'nine_80');
        var typeLabel = self.typeLabels[item.type] || item.type || '';
        var dateStr = self.formatDateRange(item.start_date, item.end_date);

        // For office-wide events, show differently
        var officeWideTypes = ['holiday', 'special_event'];
        var isOfficeWide = officeWideTypes.indexOf(item.type) !== -1;
        var isHoliday = item.type === 'holiday';
        // Use holiday_name for holidays, notes for special events, contact_name for personal
        var nameDisplay = isHoliday
          ? (item.holiday_name || item.notes || 'Holiday')
          : (isOfficeWide ? (item.notes || 'Office Event') : (item.contact_name || ''));

        // Build partner tags for holidays
        var partnerHtml = '';
        if (isHoliday && item.partners) {
          var partners = item.partners.split(',').map(function(p) { return p.trim(); }).filter(function(p) { return p; });
          if (partners.length > 0) {
            partnerHtml = '<span class="partner-tags">' +
              partners.map(function(p) { return '<span class="partner-tag">' + p + '</span>'; }).join('') +
            '</span>';
          }
        }

        // Recurrence indicator
        var recurrenceHtml = '';
        if (item.recurrence && item.recurrence !== 'none') {
          var recLabel = self.recurrenceLabels[item.recurrence] || item.recurrence;
          recurrenceHtml = '<span class="recurrence-icon" title="' + recLabel + '">â†»</span>';
        }

        return '<div class="availability-item">' +
          '<span class="avail-type-badge ' + typeClass + '">' + typeLabel + '</span>' +
          '<span class="avail-name">' + nameDisplay + '</span>' +
          partnerHtml +
          '<span class="avail-dates">' + dateStr + recurrenceHtml + '</span>' +
          (item.location && !isOfficeWide ? '<span class="avail-location">(' + item.location + ')</span>' : '') +
        '</div>';
      }).join('');

      container.innerHTML = html;
    },

    renderMeetings: function() {
      // Render weekly grid
      var days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
      days.forEach(function(day) {
        var container = document.getElementById('meetings' + day);
        var dayMeetings = Team.meetings.filter(function(m) {
          return m.day_of_week === day && m.is_active;
        });

        if (!dayMeetings.length) {
          container.innerHTML = '<p class="text-muted text-sm">No meetings</p>';
          return;
        }

        var html = dayMeetings.map(function(m) {
          return '<div class="meeting-chip" onclick="Team.scrollToMeeting(\'' + Team.escapeHtml(m.meeting_id) + '\')">' +
            '<span class="meeting-time">' + Team.escapeHtml(m.time || 'TBD') + '</span>' +
            '<span class="meeting-name">' + Team.escapeHtml(m.name) + '</span>' +
          '</div>';
        }).join('');

        container.innerHTML = html;
      });

      // Render meetings list
      var listContainer = document.getElementById('meetingsList');
      var html = this.meetings.map(function(m) {
        var safeId = Team.escapeHtml(m.meeting_id);
        var onlineLink = Team.safeUrl(m.online_link);
        var driveUrl = Team.safeUrl(m.drive_folder_url);
        var agendaUrl = Team.safeUrl(m.agenda_url);
        var notesUrl = Team.safeUrl(m.notes_url);
        var slidesUrl = Team.safeUrl(m.slides_url);
        var recordingUrl = Team.safeUrl(m.recording_url);

        return '<div class="meeting-row" id="meeting-' + safeId + '">' +
          '<div class="meeting-row-header" onclick="Team.toggleMeetingRow(\'' + safeId + '\')">' +
            '<span class="expand-icon material-icons">chevron_right</span>' +
            '<span class="meeting-name-col" style="flex:1;font-weight:600;">' + Team.escapeHtml(m.name) + '</span>' +
            '<span class="category-badge ' + Team.escapeHtml(m.category) + '">' + Team.escapeHtml(m.category) + '</span>' +
            '<span class="type-badge">' + Team.escapeHtml(m.type) + '</span>' +
            '<span style="width:100px;text-align:right;">' + Team.escapeHtml(m.cadence || '') + '</span>' +
          '</div>' +
          '<div class="meeting-row-details">' +
            '<div class="meeting-meta">' +
              '<div class="meeting-meta-item"><span class="material-icons">schedule</span>' + Team.escapeHtml(m.day_of_week || 'TBD') + ' ' + Team.escapeHtml(m.time || '') + '</div>' +
              '<div class="meeting-meta-item"><span class="material-icons">repeat</span>' + Team.escapeHtml(m.cadence || '') + '</div>' +
              '<div class="meeting-meta-item"><span class="material-icons">schedule</span>' + Team.escapeHtml(m.duration_minutes || 60) + ' min</div>' +
            '</div>' +
            '<p><strong>Purpose:</strong> ' + Team.escapeHtml(m.purpose || 'Not specified') + '</p>' +
            (onlineLink ? '<p><a href="' + onlineLink + '" target="_blank">Join Online</a></p>' : '') +
            (driveUrl ? '<p><a href="' + driveUrl + '" target="_blank">Drive Folder</a></p>' : '') +
            '<div class="artifacts-section">' +
              '<h4>Resources</h4>' +
              '<div class="artifacts-list">' +
                (agendaUrl ? '<div class="artifact-item"><span class="material-icons">description</span><a href="' + agendaUrl + '" target="_blank">Agenda</a></div>' : '') +
                (notesUrl ? '<div class="artifact-item"><span class="material-icons">edit</span><a href="' + notesUrl + '" target="_blank">Notes</a></div>' : '') +
                (slidesUrl ? '<div class="artifact-item"><span class="material-icons">slideshow</span><a href="' + slidesUrl + '" target="_blank">Slides</a></div>' : '') +
                (recordingUrl ? '<div class="artifact-item"><span class="material-icons">videocam</span><a href="' + recordingUrl + '" target="_blank">Recording</a></div>' : '') +
                (!agendaUrl && !notesUrl && !slidesUrl && !recordingUrl ? '<p class="text-muted text-sm">No resources linked yet</p>' : '') +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');

      listContainer.innerHTML = html;
    },

    toggleMeetingRow: function(meetingId) {
      var row = document.getElementById('meeting-' + meetingId);
      row.classList.toggle('expanded');
    },

    scrollToMeeting: function(meetingId) {
      var row = document.getElementById('meeting-' + meetingId);
      if (!row) return;

      // Expand the row if not already expanded
      if (!row.classList.contains('expanded')) {
        row.classList.add('expanded');
      }

      // Scroll to the row with offset for header
      row.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Brief highlight effect
      row.style.backgroundColor = 'var(--color-team-light, #e3f2fd)';
      setTimeout(function() {
        row.style.backgroundColor = '';
      }, 1500);
    },

    filterMeetings: function() {
      var category = document.getElementById('meetingCategoryFilter').value;
      var type = document.getElementById('meetingTypeFilter').value;

      document.querySelectorAll('.meeting-row').forEach(function(row) {
        var catBadge = row.querySelector('.category-badge');
        var typeBadge = row.querySelector('.type-badge');
        var catMatch = category === 'all' || (catBadge && catBadge.textContent === category);
        var typeMatch = type === 'all' || (typeBadge && typeBadge.textContent === type);
        row.style.display = (catMatch && typeMatch) ? '' : 'none';
      });
    },

    updateStats: function() {
      document.getElementById('statTeamMembers').textContent = this.members.length;

      // Count meetings this week (recurring meetings with day_of_week set)
      var weeklyMeetings = this.meetings.filter(function(m) {
        return m.day_of_week && m.is_active;
      });
      document.getElementById('statMeetingsThisWeek').textContent = weeklyMeetings.length;

      // Count people out this week
      var today = new Date();
      var outThisWeek = this.availability.filter(function(a) {
        var start = new Date(a.start_date);
        var end = new Date(a.end_date);
        return start <= today && end >= today;
      });
      document.getElementById('statOutThisWeek').textContent = outThisWeek.length;

      // Directing docs placeholder
      document.getElementById('statDocuments').textContent = '--';
    },

    populatePersonSelect: function() {
      var select = document.getElementById('availPersonSelect');
      var options = '<option value="">Select person...</option>';
      this.members.forEach(function(m) {
        options += '<option value="' + m.contact_id + '">' + m.first_name + ' ' + m.last_name + '</option>';
      });
      select.innerHTML = options;
    },

    // Modal functions
    showAddModal: function() {
      if (this.currentView === 'meetings') {
        this.showAddMeetingModal();
      } else {
        this.showAddAvailabilityModal();
      }
    },

    showAddAvailabilityModal: function() {
      document.getElementById('availabilityForm').reset();
      // Reset form field visibility
      document.getElementById('personSelectGroup').classList.remove('hidden');
      document.getElementById('availPersonSelect').setAttribute('required', 'required');
      document.getElementById('holidayNameGroup').classList.add('hidden');
      document.getElementById('partnersGroup').classList.add('hidden');
      document.getElementById('locationGroup').classList.remove('hidden');
      // Uncheck all partner checkboxes
      document.querySelectorAll('#partnerCheckboxes input[type="checkbox"]').forEach(function(cb) {
        cb.checked = false;
      });
      // Reset save button state
      document.getElementById('saveAvailabilityBtn').classList.remove('loading');
      document.getElementById('addAvailabilityModal').classList.add('show');
    },

    showAddMeetingModal: function() {
      document.getElementById('meetingForm').reset();
      document.getElementById('addMeetingModal').classList.add('show');
    },

    showMeetingDetail: function(meetingId) {
      var meeting = this.meetings.find(function(m) { return m.meeting_id === meetingId; });
      if (!meeting) return;

      document.getElementById('meetingDetailTitle').textContent = meeting.name;
      // Populate body...
      document.getElementById('meetingDetailModal').classList.add('show');
    },

    showMemberDetail: function(contactId) {
      var member = this.members.find(function(m) { return m.contact_id === contactId; });
      if (!member) return;

      var initials = (member.first_name || '').charAt(0) + (member.last_name || '').charAt(0);
      var fullName = (member.first_name || '') + ' ' + (member.last_name || '');

      // Populate modal
      document.getElementById('memberDetailAvatar').textContent = initials.toUpperCase();
      document.getElementById('memberDetailName').textContent = fullName;
      document.getElementById('memberDetailTitle2').textContent = member.internal_title || 'Team Member';
      document.getElementById('memberDetailTeam').textContent = member.internal_team || '--';

      // Email
      var emailEl = document.getElementById('memberDetailEmail');
      if (member.email) {
        emailEl.textContent = member.email;
        emailEl.href = 'mailto:' + member.email;
      } else {
        emailEl.textContent = 'No email on file';
        emailEl.href = '#';
      }

      // Phone (if available)
      var phoneRow = document.getElementById('memberDetailPhoneRow');
      if (member.phone) {
        document.getElementById('memberDetailPhone').textContent = member.phone;
        phoneRow.style.display = '';
      } else {
        phoneRow.style.display = 'none';
      }

      // Organization (if available)
      var orgRow = document.getElementById('memberDetailOrgRow');
      if (member.organization) {
        document.getElementById('memberDetailOrg').textContent = member.organization;
        orgRow.style.display = '';
      } else {
        orgRow.style.display = 'none';
      }

      // Build availability list for this member
      var memberAvail = this.availability.filter(function(a) {
        return a.contact_id === contactId;
      }).sort(function(a, b) {
        return new Date(a.start_date) - new Date(b.start_date);
      });

      var availListEl = document.getElementById('memberAvailabilityList');
      if (memberAvail.length === 0) {
        availListEl.innerHTML = '<p class="text-muted">No upcoming OOO</p>';
      } else {
        var self = this;
        var availHtml = memberAvail.slice(0, 5).map(function(a) {
          var typeLabel = self.typeLabels[a.type] || a.type;
          var dateStr = self.formatDateRange(a.start_date, a.end_date);
          return '<div class="member-avail-item">' +
            '<span class="avail-type-badge ' + a.type.replace('9_80', 'nine_80') + '">' + typeLabel + '</span>' +
            '<span>' + dateStr + '</span>' +
          '</div>';
        }).join('');
        availListEl.innerHTML = availHtml;
      }

      document.getElementById('memberDetailModal').classList.add('show');
    },

    closeModal: function(modalId) {
      document.getElementById(modalId).classList.remove('show');
    },

    saveAvailability: function() {
      var typeSelect = document.getElementById('availTypeSelect');
      var personSelect = document.getElementById('availPersonSelect');
      var selectedOption = personSelect.options[personSelect.selectedIndex];
      var saveBtn = document.getElementById('saveAvailabilityBtn');
      var selectedType = typeSelect.value;

      // Validate required fields
      if (!selectedType) {
        alert('Please select a type');
        return;
      }

      // Validate person for personal types
      var officeWideTypes = ['holiday', 'special_event'];
      var isOfficeWide = officeWideTypes.indexOf(selectedType) !== -1;
      var isHoliday = selectedType === 'holiday';

      if (!isOfficeWide && !personSelect.value) {
        alert('Please select a team member');
        return;
      }

      // Collect selected partners for holidays
      var partners = '';
      if (isHoliday) {
        var selectedPartners = [];
        document.querySelectorAll('#partnerCheckboxes input[type="checkbox"]:checked').forEach(function(cb) {
          selectedPartners.push(cb.value);
        });
        partners = selectedPartners.join(', ');
      }

      // Show loading state
      saveBtn.classList.add('loading');

      var data = {
        contact_id: isOfficeWide ? '' : personSelect.value,
        contact_name: isOfficeWide ? '' : (selectedOption ? selectedOption.textContent : ''),
        type: selectedType,
        start_date: document.getElementById('availStartDate').value,
        end_date: document.getElementById('availEndDate').value,
        recurrence: document.getElementById('availRecurrence').value,
        holiday_name: isHoliday ? document.getElementById('availHolidayName').value : '',
        partners: partners,
        location: isHoliday ? '' : document.getElementById('availLocation').value,
        notes: document.getElementById('availNotes').value
      };

      google.script.run
        .withSuccessHandler(function() {
          saveBtn.classList.remove('loading');
          Team.closeModal('addAvailabilityModal');
          Team.loadData();
        })
        .withFailureHandler(function(error) {
          saveBtn.classList.remove('loading');
          handleError(error);
          alert('Failed to save: ' + (error.message || error));
        })
        .addAvailability(data);
    },

    saveMeeting: function() {
      var data = {
        name: document.getElementById('meetingName').value,
        category: document.getElementById('meetingCategory').value,
        type: document.getElementById('meetingType').value,
        cadence: document.getElementById('meetingCadence').value,
        day_of_week: document.getElementById('meetingDay').value,
        time: document.getElementById('meetingTime').value,
        duration_minutes: parseInt(document.getElementById('meetingDuration').value) || 60,
        purpose: document.getElementById('meetingPurpose').value,
        online_link: document.getElementById('meetingLink').value,
        drive_folder_url: document.getElementById('meetingDriveFolder').value,
        agenda_url: document.getElementById('meetingAgendaUrl').value,
        notes_url: document.getElementById('meetingNotesUrl').value,
        slides_url: document.getElementById('meetingSlidesUrl').value,
        recording_url: document.getElementById('meetingRecordingUrl').value
      };

      google.script.run
        .withSuccessHandler(function() {
          Team.closeModal('addMeetingModal');
          Team.loadData();
        })
        .withFailureHandler(handleError)
        .addMeeting(data);
    },

  };

  // Initialize on load
  Team.init();
</script>
