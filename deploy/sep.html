<!-- SEP-NSITE: Stakeholder Engagement Pipeline -->
<!-- Engagement health dashboard with milestone tracking -->

<div class="sep-viewer">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title">
      <h1>SEP-NSITE</h1>
      <p class="page-subtitle">Stakeholder Engagement Pipeline</p>
    </div>
    <div class="page-actions">
      <div class="view-toggle">
        <button class="view-btn active" data-view="dashboard" onclick="SEP.setView('dashboard')">
          <span class="material-icons">dashboard</span>
          <span>Dashboard</span>
        </button>
        <button class="view-btn" data-view="agencies" onclick="SEP.setView('agencies')">
          <span class="material-icons">account_tree</span>
          <span>Agencies</span>
        </button>
      </div>
      <div class="header-filter">
        <select id="filterCycle" onchange="SEP.applyFilters()" title="Filter by cycle">
          <option value="">All Cycles</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="SEP.showLogEngagementModal()">
        <span class="material-icons">add</span>
        Log Engagement
      </button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="sep-content">
    <!-- Dashboard View (renamed from Pipeline View) -->
    <div class="view-panel active" id="dashboardView">

      <!-- Stats Row: The "What" -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon"><span class="material-icons">event</span></div>
          <div class="stat-info">
            <span class="stat-value" id="statEngagementsMonth">--</span>
            <span class="stat-label">Engagements This Month</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><span class="material-icons">people</span></div>
          <div class="stat-info">
            <span class="stat-value" id="statContactsEngaged">--</span>
            <span class="stat-label">Contacts Engaged</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><span class="material-icons">widgets</span></div>
          <div class="stat-info">
            <span class="stat-value" id="statSolutionsEngaged">--</span>
            <span class="stat-label">Solutions Engaged</span>
          </div>
        </div>
        <div class="stat-card" id="statHeatCard">
          <div class="stat-icon"><span class="material-icons" id="statHeatIcon">whatshot</span></div>
          <div class="stat-info">
            <span class="stat-value" id="statHeatLabel">--</span>
            <span class="stat-label">Activity Level</span>
          </div>
        </div>
      </div>

      <!-- Main Panels: The "How" -->
      <div class="main-panels">
        <!-- Recent Engagements (activity feed) -->
        <div class="panel engagement-panel">
          <div class="panel-header">
            <h3>Recent Engagements</h3>
            <div style="display: flex; gap: var(--space-xs);">
              <button class="btn btn-sm btn-secondary" onclick="SEP.showAllEngagements()">View All</button>
              <button class="btn btn-sm btn-primary" onclick="SEP.showLogEngagementModal()">
                <span class="material-icons">add</span>
              </button>
            </div>
          </div>
          <div class="panel-content" id="recentEngagements">
            <div class="loading-state">
              <span class="loading-spinner"></span>
            </div>
          </div>
        </div>

        <!-- Needs Attention (low engagement alerts) -->
        <div class="panel outreach-panel">
          <div class="panel-header">
            <h3>Needs Attention</h3>
            <span class="badge badge-warning" id="outreachCount">0</span>
          </div>
          <div class="panel-content">
            <div class="outreach-list" id="outreachList">
              <div class="loading-state">
                <span class="loading-spinner"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pipeline Summary: The "Where" -->
      <div class="pipeline-summary">
        <div class="summary-header">
          <h3>Milestone Summary</h3>
          <div class="pipeline-legend">
            <span class="legend-item"><span class="dot dot-ws"></span>WS</span>
            <span class="legend-item"><span class="dot dot-tp"></span>TP</span>
          </div>
        </div>
        <div class="pipeline-board" id="pipelineBoard">
          <!-- WS1/TP4 Column -->
          <div class="pipeline-column" data-column="1" data-ws="ws1" data-tp="tp4"
               ondragover="SEP.handleDragOver(event)" ondrop="SEP.handleDrop(event, '1')" ondragleave="SEP.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title-group">WS1 / TP4</span>
              <span class="column-count" id="count_col1">0</span>
            </div>
            <div class="column-cards" id="cards_col1"></div>
          </div>
          <!-- WS2/TP5 Column -->
          <div class="pipeline-column" data-column="2" data-ws="ws2" data-tp="tp5"
               ondragover="SEP.handleDragOver(event)" ondrop="SEP.handleDrop(event, '2')" ondragleave="SEP.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title-group">WS2 / TP5</span>
              <span class="column-count" id="count_col2">0</span>
            </div>
            <div class="column-cards" id="cards_col2"></div>
          </div>
          <!-- WS3/TP6 Column -->
          <div class="pipeline-column" data-column="3" data-ws="ws3" data-tp="tp6"
               ondragover="SEP.handleDragOver(event)" ondrop="SEP.handleDrop(event, '3')" ondragleave="SEP.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title-group">WS3 / TP6</span>
              <span class="column-count" id="count_col3">0</span>
            </div>
            <div class="column-cards" id="cards_col3"></div>
          </div>
          <!-- WS4/TP7 Column -->
          <div class="pipeline-column" data-column="4" data-ws="ws4" data-tp="tp7"
               ondragover="SEP.handleDragOver(event)" ondrop="SEP.handleDrop(event, '4')" ondragleave="SEP.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title-group">WS4 / TP7</span>
              <span class="column-count" id="count_col4">0</span>
            </div>
            <div class="column-cards" id="cards_col4"></div>
          </div>
          <!-- WS5/TP8 Column -->
          <div class="pipeline-column" data-column="5" data-ws="ws5" data-tp="tp8"
               ondragover="SEP.handleDragOver(event)" ondrop="SEP.handleDrop(event, '5')" ondragleave="SEP.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title-group">WS5 / TP8</span>
              <span class="column-count" id="count_col5">0</span>
            </div>
            <div class="column-cards" id="cards_col5"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Agencies View -->
    <div class="view-panel" id="agenciesView">
      <div class="agencies-layout">
        <!-- Agency Tree -->
        <div class="agency-tree-panel">
          <div class="panel-header">
            <h3>Orgs/Agencies</h3>
            <input type="text" class="search-input-sm" placeholder="Search..."
                   id="agencySearchInput" oninput="SEP.filterAgencies()">
          </div>
          <div class="tree-legend">
            <span class="legend-item"><span class="heat-dot hot"></span>4+</span>
            <span class="legend-item"><span class="heat-dot warm"></span>1-3</span>
            <span class="legend-item"><span class="heat-dot cold"></span>0</span>
            <span style="color: var(--color-text-muted);">engagements</span>
          </div>
          <div class="panel-content" id="agencyTree">
            <div class="loading-state">
              <span class="loading-spinner"></span>
            </div>
          </div>
        </div>

        <!-- Agency Detail -->
        <div class="agency-detail-panel">
          <div class="panel-header">
            <h3 id="agencyDetailTitle">Select an Agency</h3>
          </div>
          <div class="panel-content" id="agencyDetail">
            <div class="empty-state">
              <span class="material-icons">home</span>
              <p>Select an agency to view details</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Solution Detail Modal -->
<div class="modal-overlay" id="solutionModal" onclick="SEP.closeModal('solutionModal', event)">
  <div class="modal-content modal-lg" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="modalSolutionName">Solution Details</h2>
      <button class="modal-close" onclick="SEP.closeModal('solutionModal')">&times;</button>
    </div>
    <div class="modal-body" id="solutionModalBody">
      <!-- Dynamic content -->
    </div>
  </div>
</div>

<!-- Log Engagement Modal -->
<div class="modal-overlay" id="engagementModal" onclick="SEP.closeModal('engagementModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Log Engagement</h2>
      <button class="modal-close" onclick="SEP.closeModal('engagementModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="engagementForm" onsubmit="SEP.submitEngagement(event)">
        <div class="form-row">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="engDate" required>
          </div>
          <div class="form-group">
            <label>Activity Type</label>
            <select id="engActivityType" required>
              <option value="Email">Email</option>
              <option value="Phone">Phone</option>
              <option value="Meeting">Meeting</option>
              <option value="Webinar">Webinar</option>
              <option value="Conference">Conference</option>
              <option value="Site Visit">Site Visit</option>
              <option value="Training">Training</option>
            </select>
          </div>
          <div class="form-group">
            <label>Direction</label>
            <select id="engDirection">
              <option value="Outbound">Outbound</option>
              <option value="Inbound">Inbound</option>
              <option value="Bidirectional">Bidirectional</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Subject</label>
          <input type="text" id="engSubject" placeholder="Brief subject line" required>
        </div>
        <div class="form-group">
          <label>Participants (emails, comma-separated)</label>
          <input type="text" id="engParticipants" placeholder="email1@example.com, email2@example.com">
        </div>
        <div class="form-group">
          <label>Solution</label>
          <select id="engSolution">
            <option value="">-- Select Solution --</option>
            <!-- Populated dynamically -->
          </select>
        </div>
        <div class="form-group">
          <label>Summary</label>
          <textarea id="engSummary" rows="3" maxlength="2000" placeholder="Brief summary of the engagement"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Follow-up Date (optional)</label>
            <input type="date" id="engFollowUp">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="SEP.closeModal('engagementModal')">Cancel</button>
          <button type="submit" class="btn btn-primary" id="engSubmitBtn">Log Engagement</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Contact Detail Modal -->
<div class="modal-overlay" id="contactModal" onclick="SEP.closeModal('contactModal', event)">
  <div class="modal-content modal-md" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="modalContactName">Contact Details</h2>
      <button class="modal-close" onclick="SEP.closeModal('contactModal')">&times;</button>
    </div>
    <div class="modal-body" id="contactModalBody">
      <!-- Populated dynamically -->
    </div>
  </div>
</div>

<!-- Engagement Detail Modal -->
<div class="modal-overlay" id="engagementDetailModal" onclick="SEP.closeModal('engagementDetailModal', event)">
  <div class="modal-content modal-sm" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Engagement Details</h2>
      <button class="modal-close" onclick="SEP.closeModal('engagementDetailModal')">&times;</button>
    </div>
    <div class="modal-body" id="engagementDetailContent">
      <!-- Populated dynamically -->
    </div>
  </div>
</div>

<!-- All Engagements Modal -->
<div class="modal-overlay" id="allEngagementsModal" onclick="SEP.closeModal('allEngagementsModal', event)">
  <div class="modal-content modal-lg" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">All Engagements</h2>
      <button class="modal-close" onclick="SEP.closeModal('allEngagementsModal')">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Filters -->
      <div class="engagement-filters">
        <div class="filter-group">
          <label>Activity Type</label>
          <select id="filterActivityType" onchange="SEP.filterAllEngagements()">
            <option value="">All Types</option>
            <option value="Email">Email</option>
            <option value="Phone">Phone</option>
            <option value="Meeting">Meeting</option>
            <option value="Webinar">Webinar</option>
            <option value="Conference">Conference</option>
            <option value="Site Visit">Site Visit</option>
            <option value="Training">Training</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date Range</label>
          <select id="filterDateRange" onchange="SEP.filterAllEngagements()">
            <option value="30">Last 30 Days</option>
            <option value="60">Last 60 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">Last Year</option>
            <option value="all">All Time</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Search</label>
          <input type="text" id="filterEngagementSearch" placeholder="Search subject or summary..." oninput="SEP.filterAllEngagements()">
        </div>
      </div>
      <!-- Engagement List -->
      <div id="allEngagementsList" class="all-engagements-list">
        <div class="loading-state"><span class="loading-spinner"></span></div>
      </div>
    </div>
  </div>
</div>

<!-- Contact Engagement History Modal -->
<div class="modal-overlay" id="contactHistoryModal" onclick="SEP.closeModal('contactHistoryModal', event)">
  <div class="modal-content modal-lg" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="contactHistoryTitle">Engagement History</h2>
      <button class="modal-close" onclick="SEP.closeModal('contactHistoryModal')">&times;</button>
    </div>
    <div class="modal-body" id="contactHistoryContent">
      <div class="loading-state"><span class="loading-spinner"></span></div>
    </div>
  </div>
</div>

<!-- Link Contact Modal -->
<div class="modal-overlay" id="linkContactModal" onclick="SEP.closeModal('linkContactModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Add Contact to <span id="linkContactAgencyName">Agency</span></h2>
      <button class="modal-close" onclick="SEP.closeModal('linkContactModal')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Search Existing Contacts</label>
        <input type="text" id="contactSearchInput" placeholder="Search by name or email..."
               oninput="SEP.searchContactsForLink(this.value)">
        <div class="form-hint">Click a result below to link them to this agency</div>
      </div>
      <div id="contactSearchResults" class="contact-search-results">
        <div class="search-hint">Type to search existing contacts</div>
      </div>
      <div class="link-contact-divider">
        <span>or create new</span>
      </div>
      <div class="form-group">
        <label>Create New Contact</label>
        <p class="form-hint" style="margin-bottom: var(--space-sm);">Only use this if the contact doesn't exist in the system yet.</p>
        <div class="new-contact-form">
          <div class="form-row">
            <div class="form-group">
              <label>First Name</label>
              <input type="text" id="newContactFirst" placeholder="First name">
            </div>
            <div class="form-group">
              <label>Last Name</label>
              <input type="text" id="newContactLast" placeholder="Last name">
            </div>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="newContactEmail" placeholder="email@agency.gov">
          </div>
          <div class="form-group">
            <label>Title/Role</label>
            <input type="text" id="newContactTitle" placeholder="Title or role">
          </div>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="SEP.closeModal('linkContactModal')">Cancel</button>
        <button class="btn btn-primary" id="addNewContactBtn" onclick="SEP.addNewContactToAgency()">
          <span class="material-icons">person_add</span> Create New Contact
        </button>
      </div>
    </div>
  </div>
</div>

<!-- vis.js for Network Graph -->
<script src="https://unpkg.com/vis-network@9.1.6/standalone/umd/vis-network.min.js"></script>

<!-- SEP Styles -->
<style>
  /* Page accent color for shared styles */
  .sep-viewer {
    --page-accent: var(--color-sep);
    max-width: 1600px;
    margin: 0 auto;
  }

  /* Header filter (cycle dropdown in page header) */
  .header-filter select {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    background: var(--color-surface);
    color: var(--color-text-secondary);
  }

  /* Main Panels: The "How" section */
  .main-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .main-panels .panel {
    border-top: 3px solid var(--page-accent);
    min-height: 300px;
    max-height: 400px;
    display: flex;
    flex-direction: column;
  }

  .main-panels .panel-content {
    flex: 1;
    overflow-y: auto;
  }

  /* Pipeline Summary: The "Where" section */
  .pipeline-summary {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-sm);
  }

  .summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .summary-header h3 {
    font-size: var(--font-size-md);
    font-weight: 600;
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* SEP legend */
  .sep-viewer .pipeline-legend {
    display: flex;
    gap: var(--space-md);
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .sep-viewer .legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* SEP dot colors */
  .dot-ws { background: #7B1FA2; } /* Purple for Working Sessions */
  .dot-tp { background: #1565C0; } /* Blue for Touchpoints */

  /* SEP pipeline columns (compact for summary) */
  .sep-viewer .pipeline-column { max-height: 250px; }
  .sep-viewer .column-header {
    border-top: 3px solid var(--color-sep);
    border-radius: var(--radius-md) var(--radius-md) 0 0;
  }
  .column-title-group {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
  }
  .column-title-ws, .column-title-tp { color: inherit; }
  .column-divider { opacity: 0.5; }

  /* SEP count badge */
  .sep-viewer .column-count { font-size: 10px; }

  /* Drag and drop states */
  .pipeline-column.drag-over {
    background: #e8f5e9;
    outline: 2px dashed #4CAF50;
    outline-offset: -2px;
  }
  .pipeline-card.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
  }

  /* SEP card customizations */
  .sep-viewer .column-cards { padding: var(--space-xs); }
  .sep-viewer .pipeline-card {
    padding: var(--space-xs) var(--space-sm);
    cursor: grab;
    user-select: none;
  }
  .pipeline-card:active { cursor: grabbing; }
  .card-id { font-weight: 700; font-size: 11px; color: var(--color-sep); text-transform: uppercase; }

  /* Card milestone dates */
  .card-dates {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
    font-size: 10px;
    font-weight: 500;
  }
  .date-ws { color: #7B1FA2; }
  .date-tp { color: #1565C0; }

  /* Card border colors based on current milestone */
  .pipeline-card.card-ws { border-left-color: #7B1FA2; }
  .pipeline-card.card-tp { border-left-color: #1565C0; }
  .card-org { font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-bottom: 4px; }
  .card-solutions {
    font-size: var(--font-size-xs);
    color: var(--color-sep);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* SEP card meta uses smaller spacing */
  .sep-viewer .card-meta {
    font-size: 10px;
    color: var(--color-text-muted);
    margin-top: 4px;
    padding-top: 4px;
    border-top: 1px solid var(--color-border-light);
  }
  .card-date-warning { color: var(--color-warning); }
  .card-date-overdue { color: var(--color-error); font-weight: 600; }

  /* Heat level styling for activity stat */
  .stat-card.heat-hot .stat-icon {
    color: var(--color-error);
  }
  .stat-card.heat-warm .stat-icon {
    color: var(--color-warning);
  }
  .stat-card.heat-cold .stat-icon {
    color: var(--color-info);
  }
  .stat-card.heat-hot .stat-value {
    color: var(--color-error);
  }
  .stat-card.heat-warm .stat-value {
    color: var(--color-warning);
  }
  .stat-card.heat-cold .stat-value {
    color: var(--color-info);
  }

  /* SEP panels use border-top accent like Implementation */
  .sep-viewer .panel {
    border-top: 3px solid var(--page-accent);
  }

  /* Agency Browser Mini */
  .agency-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
  }
  .agency-item:hover { background: var(--color-surface-alt); }
  .agency-item.active { background: rgba(21, 101, 192, 0.1); border-left: 3px solid var(--color-sep) !important; }
  .agency-item.has-children { font-weight: 500; }
  .agency-toggle {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
    transition: transform var(--transition-fast);
  }
  .agency-toggle.expanded { transform: rotate(90deg); }
  .agency-name { flex: 1; font-size: var(--font-size-base); }
  .agency-count {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    background: var(--color-surface-alt);
    padding: 2px 6px;
    border-radius: 10px;
  }
  .agency-children { padding-left: var(--space-lg); }

  /* Drop Dialog */
  .drop-dialog p { margin-bottom: var(--space-md); }
  .drop-options {
    display: flex;
    gap: var(--space-sm);
    justify-content: center;
    flex-wrap: wrap;
  }

  /* Engagement Detail Modal */
  .modal-sm .modal-content { max-width: 500px; }
  .engagement-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .engagement-detail-item {
    padding: 8px 12px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
  }
  .engagement-detail-label {
    font-size: 10px;
    text-transform: uppercase;
    color: var(--color-text-muted);
    margin-bottom: 2px;
    letter-spacing: 0.5px;
  }
  .engagement-detail-value {
    font-size: var(--font-size-sm);
    font-weight: 500;
  }
  .engagement-detail-full {
    grid-column: 1 / -1;
  }
  .engagement-summary-box {
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    padding: 12px;
    font-size: var(--font-size-sm);
    line-height: 1.5;
    white-space: pre-wrap;
  }

  /* Recent Engagements */
  .engagement-item {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--color-sep);
    margin-bottom: var(--space-sm);
    background: var(--color-surface-alt);
  }
  .engagement-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(21, 101, 192, 0.1);
    border-radius: var(--radius-sm);
    color: var(--color-sep);
  }
  .engagement-icon svg { width: 16px; height: 16px; }
  .engagement-info { flex: 1; }
  .engagement-subject { font-weight: 500; font-size: var(--font-size-sm); }
  .engagement-meta { font-size: var(--font-size-xs); color: var(--color-text-secondary); }

  /* Agencies View */
  .agencies-layout {
    display: grid;
    grid-template-columns: 25% 1fr;
    gap: var(--space-md);
  }
  .agency-tree-panel, .agency-detail-panel {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }
  .tree-legend {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-xs) var(--space-md);
    font-size: 10px;
    color: var(--color-text-muted);
    border-bottom: 1px solid var(--color-border-light);
  }
  .tree-legend .legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .tree-legend .heat-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }
  .search-input-sm {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    width: 100px;
  }

  /* Agency Detail */
  .agency-detail-header {
    display: flex;
    gap: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--color-border-light);
    margin-bottom: 8px;
  }
  .agency-logo {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--color-sep), #60a5fa);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }
  .agency-info { flex: 1; min-width: 0; }
  .agency-full-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; line-height: 1.2; }
  .agency-type { font-size: 11px; color: var(--color-text-secondary); }
  .agency-website { margin-top: 2px; }
  .agency-website a {
    font-size: 11px;
    color: var(--color-primary);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .agency-website a:hover { text-decoration: underline; }
  .agency-website svg { width: 12px; height: 12px; }

  .mission-statement {
    background: var(--color-bg-subtle);
    padding: 8px 10px;
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
    border-left: 3px solid var(--color-sep);
  }
  .mission-text {
    font-size: 12px;
    color: var(--color-text);
    line-height: 1.4;
    font-style: italic;
  }

  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 12px;
    margin-bottom: 8px;
  }
  .detail-item { margin-bottom: 2px; }
  .detail-label { font-size: 10px; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 1px; }
  .detail-value { font-size: 12px; color: var(--color-text); }

  .data-interests, .mission-areas, .relationship-notes {
    background: var(--color-bg-subtle);
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    margin-top: 6px;
  }
  .data-interests .detail-label,
  .mission-areas .detail-label,
  .relationship-notes .detail-label { margin-bottom: 2px; }
  .data-interests .detail-value,
  .mission-areas .detail-value,
  .relationship-notes .detail-value { font-size: 11px; line-height: 1.4; }

  .status-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 500;
  }
  .status-badge.status-established { background: #dcfce7; color: #166534; }
  .status-badge.status-developing { background: #fef3c7; color: #92400e; }
  .status-badge.status-new { background: #dbeafe; color: #1e40af; }
  .status-badge.status-strong { background: #d1fae5; color: #065f46; }
  .status-badge.status-dormant { background: #f3f4f6; color: #6b7280; }
  .status-badge.status-closed { background: #fecaca; color: #991b1b; }
  .status-badge.status-merged { background: #e9d5ff; color: #7c3aed; }

  /* Agency Engagement Stats */
  .agency-engagement-stats {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .engagement-stat {
    flex: 1;
    text-align: center;
    padding: var(--space-xs);
  }
  .engagement-stat-value { font-size: 18px; font-weight: 700; color: var(--color-text); }
  .engagement-stat-label { font-size: 9px; color: var(--color-text-muted); text-transform: uppercase; }
  .heat-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .heat-indicator.heat-hot { background: #fecaca; color: #dc2626; }
  .heat-indicator.heat-warm { background: #fed7aa; color: #ea580c; }
  .heat-indicator.heat-cold { background: #e0e7ff; color: #4f46e5; }
  .heat-indicator .material-icons { font-size: 12px; }

  /* Solution Tags */
  .solution-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
    margin-top: 4px;
  }
  .solution-tag {
    display: inline-block;
    padding: 1px 5px;
    background: rgba(21, 101, 192, 0.15);
    color: var(--color-sep);
    font-size: 9px;
    font-weight: 600;
    border-radius: 3px;
    text-transform: uppercase;
  }

  /* Agency Contact Cards */
  .agency-contacts-section {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--color-border-light);
  }
  .agency-contacts-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-xs);
  }
  .agency-contacts-header h4 {
    font-size: 11px;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    margin: 0;
  }
  .agency-contact-card {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-xs);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
    margin-bottom: 4px;
  }
  .agency-contact-card:hover { background: var(--color-surface-alt); }
  .contact-avatar-sm {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, var(--color-sep), #60a5fa);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 600;
    color: white;
    flex-shrink: 0;
  }
  .contact-card-info { flex: 1; min-width: 0; }
  .contact-card-name { font-size: 12px; font-weight: 500; }
  .contact-card-role { font-size: 10px; color: var(--color-text-muted); }

  /* Link Contact Modal */
  .contact-search-results {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-md);
  }
  .search-hint {
    padding: var(--space-md);
    text-align: center;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
  }
  .contact-search-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
    border-bottom: 1px solid var(--color-border-light);
  }
  .contact-search-item:last-child { border-bottom: none; }
  .contact-search-item:hover { background: var(--color-surface-alt); }
  .contact-search-item.selected { background: rgba(21, 101, 192, 0.1); }
  .contact-search-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--color-sep), #60a5fa);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    color: white;
    flex-shrink: 0;
  }
  .contact-search-info { flex: 1; }
  .contact-search-name { font-weight: 500; font-size: var(--font-size-sm); }
  .contact-search-email { font-size: var(--font-size-xs); color: var(--color-text-muted); }
  .contact-search-agency { font-size: 10px; color: var(--color-text-secondary); }
  .link-contact-divider {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin: var(--space-md) 0;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
  }
  .link-contact-divider::before,
  .link-contact-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--color-border);
  }
  .new-contact-form { margin-top: var(--space-sm); }

  /* Agency Timeline */
  .agency-timeline-section {
    margin-top: var(--space-sm);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--color-border-light);
  }
  .agency-timeline-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-xs);
  }
  .agency-timeline-header h4 {
    font-size: 11px;
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    margin: 0;
  }
  .timeline-item {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-xs) 0;
    border-bottom: 1px solid var(--color-border-light);
    transition: background var(--transition-fast);
    border-radius: var(--radius-sm);
    margin: 0 calc(-1 * var(--space-xs));
    padding: var(--space-xs);
  }
  .timeline-item:hover { background: var(--color-surface-alt); }
  .timeline-item:last-child { border-bottom: none; }
  .timeline-icon {
    width: 24px;
    height: 24px;
    background: rgba(21, 101, 192, 0.1);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .timeline-icon .material-icons { font-size: 14px; color: var(--color-sep); }
  .timeline-content { flex: 1; min-width: 0; }
  .timeline-subject { font-size: 11px; font-weight: 500; }
  .timeline-meta { font-size: 9px; color: var(--color-text-muted); }
  .timeline-contacts { font-size: 9px; color: var(--color-text-secondary); margin-top: 2px; }

  /* Agency Tree Heat Map */
  .agency-item.heat-hot { background: rgba(239, 68, 68, 0.08); border-left: 3px solid #ef4444; }
  .agency-item.heat-warm { background: rgba(249, 115, 22, 0.08); border-left: 3px solid #f97316; }
  .agency-item.heat-cold { border-left: 3px solid transparent; }
  .agency-item .heat-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-left: auto;
    flex-shrink: 0;
  }
  .heat-dot.hot { background: #ef4444; }
  .heat-dot.warm { background: #f97316; }
  .heat-dot.cold { background: #94a3b8; }

  /* Agency Detail Tabs */
  .agency-tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid var(--color-border-light);
    margin-bottom: var(--space-md);
  }
  .agency-tab {
    padding: var(--space-sm) var(--space-md);
    font-size: 12px;
    font-weight: 500;
    color: var(--color-text-muted);
    cursor: pointer;
    border: none;
    background: none;
    position: relative;
    transition: color var(--transition-fast);
  }
  .agency-tab:hover { color: var(--color-text); }
  .agency-tab.active {
    color: var(--color-sep);
  }
  .agency-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--color-sep);
  }
  .agency-tab-panel { display: none; }
  .agency-tab-panel.active { display: block; }

  /* Quick Actions */
  .quick-actions {
    display: flex;
    gap: var(--space-xs);
    margin: var(--space-sm) 0;
  }
  .quick-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
    color: var(--color-text);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  .quick-action-btn:hover {
    background: var(--color-sep);
    border-color: var(--color-sep);
    color: white;
  }
  .quick-action-btn .material-icons { font-size: 14px; }

  /* Enhanced Metrics Row */
  .agency-metrics {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
  }
  .metric-card {
    background: linear-gradient(135deg, var(--color-surface-alt), var(--color-surface));
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-sm);
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
  }
  .metric-card.metric-engagements::before { background: var(--color-sep); }
  .metric-card.metric-contacts::before { background: #22c55e; }
  .metric-card.metric-solutions::before { background: #f59e0b; }
  .metric-card.metric-heat::before { background: #ef4444; }
  .metric-value { font-size: 24px; font-weight: 700; color: var(--color-text); line-height: 1.2; }
  .metric-label { font-size: 10px; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .metric-trend {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    font-size: 10px;
    margin-top: 4px;
  }
  .metric-trend.up { color: #22c55e; }
  .metric-trend.down { color: #ef4444; }
  .metric-trend.neutral { color: var(--color-text-muted); }
  .metric-trend .material-icons { font-size: 12px; }

  /* Enhanced Contact Cards */
  .contact-card-enhanced {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-xs);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  .contact-card-enhanced:hover {
    border-color: var(--color-sep);
    box-shadow: 0 2px 8px rgba(21, 101, 192, 0.1);
  }
  .contact-avatar-md {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--color-sep), #60a5fa);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: white;
    flex-shrink: 0;
  }
  .contact-details { flex: 1; min-width: 0; }
  .contact-name-row {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  .contact-name { font-size: 13px; font-weight: 500; }
  .contact-engagement-badge {
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 10px;
    font-weight: 500;
  }
  .contact-engagement-badge.high { background: #dcfce7; color: #166534; }
  .contact-engagement-badge.medium { background: #fef3c7; color: #92400e; }
  .contact-engagement-badge.low { background: #fee2e2; color: #991b1b; }
  .contact-role-title { font-size: 11px; color: var(--color-text-muted); }
  .contact-last-engagement { font-size: 10px; color: var(--color-text-secondary); margin-top: 2px; }
  .contact-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity var(--transition-fast);
  }
  .contact-card-enhanced:hover .contact-actions { opacity: 1; }
  .contact-action-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
    transition: all var(--transition-fast);
  }
  .contact-action-btn:hover {
    background: var(--color-sep);
    color: white;
  }
  .contact-action-btn.contact-action-remove:hover {
    background: #ef4444;
    color: white;
  }
  .contact-action-btn .material-icons { font-size: 16px; }

  /* Notes Section */
  .notes-section textarea {
    width: 100%;
    min-height: 120px;
    padding: var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 12px;
    line-height: 1.5;
    resize: vertical;
  }
  .notes-section textarea:focus {
    outline: none;
    border-color: var(--color-sep);
  }
  .notes-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-xs);
    margin-top: var(--space-sm);
  }

  /* Network Graph */
  .network-container {
    display: flex;
    flex-direction: column;
    height: 400px;
  }
  .network-legend {
    display: flex;
    gap: var(--space-md);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .network-legend .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--color-text-muted);
  }
  .legend-node {
    width: 14px;
    height: 14px;
    border-radius: 50%;
  }
  .legend-node.contact-node {
    background: var(--color-sep);
  }
  .legend-node.solution-node {
    background: #10b981;
    border-radius: 3px;
  }
  .network-graph {
    height: 400px;
    min-height: 300px;
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
  }
  .network-help {
    font-size: 10px;
    color: var(--color-text-muted);
    text-align: center;
    margin-top: var(--space-xs);
  }
  .network-legend {
    display: flex;
    justify-content: center;
    gap: var(--space-md);
    padding: var(--space-xs) 0;
    font-size: 11px;
    color: var(--color-text-secondary);
  }
  .legend-stat {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 2px;
  }
  .legend-dot.agency { background: #1565c0; border-radius: 0; transform: rotate(45deg); width: 8px; height: 8px; }
  .legend-dot.contact { background: #0ea5e9; border-radius: 50%; }
  .legend-dot.solution { background: #10b981; }

  /* Modal & Forms */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: var(--space-md);
  }
  .modal-overlay.active { display: flex; }
  .modal-content {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .modal-content.modal-md { max-width: 600px; }
  .modal-content.modal-lg { max-width: 900px; }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }
  .modal-title { font-size: var(--font-size-lg); font-weight: 600; margin: 0; }
  .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-muted); }
  .modal-close:hover { color: var(--color-text); }
  .modal-body { padding: var(--space-lg); overflow-y: auto; }

  .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); }
  .form-group { margin-bottom: var(--space-md); }
  .form-group label { display: block; font-size: var(--font-size-sm); font-weight: 500; margin-bottom: var(--space-xs); }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: inherit;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--color-sep);
  }
  .form-hint {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-xs);
  }
  .form-actions { display: flex; justify-content: flex-end; gap: var(--space-sm); margin-top: var(--space-md); }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: none;
  }
  .btn svg { width: 16px; height: 16px; }
  .btn-primary { background: var(--color-sep); color: white; }
  .btn-primary:hover { background: var(--color-primary-dark); }
  .btn-secondary { background: var(--color-surface-alt); color: var(--color-text); border: 1px solid var(--color-border); }
  .btn-secondary:hover { background: var(--color-border-light); }
  .btn-danger { background: #ef4444; color: white; border: none; }
  .btn-danger:hover { background: #dc2626; }
  .btn-sm { padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-xs); }
  .btn-sm .material-icons { font-size: 16px; }
  .engagement-detail-actions { display: flex; gap: var(--space-xs); }

  /* Loading & Empty States */
  .loading-state { text-align: center; padding: var(--space-lg); color: var(--color-text-muted); }
  .loading-spinner {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-sep);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
  @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
  .empty-state { text-align: center; padding: var(--space-lg); color: var(--color-text-muted); }
  .empty-state svg { width: 48px; height: 48px; margin-bottom: var(--space-sm); opacity: 0.5; }

  /* Needs Attention Panel */
  .attention-panel .panel-header { background: rgba(239, 68, 68, 0.1); }
  .attention-count {
    background: var(--color-error);
    color: white;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: var(--font-size-sm);
    font-weight: 600;
  }
  .attention-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
    cursor: pointer;
    transition: background var(--transition-fast);
  }
  .attention-item:hover { background: var(--color-surface-alt); }
  .attention-item.overdue { border-left: 3px solid var(--color-error); background: rgba(239, 68, 68, 0.05); }
  .attention-item.due-soon { border-left: 3px solid var(--color-warning); background: rgba(237, 108, 2, 0.05); }
  .attention-info { flex: 1; min-width: 0; }
  .attention-name { font-weight: 500; font-size: var(--font-size-sm); }
  .attention-org { font-size: var(--font-size-xs); color: var(--color-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .attention-status {
    font-size: var(--font-size-xs);
    font-weight: 600;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    white-space: nowrap;
  }
  .attention-status.overdue { background: var(--color-error); color: white; }
  .attention-status.due-soon { background: var(--color-warning); color: white; }
  .attention-action {
    padding: 4px 8px;
    font-size: var(--font-size-xs);
    background: var(--color-sep);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
  }
  .attention-action:hover { background: var(--color-primary-dark); }

  /* Engagement Filters */
  .engagement-filters {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
  }
  .filter-group { display: flex; flex-direction: column; gap: var(--space-xs); }
  .filter-group label { font-size: var(--font-size-xs); color: var(--color-text-muted); text-transform: uppercase; }
  .filter-group select, .filter-group input {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    min-width: 150px;
  }

  /* All Engagements List */
  .all-engagements-list { max-height: 500px; overflow-y: auto; }
  .engagement-row {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
    cursor: pointer;
    transition: background var(--transition-fast);
  }
  .engagement-row:hover { background: var(--color-surface-alt); }
  .engagement-row-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(21, 101, 192, 0.1);
    border-radius: var(--radius-sm);
    color: var(--color-sep);
    flex-shrink: 0;
  }
  .engagement-row-info { flex: 1; min-width: 0; }
  .engagement-row-subject { font-weight: 500; font-size: var(--font-size-sm); }
  .engagement-row-meta { font-size: var(--font-size-xs); color: var(--color-text-secondary); }
  .engagement-row-date { font-size: var(--font-size-sm); color: var(--color-text-muted); white-space: nowrap; }
  .engagement-count-badge {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-bottom: var(--space-sm);
  }

  /* Contact History Timeline */
  .history-timeline { position: relative; padding-left: var(--space-lg); }
  .history-timeline::before {
    content: '';
    position: absolute;
    left: 12px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--color-border-light);
  }
  .history-item {
    position: relative;
    padding-bottom: var(--space-md);
    margin-bottom: var(--space-md);
  }
  .history-item::before {
    content: '';
    position: absolute;
    left: calc(-1 * var(--space-lg) + 8px);
    top: 4px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--color-sep);
    border: 2px solid var(--color-surface);
  }
  .history-date { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs); }
  .history-content {
    background: var(--color-surface-alt);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
  }
  .history-subject { font-weight: 500; margin-bottom: var(--space-xs); }
  .history-meta { font-size: var(--font-size-xs); color: var(--color-text-secondary); }
  .history-summary { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-xs); }

  /* Inline Edit Controls */
  .inline-edit-group {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
  .inline-select {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
    cursor: pointer;
  }
  .inline-select:focus { border-color: var(--color-sep); outline: none; }
  .inline-date {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
  }
  .save-indicator {
    font-size: var(--font-size-xs);
    color: var(--color-success);
    opacity: 0;
    transition: opacity var(--transition-fast);
  }
  .save-indicator.visible { opacity: 1; }

  /* Contact Detail (in modal) */
  .contact-detail-header {
    display: flex;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
  }
  .contact-avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--color-sep), #60a5fa);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }
  .contact-detail-info { flex: 1; }
  .contact-detail-name { font-size: var(--font-size-xl); font-weight: 600; margin-bottom: var(--space-xs); }
  .contact-detail-email { color: var(--color-sep); margin-bottom: var(--space-xs); }
  .contact-detail-org { color: var(--color-text-secondary); font-size: var(--font-size-sm); }
  .detail-section { margin-bottom: var(--space-lg); }
  .detail-section-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--color-border-light);
  }
  .touchpoint-badge {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-sep);
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
  }
  .engagement-level-badge {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    background: rgba(21, 101, 192, 0.1);
    color: var(--color-sep);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }

  /* Solution Detail Modal */
  .solution-detail-header {
    display: flex;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
  }
  .solution-avatar {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--color-sep), #60a5fa);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }
  .solution-info { flex: 1; }
  .solution-id { font-size: var(--font-size-sm); font-weight: 700; color: var(--color-sep); text-transform: uppercase; }
  .solution-name { font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--space-xs); }
  .solution-meta { font-size: var(--font-size-sm); color: var(--color-text-secondary); }

  /* Milestone Timeline */
  .milestone-timeline {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--space-sm);
  }
  .milestone-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    background: var(--color-surface-alt);
    position: relative;
  }
  .milestone-item.completed { background: rgba(46, 125, 50, 0.1); }
  .milestone-item.milestone-ws .milestone-marker { background: #7B1FA2; }
  .milestone-item.milestone-tp .milestone-marker { background: #1565C0; }
  .milestone-item.completed .milestone-marker { background: #2E7D32; }
  .milestone-marker {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--color-text-muted);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: var(--space-xs);
  }
  .milestone-content { width: 100%; }
  .milestone-label { font-size: 11px; font-weight: 700; color: var(--color-text); }
  .milestone-name { font-size: 9px; color: var(--color-text-muted); margin-bottom: var(--space-xs); line-height: 1.2; }
  .milestone-date-row { display: flex; align-items: center; justify-content: center; gap: 4px; }
  .milestone-date-input {
    font-size: 10px;
    padding: 2px 4px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    width: 90px;
  }
  .milestone-link {
    color: var(--color-sep);
    display: flex;
    align-items: center;
  }
  .milestone-link .material-icons { font-size: 14px; }

  /* Outreach Panel */
  .outreach-panel .panel-header { background: rgba(255, 152, 0, 0.1); }
  .outreach-panel .panel-header h3 { color: var(--color-warning); }
  .outreach-panel .outreach-count {
    background: var(--color-warning);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
  }
  .outreach-list { max-height: 200px; overflow-y: auto; }
  .outreach-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xs);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
    border-left: 3px solid var(--color-warning);
    margin-bottom: 4px;
  }
  .outreach-item:hover { background: var(--color-surface); }
  .outreach-id { font-weight: 700; font-size: 10px; color: var(--color-sep); }
  .outreach-name { font-size: 10px; color: var(--color-text); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .outreach-count-badge {
    font-size: 9px;
    background: var(--color-surface);
    padding: 1px 6px;
    border-radius: 8px;
    color: var(--color-text-muted);
  }

  /* Responsive */
  @media (max-width: 1400px) {
    .pipeline-board { grid-template-columns: repeat(5, 1fr); }
  }
  @media (max-width: 1200px) {
    .pipeline-board { grid-template-columns: repeat(5, 1fr); }
    .bottom-panels { grid-template-columns: 1fr; }
  }
  @media (max-width: 900px) {
    .pipeline-board { grid-template-columns: repeat(3, 1fr); }
  }
  @media (max-width: 768px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .pipeline-board { grid-template-columns: repeat(2, 1fr); }
    .form-row { grid-template-columns: 1fr; }
    /* Stack search under title on smaller screens */
    .agency-tree-panel .panel-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-xs);
    }
    .agency-tree-panel .search-input-sm {
      width: 100%;
    }
    /* Hide "engagements" text in legend */
    .tree-legend > span:last-child {
      display: none;
    }
  }
</style>

<!-- SEP JavaScript -->
<script>
var SEP = (function() {
  // SEP Milestone definitions
  var MILESTONES = ['ws1', 'tp4', 'ws2', 'tp5', 'ws3', 'tp6', 'ws4', 'tp7', 'ws5', 'tp8'];

  // Combined columns: each column contains a WS/TP pair
  var COLUMNS = [
    { id: '1', ws: 'ws1', tp: 'tp4', label: 'WS1/TP4' },
    { id: '2', ws: 'ws2', tp: 'tp5', label: 'WS2/TP5' },
    { id: '3', ws: 'ws3', tp: 'tp6', label: 'WS3/TP6' },
    { id: '4', ws: 'ws4', tp: 'tp7', label: 'WS4/TP7' },
    { id: '5', ws: 'ws5', tp: 'tp8', label: 'WS5/TP8' }
  ];

  // Map milestone to column
  var MILESTONE_TO_COLUMN = {
    'ws1': '1', 'tp4': '1',
    'ws2': '2', 'tp5': '2',
    'ws3': '3', 'tp6': '3',
    'ws4': '4', 'tp7': '4',
    'ws5': '5', 'tp8': '5'
  };

  var state = {
    solutions: [],
    solutionsByMilestone: {},
    stats: null,
    agencies: [],
    agencyHierarchy: [],
    agencyEngagementCounts: {},
    engagements: [],
    currentView: 'pipeline',
    selectedAgency: null,
    selectedAgencyData: null,
    selectedSolution: null,
    // Filter state
    cycles: [],
    filterCycle: null,
    filterMilestone: 'all',
    needsOutreach: [],
    // Link Contact modal
    linkContactAgencyId: null,
    // Network graph
    currentAgencyContacts: [],
    agencyNetwork: null,
    // Agency timeline (for engagement clicks)
    currentAgencyTimeline: [],
    // Engagement detail
    currentEngagementDetail: null,
    editingEngagementId: null
  };

  // Store all engagements for filtering
  var allEngagementsCache = [];

  function init() {
    setDefaultDate();
    loadDashboardStats();
    loadSolutionsWithProgress();
    loadCycles();
    loadNeedsOutreach();
    loadAgencies();
    loadRecentEngagements();
  }

  function loadDashboardStats() {
    google.script.run
      .withSuccessHandler(function(stats) {
        if (!stats) return;

        // Populate stat values
        var engEl = document.getElementById('statEngagementsMonth');
        var contactsEl = document.getElementById('statContactsEngaged');
        var solutionsEl = document.getElementById('statSolutionsEngaged');
        var heatLabelEl = document.getElementById('statHeatLabel');
        var heatIconEl = document.getElementById('statHeatIcon');
        var heatCardEl = document.getElementById('statHeatCard');

        if (engEl) engEl.textContent = stats.engagements_this_month || 0;
        if (contactsEl) contactsEl.textContent = stats.contacts_this_month || 0;
        if (solutionsEl) solutionsEl.textContent = stats.solutions_this_month || 0;

        if (heatLabelEl && heatIconEl) {
          var level = stats.heat_level || 'cold';
          heatLabelEl.textContent = level.charAt(0).toUpperCase() + level.slice(1);
          heatIconEl.textContent = stats.heat_icon || 'ac_unit';

          // Update card styling based on heat level
          if (heatCardEl) {
            heatCardEl.classList.remove('heat-hot', 'heat-warm', 'heat-cold');
            heatCardEl.classList.add('heat-' + level);

            // Add tooltip with engagement counts
            var weekCount = stats.last_week_count || 0;
            var twoWeekCount = stats.last_two_weeks_count || 0;
            var tooltipText = weekCount + ' engagement' + (weekCount !== 1 ? 's' : '') + ' this week, ' +
                              twoWeekCount + ' in past 2 weeks';
            heatCardEl.title = tooltipText;
          }
        }
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load dashboard stats:', error);
      })
      .getSEPDashboardStats();
  }

  function loadSolutionsWithProgress() {
    // Load solutions grouped by SEP milestone
    google.script.run
      .withSuccessHandler(function(grouped) {
        state.solutionsByMilestone = grouped || {};
        renderPipeline();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load solutions by milestone:', error);
        showPipelineError('Failed to load solutions');
      })
      .getSolutionsBySEPMilestone();

    // Load full solutions list (has complete data including dates)
    google.script.run
      .withSuccessHandler(function(solutions) {
        state.solutions = (solutions || []).filter(function(s) { return s && s.core_id; });
        populateSolutionDropdown();
        // Re-render pipeline to show dates now that full data is available
        renderPipeline();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load solutions:', error);
      })
      .getSolutions();
  }

  function populateSolutionDropdown() {
    var select = document.getElementById('engSolution');
    if (!select) return;

    select.innerHTML = '<option value="">-- Select Solution --</option>';

    var sorted = state.solutions.slice().sort(function(a, b) {
      return (a.core_id || '').localeCompare(b.core_id || '');
    });

    sorted.forEach(function(sol) {
      var opt = document.createElement('option');
      opt.value = sol.core_id;
      opt.textContent = sol.core_id.toUpperCase() + ' - ' + (sol.core_official_name || '');
      select.appendChild(opt);
    });
  }

  function setDefaultDate() {
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('engDate').value = today;
  }

  function loadAgencies() {
    // Load both agency hierarchy and engagement counts
    var loadedHierarchy = false;
    var loadedCounts = false;

    function tryRender() {
      if (loadedHierarchy && loadedCounts) {
        renderAgencyTree();
      }
    }

    google.script.run
      .withSuccessHandler(function(hierarchy) {
        state.agencyHierarchy = hierarchy || [];
        loadedHierarchy = true;
        tryRender();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load agencies:', error);
        loadedHierarchy = true;
        tryRender();
      })
      .getAgencyHierarchy();

    google.script.run
      .withSuccessHandler(function(counts) {
        state.agencyEngagementCounts = counts || {};
        loadedCounts = true;
        tryRender();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load engagement counts:', error);
        state.agencyEngagementCounts = {};
        loadedCounts = true;
        tryRender();
      })
      .getEngagementCountsByAgency();
  }

  function loadRecentEngagements() {
    google.script.run
      .withSuccessHandler(function(engagements) {
        state.engagements = engagements || [];
        renderRecentEngagements();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load engagements:', error);
        document.getElementById('recentEngagements').innerHTML =
          '<div class="empty-state"><p>No engagements logged yet</p></div>';
      })
      .getRecentEngagements(30, 10);
  }


  function renderPipeline() {
    // Render each combined column
    COLUMNS.forEach(function(col) {
      var container = document.getElementById('cards_col' + col.id);
      var countEl = document.getElementById('count_col' + col.id);
      if (!container || !countEl) return;

      // Get solutions from both WS and TP milestones for this column
      var wsSolutions = getFilteredSolutions(col.ws);
      var tpSolutions = getFilteredSolutions(col.tp);

      // Combine and deduplicate (a solution might appear in both WS and TP)
      var seen = {};
      var allSolutions = [];
      wsSolutions.concat(tpSolutions).forEach(function(sol) {
        if (!seen[sol.core_id]) {
          seen[sol.core_id] = true;
          // Determine current milestone for this solution
          sol._currentMilestone = getCurrentMilestone(sol);
          allSolutions.push(sol);
        }
      });

      // Sort by ID
      allSolutions.sort(function(a, b) {
        return (a.core_id || '').localeCompare(b.core_id || '');
      });

      if (countEl) countEl.textContent = allSolutions.length;

      if (allSolutions.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: var(--space-sm); font-size: 10px; color: var(--color-text-muted);">No solutions</div>';
      } else {
        var html = allSolutions.slice(0, 20).map(function(sol) {
          return renderSolutionCard(sol, col);
        }).join('');
        if (allSolutions.length > 20) {
          html += '<div style="text-align: center; padding: var(--space-xs); font-size: 10px; color: var(--color-text-muted);">+' + (allSolutions.length - 20) + ' more</div>';
        }
        container.innerHTML = html;
      }
    });
  }

  // Determine which milestone a solution is currently at
  function getCurrentMilestone(sol) {
    // Check milestones in reverse order - return the latest completed one
    var order = ['tp8', 'ws5', 'tp7', 'ws4', 'tp6', 'ws3', 'tp5', 'ws2', 'tp4', 'ws1'];
    for (var i = 0; i < order.length; i++) {
      var ms = order[i];
      var dateField = 'sep_' + ms + '_date';
      if (sol[dateField]) {
        return ms;
      }
    }
    return 'ws1'; // Default to first milestone
  }

  // ========================================================================
  // FILTERS & OUTREACH
  // ========================================================================

  function loadCycles() {
    google.script.run
      .withSuccessHandler(function(cycles) {
        state.cycles = cycles || [];
        renderCycleDropdown();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load cycles:', error);
      })
      .getSEPCycles();
  }

  function renderCycleDropdown() {
    var select = document.getElementById('filterCycle');
    if (!select) return;

    select.innerHTML = '<option value="">All Cycles</option>';
    state.cycles.forEach(function(cycle) {
      var opt = document.createElement('option');
      opt.value = cycle;
      opt.textContent = 'Cycle ' + cycle;
      select.appendChild(opt);
    });
  }

  function loadNeedsOutreach() {
    google.script.run
      .withSuccessHandler(function(solutions) {
        state.needsOutreach = solutions || [];
        renderNeedsOutreach();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load outreach:', error);
        document.getElementById('outreachList').innerHTML =
          '<div style="font-size: 10px; color: var(--color-text-muted); padding: 4px;">Could not load</div>';
      })
      .getSolutionsNeedingOutreach(2);
  }

  function renderNeedsOutreach() {
    var container = document.getElementById('outreachList');
    var countEl = document.getElementById('outreachCount');
    var solutions = state.needsOutreach || [];

    if (countEl) countEl.textContent = solutions.length;

    if (solutions.length === 0) {
      container.innerHTML = '<div style="font-size: 10px; color: var(--color-text-muted); padding: 4px; text-align: center;">All solutions are well engaged</div>';
      return;
    }

    var html = solutions.map(function(sol) {
      return '<div class="outreach-item" onclick="SEP.showSolutionDetail(\'' + escapeAttr(sol.core_id) + '\')">' +
        '<span class="outreach-id">' + escapeHtml(sol.core_id) + '</span>' +
        '<span class="outreach-name">' + escapeHtml(sol.core_official_name || '') + '</span>' +
        '<span class="outreach-count-badge">' + (sol.engagement_count || 0) + '</span>' +
        '</div>';
    }).join('');

    container.innerHTML = html;
  }

  function applyFilters() {
    var cycleFilter = document.getElementById('filterCycle').value;
    state.filterCycle = cycleFilter ? parseInt(cycleFilter) : null;
    renderPipeline();
  }

  function setMilestoneFilter(filter) {
    state.filterMilestone = filter;

    // Update toggle button states
    document.querySelectorAll('.toggle-btn').forEach(function(btn) {
      btn.classList.remove('active');
      if (btn.dataset.filter === filter) {
        btn.classList.add('active');
      }
    });

    renderPipeline();
  }

  function getFilteredSolutions(milestone) {
    var solutions = state.solutionsByMilestone[milestone] || [];

    // Apply cycle filter
    if (state.filterCycle) {
      solutions = solutions.filter(function(sol) {
        return parseInt(sol.core_cycle) === state.filterCycle;
      });
    }

    return solutions;
  }

  function shouldShowMilestone(milestone) {
    if (!state.filterMilestone || state.filterMilestone === 'all') return true;
    if (state.filterMilestone === 'ws') return milestone.startsWith('ws');
    if (state.filterMilestone === 'tp') return milestone.startsWith('tp');
    return true;
  }

  function renderSolutionCard(sol, col) {
    // Get full solution from state.solutions (has date fields)
    var fullSol = null;
    if (state.solutions && state.solutions.length > 0) {
      fullSol = state.solutions.find(function(s) {
        return s.core_id === sol.core_id;
      });
    }

    // Fallback to sol if not found
    if (!fullSol) fullSol = sol;

    // Get dates using confirmed field names
    var wsDate = fullSol['sep_' + col.ws + '_date'] || '';
    var tpDate = fullSol['sep_' + col.tp + '_date'] || '';
    var currentMs = sol._currentMilestone || getCurrentMilestone(fullSol);

    // Determine card border color based on current milestone
    var borderClass = currentMs.startsWith('ws') ? 'card-ws' : 'card-tp';

    var html = '<div class="pipeline-card ' + borderClass + '" draggable="true" ' +
      'data-solution-id="' + escapeAttr(sol.core_id) + '" ' +
      'title="' + escapeAttr(sol.core_official_name || sol.core_id) + '" ' +
      'ondragstart="SEP.handleDragStart(event, \'' + escapeAttr(sol.core_id) + '\')" ' +
      'ondragend="SEP.handleDragEnd(event)" ' +
      'onclick="SEP.showSolutionDetail(\'' + escapeAttr(sol.core_id) + '\')">';
    html += '<div class="card-id">' + escapeHtml(sol.core_id) + '</div>';

    // Show milestone dates
    html += '<div class="card-dates">';
    html += '<span class="date-ws">' + (wsDate ? formatShortDate(wsDate) : '--') + '</span>';
    html += '<span class="date-tp">' + (tpDate ? formatShortDate(tpDate) : '--') + '</span>';
    html += '</div>';
    html += '</div>';
    return html;
  }

  function formatShortDate(dateStr) {
    if (!dateStr) return '--';
    try {
      var d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return (d.getMonth() + 1) + '/' + d.getDate();
    } catch (e) {
      return dateStr;
    }
  }

  // ========================================================================
  // DRAG AND DROP
  // ========================================================================

  var draggedSolutionId = null;

  function handleDragStart(event, solutionId) {
    draggedSolutionId = solutionId;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', solutionId);
  }

  function handleDragEnd(event) {
    event.target.classList.remove('dragging');
    draggedSolutionId = null;
    // Remove drag-over class from all columns
    document.querySelectorAll('.pipeline-column').forEach(function(col) {
      col.classList.remove('drag-over');
    });
  }

  function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    var column = event.target.closest('.pipeline-column');
    if (column) {
      column.classList.add('drag-over');
    }
  }

  function handleDragLeave(event) {
    var column = event.target.closest('.pipeline-column');
    if (column && !column.contains(event.relatedTarget)) {
      column.classList.remove('drag-over');
    }
  }

  function handleDrop(event, columnId) {
    event.preventDefault();
    var column = event.target.closest('.pipeline-column');
    if (column) {
      column.classList.remove('drag-over');
    }

    var solutionId = event.dataTransfer.getData('text/plain') || draggedSolutionId;
    if (!solutionId) return;

    // Find the column definition
    var targetColumn = COLUMNS.find(function(c) { return c.id === columnId; });
    if (!targetColumn) return;

    // Show milestone selection dialog
    showMilestoneDropDialog(solutionId, targetColumn);
  }

  function showMilestoneDropDialog(solutionId, column) {
    // Find the solution
    var solution = findSolutionById(solutionId);
    if (!solution) return;

    var wsLabel = column.ws.toUpperCase();
    var tpLabel = column.tp.toUpperCase();
    var wsDate = solution['sep_' + column.ws + '_date'] || '';
    var tpDate = solution['sep_' + column.tp + '_date'] || '';

    var html = '<div class="drop-dialog">';
    html += '<p>Move <strong>' + escapeHtml(solutionId) + '</strong> to:</p>';
    html += '<div class="drop-options">';
    html += '<button class="btn btn-sm" style="background: #7B1FA2; color: white;" onclick="SEP.setMilestoneDate(\'' + escapeAttr(solutionId) + '\', \'' + column.ws + '\')">';
    html += wsLabel + (wsDate ? ' (' + formatShortDate(wsDate) + ')' : ' (set date)');
    html += '</button>';
    html += '<button class="btn btn-sm" style="background: #1565C0; color: white;" onclick="SEP.setMilestoneDate(\'' + escapeAttr(solutionId) + '\', \'' + column.tp + '\')">';
    html += tpLabel + (tpDate ? ' (' + formatShortDate(tpDate) + ')' : ' (set date)');
    html += '</button>';
    html += '</div>';
    html += '<button class="btn btn-sm btn-secondary" style="margin-top: var(--space-sm);" onclick="SEP.closeDropDialog()">Cancel</button>';
    html += '</div>';

    // Create overlay
    var overlay = document.createElement('div');
    overlay.id = 'dropDialogOverlay';
    overlay.className = 'modal-overlay active';
    overlay.innerHTML = '<div class="modal-content modal-sm" style="max-width: 300px; text-align: center;" onclick="event.stopPropagation()">' + html + '</div>';
    overlay.onclick = function() { closeDropDialog(); };
    document.body.appendChild(overlay);
  }

  function closeDropDialog() {
    var overlay = document.getElementById('dropDialogOverlay');
    if (overlay) overlay.remove();
  }

  function setMilestoneDate(solutionId, milestone) {
    closeDropDialog();

    // Prompt for date
    var today = new Date().toISOString().split('T')[0];
    var dateStr = prompt('Enter date for ' + milestone.toUpperCase() + ' (YYYY-MM-DD):', today);
    if (!dateStr) return;

    // Validate date format
    if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
      alert('Please use YYYY-MM-DD format');
      return;
    }

    // Update via API
    google.script.run
      .withSuccessHandler(function() {
        // Reload pipeline
        loadSolutionsWithProgress();
      })
      .withFailureHandler(function(error) {
        alert('Failed to update milestone: ' + error.message);
      })
      .updateSolutionSEPMilestone(solutionId, milestone, dateStr);
  }

  function findSolutionById(solutionId) {
    var solution = state.solutions.find(function(s) { return s.core_id === solutionId; });
    if (!solution) {
      for (var ms in state.solutionsByMilestone) {
        var found = (state.solutionsByMilestone[ms] || []).find(function(s) { return s.core_id === solutionId; });
        if (found) { solution = found; break; }
      }
    }
    return solution;
  }

  // ========================================================================
  // SOLUTION DETAIL
  // ========================================================================

  function showSolutionDetail(solutionId) {
    // Find solution in state
    var solution = state.solutions.find(function(s) { return s.core_id === solutionId; });
    if (!solution) {
      // Try to find in milestone groups
      for (var ms in state.solutionsByMilestone) {
        var found = (state.solutionsByMilestone[ms] || []).find(function(s) { return s.core_id === solutionId; });
        if (found) { solution = found; break; }
      }
    }
    if (!solution) {
      alert('Solution not found: ' + solutionId);
      return;
    }

    state.selectedSolution = solution;
    document.getElementById('modalSolutionName').textContent = solution.core_id + ' - ' + (solution.core_official_name || 'Unnamed');

    var html = renderSolutionDetailContent(solution);
    document.getElementById('solutionModalBody').innerHTML = html;
    document.getElementById('solutionModal').classList.add('active');
  }

  function renderSolutionDetailContent(sol) {
    var html = '';

    // Header with basic info
    html += '<div class="solution-detail-header">';
    html += '<div class="solution-avatar">' + escapeHtml((sol.core_id || 'XX').substring(0, 2).toUpperCase()) + '</div>';
    html += '<div class="solution-info">';
    html += '<div class="solution-id">' + escapeHtml(sol.core_id) + '</div>';
    html += '<div class="solution-name">' + escapeHtml(sol.core_official_name || '') + '</div>';
    html += '<div class="solution-meta">Cycle ' + escapeHtml(String(sol.core_cycle || '--')) + ' | ' + escapeHtml(sol.admin_lifecycle_phase || 'Unknown phase') + '</div>';
    html += '</div></div>';

    // SEP Progress Section
    html += '<div class="detail-section">';
    html += '<div class="detail-section-title">SEP Milestones <span class="save-indicator" id="sepSaveIndicator"> Saved</span></div>';
    html += renderMilestoneTimeline(sol);
    html += '</div>';

    // Team Section
    if (sol.team_lead || sol.team_ra_rep) {
      html += '<div class="detail-section">';
      html += '<div class="detail-section-title">Team</div>';
      html += '<div class="detail-grid">';
      if (sol.team_lead) {
        html += '<div class="detail-item"><div class="detail-label">Solution Lead</div><div class="detail-value">' + escapeHtml(sol.team_lead) + '</div></div>';
      }
      if (sol.team_ra_rep) {
        html += '<div class="detail-item"><div class="detail-label">RA Representative</div><div class="detail-value">' + escapeHtml(sol.team_ra_rep) + '</div></div>';
      }
      html += '</div></div>';
    }

    // Actions
    html += '<div style="display: flex; gap: var(--space-sm); margin-top: var(--space-lg); flex-wrap: wrap;">';
    html += '<button class="btn btn-primary" onclick="SEP.logEngagementForSolution(\'' + escapeAttr(sol.core_id) + '\')"><span class="material-icons">add</span> Log Engagement</button>';
    html += '<button class="btn btn-secondary" onclick="SEP.showSolutionEngagements(\'' + escapeAttr(sol.core_id) + '\')"><span class="material-icons">history</span> View Engagements</button>';
    html += '</div>';

    return html;
  }

  function renderMilestoneTimeline(sol) {
    var milestoneLabels = {
      ws1: 'WS1', tp4: 'TP4', ws2: 'WS2', tp5: 'TP5',
      ws3: 'WS3', tp6: 'TP6', ws4: 'WS4', tp7: 'TP7',
      ws5: 'WS5', tp8: 'TP8'
    };
    var milestoneNames = {
      ws1: 'Working Session 1', tp4: 'Touchpoint 4 - Outreach',
      ws2: 'Working Session 2', tp5: 'Touchpoint 5 - Transition',
      ws3: 'Working Session 3', tp6: 'Touchpoint 6 - Training',
      ws4: 'Working Session 4', tp7: 'Touchpoint 7 - Adoption',
      ws5: 'Working Session 5', tp8: 'Touchpoint 8 - Impact'
    };

    var html = '<div class="milestone-timeline">';

    MILESTONES.forEach(function(ms, idx) {
      var dateField = 'sep_' + ms + '_date';
      var urlField = 'sep_' + ms + '_url';
      var dateValue = sol[dateField] || '';
      var urlValue = sol[urlField] || '';
      var isCompleted = dateValue && String(dateValue).trim();
      var isWS = ms.startsWith('ws');

      html += '<div class="milestone-item ' + (isCompleted ? 'completed' : '') + ' ' + (isWS ? 'milestone-ws' : 'milestone-tp') + '">';
      html += '<div class="milestone-marker">' + (isCompleted ? '' : (idx + 1)) + '</div>';
      html += '<div class="milestone-content">';
      html += '<div class="milestone-label">' + milestoneLabels[ms] + '</div>';
      html += '<div class="milestone-name">' + milestoneNames[ms] + '</div>';
      html += '<div class="milestone-date-row">';
      html += '<input type="date" class="milestone-date-input" value="' + (dateValue ? formatDateForInput(dateValue) : '') + '" onchange="SEP.updateMilestoneDate(\'' + escapeAttr(sol.core_id) + '\', \'' + ms + '\', this.value)">';
      if (urlValue) {
        html += '<a href="' + escapeAttr(urlValue) + '" target="_blank" class="milestone-link"><span class="material-icons">link</span></a>';
      }
      html += '</div>';
      html += '</div></div>';
    });

    html += '</div>';
    return html;
  }

  function formatDateForInput(dateStr) {
    if (!dateStr) return '';
    try {
      var d = new Date(dateStr);
      return d.toISOString().split('T')[0];
    } catch (e) {
      return '';
    }
  }

  function updateMilestoneDate(solutionId, milestoneId, date) {
    var indicator = document.getElementById('sepSaveIndicator');
    if (indicator) {
      indicator.textContent = 'Saving...';
      indicator.classList.add('visible');
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          if (indicator) {
            indicator.textContent = ' Saved';
            setTimeout(function() { indicator.classList.remove('visible'); }, 2000);
          }
          // Refresh pipeline
          loadSolutionsWithProgress();
        } else {
          if (indicator) {
            indicator.textContent = ' ' + (result.error || 'Failed');
            indicator.style.color = 'var(--color-error)';
          }
        }
      })
      .withFailureHandler(function(err) {
        if (indicator) {
          indicator.textContent = ' Failed';
          indicator.style.color = 'var(--color-error)';
        }
        console.error('Failed to update milestone:', err);
      })
      .updateSolutionSEPMilestone(solutionId, milestoneId, date);
  }

  function logEngagementForSolution(solutionId) {
    closeModal('solutionModal');
    showLogEngagementModal();
    document.getElementById('engSolution').value = solutionId;
  }

  function showSolutionEngagements(solutionId) {
    // TODO: Show engagements filtered by solution
    closeModal('solutionModal');
    showAllEngagements();
    // Could pre-filter by solution if we add that capability
  }

  function renderAgencyTree() {
    var container = document.getElementById('agencyTree');
    if (!state.agencyHierarchy || state.agencyHierarchy.length === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">home</span><p>No agencies configured</p></div>';
return;
    }

    var html = '';
    state.agencyHierarchy.forEach(function(agency) {
      html += renderAgencyTreeItem(agency, 0);
    });
    container.innerHTML = html;
}

  function renderAgencyTreeItem(agency, level) {
    var hasChildren = agency.children && agency.children.length > 0;
    var indent = level * 20;
    var isClosed = agency.status && (agency.status.toLowerCase() === 'closed' || agency.status.toLowerCase() === 'merged');

    // Determine heat level from engagement count (not relationship_status)
    var engagementCount = state.agencyEngagementCounts[agency.agency_id] || 0;
    var heatClass = '';
    var heatDot = 'cold';
    var heatTooltip = engagementCount + ' engagement' + (engagementCount !== 1 ? 's' : '');
    if (engagementCount >= 4) {
      heatClass = 'heat-hot';
      heatDot = 'hot';
    } else if (engagementCount >= 1) {
      heatClass = 'heat-warm';
      heatDot = 'warm';
    }

    var html = '<div class="agency-item' + (hasChildren ? ' has-children' : '') + (isClosed ? ' agency-closed' : '') + (heatClass ? ' ' + heatClass : '') + '" style="padding-left: ' + (indent + 8) + 'px;' + (isClosed ? ' opacity: 0.6;' : '') + '" onclick="SEP.selectAgency(\'' + escapeAttr(agency.agency_id) + '\')" title="' + heatTooltip + '">';
    if (hasChildren) {
      html += '<span class="agency-toggle" data-agency="' + escapeAttr(agency.agency_id) + '" onclick="event.stopPropagation(); SEP.toggleAgencyChildren(\'' + escapeAttr(agency.agency_id) + '\')"><span class="material-icons">chevron_right</span></span>';
    } else {
      html += '<span style="width: 16px;"></span>';
    }
    html += '<span class="agency-name">' + escapeHtml(agency.name || agency.abbreviation || 'Unknown');
    if (isClosed) {
      html += ' <span style="font-size: 9px; color: var(--color-text-muted);">(' + escapeHtml(agency.status) + ')</span>';
    }
    html += '</span>';
    // Heat indicator dot based on engagement count
    if (!isClosed) {
      html += '<span class="heat-dot ' + heatDot + '"></span>';
    }
    html += '</div>';

    if (hasChildren) {
      html += '<div class="agency-children" id="children_' + escapeAttr(agency.agency_id) + '" style="display: none;">';
      agency.children.forEach(function(child) {
        html += renderAgencyTreeItem(child, level + 1);
      });
      html += '</div>';
    }

    return html;
  }

  function toggleAgencyChildren(agencyId) {
    var childrenEl = document.getElementById('children_' + agencyId);
    var toggleEl = document.querySelector('.agency-toggle[data-agency="' + agencyId + '"]');
    if (childrenEl && toggleEl) {
      var isExpanded = childrenEl.style.display !== 'none';
      childrenEl.style.display = isExpanded ? 'none' : 'block';
      toggleEl.classList.toggle('expanded', !isExpanded);
    }
  }

  function selectAgency(agencyId) {
    // Clean up previous network graph
    destroyAgencyNetwork();

    state.selectedAgency = agencyId;
    state.selectedAgencyData = null;
    state.selectedAgencyStats = null;
    state.selectedAgencyContacts = null;
    state.selectedAgencyTimeline = null;

    // Highlight active agency in tree
    document.querySelectorAll('#agencyTree .agency-item').forEach(function(item) {
      item.classList.remove('active');
    });
    var activeItem = document.querySelector('#agencyTree .agency-item[onclick*="' + agencyId + '"]');
    if (activeItem) activeItem.classList.add('active');

    document.getElementById('agencyDetailTitle').textContent = 'Loading...';
    document.getElementById('agencyDetail').innerHTML = '<div class="loading-state"><span class="loading-spinner"></span></div>';

    // Load agency details
    google.script.run
      .withSuccessHandler(function(agency) {
        state.selectedAgencyData = agency;
        renderAgencyDetailIfReady();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load agency:', error);
        document.getElementById('agencyDetail').innerHTML =
          '<div class="empty-state"><p>Failed to load agency details</p></div>';
      })
      .getAgencyById(agencyId);

    // Load engagement stats
    google.script.run
      .withSuccessHandler(function(stats) {
        state.selectedAgencyStats = stats;
        renderAgencyDetailIfReady();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load agency stats:', error);
        state.selectedAgencyStats = { total_engagements: 0, heat_status: 'cold' };
        renderAgencyDetailIfReady();
      })
      .getAgencyEngagementStats(agencyId);

    // Load contacts with solution tags
    google.script.run
      .withSuccessHandler(function(contacts) {
        state.selectedAgencyContacts = contacts;
        renderAgencyDetailIfReady();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load contacts:', error);
        state.selectedAgencyContacts = [];
        renderAgencyDetailIfReady();
      })
      .getAgencyContactsWithTags(agencyId);

    // Load engagement timeline
    google.script.run
      .withSuccessHandler(function(timeline) {
        state.selectedAgencyTimeline = timeline;
        renderAgencyDetailIfReady();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load timeline:', error);
        state.selectedAgencyTimeline = [];
        renderAgencyDetailIfReady();
      })
      .getAgencyEngagementTimeline(agencyId, 10);
  }

  function renderAgencyDetailIfReady() {
    // Only render when all data is loaded
    if (state.selectedAgencyData === null ||
        state.selectedAgencyStats === null ||
        state.selectedAgencyContacts === null ||
        state.selectedAgencyTimeline === null) {
      return;
    }
    renderAgencyDetail(
      state.selectedAgencyData,
      state.selectedAgencyStats,
      state.selectedAgencyContacts,
      state.selectedAgencyTimeline
    );
  }

  function renderAgencyDetail(agency, stats, contacts, timeline) {
    if (!agency) {
      document.getElementById('agencyDetail').innerHTML =
        '<div class="empty-state"><p>Agency not found</p></div>';
      return;
    }

    stats = stats || { total_engagements: 0, heat_status: 'cold' };
    contacts = contacts || [];
    timeline = timeline || [];

    var titleText = agency.name || agency.abbreviation;
    if (agency.status && agency.status.toLowerCase() !== 'active') {
      titleText += ' (' + agency.status + ')';
    }
    document.getElementById('agencyDetailTitle').textContent = titleText;

    var initials = (agency.abbreviation || agency.name || 'AG').substring(0, 2).toUpperCase();
    var isClosed = agency.status && (agency.status.toLowerCase() === 'closed' || agency.status.toLowerCase() === 'merged');

    var html = '';

    // Agency Header with logo and info
    html += '<div class="agency-detail-header">';
    html += '<div class="agency-logo" style="' + (isClosed ? 'opacity: 0.5;' : '') + '">' + initials + '</div>';
    html += '<div class="agency-info">';
    html += '<div class="agency-full-name">' + escapeHtml(agency.full_name || agency.name || '') + '</div>';
    html += '<div class="agency-type">' + escapeHtml(agency.type || 'Organization');
    if (isClosed) {
      html += ' <span class="status-badge status-' + agency.status.toLowerCase() + '">' + escapeHtml(agency.status) + '</span>';
    }
    html += '</div>';
    if (agency.website_url) {
      html += '<div class="agency-website"><a href="' + escapeAttr(agency.website_url) + '" target="_blank">';
      html += '<span class="material-icons">open_in_new</span> Website</a></div>';
    }
    html += '</div></div>';

    // Quick Actions
    html += '<div class="quick-actions">';
    html += '<button class="quick-action-btn" onclick="SEP.showLogEngagementModalForAgency(\'' + escapeAttr(agency.agency_id) + '\')">';
    html += '<span class="material-icons">add_circle</span>Log Engagement</button>';
    html += '<button class="quick-action-btn" onclick="SEP.showLinkContactModal(\'' + escapeAttr(agency.agency_id) + '\')">';
    html += '<span class="material-icons">person_add</span>Add Contact</button>';
    if (agency.website_url) {
      html += '<a class="quick-action-btn" href="' + escapeAttr(agency.website_url) + '" target="_blank">';
      html += '<span class="material-icons">open_in_new</span>Website</a>';
    }
    html += '</div>';

    // Metrics Cards Row
    html += '<div class="agency-metrics">';
    html += '<div class="metric-card metric-engagements">';
    html += '<div class="metric-value">' + (stats.total_engagements || 0) + '</div>';
    html += '<div class="metric-label">Engagements</div>';
    var thisMonth = stats.by_month ? (stats.by_month[getCurrentMonth()] || 0) : 0;
    var lastMonth = stats.by_month ? (stats.by_month[getLastMonth()] || 0) : 0;
    var trend = thisMonth > lastMonth ? 'up' : (thisMonth < lastMonth ? 'down' : 'neutral');
    var trendIcon = trend === 'up' ? 'trending_up' : (trend === 'down' ? 'trending_down' : 'trending_flat');
    html += '<div class="metric-trend ' + trend + '"><span class="material-icons">' + trendIcon + '</span>' + thisMonth + ' this month</div>';
    html += '</div>';

    html += '<div class="metric-card metric-contacts">';
    html += '<div class="metric-value">' + contacts.length + '</div>';
    html += '<div class="metric-label">Contacts</div>';
    html += '<div class="metric-trend neutral">' + (stats.contacts_engaged || 0) + ' engaged</div>';
    html += '</div>';

    html += '<div class="metric-card metric-solutions">';
    html += '<div class="metric-value">' + (stats.solutions_engaged ? stats.solutions_engaged.length : 0) + '</div>';
    html += '<div class="metric-label">Solutions</div>';
    html += '<div class="metric-trend neutral">involved with</div>';
    html += '</div>';

    html += '<div class="metric-card metric-heat">';
    var heatIcon = stats.heat_status === 'hot' ? 'whatshot' : (stats.heat_status === 'warm' ? 'wb_sunny' : 'ac_unit');
    var heatLabel = stats.heat_status === 'hot' ? 'Hot' : (stats.heat_status === 'warm' ? 'Warm' : 'Cold');
    html += '<div class="metric-value"><span class="material-icons" style="font-size: 24px; color: ' + (stats.heat_status === 'hot' ? '#ef4444' : stats.heat_status === 'warm' ? '#f97316' : '#6366f1') + ';">' + heatIcon + '</span></div>';
    html += '<div class="metric-label">' + heatLabel + '</div>';
    if (stats.last_engagement_date) {
      html += '<div class="metric-trend neutral">' + stats.days_since_last + ' days ago</div>';
    } else {
      html += '<div class="metric-trend neutral">No activity</div>';
    }
    html += '</div>';
    html += '</div>';

    // Tabs
    html += '<div class="agency-tabs">';
    html += '<button class="agency-tab active" onclick="SEP.switchAgencyTab(\'overview\')">Overview</button>';
    html += '<button class="agency-tab" onclick="SEP.switchAgencyTab(\'contacts\')">Contacts (' + contacts.length + ')</button>';
    html += '<button class="agency-tab" onclick="SEP.switchAgencyTab(\'engagements\')">Engagements (' + timeline.length + ')</button>';
    html += '<button class="agency-tab" onclick="SEP.switchAgencyTab(\'notes\')">Notes</button>';
    html += '<button class="agency-tab" onclick="SEP.switchAgencyTab(\'network\')"><span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 2px;">hub</span>Network</button>';
    html += '</div>';

    // Tab: Overview
    html += '<div class="agency-tab-panel active" id="agencyTab_overview">';
    if (agency.mission_statement) {
      html += '<div class="mission-statement">';
      html += '<div class="detail-label">Mission</div>';
      html += '<div class="mission-text">' + escapeHtml(agency.mission_statement) + '</div>';
      html += '</div>';
    }
    html += '<div class="detail-grid">';
    if (agency.geographic_scope) {
      html += '<div class="detail-item"><div class="detail-label">Geographic Scope</div>';
      html += '<div class="detail-value">' + escapeHtml(agency.geographic_scope) + '</div></div>';
    }
    if (agency.data_interests) {
      html += '<div class="detail-item"><div class="detail-label">Data Interests</div>';
      html += '<div class="detail-value">' + escapeHtml(agency.data_interests) + '</div></div>';
    }
    if (agency.poc_name) {
      html += '<div class="detail-item"><div class="detail-label">Primary POC</div>';
      html += '<div class="detail-value">' + escapeHtml(agency.poc_name) + '</div></div>';
    }
    if (agency.successor_agency_id) {
      html += '<div class="detail-item"><div class="detail-label">Successor Agency</div>';
      html += '<div class="detail-value"><a href="#" onclick="SEP.selectAgency(\'' + escapeAttr(agency.successor_agency_id) + '\'); return false;">' + escapeHtml(agency.successor_agency_id) + '</a></div></div>';
    }
    html += '</div>';
    // Top solutions for this agency
    if (stats.solutions_engaged && stats.solutions_engaged.length > 0) {
      html += '<div style="margin-top: var(--space-sm);">';
      html += '<div class="detail-label">Solutions Engaged</div>';
      html += '<div class="solution-tags" style="margin-top: 4px;">';
      stats.solutions_engaged.slice(0, 8).forEach(function(sol) {
        html += '<span class="solution-tag">' + escapeHtml(sol) + '</span>';
      });
      if (stats.solutions_engaged.length > 8) {
        html += '<span class="solution-tag">+' + (stats.solutions_engaged.length - 8) + '</span>';
      }
      html += '</div></div>';
    }
    html += '</div>';

    // Tab: Contacts
    html += '<div class="agency-tab-panel" id="agencyTab_contacts">';
    if (contacts.length === 0) {
      html += '<div class="empty-state" style="padding: var(--space-md);"><p>No contacts linked to this agency</p>';
      html += '<button class="btn btn-primary btn-sm" onclick="SEP.showLinkContactModal(\'' + escapeAttr(agency.agency_id) + '\')"><span class="material-icons">person_add</span> Add Contact</button></div>';
    } else {
      contacts.forEach(function(c) {
        var contactInitials = ((c.first_name || '').charAt(0) + (c.last_name || '').charAt(0)).toUpperCase() || '?';
        var engagementLevel = c.solution_tags ? (c.solution_tags.length >= 3 ? 'high' : (c.solution_tags.length >= 1 ? 'medium' : 'low')) : 'low';
        html += '<div class="contact-card-enhanced" onclick="SEP.showContactDetail(\'' + escapeAttr(c.email) + '\')">';
        html += '<div class="contact-avatar-md">' + contactInitials + '</div>';
        html += '<div class="contact-details">';
        html += '<div class="contact-name-row">';
        html += '<span class="contact-name">' + escapeHtml((c.first_name || '') + ' ' + (c.last_name || '')) + '</span>';
        if (c.solution_tags && c.solution_tags.length > 0) {
          html += '<span class="contact-engagement-badge ' + engagementLevel + '">' + c.solution_tags.length + ' solutions</span>';
        }
        html += '</div>';
        html += '<div class="contact-role-title">' + escapeHtml(c.title || c.role || 'No title') + '</div>';
        if (c.last_contact_date) {
          html += '<div class="contact-last-engagement">Last contact: ' + escapeHtml(c.last_contact_date) + '</div>';
        }
        html += '</div>';
        html += '<div class="contact-actions">';
        html += '<button class="contact-action-btn" onclick="event.stopPropagation(); SEP.logEngagementFor(\'' + escapeAttr(c.email) + '\')" title="Log Engagement"><span class="material-icons">add_circle</span></button>';
        if (c.email) {
          html += '<a class="contact-action-btn" href="mailto:' + escapeAttr(c.email) + '" onclick="event.stopPropagation();" title="Send Email"><span class="material-icons">email</span></a>';
        }
        html += '<button class="contact-action-btn contact-action-remove" onclick="event.stopPropagation(); SEP.removeContactFromAgency(\'' + escapeAttr(c.email) + '\', \'' + escapeAttr(agency.agency_id) + '\')" title="Remove from Agency"><span class="material-icons">person_remove</span></button>';
        html += '</div>';
        html += '</div>';
      });
    }
    html += '</div>';

    // Tab: Engagements
    html += '<div class="agency-tab-panel" id="agencyTab_engagements">';
    if (timeline.length === 0) {
      html += '<div class="empty-state" style="padding: var(--space-md);"><p>No engagements recorded</p>';
      html += '<button class="btn btn-primary btn-sm" onclick="SEP.showLogEngagementModalForAgency(\'' + escapeAttr(agency.agency_id) + '\')"><span class="material-icons">add</span> Log Engagement</button></div>';
    } else {
      var iconMap = { 'Email': 'email', 'Phone': 'phone', 'Meeting': 'groups', 'Webinar': 'videocam', 'Conference': 'location_city', 'Site Visit': 'place', 'Training': 'school' };
      timeline.forEach(function(e, idx) {
        var icon = iconMap[e.activity_type] || 'event';
        html += '<div class="timeline-item" style="cursor: pointer;" onclick="SEP.showAgencyEngagementDetail(' + idx + ')">';
        html += '<div class="timeline-icon"><span class="material-icons">' + icon + '</span></div>';
        html += '<div class="timeline-content">';
        html += '<div class="timeline-subject">' + escapeHtml(e.subject || e.activity_type || 'Engagement') + '</div>';
        html += '<div class="timeline-meta">' + formatDate(e.date) + '  ' + escapeHtml(e.activity_type || '') + (e.solution_id ? '  ' + escapeHtml(e.solution_id) : '') + '</div>';
        if (e.matched_contacts && e.matched_contacts.length > 0) {
          var names = e.matched_contacts.map(function(c) { return c.name; }).join(', ');
          html += '<div class="timeline-contacts">' + escapeHtml(names) + '</div>';
        }
        html += '</div>';
        html += '</div>';
      });
    }
    html += '</div>';

    // Store timeline for engagement clicks
    state.currentAgencyTimeline = timeline;

    // Tab: Notes
    html += '<div class="agency-tab-panel" id="agencyTab_notes">';
    html += '<div class="notes-section">';
    html += '<textarea id="agencyNotes" placeholder="Add notes about this agency relationship, key contacts, or upcoming opportunities...">' + escapeHtml(agency.notes || '') + '</textarea>';
    html += '<div class="notes-actions">';
    html += '<button class="btn btn-secondary btn-sm" onclick="SEP.cancelAgencyNotes()">Cancel</button>';
    html += '<button class="btn btn-primary btn-sm" onclick="SEP.saveAgencyNotes(\'' + escapeAttr(agency.agency_id) + '\')">Save Notes</button>';
    html += '</div></div>';
    html += '</div>';

    // Tab: Network
    html += '<div class="agency-tab-panel" id="agencyTab_network">';
    if (contacts.length === 0) {
      html += '<div class="empty-state" style="padding: var(--space-md);"><span class="material-icons">hub</span><p>No contacts to visualize</p></div>';
    } else {
      html += '<div class="network-container">';
      html += '<div class="network-legend">';
      html += '<span class="legend-item"><span class="legend-node contact-node"></span>Contact</span>';
      html += '<span class="legend-item"><span class="legend-node solution-node"></span>Solution</span>';
      html += '</div>';
      html += '<div id="agencyNetworkGraph" class="network-graph"></div>';
      html += '<div class="network-help">Click and drag to explore. Scroll to zoom.</div>';
      html += '</div>';
    }
    html += '</div>';

    // Store contacts for network rendering
    state.currentAgencyContacts = contacts;

    document.getElementById('agencyDetail').innerHTML = html;
  }

  function getCurrentMonth() {
    var d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
  }

  function getLastMonth() {
    var d = new Date();
    d.setMonth(d.getMonth() - 1);
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
  }

  function switchAgencyTab(tabName) {
    document.querySelectorAll('.agency-tab').forEach(function(tab) {
      tab.classList.remove('active');
    });
    document.querySelectorAll('.agency-tab-panel').forEach(function(panel) {
      panel.classList.remove('active');
    });
    document.querySelector('.agency-tab[onclick*="' + tabName + '"]').classList.add('active');
    document.getElementById('agencyTab_' + tabName).classList.add('active');

    // Initialize network graph when tab is selected
    if (tabName === 'network' && !state.agencyNetwork) {
      setTimeout(function() {
        initAgencyNetwork();
      }, 100);
    }
  }

  function showLogEngagementModalForAgency(agencyId) {
    // Pre-fill engagement modal for this agency
    showLogEngagementModal();
    // Could set agency context here if needed
  }

  function saveAgencyNotes(agencyId) {
    var notes = document.getElementById('agencyNotes').value;
    // TODO: Implement save to backend
    alert('Notes saved (backend integration pending)');
  }

  function cancelAgencyNotes() {
    // Reset to original value
    if (state.selectedAgencyData && state.selectedAgencyData.notes) {
      document.getElementById('agencyNotes').value = state.selectedAgencyData.notes;
    } else {
      document.getElementById('agencyNotes').value = '';
    }
  }

  // ========================================================================
  // NETWORK GRAPH - Cross-Agency Collaboration Visualization
  // ========================================================================

  function initAgencyNetwork() {
    var container = document.getElementById('agencyNetworkGraph');
    if (!container || !state.selectedAgency) {
      return;
    }

    // Show loading state
    container.innerHTML = '<div class="loading-state" style="height: 100%; display: flex; align-items: center; justify-content: center;"><span class="loading-spinner"></span><span style="margin-left: 8px;">Building network...</span></div>';

    // Fetch cross-agency network data
    google.script.run
      .withSuccessHandler(function(networkData) {
        renderCrossAgencyNetwork(container, networkData);
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load network data:', error);
        container.innerHTML = '<div class="empty-state" style="height: 100%; display: flex; align-items: center; justify-content: center;"><p style="color: var(--color-text-muted); font-size: 12px;">Failed to load network data.</p></div>';
      })
      .getCrossAgencyNetwork(state.selectedAgency);
  }

  function renderCrossAgencyNetwork(container, networkData) {
    if (!networkData || !networkData.nodes || networkData.nodes.length === 0) {
      container.innerHTML = '<div class="empty-state" style="height: 100%; display: flex; align-items: center; justify-content: center;"><p style="color: var(--color-text-muted); font-size: 12px;">No solution engagements to visualize.<br>Contacts will connect when they engage with solutions.</p></div>';
      return;
    }

    // Style nodes based on type
    var visNodes = networkData.nodes.map(function(n) {
      var node = {
        id: n.id,
        label: n.label,
        title: n.title
      };

      if (n.type === 'agency') {
        node.shape = 'diamond';
        node.size = n.isStart ? 30 : 20;
        node.color = {
          background: n.isStart ? '#1565c0' : '#6366f1',
          border: n.isStart ? '#0d47a1' : '#4f46e5',
          highlight: { background: n.isStart ? '#1976d2' : '#818cf8', border: n.isStart ? '#0d47a1' : '#4f46e5' }
        };
        node.font = { color: '#fff', size: 10 };
      } else if (n.type === 'contact') {
        node.shape = 'dot';
        node.size = n.isStart ? 18 : 12;
        node.color = {
          background: n.isStart ? '#0ea5e9' : '#94a3b8',
          border: n.isStart ? '#0284c7' : '#64748b',
          highlight: { background: n.isStart ? '#38bdf8' : '#cbd5e1', border: n.isStart ? '#0284c7' : '#64748b' }
        };
        node.font = { color: '#fff', size: 8 };
      } else if (n.type === 'solution') {
        node.shape = 'box';
        node.size = 15;
        node.color = {
          background: '#10b981',
          border: '#059669',
          highlight: { background: '#34d399', border: '#059669' }
        };
        node.font = { color: '#fff', size: 9 };
      }

      return node;
    });

    // Style edges based on type
    var visEdges = networkData.edges.map(function(e) {
      return {
        from: e.from,
        to: e.to,
        color: {
          color: e.type === 'member' ? '#94a3b8' : '#90caf9',
          highlight: e.type === 'member' ? '#64748b' : '#1565c0'
        },
        width: e.type === 'member' ? 1 : 1.5,
        dashes: e.type === 'member' ? true : false
      };
    });

    // Create network
    var data = { nodes: new vis.DataSet(visNodes), edges: new vis.DataSet(visEdges) };
    var options = {
      physics: {
        enabled: true,
        solver: 'forceAtlas2Based',
        forceAtlas2Based: {
          gravitationalConstant: -50,
          centralGravity: 0.008,
          springLength: 120,
          springConstant: 0.05
        },
        stabilization: { iterations: 150 }
      },
      interaction: {
        hover: true,
        tooltipDelay: 100,
        zoomView: true,
        dragView: true
      },
      nodes: {
        borderWidth: 2,
        shadow: true
      },
      edges: {
        smooth: {
          type: 'continuous'
        }
      }
    };

    state.agencyNetwork = new vis.Network(container, data, options);

    // Add network stats legend
    if (networkData.stats) {
      var legendHtml = '<div class="network-legend">';
      legendHtml += '<span class="legend-stat"><span class="legend-dot agency"></span>' + networkData.stats.agencies + ' Agencies</span>';
      legendHtml += '<span class="legend-stat"><span class="legend-dot contact"></span>' + networkData.stats.contacts + ' Contacts</span>';
      legendHtml += '<span class="legend-stat"><span class="legend-dot solution"></span>' + networkData.stats.solutions + ' Solutions</span>';
      legendHtml += '</div>';
      var legendEl = document.createElement('div');
      legendEl.innerHTML = legendHtml;
      container.parentNode.insertBefore(legendEl.firstChild, container.nextSibling);
    }

    // Handle node click
    state.agencyNetwork.on('click', function(params) {
      if (params.nodes.length > 0) {
        var nodeId = params.nodes[0];
        if (nodeId.startsWith('contact_')) {
          var email = nodeId.replace('contact_', '');
          showContactDetail(email);
        } else if (nodeId.startsWith('solution_')) {
          var solId = nodeId.replace('solution_', '');
          showSolutionDetail(solId);
        } else if (nodeId.startsWith('agency_')) {
          var agencyId = nodeId.replace('agency_', '');
          if (agencyId !== state.selectedAgency) {
            selectAgency(agencyId);
          }
        }
      }
    });
  }

  function destroyAgencyNetwork() {
    if (state.agencyNetwork) {
      state.agencyNetwork.destroy();
      state.agencyNetwork = null;
    }
    // Remove legend if exists
    var legend = document.querySelector('.network-legend');
    if (legend) legend.remove();
  }

  // ========================================================================
  // LINK CONTACT TO AGENCY
  // ========================================================================

  function showLinkContactModal(agencyId) {
    state.linkContactAgencyId = agencyId;
    var agencyName = state.selectedAgencyData ? state.selectedAgencyData.name : agencyId;
    document.getElementById('linkContactAgencyName').textContent = agencyName;
    document.getElementById('contactSearchInput').value = '';
    document.getElementById('contactSearchResults').innerHTML = '<div class="search-hint">Type to search existing contacts</div>';
    document.getElementById('newContactFirst').value = '';
    document.getElementById('newContactLast').value = '';
    document.getElementById('newContactEmail').value = '';
    document.getElementById('newContactTitle').value = '';
    document.getElementById('linkContactModal').classList.add('active');
    document.getElementById('contactSearchInput').focus();
  }

  var searchDebounceTimer = null;
  function searchContactsForLink(query) {
    clearTimeout(searchDebounceTimer);
    if (!query || query.length < 2) {
      document.getElementById('contactSearchResults').innerHTML = '<div class="search-hint">Type to search existing contacts</div>';
      return;
    }

    document.getElementById('contactSearchResults').innerHTML = '<div class="search-hint">Searching...</div>';

    searchDebounceTimer = setTimeout(function() {
      google.script.run
        .withSuccessHandler(function(contacts) {
          renderContactSearchResults(contacts || []);
        })
        .withFailureHandler(function(error) {
          console.error('Search failed:', error);
          document.getElementById('contactSearchResults').innerHTML = '<div class="search-hint">Search failed</div>';
        })
        .searchContacts(query);
    }, 300);
  }

  function renderContactSearchResults(contacts) {
    var container = document.getElementById('contactSearchResults');

    if (contacts.length === 0) {
      container.innerHTML = '<div class="search-hint">No contacts found. Add a new contact below.</div>';
      return;
    }

    // Deduplicate contacts by email
    var seenEmails = {};
    var uniqueContacts = contacts.filter(function(c) {
      var email = (c.email || '').toLowerCase();
      if (!email || seenEmails[email]) return false;
      seenEmails[email] = true;
      return true;
    });

    var html = '';
    uniqueContacts.slice(0, 10).forEach(function(c) {
      var initials = ((c.first_name || '').charAt(0) + (c.last_name || '').charAt(0)).toUpperCase() || '?';
      var alreadyLinked = c.agency_id === state.linkContactAgencyId;

      html += '<div class="contact-search-item' + (alreadyLinked ? ' selected' : '') + '" onclick="SEP.linkExistingContact(\'' + escapeAttr(c.email) + '\')">';
      html += '<div class="contact-search-avatar">' + initials + '</div>';
      html += '<div class="contact-search-info">';
      html += '<div class="contact-search-name">' + escapeHtml((c.first_name || '') + ' ' + (c.last_name || '')) + '</div>';
      html += '<div class="contact-search-email">' + escapeHtml(c.email || '') + '</div>';
      if (c.agency_name || c.organization) {
        html += '<div class="contact-search-agency">' + escapeHtml(c.agency_name || c.organization || '') + (alreadyLinked ? ' (already linked)' : '') + '</div>';
      }
      html += '</div>';
      if (alreadyLinked) {
        html += '<span class="material-icons" style="color: var(--color-success);">check_circle</span>';
      }
      html += '</div>';
    });

    if (uniqueContacts.length > 10) {
      html += '<div class="search-hint">' + (uniqueContacts.length - 10) + ' more results not shown</div>';
    }

    container.innerHTML = html;
  }

  function linkExistingContact(email) {
    var btn = document.getElementById('addNewContactBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Linking...';

    google.script.run
      .withSuccessHandler(function(result) {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons">person_add</span> Add Contact';

        if (result.success) {
          closeModal('linkContactModal');
          // Refresh the agency view
          selectAgency(state.linkContactAgencyId);
        } else {
          alert('Failed to link contact: ' + (result.error || 'Unknown error'));
        }
      })
      .withFailureHandler(function(error) {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons">person_add</span> Add Contact';
        alert('Failed to link contact: ' + error);
      })
      .updateContactAgency(email, state.linkContactAgencyId);
  }

  function addNewContactToAgency() {
    var firstName = document.getElementById('newContactFirst').value.trim();
    var lastName = document.getElementById('newContactLast').value.trim();
    var email = document.getElementById('newContactEmail').value.trim();
    var title = document.getElementById('newContactTitle').value.trim();

    if (!firstName || !lastName) {
      alert('Please enter first and last name');
      return;
    }
    if (!email || !email.includes('@')) {
      alert('Please enter a valid email address');
      return;
    }

    var btn = document.getElementById('addNewContactBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Adding...';

    google.script.run
      .withSuccessHandler(function(result) {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons">person_add</span> Add Contact';

        if (result.success) {
          closeModal('linkContactModal');
          // Refresh the agency view
          selectAgency(state.linkContactAgencyId);
        } else {
          alert('Failed to add contact: ' + (result.error || 'Unknown error'));
        }
      })
      .withFailureHandler(function(error) {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons">person_add</span> Add Contact';
        alert('Failed to add contact: ' + error);
      })
      .createContactForAgency({
        first_name: firstName,
        last_name: lastName,
        email: email,
        title: title,
        agency_id: state.linkContactAgencyId
      });
  }

  function removeContactFromAgency(contactId, agencyId) {
    if (!confirm('Remove this contact from the agency?\n\nThis will unlink the contact from ' + (state.selectedAgencyData ? state.selectedAgencyData.name : agencyId) + '. The contact will still exist in the system.')) {
      return;
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // Refresh the agency view
          selectAgency(agencyId);
        } else {
          alert('Failed to remove contact: ' + (result.error || 'Unknown error'));
        }
      })
      .withFailureHandler(function(error) {
        alert('Failed to remove contact: ' + error);
      })
      .updateContactAgency(contactId, '');
  }

  function renderRecentEngagements() {
    var container = document.getElementById('recentEngagements');
    if (!state.engagements || state.engagements.length === 0) {
      container.innerHTML = '<div class="empty-state"><p>No recent engagements</p></div>';
      return;
    }

    var iconMap = {
      'Email': 'email',
      'Phone': 'phone',
      'Meeting': 'groups',
      'Webinar': 'videocam',
      'Conference': 'location_city',
      'Site Visit': 'place',
      'Training': 'school'
    };

    var html = '';
    state.engagements.slice(0, 8).forEach(function(e, index) {
      var icon = iconMap[e.activity_type] || 'event';
      html += '<div class="engagement-item" style="cursor: pointer;" onclick="SEP.showEngagementDetail(' + index + ')">';
      html += '<div class="engagement-icon"><span class="material-icons">' + icon + '</span></div>';
      html += '<div class="engagement-info">';
      html += '<div class="engagement-subject">' + escapeHtml(e.subject || 'No subject') + '</div>';
      html += '<div class="engagement-meta">' + formatDate(e.date) + ' - ' + escapeHtml(e.activity_type || 'Unknown') + '</div>';
      html += '</div></div>';
    });

    container.innerHTML = html;
  }

  function showEngagementDetail(index) {
    var e = state.engagements[index];
    if (!e) return;

    var typeIcons = {
      'Email': 'email',
      'Phone': 'phone',
      'Meeting': 'groups',
      'Webinar': 'videocam',
      'Conference': 'location_city',
      'Site Visit': 'place',
      'Training': 'school'
    };
    var icon = typeIcons[e.activity_type] || 'event';

    var html = '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">';
    html += '<div class="engagement-icon" style="width: 48px; height: 48px;"><span class="material-icons" style="font-size: 24px;">' + icon + '</span></div>';
    html += '<div><div style="font-size: 16px; font-weight: 600;">' + escapeHtml(e.subject || 'No subject') + '</div>';
    html += '<div style="color: var(--color-text-secondary); font-size: 13px;">' + escapeHtml(e.activity_type || 'Unknown') + '</div></div>';
    html += '</div>';

    html += '<div class="engagement-detail-grid">';
    html += '<div class="engagement-detail-item"><div class="engagement-detail-label">Date</div><div class="engagement-detail-value">' + escapeHtml(e.date || '--') + '</div></div>';
    html += '<div class="engagement-detail-item"><div class="engagement-detail-label">Direction</div><div class="engagement-detail-value">' + escapeHtml(e.direction || '--') + '</div></div>';
    html += '<div class="engagement-detail-item"><div class="engagement-detail-label">Touchpoint</div><div class="engagement-detail-value">' + escapeHtml(e.touchpoint_reference || '--') + '</div></div>';
    if (e.follow_up_date) {
      html += '<div class="engagement-detail-item"><div class="engagement-detail-label">Follow-up</div><div class="engagement-detail-value">' + escapeHtml(e.follow_up_date) + '</div></div>';
    }
    if (e.solution_ids) {
      html += '<div class="engagement-detail-item engagement-detail-full"><div class="engagement-detail-label">Solutions</div><div class="engagement-detail-value">' + escapeHtml(e.solution_ids) + '</div></div>';
    }
    html += '<div class="engagement-detail-item engagement-detail-full"><div class="engagement-detail-label">Participants</div><div class="engagement-detail-value">' + escapeHtml(e.participants || '--') + '</div></div>';
    html += '</div>';

    if (e.summary) {
      html += '<div class="engagement-detail-label" style="margin-bottom: 4px;">Summary</div>';
      html += '<div class="engagement-summary-box">' + escapeHtml(e.summary) + '</div>';
    }

    document.getElementById('engagementDetailContent').innerHTML = html;
    document.getElementById('engagementDetailModal').classList.add('active');
  }

  function setView(view) {
    state.currentView = view;
    document.querySelectorAll('.view-btn').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.view === view);
    });
    document.getElementById('dashboardView').classList.toggle('active', view === 'dashboard');
    document.getElementById('agenciesView').classList.toggle('active', view === 'agencies');
  }

  function filterAgencies() {
    var query = document.getElementById('agencySearchInput').value.toLowerCase();
    var items = document.querySelectorAll('#agencyTree .agency-item');
    items.forEach(function(item) {
      var name = item.querySelector('.agency-name').textContent.toLowerCase();
      item.style.display = name.indexOf(query) !== -1 ? '' : 'none';
    });
  }

  function showContactDetail(email) {
    // Try to find contact in currentAgencyContacts first, then fall back to contacts
    var contact = null;
    if (state.currentAgencyContacts && state.currentAgencyContacts.length > 0) {
      contact = state.currentAgencyContacts.find(function(c) { return c.email === email; });
    }
    if (!contact && state.contacts && state.contacts.length > 0) {
      contact = state.contacts.find(function(c) { return c.email === email; });
    }
    if (!contact) {
      alert('Contact not found');
      return;
    }

    document.getElementById('modalContactName').textContent =
      (contact.first_name || '') + ' ' + (contact.last_name || '');

    var initials = ((contact.first_name || '')[0] || '') + ((contact.last_name || '')[0] || '');

    var html = '<div class="contact-detail-header">';
    html += '<div class="contact-avatar">' + initials.toUpperCase() + '</div>';
    html += '<div class="contact-detail-info">';
    html += '<div class="contact-detail-name">' + escapeHtml((contact.first_name || '') + ' ' + (contact.last_name || '')) + '</div>';
    html += '<div class="contact-detail-email"><a href="mailto:' + escapeHtml(contact.email) + '">' + escapeHtml(contact.email) + '</a></div>';
    if (contact.department || contact.agency) {
      html += '<div class="contact-detail-org">' + escapeHtml(contact.department || '') + (contact.agency ? ' / ' + escapeHtml(contact.agency) : '') + '</div>';
    }
    if (contact.title) {
      html += '<div class="contact-detail-org">' + escapeHtml(contact.title) + '</div>';
    }
    html += '</div></div>';

    // SEP Status Section with Inline Editing
    html += '<div class="detail-section">';
    html += '<div class="detail-section-title">SEP Status <span class="save-indicator" id="saveIndicator"> Saved</span></div>';
    html += '<div class="detail-grid">';

    // Touchpoint - Inline Editable
    html += '<div class="detail-item"><div class="detail-label">Touchpoint</div><div class="detail-value inline-edit-group">';
    html += '<select class="inline-select" id="editTouchpoint" onchange="SEP.updateContactField(\'' + escapeAttr(contact.email) + '\', \'touchpoint\', this.value)">';
    html += '<option value="">Not assigned</option>';
    ['T4', 'W1', 'W2', 'T5', 'T6', 'T7', 'T8'].forEach(function(tp) {
      var selected = contact.touchpoint_status === tp ? ' selected' : '';
      var labels = { 'T4': 'T4 - Outreach', 'W1': 'W1 - Assessment', 'W2': 'W2 - Deep Dive', 'T5': 'T5 - Transition', 'T6': 'T6 - Training', 'T7': 'T7 - Adoption', 'T8': 'T8 - Impact' };
      html += '<option value="' + tp + '"' + selected + '>' + labels[tp] + '</option>';
    });
    html += '</select></div></div>';

    // Engagement Level - Inline Editable
    html += '<div class="detail-item"><div class="detail-label">Engagement Level</div><div class="detail-value inline-edit-group">';
    html += '<select class="inline-select" id="editEngagementLevel" onchange="SEP.updateContactField(\'' + escapeAttr(contact.email) + '\', \'engagement\', this.value)">';
    html += '<option value="">Not set</option>';
    ['Could benefit', 'Interested', 'Info & Feedback', 'Collaborate', 'CoOwners'].forEach(function(level) {
      var selected = contact.engagement_level === level ? ' selected' : '';
      html += '<option value="' + level + '"' + selected + '>' + level + '</option>';
    });
    html += '</select></div></div>';

    // Last Contact - Display only
    html += '<div class="detail-item"><div class="detail-label">Last Contact</div><div class="detail-value">' + (contact.last_contact_date ? formatDate(contact.last_contact_date) : '--') + '</div></div>';

    // Next Scheduled - Inline Editable
    html += '<div class="detail-item"><div class="detail-label">Next Scheduled</div><div class="detail-value inline-edit-group">';
    html += '<input type="date" class="inline-date" id="editNextContact" value="' + (contact.next_scheduled_contact || '') + '" onchange="SEP.updateContactField(\'' + escapeAttr(contact.email) + '\', \'next_contact\', this.value)">';
    html += '</div></div>';

    html += '</div></div>';

    // Solutions Section
    if (contact.solutions && contact.solutions.length > 0) {
      html += '<div class="detail-section">';
      html += '<div class="detail-section-title">Solutions (' + contact.solutions.length + ')</div>';
      html += '<div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">';
      contact.solutions.forEach(function(sol) {
        html += '<span style="background: var(--color-surface-alt); padding: 4px 8px; border-radius: var(--radius-sm); font-size: var(--font-size-sm);">' + escapeHtml(sol.length > 30 ? sol.substring(0, 30) + '...' : sol) + '</span>';
      });
      html += '</div></div>';
    }

    // Notes Section
    if (contact.relationship_notes) {
      html += '<div class="detail-section">';
      html += '<div class="detail-section-title">Relationship Notes</div>';
      html += '<p style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">' + escapeHtml(contact.relationship_notes) + '</p>';
      html += '</div>';
    }

    // Actions
    html += '<div style="display: flex; gap: var(--space-sm); margin-top: var(--space-lg); flex-wrap: wrap;">';
    if (contact.email) {
      html += '<a href="mailto:' + escapeHtml(contact.email) + '" class="btn btn-primary"><span class="material-icons">email</span> Email</a>';
    }
    html += '<button class="btn btn-secondary" onclick="SEP.logEngagementFor(\'' + escapeAttr(contact.email) + '\')"><span class="material-icons">add</span> Log Engagement</button>';
    html += '<button class="btn btn-secondary" onclick="SEP.showContactHistory(\'' + escapeAttr(contact.email) + '\')"><span class="material-icons">history</span> View History</button>';
    html += '<button class="btn btn-secondary" onclick="SEP.markContacted(\'' + escapeAttr(contact.email) + '\')"><span class="material-icons">check_circle</span> Mark Contacted</button>';
    html += '</div>';

    document.getElementById('contactModalBody').innerHTML = html;
    document.getElementById('contactModal').classList.add('active');
}

  function showLogEngagementModal() {
    state.editingEngagementId = null;
    document.getElementById('engagementForm').reset();
    setDefaultDate();
    document.getElementById('engSubmitBtn').textContent = 'Log Engagement';
    document.getElementById('engagementModal').classList.add('active');
  }

  function logEngagementFor(email) {
    closeModal('contactModal');
    showLogEngagementModal();
    document.getElementById('engParticipants').value = email;
  }

  function submitEngagement(event) {
    event.preventDefault();

    var submitBtn = document.getElementById('engSubmitBtn');
    var originalText = submitBtn.textContent;
    var isEditing = !!state.editingEngagementId;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="material-icons" style="font-size: 16px; animation: spin 1s linear infinite;">refresh</span> Saving...';

    var engagement = {
      date: document.getElementById('engDate').value,
      activity_type: document.getElementById('engActivityType').value,
      direction: document.getElementById('engDirection').value,
      subject: document.getElementById('engSubject').value,
      participants: document.getElementById('engParticipants').value,
      solution_id: document.getElementById('engSolution').value,
      summary: document.getElementById('engSummary').value,
      follow_up_date: document.getElementById('engFollowUp').value
    };

    var successHandler = function(result) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Log Engagement';
      state.editingEngagementId = null;
      closeModal('engagementModal');
      loadRecentEngagements();
      if (state.selectedAgency) {
        selectAgency(state.selectedAgency);
      }
      alert(isEditing ? 'Engagement updated!' : 'Engagement logged successfully!');
    };

    var failureHandler = function(error) {
      submitBtn.disabled = false;
      submitBtn.textContent = isEditing ? 'Update Engagement' : 'Log Engagement';
      alert('Failed to ' + (isEditing ? 'update' : 'log') + ' engagement: ' + error);
    };

    if (isEditing) {
      google.script.run
        .withSuccessHandler(successHandler)
        .withFailureHandler(failureHandler)
        .updateEngagement(state.editingEngagementId, engagement);
    } else {
      google.script.run
        .withSuccessHandler(successHandler)
        .withFailureHandler(failureHandler)
        .createEngagement(engagement);
    }
  }

  function closeModal(modalId, event) {
    var modal = document.getElementById(modalId);
    if (!modal) return; // Modal doesn't exist, nothing to close
    if (!event || event.target === modal) {
      modal.classList.remove('active');
    }
  }

  function formatDate(dateStr) {
    if (!dateStr) return '--';
    var date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function escapeAttr(text) {
    if (!text) return '';
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function showPipelineError(message) {
    var touchpoints = ['T4', 'W1', 'W2', 'T5', 'T6', 'T7', 'T8'];
    touchpoints.forEach(function(tp) {
      document.getElementById('cards' + tp).innerHTML =
        '<div class="empty-state"><p style="font-size: var(--font-size-xs);">Error</p></div>';
    });
  }

  // ========================================================================
  // NEEDS ATTENTION (Follow-up Dashboard)
  // ========================================================================

  function loadNeedsAttention() {
    // Load overdue contacts
    google.script.run
      .withSuccessHandler(function(overdue) {
        google.script.run
          .withSuccessHandler(function(dueSoon) {
            renderNeedsAttention(overdue || [], dueSoon || []);
          })
          .withFailureHandler(function(err) {
            console.error('Failed to load due-soon contacts:', err);
            renderNeedsAttention(overdue || [], []);
          })
          .getContactsNeedingFollowUp(7);
      })
      .withFailureHandler(function(err) {
        console.error('Failed to load overdue contacts:', err);
        document.getElementById('needsAttentionList').innerHTML =
          '<div class="empty-state"><p>Failed to load</p></div>';
      })
      .getContactsOverdueFollowUp();
  }

  function renderNeedsAttention(overdue, dueSoon) {
    var container = document.getElementById('needsAttentionList');
    var countEl = document.getElementById('attentionCount');

    // Filter out duplicates (contacts in both lists)
    var overdueEmails = overdue.map(function(c) { return c.email; });
    var uniqueDueSoon = dueSoon.filter(function(c) {
      return overdueEmails.indexOf(c.email) === -1;
    });

    var totalCount = overdue.length + uniqueDueSoon.length;
    countEl.textContent = totalCount;

    if (totalCount === 0) {
      container.innerHTML = '<div class="empty-state" style="padding: var(--space-lg);"><span class="material-icons" style="font-size: 32px; color: var(--color-success);">check_circle</span><p>All caught up!</p></div>';
      return;
    }

    var html = '';

    // Overdue contacts first
    overdue.slice(0, 5).forEach(function(c) {
      var name = (c.first_name || '') + ' ' + (c.last_name || '');
      var org = c.agency || c.department || '';
      var daysOverdue = c.next_scheduled_contact ? Math.abs(Math.ceil((new Date(c.next_scheduled_contact) - new Date()) / (1000 * 60 * 60 * 24))) : 0;

      html += '<div class="attention-item overdue" onclick="SEP.showContactDetail(\'' + escapeAttr(c.email) + '\')">';
      html += '<div class="attention-info">';
      html += '<div class="attention-name">' + escapeHtml(name) + '</div>';
      html += '<div class="attention-org">' + escapeHtml(org) + '</div>';
      html += '</div>';
      html += '<span class="attention-status overdue">' + daysOverdue + 'd overdue</span>';
      html += '<button class="attention-action" onclick="event.stopPropagation(); SEP.markContacted(\'' + escapeAttr(c.email) + '\')"></button>';
      html += '</div>';
    });

    // Due soon contacts
    uniqueDueSoon.slice(0, 5).forEach(function(c) {
      var name = (c.first_name || '') + ' ' + (c.last_name || '');
      var org = c.agency || c.department || '';
      var daysUntil = c.next_scheduled_contact ? Math.ceil((new Date(c.next_scheduled_contact) - new Date()) / (1000 * 60 * 60 * 24)) : 0;

      html += '<div class="attention-item due-soon" onclick="SEP.showContactDetail(\'' + escapeAttr(c.email) + '\')">';
      html += '<div class="attention-info">';
      html += '<div class="attention-name">' + escapeHtml(name) + '</div>';
      html += '<div class="attention-org">' + escapeHtml(org) + '</div>';
      html += '</div>';
      html += '<span class="attention-status due-soon">' + (daysUntil === 0 ? 'Today' : daysUntil + 'd') + '</span>';
      html += '<button class="attention-action" onclick="event.stopPropagation(); SEP.markContacted(\'' + escapeAttr(c.email) + '\')"></button>';
      html += '</div>';
    });

    if (totalCount > 10) {
      html += '<div style="text-align: center; padding: var(--space-sm); font-size: var(--font-size-xs); color: var(--color-text-muted);">+' + (totalCount - 10) + ' more</div>';
    }

    container.innerHTML = html;
  }

  // ========================================================================
  // INLINE EDITING
  // ========================================================================

  function updateContactField(email, fieldType, value) {
    var indicator = document.getElementById('saveIndicator');
    if (indicator) {
      indicator.textContent = 'Saving...';
      indicator.classList.add('visible');
    }

    var runner = google.script.run
      .withSuccessHandler(function() {
        if (indicator) {
          indicator.textContent = ' Saved';
          setTimeout(function() { indicator.classList.remove('visible'); }, 2000);
        }
        // Update local state
        var contact = state.contacts.find(function(c) { return c.email === email; });
        if (contact) {
          if (fieldType === 'touchpoint') contact.touchpoint_status = value;
          else if (fieldType === 'engagement') contact.engagement_level = value;
          else if (fieldType === 'next_contact') contact.next_scheduled_contact = value;
        }
        // Refresh pipeline view
        renderPipeline();
        loadNeedsAttention();
      })
      .withFailureHandler(function(err) {
        if (indicator) {
          indicator.textContent = ' Failed';
          indicator.style.color = 'var(--color-error)';
          setTimeout(function() {
            indicator.classList.remove('visible');
            indicator.style.color = '';
          }, 3000);
        }
        console.error('Failed to update contact:', err);
      });

    // Call the appropriate API function
    if (fieldType === 'touchpoint') {
      runner.updateContactTouchpoint(email, value);
    } else if (fieldType === 'engagement') {
      runner.updateContactEngagement(email, value);
    } else if (fieldType === 'next_contact') {
      runner.updateContactNextScheduledContact(email, value);
    }
  }

  function markContacted(email) {
    var today = new Date().toISOString().split('T')[0];

    google.script.run
      .withSuccessHandler(function() {
        // Update local state
        var contact = state.contacts.find(function(c) { return c.email === email; });
        if (contact) {
          contact.last_contact_date = today;
        }
        // Refresh views
        renderPipeline();
        loadNeedsAttention();
        // Close contact modal if open
        closeModal('contactModal');
        // Show confirmation
        showToast('Contact marked as contacted today');
      })
      .withFailureHandler(function(err) {
        alert('Failed to update: ' + err);
      })
      .updateContactLastContactDate(email, today);
  }

  function showToast(message) {
    var toast = document.createElement('div');
    toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--color-text); color: white; padding: 12px 24px; border-radius: var(--radius-md); font-size: var(--font-size-sm); z-index: 9999; animation: fadeIn 0.3s;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(function() {
      toast.style.animation = 'fadeOut 0.3s';
      setTimeout(function() { toast.remove(); }, 300);
    }, 2000);
  }

  // ========================================================================
  // CONTACT ENGAGEMENT HISTORY
  // ========================================================================

  function showContactHistory(email) {
    // Try to find contact in currentAgencyContacts first, then fall back to contacts
    var contact = null;
    if (state.currentAgencyContacts && state.currentAgencyContacts.length > 0) {
      contact = state.currentAgencyContacts.find(function(c) { return c.email === email; });
    }
    if (!contact && state.contacts && state.contacts.length > 0) {
      contact = state.contacts.find(function(c) { return c.email === email; });
    }
    var name = contact ? ((contact.first_name || '') + ' ' + (contact.last_name || '')) : email;

    document.getElementById('contactHistoryTitle').textContent = 'Engagement History - ' + name;
    document.getElementById('contactHistoryContent').innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><p>Loading history...</p></div>';
    document.getElementById('contactHistoryModal').classList.add('active');

    google.script.run
      .withSuccessHandler(function(engagements) {
        renderContactHistory(engagements || [], email);
      })
      .withFailureHandler(function(err) {
        document.getElementById('contactHistoryContent').innerHTML =
          '<div class="empty-state"><p>Failed to load history</p></div>';
      })
      .getEngagementsByContact(email);
  }

  function renderContactHistory(engagements, email) {
    var container = document.getElementById('contactHistoryContent');

    if (engagements.length === 0) {
      container.innerHTML = '<div class="empty-state" style="padding: var(--space-lg);"><span class="material-icons" style="font-size: 48px; opacity: 0.5;">history</span><p>No engagement history found</p><button class="btn btn-primary" onclick="SEP.closeModal(\'contactHistoryModal\'); SEP.logEngagementFor(\'' + escapeAttr(email) + '\');"><span class="material-icons">add</span> Log First Engagement</button></div>';
      return;
    }

    // Sort by date descending
    engagements.sort(function(a, b) {
      return new Date(b.date || 0) - new Date(a.date || 0);
    });

    var html = '<div class="engagement-count-badge">' + engagements.length + ' engagement' + (engagements.length === 1 ? '' : 's') + '</div>';
    html += '<div class="history-timeline">';

    engagements.forEach(function(e) {
      var iconMap = { 'Email': 'email', 'Phone': 'phone', 'Meeting': 'groups', 'Webinar': 'videocam', 'Conference': 'location_city', 'Site Visit': 'place', 'Training': 'school' };
      var icon = iconMap[e.activity_type] || 'event';

      html += '<div class="history-item">';
      html += '<div class="history-date">' + escapeHtml(e.date || 'Unknown date') + '</div>';
      html += '<div class="history-content">';
      html += '<div class="history-subject"><span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">' + icon + '</span>' + escapeHtml(e.subject || 'No subject') + '</div>';
      html += '<div class="history-meta">' + escapeHtml(e.activity_type || '') + '  ' + escapeHtml(e.direction || '') + (e.touchpoint_reference ? '  ' + escapeHtml(e.touchpoint_reference) : '') + '</div>';
      if (e.summary) {
        html += '<div class="history-summary">' + escapeHtml(e.summary.length > 200 ? e.summary.substring(0, 200) + '...' : e.summary) + '</div>';
      }
      html += '</div></div>';
    });

    html += '</div>';
    container.innerHTML = html;
  }

  // ========================================================================
  // ALL ENGAGEMENTS VIEW
  // ========================================================================

  function showAllEngagements() {
    document.getElementById('allEngagementsModal').classList.add('active');
    document.getElementById('allEngagementsList').innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><p>Loading engagements...</p></div>';

    // Reset filters
    document.getElementById('filterActivityType').value = '';
    document.getElementById('filterDateRange').value = '30';
    document.getElementById('filterEngagementSearch').value = '';

    loadAllEngagements();
  }

  function loadAllEngagements() {
    var dateRange = document.getElementById('filterDateRange').value;
    var days = dateRange === 'all' ? 9999 : parseInt(dateRange);

    google.script.run
      .withSuccessHandler(function(engagements) {
        allEngagementsCache = engagements || [];
        filterAllEngagements();
      })
      .withFailureHandler(function(err) {
        document.getElementById('allEngagementsList').innerHTML =
          '<div class="empty-state"><p>Failed to load engagements</p></div>';
      })
      .getRecentEngagements(days, 500);
  }

  function filterAllEngagements() {
    var activityType = document.getElementById('filterActivityType').value;
    var searchQuery = document.getElementById('filterEngagementSearch').value.toLowerCase();
    var dateRange = document.getElementById('filterDateRange').value;

    var filtered = allEngagementsCache.filter(function(e) {
      // Activity type filter
      if (activityType && e.activity_type !== activityType) return false;

      // Search filter
      if (searchQuery) {
        var searchable = ((e.subject || '') + ' ' + (e.summary || '')).toLowerCase();
        if (searchable.indexOf(searchQuery) === -1) return false;
      }

      // Date range filter
      if (dateRange !== 'all') {
        var days = parseInt(dateRange);
        var cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        if (new Date(e.date) < cutoff) return false;
      }

      return true;
    });

    renderAllEngagements(filtered);
  }

  function renderAllEngagements(engagements) {
    var container = document.getElementById('allEngagementsList');

    if (engagements.length === 0) {
      container.innerHTML = '<div class="empty-state" style="padding: var(--space-lg);"><span class="material-icons" style="font-size: 48px; opacity: 0.5;">inbox</span><p>No engagements match your filters</p></div>';
      return;
    }

    var iconMap = { 'Email': 'email', 'Phone': 'phone', 'Meeting': 'groups', 'Webinar': 'videocam', 'Conference': 'location_city', 'Site Visit': 'place', 'Training': 'school' };

    var html = '<div class="engagement-count-badge">' + engagements.length + ' engagement' + (engagements.length === 1 ? '' : 's') + '</div>';

    engagements.forEach(function(e, index) {
      var icon = iconMap[e.activity_type] || 'event';

      html += '<div class="engagement-row" onclick="SEP.showEngagementDetailFromAll(' + index + ')">';
      html += '<div class="engagement-row-icon"><span class="material-icons">' + icon + '</span></div>';
      html += '<div class="engagement-row-info">';
      html += '<div class="engagement-row-subject">' + escapeHtml(e.subject || 'No subject') + '</div>';
      html += '<div class="engagement-row-meta">' + escapeHtml(e.activity_type || '') + '  ' + escapeHtml(e.direction || '') + (e.participants ? '  ' + escapeHtml(e.participants.split(',').length + ' participant' + (e.participants.split(',').length > 1 ? 's' : '')) : '') + '</div>';
      html += '</div>';
      html += '<div class="engagement-row-date">' + escapeHtml(e.date || '--') + '</div>';
      html += '</div>';
    });

    container.innerHTML = html;
  }

  function showEngagementDetailFromAll(index) {
    var filtered = filterEngagementsForDisplay();
    var e = filtered[index];
    if (!e) return;

    // Reuse the existing engagement detail rendering
    showEngagementDetailData(e);
  }

  function filterEngagementsForDisplay() {
    var activityType = document.getElementById('filterActivityType').value;
    var searchQuery = document.getElementById('filterEngagementSearch').value.toLowerCase();
    var dateRange = document.getElementById('filterDateRange').value;

    return allEngagementsCache.filter(function(e) {
      if (activityType && e.activity_type !== activityType) return false;
      if (searchQuery) {
        var searchable = ((e.subject || '') + ' ' + (e.summary || '')).toLowerCase();
        if (searchable.indexOf(searchQuery) === -1) return false;
      }
      if (dateRange !== 'all') {
        var days = parseInt(dateRange);
        var cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        if (new Date(e.date) < cutoff) return false;
      }
      return true;
    });
  }

  function showEngagementDetailData(e) {
    // Store for edit/delete
    state.currentEngagementDetail = e;

    var typeIcons = { 'Email': 'email', 'Phone': 'phone', 'Meeting': 'groups', 'Webinar': 'videocam', 'Conference': 'location_city', 'Site Visit': 'place', 'Training': 'school' };
    var icon = typeIcons[e.activity_type] || 'event';

    var html = '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">';
    html += '<div class="engagement-icon" style="width: 48px; height: 48px;"><span class="material-icons" style="font-size: 24px;">' + icon + '</span></div>';
    html += '<div style="flex: 1;"><div style="font-size: 16px; font-weight: 600;">' + escapeHtml(e.subject || 'No subject') + '</div>';
    html += '<div style="color: var(--color-text-secondary); font-size: 13px;">' + escapeHtml(e.activity_type || 'Unknown') + '</div></div>';
    html += '<div class="engagement-detail-actions">';
    html += '<button class="btn btn-sm btn-secondary" onclick="SEP.editEngagement()" title="Edit"><span class="material-icons">edit</span></button>';
    html += '<button class="btn btn-sm btn-danger" onclick="SEP.deleteEngagement()" title="Delete"><span class="material-icons">delete</span></button>';
    html += '</div>';
    html += '</div>';

    html += '<div class="engagement-detail-grid">';
    html += '<div class="engagement-detail-item"><div class="engagement-detail-label">Date</div><div class="engagement-detail-value">' + escapeHtml(e.date || '--') + '</div></div>';
    html += '<div class="engagement-detail-item"><div class="engagement-detail-label">Direction</div><div class="engagement-detail-value">' + escapeHtml(e.direction || '--') + '</div></div>';
    html += '<div class="engagement-detail-item"><div class="engagement-detail-label">Touchpoint</div><div class="engagement-detail-value">' + escapeHtml(e.touchpoint_reference || '--') + '</div></div>';
    if (e.follow_up_date) {
      html += '<div class="engagement-detail-item"><div class="engagement-detail-label">Follow-up</div><div class="engagement-detail-value">' + escapeHtml(e.follow_up_date) + '</div></div>';
    }
    if (e.solution_ids) {
      html += '<div class="engagement-detail-item engagement-detail-full"><div class="engagement-detail-label">Solutions</div><div class="engagement-detail-value">' + escapeHtml(e.solution_ids) + '</div></div>';
    }
    html += '<div class="engagement-detail-item engagement-detail-full"><div class="engagement-detail-label">Participants</div><div class="engagement-detail-value">' + escapeHtml(e.participants || '--') + '</div></div>';
    html += '</div>';

    if (e.summary) {
      html += '<div class="engagement-detail-label" style="margin-bottom: 4px;">Summary</div>';
      html += '<div class="engagement-summary-box">' + escapeHtml(e.summary) + '</div>';
    }

    document.getElementById('engagementDetailContent').innerHTML = html;
    document.getElementById('engagementDetailModal').classList.add('active');
  }

  function editEngagement() {
    var e = state.currentEngagementDetail;
    if (!e) return;

    closeModal('engagementDetailModal');
    showLogEngagementModal();

    // Populate form with existing values
    document.getElementById('engDate').value = e.date || '';
    document.getElementById('engActivityType').value = e.activity_type || '';
    document.getElementById('engDirection').value = e.direction || '';
    document.getElementById('engSubject').value = e.subject || '';
    document.getElementById('engParticipants').value = e.participants || '';
    document.getElementById('engSolution').value = e.solution_id || '';
    document.getElementById('engSummary').value = e.summary || '';
    document.getElementById('engFollowUp').value = e.follow_up_date || '';

    // Store the engagement ID for update
    state.editingEngagementId = e.engagement_id;

    // Change submit button text
    var submitBtn = document.getElementById('engSubmitBtn');
    submitBtn.textContent = 'Update Engagement';
  }

  function deleteEngagement() {
    var e = state.currentEngagementDetail;
    if (!e || !e.engagement_id) {
      alert('Cannot delete: Engagement ID not found');
      return;
    }

    if (!confirm('Delete this engagement?\n\n"' + (e.subject || 'No subject') + '"\n\nThis action cannot be undone.')) {
      return;
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          closeModal('engagementDetailModal');
          // Refresh engagements
          loadRecentEngagements();
          if (state.selectedAgency) {
            selectAgency(state.selectedAgency);
          }
        } else {
          alert('Failed to delete: ' + (result.error || 'Unknown error'));
        }
      })
      .withFailureHandler(function(error) {
        alert('Failed to delete: ' + error);
      })
      .deleteEngagement(e.engagement_id);
  }

  function showAgencyEngagementDetail(index) {
    if (!state.currentAgencyTimeline || index >= state.currentAgencyTimeline.length) {
      return;
    }
    var e = state.currentAgencyTimeline[index];
    showEngagementDetailData(e);
  }

  return {
    init: init,
    setView: setView,
    filterAgencies: filterAgencies,
    toggleAgencyChildren: toggleAgencyChildren,
    selectAgency: selectAgency,
    showLogEngagementModal: showLogEngagementModal,
    submitEngagement: submitEngagement,
    showEngagementDetail: showEngagementDetail,
    editEngagement: editEngagement,
    deleteEngagement: deleteEngagement,
    closeModal: closeModal,
    // Solution-based SEP functions
    showSolutionDetail: showSolutionDetail,
    updateMilestoneDate: updateMilestoneDate,
    logEngagementForSolution: logEngagementForSolution,
    showSolutionEngagements: showSolutionEngagements,
    // Filter functions
    applyFilters: applyFilters,
    setMilestoneFilter: setMilestoneFilter,
    // Contact/Agency functions
    showContactDetail: showContactDetail,
    updateContactField: updateContactField,
    logEngagementFor: logEngagementFor,
    showLinkContactModal: showLinkContactModal,
    searchContactsForLink: searchContactsForLink,
    linkExistingContact: linkExistingContact,
    addNewContactToAgency: addNewContactToAgency,
    markContacted: markContacted,
    showContactHistory: showContactHistory,
    // Agency detail tabs and actions
    switchAgencyTab: switchAgencyTab,
    showLogEngagementModalForAgency: showLogEngagementModalForAgency,
    saveAgencyNotes: saveAgencyNotes,
    cancelAgencyNotes: cancelAgencyNotes,
    removeContactFromAgency: removeContactFromAgency,
    showAgencyEngagementDetail: showAgencyEngagementDetail,
    // Engagement list functions
    showAllEngagements: showAllEngagements,
    filterAllEngagements: filterAllEngagements,
    showEngagementDetailFromAll: showEngagementDetailFromAll,
    // Drag and drop
    handleDragStart: handleDragStart,
    handleDragEnd: handleDragEnd,
    handleDragOver: handleDragOver,
    handleDragLeave: handleDragLeave,
    handleDrop: handleDrop,
    setMilestoneDate: setMilestoneDate,
    closeDropDialog: closeDropDialog
  };
})();

// Initialize
if (typeof google !== 'undefined' && google.script) {
  SEP.init();
} else {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() { SEP.init(); }, 500);
  });
}
</script>
