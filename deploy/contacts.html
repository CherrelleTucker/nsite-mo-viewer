<!-- Contacts Viewer -->
<!-- Stakeholder directory for NSITE MO -->

<div class="contacts-viewer">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title">
      <h1>Contacts Directory</h1>
    </div>
    <div class="page-actions">
      <button class="btn btn-secondary" onclick="Contacts.exportList()">
        <span class="material-icons">download</span>
        Download Contact List
      </button>
      <button class="btn btn-primary" onclick="Contacts.showAddModal()">
        <span class="material-icons">person_add</span>
        Add Contact
      </button>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">group</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statTotalContacts">--</span>
        <span class="stat-label">Total Contacts</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">work</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statDepartments">--</span>
        <span class="stat-label">Departments</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">folder</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statSolutions">--</span>
        <span class="stat-label">Solutions</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">star</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statTopEngaged">--</span>
        <span class="stat-label">Multi-Solution</span>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="search-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input type="text" id="searchInput" class="search-input"
             placeholder="Search by name, email, or organization..."
             oninput="Contacts.debounceSearch()">
    </div>
    <div class="filter-row">
      <div class="filter-group">
        <label>Department:</label>
        <select id="filterDepartment" class="filter-select" onchange="Contacts.applyFilters()">
          <option value="">All Departments</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Solution:</label>
        <select id="filterSolution" class="filter-select" onchange="Contacts.applyFilters()">
          <option value="">All Solutions</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Role:</label>
        <select id="filterRole" class="filter-select" onchange="Contacts.applyFilters()">
          <option value="">All Roles</option>
          <option value="Primary SME">Primary SME</option>
          <option value="Secondary SME">Secondary SME</option>
          <option value="Survey Submitter">Survey Submitter</option>
          <option value="Stakeholder">Stakeholder</option>
          <option value="Additional SME">Additional SME</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Year:</label>
        <select id="filterYear" class="filter-select" onchange="Contacts.applyFilters()">
          <option value="">All Years</option>
          <option value="2024">2024</option>
          <option value="2022">2022</option>
          <option value="2020">2020</option>
          <option value="2018">2018</option>
          <option value="2016">2016</option>
        </select>
      </div>
      <div class="filter-group">
        <label>SNWG Champion:</label>
        <select id="filterChampion" class="filter-select" onchange="Contacts.applyFilters()">
          <option value="">All Contacts</option>
          <option value="any">Any Champion</option>
          <option value="Active">Active</option>
          <option value="Prospective">Prospective</option>
          <option value="Alumni">Alumni</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>
      <div class="filter-group">
        <label>MO Connection:</label>
        <select id="filterOwner" class="filter-select" onchange="Contacts.applyFilters()">
          <option value="">All</option>
        </select>
      </div>
      <button class="btn btn-sm btn-secondary" onclick="Contacts.clearFilters()">Clear</button>
    </div>
  </div>

  <!-- Results Info -->
  <div class="results-info">
    <span id="resultsCount">Loading...</span>
    <div class="view-toggle">
      <button class="view-btn active" data-view="cards" onclick="Contacts.setView('cards')">
        <span class="material-icons">grid_view</span>
      </button>
      <button class="view-btn" data-view="table" onclick="Contacts.setView('table')">
        <span class="material-icons">list</span>
      </button>
    </div>
  </div>

  <!-- Contacts Container -->
  <div class="contacts-container" id="contactsContainer">
    <div class="loading-state">
      <span class="loading-spinner"></span>
      <p>Loading contacts...</p>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination" id="pagination"></div>
</div>

<!-- Contact Detail Modal -->
<div class="modal-overlay" id="contactModal" role="dialog" aria-modal="true" aria-labelledby="contactModalTitle" onclick="Contacts.closeModal(event)">
  <div class="modal-content modal-lg" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="contactModalTitle">Contact Details</h2>
      <button class="modal-close" onclick="Contacts.closeModal()" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Dynamic content -->
    </div>
  </div>
</div>

<!-- Add Contact Modal -->
<div class="modal-overlay" id="addContactModal" role="dialog" aria-modal="true" aria-labelledby="addContactModalTitle" onclick="Contacts.closeAddModal(event)">
  <div class="modal-content modal-lg" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="addContactModalTitle">Add New Contact</h2>
      <button class="modal-close" onclick="Contacts.closeAddModal()" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addContactForm" onsubmit="return Contacts.submitNewContact(event)">
        <!-- Essential Information -->
        <div class="form-section">
          <h3 class="form-section-title">Contact Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="newFirstName">First Name <span class="required">*</span></label>
              <input type="text" id="newFirstName" name="first_name" required>
            </div>
            <div class="form-group">
              <label for="newLastName">Last Name <span class="required">*</span></label>
              <input type="text" id="newLastName" name="last_name" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newEmail">Email <span class="required">*</span></label>
              <input type="email" id="newEmail" name="email" required placeholder="name@agency.gov">
            </div>
          </div>
        </div>

        <!-- Organization Information -->
        <div class="form-section">
          <h3 class="form-section-title">Organization</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="newTitle">Title / Position</label>
              <input type="text" id="newTitle" name="title" placeholder="Program Manager">
            </div>
            <div class="form-group">
              <label for="newDepartment">Department</label>
              <input type="text" id="newDepartment" name="department" placeholder="Earth Science Division">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newAgency">Agency</label>
              <input type="text" id="newAgency" name="agency" placeholder="NASA" list="agencyList">
              <datalist id="agencyList"></datalist>
            </div>
            <div class="form-group">
              <label for="newOrganization">Organization</label>
              <input type="text" id="newOrganization" name="organization" placeholder="Goddard Space Flight Center">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="newRegion">Region</label>
              <select id="newRegion" name="region">
                <option value="">-- Select Region --</option>
                <option value="National">National</option>
                <option value="Northeast">Northeast</option>
                <option value="Southeast">Southeast</option>
                <option value="Midwest">Midwest</option>
                <option value="Southwest">Southwest</option>
                <option value="West">West</option>
                <option value="Pacific">Pacific</option>
                <option value="International">International</option>
              </select>
            </div>
            <div class="form-group"></div>
          </div>
        </div>

        <!-- Solution & Role (Collapsible) -->
        <div class="form-section collapsible">
          <h3 class="form-section-title" onclick="Contacts.toggleFormSection(this)">
            <span class="material-icons section-toggle">expand_more</span>
            Solution & Engagement
            <span class="optional-label">(Optional)</span>
          </h3>
          <div class="form-section-content">
            <div class="form-row">
              <div class="form-group">
                <label for="newSolution">Solution</label>
                <select id="newSolution" name="solution_id">
                  <option value="">-- Select Solution --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="newRole">Role</label>
                <select id="newRole" name="role">
                  <option value="">-- Select Role --</option>
                  <option value="Primary SME">Primary SME</option>
                  <option value="Secondary SME">Secondary SME</option>
                  <option value="Additional SME">Additional SME</option>
                  <option value="Survey Submitter">Survey Submitter</option>
                  <option value="Stakeholder">Stakeholder</option>
                  <option value="Decision Maker">Decision Maker</option>
                  <option value="Technical Contact">Technical Contact</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="newTouchpoint">SEP Touchpoint</label>
                <select id="newTouchpoint" name="touchpoint_status">
                  <option value="">-- Select Touchpoint --</option>
                  <option value="T4">T4 - Outreach</option>
                  <option value="W1">W1 - Assessment</option>
                  <option value="W2">W2 - Deep Dive</option>
                  <option value="T5">T5 - Transition</option>
                  <option value="T6">T6 - Training</option>
                  <option value="T7">T7 - Adoption</option>
                  <option value="T8">T8 - Impact</option>
                </select>
              </div>
              <div class="form-group">
                <label for="newEngagement">Engagement Level</label>
                <select id="newEngagement" name="engagement_level">
                  <option value="">-- Select Level --</option>
                  <option value="Could benefit">Could benefit</option>
                  <option value="Interested">Interested</option>
                  <option value="Info & Feedback">Info & Feedback</option>
                  <option value="Collaborate">Collaborate</option>
                  <option value="CoOwners">Co-Owners</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- SNWG Champion Tracking (Collapsible) -->
        <div class="form-section collapsible">
          <h3 class="form-section-title" onclick="Contacts.toggleFormSection(this)">
            <span class="material-icons section-toggle">expand_more</span>
            SNWG Champion
            <span class="optional-label">(Optional)</span>
          </h3>
          <div class="form-section-content">
            <div class="form-row">
              <div class="form-group">
                <label for="newChampionStatus">Champion Status</label>
                <select id="newChampionStatus" name="champion_status">
                  <option value="">-- Not a Champion --</option>
                  <option value="Active">Active - Currently engaged champion</option>
                  <option value="Prospective">Prospective - Being cultivated</option>
                  <option value="Alumni">Alumni - Former champion, still friendly</option>
                  <option value="Inactive">Inactive - Relationship dormant</option>
                </select>
              </div>
              <div class="form-group">
                <label for="newRelationshipOwner">NSITE MO Connection</label>
                <select id="newRelationshipOwner" name="relationship_owner">
                  <option value="">-- Select Team Member --</option>
                </select>
              </div>
            </div>
            <div class="form-group full-width">
              <label for="newChampionNotes">Champion Notes</label>
              <div id="newChampionNotes" class="rich-text-field" contenteditable="true" data-placeholder="Why is this person a champion? Value they bring? Relationship context?"></div>
            </div>
          </div>
        </div>

        <!-- Notes (Collapsible) -->
        <div class="form-section collapsible">
          <h3 class="form-section-title" onclick="Contacts.toggleFormSection(this)">
            <span class="material-icons section-toggle">expand_more</span>
            Notes
            <span class="optional-label">(Optional)</span>
          </h3>
          <div class="form-section-content">
            <div class="form-group full-width">
              <label for="newNotes">Relationship Notes</label>
              <div id="newRelationshipNotes" class="rich-text-field" contenteditable="true" data-placeholder="How did you meet? Key interests? Follow-up context?"></div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="Contacts.closeAddModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitContactBtn">
            <span class="material-icons">person_add</span>
            Add Contact
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Contacts Styles -->
<style>
  .contacts-viewer {
    --page-accent: var(--color-primary);
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(59, 130, 246, 0.1);
    border-radius: var(--radius-md);
    color: var(--color-primary);
  }

  .stat-icon svg { width: 24px; height: 24px; }
  .stat-info { display: flex; flex-direction: column; }
  .stat-value { font-size: var(--font-size-xl); font-weight: 700; color: var(--color-text); }
  .stat-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); }

  /* Search Section */
  .search-section {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    padding: var(--space-md);
    margin-bottom: var(--space-md);
  }

  .search-box {
    position: relative;
    margin-bottom: var(--space-md);
  }

  .search-icon {
    position: absolute;
    left: var(--space-md);
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    color: var(--color-text-muted);
  }

  .search-input {
    width: 100%;
    padding: var(--space-md) var(--space-md) var(--space-md) 48px;
    font-size: var(--font-size-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    transition: border-color var(--transition-fast);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .filter-row {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .filter-group label {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
    white-space: nowrap;
  }

  .filter-select {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    min-width: 150px;
  }

  /* Results Info */
  .results-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding: 0 var(--space-xs);
  }

  #resultsCount {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .view-toggle {
    display: flex;
    gap: 2px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    padding: 2px;
  }

  .view-btn {
    padding: var(--space-xs) var(--space-sm);
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    transition: all var(--transition-fast);
  }

  .view-btn:hover { color: var(--color-text); }
  .view-btn.active { background: var(--color-surface); color: var(--color-primary); box-shadow: var(--shadow-sm); }
  .view-btn svg { width: 16px; height: 16px; }

  /* Contacts Container - Cards View */
  .contacts-container.view-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-md);
  }

  .contact-card {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    padding: var(--space-md);
    transition: all var(--transition-fast);
    cursor: pointer;
    border-left: 4px solid var(--color-primary);
  }

  .contact-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .contact-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-sm);
  }

  .contact-name {
    font-weight: 600;
    font-size: var(--font-size-md);
    color: var(--color-text);
  }

  .contact-badges {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .contact-solutions-count {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    background: rgba(59, 130, 246, 0.1);
    color: var(--color-primary);
    border-radius: 12px;
    font-weight: 600;
  }

  /* Champion badges */
  .champion-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .champion-badge .material-icons {
    font-size: 14px;
  }

  .champion-badge.champion-active {
    background: rgba(46, 125, 50, 0.15);
    color: var(--color-success);
  }

  .champion-badge.champion-prospective {
    background: rgba(21, 101, 192, 0.15);
    color: var(--color-primary);
  }

  .champion-badge.champion-alumni {
    background: rgba(123, 31, 162, 0.15);
    color: var(--color-comms);
  }

  .champion-badge.champion-inactive {
    background: rgba(117, 117, 117, 0.15);
    color: var(--color-text-muted);
  }

  /* Champion detail section in modal */
  .champion-detail {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    flex-wrap: wrap;
    margin-bottom: var(--space-sm);
  }

  .champion-status-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: 4px 12px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 600;
  }

  .champion-status-badge.champion-active {
    background: rgba(46, 125, 50, 0.15);
    color: var(--color-success);
  }

  .champion-status-badge.champion-prospective {
    background: rgba(21, 101, 192, 0.15);
    color: var(--color-primary);
  }

  .champion-status-badge.champion-alumni {
    background: rgba(123, 31, 162, 0.15);
    color: var(--color-comms);
  }

  .champion-status-badge.champion-inactive {
    background: rgba(117, 117, 117, 0.15);
    color: var(--color-text-muted);
  }

  .champion-owner {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .champion-notes {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    font-style: italic;
    margin: 0;
  }

  /* Champion badge in table view */
  .champion-table-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 500;
  }

  .champion-table-badge.champion-active {
    background: rgba(46, 125, 50, 0.15);
    color: var(--color-success);
  }

  .champion-table-badge.champion-prospective {
    background: rgba(21, 101, 192, 0.15);
    color: var(--color-primary);
  }

  .champion-table-badge.champion-alumni {
    background: rgba(123, 31, 162, 0.15);
    color: var(--color-comms);
  }

  .champion-table-badge.champion-inactive {
    background: rgba(117, 117, 117, 0.15);
    color: var(--color-text-muted);
  }

  .contact-email {
    font-size: var(--font-size-sm);
    color: var(--color-primary);
    margin-bottom: var(--space-sm);
    word-break: break-all;
  }

  .contact-org {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-sm);
  }

  .contact-roles {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .role-tag {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
  }

  .role-tag.role-primary { background: rgba(46, 125, 50, 0.1); color: var(--color-success); }
  .role-tag.role-secondary { background: rgba(21, 101, 192, 0.1); color: var(--color-sep); }
  .role-tag.role-submitter { background: rgba(237, 108, 2, 0.1); color: var(--color-warning); }

  /* Contacts Container - Table View */
  .contacts-container.view-table {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .contacts-table {
    width: 100%;
    border-collapse: collapse;
  }

  .contacts-table th,
  .contacts-table td {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--color-border-light);
  }

  .contacts-table th {
    background: var(--color-surface-alt);
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    position: sticky;
    top: 0;
  }

  .contacts-table tr:hover {
    background: var(--color-surface-alt);
    cursor: pointer;
  }

  .contacts-table td {
    font-size: var(--font-size-sm);
  }

  .table-email {
    color: var(--color-primary);
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-xs);
    margin-top: var(--space-lg);
  }

  .page-btn {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border);
    background: var(--color-surface);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: var(--font-size-sm);
    min-width: 36px;
    transition: all var(--transition-fast);
  }

  .page-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
  .page-btn.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }
  .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Modal */
  .modal-content { max-width: 700px; }
  .modal-content.modal-lg { max-width: 900px; }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }

  .modal-title { font-size: var(--font-size-lg); font-weight: 600; margin: 0; }
  .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-muted); }
  .modal-close:hover { color: var(--color-text); }
  .modal-body { padding: var(--space-lg); overflow-y: auto; }

  /* Modal Content Sections */
  .contact-detail-header {
    display: flex;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
  }

  .contact-avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--color-primary), var(--color-gradient-light));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }

  .contact-detail-info { flex: 1; }
  .contact-detail-name { font-size: var(--font-size-xl); font-weight: 600; margin-bottom: var(--space-xs); }
  .contact-detail-email { color: var(--color-primary); margin-bottom: var(--space-xs); }
  .contact-detail-org { color: var(--color-text-secondary); font-size: var(--font-size-sm); }

  .contact-actions {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-sm);
  }

  .detail-section {
    margin-bottom: var(--space-lg);
  }

  .detail-section:last-child { margin-bottom: 0; }

  .detail-section-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--color-border-light);
  }

  .solutions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-sm);
  }

  .solution-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }

  .solution-item-name { color: var(--color-text); flex: 1; }
  .solution-item-roles { display: flex; gap: var(--space-xs); }

  .related-contacts-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .related-contact {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .related-contact:hover { background: var(--color-border-light); }
  .related-contact-name { font-weight: 500; }
  .related-contact-shared { font-size: var(--font-size-xs); color: var(--color-text-secondary); }

  /* Add Contact Form Styles */
  .form-section {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
  }

  .form-section:last-of-type {
    border-bottom: none;
  }

  .form-section-title {
    font-size: var(--font-size-md);
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 var(--space-md) 0;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .form-section.collapsible .form-section-title {
    cursor: pointer;
    user-select: none;
  }

  .form-section.collapsible .form-section-title:hover {
    color: var(--color-primary);
  }

  .section-toggle {
    transition: transform var(--transition-fast);
  }

  .form-section.collapsed .section-toggle {
    transform: rotate(-90deg);
  }

  .form-section.collapsed .form-section-content {
    display: none;
  }

  .optional-label {
    font-size: var(--font-size-sm);
    font-weight: 400;
    color: var(--color-text-muted);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-group label {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .form-group label .required {
    color: var(--color-error);
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .form-group input::placeholder,
  .form-group textarea::placeholder {
    color: var(--color-text-muted);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 80px;
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-md);
    margin-top: var(--space-lg);
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border-light);
  }

  .form-actions .btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  /* Toast Notification */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: var(--space-md) var(--space-lg);
    border-radius: var(--radius-md);
    background: var(--color-text);
    color: white;
    font-size: var(--font-size-sm);
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    transform: translateY(100px);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
    z-index: 2000;
  }

  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  .toast.success {
    background: var(--color-success);
  }

  .toast.error {
    background: var(--color-error);
  }

  .toast.info {
    background: var(--color-primary);
  }

  /* Inline Editing Styles */
  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .detail-label {
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .detail-value {
    font-size: var(--font-size-sm);
    color: var(--color-text);
  }

  .inline-edit-group {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .inline-select {
    flex: 1;
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
    cursor: pointer;
    transition: border-color var(--transition-fast);
  }

  .inline-select:hover {
    border-color: var(--color-primary);
  }

  .inline-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
  }

  .inline-textarea {
    width: 100%;
    padding: var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
    min-height: 60px;
    resize: vertical;
    font-family: inherit;
    transition: border-color var(--transition-fast);
  }

  .inline-textarea:hover {
    border-color: var(--color-primary);
  }

  .inline-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
  }

  .save-indicator {
    font-size: var(--font-size-xs);
    color: var(--color-success);
    margin-left: var(--space-sm);
    opacity: 0;
    transition: opacity var(--transition-fast);
  }

  .save-indicator.show {
    opacity: 1;
  }

  /* Collapsible Section Styles */
  .collapsible-section .collapsible-header {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    user-select: none;
  }

  .collapsible-section .collapsible-header:hover {
    color: var(--color-primary);
  }

  .section-toggle-icon {
    font-size: 18px;
    transition: transform var(--transition-fast);
  }

  .collapsible-section.collapsed .section-toggle-icon {
    transform: rotate(-90deg);
  }

  .collapsible-section .collapsible-content {
    margin-top: var(--space-sm);
    transition: max-height var(--transition-fast);
  }

  .collapsible-section.collapsed .collapsible-content {
    display: none;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .filter-row { flex-direction: column; align-items: stretch; }
    .filter-group { justify-content: space-between; }
    .contact-detail-header { flex-direction: column; align-items: center; text-align: center; }
    .form-row { grid-template-columns: 1fr; }
    .detail-grid { grid-template-columns: 1fr; }
  }
</style>

<!-- Contacts JavaScript -->
<script>
var Contacts = (function() {
  var state = {
    allContacts: [],
    filteredContacts: [],
    departments: [],
    solutions: [],
    teamMembers: [],
    relationshipOwners: [],
    currentPage: 1,
    pageSize: 24,
    view: 'cards',
    searchTimeout: null,
    currentContactEmail: null,
    isSaving: false
  };

  function init() {
    // Capture navigation ID to detect if user navigates away during load
    var navId = getNavigationId();
    loadContacts(navId);
    loadStats(navId);
    loadTeamMembers(navId);
  }

  function loadContacts(navId) {
    // Use CachedAPI for contacts (60 min TTL, shared across pages)
    CachedAPI.getContacts()
      .then(function(contacts) {
        // Abandon if user navigated away
        if (navId && !isNavigationCurrent(navId)) {
          console.log('[Contacts] Abandoning load - user navigated away');
          return;
        }

        // Normalize emails to lowercase for consistent comparison
        state.allContacts = (contacts || []).map(function(c) {
          if (c.email) c.email = c.email.toLowerCase().trim();
          return c;
        });
        extractFilters();

        // Check for pre-set solution filter from Implementation page
        var presetSolution = sessionStorage.getItem('contactsSolutionFilter');
        if (presetSolution) {
          sessionStorage.removeItem('contactsSolutionFilter');
          // Set the solution filter dropdown
          var solSelect = document.getElementById('filterSolution');
          // Find matching option (case-insensitive)
          for (var i = 0; i < solSelect.options.length; i++) {
            if (solSelect.options[i].value.toLowerCase() === presetSolution.toLowerCase()) {
              solSelect.value = solSelect.options[i].value;
              break;
            }
          }
        }


        applyFilters();
        updateMultiSolutionStat();

        // Check for deep link: #contact=CON_xxx
        var hash = window.location.hash;
        if (hash && hash.indexOf('#contact=') === 0) {
          var deepLinkId = decodeURIComponent(hash.replace('#contact=', ''));
          showDetail(deepLinkId);
        }
      })
      .catch(function(error) {
        if (navId && !isNavigationCurrent(navId)) return;
        console.error('Failed to load contacts:', error);
        showError('Failed to load contacts');
      });
  }

  function loadStats(navId) {
    google.script.run
      .withSuccessHandler(function(stats) {
        // Abandon if user navigated away
        if (navId && !isNavigationCurrent(navId)) return;

        if (stats) {
          document.getElementById('statTotalContacts').textContent = stats.unique_contacts || 0;
          document.getElementById('statDepartments').textContent = stats.departments_count || 0;
          document.getElementById('statSolutions').textContent = stats.solutions_count || 0;
        }
      })
      .withFailureHandler(function(error) {
        if (navId && !isNavigationCurrent(navId)) return;
        console.error('Failed to load stats:', error);
      })
      .getContactStats();
  }

  function loadTeamMembers(navId) {
    google.script.run
      .withSuccessHandler(function(team) {
        // Abandon if user navigated away
        if (navId && !isNavigationCurrent(navId)) return;

        state.teamMembers = team || [];
        populateOwnerDropdowns();
      })
      .withFailureHandler(function(error) {
        if (navId && !isNavigationCurrent(navId)) return;
        console.error('Failed to load team members:', error);
      })
      .getInternalTeam();
  }

  function populateOwnerDropdowns() {
    // Extract unique relationship owners from existing contacts
    var owners = {};
    state.allContacts.forEach(function(c) {
      if (c.relationship_owner && c.relationship_owner.trim()) {
        owners[c.relationship_owner.toLowerCase()] = c.relationship_owner;
      }
    });

    // Add team members to owner options
    state.teamMembers.forEach(function(tm) {
      if (tm.email) {
        owners[tm.email.toLowerCase()] = tm.email;
      }
    });

    state.relationshipOwners = Object.keys(owners).sort();

    // Populate filter dropdown
    var filterSelect = document.getElementById('filterOwner');
    if (filterSelect) {
      filterSelect.innerHTML = '<option value="">All</option>';
      state.relationshipOwners.forEach(function(email) {
        // Find display name from team members
        var displayName = email;
        var teamMember = state.teamMembers.find(function(tm) {
          return tm.email && tm.email.toLowerCase() === email.toLowerCase();
        });
        if (teamMember) {
          displayName = (teamMember.first_name || '') + ' ' + (teamMember.last_name || '');
          displayName = displayName.trim() || email;
        }
        var opt = document.createElement('option');
        opt.value = email;
        opt.textContent = displayName;
        filterSelect.appendChild(opt);
      });
    }

    // Populate form dropdown
    var formSelect = document.getElementById('newRelationshipOwner');
    if (formSelect) {
      formSelect.innerHTML = '<option value="">-- Select Team Member --</option>';
      state.teamMembers.forEach(function(tm) {
        if (tm.email) {
          var opt = document.createElement('option');
          opt.value = tm.email;
          opt.textContent = ((tm.first_name || '') + ' ' + (tm.last_name || '')).trim() || tm.email;
          formSelect.appendChild(opt);
        }
      });
    }
  }

  function updateMultiSolutionStat() {
    var multiCount = state.allContacts.filter(function(c) {
      return c.solutions_count > 1;
    }).length;
    document.getElementById('statTopEngaged').textContent = multiCount || '--';
  }

  function extractFilters() {
    var depts = {}, sols = {};

    state.allContacts.forEach(function(c) {
      if (c.department) depts[c.department] = true;
      if (c.solutions) {
        c.solutions.forEach(function(s) { sols[s] = true; });
      }
    });

    state.departments = Object.keys(depts).sort();
    state.solutions = Object.keys(sols).sort();

    populateFilterDropdowns();
    populateOwnerDropdowns();
  }

  function populateFilterDropdowns() {
    var deptSelect = document.getElementById('filterDepartment');
    var solSelect = document.getElementById('filterSolution');

    // Guard against SPA navigation - elements may not exist
    if (!deptSelect || !solSelect) {
      // SPA navigation - elements no longer exist
      return;
    }

    deptSelect.innerHTML = '<option value="">All Departments</option>';
    state.departments.forEach(function(d) {
      var opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      deptSelect.appendChild(opt);
    });

    solSelect.innerHTML = '<option value="">All Solutions</option>';
    state.solutions.forEach(function(s) {
      var opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s.length > 50 ? s.substring(0, 50) + '...' : s;
      solSelect.appendChild(opt);
    });
  }

  function debounceSearch() {
    clearTimeout(state.searchTimeout);
    state.searchTimeout = setTimeout(function() {
      applyFilters();
    }, 300);
  }

  function applyFilters() {
    var search = document.getElementById('searchInput').value.toLowerCase().trim();
    var dept = document.getElementById('filterDepartment').value;
    var sol = document.getElementById('filterSolution').value;
    var role = document.getElementById('filterRole').value;
    var year = document.getElementById('filterYear').value;
    var champion = document.getElementById('filterChampion').value;
    var owner = document.getElementById('filterOwner').value;

    state.filteredContacts = state.allContacts.filter(function(c) {
      // Search filter
      if (search) {
        var searchable = [
          c.first_name, c.last_name, c.email, c.department, c.agency, c.organization
        ].join(' ').toLowerCase();
        if (searchable.indexOf(search) === -1) return false;
      }

      // Department filter
      if (dept && c.department !== dept) return false;

      // Solution filter
      if (sol && (!c.solutions || c.solutions.indexOf(sol) === -1)) return false;

      // Role filter
      if (role && (!c.roles || c.roles.indexOf(role) === -1)) return false;

      // Year filter
      if (year && (!c.years || c.years.indexOf(parseInt(year)) === -1)) return false;

      // Champion filter
      if (champion) {
        if (champion === 'any') {
          // Any champion (non-empty status)
          if (!c.champion_status || c.champion_status.trim() === '') return false;
        } else {
          // Specific status
          if (c.champion_status !== champion) return false;
        }
      }

      // Relationship owner filter
      if (owner) {
        var contactOwner = (c.relationship_owner || '').toLowerCase().trim();
        if (contactOwner !== owner.toLowerCase()) return false;
      }

      return true;
    });

    // Sort by solutions count (most engaged first), then by name
    state.filteredContacts.sort(function(a, b) {
      if (b.solutions_count !== a.solutions_count) {
        return b.solutions_count - a.solutions_count;
      }
      return (a.last_name || '').localeCompare(b.last_name || '');
    });

    state.currentPage = 1;
    render();
  }

  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('filterDepartment').value = '';
    document.getElementById('filterSolution').value = '';
    document.getElementById('filterRole').value = '';
    document.getElementById('filterYear').value = '';
    document.getElementById('filterChampion').value = '';
    document.getElementById('filterOwner').value = '';
    applyFilters();
  }

  function setView(view) {
    state.view = view;
    document.querySelectorAll('.view-btn').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.view === view);
    });
    render();
  }

  function render() {
    var container = document.getElementById('contactsContainer');
    var total = state.filteredContacts.length;
    var start = (state.currentPage - 1) * state.pageSize;
    var end = Math.min(start + state.pageSize, total);
    var pageContacts = state.filteredContacts.slice(start, end);

    document.getElementById('resultsCount').textContent =
      'Showing ' + (total > 0 ? start + 1 : 0) + '-' + end + ' of ' + total + ' contacts';

    if (total === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">group</span><p>No contacts match your filters</p></div>';
      container.className = 'contacts-container';
renderPagination();
      return;
    }

    if (state.view === 'cards') {
      container.className = 'contacts-container view-cards';
      container.innerHTML = pageContacts.map(renderContactCard).join('');
    } else {
      container.className = 'contacts-container view-table';
      container.innerHTML = renderContactTable(pageContacts);
    }
renderPagination();
  }

  function renderContactCard(contact) {
    var initials = ((contact.first_name || '')[0] || '') + ((contact.last_name || '')[0] || '');
    var roles = (contact.roles || []).slice(0, 3);

    var html = '<div class="contact-card" onclick="Contacts.showDetail(\'' + escapeAttr(contact.email) + '\')">';
    html += '<div class="contact-card-header">';
    html += '<span class="contact-name">' + escapeHtml(contact.first_name || '') + ' ' + escapeHtml(contact.last_name || '') + '</span>';
    html += '<div class="contact-badges">';
    if (contact.champion_status) {
      var championClass = 'champion-badge champion-' + contact.champion_status.toLowerCase();
      html += '<span class="' + championClass + '" title="Champion: ' + escapeAttr(contact.champion_status) + '">';
      html += '<span class="material-icons">star</span></span>';
    }
    html += '<span class="contact-solutions-count">' + (contact.solutions_count || 0) + ' solutions</span>';
    html += '</div>';
    html += '</div>';
    html += '<div class="contact-email">' + escapeHtml(contact.email || '') + '</div>';

    if (contact.department || contact.agency) {
      html += '<div class="contact-org">' + escapeHtml(contact.department || contact.agency || '') + '</div>';
    }

    if (roles.length > 0) {
      html += '<div class="contact-roles">';
      roles.forEach(function(role) {
        var roleClass = 'role-tag';
        if (role.includes('Primary')) roleClass += ' role-primary';
        else if (role.includes('Secondary')) roleClass += ' role-secondary';
        else if (role.includes('Submitter')) roleClass += ' role-submitter';
        html += '<span class="' + roleClass + '">' + escapeHtml(role) + '</span>';
      });
      html += '</div>';
    }

    html += '</div>';
    return html;
  }

  function renderContactTable(contacts) {
    var html = '<table class="contacts-table">';
    html += '<thead><tr>';
    html += '<th>Name</th>';
    html += '<th>Email</th>';
    html += '<th>Department</th>';
    html += '<th>Solutions</th>';
    html += '<th>Champion</th>';
    html += '<th>Roles</th>';
    html += '</tr></thead>';
    html += '<tbody>';

    contacts.forEach(function(c) {
      html += '<tr onclick="Contacts.showDetail(\'' + escapeAttr(c.email) + '\')">';
      html += '<td>' + escapeHtml((c.first_name || '') + ' ' + (c.last_name || '')) + '</td>';
      html += '<td class="table-email">' + escapeHtml(c.email || '') + '</td>';
      html += '<td>' + escapeHtml(c.department || '-') + '</td>';
      html += '<td>' + (c.solutions_count || 0) + '</td>';
      // Champion status cell
      html += '<td>';
      if (c.champion_status) {
        var statusClass = 'champion-table-badge champion-' + c.champion_status.toLowerCase();
        html += '<span class="' + statusClass + '">' + escapeHtml(c.champion_status) + '</span>';
      } else {
        html += '-';
      }
      html += '</td>';
      html += '<td>' + escapeHtml((c.roles || []).slice(0, 2).join(', ') || '-') + '</td>';
      html += '</tr>';
    });

    html += '</tbody></table>';
    return html;
  }

  function renderPagination() {
    var total = state.filteredContacts.length;
    var totalPages = Math.ceil(total / state.pageSize);
    var container = document.getElementById('pagination');

    if (totalPages <= 1) {
      container.innerHTML = '';
      return;
    }

    var html = '';
    html += '<button class="page-btn" onclick="Contacts.goToPage(1)" ' + (state.currentPage === 1 ? 'disabled' : '') + '>&laquo;</button>';
    html += '<button class="page-btn" onclick="Contacts.goToPage(' + (state.currentPage - 1) + ')" ' + (state.currentPage === 1 ? 'disabled' : '') + '>&lsaquo;</button>';

    var startPage = Math.max(1, state.currentPage - 2);
    var endPage = Math.min(totalPages, startPage + 4);
    startPage = Math.max(1, endPage - 4);

    for (var i = startPage; i <= endPage; i++) {
      html += '<button class="page-btn' + (i === state.currentPage ? ' active' : '') + '" onclick="Contacts.goToPage(' + i + ')">' + i + '</button>';
    }

    html += '<button class="page-btn" onclick="Contacts.goToPage(' + (state.currentPage + 1) + ')" ' + (state.currentPage === totalPages ? 'disabled' : '') + '>&rsaquo;</button>';
    html += '<button class="page-btn" onclick="Contacts.goToPage(' + totalPages + ')" ' + (state.currentPage === totalPages ? 'disabled' : '') + '>&raquo;</button>';

    container.innerHTML = html;
  }

  function goToPage(page) {
    var totalPages = Math.ceil(state.filteredContacts.length / state.pageSize);
    if (page < 1 || page > totalPages) return;
    state.currentPage = page;
    render();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function showDetail(emailOrId) {
    var contact = null;
    if (emailOrId && emailOrId.indexOf('CON_') === 0) {
      contact = state.allContacts.find(function(c) { return c.contact_id === emailOrId; });
    } else {
      var normalizedEmail = (emailOrId || '').toLowerCase().trim();
      contact = state.allContacts.find(function(c) { return c.email === normalizedEmail; });
    }
    if (!contact) return;

    state.currentContactEmail = (contact.email || '').toLowerCase().trim();

    document.getElementById('contactModalTitle').textContent =
      (contact.first_name || '') + ' ' + (contact.last_name || '');

    var initials = ((contact.first_name || '')[0] || '') + ((contact.last_name || '')[0] || '');

    var html = '<div class="contact-detail-header">';
    html += '<div class="contact-avatar">' + initials.toUpperCase() + '</div>';
    html += '<div class="contact-detail-info">';
    html += '<div class="contact-detail-name">' + escapeHtml((contact.first_name || '') + ' ' + (contact.last_name || '')) + '</div>';
    if (contact.email) {
      html += '<div class="contact-detail-email"><a href="mailto:' + escapeHtml(contact.email) + '">' + escapeHtml(contact.email) + '</a></div>';
    }

    if (contact.department || contact.agency) {
      html += '<div class="contact-detail-org">' + escapeHtml(contact.department || '') + (contact.agency ? ' / ' + escapeHtml(contact.agency) : '') + '</div>';
    }

    html += '</div></div>';

    // SNWG Champion Section - Inline Editable
    html += '<div class="detail-section">';
    html += '<div class="detail-section-title"><span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">star</span> SNWG Champion <span class="save-indicator" id="saveIndicator"></span></div>';
    html += '<div class="detail-grid">';

    // Champion Status - Inline Editable
    html += '<div class="detail-item"><div class="detail-label">Status</div><div class="detail-value inline-edit-group">';
    html += '<select class="inline-select" id="editChampionStatus" onchange="Contacts.updateContactField(\'' + escapeAttr(contact.email) + '\', \'champion_status\', this.value)">';
    html += '<option value="">Not a Champion</option>';
    ['Active', 'Prospective', 'Alumni', 'Inactive'].forEach(function(status) {
      var selected = contact.champion_status === status ? ' selected' : '';
      var labels = { 'Active': 'Active - Currently engaged', 'Prospective': 'Prospective - Being cultivated', 'Alumni': 'Alumni - Former champion', 'Inactive': 'Inactive - Dormant' };
      html += '<option value="' + status + '"' + selected + '>' + labels[status] + '</option>';
    });
    html += '</select></div></div>';

    // NSITE MO Connection - Inline Editable
    html += '<div class="detail-item"><div class="detail-label">NSITE MO Connection</div><div class="detail-value inline-edit-group">';
    html += '<select class="inline-select" id="editRelationshipOwner" onchange="Contacts.updateContactField(\'' + escapeAttr(contact.email) + '\', \'relationship_owner\', this.value)">';
    html += '<option value="">-- None --</option>';
    state.teamMembers.forEach(function(tm) {
      if (tm.email) {
        var selected = contact.relationship_owner && contact.relationship_owner.toLowerCase() === tm.email.toLowerCase() ? ' selected' : '';
        var displayName = ((tm.first_name || '') + ' ' + (tm.last_name || '')).trim() || tm.email;
        html += '<option value="' + escapeAttr(tm.email) + '"' + selected + '>' + escapeHtml(displayName) + '</option>';
      }
    });
    html += '</select></div></div>';

    html += '</div>';

    // Champion Notes - View/Edit pattern
    html += '<div class="detail-item" style="margin-top: var(--space-sm);"><div class="detail-label">Champion Notes</div>';
    // View mode
    html += '<div id="championNotesView">';
    if (contact.champion_notes && contact.champion_notes.trim()) {
      html += '<div class="notes-content" style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">' + displayRichContent(contact.champion_notes) + '</div>';
    } else {
      html += '<div class="notes-empty" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-xs);">No champion notes yet</div>';
    }
    html += '<button class="btn btn-secondary btn-sm" onclick="Contacts.editChampionNotes()"><span class="material-icons" style="font-size: 14px; margin-right: 4px;">edit</span>Edit</button>';
    html += '</div>';
    // Edit mode (hidden by default)
    html += '<div id="championNotesEdit" style="display: none;">';
    html += '<div id="editChampionNotes" class="rich-text-field" contenteditable="true" data-placeholder="Why is this person a champion? Value they bring?"></div>';
    html += '<div style="display: flex; gap: var(--space-xs); margin-top: var(--space-xs);">';
    html += '<button class="btn btn-secondary btn-sm" onclick="Contacts.cancelChampionNotes()">Cancel</button>';
    html += '<button class="btn btn-primary btn-sm" onclick="Contacts.saveChampionNotes(\'' + escapeAttr(contact.email) + '\')">Save</button>';
    html += '</div>';
    html += '</div>';
    html += '</div>';

    html += '</div>';

    // Solutions section - Collapsible, collapsed by default
    html += '<div class="detail-section collapsible-section collapsed" id="solutionsSection">';
    html += '<div class="detail-section-title collapsible-header" onclick="Contacts.toggleDetailSection(\'solutionsSection\')">';
    html += '<span class="material-icons section-toggle-icon">expand_more</span>';
    html += 'Solutions (' + (contact.solutions_count || 0) + ')';
    html += '</div>';
    html += '<div class="collapsible-content">';

    if (contact.solutions && contact.solutions.length > 0) {
      html += '<div class="solutions-grid">';
      contact.solutions.forEach(function(sol) {
        html += '<div class="solution-item">';
        html += '<span class="solution-item-name">' + escapeHtml(sol.length > 45 ? sol.substring(0, 45) + '...' : sol) + '</span>';
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<p style="color:var(--color-text-muted)">No solutions linked</p>';
    }
    html += '</div></div>';

    // Roles section
    if (contact.roles && contact.roles.length > 0) {
      html += '<div class="detail-section">';
      html += '<div class="detail-section-title">Roles</div>';
      html += '<div class="contact-roles" style="gap: var(--space-sm);">';
      contact.roles.forEach(function(role) {
        var roleClass = 'role-tag';
        if (role.includes('Primary')) roleClass += ' role-primary';
        else if (role.includes('Secondary')) roleClass += ' role-secondary';
        else if (role.includes('Submitter')) roleClass += ' role-submitter';
        html += '<span class="' + roleClass + '" style="font-size: var(--font-size-sm); padding: 4px 12px;">' + escapeHtml(role) + '</span>';
      });
      html += '</div></div>';
    }

    // Survey Years
    if (contact.years && contact.years.length > 0) {
      html += '<div class="detail-section">';
      html += '<div class="detail-section-title">Survey Participation</div>';
      html += '<p>Participated in surveys: <strong>' + contact.years.join(', ') + '</strong></p>';
      html += '</div>';
    }

    // Events Participated section
    html += '<div class="detail-section" id="eventsParticipatedSection">';
    html += '<div class="detail-section-title"><span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">event</span> Events Participated</div>';
    html += '<div class="loading-state"><span class="loading-spinner"></span></div>';
    html += '</div>';

    // Load related contacts
    html += '<div class="detail-section" id="relatedContactsSection">';
    html += '<div class="detail-section-title">Related Contacts</div>';
    html += '<div class="loading-state"><span class="loading-spinner"></span></div>';
    html += '</div>';

    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('contactModal').classList.add('active');

    // Load events participated async
    var contactId = contact.contact_id || contact.email;
    google.script.run
      .withSuccessHandler(function(summary) {
        renderEventsParticipated(summary);
      })
      .withFailureHandler(function(error) {
        document.getElementById('eventsParticipatedSection').innerHTML =
          '<div class="detail-section-title"><span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">event</span> Events Participated</div><p style="color:var(--color-text-muted)">Could not load event participation</p>';
      })
      .getContactEventsSummary(contactId);

    // Load related contacts async
    google.script.run
      .withSuccessHandler(function(related) {
        renderRelatedContacts(related);
      })
      .withFailureHandler(function(error) {
        document.getElementById('relatedContactsSection').innerHTML =
          '<div class="detail-section-title">Related Contacts</div><p style="color:var(--color-text-muted)">Could not load related contacts</p>';
      })
      .getRelatedContacts(contact.email);
  }

  function renderEventsParticipated(summary) {
    var section = document.getElementById('eventsParticipatedSection');
    if (!summary || summary.total_events === 0) {
      section.innerHTML = '<div class="detail-section-title"><span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">event</span> Events Participated</div><p style="color:var(--color-text-muted)">No event participation recorded</p>';
      return;
    }

    var html = '<div class="detail-section-title"><span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">event</span> Events Participated (' + summary.total_events + ')</div>';

    // Summary stats
    html += '<div class="event-stats" style="display: flex; gap: var(--space-md); margin-bottom: var(--space-sm); font-size: var(--font-size-sm); color: var(--color-text-secondary);">';
    html += '<span><strong>' + summary.completed + '</strong> completed</span>';
    if (summary.upcoming > 0) {
      html += '<span><strong>' + summary.upcoming + '</strong> upcoming</span>';
    }
    html += '</div>';

    // Event list
    html += '<div class="events-list" style="display: flex; flex-direction: column; gap: var(--space-xs);">';
    summary.events.slice(0, 5).forEach(function(event) {
      var eventDate = event.event_date ? formatDate(event.event_date) : '';
      var statusClass = (event.event_status || 'planning').toLowerCase();
      html += '<div class="event-item" style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); background: var(--color-surface-alt); border-radius: var(--radius-sm); border-left: 3px solid var(--color-sep);">';
      html += '<div style="flex: 1; min-width: 0;">';
      html += '<div style="font-weight: 500; font-size: var(--font-size-sm);">' + escapeHtml(event.event_name || 'Unnamed Event') + '</div>';
      html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted);">';
      if (eventDate) html += eventDate;
      if (event.solution_id) html += (eventDate ? '  ' : '') + escapeHtml(event.solution_id.toUpperCase());
      html += '</div>';
      html += '</div>';
      html += '<span class="event-status-badge status-' + statusClass + '">' + escapeHtml(event.event_status || 'Planning') + '</span>';
      html += '</div>';
    });
    html += '</div>';

    if (summary.events.length > 5) {
      html += '<p style="text-align:center;color:var(--color-text-muted);margin-top:var(--space-sm);font-size:var(--font-size-sm);">+' + (summary.events.length - 5) + ' more events</p>';
    }

    section.innerHTML = html;
  }

  function renderRelatedContacts(related) {
    var section = document.getElementById('relatedContactsSection');
    if (!related || related.length === 0) {
      section.innerHTML = '<div class="detail-section-title">Related Contacts</div><p style="color:var(--color-text-muted)">No related contacts found</p>';
      return;
    }

    var html = '<div class="detail-section-title">Related Contacts (' + related.length + ' colleagues)</div>';
    html += '<div class="related-contacts-list">';

    related.slice(0, 10).forEach(function(r) {
      html += '<div class="related-contact" onclick="Contacts.showDetail(\'' + escapeAttr(r.email) + '\')">';
      html += '<span class="related-contact-name">' + escapeHtml((r.first_name || '') + ' ' + (r.last_name || '')) + '</span>';
      html += '<span class="related-contact-shared">' + r.shared_count + ' shared solutions</span>';
      html += '</div>';
    });

    if (related.length > 10) {
      html += '<p style="text-align:center;color:var(--color-text-muted);margin-top:var(--space-sm);">+' + (related.length - 10) + ' more colleagues</p>';
    }

    html += '</div>';
    section.innerHTML = html;
  }

  function closeModal(event) {
    window.closeModal('contactModal', event);
  }

  function refresh() {
    loadContacts();
    loadStats();
  }

  // ============================================
  // Add Contact Modal Functions
  // ============================================

  function showAddModal() {
    document.getElementById('addContactForm').reset();
    // Collapse optional sections by default
    document.querySelectorAll('#addContactModal .form-section.collapsible').forEach(function(section) {
      section.classList.add('collapsed');
    });
    loadSolutionsForDropdown();
    loadAgenciesForDatalist();
    document.getElementById('addContactModal').classList.add('active');
    // Focus first field
    setTimeout(function() {
      document.getElementById('newFirstName').focus();
    }, 100);
  }

  function closeAddModal(event) {
    if (!event || event.target === document.getElementById('addContactModal')) {
      document.getElementById('addContactModal').classList.remove('active');
    }
  }

  function toggleFormSection(titleElement) {
    var section = titleElement.closest('.form-section');
    section.classList.toggle('collapsed');
  }

  function loadSolutionsForDropdown() {
    google.script.run
      .withSuccessHandler(function(solutions) {
        var select = document.getElementById('newSolution');
        select.innerHTML = '<option value="">-- Select Solution --</option>';
        (solutions || []).forEach(function(sol) {
          var opt = document.createElement('option');
          opt.value = sol.solution_id || sol.solution_id || sol.name;
          opt.textContent = sol.core_name || sol.name || sol.solution_id;
          select.appendChild(opt);
        });
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load solutions:', error);
      })
      .getAllSolutions();
  }

  function loadAgenciesForDatalist() {
    google.script.run
      .withSuccessHandler(function(agencies) {
        var datalist = document.getElementById('agencyList');
        datalist.innerHTML = '';
        (agencies || []).forEach(function(agency) {
          var opt = document.createElement('option');
          opt.value = agency.name || agency.agency_name;
          datalist.appendChild(opt);
        });
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load agencies:', error);
      })
      .getAllAgencies();
  }

  function submitNewContact(event) {
    event.preventDefault();
    if (state.isSaving) return false;

    var form = document.getElementById('addContactForm');
    var submitBtn = document.getElementById('submitContactBtn');
    var originalText = submitBtn.innerHTML;

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';

    // Gather form data
    var contactData = {
      first_name: form.first_name.value.trim(),
      last_name: form.last_name.value.trim(),
      email: form.email.value.trim().toLowerCase(),
      title: form.title.value.trim(),
      department: form.department.value.trim(),
      agency: form.agency.value.trim(),
      organization: form.organization.value.trim(),
      region: form.region.value,
      solution_id: form.solution_id.value,
      role: form.role.value,
      touchpoint_status: form.touchpoint_status.value,
      engagement_level: form.engagement_level.value,
      relationship_notes: getRichTextContent('newRelationshipNotes'),
      // Champion fields
      champion_status: form.champion_status.value,
      relationship_owner: form.relationship_owner.value,
      champion_notes: getRichTextContent('newChampionNotes')
    };

    state.isSaving = true;
    google.script.run
      .withSuccessHandler(function(result) {
        state.isSaving = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;

        if (result && result.success) {
          closeAddModal();
          // Show success message
          showToast('Contact added successfully!', 'success');
          // Refresh contacts list
          refresh();
        } else {
          showToast(result && result.error ? result.error : 'Failed to add contact', 'error');
        }
      })
      .withFailureHandler(function(error) {
        state.isSaving = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        showToast('Could not load contact details. Please try again.', 'error');
      })
      .createContact(contactData);

    return false;
  }

  // showToast removed - uses global showToast() from index.html

  function exportList() {
    // Export current filtered list
    if (state.filteredContacts.length === 0) {
      showToast('No contacts to export', 'warning');
      return;
    }

    var csv = 'First Name,Last Name,Email,Title,Department,Agency,Roles,Solutions,Years,Solutions Count\n';
    state.filteredContacts.forEach(function(c) {
      var roles = Array.isArray(c.roles) ? c.roles.join('; ') : (c.roles || '');
      var solutions = Array.isArray(c.solutions) ? c.solutions.join('; ') : (c.solutions || '');
      var years = Array.isArray(c.years) ? c.years.join('; ') : (c.years || '');
      csv += '"' + (c.first_name || '') + '","' + (c.last_name || '') + '","' + (c.email || '') + '","' + (c.title || '') + '","' + (c.department || '') + '","' + (c.agency || '') + '","' + roles.replace(/"/g, '""') + '","' + solutions.replace(/"/g, '""') + '","' + years + '",' + (c.solutions_count || 0) + '\n';
    });

    var blob = new Blob([csv], { type: 'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'contacts_export.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  // escapeHtml() and escapeAttr() - use globals from index.html

  function showError(message) {
    document.getElementById('contactsContainer').innerHTML =
      '<div class="empty-state"><span class="material-icons">error</span><p>' + message + '</p></div>';
  }

  // ============================================
  // Inline Edit Functions
  // ============================================

  function updateContactField(email, fieldName, value) {
    if (state.isSaving) return;

    var indicator = document.getElementById('saveIndicator');
    if (indicator) {
      indicator.textContent = 'Saving...';
      indicator.classList.add('show');
    }

    // Map field names to API functions
    var apiCallMap = {
      'champion_status': 'updateContactChampionStatus',
      'relationship_owner': 'updateContactRelationshipOwner',
      'champion_notes': 'updateContactChampionNotes'
    };

    var apiFunction = apiCallMap[fieldName];
    if (!apiFunction) {
      console.error('Unknown field:', fieldName);
      if (indicator) {
        indicator.textContent = 'Error';
        setTimeout(function() { indicator.classList.remove('show'); }, 2000);
      }
      return;
    }

    state.isSaving = true;
    google.script.run
      .withSuccessHandler(function(result) {
        state.isSaving = false;
        if (result && result.success) {
          if (indicator) {
            indicator.textContent = 'Saved';
            setTimeout(function() { indicator.classList.remove('show'); }, 1500);
          }
          // Update local state
          var contact = state.allContacts.find(function(c) {
            return c.email === email.toLowerCase();
          });
          if (contact) {
            contact[fieldName] = value;
          }
          // Invalidate cache so other pages see the update
          if (typeof CachedAPI !== 'undefined' && CachedAPI.invalidate) {
            CachedAPI.invalidate.contacts();
          }
        } else {
          if (indicator) {
            indicator.textContent = 'Failed';
            setTimeout(function() { indicator.classList.remove('show'); }, 2000);
          }
          showToast(result && result.error ? result.error : 'Failed to save', 'error');
        }
      })
      .withFailureHandler(function(error) {
        state.isSaving = false;
        if (indicator) {
          indicator.textContent = 'Error';
          setTimeout(function() { indicator.classList.remove('show'); }, 2000);
        }
        showToast('Could not save contact. Please try again.', 'error');
      })
      [apiFunction](email, value);
  }

  function editChampionNotes() {
    var viewEl = document.getElementById('championNotesView');
    var editEl = document.getElementById('championNotesEdit');
    if (viewEl) viewEl.style.display = 'none';
    if (editEl) editEl.style.display = 'block';
    var notesField = document.getElementById('editChampionNotes');
    if (notesField) {
      initRichTextField('editChampionNotes', 'Why is this person a champion? Value they bring?');
      var contact = state.allContacts.find(function(c) { return c.email === state.currentContactEmail; });
      setRichTextContent('editChampionNotes', (contact && contact.champion_notes) || '');
      notesField.focus();
    }
  }

  function saveChampionNotes(email) {
    if (state.isSaving) return;
    var notesEl = document.getElementById('editChampionNotes');
    if (!notesEl) return;

    var notes = getRichTextContent('editChampionNotes');
    var indicator = document.getElementById('saveIndicator');
    if (indicator) {
      indicator.textContent = 'Saving...';
      indicator.classList.add('show');
    }

    state.isSaving = true;
    google.script.run
      .withSuccessHandler(function(result) {
        state.isSaving = false;
        if (result && result.success) {
          if (indicator) {
            indicator.textContent = 'Saved';
            setTimeout(function() { indicator.classList.remove('show'); }, 1500);
          }
          // Update local state
          var contact = state.allContacts.find(function(c) { return c.email === email.toLowerCase(); });
          if (contact) {
            contact.champion_notes = notes;
          }
          if (typeof CachedAPI !== 'undefined' && CachedAPI.invalidate) {
            CachedAPI.invalidate.contacts();
          }
          // Update view mode content
          var viewEl = document.getElementById('championNotesView');
          if (viewEl) {
            var contentHtml = '';
            if (notes && notes.trim()) {
              contentHtml = '<div class="notes-content" style="font-size: var(--font-size-sm); margin-bottom: var(--space-xs);">' + displayRichContent(notes) + '</div>';
            } else {
              contentHtml = '<div class="notes-empty" style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: var(--space-xs);">No champion notes yet</div>';
            }
            contentHtml += '<button class="btn btn-secondary btn-sm" onclick="Contacts.editChampionNotes()"><span class="material-icons" style="font-size: 14px; margin-right: 4px;">edit</span>Edit</button>';
            viewEl.innerHTML = contentHtml;
          }
          // Switch back to view mode
          var editEl = document.getElementById('championNotesEdit');
          if (viewEl) viewEl.style.display = 'block';
          if (editEl) editEl.style.display = 'none';
        } else {
          if (indicator) {
            indicator.textContent = 'Failed';
            setTimeout(function() { indicator.classList.remove('show'); }, 2000);
          }
          showToast(result && result.error ? result.error : 'Failed to save', 'error');
        }
      })
      .withFailureHandler(function(error) {
        state.isSaving = false;
        if (indicator) {
          indicator.textContent = 'Error';
          setTimeout(function() { indicator.classList.remove('show'); }, 2000);
        }
        showToast('Could not save changes. Please try again.', 'error');
      })
      .updateContactChampionNotes(email, notes);
  }

  function cancelChampionNotes() {
    var contact = state.allContacts.find(function(c) { return c.email === state.currentContactEmail; });
    setRichTextContent('editChampionNotes', (contact && contact.champion_notes) || '');
    var viewEl = document.getElementById('championNotesView');
    var editEl = document.getElementById('championNotesEdit');
    if (viewEl) viewEl.style.display = 'block';
    if (editEl) editEl.style.display = 'none';
  }

  function toggleDetailSection(sectionId) {
    var section = document.getElementById(sectionId);
    if (section) {
      section.classList.toggle('collapsed');
    }
  }

  return {
    init: init,
    debounceSearch: debounceSearch,
    applyFilters: applyFilters,
    clearFilters: clearFilters,
    setView: setView,
    goToPage: goToPage,
    showDetail: showDetail,
    closeModal: closeModal,
    refresh: refresh,
    exportList: exportList,
    showAddModal: showAddModal,
    closeAddModal: closeAddModal,
    toggleFormSection: toggleFormSection,
    submitNewContact: submitNewContact,
    updateContactField: updateContactField,
    editChampionNotes: editChampionNotes,
    saveChampionNotes: saveChampionNotes,
    cancelChampionNotes: cancelChampionNotes,
    toggleDetailSection: toggleDetailSection
  };
})();

// Initialize  queued so CachedAPI is available (defined in index.html main script)
queuePageInit(function() { Contacts.init(); });
</script>
