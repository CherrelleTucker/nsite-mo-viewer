<!-- Comms-NSITE: Communications Pipeline -->
<!-- Story tracking, opportunity detection, and coverage analysis -->

<div class="comms-viewer">
  <!-- Page Header -->
  <div class="page-header" style="justify-content: flex-end;">
    <div class="page-actions">
      <div class="view-toggle">
        <button class="view-btn active" data-view="content" onclick="COMMS.setView('content')">
          <span class="material-icons">library_books</span>
          <span>Content</span>
        </button>
        <button class="view-btn" data-view="assets" onclick="COMMS.setView('assets')">
          <span class="material-icons">perm_media</span>
          <span>Assets</span>
        </button>
        <button class="view-btn" data-view="events" onclick="COMMS.setView('events')">
          <span class="material-icons">place</span>
          <span>Events</span>
        </button>
        <button class="view-btn" data-view="manage" onclick="COMMS.setView('manage')">
          <span class="material-icons">settings</span>
          <span>Manage</span>
        </button>
      </div>
      <button class="btn btn-primary" onclick="COMMS.showAddAssetModal()">
        <span class="material-icons">add</span>
        Add Content
      </button>
    </div>
  </div>

  <!-- Stats Row (Pipeline only) -->
  <div class="stats-row" id="pipelineStatsRow">
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">description</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statTotalStories">--</span>
        <span class="stat-label">Total Stories</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">trending_up</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statInPipeline">--</span>
        <span class="stat-label">In Pipeline</span>
      </div>
    </div>
    <div class="stat-card stat-success">
      <div class="stat-icon"><span class="material-icons">check_circle</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statPublishedQtr">--</span>
        <span class="stat-label">Published (Q)</span>
      </div>
    </div>
    <div class="stat-card stat-warning">
      <div class="stat-icon"><span class="material-icons">warning</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statCoverageGaps">--</span>
        <span class="stat-label">Coverage Gaps</span>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="comms-content">
    <!-- Content View (NEW DEFAULT) -->
    <div class="view-panel active" id="contentView">
      <div class="content-view-layout">
        <!-- Search Header -->
        <div class="content-search-header">
          <div class="content-search-box">
            <span class="material-icons">search</span>
            <input type="text" id="contentSearchInput" placeholder="What do you need content about?" oninput="COMMS.searchContent(this.value)">
          </div>
          <div class="content-filters">
            <label>Browse by Solution:</label>
            <select id="contentSolutionSelect" onchange="COMMS.selectContentSolution(this.value)">
              <option value="">All Solutions</option>
            </select>
            <button class="btn btn-secondary" onclick="COMMS.showAddAssetModal()">
              <span class="material-icons">add</span>
              New Asset
            </button>
          </div>
        </div>

        <!-- Content Results Area -->
        <div id="contentResults" class="content-results">
          <!-- Default: Quick Access Cards -->
          <div class="content-quick-access" id="contentQuickAccess">
            <div class="quick-access-grid">
              <div class="quick-access-card" onclick="COMMS.showRecentBlurbs()">
                <span class="material-icons">history</span>
                <h4>Recent Blurbs</h4>
                <p>Latest HQ updates and highlights</p>
              </div>
              <div class="quick-access-card" onclick="COMMS.showMostUsed()">
                <span class="material-icons">trending_up</span>
                <h4>Most Used</h4>
                <p>Frequently copied content</p>
              </div>
              <div class="quick-access-card" onclick="COMMS.showByType()">
                <span class="material-icons">category</span>
                <h4>By Type</h4>
                <p>Browse talking points, facts, quotes</p>
              </div>
            </div>
          </div>

          <!-- Solution Content (shown when solution selected) -->
          <div class="solution-content-panel" id="solutionContentPanel" style="display: none;">
            <div class="solution-content-header">
              <button class="btn btn-icon" onclick="COMMS.resetContentView()" title="Back to Quick Access">
                <span class="material-icons">arrow_back</span>
              </button>
              <h3 id="solutionContentTitle">Solution Name</h3>
              <div class="solution-content-actions">
                <button class="btn btn-secondary" onclick="COMMS.copyAllContent()">
                  <span class="material-icons">content_copy</span>
                  Copy All
                </button>
                <button class="btn btn-primary" onclick="COMMS.showPresentationBuilder()">
                  <span class="material-icons">slideshow</span>
                  Generate Presentation
                </button>
              </div>
            </div>

            <!-- Content grouped by type -->
            <div class="content-type-sections" id="contentTypeSections">
              <!-- Populated dynamically -->
            </div>
          </div>

          <!-- Search Results (shown during search) -->
          <div class="search-results-panel" id="searchResultsPanel" style="display: none;">
            <div class="search-results-header">
              <button class="btn btn-icon" onclick="COMMS.resetContentView()" title="Back to Quick Access">
                <span class="material-icons">arrow_back</span>
              </button>
              <h3>Search Results: <span id="searchResultsQuery"></span></h3>
              <span class="search-results-count" id="searchResultsCount"></span>
            </div>
            <div class="content-type-sections" id="searchResultsSections">
              <!-- Populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Assets View (NEW) -->
    <div class="view-panel" id="assetsView">
      <div class="assets-view-layout">
        <!-- Assets Header -->
        <div class="assets-header">
          <div class="assets-filters">
            <select id="assetTypeFilter" onchange="COMMS.filterAssets()">
              <option value="">All Types</option>
              <option value="image">Images</option>
              <option value="presentation">Presentations</option>
              <option value="pdf">PDFs</option>
              <option value="video">Videos</option>
              <option value="document">Documents</option>
              <option value="graphic">Graphics</option>
            </select>
            <select id="assetSolutionFilter" onchange="COMMS.filterAssets()">
              <option value="">All Solutions</option>
            </select>
            <div class="assets-search-box">
              <span class="material-icons">search</span>
              <input type="text" id="assetsSearchInput" placeholder="Search assets..." oninput="COMMS.filterAssets()">
            </div>
          </div>
          <button class="btn btn-primary" onclick="COMMS.toggleUploadDropzone()">
            <span class="material-icons">upload</span>
            Upload
          </button>
        </div>

        <!-- Upload Dropzone (hidden by default) -->
        <div class="upload-dropzone-container" id="uploadDropzoneContainer" style="display: none;">
          <div class="upload-dropzone" id="uploadDropzone"
               ondragover="COMMS.handleUploadDragOver(event)"
               ondragleave="COMMS.handleUploadDragLeave(event)"
               ondrop="COMMS.handleUploadDrop(event)">
            <span class="material-icons">cloud_upload</span>
            <p>Drag & drop files here</p>
            <span class="dropzone-or">or</span>
            <label class="btn btn-secondary">
              <span class="material-icons">folder_open</span>
              Browse Files
              <input type="file" id="assetFileInput" multiple accept="image/*,.pdf,.pptx,.ppt,.docx,.doc,.mp4,.mov" onchange="COMMS.handleFileSelect(event)" style="display: none;">
            </label>
            <p class="dropzone-hint">Images, PDFs, Presentations, Documents, Videos</p>
          </div>
          <button class="btn btn-sm btn-secondary dropzone-close" onclick="COMMS.toggleUploadDropzone()">
            <span class="material-icons">close</span>
            Cancel
          </button>
        </div>

        <!-- Upload Progress (shown during upload) -->
        <div class="upload-progress-container" id="uploadProgressContainer" style="display: none;">
          <div class="upload-progress-item" id="uploadProgressItem">
            <span class="material-icons">insert_drive_file</span>
            <div class="upload-progress-info">
              <span class="upload-filename" id="uploadFilename">filename.jpg</span>
              <div class="upload-progress-bar">
                <div class="upload-progress-fill" id="uploadProgressFill"></div>
              </div>
            </div>
            <span class="upload-status" id="uploadStatus">Uploading...</span>
          </div>
        </div>

        <!-- Upload Metadata Form (shown after upload) -->
        <div class="upload-metadata-form" id="uploadMetadataForm" style="display: none;">
          <div class="metadata-form-header">
            <h4>Add Details</h4>
            <button class="btn btn-icon" onclick="COMMS.cancelUploadMetadata()">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="metadata-form-content">
            <div class="form-row">
              <label>Title *</label>
              <input type="text" id="uploadAssetTitle" placeholder="Asset title">
            </div>
            <div class="form-row">
              <label>Solution</label>
              <select id="uploadAssetSolution">
                <option value="">Select solution...</option>
              </select>
            </div>
            <div class="form-row">
              <label>Description</label>
              <textarea id="uploadAssetDescription" rows="2" placeholder="Brief description..."></textarea>
            </div>
            <div class="form-row">
              <label>Usage Rights</label>
              <select id="uploadAssetRights">
                <option value="internal-only">Internal Only</option>
                <option value="nasa-media">NASA Media</option>
                <option value="public-domain">Public Domain</option>
                <option value="attribution-required">Attribution Required</option>
              </select>
            </div>
            <div class="form-row">
              <label>Tags</label>
              <input type="text" id="uploadAssetTags" placeholder="comma, separated, tags">
            </div>
          </div>
          <div class="metadata-form-actions">
            <button class="btn btn-secondary" onclick="COMMS.cancelUploadMetadata()">Cancel</button>
            <button class="btn btn-primary" onclick="COMMS.saveUploadedAsset()">
              <span class="material-icons">save</span>
              Save Asset
            </button>
          </div>
        </div>

        <!-- Assets Grid -->
        <div class="assets-grid" id="assetsGrid">
          <div class="loading-state">
            <span class="loading-spinner"></span>
            <p>Loading assets...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Asset Detail Modal -->
    <div class="modal-overlay" id="assetDetailModal" style="display: none;">
      <div class="modal-content asset-detail-modal">
        <div class="modal-header">
          <h2 id="assetDetailTitle">Asset Preview</h2>
          <button class="modal-close" onclick="COMMS.closeAssetDetailModal()" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body asset-detail-body">
          <div class="asset-preview-container" id="assetPreviewContainer">
            <!-- Preview iframe or image will be inserted here -->
          </div>
          <div class="asset-detail-info" id="assetDetailInfo">
            <!-- Asset metadata will be inserted here -->
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="COMMS.copyAssetLink(document.getElementById('assetDetailModal').dataset.assetId)">
            <span class="material-icons">link</span> Copy Link
          </button>
          <button class="btn btn-secondary" onclick="window.open(document.getElementById('assetDetailModal').dataset.assetUrl, '_blank')">
            <span class="material-icons">open_in_new</span> Open in Drive
          </button>
          <button class="btn btn-primary" onclick="COMMS.closeAssetDetailModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- Manage Subtabs Bar (shown when in Manage mode, before legacy views) -->
    <div class="manage-subtabs-bar" id="manageSubtabsBar" style="display: none;">
      <button class="manage-subtab active" data-subtab="pipeline" onclick="COMMS.setManageSubtab('pipeline')">
        <span class="material-icons">view_column</span>
        Pipeline
      </button>
      <button class="manage-subtab" data-subtab="coverage" onclick="COMMS.setManageSubtab('coverage')">
        <span class="material-icons">pie_chart</span>
        Coverage
      </button>
      <button class="manage-subtab" data-subtab="calendar" onclick="COMMS.setManageSubtab('calendar')">
        <span class="material-icons">calendar_today</span>
        Calendar
      </button>
      <button class="manage-subtab" data-subtab="priorities" onclick="COMMS.setManageSubtab('priorities')">
        <span class="material-icons">flag</span>
        Priorities
      </button>
      <div class="manage-subtab-spacer"></div>
      <button class="btn btn-primary" onclick="COMMS.showCreateStoryModal()">
        <span class="material-icons">add</span>
        New Story
      </button>
    </div>

    <!-- Pipeline View (now inside Manage) -->
    <div class="view-panel" id="pipelineView">
      <div class="pipeline-layout">
        <!-- Collapsible Sidebar: Opportunities + Coverage Gaps -->
        <div class="insights-sidebar" id="insightsSidebar">
          <div class="sidebar-toggle" onclick="COMMS.toggleSidebar()">
            <span class="material-icons" id="sidebarToggleIcon">chevron_left</span>
          </div>
          <div class="sidebar-content">
            <!-- Story Opportunities -->
            <div class="sidebar-section">
              <div class="sidebar-section-header">
                <h4>Story Opportunities</h4>
              </div>
              <div class="sidebar-section-content" id="opportunitiesPanel">
                <div class="loading-state">
                  <span class="loading-spinner"></span>
                </div>
              </div>
            </div>

            <!-- Coverage Gaps -->
            <div class="sidebar-section">
              <div class="sidebar-section-header">
                <h4>Coverage Gaps</h4>
                <button class="btn btn-sm btn-icon" onclick="COMMS.setView('manage'); COMMS.setManageSubtab('coverage')" title="Full View">
                  <span class="material-icons">fullscreen</span>
                </button>
              </div>
              <div class="sidebar-section-content" id="coverageGapsPanel">
                <div class="loading-state">
                  <span class="loading-spinner"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Pipeline Area -->
        <div class="pipeline-main">
      <!-- Story Pipeline -->
      <div class="pipeline-section">
        <!-- Collapsible Search/Filter Bar -->
        <div class="pipeline-search-bar" id="pipelineSearchBar">
          <button class="search-toggle-btn" onclick="COMMS.toggleSearchBar()" title="Search & Filter">
            <span class="material-icons">search</span>
          </button>
          <div class="search-bar-content" id="searchBarContent">
            <div class="search-input-wrapper">
              <input type="text" id="searchInput" placeholder="Search stories..." oninput="COMMS.filterStories()">
            </div>
            <select id="filterType" onchange="COMMS.filterStories()">
              <option value="">All Types</option>
              <option value="press_release">Press Release</option>
              <option value="web_content">Web Content</option>
              <option value="social_media">Social Media</option>
              <option value="nugget">Nugget</option>
              <option value="external_mention">External Mention</option>
              <option value="key_date">Key Date</option>
            </select>
            <select id="filterChannel" onchange="COMMS.filterStories()">
              <option value="">All Channels</option>
              <option value="nasa_gov">nasa.gov</option>
              <option value="social">Social</option>
              <option value="internal">Internal</option>
              <option value="media">Media</option>
            </select>
            <button class="btn btn-sm btn-secondary" onclick="COMMS.clearFilters()" title="Clear filters">
              <span class="material-icons">clear</span>
            </button>
          </div>
        </div>

        <div class="pipeline-board" id="pipelineBoard">
          <!-- Idea Column -->
          <div class="pipeline-column" data-status="idea" ondragover="COMMS.handleDragOver(event)" ondrop="COMMS.handleDrop(event, 'idea')" ondragleave="COMMS.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title">Idea</span>
              <span class="column-count" id="countIdea">0</span>
            </div>
            <div class="column-cards" id="cardsIdea"></div>
          </div>
          <!-- Researching Column -->
          <div class="pipeline-column" data-status="researching" ondragover="COMMS.handleDragOver(event)" ondrop="COMMS.handleDrop(event, 'researching')" ondragleave="COMMS.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title">Researching</span>
              <span class="column-count" id="countResearching">0</span>
            </div>
            <div class="column-cards" id="cardsResearching"></div>
          </div>
          <!-- Drafting Column -->
          <div class="pipeline-column" data-status="drafting" ondragover="COMMS.handleDragOver(event)" ondrop="COMMS.handleDrop(event, 'drafting')" ondragleave="COMMS.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title">Drafting</span>
              <span class="column-count" id="countDrafting">0</span>
            </div>
            <div class="column-cards" id="cardsDrafting"></div>
          </div>
          <!-- Review Column -->
          <div class="pipeline-column" data-status="review" ondragover="COMMS.handleDragOver(event)" ondrop="COMMS.handleDrop(event, 'review')" ondragleave="COMMS.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title">Review</span>
              <span class="column-count" id="countReview">0</span>
            </div>
            <div class="column-cards" id="cardsReview"></div>
          </div>
        </div>
      </div><!-- /.pipeline-section -->
        </div><!-- /.pipeline-main -->

        <!-- Collapsible Published Panel -->
        <div class="published-sidebar" id="publishedSidebar">
          <div class="sidebar-toggle" onclick="COMMS.togglePublishedPanel()">
            <span class="material-icons" id="publishedToggleIcon">chevron_right</span>
          </div>
          <div class="sidebar-content">
            <div class="sidebar-section">
              <div class="sidebar-section-header">
                <h4>Published</h4>
                <span class="column-count" id="countPublished">0</span>
              </div>
              <div class="sidebar-section-content published-cards" id="cardsPublished"
                   ondragover="COMMS.handleDragOver(event)"
                   ondrop="COMMS.handleDrop(event, 'published')"
                   ondragleave="COMMS.handleDragLeave(event)">
              </div>
            </div>
          </div>
        </div>
      </div><!-- /.pipeline-layout -->
    </div>

    <!-- Coverage View -->
    <div class="view-panel" id="coverageView">
      <div class="coverage-layout">
        <!-- Coverage Summary -->
        <div class="coverage-summary">
          <div class="summary-card">
            <div class="summary-icon covered"><span class="material-icons">check_circle</span></div>
            <div class="summary-info">
              <span class="summary-value" id="coverageWellCovered">--</span>
              <span class="summary-label">Well Covered</span>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon attention"><span class="material-icons">error</span></div>
            <div class="summary-info">
              <span class="summary-value" id="coverageNeedsAttention">--</span>
              <span class="summary-label">Needs Attention</span>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon uncovered"><span class="material-icons">cancel</span></div>
            <div class="summary-info">
              <span class="summary-value" id="coverageNoStories">--</span>
              <span class="summary-label">No Stories</span>
            </div>
          </div>
        </div>

        <!-- Coverage Table -->
        <div class="coverage-table-container">
          <table class="coverage-table" id="coverageTable">
            <thead>
              <tr>
                <th>Solution</th>
                <th>Phase</th>
                <th>Total Stories</th>
                <th>Recent (90d)</th>
                <th>Last Story</th>
                <th>Days Since</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="coverageTableBody">
              <tr>
                <td colspan="8" class="loading-state">
                  <span class="loading-spinner"></span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Calendar View -->
    <div class="view-panel" id="calendarView">
      <div class="calendar-layout">
        <div class="calendar-header">
          <button class="btn btn-sm btn-secondary" onclick="COMMS.navigateCalendar(-1)">
            <span class="material-icons">chevron_left</span>
          </button>
          <h3 id="calendarTitle">January 2026</h3>
          <button class="btn btn-sm btn-secondary" onclick="COMMS.navigateCalendar(1)">
            <span class="material-icons">chevron_right</span>
          </button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar will be rendered here -->
        </div>
        <div class="calendar-sidebar">
          <div class="upcoming-targets">
            <h4>Upcoming Targets</h4>
            <div id="upcomingTargetsList">
              <div class="loading-state">
                <span class="loading-spinner"></span>
              </div>
            </div>
          </div>
          <div class="comms-due-section">
            <h4><span class="material-icons" style="font-size: 18px; vertical-align: text-bottom;">notification_important</span> Communications Due</h4>
            <div id="commsDueList">
              <div class="loading-state">
                <span class="loading-spinner"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Messaging View (Priorities + Key Messages) -->
    <div class="view-panel" id="messagingView">
      <div class="messaging-layout">
        <!-- Priority Coverage Bar (Compact) -->
        <div class="priority-bar">
          <div class="priority-bar-label">
            <span class="material-icons">flag</span>
            <span>Priority Alignment</span>
          </div>
          <div class="priority-chips" id="priorityChips">
            <button class="priority-chip" data-priority="partnerships" onclick="COMMS.togglePriorityDetail('partnerships')">
              <span class="material-icons">group</span>
              <span class="chip-label">Partnerships</span>
              <span class="chip-count" id="priorityCountPartnerships">0</span>
            </button>
            <button class="priority-chip" data-priority="citizens" onclick="COMMS.togglePriorityDetail('citizens')">
              <span class="material-icons">home</span>
              <span class="chip-label">Citizens</span>
              <span class="chip-count" id="priorityCountCitizens">0</span>
            </button>
            <button class="priority-chip" data-priority="ai_innovation" onclick="COMMS.togglePriorityDetail('ai_innovation')">
              <span class="material-icons">memory</span>
              <span class="chip-label">AI/Innovation</span>
              <span class="chip-count" id="priorityCountAiInnovation">0</span>
            </button>
            <button class="priority-chip" data-priority="science_integrity" onclick="COMMS.togglePriorityDetail('science_integrity')">
              <span class="material-icons">emoji_events</span>
              <span class="chip-label">Science</span>
              <span class="chip-count" id="priorityCountScienceIntegrity">0</span>
            </button>
            <button class="priority-chip" data-priority="efficiency" onclick="COMMS.togglePriorityDetail('efficiency')">
              <span class="material-icons">flash_on</span>
              <span class="chip-label">Efficiency</span>
              <span class="chip-count" id="priorityCountEfficiency">0</span>
            </button>
            <button class="priority-chip priority-chip-warning" data-priority="untagged" onclick="COMMS.togglePriorityDetail('untagged')">
              <span class="material-icons">error</span>
              <span class="chip-label">Untagged</span>
              <span class="chip-count" id="priorityCountUntagged">0</span>
            </button>
          </div>
        </div>

        <!-- Priority Detail Panel (shown when chip clicked) -->
        <div class="priority-detail-panel" id="priorityDetailPanel" style="display: none;">
          <div class="priority-detail-header">
            <span class="material-icons" id="priorityDetailIcon">flag</span>
            <h3 id="priorityDetailTitle">Priority Stories</h3>
            <button class="btn btn-icon" onclick="COMMS.closePriorityDetail()" aria-label="Close">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="priority-detail-content" id="priorityDetailContent">
            <!-- Stories will be rendered here -->
          </div>
        </div>

        <!-- Reporting Section (Highlighter Blurbs for HQ) -->
        <div class="reporting-section">
          <div class="reporting-header">
            <div class="reporting-title">
              <span class="material-icons">description</span>
              <div>
                <h3>HQ Reporting</h3>
                <p>Highlighter blurbs for weekly HQ updates</p>
              </div>
            </div>
            <div class="reporting-deadline" id="blurbDeadline">
              <span class="material-icons">schedule</span>
              <span>Next deadline: <strong id="nextDeadlineDate">Tuesday</strong></span>
            </div>
            <div class="blurb-view-toggle">
              <button class="view-btn" id="blurbViewCards" onclick="COMMS.setBlurbView('cards')" title="Card view">
                <span class="material-icons">view_agenda</span>
              </button>
              <button class="view-btn active" id="blurbViewTable" onclick="COMMS.setBlurbView('table')" title="Table view">
                <span class="material-icons">table_rows</span>
              </button>
            </div>
            <div class="blurb-search-wrapper">
              <span class="material-icons">search</span>
              <input type="text" id="blurbSearchInput" placeholder="Search blurbs..." oninput="COMMS.filterBlurbs()">
            </div>
            <select id="blurbStatusFilter" onchange="COMMS.filterBlurbs()" class="blurb-filter-select">
              <option value="">All Status</option>
              <option value="idea">Idea</option>
              <option value="drafting">Drafting</option>
              <option value="review">Review</option>
              <option value="published">Submitted</option>
            </select>
            <button class="btn btn-secondary btn-sm" onclick="COMMS.showNewBlurbModal()">
              <span class="material-icons">add</span>
              New Blurb
            </button>
          </div>
          <div class="reporting-content" id="blurbsContainer">
            <div class="loading-state" style="display: flex;">
              <span class="loading-spinner"></span>
              <span>Loading blurbs...</span>
            </div>
          </div>
        </div>

        <!-- Key Messages Section (Main Content) -->
        <div class="messages-section">
          <div class="messages-header">
            <div class="messages-title">
              <span class="material-icons">chat</span>
              <div>
                <h2>Solution Key Messages</h2>
                <p>Approved talking points for communications and outreach</p>
              </div>
            </div>
            <div class="messages-search">
              <span class="material-icons">search</span>
              <input type="text" id="messagesSearchInput" placeholder="Search solutions or messages..." oninput="COMMS.searchMessages()">
            </div>
          </div>

          <!-- Messages Summary -->
          <div class="messages-summary" id="messagesSummary">
            <div class="summary-stat">
              <span class="summary-value" id="msgTotalSolutions">--</span>
              <span class="summary-label">With Messages</span>
            </div>
            <div class="summary-stat">
              <span class="summary-value" id="msgCoverage">--</span>
              <span class="summary-label">Coverage</span>
            </div>
            <div class="summary-stat">
              <span class="summary-value" id="msgByFocus">--</span>
              <span class="summary-label">Focus Types</span>
            </div>
          </div>

          <!-- Messages Grid -->
          <div class="messages-grid" id="messagesGrid">
            <div class="loading-state">
              <span class="loading-spinner"></span>
              <span>Loading key messages...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tools View -->
    <div class="view-panel" id="toolsView">
      <div class="tools-layout">
        <div class="tools-header">
          <h2>Comms Tools</h2>
          <p class="tools-subtitle">Resources and generators for the team</p>
        </div>

        <!-- Tools Grid -->
        <div class="tools-grid">
          <!-- Presentation Builder Tool -->
          <div class="tool-card">
            <div class="tool-card-icon">
              <span class="material-icons">slideshow</span>
            </div>
            <div class="tool-card-content">
              <h3>Presentation Builder</h3>
              <p>Generate customized Google Slides presentations for any solution. Select audience type to automatically filter slides and replace placeholders with solution data.</p>
              <div class="tool-card-meta">
                <span class="tool-tag">Google Slides</span>
                <span class="tool-tag">Automated</span>
              </div>
            </div>
            <div class="tool-card-actions">
              <button class="btn btn-primary" onclick="COMMS.showPresentationBuilder()">
                <span class="material-icons">play_arrow</span>
                Launch Tool
              </button>
            </div>
          </div>

          <!-- Placeholder for future tools -->
          <div class="tool-card tool-card-placeholder">
            <div class="tool-card-icon">
              <span class="material-icons">add_circle_outline</span>
            </div>
            <div class="tool-card-content">
              <h3>More Tools Coming</h3>
              <p>Additional Comms tools will be added here. Ideas? Talk to the team!</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Manage View (NEW - consolidates Pipeline, Coverage, Calendar, Priorities) -->
    <div class="view-panel" id="manageView">
      <div class="manage-layout">
        <!-- Manage Sub-tabs -->
        <div class="manage-subtabs">
          <button class="manage-subtab active" data-subtab="pipeline" onclick="COMMS.setManageSubtab('pipeline')">
            <span class="material-icons">view_column</span>
            Pipeline
          </button>
          <button class="manage-subtab" data-subtab="coverage" onclick="COMMS.setManageSubtab('coverage')">
            <span class="material-icons">pie_chart</span>
            Coverage
          </button>
          <button class="manage-subtab" data-subtab="calendar" onclick="COMMS.setManageSubtab('calendar')">
            <span class="material-icons">calendar_today</span>
            Calendar
          </button>
          <button class="manage-subtab" data-subtab="priorities" onclick="COMMS.setManageSubtab('priorities')">
            <span class="material-icons">flag</span>
            Priorities
          </button>
          <div class="manage-subtab-spacer"></div>
          <button class="btn btn-primary" onclick="COMMS.showCreateStoryModal()">
            <span class="material-icons">add</span>
            New Story
          </button>
        </div>

        <!-- Manage Content Panels (content is pulled from existing views via JS) -->
        <div class="manage-content-area" id="manageContentArea">
          <!-- The sub-tab content will be shown by toggling visibility of the existing view panels -->
          <!-- Pipeline, Coverage, Calendar are shown/hidden by setManageSubtab() -->

          <!-- Priorities Panel (extracted from Messaging view) -->
          <div class="manage-panel" id="managePrioritiesPanel" style="display: none;">
            <div class="priorities-content">
              <!-- Priority Bar -->
              <div class="priority-bar" id="managePriorityBar">
                <div class="priority-chips" id="managePriorityChips">
                  <div class="loading-state">
                    <span class="loading-spinner"></span>
                  </div>
                </div>
              </div>

              <!-- Priority Detail -->
              <div class="priority-detail-panel" id="managePriorityDetail">
                <div class="empty-state">
                  <span class="material-icons">flag</span>
                  <p>Select a priority to view related solutions</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Events View -->
    <div class="view-panel" id="eventsView">
      <div class="events-layout">
        <!-- Events Header -->
        <div class="events-header">
          <div class="events-stats">
            <div class="event-stat">
              <span class="event-stat-value" id="eventStatUpcoming">--</span>
              <span class="event-stat-label">Upcoming</span>
            </div>
            <div class="event-stat">
              <span class="event-stat-value" id="eventStatConfirmed">--</span>
              <span class="event-stat-label">Confirmed</span>
            </div>
            <div class="event-stat">
              <span class="event-stat-value" id="eventStatPotential">--</span>
              <span class="event-stat-label">Potential</span>
            </div>
            <div class="event-stat">
              <span class="event-stat-value" id="eventStatDeadlines">--</span>
              <span class="event-stat-label">Deadlines (30d)</span>
            </div>
          </div>
          <div class="events-actions">
            <select id="eventYearFilter" onchange="COMMS.filterEvents()">
              <option value="" selected>All Years</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
              <option value="2027">2027</option>
            </select>
            <select id="eventStatusFilter" onchange="COMMS.filterEvents()">
              <option value="">All Status</option>
              <option value="potential">Potential</option>
              <option value="considering">Considering</option>
              <option value="confirmed">Confirmed</option>
              <option value="attended">Attended</option>
            </select>
            <button class="btn btn-primary" onclick="COMMS.showAddEventModal()">
              <span class="material-icons">add</span>
              Add Event
            </button>
          </div>
        </div>

        <!-- Events Grid -->
        <div class="events-content">
          <!-- Upcoming Events -->
          <div class="events-panel">
            <div class="panel-header">
              <h3>Upcoming Events</h3>
            </div>
            <div class="panel-content" id="upcomingEventsPanel">
              <div class="loading-state">
                <span class="loading-spinner"></span>
              </div>
            </div>
          </div>

          <!-- Event Opportunities (Potential) -->
          <div class="events-panel">
            <div class="panel-header">
              <h3>Event Opportunities</h3>
              <span class="badge" id="potentialBadge">0</span>
            </div>
            <div class="panel-content" id="potentialEventsPanel">
              <div class="loading-state">
                <span class="loading-spinner"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Events Table -->
        <div class="events-table-container">
          <table class="events-table" id="eventsTable">
            <thead>
              <tr>
                <th>Event</th>
                <th>Type</th>
                <th>Date</th>
                <th>Location</th>
                <th>Status</th>
                <th>Team</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="eventsTableBody">
              <tr>
                <td colspan="7" class="loading-state">
                  <span class="loading-spinner"></span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Story Detail Modal -->
<div class="modal-overlay" id="storyModal" onclick="COMMS.closeModal('storyModal', event)">
  <div class="modal-content modal-lg" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="modalStoryTitle">Story Details</h2>
      <button class="modal-close" onclick="COMMS.closeModal('storyModal')" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body" id="storyModalBody">
      <!-- Dynamic content -->
    </div>
  </div>
</div>

<!-- Create/Edit Story Modal -->
<div class="modal-overlay" id="editStoryModal" onclick="COMMS.closeModal('editStoryModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="editStoryModalTitle">New Story</h2>
      <button class="modal-close" onclick="COMMS.closeModal('editStoryModal')" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body">
      <form id="storyForm" onsubmit="COMMS.submitStory(event)">
        <input type="hidden" id="editStoryId">
        <div class="form-row">
          <div class="form-group form-group-wide">
            <label>Title *</label>
            <input type="text" id="storyTitle" required placeholder="Story title">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Content Type</label>
            <select id="storyContentType" onchange="COMMS.toggleBlurbFields()">
              <option value="story">Impact Story</option>
              <option value="web_content">Web Content</option>
              <option value="social_media">Social Media</option>
              <option value="external_mention">External Mention</option>
              <option value="nugget">Nugget Slide</option>
              <option value="key_date">Key Date</option>
              <option value="highlighter_blurb">Highlighter Blurb</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="storyStatus">
              <option value="idea">Idea</option>
              <option value="researching">Researching</option>
              <option value="drafting">Drafting</option>
              <option value="review">Review</option>
              <option value="published">Published</option>
            </select>
          </div>
          <div class="form-group">
            <label>Priority</label>
            <select id="storyPriority">
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="low">Low</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Channel</label>
            <select id="storyChannel">
              <option value="web">Web</option>
              <option value="social">Social</option>
              <option value="slide">Slide</option>
              <option value="external">External</option>
              <option value="newsletter">Newsletter</option>
            </select>
          </div>
          <div class="form-group">
            <label>Primary Outlet</label>
            <input type="text" id="storyOutlet" placeholder="Target publication">
          </div>
          <div class="form-group">
            <label>Author</label>
            <input type="text" id="storyAuthor" placeholder="Story author">
          </div>
        </div>
        <div class="form-group">
          <label>Solution</label>
          <select id="storySolution" required>
            <option value="">-- Select Solution --</option>
            <option value="3d-topo">3D Topographic Mapping</option>
            <option value="admg">ADMG</option>
            <option value="aq">Air Quality</option>
            <option value="aq_gmao">Air Quality - GMAO</option>
            <option value="aq_pandora">Pandora</option>
            <option value="aq_pandora-ongoing">Pandora Ongoing</option>
            <option value="aq_pm">Air Quality - PM</option>
            <option value="csda">CSDA</option>
            <option value="dcd">DCD</option>
            <option value="firms-2g">FIRMS-2G</option>
            <option value="gaban">GABAN</option>
            <option value="gacr">GACR</option>
            <option value="gcc">GCC</option>
            <option value="global-et">Evapotranspiration (ET)</option>
            <option value="grace-fo">GRACE-FO</option>
            <option value="harm-tir">Harmonized TIR</option>
            <option value="hls">HLS</option>
            <option value="hls_10m">HLS 10-m</option>
            <option value="hls_et">HLS ET</option>
            <option value="hls_ll">HLS Low Latency</option>
            <option value="hls_lst">HLS Land Surface Temperature</option>
            <option value="hls_vi">HLS Vegetation Indices</option>
            <option value="icesat">ICESat-2 Lake Ice/Freeboard</option>
            <option value="ioa">Internet of Animals</option>
            <option value="mo">MO General</option>
            <option value="mo_assess">MO Assessment</option>
            <option value="mo_comms">MO Comms</option>
            <option value="mo_impl">MO Implementation</option>
            <option value="mo_sep">MO SEP</option>
            <option value="mwow">MWOW</option>
            <option value="nga">NGA</option>
            <option value="nisar_dl">NISAR Downlink</option>
            <option value="nisar_hi_res">NISAR High Resolution</option>
            <option value="nisar_sm">NISAR Soil Moisture</option>
            <option value="opera">OPERA</option>
            <option value="opera_disp">OPERA DISP</option>
            <option value="opera_dist">OPERA DIST</option>
            <option value="opera_dswx">OPERA DSWx</option>
            <option value="pbl">PBL</option>
            <option value="pbl_height">PBL Height</option>
            <option value="sss">Sea Surface Salinity</option>
            <option value="targeted_rs">Remote Sensing Training</option>
            <option value="tempo_enhanced">TEMPO Enhanced</option>
            <option value="tempo_nrt">TEMPO NRT</option>
            <option value="vlm">VLM</option>
            <option value="volcano">Volcano Monitoring</option>
            <option value="water-quality">Water Quality</option>
          </select>
        </div>
        <div class="form-group">
          <label>Admin Priorities (check all that apply)</label>
          <div class="checkbox-group" id="storyAdminPriorities">
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="partnerships">
              <span>Partnerships & Decision Support</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="citizens">
              <span>Benefits to American Citizens</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="ai_innovation">
              <span>AI Leadership & Tech Innovation</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="science_integrity">
              <span>Gold Standard Science & Research Integrity</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="efficiency">
              <span>Government Efficiency</span>
            </label>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Target Date</label>
            <input type="date" id="storyTargetDate">
          </div>
          <div class="form-group">
            <label>Publish Date</label>
            <input type="date" id="storyPublishDate">
          </div>
        </div>
        <div class="form-group">
          <label>Source / Origin</label>
          <input type="text" id="storySource" placeholder="Where did this idea come from?">
        </div>
        <div class="form-group">
          <label>Pitch/Draft Document URL</label>
          <input type="url" id="storyPitchUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Published Link</label>
          <input type="url" id="storyPublishedLink" placeholder="https://...">
        </div>
        <!-- Highlighter Blurb specific fields -->
        <div id="blurbFields" style="display: none;">
          <div class="form-group">
            <label>Background Information</label>
            <textarea id="storyBackgroundInfo" rows="3" maxlength="1500" placeholder="Background context on technical details, team, products, missions. Include SNWG boilerplate if needed."></textarea>
          </div>
          <div class="form-group">
            <label>Blurb Content *</label>
            <textarea id="storyBlurbContent" rows="8" maxlength="4000" placeholder="Full formatted blurb text (Title + Accomplishment Description + Background) as submitted to HQ."></textarea>
            <small style="color: var(--color-text-secondary);">This is the complete text submitted to the Highlighter portal.</small>
          </div>
          <div class="form-group">
            <label>HQ Submission Date</label>
            <input type="date" id="storyHqSubmissionDate">
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <div id="storyNotes" class="rich-text-field" contenteditable="true" data-placeholder="Additional notes..."></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="COMMS.closeModal('editStoryModal')">Cancel</button>
          <button type="submit" id="saveStoryBtn" class="btn btn-primary">Save Story</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Event Modal -->
<div class="modal-overlay" id="addEventModal" onclick="COMMS.closeModal('addEventModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Add New Event</h2>
      <button class="modal-close" onclick="COMMS.closeModal('addEventModal')" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addEventForm" onsubmit="COMMS.submitNewEvent(event)">
        <div class="form-group">
          <label>Event Name *</label>
          <input type="text" id="newEventName" required placeholder="e.g., AGU Fall Meeting 2026">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Event Type</label>
            <select id="newEventType">
              <option value="conference">Conference</option>
              <option value="workshop">Workshop</option>
              <option value="webinar">Webinar</option>
              <option value="meeting">Meeting</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="newEventStatus">
              <option value="potential">Potential</option>
              <option value="researching">Researching</option>
              <option value="confirmed">Confirmed</option>
              <option value="declined">Declined</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="newEventStartDate">
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="date" id="newEventEndDate">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Sector</label>
            <select id="newEventSector">
              <option value="">-- Select Sector --</option>
              <option value="Agriculture">Agriculture</option>
              <option value="Water Resources">Water Resources</option>
              <option value="Disasters">Disasters</option>
              <option value="Ecological Conservation">Ecological Conservation</option>
              <option value="Climate">Climate</option>
              <option value="Wildland Fires">Wildland Fires</option>
              <option value="Land Use">Land Use</option>
              <option value="Energy">Energy</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Event URL</label>
          <input type="url" id="newEventUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <div id="newEventNotes" class="rich-text-field" contenteditable="true" data-placeholder="Any additional details..."></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="COMMS.closeModal('addEventModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Event</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Event Detail Modal (Tabbed) -->
<div class="modal-overlay" id="eventModal" onclick="COMMS.closeModal('eventModal', event)">
  <div class="modal-content modal-lg" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="modalEventName">Event Details</h2>
      <button class="modal-close" onclick="COMMS.closeModal('eventModal')" aria-label="Close dialog">&times;</button>
    </div>
    <!-- Modal Tabs -->
    <div class="modal-tabs">
      <button class="modal-tab active" data-tab="details" onclick="COMMS.switchEventTab('details')">
        <span class="material-icons">info</span> Details
      </button>
      <button class="modal-tab" data-tab="guests" onclick="COMMS.switchEventTab('guests')">
        <span class="material-icons">people</span> Guest List
        <span class="tab-badge" id="guestCountBadge">0</span>
      </button>
      <button class="modal-tab" data-tab="prep" onclick="COMMS.switchEventTab('prep')">
        <span class="material-icons">assignment</span> Prep Report
      </button>
    </div>
    <div class="modal-body">
      <!-- Details Tab -->
      <div class="tab-panel active" id="eventDetailsTab">
        <div id="eventModalBody">
          <!-- Dynamic content -->
        </div>
      </div>
      <!-- Guest List Tab -->
      <div class="tab-panel" id="eventGuestsTab">
        <div class="guest-list-container">
          <!-- Search contacts to add -->
          <div class="guest-search-section">
            <h4>Add Guests</h4>
            <div class="guest-search-input">
              <span class="material-icons">search</span>
              <input type="text" id="guestSearchInput" placeholder="Search contacts by name or email..." oninput="COMMS.searchContactsForGuest()">
            </div>
            <div class="guest-search-results" id="guestSearchResults">
              <div class="empty-state-sm">Search to find contacts</div>
            </div>
          </div>
          <!-- Current guest list -->
          <div class="guest-list-section">
            <h4>Expected Guests</h4>
            <div class="guest-list" id="currentGuestList">
              <div class="empty-state-sm">No guests added yet</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Prep Report Tab -->
      <div class="tab-panel" id="eventPrepTab">
        <div class="prep-report-container" id="prepReportContent">
          <div class="prep-actions">
            <button class="btn btn-primary" onclick="COMMS.generatePrepReport()">
              <span class="material-icons">description</span>
              Generate Prep Report
            </button>
            <button class="btn btn-secondary" id="exportPrepBtn" onclick="COMMS.exportPrepToDoc()" style="display:none;">
              <span class="material-icons">open_in_new</span>
              Export to Doc
            </button>
          </div>
          <div id="prepReportBody">
            <div class="empty-state">
              <span class="material-icons">assignment</span>
              <p>Click "Generate Prep Report" to create a preparation report for this event</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Contact from Event Modal -->
<div class="modal-overlay" id="newContactFromEventModal" onclick="COMMS.closeModal('newContactFromEventModal', event)">
  <div class="modal-content modal-md" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Add New Contact</h2>
      <button class="modal-close" onclick="COMMS.closeModal('newContactFromEventModal')" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body">
      <form id="newContactFromEventForm" onsubmit="COMMS.submitNewContactFromEvent(event)">
        <div class="form-row">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" id="newContactFirstName" required>
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" id="newContactLastName" required>
          </div>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="newContactEmail" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Agency/Organization</label>
            <input type="text" id="newContactAgency">
          </div>
          <div class="form-group">
            <label>Title</label>
            <input type="text" id="newContactTitle">
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="newContactNotes" rows="2" placeholder="How did you meet? Any follow-up needed?"></textarea>
        </div>
        <div class="form-group">
          <label class="checkbox-item">
            <input type="checkbox" id="addToGuestList" checked>
            <span>Add to this event's guest list</span>
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="COMMS.closeModal('newContactFromEventModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Contact</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Presentation Builder Modal -->
<div class="modal-overlay" id="presentationBuilderModal" onclick="COMMS.closeModal('presentationBuilderModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Presentation Builder</h2>
      <button class="modal-close" onclick="COMMS.closeModal('presentationBuilderModal')" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Initial Form -->
      <div id="presentationForm">
        <div class="form-group">
          <label>Solution *</label>
          <select id="presentationSolution" required>
            <option value="">-- Loading Solutions --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Audience Type *</label>
          <div class="radio-group">
            <label class="radio-item">
              <input type="radio" name="presentationAudience" value="internal" checked>
              <span>Internal</span>
              <small>NASA/agency stakeholders, includes SEP, onboarding, and assessment details</small>
            </label>
            <label class="radio-item">
              <input type="radio" name="presentationAudience" value="external">
              <span>External</span>
              <small>Public and partners, focuses on impact and engagement</small>
            </label>
          </div>
        </div>
        <div class="form-info" style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); background: var(--color-surface-alt); border-radius: var(--radius-sm); margin-bottom: var(--space-md);">
          <span class="material-icons" style="color: var(--color-text-muted);">info</span>
          <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">The presentation will be saved to your Google Drive</span>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="COMMS.closeModal('presentationBuilderModal')">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="COMMS.generatePresentation()" id="generatePresentationBtn">
            <span class="material-icons">slideshow</span>
            Generate Presentation
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div id="presentationLoading" class="loading-state" style="display: none;">
        <span class="loading-spinner"></span>
        <p>Generating presentation...</p>
      </div>

      <!-- Success State -->
      <div id="presentationSuccess" style="display: none; text-align: center; padding: var(--space-xl);">
        <span class="material-icons" style="font-size: 64px; color: var(--color-success);">check_circle</span>
        <h3 style="margin: var(--space-md) 0;">Presentation Created!</h3>
        <p id="presentationSuccessName" style="color: var(--color-text-secondary);"></p>
        <p id="presentationModeNote" style="display: none; color: var(--color-warning); font-size: var(--font-sm); margin-top: var(--space-sm);"></p>
        <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-md); justify-content: center;">
          <a id="presentationOpenLink" href="#" target="_blank" class="btn btn-primary">
            <span class="material-icons">open_in_new</span>
            Open Presentation
          </a>
          <button type="button" class="btn btn-secondary" onclick="COMMS.resetPresentationBuilder()">
            Generate Another
          </button>
        </div>
      </div>

      <!-- Error State -->
      <div id="presentationError" style="display: none; text-align: center; padding: var(--space-xl);">
        <span class="material-icons" style="font-size: 64px; color: var(--color-error);">error</span>
        <h3 style="margin: var(--space-md) 0;">Generation Failed</h3>
        <p id="presentationErrorMessage" style="color: var(--color-text-secondary);"></p>
        <div style="margin-top: var(--space-lg);">
          <button type="button" class="btn btn-secondary" onclick="COMMS.resetPresentationBuilder()">
            Try Again
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Comms Asset Modal -->
<div class="modal-overlay" id="addAssetModal" onclick="COMMS.closeModal('addAssetModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="addAssetModalTitle">Add Communications Asset</h2>
      <button class="modal-close" onclick="COMMS.closeModal('addAssetModal')" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addAssetForm" onsubmit="COMMS.submitAsset(event)">
        <input type="hidden" id="editAssetId">

        <!-- Quick Add Fields (always visible) -->
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label>Asset Type *</label>
            <select id="assetType" required onchange="COMMS.onAssetTypeChange()">
              <option value="">-- Select Type --</option>
              <option value="blurb">Blurb (HQ Update)</option>
              <option value="talking_point">Talking Point</option>
              <option value="quote">Quote</option>
              <option value="fact">Fact/Statistic</option>
              <option value="soundbite">Sound Bite</option>
              <option value="boilerplate">Boilerplate</option>
              <option value="connection">Connection</option>
            </select>
          </div>
          <div class="form-group" style="flex: 1;">
            <label>Status</label>
            <select id="assetStatus">
              <option value="approved" selected>Approved (Ready to Use)</option>
              <option value="draft">Draft</option>
              <option value="needs_update">Needs Update</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Title *</label>
          <input type="text" id="assetTitle" required placeholder="Brief descriptive title">
        </div>

        <div class="form-group">
          <label>Content *</label>
          <textarea id="assetContent" required rows="4" placeholder="The actual text content of the asset..."></textarea>
          <div class="form-hint" id="assetContentHint">2-3 sentences recommended for blurbs</div>
        </div>

        <!-- Affiliation Section -->
        <div class="form-section">
          <div class="form-section-header" onclick="COMMS.toggleAssetSection('affiliations')">
            <span class="material-icons section-toggle-icon" id="affiliationsToggleIcon">expand_more</span>
            <span>Affiliations</span>
            <span class="form-section-badge" id="affiliationsBadge">0</span>
          </div>
          <div class="form-section-content" id="affiliationsSection">
            <!-- Primary Solution -->
            <div class="form-group">
              <label>Primary Solution</label>
              <select id="assetPrimarySolution" onchange="COMMS.onPrimarySolutionChange()">
                <option value="">-- Select Solution --</option>
                <!-- Populated dynamically -->
              </select>
            </div>

            <!-- Additional Solutions -->
            <div class="form-group">
              <label>Additional Solutions <span style="color: var(--color-text-muted); font-weight: normal;">(optional)</span></label>
              <div class="asset-solution-tags" id="assetSolutionTags"></div>
              <select id="addAssetSolution" onchange="COMMS.addAssetSolution(this.value); this.value='';">
                <option value="">+ Add solution...</option>
                <!-- Populated dynamically -->
              </select>
            </div>

            <!-- Contacts Picker -->
            <div class="form-group">
              <label>Contacts <span style="color: var(--color-text-muted); font-weight: normal;">(optional)</span></label>
              <div class="asset-contact-picker" id="assetContactPicker">
                <div class="asset-selected-contacts" id="assetSelectedContacts"></div>
                <input type="text" id="assetContactSearchInput" class="asset-contact-search"
                       placeholder="Search contacts by name or email..."
                       autocomplete="off"
                       oninput="COMMS.searchAssetContacts(this.value)"
                       onfocus="COMMS.showAssetContactResults()"
                       onblur="COMMS.hideAssetContactResults()">
                <div class="asset-contact-results" id="assetContactResults"></div>
              </div>
              <button type="button" class="btn btn-sm btn-text" onclick="COMMS.showAddContactForAsset()" style="margin-top: 4px;">
                <span class="material-icons">person_add</span> Add New Contact
              </button>
            </div>

            <!-- Agency -->
            <div class="form-group">
              <label>Agency <span style="color: var(--color-text-muted); font-weight: normal;">(optional)</span></label>
              <select id="assetAgency">
                <option value="">-- Select Agency --</option>
                <!-- Populated dynamically -->
              </select>
            </div>
          </div>
        </div>

        <!-- Tags Section -->
        <div class="form-section">
          <div class="form-section-header" onclick="COMMS.toggleAssetSection('tags')">
            <span class="material-icons section-toggle-icon" id="tagsToggleIcon">expand_more</span>
            <span>Tags & Categories</span>
          </div>
          <div class="form-section-content" id="tagsSection">
            <div class="form-group">
              <label>Thematic Areas</label>
              <div class="tag-suggestions" id="tagSuggestions">
                <button type="button" class="tag-suggestion" data-tag="science" onclick="COMMS.toggleTag('science')">Science</button>
                <button type="button" class="tag-suggestion" data-tag="applications" onclick="COMMS.toggleTag('applications')">Applications</button>
                <button type="button" class="tag-suggestion" data-tag="partnerships" onclick="COMMS.toggleTag('partnerships')">Partnerships</button>
                <button type="button" class="tag-suggestion" data-tag="data-access" onclick="COMMS.toggleTag('data-access')">Data Access</button>
                <button type="button" class="tag-suggestion" data-tag="training" onclick="COMMS.toggleTag('training')">Training</button>
                <button type="button" class="tag-suggestion" data-tag="milestone" onclick="COMMS.toggleTag('milestone')">Milestone</button>
                <button type="button" class="tag-suggestion" data-tag="impact" onclick="COMMS.toggleTag('impact')">Impact</button>
                <button type="button" class="tag-suggestion" data-tag="user-story" onclick="COMMS.toggleTag('user-story')">User Story</button>
              </div>
            </div>
            <div class="form-group">
              <label>Custom Tags</label>
              <input type="text" id="customTags" placeholder="Add additional tags, comma-separated">
              <div class="form-hint">e.g., agriculture, flood-monitoring, quarterly-report</div>
            </div>
          </div>
        </div>

        <!-- More Options Section -->
        <div class="form-section">
          <div class="form-section-header" onclick="COMMS.toggleAssetSection('moreOptions')">
            <span class="material-icons section-toggle-icon" id="moreOptionsToggleIcon">chevron_right</span>
            <span>More Options</span>
          </div>
          <div class="form-section-content collapsed" id="moreOptionsSection">
            <!-- Source Info -->
            <div class="form-row">
              <div class="form-group">
                <label>Source Name</label>
                <input type="text" id="assetSourceName" placeholder="e.g., Dr. Jane Smith, USDA Report">
              </div>
              <div class="form-group">
                <label>Source Type</label>
                <select id="assetSourceType">
                  <option value="internal">Internal</option>
                  <option value="stakeholder">Stakeholder</option>
                  <option value="leadership">Leadership</option>
                  <option value="publication">Publication</option>
                  <option value="event">Event</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Source URL</label>
              <input type="url" id="assetSourceUrl" placeholder="https://...">
            </div>
            <div class="form-group">
              <label>Attribution Text</label>
              <input type="text" id="assetAttribution" placeholder="How to cite this content">
            </div>

            <!-- Usage Guidance -->
            <div class="form-row">
              <div class="form-group">
                <label>Audience</label>
                <select id="assetAudience">
                  <option value="all">All Audiences</option>
                  <option value="internal">Internal Only</option>
                  <option value="external">External</option>
                  <option value="leadership">Leadership</option>
                  <option value="public">Public</option>
                  <option value="technical">Technical</option>
                </select>
              </div>
              <div class="form-group">
                <label>Tone</label>
                <select id="assetTone">
                  <option value="formal">Formal</option>
                  <option value="casual">Casual</option>
                  <option value="technical">Technical</option>
                  <option value="inspirational">Inspirational</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Channels</label>
              <div class="checkbox-group-inline">
                <label class="checkbox-item-inline">
                  <input type="checkbox" name="assetChannel" value="email"> Email
                </label>
                <label class="checkbox-item-inline">
                  <input type="checkbox" name="assetChannel" value="presentation"> Presentation
                </label>
                <label class="checkbox-item-inline">
                  <input type="checkbox" name="assetChannel" value="report"> Report
                </label>
                <label class="checkbox-item-inline">
                  <input type="checkbox" name="assetChannel" value="social"> Social
                </label>
                <label class="checkbox-item-inline">
                  <input type="checkbox" name="assetChannel" value="flyer"> Flyer
                </label>
              </div>
            </div>
            <div class="form-group">
              <label>Usage Notes</label>
              <textarea id="assetUsageNotes" rows="2" placeholder="Any caveats or context needed when using this content"></textarea>
            </div>
            <div class="form-group">
              <label>Expiration Date</label>
              <input type="date" id="assetExpirationDate">
              <div class="form-hint">Leave blank if no expiration</div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="COMMS.closeModal('addAssetModal')">Cancel</button>
          <button type="submit" id="saveAssetBtn" class="btn btn-primary">
            <span class="material-icons">save</span>
            Save Asset
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Contact for Asset Modal (Quick Add) -->
<div class="modal-overlay" id="addContactForAssetModal" onclick="COMMS.closeModal('addContactForAssetModal', event)">
  <div class="modal-content modal-sm" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Quick Add Contact</h2>
      <button class="modal-close" onclick="COMMS.closeModal('addContactForAssetModal')" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addContactForAssetForm" onsubmit="COMMS.submitContactForAsset(event)">
        <div class="form-row">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" id="assetContactFirstName" required>
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" id="assetContactLastName" required>
          </div>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="assetContactEmail" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Organization</label>
            <input type="text" id="assetContactOrg">
          </div>
          <div class="form-group">
            <label>Title</label>
            <input type="text" id="assetContactTitle">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="COMMS.closeModal('addContactForAssetModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Add & Select</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Comms Styles -->
<style>
  /* Page accent color for shared styles */
  .comms-viewer {
    --page-accent: var(--color-comms);
    max-width: 1600px;
    margin: 0 auto;
  }

  /* Header Search (like SEP's cycle filter) */
  .header-search {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
  }
  .header-search .material-icons {
    font-size: 18px;
    color: var(--color-text-muted);
  }
  .header-search input {
    border: none;
    outline: none;
    font-size: var(--font-size-sm);
    width: 180px;
    background: transparent;
  }

  /* Pipeline Filters (inline in section header) */
  .pipeline-filters {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }
  .pipeline-filters select {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    background: var(--color-surface);
  }
  .pipeline-filters select:focus {
    outline: none;
    border-color: var(--color-comms);
  }

  /* ========================================================================
     CONTENT VIEW STYLES
     ======================================================================== */

  .content-view-layout {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    height: 100%;
  }

  .content-search-header {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
  }

  .content-search-box {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    background: var(--color-background);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-md);
  }

  .content-search-box:focus-within {
    border-color: var(--color-comms);
  }

  .content-search-box .material-icons {
    color: var(--color-text-muted);
    font-size: 24px;
  }

  .content-search-box input {
    flex: 1;
    border: none;
    outline: none;
    font-size: var(--font-size-md);
    background: transparent;
  }

  .content-filters {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .content-filters label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  .content-filters select {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    min-width: 200px;
  }

  .content-results {
    flex: 1;
    overflow-y: auto;
  }

  /* Quick Access Cards */
  .content-quick-access {
    padding: var(--space-md);
  }

  .quick-access-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-md);
  }

  .quick-access-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }

  .quick-access-card:hover {
    border-color: var(--color-comms);
    box-shadow: var(--shadow-md);
  }

  .quick-access-card .material-icons {
    font-size: 48px;
    color: var(--color-comms);
    margin-bottom: var(--space-sm);
  }

  .quick-access-card h4 {
    margin: 0 0 var(--space-xs);
    font-size: var(--font-size-md);
    font-weight: 600;
  }

  .quick-access-card p {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  /* Solution Content Panel */
  .solution-content-panel {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .solution-content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-background);
  }

  .solution-content-header h3 {
    margin: 0;
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--color-comms);
  }

  .solution-content-actions {
    display: flex;
    gap: var(--space-sm);
  }

  /* Content Type Sections */
  .content-type-sections {
    padding: var(--space-md);
  }

  .content-type-section {
    margin-bottom: var(--space-lg);
  }

  .content-type-section:last-child {
    margin-bottom: 0;
  }

  .content-type-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border-light);
    margin-bottom: var(--space-sm);
    cursor: pointer;
  }

  .content-type-header .material-icons {
    font-size: 20px;
    color: var(--color-comms);
  }

  .content-type-header h4 {
    margin: 0;
    font-size: var(--font-size-md);
    font-weight: 600;
    flex: 1;
  }

  .content-type-header .count-badge {
    background: var(--color-comms);
    color: white;
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: var(--radius-pill);
  }

  .content-type-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .content-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-background);
    border-radius: var(--radius-sm);
    border: 1px solid transparent;
  }

  .content-item:hover {
    border-color: var(--color-border);
  }

  .content-item-text {
    flex: 1;
    font-size: var(--font-size-sm);
    line-height: 1.5;
  }

  .content-item-actions {
    display: flex;
    gap: var(--space-xs);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .content-item:hover .content-item-actions {
    opacity: 1;
  }

  .content-item .btn-icon {
    padding: 4px;
    min-width: auto;
  }

  .copy-success {
    color: var(--color-success);
    font-size: var(--font-size-xs);
    animation: fadeInOut 2s ease;
  }

  @keyframes fadeInOut {
    0% { opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
  }

  /* Search Results */
  .search-results-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
  }

  .search-results-header h3 {
    margin: 0;
    font-size: var(--font-size-md);
    flex: 1;
  }

  .search-results-header .btn-icon {
    padding: var(--space-xs);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
  }

  .search-results-header .btn-icon:hover {
    background: var(--color-comms);
    color: white;
    border-color: var(--color-comms);
  }

  /* Solution content header back button */
  .solution-content-header .btn-icon {
    padding: var(--space-xs);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    margin-right: var(--space-sm);
  }

  .solution-content-header .btn-icon:hover {
    background: var(--color-comms);
    color: white;
    border-color: var(--color-comms);
  }

  .search-results-count {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  /* ========================================================================
     ASSETS VIEW STYLES
     ======================================================================== */

  .assets-view-layout {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    height: 100%;
  }

  .assets-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
  }

  .assets-filters {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .assets-filters select {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }

  .assets-search-box {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
  }

  .assets-search-box:focus-within {
    border-color: var(--color-comms);
  }

  .assets-search-box .material-icons {
    font-size: 18px;
    color: var(--color-text-muted);
  }

  .assets-search-box input {
    border: none;
    outline: none;
    font-size: var(--font-size-sm);
    width: 180px;
    background: transparent;
  }

  .assets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-md);
    padding: var(--space-md);
    overflow-y: auto;
  }

  .asset-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .asset-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-comms);
  }

  .asset-card-thumbnail {
    height: 120px;
    background: var(--color-background);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .asset-card-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .asset-card-thumbnail iframe {
    width: 100%;
    height: 100%;
    border: none;
    pointer-events: none; /* Prevent iframe from capturing clicks */
  }

  .asset-card-thumbnail .material-icons {
    font-size: 48px;
    color: var(--color-text-muted);
  }

  .asset-card-info {
    padding: var(--space-sm);
  }

  .asset-card-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    margin: 0 0 var(--space-xs);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .asset-card-meta {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  .asset-card-actions {
    display: flex;
    padding: var(--space-xs) var(--space-sm);
    border-top: 1px solid var(--color-border-light);
    gap: var(--space-xs);
  }

  .asset-card-actions .btn {
    flex: 1;
    font-size: var(--font-size-xs);
    padding: var(--space-xs);
  }

  /* Asset Detail Modal */
  .asset-detail-modal {
    max-width: 900px;
    width: 95vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
  }

  .asset-detail-body {
    display: flex;
    gap: var(--space-md);
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  .asset-preview-container {
    flex: 2;
    min-width: 0;
    background: var(--color-background);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .asset-preview-container iframe {
    width: 100%;
    height: 400px;
    border: none;
    border-radius: var(--radius-md);
  }

  .asset-preview-container img {
    max-width: 100%;
    max-height: 400px;
    object-fit: contain;
  }

  .asset-preview-container .preview-icon {
    font-size: 96px;
    color: var(--color-text-muted);
  }

  .asset-detail-info {
    flex: 1;
    min-width: 200px;
    overflow-y: auto;
  }

  .asset-detail-info .detail-row {
    margin-bottom: var(--space-sm);
  }

  .asset-detail-info .detail-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: var(--space-xs);
  }

  .asset-detail-info .detail-value {
    font-size: var(--font-size-sm);
  }

  @media (max-width: 768px) {
    .asset-detail-body {
      flex-direction: column;
    }
    .asset-detail-info {
      min-width: 100%;
    }
  }

  /* Upload Dropzone */
  .upload-dropzone-container {
    margin-bottom: var(--space-md);
    position: relative;
  }

  .upload-dropzone {
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-xl);
    text-align: center;
    background: var(--color-surface);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .upload-dropzone:hover,
  .upload-dropzone.drag-over {
    border-color: var(--color-comms);
    background: rgba(233, 30, 99, 0.05);
  }

  .upload-dropzone.drag-over {
    border-style: solid;
  }

  .upload-dropzone .material-icons {
    font-size: 48px;
    color: var(--color-comms);
    margin-bottom: var(--space-sm);
  }

  .upload-dropzone p {
    margin: 0 0 var(--space-xs);
    font-size: var(--font-size-md);
    color: var(--color-text);
  }

  .dropzone-or {
    display: block;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    margin: var(--space-sm) 0;
  }

  .dropzone-hint {
    font-size: var(--font-size-xs) !important;
    color: var(--color-text-muted) !important;
    margin-top: var(--space-sm) !important;
  }

  .dropzone-close {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
  }

  /* Upload Progress */
  .upload-progress-container {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    margin-bottom: var(--space-md);
  }

  .upload-progress-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .upload-progress-item .material-icons {
    font-size: 24px;
    color: var(--color-comms);
  }

  .upload-progress-info {
    flex: 1;
  }

  .upload-filename {
    font-size: var(--font-size-sm);
    font-weight: 500;
    display: block;
    margin-bottom: var(--space-xs);
  }

  .upload-progress-bar {
    height: 6px;
    background: var(--color-background);
    border-radius: 3px;
    overflow: hidden;
  }

  .upload-progress-fill {
    height: 100%;
    background: var(--color-comms);
    width: 0%;
    transition: width 0.3s ease;
  }

  .upload-status {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  .upload-status.success {
    color: var(--color-success);
  }

  .upload-status.error {
    color: var(--color-error);
  }

  /* Upload Metadata Form */
  .upload-metadata-form {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
    overflow: hidden;
  }

  .metadata-form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-background);
    border-bottom: 1px solid var(--color-border-light);
  }

  .metadata-form-header h4 {
    margin: 0;
    font-size: var(--font-size-md);
  }

  .metadata-form-content {
    padding: var(--space-md);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
  }

  .metadata-form-content .form-row {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .metadata-form-content label {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-muted);
  }

  .metadata-form-content input,
  .metadata-form-content select,
  .metadata-form-content textarea {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }

  .metadata-form-content input:focus,
  .metadata-form-content select:focus,
  .metadata-form-content textarea:focus {
    outline: none;
    border-color: var(--color-comms);
  }

  .metadata-form-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-background);
    border-top: 1px solid var(--color-border-light);
  }

  /* ========================================================================
     MANAGE VIEW STYLES
     ======================================================================== */

  .manage-layout {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* Standalone Manage Subtabs Bar (shown above legacy views) */
  .manage-subtabs-bar {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
  }

  .manage-subtabs-bar .manage-subtab-spacer {
    flex: 1;
  }

  .manage-subtabs {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
  }

  .manage-subtab {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    border: none;
    background: transparent;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .manage-subtab:hover {
    background: var(--color-background);
    color: var(--color-text);
  }

  .manage-subtab.active {
    background: var(--color-comms);
    color: white;
  }

  .manage-subtab .material-icons {
    font-size: 18px;
  }

  .manage-subtab-spacer {
    flex: 1;
  }

  .manage-content-area {
    flex: 1;
    overflow-y: auto;
  }

  .manage-panel {
    height: 100%;
  }

  .priorities-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    height: 100%;
  }

  /* Comms Pipeline Customizations */

  /* Comms dot colors (story status) */
  .dot-idea { background: #9E9E9E; }
  .dot-research { background: #2196F3; }
  .dot-draft { background: #FF9800; }
  .dot-review { background: #9C27B0; }
  .dot-published { background: #4CAF50; }

  /* Comms column customizations */
  .comms-viewer .pipeline-column { min-width: 200px; }
  .comms-viewer .column-header {
    border-top: 3px solid var(--color-comms);
  }

  /* Drag and drop styles */
  .comms-viewer .story-card {
    cursor: grab;
    transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
  }
  .comms-viewer .story-card:active {
    cursor: grabbing;
  }
  .comms-viewer .story-card.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
    box-shadow: var(--shadow-lg);
  }
  .comms-viewer .pipeline-column.drop-target {
    background: rgba(233, 30, 99, 0.08);
    border: 2px dashed var(--color-comms);
  }
  .comms-viewer .pipeline-column.drop-target .column-cards {
    min-height: 100px;
  }

  /* Collapsible Sidebar Layout */
  .pipeline-layout {
    display: flex;
    gap: var(--space-md);
    height: 100%;
  }
  .insights-sidebar {
    width: 280px;
    min-width: 280px;
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    position: relative;
    transition: width 0.3s ease, min-width 0.3s ease;
    overflow: hidden;
  }
  .insights-sidebar.collapsed {
    width: 40px;
    min-width: 40px;
  }
  .insights-sidebar.collapsed .sidebar-content {
    opacity: 0;
    visibility: hidden;
  }
  .sidebar-toggle {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface-alt);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    cursor: pointer;
    z-index: 1;
    transition: transform 0.3s ease;
  }
  .sidebar-toggle:hover {
    background: var(--color-border-light);
  }
  .insights-sidebar.collapsed .sidebar-toggle {
    right: 8px;
    transform: rotate(180deg);
  }
  .sidebar-content {
    padding: var(--space-md);
    padding-top: 40px;
    overflow-y: auto;
    flex: 1;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }
  .sidebar-section {
    margin-bottom: var(--space-md);
  }
  .sidebar-section:last-child {
    margin-bottom: 0;
  }
  .sidebar-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--color-border-light);
  }
  .sidebar-section-header h4 {
    margin: 0;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-comms);
  }
  .sidebar-section-content {
    max-height: 250px;
    overflow-y: auto;
  }
  .pipeline-main {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  /* Override pipeline-board to use 4 columns (Published is in sidebar) */
  .comms-viewer .pipeline-board {
    grid-template-columns: repeat(4, 1fr);
    flex: 1;
  }

  /* Collapsible Search Bar */
  .pipeline-search-bar {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
    height: 36px;
  }
  .search-toggle-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    cursor: pointer;
    color: var(--color-text-secondary);
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  .search-toggle-btn:hover {
    background: var(--color-surface-alt);
    color: var(--color-comms);
    border-color: var(--color-comms);
  }
  .pipeline-search-bar.expanded .search-toggle-btn {
    background: var(--color-comms);
    color: white;
    border-color: var(--color-comms);
  }
  .search-bar-content {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    overflow: hidden;
    max-width: 0;
    opacity: 0;
    transition: max-width 0.3s ease, opacity 0.2s ease;
  }
  .pipeline-search-bar.expanded .search-bar-content {
    max-width: 600px;
    opacity: 1;
  }
  .search-input-wrapper {
    position: relative;
  }
  .search-input-wrapper input {
    width: 180px;
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }
  .search-input-wrapper input:focus {
    outline: none;
    border-color: var(--color-comms);
    box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.1);
  }
  .search-bar-content select {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    background: var(--color-surface);
    cursor: pointer;
  }
  .search-bar-content select:focus {
    outline: none;
    border-color: var(--color-comms);
  }
  /* Published Sidebar (right side) */
  .published-sidebar {
    width: 250px;
    min-width: 250px;
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    position: relative;
    transition: width 0.3s ease, min-width 0.3s ease;
    overflow: hidden;
  }
  .published-sidebar.collapsed {
    width: 40px;
    min-width: 40px;
  }
  .published-sidebar.collapsed .sidebar-content {
    opacity: 0;
    visibility: hidden;
  }
  .published-sidebar .sidebar-toggle {
    left: 8px;
    right: auto;
  }
  .published-sidebar.collapsed .sidebar-toggle {
    transform: rotate(180deg);
  }
  .published-sidebar .sidebar-section-header {
    border-bottom-color: var(--color-success);
  }
  .published-sidebar .sidebar-section-header h4 {
    color: var(--color-success);
  }
  .published-sidebar .sidebar-section-content {
    max-height: none;
    flex: 1;
  }
  .published-cards {
    min-height: 200px;
    padding: var(--space-xs);
    border-radius: var(--radius-sm);
    transition: background 0.2s;
  }
  .published-cards.drop-target {
    background: rgba(76, 175, 80, 0.08);
    border: 2px dashed var(--color-success);
  }

  /* Comms story card header */
  .story-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 4px;
  }
  .card-type {
    font-size: var(--font-size-xs);
    padding: 2px 6px;
    background: rgba(123, 31, 162, 0.1);
    color: var(--color-comms);
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    font-weight: 500;
  }
  .card-type.type-web_content { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
  .card-type.type-social_media { background: rgba(0, 150, 136, 0.1); color: #009688; }
  .card-type.type-external_mention { background: rgba(96, 125, 139, 0.1); color: #607D8B; }
  .card-type.type-nugget { background: rgba(255, 152, 0, 0.1); color: #FF9800; }
  .card-type.type-key_date { background: rgba(244, 67, 54, 0.1); color: #F44336; }
  .card-type.type-highlighter_blurb { background: rgba(103, 58, 183, 0.1); color: #673AB7; }
  .card-date { font-size: var(--font-size-xs); color: var(--color-text-muted); }
  .card-title {
    font-weight: 600;
    font-size: var(--font-size-sm);
    color: var(--color-text);
    margin-bottom: 4px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .card-solutions {
    font-size: var(--font-size-xs);
    color: var(--color-comms);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 4px;
  }
  .card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 10px;
    color: var(--color-text-muted);
    padding-top: 4px;
    border-top: 1px solid var(--color-border-light);
  }
  .card-channel {
    display: flex;
    align-items: center;
    gap: 2px;
  }
  .card-channel svg { width: 12px; height: 12px; }

  /* Bottom Panels */
  .bottom-panels,
  .top-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
  }
  .top-panels {
    margin-bottom: var(--space-lg);
  }
  .panel {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-bottom: 1px solid var(--color-border-light);
  }
  .panel-header h3 { font-size: var(--font-size-md); font-weight: 600; margin: 0; }
  .panel-content { padding: var(--space-md); max-height: 300px; overflow-y: auto; }

  /* Opportunity Items */
  .opportunity-item {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--color-comms);
    margin-bottom: var(--space-sm);
    background: var(--color-surface-alt);
    cursor: pointer;
    transition: background var(--transition-fast);
  }
  .opportunity-item:hover { background: var(--color-border-light); }
  .opportunity-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(123, 31, 162, 0.1);
    border-radius: var(--radius-sm);
    color: var(--color-comms);
    flex-shrink: 0;
  }
  .opportunity-icon svg { width: 16px; height: 16px; }
  .opportunity-icon.milestone { background: rgba(76, 175, 80, 0.1); color: var(--color-success); }
  .opportunity-icon.t8 { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
  .opportunity-info { flex: 1; min-width: 0; }
  .opportunity-title { font-weight: 500; font-size: var(--font-size-sm); margin-bottom: 2px; }
  .opportunity-desc { font-size: var(--font-size-xs); color: var(--color-text-secondary); }

  /* Coverage Gap Items */
  .gap-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
    background: var(--color-surface-alt);
  }
  .gap-item.severe { border-left: 3px solid var(--color-error); }
  .gap-item.moderate { border-left: 3px solid var(--color-warning); }
  .gap-info { flex: 1; }
  .gap-solution { font-weight: 500; font-size: var(--font-size-sm); }
  .gap-days { font-size: var(--font-size-xs); color: var(--color-text-muted); }
  .gap-action {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-xs);
    background: var(--color-comms);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
  }

  /* Coverage View */
  .coverage-layout { padding: var(--space-md); }
  .coverage-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }
  .summary-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }
  .summary-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
  }
  .summary-icon.covered { background: rgba(76, 175, 80, 0.1); color: var(--color-success); }
  .summary-icon.attention { background: rgba(255, 152, 0, 0.1); color: var(--color-warning); }
  .summary-icon.uncovered { background: rgba(244, 67, 54, 0.1); color: var(--color-error); }
  .summary-icon svg { width: 24px; height: 24px; }
  .summary-value { font-size: var(--font-size-xl); font-weight: 700; }
  .summary-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); }

  .coverage-table-container {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .coverage-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-sm);
  }
  .coverage-table th {
    background: var(--color-surface-alt);
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid var(--color-border);
  }
  .coverage-table td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
  }
  .coverage-table tr:hover { background: var(--color-surface-alt); }
  .status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: var(--font-size-xs);
    font-weight: 500;
  }
  .status-badge.covered { background: rgba(76, 175, 80, 0.1); color: var(--color-success); }
  .status-badge.attention { background: rgba(255, 152, 0, 0.1); color: var(--color-warning); }
  .status-badge.uncovered { background: rgba(244, 67, 54, 0.1); color: var(--color-error); }

  /* Calendar View */
  .calendar-layout {
    padding: var(--space-md);
    display: grid;
    grid-template-columns: 1fr 300px;
    grid-template-rows: auto 1fr;
    gap: var(--space-md);
  }
  .calendar-layout .calendar-header {
    grid-column: 1 / -1;
  }
  .calendar-layout .calendar-grid {
    grid-column: 1;
  }
  .calendar-layout .calendar-sidebar {
    grid-column: 2;
    grid-row: 2;
  }
  @media (max-width: 1000px) {
    .calendar-layout {
      grid-template-columns: 1fr;
    }
    .calendar-layout .calendar-sidebar {
      grid-column: 1;
      grid-row: 3;
    }
  }
  .calendar-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-lg);
    margin-bottom: var(--space-md);
  }
  .calendar-header h3 { margin: 0; min-width: 200px; text-align: center; }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    margin-bottom: var(--space-lg);
  }
  .calendar-day-header {
    background: var(--color-surface-alt);
    padding: var(--space-sm);
    text-align: center;
    font-weight: 600;
    font-size: var(--font-size-sm);
  }
  .calendar-day {
    background: var(--color-surface);
    min-height: 80px;
    padding: var(--space-xs);
  }
  .calendar-day.other-month { background: var(--color-surface-alt); opacity: 0.5; }
  .calendar-day.today { background: rgba(123, 31, 162, 0.05); }
  .calendar-day-number {
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-bottom: var(--space-xs);
  }
  .calendar-event {
    font-size: var(--font-size-xs);
    padding: 2px 4px;
    background: var(--color-comms);
    color: white;
    border-radius: 2px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
  }
  .calendar-event.published { background: var(--color-success); }
  .calendar-event.target { background: var(--color-warning); }

  .upcoming-targets {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-sm);
  }
  .upcoming-targets h4 { margin: 0 0 var(--space-md) 0; }
  .target-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    border-left: 3px solid var(--color-warning);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .target-info { flex: 1; }
  .target-title { font-weight: 500; font-size: var(--font-size-sm); }
  .target-date { font-size: var(--font-size-xs); color: var(--color-text-muted); }

  /* Calendar Sidebar */
  .calendar-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  /* Comms Due Section */
  .comms-due-section {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-sm);
  }
  .comms-due-section h4 {
    margin: 0 0 var(--space-md) 0;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    color: var(--color-warning);
  }
  .comms-due-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
  }
  .comms-due-item:hover { background: var(--color-border-light); }
  .comms-due-item.urgent { border-left: 3px solid var(--color-error); }
  .comms-due-item.warning { border-left: 3px solid var(--color-warning); }
  .comms-due-info { flex: 1; min-width: 0; }
  .comms-due-solution {
    font-weight: 500;
    font-size: var(--font-size-sm);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .comms-due-days {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .comms-due-days.urgent { color: var(--color-error); font-weight: 500; }
  .comms-due-days.warning { color: var(--color-warning); }
  .comms-due-action {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-xs);
    background: var(--color-comms);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    white-space: nowrap;
  }
  .comms-due-action:hover { background: #6a1b9a; }

  /* Modal & Forms */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: var(--space-md);
  }
  .modal-overlay.active { display: flex; }
  .modal-content {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .modal-content.modal-lg { max-width: 900px; }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }
  .modal-title { font-size: var(--font-size-lg); font-weight: 600; margin: 0; }
  .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-muted); }
  .modal-close:hover { color: var(--color-text); }
  .modal-body { padding: var(--space-lg); overflow-y: auto; }

  .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); }
  .form-group { margin-bottom: var(--space-md); }
  .form-group-wide { grid-column: span 3; }
  .form-group label { display: block; font-size: var(--font-size-sm); font-weight: 500; margin-bottom: var(--space-xs); }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: inherit;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--color-comms);
  }
  .form-actions { display: flex; justify-content: flex-end; gap: var(--space-sm); margin-top: var(--space-md); }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: none;
  }
  .btn svg { width: 16px; height: 16px; }
  .btn-primary { background: var(--color-comms); color: white; }
  .btn-primary:hover { background: #6a1b9a; }
  .btn-secondary { background: var(--color-surface-alt); color: var(--color-text); border: 1px solid var(--color-border); }
  .btn-secondary:hover { background: var(--color-border-light); }
  .btn-sm { padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-xs); }

  /* Events View */
  .events-layout { display: flex; flex-direction: column; gap: var(--space-md); }
  .events-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }
  .events-stats { display: flex; gap: var(--space-lg); }
  .event-stat { text-align: center; }
  .event-stat-value { display: block; font-size: var(--font-size-xl); font-weight: 700; color: var(--color-comms); }
  .event-stat-label { font-size: var(--font-size-xs); color: var(--color-text-secondary); }
  .events-actions { display: flex; gap: var(--space-sm); align-items: center; }
  .events-actions select {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }
  .events-content { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); }
  .events-panel {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .events-panel .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .events-panel .panel-content { max-height: 300px; overflow-y: auto; }
  .badge {
    padding: 2px 8px;
    background: var(--color-comms);
    color: white;
    border-radius: 12px;
    font-size: var(--font-size-xs);
    font-weight: 600;
  }
  .event-card {
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: 1px solid var(--color-border-light);
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .event-card:hover {
    border-color: var(--color-border);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transform: translateY(-1px);
  }
  .event-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
  }
  .event-type-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: rgba(123, 31, 162, 0.08);
    border-radius: var(--radius-sm);
    color: var(--color-comms);
  }
  .event-type-icon .material-icons {
    font-size: 18px;
  }
  .event-card-title {
    font-weight: 600;
    font-size: var(--font-size-md);
    color: var(--color-text);
    line-height: 1.3;
    margin-bottom: var(--space-sm);
  }
  .event-card-details {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .event-card-date,
  .event-card-location {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }
  .event-card-date .material-icons,
  .event-card-location .material-icons {
    font-size: 16px;
    color: var(--color-text-muted);
  }
  .event-card-actions {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--color-border-light);
  }
  .event-card-actions .btn {
    flex: 1;
  }
  .events-table-container {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .events-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-sm);
  }
  .events-table th {
    background: var(--color-surface-alt);
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid var(--color-border);
  }
  .events-table td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
  }
  .events-table tr:hover { background: var(--color-surface-alt); }

  /* Event Status - uses shared badge pattern */
  .event-status {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 500;
    text-transform: capitalize;
  }
  .event-status.potential {
    background: var(--color-surface-alt);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
  }
  .event-status.considering {
    background: rgba(33, 150, 243, 0.12);
    color: #1565C0;
  }
  .event-status.confirmed {
    background: rgba(76, 175, 80, 0.12);
    color: #2E7D32;
  }
  .event-status.attended {
    background: var(--color-surface-alt);
    color: var(--color-text-muted);
  }
  .event-status.cancelled {
    background: rgba(158, 158, 158, 0.12);
    color: var(--color-text-muted);
    text-decoration: line-through;
  }

  /* Event Detail Modal Header */
  .event-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
  }
  .event-detail-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
  .event-type-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }
  .event-detail-actions {
    display: flex;
    gap: var(--space-xs);
  }
  .event-detail-actions .btn .material-icons {
    font-size: 16px;
  }

  /* Discover Events */
  .discover-search { margin-bottom: var(--space-lg); }
  .discover-results { max-height: 400px; overflow-y: auto; }
  .discover-result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .discover-result-info { flex: 1; min-width: 0; }
  .discover-result-title { font-weight: 500; font-size: var(--font-size-sm); margin-bottom: 2px; }
  .discover-result-url { font-size: var(--font-size-xs); color: var(--color-text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Checkbox Group */
  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
  }
  .checkbox-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
    font-size: var(--font-size-sm);
  }
  .checkbox-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }
  .checkbox-item span { flex: 1; }

  /* Radio Group (for Presentation Builder) */
  .radio-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }
  .radio-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    cursor: pointer;
    border: 2px solid transparent;
    transition: all var(--transition-fast);
  }
  .radio-item:hover {
    background: var(--color-surface);
    border-color: var(--color-border);
  }
  .radio-item:has(input:checked) {
    background: rgba(123, 31, 162, 0.08);
    border-color: var(--color-comms);
  }
  .radio-item input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }
  .radio-item span {
    font-weight: 600;
    font-size: var(--font-size-md);
  }
  .radio-item small {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    font-weight: normal;
  }

  /* Asset Contact Picker (matches SEP engagement modal) */
  .asset-contact-picker {
    position: relative;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
    padding: 4px;
    min-height: 38px;
  }
  .asset-contact-picker:focus-within {
    border-color: var(--color-comms);
    box-shadow: 0 0 0 2px rgba(123, 31, 162, 0.1);
  }
  .asset-selected-contacts {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 4px;
  }
  .asset-selected-contacts:empty { margin-bottom: 0; }
  .asset-contact-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: var(--color-comms);
    color: white;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: var(--font-size-xs);
    max-width: 200px;
  }
  .asset-contact-chip-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .asset-contact-chip-remove {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    color: white;
    opacity: 0.7;
    font-size: 14px;
    line-height: 1;
    display: flex;
  }
  .asset-contact-chip-remove:hover { opacity: 1; }
  .asset-contact-search {
    border: none;
    outline: none;
    width: 100%;
    padding: 4px;
    font-size: var(--font-size-sm);
    background: transparent;
  }
  .asset-contact-results {
    position: absolute;
    top: 100%;
    left: -1px;
    right: -1px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-top: none;
    border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: var(--shadow-md);
  }
  .asset-contact-results.active { display: block; }
  .asset-contact-result-item {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background var(--transition-fast);
    border-bottom: 1px solid var(--color-border-light);
  }
  .asset-contact-result-item:last-child { border-bottom: none; }
  .asset-contact-result-item:hover { background: var(--color-surface-alt); }
  .asset-contact-result-item.selected { background: rgba(123, 31, 162, 0.1); }
  .asset-contact-result-info { flex: 1; min-width: 0; }
  .asset-contact-result-name { font-weight: 500; font-size: var(--font-size-sm); }
  .asset-contact-result-detail { font-size: var(--font-size-xs); color: var(--color-text-muted); }
  .asset-contact-results-empty {
    padding: 12px;
    text-align: center;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
  }

  /* Asset Solution Tags */
  .asset-solution-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
    min-height: 28px;
  }
  .asset-solution-tags:empty { margin-bottom: 0; min-height: 0; }
  .asset-solution-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: var(--color-comms);
    color: white;
    padding: 4px 8px;
    border-radius: 999px;
    font-size: var(--font-size-xs);
  }
  .asset-solution-tag-remove {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    color: white;
    opacity: 0.7;
    display: flex;
    align-items: center;
  }
  .asset-solution-tag-remove:hover { opacity: 1; }
  .asset-solution-tag-remove .material-icons { font-size: 14px; }

  /* Form Sections (Collapsible) */
  .form-section {
    margin-bottom: var(--space-md);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }
  .form-section-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    cursor: pointer;
    user-select: none;
    font-weight: 500;
    font-size: var(--font-size-sm);
  }
  .form-section-header:hover {
    background: var(--color-surface);
  }
  .section-toggle-icon {
    font-size: 20px;
    color: var(--color-text-muted);
    transition: transform var(--transition-fast);
  }
  .form-section-content.collapsed + .form-section-header .section-toggle-icon,
  .form-section-content.collapsed ~ .section-toggle-icon {
    transform: rotate(-90deg);
  }
  .form-section-badge {
    margin-left: auto;
    background: var(--color-comms);
    color: white;
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: 999px;
    min-width: 20px;
    text-align: center;
  }
  .form-section-badge:empty,
  .form-section-badge[data-count="0"] {
    display: none;
  }
  .form-section-content {
    padding: var(--space-md);
  }
  .form-section-content.collapsed {
    display: none;
  }

  /* Tag Suggestions */
  .tag-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }
  .tag-suggestion {
    padding: 4px 12px;
    background: var(--color-surface-alt);
    border: 1px solid var(--color-border-light);
    border-radius: 999px;
    font-size: var(--font-size-xs);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  .tag-suggestion:hover {
    background: var(--color-surface);
    border-color: var(--color-border);
  }
  .tag-suggestion.selected {
    background: var(--color-comms);
    color: white;
    border-color: var(--color-comms);
  }

  /* Inline Checkbox Group */
  .checkbox-group-inline {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }
  .checkbox-item-inline {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: var(--font-size-sm);
    cursor: pointer;
    padding: 4px 8px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
  }
  .checkbox-item-inline:hover {
    background: var(--color-surface);
  }
  .checkbox-item-inline:has(input:checked) {
    background: rgba(123, 31, 162, 0.1);
  }
  .checkbox-item-inline input {
    width: 14px;
    height: 14px;
  }

  /* Form Hint */
  .form-hint {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: 4px;
  }

  /* Small Button Text Variant */
  .btn-text {
    background: transparent;
    border: none;
    color: var(--color-comms);
    padding: 4px 8px;
    font-size: var(--font-size-xs);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
  }
  .btn-text:hover {
    background: rgba(123, 31, 162, 0.08);
    border-radius: var(--radius-sm);
  }
  .btn-text .material-icons {
    font-size: 16px;
  }

  /* Small Modal */
  .modal-sm .modal-content {
    max-width: 480px;
  }

  /* Messaging View */
  .messaging-layout {
    padding: var(--space-md);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  /* Priority Bar (Compact) */
  .priority-bar {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-sm) var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    flex-wrap: wrap;
  }
  .priority-bar-label {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    white-space: nowrap;
  }
  .priority-bar-label .material-icons {
    font-size: 18px;
    color: var(--page-accent, var(--color-comms));
  }
  .priority-chips {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    flex: 1;
  }
  .priority-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--color-surface-alt);
    border: 1px solid var(--color-border-light);
    border-radius: 20px;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all 0.15s;
  }
  .priority-chip:hover {
    background: var(--color-primary-light);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }
  .priority-chip.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }
  .priority-chip .material-icons {
    font-size: 16px;
  }
  .chip-label {
    font-weight: 500;
  }
  .chip-count {
    background: rgba(0,0,0,0.1);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: var(--font-size-xs);
    font-weight: 600;
  }
  .priority-chip.active .chip-count {
    background: rgba(255,255,255,0.2);
  }
  .priority-chip-warning {
    background: rgba(255, 152, 0, 0.1);
    border-color: rgba(255, 152, 0, 0.3);
    color: #E65100;
  }
  .priority-chip-warning:hover {
    background: rgba(255, 152, 0, 0.2);
    border-color: #F57C00;
  }
  .priority-chip-warning .chip-count {
    background: rgba(255, 152, 0, 0.2);
  }

  /* Priority Detail Panel */
  .priority-detail-panel {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    animation: slideDown 0.2s ease;
  }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .priority-detail-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--color-border-light);
  }
  .priority-detail-header .material-icons {
    color: var(--page-accent, var(--color-comms));
  }
  .priority-detail-header h3 {
    margin: 0;
    flex: 1;
    font-size: var(--font-size-md);
  }
  .priority-detail-content {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-sm);
    max-height: 300px;
    overflow-y: auto;
  }
  .priority-story-item {
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: background 0.15s;
  }
  .priority-story-item:hover { background: var(--color-border-light); }
  .priority-story-title { font-weight: 500; margin-bottom: 4px; }
  .priority-story-meta {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  /* Reporting Section (Highlighter Blurbs) */
  .reporting-section {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    margin-bottom: var(--space-sm);
  }
  .reporting-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
    flex-wrap: wrap;
  }
  .reporting-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex: 1;
    min-width: 200px;
  }
  .reporting-title .material-icons {
    font-size: 20px;
    color: var(--page-accent, var(--color-comms));
  }
  .reporting-title h3 {
    margin: 0;
    font-size: var(--font-size-md);
  }
  .reporting-title p {
    margin: 0;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .reporting-deadline {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    padding: 6px 12px;
    background: rgba(255, 152, 0, 0.1);
    border-radius: var(--radius-sm);
  }
  .reporting-deadline .material-icons {
    font-size: 16px;
    color: #F57C00;
  }
  .reporting-deadline strong {
    color: #E65100;
  }
  .reporting-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }
  .blurb-empty {
    text-align: center;
    padding: var(--space-lg);
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
  }
  .blurb-card {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--page-accent, var(--color-comms));
    cursor: pointer;
    transition: background 0.15s ease, box-shadow 0.15s ease;
  }
  .blurb-card:hover {
    background: var(--color-surface);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .blurb-card.blurb-due-soon {
    border-left-color: #F57C00;
    background: rgba(255, 152, 0, 0.05);
  }
  .blurb-card.blurb-due-soon:hover {
    background: rgba(255, 152, 0, 0.1);
  }
  .blurb-card.blurb-submitted {
    border-left-color: #4CAF50;
    opacity: 0.8;
  }
  .blurb-content {
    flex: 1;
    min-width: 0;
  }
  .blurb-title {
    font-weight: 500;
    font-size: var(--font-size-sm);
    margin-bottom: 4px;
  }
  .blurb-solution {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-bottom: 4px;
  }
  .blurb-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .blurb-meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    flex-shrink: 0;
  }
  .blurb-date {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .blurb-status {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--color-surface);
    text-transform: capitalize;
  }
  .blurb-status.status-idea { background: #E0E0E0; }
  .blurb-status.status-drafting { background: #FFE0B2; color: #E65100; }
  .blurb-status.status-review { background: #E1BEE7; color: #7B1FA2; }
  .blurb-status.status-published { background: #C8E6C9; color: #2E7D32; }
  .blurbs-show-more {
    text-align: center;
    padding-top: var(--space-sm);
  }

  /* Blurb View Toggle */
  .blurb-view-toggle {
    display: flex;
    gap: 2px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    padding: 2px;
  }
  .blurb-view-toggle .view-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 28px;
    border: none;
    background: transparent;
    border-radius: var(--radius-xs);
    cursor: pointer;
    color: var(--color-text-muted);
    transition: all 0.15s ease;
  }
  .blurb-view-toggle .view-btn:hover {
    background: var(--color-surface);
    color: var(--color-text-secondary);
  }
  .blurb-view-toggle .view-btn.active {
    background: var(--color-surface);
    color: var(--page-accent, var(--color-comms));
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .blurb-view-toggle .view-btn .material-icons {
    font-size: 18px;
  }

  /* Blurb Search */
  .blurb-search-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    padding: 4px 10px;
    min-width: 180px;
  }
  .blurb-search-wrapper .material-icons {
    font-size: 18px;
    color: var(--color-text-muted);
  }
  .blurb-search-wrapper input {
    border: none;
    background: transparent;
    outline: none;
    font-size: var(--font-size-sm);
    width: 100%;
  }
  .blurb-filter-select {
    padding: 6px 10px;
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
    font-size: var(--font-size-sm);
    cursor: pointer;
  }
  .blurb-filter-select:focus {
    outline: none;
    border-color: var(--page-accent, var(--color-comms));
  }

  /* Blurb Table View */
  .blurb-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-sm);
  }
  .blurb-table th {
    text-align: left;
    padding: 8px 12px;
    font-weight: 500;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--color-border-light);
  }
  .blurb-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--color-border-light);
    vertical-align: middle;
  }
  .blurb-table tr {
    cursor: pointer;
    transition: background 0.15s ease;
  }
  .blurb-table tbody tr:hover {
    background: var(--color-surface-alt);
  }
  .blurb-table tr.blurb-row-due {
    background: rgba(255, 152, 0, 0.05);
  }
  .blurb-table tr.blurb-row-due:hover {
    background: rgba(255, 152, 0, 0.1);
  }
  .blurb-table tr.blurb-row-submitted {
    opacity: 0.7;
  }
  .blurb-table .blurb-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  .blurb-status-dot.dot-idea { background: #9E9E9E; }
  .blurb-status-dot.dot-drafting { background: #FF9800; }
  .blurb-status-dot.dot-review { background: #9C27B0; }
  .blurb-status-dot.dot-published { background: #4CAF50; }
  .blurb-status-dot.dot-due { background: #F57C00; animation: pulse 1.5s infinite; }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .blurb-table .blurb-title-cell {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
  }
  .blurb-table .blurb-solution-cell {
    color: var(--color-text-muted);
    font-size: var(--font-size-xs);
  }
  .blurb-table .blurb-date-cell {
    white-space: nowrap;
    color: var(--color-text-secondary);
  }
  .blurb-table .blurb-actions-cell {
    text-align: right;
  }
  .blurb-table .blurb-actions-cell button {
    padding: 4px 8px;
    font-size: var(--font-size-xs);
  }

  /* Key Messages Section */
  .messages-section {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    flex: 1;
  }
  .messages-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
  }
  .messages-title {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
  }
  .messages-title .material-icons {
    font-size: 24px;
    color: var(--page-accent, var(--color-comms));
    margin-top: 2px;
  }
  .messages-title h2 {
    margin: 0 0 var(--space-xs) 0;
    font-size: var(--font-size-lg);
  }
  .messages-title p {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  /* Key Messages Search & Grid */
  .messages-search {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-xs) var(--space-sm);
    max-width: 400px;
  }
  .messages-search input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: var(--font-size-sm);
    outline: none;
  }
  .messages-search svg {
    width: 16px;
    height: 16px;
    color: var(--color-text-muted);
  }
  .messages-summary {
    display: flex;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
  }
  .summary-stat {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }
  .summary-value {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--color-primary);
  }
  .summary-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }
  .messages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: var(--space-md);
  }
  .message-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .message-card:hover { box-shadow: var(--shadow-md); }
  .message-card-header {
    padding: var(--space-md);
    background: var(--color-surface-alt);
    border-bottom: 1px solid var(--color-border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-sm);
  }
  .message-solution-name {
    margin: 0;
    font-size: var(--font-size-md);
    font-weight: 600;
    flex: 1;
  }
  /* Copy button styles */
  .copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
    color: var(--color-text-secondary);
    font-size: var(--font-size-xs);
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
  }
  .copy-btn:hover {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }
  .copy-btn .material-icons {
    font-size: 14px;
  }
  .copy-btn.copied {
    background: var(--color-success);
    border-color: var(--color-success);
    color: white;
  }
  .message-section-header .copy-btn {
    margin-left: auto;
    opacity: 0;
    transition: opacity 0.15s ease;
  }
  .message-section-collapsible:hover .message-section-header .copy-btn {
    opacity: 1;
  }
  .focus-badge {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    background: var(--color-primary);
    color: white;
    font-weight: 500;
  }
  .focus-science { background: #2196F3; }
  .focus-operations { background: #4CAF50; }
  .focus-applications { background: #9C27B0; }
  .message-card-body {
    padding: var(--space-md);
  }
  .message-section {
    margin-bottom: var(--space-md);
  }
  .message-section:last-child { margin-bottom: 0; }
  .message-section h4 {
    margin: 0 0 var(--space-xs) 0;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .message-section p {
    margin: 0;
    font-size: var(--font-size-sm);
    line-height: 1.5;
    color: var(--color-text);
  }
  .message-card-footer {
    padding: var(--space-sm) var(--space-md);
    border-top: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }
  .message-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-sm);
    color: var(--color-primary);
    text-decoration: none;
  }
  .message-link:hover { text-decoration: underline; }
  .message-link svg { width: 14px; height: 14px; }

  /* Collapsible Message Sections */
  .message-section-collapsible {
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
    overflow: hidden;
  }
  .message-section-collapsible:last-child {
    margin-bottom: 0;
  }
  .message-section-header {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    cursor: pointer;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    transition: background 0.15s;
  }
  .message-section-header:hover {
    background: var(--color-border-light);
  }
  .message-section-header .material-icons {
    font-size: 18px;
    color: var(--color-text-muted);
    transition: transform 0.2s;
  }
  .message-section-collapsible:not(.open) .message-section-header .material-icons {
    transform: rotate(-90deg);
  }
  .message-section-content {
    display: none;
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    line-height: 1.6;
    color: var(--color-text);
    background: var(--color-surface);
  }
  .message-section-collapsible.open .message-section-content {
    display: block;
  }
  .message-section-content p {
    margin: 0 0 var(--space-sm) 0;
  }
  .message-section-content p:last-child {
    margin-bottom: 0;
  }
  .message-section-content ul {
    margin: 0;
    padding-left: var(--space-lg);
  }
  .message-section-content li {
    margin-bottom: var(--space-xs);
  }
  .message-section-content li:last-child {
    margin-bottom: 0;
  }

  /* Tools View */
  .tools-layout { padding: var(--space-md); }
  .tools-header {
    margin-bottom: var(--space-lg);
  }
  .tools-header h2 {
    margin: 0 0 var(--space-xs) 0;
    font-size: var(--font-size-xl);
  }
  .tools-subtitle {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    margin: 0;
  }
  .tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-lg);
  }
  .tool-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    transition: box-shadow 0.2s, border-color 0.2s;
  }
  .tool-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-border);
  }
  .tool-card-icon {
    width: 56px;
    height: 56px;
    background: rgba(123, 31, 162, 0.1);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .tool-card-icon .material-icons {
    font-size: 28px;
    color: var(--color-comms);
  }
  .tool-card-content h3 {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--font-size-lg);
    font-weight: 600;
  }
  .tool-card-content p {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: 1.5;
  }
  .tool-card-meta {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
    margin-top: var(--space-sm);
  }
  .tool-tag {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
  }
  .tool-card-actions {
    margin-top: auto;
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border-light);
  }
  .tool-card-placeholder {
    border-style: dashed;
    background: var(--color-surface-alt);
  }
  .tool-card-placeholder .tool-card-icon {
    background: var(--color-border-light);
  }
  .tool-card-placeholder .tool-card-icon .material-icons {
    color: var(--color-text-muted);
  }
  .tool-card-placeholder h3 {
    color: var(--color-text-muted);
  }

  /* Modal Tabs */
  .modal-tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }
  .modal-tab {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    border-bottom: 2px solid transparent;
    transition: all var(--transition-fast);
  }
  .modal-tab:hover {
    color: var(--color-text);
    background: var(--color-surface);
  }
  .modal-tab.active {
    color: var(--color-comms);
    border-bottom-color: var(--color-comms);
    background: var(--color-surface);
  }
  .modal-tab .material-icons {
    font-size: 18px;
  }
  .tab-badge {
    padding: 2px 6px;
    background: var(--color-comms);
    color: white;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .tab-panel {
    display: none;
  }
  .tab-panel.active {
    display: block;
  }

  /* Guest List Styles */
  .guest-list-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
  }
  .guest-search-section h4,
  .guest-list-section h4 {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .guest-search-input {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .guest-search-input .material-icons {
    color: var(--color-text-muted);
    font-size: 18px;
  }
  .guest-search-input input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: var(--font-size-sm);
    outline: none;
  }
  .guest-search-results,
  .guest-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
  }
  .guest-result-item,
  .guest-list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm);
    background: var(--color-surface);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
    transition: background var(--transition-fast);
  }
  .guest-result-item:hover,
  .guest-list-item:hover {
    background: var(--color-border-light);
  }
  .guest-info {
    flex: 1;
    min-width: 0;
  }
  .guest-name {
    font-weight: 500;
    font-size: var(--font-size-sm);
    margin-bottom: 2px;
  }
  .guest-email {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .guest-agency {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }
  .guest-actions {
    display: flex;
    gap: var(--space-xs);
  }
  .guest-add-btn,
  .guest-remove-btn {
    padding: var(--space-xs);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  .guest-add-btn {
    background: var(--color-success);
    color: white;
  }
  .guest-add-btn:hover {
    filter: brightness(1.1);
  }
  .guest-remove-btn {
    background: var(--color-surface-alt);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
  }
  .guest-remove-btn:hover {
    background: var(--color-error);
    color: white;
    border-color: var(--color-error);
  }
  .empty-state-sm {
    padding: var(--space-md);
    text-align: center;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
  }

  /* Post-Event Attendance Section */
  .attendance-section {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border-light);
  }
  .attendance-section h4 {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--font-size-sm);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  .attendance-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
  }
  .attendance-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  .attendance-checkbox label {
    flex: 1;
    cursor: pointer;
    font-size: var(--font-size-sm);
  }
  .attendance-checkbox.attended {
    background: rgba(76, 175, 80, 0.1);
  }

  /* Prep Report Styles */
  .prep-report-container {
    padding: var(--space-md);
  }
  .prep-actions {
    margin-bottom: var(--space-lg);
  }
  .prep-section {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
  }
  .prep-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .prep-section h3 {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--font-size-md);
    color: var(--color-comms);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  .prep-section h3 .material-icons {
    font-size: 20px;
  }
  .prep-summary-stats {
    display: flex;
    gap: var(--space-lg);
    margin-bottom: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-md);
  }
  .prep-stat {
    text-align: center;
  }
  .prep-stat-value {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--color-comms);
  }
  .prep-stat-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .prep-guest-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    margin-bottom: var(--space-sm);
  }
  .prep-guest-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-sm);
  }
  .prep-guest-name {
    font-weight: 600;
    font-size: var(--font-size-md);
  }
  .prep-guest-title {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }
  .prep-guest-agency {
    font-size: var(--font-size-sm);
    color: var(--color-comms);
  }
  .prep-guest-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
  }
  .prep-detail-item {
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }
  .prep-detail-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
  }
  .prep-agency-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-sm);
  }
  .prep-agency-item {
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
  }
  .prep-agency-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
  }
  .prep-agency-count {
    font-size: var(--font-size-xs);
    color: var(--color-comms);
  }
  .prep-connection-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
  }
  .prep-connection-icon {
    color: var(--color-comms);
  }
  .prep-connection-names {
    font-weight: 500;
    font-size: var(--font-size-sm);
  }
  .prep-connection-reason {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .prep-starter-item {
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .prep-starter-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-xs);
  }
  .prep-starter-topics {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }
  .prep-topic-tag {
    padding: 2px 8px;
    background: var(--color-surface);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    border: 1px solid var(--color-border-light);
  }
  .prep-topic-tag.hobby { border-left: 3px solid #4CAF50; }
  .prep-topic-tag.icebreaker { border-left: 3px solid #FF9800; }
  .prep-topic-tag.professional { border-left: 3px solid #2196F3; }
  .prep-topic-tag.personal { border-left: 3px solid #9C27B0; }
  .prep-topic-tag.skill { border-left: 3px solid #00BCD4; }
  .prep-topic-tag.work { border-left: 3px solid var(--color-comms); }

  /* Linked Solutions */
  .prep-solution-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }
  .prep-solution-tag {
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-comms);
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 500;
  }

  /* Potential Guests / Suggested Attendees */
  .prep-section-desc {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin: 0 0 var(--space-md) 0;
  }
  .potential-guests-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }
  .potential-guest-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--color-success);
  }
  .potential-guest-info {
    flex: 1;
    min-width: 0;
  }
  .potential-guest-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
  }
  .potential-guest-agency {
    font-size: var(--font-size-xs);
    color: var(--color-comms);
  }
  .potential-guest-reason {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: 2px;
  }
  .potential-guest-touchpoints {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    margin-top: 2px;
  }

  /* Responsive */
  @media (max-width: 1400px) {
    .comms-viewer .pipeline-layout {
      flex-direction: column;
    }
    .comms-viewer .insights-sidebar,
    .comms-viewer .published-sidebar {
      width: 100%;
      min-width: 100%;
      max-height: 200px;
    }
    .comms-viewer .insights-sidebar.collapsed,
    .comms-viewer .published-sidebar.collapsed {
      width: 100%;
      min-width: 100%;
      max-height: 40px;
    }
  }
  @media (max-width: 1200px) {
    .comms-viewer .pipeline-board { grid-template-columns: repeat(2, 1fr); }
    .bottom-panels, .top-panels { grid-template-columns: 1fr; }
    .coverage-summary { grid-template-columns: 1fr; }
    .priorities-grid { grid-template-columns: repeat(2, 1fr); }
    .messages-grid { grid-template-columns: 1fr; }
    .guest-list-container { grid-template-columns: 1fr; }
    .prep-guest-details { grid-template-columns: 1fr; }
  }
  @media (max-width: 768px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .comms-viewer .pipeline-board { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
    .form-group-wide { grid-column: span 1; }
    .pipeline-filters { flex-wrap: wrap; }
    .priorities-grid { grid-template-columns: 1fr; }
    .priority-bar-label { width: 120px; }
    .messages-summary { flex-direction: column; gap: var(--space-sm); }
    .modal-tabs { flex-wrap: wrap; }
    .prep-summary-stats { flex-direction: column; }
    .header-search input { width: 120px; }
    .pipeline-search-bar.expanded .search-bar-content {
      max-width: 100%;
      flex-wrap: wrap;
    }
    .search-input-wrapper input {
      width: 140px;
    }
  }
</style>

<!-- Comms JavaScript -->
<script>
var COMMS = (function() {
  var state = {
    overview: null,
    stories: [],
    opportunities: null,
    coverage: null,
    currentView: 'content',  // NEW DEFAULT: Content tab
    manageSubtab: 'pipeline',  // Default Manage sub-tab
    calendarDate: new Date(),
    filters: {
      type: '',
      status: '',
      channel: '',
      search: ''
    },
    // Events state
    events: [],
    eventsOverview: null,
    eventFilters: {
      year: '',  // Empty = show all years (user can filter via dropdown)
      status: ''
    },
    // Content view state (NEW)
    content: {
      searchQuery: '',
      selectedSolution: '',
      allContent: [],
      filteredContent: [],
      recentBlurbs: [],
      mostUsed: []
    },
    // Assets view state (NEW)
    assets: {
      all: [],
      filtered: [],
      filters: { type: '', solution: '' },
      searchQuery: ''
    },
    // Save guards to prevent double-submit
    isSavingEvent: false,
    isSavingStory: false,
    isSubmittingNewEvent: false,
    isSavingAsset: false,
    // Asset form state
    assetForm: {
      solutions: [],
      contacts: [],
      agencies: [],
      selectedSolutions: [],  // Additional solutions (beyond primary)
      selectedContacts: [],
      selectedTags: []
    }
  };

  // Navigation ID for abandoning stale loads
  var commsNavId = null;

  /**
   * Copy text to clipboard and show feedback
   * @param {string} text - Text to copy
   * @param {HTMLElement} button - Button element to show feedback on
   */
  function copyToClipboard(text, button) {
    navigator.clipboard.writeText(text).then(function() {
      // Show success feedback
      if (button) {
        var originalHtml = button.innerHTML;
        button.classList.add('copied');
        button.innerHTML = '<span class="material-icons">check</span>Copied!';
        setTimeout(function() {
          button.classList.remove('copied');
          button.innerHTML = originalHtml;
        }, 1500);
      }
      // Optional: track usage if asset ID provided
      var assetId = button ? button.dataset.assetId : null;
      if (assetId) {
        google.script.run
          .withFailureHandler(function(err) {
            // Silent fail for analytics - don't interrupt user flow
            console.log('Failed to record asset usage:', err);
          })
          .recordCommsAssetUsage(assetId);
      }
    }).catch(function(err) {
      console.error('Failed to copy:', err);
      window.showError('Failed to copy to clipboard');
    });
  }

  function init() {
    // Capture navigation ID to detect if user navigates away during load
    commsNavId = getNavigationId();

    // Initialize rich text fields
    initRichTextField('storyNotes', 'Additional notes...');
    initRichTextField('newEventNotes', 'Any additional details...');

    // Set initial view (Content is the new default)
    setView(state.currentView || 'content');

    // Load data for Manage tab (pipeline, coverage) in background
    // These are loaded but not displayed until user switches to Manage
    loadOverview();
    loadStories();
    loadOpportunities();
    loadCoverage();
  }

  function loadOverview() {
    var navId = commsNavId;
    // Use CachedAPI for comms overview (15 min TTL)
    CachedAPI.getCommsOverview()
      .then(function(overview) {
        // Abandon if user navigated away
        if (!isNavigationCurrent(navId)) {
          console.log('[Comms] Abandoning overview load - user navigated away');
          return;
        }
        state.overview = overview;
        renderStats(overview);
      })
      .catch(function(error) {
        if (!isNavigationCurrent(navId)) return;
        console.error('Failed to load overview:', error);
      });
  }

  function loadStories() {
    var navId = commsNavId;
    google.script.run
      .withSuccessHandler(function(stories) {
        // Abandon if user navigated away
        if (!isNavigationCurrent(navId)) {
          console.log('[Comms] Abandoning stories load - user navigated away');
          return;
        }
        state.stories = stories || [];
        renderPipeline();
      })
      .withFailureHandler(function(error) {
        if (!isNavigationCurrent(navId)) return;
        console.error('Failed to load stories:', error);
        showPipelineError('Failed to load stories');
      })
      .getPipelineStoriesForUI();
  }

  function loadOpportunities() {
    var navId = commsNavId;
    google.script.run
      .withSuccessHandler(function(opportunities) {
        // Abandon if user navigated away
        if (!isNavigationCurrent(navId)) {
          console.log('[Comms] Abandoning opportunities load - user navigated away');
          return;
        }
        state.opportunities = opportunities;
        renderOpportunities();
      })
      .withFailureHandler(function(error) {
        if (!isNavigationCurrent(navId)) return;
        console.error('Failed to load opportunities:', error);
        document.getElementById('opportunitiesPanel').innerHTML =
          '<div class="empty-state"><p>Could not load opportunities</p></div>';
      })
      .detectStoryOpportunities();
  }

  function loadCoverage() {
    var navId = commsNavId;
    google.script.run
      .withSuccessHandler(function(coverage) {
        // Abandon if user navigated away
        if (!isNavigationCurrent(navId)) {
          console.log('[Comms] Abandoning coverage load - user navigated away');
          return;
        }
        state.coverage = coverage;
        renderCoverageGaps();
        renderCoverageView();
      })
      .withFailureHandler(function(error) {
        if (!isNavigationCurrent(navId)) return;
        console.error('Failed to load coverage:', error);
        var panel = document.getElementById('coverageGapsPanel');
        if (panel) {
          panel.innerHTML = '<div class="empty-state"><p>Could not load coverage data</p></div>';
        }
      })
      .getCoverageAnalysis(90);
  }

  function renderStats(overview) {
    if (!overview) return;
    // Guard for SPA navigation
    var el1 = document.getElementById('statTotalStories');
    var el2 = document.getElementById('statInPipeline');
    var el3 = document.getElementById('statPublishedQtr');
    var el4 = document.getElementById('statCoverageGaps');
    if (!el1 || !el2 || !el3 || !el4) return;

    el1.textContent = overview.stats ? overview.stats.total_stories : 0;
    el2.textContent = overview.stats ? overview.stats.active_pipeline : 0;
    el3.textContent = overview.stats ? overview.stats.published_this_quarter : 0;
    el4.textContent = overview.coverage_gaps_count || 0;
  }

  function renderPipeline() {
    var statuses = ['idea', 'researching', 'drafting', 'review', 'published'];
    var storiesByStatus = {};

    statuses.forEach(function(s) {
      storiesByStatus[s] = [];
    });

    var filteredStories = applyFiltersToStories(state.stories);

    filteredStories.forEach(function(story) {
      var status = (story.status || 'idea').toLowerCase();
      if (storiesByStatus[status]) {
        storiesByStatus[status].push(story);
      }
    });

    statuses.forEach(function(status) {
      var containerId = 'cards' + capitalizeFirst(status);
      var countId = 'count' + capitalizeFirst(status);
      var container = document.getElementById(containerId);
      var countEl = document.getElementById(countId);
      if (!container || !countEl) return; // Guard for SPA navigation
      var stories = storiesByStatus[status];

      countEl.textContent = stories.length;

      if (stories.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: var(--space-md);"><p style="font-size: var(--font-size-xs);">No stories</p></div>';
      } else {
        container.innerHTML = stories.slice(0, 15).map(function(s) {
          return renderStoryCard(s);
        }).join('');
      }
    });
}

  function renderStoryCard(story) {
    var typeClass = 'type-' + (story.content_type || 'story');
    var typeNames = {
      'story': 'Story',
      'web_content': 'Web',
      'social_media': 'Social',
      'external_mention': 'External',
      'nugget': 'Nugget',
      'key_date': 'Key Date'
    };
    var typeName = typeNames[story.content_type] || 'Story';

    var channelIcons = {
      'web': 'language',
      'social': 'share',
      'slide': 'slideshow',
      'external': 'open_in_new',
      'newsletter': 'mail'
    };
    var channelIcon = channelIcons[story.channel] || 'description';

    var dateStr = story.target_date ? formatDate(story.target_date) : (story.idea_date ? formatDate(story.idea_date) : '');

    var priorityClass = story.priority === 'high' ? 'priority-high' : (story.priority === 'low' ? 'priority-low' : '');

    var html = '<div class="story-card ' + priorityClass + '" draggable="true" ' +
      'data-story-id="' + escapeAttr(story.story_id) + '" ' +
      'ondragstart="COMMS.handleDragStart(event, \'' + escapeAttr(story.story_id) + '\')" ' +
      'ondragend="COMMS.handleDragEnd(event)" ' +
      'onclick="COMMS.showStoryDetail(\'' + escapeAttr(story.story_id) + '\')">';
    html += '<div class="card-header">';
    html += '<span class="card-type ' + typeClass + '">' + typeName + '</span>';
    if (dateStr) html += '<span class="card-date">' + dateStr + '</span>';
    html += '</div>';
    html += '<div class="card-title">' + escapeHtml(story.title || 'Untitled') + '</div>';
    if (story.solution_id) {
      var solDisplay = story.solution_id.length > 30 ? story.solution_id.substring(0, 30) + '...' : story.solution_id;
      html += '<div class="card-solutions">' + escapeHtml(solDisplay) + '</div>';
    }
    html += '<div class="card-meta">';
    html += '<span class="card-channel"><span class="material-icons">' + channelIcon + '</span> ' + (story.channel || 'web') + '</span>';
    if (story.author) html += '<span>' + escapeHtml(story.author) + '</span>';
    html += '</div>';
    html += '</div>';
    return html;
  }

  function renderOpportunities() {
    var container = document.getElementById('opportunitiesPanel');
    if (!container) return; // Guard for SPA navigation
    var opp = state.opportunities;

    if (!opp || opp.summary.total_opportunities === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">flash_on</span><p>No new opportunities detected</p></div>';
      return;
    }

    var html = '';

    // Milestones
    opp.milestones.slice(0, 3).forEach(function(m) {
      html += '<div class="opportunity-item" onclick="COMMS.createStoryFromOpportunity(\'milestone\', \'' + escapeAttr(m.solution_id || '') + '\')">';
      html += '<div class="opportunity-icon milestone"><span class="material-icons">flag</span></div>';
      html += '<div class="opportunity-info">';
      html += '<div class="opportunity-title">' + escapeHtml(m.solution_name) + ' - ' + escapeHtml(m.type) + '</div>';
      html += '<div class="opportunity-desc">' + formatTextWithLinks(m.description) + '</div>';
      html += '</div></div>';
    });

    // T8 Contacts
    opp.t8_contacts.slice(0, 3).forEach(function(c) {
      html += '<div class="opportunity-item" onclick="COMMS.createStoryFromOpportunity(\'t8\', \'' + escapeAttr(c.name) + '\')">';
      html += '<div class="opportunity-icon t8"><span class="material-icons">group</span></div>';
      html += '<div class="opportunity-info">';
      html += '<div class="opportunity-title">' + escapeHtml(c.name) + ' at T8 Impact</div>';
      html += '<div class="opportunity-desc">' + escapeHtml(c.agency || '') + (c.solutions && c.solutions.length ? ' - ' + c.solutions.slice(0, 2).join(', ') : '') + '</div>';
      html += '</div></div>';
    });

    if (!html) {
      html = '<div class="empty-state"><p>No new opportunities</p></div>';
    }

    container.innerHTML = html;
}

  function renderCoverageGaps() {
    var container = document.getElementById('coverageGapsPanel');
    if (!container) return; // Guard for SPA navigation
    var coverage = state.coverage;

    if (!coverage || (coverage.gaps.length === 0 && coverage.uncovered.length === 0)) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">check_circle</span><p>All solutions have recent coverage!</p></div>';
      return;
    }

    var html = '';

    // Gaps (solutions with old stories)
    coverage.gaps.slice(0, 4).forEach(function(g) {
      var severity = g.days_since_story > 180 ? 'severe' : 'moderate';
      html += '<div class="gap-item ' + severity + '">';
      html += '<div class="gap-info">';
      html += '<div class="gap-solution">' + escapeHtml(g.solution_name) + '</div>';
      html += '<div class="gap-days">No stories in ' + g.days_since_story + ' days</div>';
      html += '</div>';
      html += '<button class="gap-action" onclick="COMMS.suggestStory(\'' + escapeAttr(g.solution_id || '') + '\')">Suggest Story</button>';
      html += '</div>';
    });

    // Uncovered (no stories ever)
    coverage.uncovered.slice(0, 3).forEach(function(u) {
      html += '<div class="gap-item severe">';
      html += '<div class="gap-info">';
      html += '<div class="gap-solution">' + escapeHtml(u.solution_name) + '</div>';
      html += '<div class="gap-days">No stories ever</div>';
      html += '</div>';
      html += '<button class="gap-action" onclick="COMMS.suggestStory(\'' + escapeAttr(u.solution_id || '') + '\')">Suggest Story</button>';
      html += '</div>';
    });

    container.innerHTML = html;
  }

  function renderCoverageView() {
    var coverage = state.coverage;
    if (!coverage) return;

    // Guard for SPA navigation - elements may not exist
    var wellCoveredEl = document.getElementById('coverageWellCovered');
    var needsAttentionEl = document.getElementById('coverageNeedsAttention');
    var noStoriesEl = document.getElementById('coverageNoStories');
    var tbody = document.getElementById('coverageTableBody');

    if (!wellCoveredEl || !tbody) return; // Elements don't exist, user navigated away

    wellCoveredEl.textContent = coverage.well_covered || 0;
    if (needsAttentionEl) needsAttentionEl.textContent = coverage.needs_attention || 0;
    if (noStoriesEl) noStoriesEl.textContent = coverage.no_stories || 0;

    // Render table
    var allSolutions = []
      .concat(coverage.gaps || [])
      .concat(coverage.uncovered || [])
      .concat(coverage.covered || []);

    if (allSolutions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No coverage data available</td></tr>';
      return;
    }

    // Sort by days_since_story descending (worst first)
    allSolutions.sort(function(a, b) {
      var aVal = a.days_since_story != null ? a.days_since_story : 9999;
      var bVal = b.days_since_story != null ? b.days_since_story : 9999;
      return bVal - aVal;
    });

    var html = '';
    allSolutions.slice(0, 50).forEach(function(sol) {
      var statusClass, statusText;
      if (sol.total_stories === 0) {
        statusClass = 'uncovered';
        statusText = 'No Coverage';
      } else if (sol.days_since_story > 90) {
        statusClass = 'attention';
        statusText = 'Needs Attention';
      } else {
        statusClass = 'covered';
        statusText = 'Covered';
      }

      var displayName = sol.solution_name || sol.solution_id || '--';
      var solId = sol.solution_id || '';

      html += '<tr>';
      html += '<td><strong>' + escapeHtml(displayName) + '</strong></td>';
      html += '<td>' + escapeHtml(sol.phase || '--') + '</td>';
      html += '<td>' + (sol.total_stories || 0) + '</td>';
      html += '<td>' + (sol.recent_stories || 0) + '</td>';
      html += '<td>' + (sol.last_story_date ? formatDate(sol.last_story_date) : '--') + '</td>';
      html += '<td>' + (sol.days_since_story != null ? sol.days_since_story : '--') + '</td>';
      html += '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>';
      html += '<td><button class="btn btn-sm btn-secondary" onclick="COMMS.suggestStory(\'' + escapeAttr(solId) + '\')">+ Story</button></td>';
      html += '</tr>';
    });

    tbody.innerHTML = html;
  }

  function applyFiltersToStories(stories) {
    var filters = state.filters;
    return stories.filter(function(s) {
      if (filters.type && s.content_type !== filters.type) return false;
      if (filters.status && s.status !== filters.status) return false;
      if (filters.channel && s.channel !== filters.channel) return false;
      if (filters.search) {
        var searchLower = filters.search.toLowerCase();
        var titleMatch = s.title && s.title.toLowerCase().includes(searchLower);
        var solMatch = s.solution_id && s.solution_id.toLowerCase().includes(searchLower);
        if (!titleMatch && !solMatch) return false;
      }
      return true;
    });
  }

  function applyFilters() {
    var typeEl = document.getElementById('filterType');
    var statusEl = document.getElementById('filterStatus');
    var channelEl = document.getElementById('filterChannel');
    var searchEl = document.getElementById('searchInput');

    state.filters.type = typeEl ? typeEl.value : '';
    state.filters.status = statusEl ? statusEl.value : '';
    state.filters.channel = channelEl ? channelEl.value : '';
    state.filters.search = searchEl ? searchEl.value : '';
    renderPipeline();
  }

  function setView(view) {
    state.currentView = view;

    // Update main tab buttons
    document.querySelectorAll('.view-btn').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.view === view);
    });

    // Hide all main view panels
    var mainViews = ['contentView', 'assetsView', 'eventsView', 'manageView'];
    mainViews.forEach(function(viewId) {
      var el = document.getElementById(viewId);
      if (el) el.classList.remove('active');
    });

    // Hide legacy view panels (they're shown within Manage sub-tabs)
    var legacyViews = ['pipelineView', 'coverageView', 'calendarView', 'messagingView', 'toolsView'];
    legacyViews.forEach(function(viewId) {
      var el = document.getElementById(viewId);
      if (el) el.classList.remove('active');
    });

    // Hide pipeline stats - no longer shown in reorganized Comms
    var pipelineStats = document.getElementById('pipelineStatsRow');
    if (pipelineStats) {
      pipelineStats.style.display = 'none';
    }

    // Show/hide the manage subtabs bar
    var subtabsBar = document.getElementById('manageSubtabsBar');
    if (subtabsBar) {
      subtabsBar.style.display = (view === 'manage') ? '' : 'none';
    }

    // Show the selected main view (except for manage which uses legacy views)
    if (view !== 'manage') {
      var viewEl = document.getElementById(view + 'View');
      if (viewEl) viewEl.classList.add('active');
    }

    // Handle view-specific loading
    if (view === 'content') {
      loadContentView();
    }

    if (view === 'assets') {
      loadAssetsView();
    }

    if (view === 'events') {
      loadEvents();
    }

    if (view === 'manage') {
      // Show the current manage sub-tab (this shows the legacy view panels)
      setManageSubtab(state.manageSubtab || 'pipeline');
    }
  }

  /**
   * Switch between sub-tabs within the Manage view
   */
  function setManageSubtab(subtab) {
    state.manageSubtab = subtab;

    // Update sub-tab buttons in the standalone bar
    document.querySelectorAll('#manageSubtabsBar .manage-subtab').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.subtab === subtab);
    });

    // Hide all legacy view panels and manage panels
    var managePanels = ['pipelineView', 'coverageView', 'calendarView', 'messagingView', 'manageView'];
    managePanels.forEach(function(panelId) {
      var el = document.getElementById(panelId);
      if (el) {
        el.classList.remove('active');
        el.style.display = 'none';
      }
    });

    // Stats bar removed from Manage view - keep hidden
    var pipelineStats = document.getElementById('pipelineStatsRow');
    if (pipelineStats) {
      pipelineStats.style.display = 'none';
    }

    // Show the selected sub-tab panel and load its content
    if (subtab === 'pipeline') {
      var pipelineEl = document.getElementById('pipelineView');
      if (pipelineEl) {
        pipelineEl.classList.add('active');
        pipelineEl.style.display = '';
      }
      // Pipeline should already be loaded by init()
    }

    if (subtab === 'coverage') {
      var coverageEl = document.getElementById('coverageView');
      if (coverageEl) {
        coverageEl.classList.add('active');
        coverageEl.style.display = '';
      }
      if (state.coverage) {
        renderCoverageView();
      } else {
        loadCoverage();
      }
    }

    if (subtab === 'calendar') {
      var calendarEl = document.getElementById('calendarView');
      if (calendarEl) {
        calendarEl.classList.add('active');
        calendarEl.style.display = '';
      }
      renderCalendar();
      loadUpcomingTargets();
      renderCommsDue();
    }

    if (subtab === 'priorities') {
      // Show the messaging view for priorities (it has the priority chips)
      var messagingEl = document.getElementById('messagingView');
      if (messagingEl) {
        messagingEl.classList.add('active');
        messagingEl.style.display = '';
      }
      renderPrioritiesView();
      loadBlurbs();
      renderMessagesView();
    }
  }

  // ========================================================================
  // CONTENT VIEW FUNCTIONS
  // ========================================================================

  var contentSearchTimer = null;  // Debounce timer for search

  /**
   * Load the Content view
   */
  function loadContentView() {
    // Populate solution dropdown if not already done
    var solutionSelect = document.getElementById('contentSolutionSelect');
    if (solutionSelect && solutionSelect.options.length <= 1) {
      populateContentSolutionDropdown();
    }

    // Load all content assets for client-side search (use cache)
    if (state.content.allContent.length === 0) {
      // Show loading state
      var quickAccess = document.getElementById('contentQuickAccess');
      if (quickAccess) {
        quickAccess.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><p>Loading content...</p></div>';
      }

      google.script.run
        .withSuccessHandler(function(data) {
          if (!isNavigationCurrent(commsNavId)) return;
          state.content.allContent = data || [];
          // Restore quick access cards
          renderQuickAccessCards();
        })
        .withFailureHandler(function(err) {
          handleError(err);
          renderQuickAccessCards();
        })
        .getAllCommsAssets();
    }
  }

  /**
   * Render quick access cards
   */
  function renderQuickAccessCards() {
    var quickAccess = document.getElementById('contentQuickAccess');
    if (!quickAccess) return;

    quickAccess.innerHTML = '<div class="quick-access-grid">' +
      '<div class="quick-access-card" onclick="COMMS.showRecentBlurbs()">' +
        '<span class="material-icons">history</span>' +
        '<h4>Recent Blurbs</h4>' +
        '<p>Latest HQ updates and highlights</p>' +
      '</div>' +
      '<div class="quick-access-card" onclick="COMMS.showMostUsed()">' +
        '<span class="material-icons">trending_up</span>' +
        '<h4>Most Used</h4>' +
        '<p>Frequently copied content</p>' +
      '</div>' +
      '<div class="quick-access-card" onclick="COMMS.showByType()">' +
        '<span class="material-icons">category</span>' +
        '<h4>By Type</h4>' +
        '<p>Browse talking points, facts, quotes</p>' +
      '</div>' +
    '</div>';
  }

  /**
   * Populate the Content solution dropdown
   */
  function populateContentSolutionDropdown() {
    var select = document.getElementById('contentSolutionSelect');
    if (!select) return;

    // Use cached solutions if available
    CachedAPI.getSolutions()
      .then(function(solutions) {
        if (!isNavigationCurrent(commsNavId)) return;
        state.assetForm.solutions = solutions || [];

        // Clear and rebuild options
        select.innerHTML = '<option value="">All Solutions</option>';
        solutions.forEach(function(sol) {
          var opt = document.createElement('option');
          opt.value = sol.core_id;
          opt.textContent = sol.core_official_name || sol.core_id;
          select.appendChild(opt);
        });

        // Also populate assets filter if it exists
        populateAssetSolutionFilter();
      })
      .catch(handleError);
  }

  /**
   * Search content by query (debounced, client-side when possible)
   */
  function searchContent(query) {
    state.content.searchQuery = query;

    // Hide quick access, show search results
    var quickAccess = document.getElementById('contentQuickAccess');
    var solutionPanel = document.getElementById('solutionContentPanel');
    var searchPanel = document.getElementById('searchResultsPanel');

    if (!query || query.length < 2) {
      // Show quick access, hide others
      if (quickAccess) quickAccess.style.display = '';
      if (solutionPanel) solutionPanel.style.display = 'none';
      if (searchPanel) searchPanel.style.display = 'none';
      return;
    }

    // Show search results panel immediately
    if (quickAccess) quickAccess.style.display = 'none';
    if (solutionPanel) solutionPanel.style.display = 'none';
    if (searchPanel) searchPanel.style.display = '';

    // Update query display
    var queryEl = document.getElementById('searchResultsQuery');
    if (queryEl) queryEl.textContent = '"' + query + '"';

    // Debounce the actual search
    if (contentSearchTimer) clearTimeout(contentSearchTimer);
    contentSearchTimer = setTimeout(function() {
      performContentSearch(query);
    }, 200);  // 200ms debounce
  }

  /**
   * Perform the actual content search (client-side if data loaded)
   */
  function performContentSearch(query) {
    var lowerQuery = query.toLowerCase();

    // Client-side search if we have content loaded
    if (state.content.allContent.length > 0) {
      var results = state.content.allContent.filter(function(item) {
        var searchText = [
          item.title || '',
          item.content || '',
          item.solution_ids || '',
          item.tags || '',
          item.source_name || ''
        ].join(' ').toLowerCase();
        return searchText.includes(lowerQuery);
      });

      // Group by type
      var grouped = groupContentByType(results);
      renderSearchResults({ query: query, total: results.length, results: grouped });
      return;
    }

    // Fallback to API search if content not loaded yet
    google.script.run
      .withSuccessHandler(function(data) {
        if (!isNavigationCurrent(commsNavId)) return;
        renderSearchResults(data);
      })
      .withFailureHandler(handleError)
      .searchWhatToSay(query);
  }

  /**
   * Group content items by type
   */
  function groupContentByType(items) {
    var grouped = {
      talking_point: [],
      fact: [],
      quote: [],
      blurb: [],
      soundbite: [],
      boilerplate: [],
      connection: []
    };

    items.forEach(function(item) {
      var type = item.asset_type || 'blurb';
      if (grouped[type]) {
        grouped[type].push(item);
      }
    });

    return grouped;
  }

  /**
   * Select a solution to view its content
   */
  function selectContentSolution(solutionId) {
    state.content.selectedSolution = solutionId;

    // Clear search input when selecting solution
    var searchInput = document.getElementById('contentSearchInput');
    if (searchInput) searchInput.value = '';

    // Hide quick access and search, show solution panel
    var quickAccess = document.getElementById('contentQuickAccess');
    var solutionPanel = document.getElementById('solutionContentPanel');
    var searchPanel = document.getElementById('searchResultsPanel');

    if (!solutionId) {
      // Show quick access
      if (quickAccess) quickAccess.style.display = '';
      if (solutionPanel) solutionPanel.style.display = 'none';
      if (searchPanel) searchPanel.style.display = 'none';
      return;
    }

    // Show solution panel
    if (quickAccess) quickAccess.style.display = 'none';
    if (solutionPanel) solutionPanel.style.display = '';
    if (searchPanel) searchPanel.style.display = 'none';

    // Update title
    var titleEl = document.getElementById('solutionContentTitle');
    var solutions = state.assetForm.solutions || [];
    var sol = solutions.find(function(s) { return s.core_id === solutionId; });
    if (titleEl) titleEl.textContent = sol ? sol.core_official_name : solutionId;

    // Client-side filter if content is loaded
    if (state.content.allContent.length > 0) {
      var lowerSolutionId = solutionId.toLowerCase();
      var results = state.content.allContent.filter(function(item) {
        var solutionIds = (item.solution_ids || '').toLowerCase();
        return solutionIds.includes(lowerSolutionId);
      });
      var grouped = groupContentByType(results);
      renderSolutionContent({ results: grouped });
      return;
    }

    // Fallback to API if content not loaded
    google.script.run
      .withSuccessHandler(function(data) {
        if (!isNavigationCurrent(commsNavId)) return;
        renderSolutionContent(data);
      })
      .withFailureHandler(handleError)
      .searchWhatToSay(solutionId);
  }

  /**
   * Render search results grouped by type
   */
  function renderSearchResults(data) {
    var countEl = document.getElementById('searchResultsCount');
    if (countEl) countEl.textContent = data.total + ' results';

    var sectionsEl = document.getElementById('searchResultsSections');
    if (!sectionsEl) return;

    renderContentSections(sectionsEl, data.results);
  }

  /**
   * Render solution content grouped by type
   */
  function renderSolutionContent(data) {
    var sectionsEl = document.getElementById('contentTypeSections');
    if (!sectionsEl) return;

    renderContentSections(sectionsEl, data.results);
  }

  /**
   * Render content sections (shared by search results and solution content)
   */
  function renderContentSections(container, results) {
    var typeConfig = [
      { key: 'talking_point', icon: 'format_quote', label: 'Key Messages' },
      { key: 'fact', icon: 'analytics', label: 'Facts & Stats' },
      { key: 'quote', icon: 'chat', label: 'Quotes' },
      { key: 'blurb', icon: 'description', label: 'Blurbs' },
      { key: 'soundbite', icon: 'mic', label: 'Sound Bites' },
      { key: 'boilerplate', icon: 'article', label: 'Boilerplate' },
      { key: 'connection', icon: 'hub', label: 'Connections' }
    ];

    var html = '';

    typeConfig.forEach(function(type) {
      var items = results[type.key] || [];
      if (items.length === 0) return;

      html += '<div class="content-type-section">';
      html += '<div class="content-type-header">';
      html += '<span class="material-icons">' + type.icon + '</span>';
      html += '<h4>' + type.label + '</h4>';
      html += '<span class="count-badge">' + items.length + '</span>';
      html += '</div>';
      html += '<div class="content-type-items">';

      items.forEach(function(item) {
        html += renderContentItem(item);
      });

      html += '</div></div>';
    });

    if (!html) {
      html = '<div class="empty-state"><span class="material-icons">search_off</span><p>No content found</p></div>';
    }

    container.innerHTML = html;
  }

  /**
   * Render a single content item
   */
  function renderContentItem(item) {
    var html = '<div class="content-item" data-asset-id="' + escapeAttr(item.asset_id) + '">';
    html += '<div class="content-item-text">' + escapeHtml(item.content || item.title || '') + '</div>';
    html += '<div class="content-item-actions">';
    html += '<button class="btn btn-icon" onclick="COMMS.copyContentItem(\'' + escapeAttr(item.asset_id) + '\', this)" title="Copy">';
    html += '<span class="material-icons">content_copy</span>';
    html += '</button>';
    html += '</div>';
    html += '</div>';
    return html;
  }

  /**
   * Copy content item to clipboard
   */
  function copyContentItem(assetId, btnEl) {
    var itemEl = btnEl.closest('.content-item');
    var textEl = itemEl ? itemEl.querySelector('.content-item-text') : null;
    if (!textEl) return;

    var text = textEl.textContent;

    navigator.clipboard.writeText(text).then(function() {
      // Visual feedback
      var icon = btnEl.querySelector('.material-icons');
      if (icon) {
        icon.textContent = 'check';
        setTimeout(function() { icon.textContent = 'content_copy'; }, 2000);
      }

      // Track usage
      google.script.run
        .withFailureHandler(function(err) {
          // Silent fail for analytics
          console.log('Failed to record asset usage:', err);
        })
        .recordCommsAssetUsage(assetId);
    }).catch(function() {
      showToast('Failed to copy', 'error');
    });
  }

  /**
   * Copy all content for the selected solution
   */
  function copyAllContent() {
    var solutionId = state.content.selectedSolution;
    if (!solutionId) return;

    google.script.run
      .withSuccessHandler(function(data) {
        if (!isNavigationCurrent(commsNavId)) return;

        var text = '';
        var types = ['talking_point', 'fact', 'quote', 'blurb'];
        types.forEach(function(type) {
          var items = data.results[type] || [];
          if (items.length > 0) {
            text += '=== ' + type.toUpperCase().replace('_', ' ') + ' ===\n\n';
            items.forEach(function(item) {
              text += ' ' + (item.content || item.title) + '\n\n';
            });
          }
        });

        navigator.clipboard.writeText(text).then(function() {
          showToast('Copied all content to clipboard');
        }).catch(function() {
          showToast('Failed to copy', 'error');
        });
      })
      .withFailureHandler(handleError)
      .searchWhatToSay(solutionId);
  }

  /**
   * Show recent blurbs (client-side if available)
   */
  function showRecentBlurbs() {
    var searchInput = document.getElementById('contentSearchInput');
    if (searchInput) searchInput.value = '';

    var solutionSelect = document.getElementById('contentSolutionSelect');
    if (solutionSelect) solutionSelect.value = '';

    var quickAccess = document.getElementById('contentQuickAccess');
    var solutionPanel = document.getElementById('solutionContentPanel');
    var searchPanel = document.getElementById('searchResultsPanel');

    if (quickAccess) quickAccess.style.display = 'none';
    if (solutionPanel) solutionPanel.style.display = 'none';
    if (searchPanel) searchPanel.style.display = '';

    var queryEl = document.getElementById('searchResultsQuery');
    if (queryEl) queryEl.textContent = 'Recent Blurbs';

    // Client-side if content loaded
    if (state.content.allContent.length > 0) {
      var blurbs = state.content.allContent
        .filter(function(item) { return item.asset_type === 'blurb'; })
        .sort(function(a, b) {
          var dateA = a.date_captured || a.created_at || '';
          var dateB = b.date_captured || b.created_at || '';
          return dateB.localeCompare(dateA);
        })
        .slice(0, 20);

      var countEl = document.getElementById('searchResultsCount');
      if (countEl) countEl.textContent = blurbs.length + ' results';

      var sectionsEl = document.getElementById('searchResultsSections');
      if (sectionsEl) {
        renderContentSections(sectionsEl, { blurb: blurbs });
      }
      return;
    }

    // Fallback to API
    google.script.run
      .withSuccessHandler(function(blurbs) {
        if (!isNavigationCurrent(commsNavId)) return;

        var countEl = document.getElementById('searchResultsCount');
        if (countEl) countEl.textContent = blurbs.length + ' results';

        var sectionsEl = document.getElementById('searchResultsSections');
        if (sectionsEl) {
          renderContentSections(sectionsEl, { blurb: blurbs });
        }
      })
      .withFailureHandler(handleError)
      .getHighlighterBlurbsFromAssets(20);
  }

  /**
   * Show most used content (client-side if available)
   */
  function showMostUsed() {
    var searchInput = document.getElementById('contentSearchInput');
    if (searchInput) searchInput.value = '';

    var solutionSelect = document.getElementById('contentSolutionSelect');
    if (solutionSelect) solutionSelect.value = '';

    var quickAccess = document.getElementById('contentQuickAccess');
    var solutionPanel = document.getElementById('solutionContentPanel');
    var searchPanel = document.getElementById('searchResultsPanel');

    if (quickAccess) quickAccess.style.display = 'none';
    if (solutionPanel) solutionPanel.style.display = 'none';
    if (searchPanel) searchPanel.style.display = '';

    var queryEl = document.getElementById('searchResultsQuery');
    if (queryEl) queryEl.textContent = 'Most Used';

    // Client-side if content loaded
    if (state.content.allContent.length > 0) {
      var mostUsed = state.content.allContent
        .filter(function(item) { return (item.use_count || 0) > 0; })
        .sort(function(a, b) { return (b.use_count || 0) - (a.use_count || 0); })
        .slice(0, 20);

      var countEl = document.getElementById('searchResultsCount');
      if (countEl) countEl.textContent = mostUsed.length + ' results';

      var sectionsEl = document.getElementById('searchResultsSections');
      if (sectionsEl) {
        var grouped = groupContentByType(mostUsed);
        renderContentSections(sectionsEl, grouped);
      }
      return;
    }

    // Fallback to API
    google.script.run
      .withSuccessHandler(function(summary) {
        if (!isNavigationCurrent(commsNavId)) return;

        var mostUsed = summary.most_used || [];
        var countEl = document.getElementById('searchResultsCount');
        if (countEl) countEl.textContent = mostUsed.length + ' results';

        var sectionsEl = document.getElementById('searchResultsSections');
        if (sectionsEl) {
          var grouped = groupContentByType(mostUsed);
          renderContentSections(sectionsEl, grouped);
        }
      })
      .withFailureHandler(handleError)
      .getCommsAssetsSummary();
  }

  /**
   * Show content by type (quick links)
   */
  function showByType() {
    // For now, just load all content and let user search
    var searchInput = document.getElementById('contentSearchInput');
    if (searchInput) {
      searchInput.focus();
      searchInput.placeholder = 'Search by type: blurb, quote, fact...';
    }
  }

  /**
   * Reset Content view to show quick access cards
   */
  function resetContentView() {
    // Clear search and solution selection
    var searchInput = document.getElementById('contentSearchInput');
    if (searchInput) {
      searchInput.value = '';
      searchInput.placeholder = 'What do you need content about?';
    }

    var solutionSelect = document.getElementById('contentSolutionSelect');
    if (solutionSelect) solutionSelect.value = '';

    // Reset state
    state.content.searchQuery = '';
    state.content.selectedSolution = '';

    // Show quick access, hide others
    var quickAccess = document.getElementById('contentQuickAccess');
    var solutionPanel = document.getElementById('solutionContentPanel');
    var searchPanel = document.getElementById('searchResultsPanel');

    if (quickAccess) quickAccess.style.display = '';
    if (solutionPanel) solutionPanel.style.display = 'none';
    if (searchPanel) searchPanel.style.display = 'none';
  }

  // ========================================================================
  // ASSETS VIEW FUNCTIONS
  // ========================================================================

  /**
   * Load the Assets view
   */
  function loadAssetsView() {
    // Populate solution filter dropdown if not already done
    var solutionFilter = document.getElementById('assetSolutionFilter');
    if (solutionFilter && solutionFilter.options.length <= 1) {
      populateAssetSolutionFilter();
    }

    // Load assets - try getFileAssets first, fallback to getAllCommsAssets
    google.script.run
      .withSuccessHandler(function(data) {
        if (!isNavigationCurrent(commsNavId)) return;

        // Filter client-side for assets with URLs or file types
        var fileTypes = ['image', 'presentation', 'pdf', 'video', 'document', 'graphic'];
        var fileAssets = (data || []).filter(function(a) {
          // Has a file-type asset_type
          if (fileTypes.includes(a.asset_type)) return true;
          // Has asset_url filled in
          if (a.asset_url && String(a.asset_url).trim()) return true;
          // Has source_url that looks like a file (Drive, image, etc.)
          if (a.source_url && String(a.source_url).includes('drive.google.com')) return true;
          return false;
        });

        state.assets.all = fileAssets;
        state.assets.filtered = fileAssets;
        renderAssetsGrid();
      })
      .withFailureHandler(handleError)
      .getAllCommsAssets();
  }

  /**
   * Populate the Assets solution filter dropdown
   */
  function populateAssetSolutionFilter() {
    var select = document.getElementById('assetSolutionFilter');
    if (!select) return;

    var solutions = state.assetForm.solutions || [];
    if (solutions.length === 0) {
      // Will be populated when assetForm.solutions is loaded
      return;
    }

    select.innerHTML = '<option value="">All Solutions</option>';
    solutions.forEach(function(sol) {
      var opt = document.createElement('option');
      opt.value = sol.core_id;
      opt.textContent = sol.core_official_name || sol.core_id;
      select.appendChild(opt);
    });
  }

  /**
   * Filter assets based on type, solution, and search
   */
  function filterAssets() {
    var typeFilter = document.getElementById('assetTypeFilter');
    var solutionFilter = document.getElementById('assetSolutionFilter');
    var searchInput = document.getElementById('assetsSearchInput');

    var type = typeFilter ? typeFilter.value : '';
    var solution = solutionFilter ? solutionFilter.value : '';
    var query = searchInput ? searchInput.value.toLowerCase() : '';

    state.assets.filters.type = type;
    state.assets.filters.solution = solution;
    state.assets.searchQuery = query;

    state.assets.filtered = state.assets.all.filter(function(asset) {
      // Type filter
      if (type && asset.asset_file_type !== type && asset.asset_type !== type) {
        return false;
      }

      // Solution filter
      if (solution) {
        var solutionIds = (asset.solution_ids || '').toLowerCase();
        if (!solutionIds.includes(solution.toLowerCase())) {
          return false;
        }
      }

      // Search filter
      if (query) {
        var searchText = [asset.title, asset.content, asset.tags, asset.solution_ids].join(' ').toLowerCase();
        if (!searchText.includes(query)) {
          return false;
        }
      }

      return true;
    });

    renderAssetsGrid();
  }

  /**
   * Render the assets grid
   */
  function renderAssetsGrid() {
    var grid = document.getElementById('assetsGrid');
    if (!grid) return;

    var assets = state.assets.filtered;

    if (assets.length === 0) {
      grid.innerHTML = '<div class="empty-state"><span class="material-icons">perm_media</span><p>No assets found</p></div>';
      return;
    }

    var html = assets.map(function(asset) {
      return renderAssetCard(asset);
    }).join('');

    grid.innerHTML = html;
  }

  /**
   * Render a single asset card
   */
  function renderAssetCard(asset) {
    var thumbnailHtml = '';

    // Use iframe preview for Drive files
    if (asset.asset_url && asset.asset_url.includes('drive.google.com')) {
      var match = asset.asset_url.match(/[-\w]{25,}/);
      if (match) {
        var fileId = match[0];
        thumbnailHtml = '<iframe src="https://drive.google.com/file/d/' + fileId + '/preview" loading="lazy"></iframe>';
      } else {
        var icon = getFileTypeIcon(asset.asset_file_type || asset.asset_type);
        thumbnailHtml = '<span class="material-icons">' + icon + '</span>';
      }
    } else {
      var icon = getFileTypeIcon(asset.asset_file_type || asset.asset_type);
      thumbnailHtml = '<span class="material-icons">' + icon + '</span>';
    }

    var solutionDisplay = (asset.solution_ids || '').split(',')[0] || '';

    var html = '<div class="asset-card" onclick="COMMS.showAssetDetail(\'' + escapeAttr(asset.asset_id) + '\')">';
    html += '<div class="asset-card-thumbnail">' + thumbnailHtml + '</div>';
    html += '<div class="asset-card-info">';
    html += '<div class="asset-card-title">' + escapeHtml(asset.title || 'Untitled') + '</div>';
    html += '<div class="asset-card-meta">' + escapeHtml(solutionDisplay) + '</div>';
    html += '</div>';
    html += '<div class="asset-card-actions">';
    html += '<button class="btn btn-secondary" onclick="event.stopPropagation(); COMMS.copyAssetLink(\'' + escapeAttr(asset.asset_id) + '\')">Copy Link</button>';
    html += '</div>';
    html += '</div>';
    return html;
  }

  /**
   * Get icon for file type
   */
  function getFileTypeIcon(fileType) {
    var icons = {
      'image': 'image',
      'presentation': 'slideshow',
      'pdf': 'picture_as_pdf',
      'video': 'videocam',
      'document': 'description',
      'graphic': 'brush'
    };
    return icons[fileType] || 'insert_drive_file';
  }

  /**
   * Show asset detail modal with preview
   */
  function showAssetDetail(assetId) {
    var asset = state.assets.all.find(function(a) { return a.asset_id === assetId; });
    if (!asset) return;

    var modal = document.getElementById('assetDetailModal');
    var titleEl = document.getElementById('assetDetailTitle');
    var previewContainer = document.getElementById('assetPreviewContainer');
    var infoContainer = document.getElementById('assetDetailInfo');

    // Store asset info on modal for footer buttons
    modal.dataset.assetId = assetId;
    modal.dataset.assetUrl = asset.asset_url || '';

    // Set title
    titleEl.textContent = asset.title || 'Asset Preview';

    // Build preview content
    var previewHtml = '';
    if (asset.asset_url && asset.asset_url.includes('drive.google.com')) {
      // Extract file ID and use Drive preview
      var match = asset.asset_url.match(/[-\w]{25,}/);
      if (match) {
        var fileId = match[0];
        previewHtml = '<iframe src="https://drive.google.com/file/d/' + fileId + '/preview" allow="autoplay"></iframe>';
      }
    } else if (asset.asset_url) {
      // Try to show as image or link
      var fileType = asset.asset_file_type || asset.asset_type;
      if (fileType === 'image') {
        previewHtml = '<img src="' + escapeAttr(asset.asset_url) + '" alt="' + escapeAttr(asset.title) + '" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">';
        previewHtml += '<span class="material-icons preview-icon" style="display:none;">broken_image</span>';
      } else {
        var icon = getFileTypeIcon(fileType);
        previewHtml = '<span class="material-icons preview-icon">' + icon + '</span>';
      }
    } else {
      previewHtml = '<span class="material-icons preview-icon">insert_drive_file</span>';
    }
    previewContainer.innerHTML = previewHtml;

    // Build info panel
    var infoHtml = '';

    if (asset.content && !asset.content.startsWith('[File:')) {
      infoHtml += '<div class="detail-row"><div class="detail-label">Description</div><div class="detail-value">' + escapeHtml(asset.content) + '</div></div>';
    }
    if (asset.solution_ids) {
      infoHtml += '<div class="detail-row"><div class="detail-label">Solutions</div><div class="detail-value">' + escapeHtml(asset.solution_ids) + '</div></div>';
    }
    if (asset.asset_file_type) {
      infoHtml += '<div class="detail-row"><div class="detail-label">Type</div><div class="detail-value">' + escapeHtml(asset.asset_file_type) + '</div></div>';
    }
    if (asset.usage_rights) {
      infoHtml += '<div class="detail-row"><div class="detail-label">Usage Rights</div><div class="detail-value">' + escapeHtml(asset.usage_rights) + '</div></div>';
    }
    if (asset.rights_holder) {
      infoHtml += '<div class="detail-row"><div class="detail-label">Rights Holder</div><div class="detail-value">' + escapeHtml(asset.rights_holder) + '</div></div>';
    }
    if (asset.tags) {
      infoHtml += '<div class="detail-row"><div class="detail-label">Tags</div><div class="detail-value">' + escapeHtml(asset.tags) + '</div></div>';
    }
    if (asset.date_captured) {
      infoHtml += '<div class="detail-row"><div class="detail-label">Date Added</div><div class="detail-value">' + escapeHtml(asset.date_captured) + '</div></div>';
    }

    infoContainer.innerHTML = infoHtml || '<p class="text-muted">No additional details available.</p>';

    // Show modal
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  /**
   * Close asset detail modal
   */
  function closeAssetDetailModal() {
    var modal = document.getElementById('assetDetailModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
    // Clear preview to stop any video/audio
    document.getElementById('assetPreviewContainer').innerHTML = '';
  }

  /**
   * Copy asset link to clipboard
   */
  function copyAssetLink(assetId) {
    var asset = state.assets.all.find(function(a) { return a.asset_id === assetId; });
    if (!asset || !asset.asset_url) {
      showToast('No link available', 'error');
      return;
    }

    var text = asset.asset_url;
    if (asset.attribution_text) {
      text += '\n\nAttribution: ' + asset.attribution_text;
    }

    navigator.clipboard.writeText(text).then(function() {
      showToast('Link copied to clipboard');
      google.script.run
        .withFailureHandler(function(err) {
          // Silent fail for analytics
          console.log('Failed to record asset usage:', err);
        })
        .recordCommsAssetUsage(assetId);
    }).catch(function() {
      showToast('Failed to copy', 'error');
    });
  }

  /**
   * Toggle the upload dropzone visibility
   */
  function toggleUploadDropzone() {
    var container = document.getElementById('uploadDropzoneContainer');
    var metadataForm = document.getElementById('uploadMetadataForm');
    var progressContainer = document.getElementById('uploadProgressContainer');

    if (container) {
      var isVisible = container.style.display !== 'none';
      container.style.display = isVisible ? 'none' : '';

      // Hide metadata form and progress when closing
      if (isVisible) {
        if (metadataForm) metadataForm.style.display = 'none';
        if (progressContainer) progressContainer.style.display = 'none';
      }
    }
  }

  /**
   * Handle drag over event
   */
  function handleUploadDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    var dropzone = document.getElementById('uploadDropzone');
    if (dropzone) dropzone.classList.add('drag-over');
  }

  /**
   * Handle drag leave event
   */
  function handleUploadDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    var dropzone = document.getElementById('uploadDropzone');
    if (dropzone) dropzone.classList.remove('drag-over');
  }

  /**
   * Handle file drop event
   */
  function handleUploadDrop(event) {
    event.preventDefault();
    event.stopPropagation();

    var dropzone = document.getElementById('uploadDropzone');
    if (dropzone) dropzone.classList.remove('drag-over');

    var files = event.dataTransfer.files;
    if (files.length > 0) {
      processUploadFiles(files);
    }
  }

  /**
   * Handle file selection via input
   */
  function handleFileSelect(event) {
    var files = event.target.files;
    if (files.length > 0) {
      processUploadFiles(files);
    }
  }

  // Track pending file for upload
  var pendingFile = null;
  var pendingFileBase64 = null;

  /**
   * Process files for upload - show metadata form FIRST
   */
  function processUploadFiles(files) {
    var file = files[0];
    if (!file) return;

    // Read file as base64 and store it
    var reader = new FileReader();
    reader.onload = function(e) {
      pendingFile = file;
      pendingFileBase64 = e.target.result.split(',')[1];  // Remove data:... prefix

      // Show metadata form
      showUploadMetadataForm(file.name);
    };

    reader.onerror = function() {
      showToast('Failed to read file', 'error');
    };

    reader.readAsDataURL(file);
  }

  /**
   * Show metadata form BEFORE upload
   */
  function showUploadMetadataForm(filename) {
    var dropzoneContainer = document.getElementById('uploadDropzoneContainer');
    var metadataForm = document.getElementById('uploadMetadataForm');

    if (dropzoneContainer) dropzoneContainer.style.display = 'none';
    if (metadataForm) metadataForm.style.display = '';

    // Pre-fill title from filename (without extension)
    var titleInput = document.getElementById('uploadAssetTitle');
    if (titleInput) {
      var title = filename.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' ');
      titleInput.value = title;
    }

    // Clear other fields
    var descInput = document.getElementById('uploadAssetDescription');
    if (descInput) descInput.value = '';
    var tagsInput = document.getElementById('uploadAssetTags');
    if (tagsInput) tagsInput.value = '';

    // Populate solution dropdown
    var solutionSelect = document.getElementById('uploadAssetSolution');
    if (solutionSelect) {
      var solutions = state.assetForm.solutions || [];
      solutionSelect.innerHTML = '<option value="">Select solution...</option>';
      solutions.forEach(function(sol) {
        var opt = document.createElement('option');
        opt.value = sol.core_id;
        opt.textContent = sol.core_official_name || sol.core_id;
        solutionSelect.appendChild(opt);
      });
    }
  }

  /**
   * Cancel upload and close form
   */
  function cancelUploadMetadata() {
    var metadataForm = document.getElementById('uploadMetadataForm');
    var progressContainer = document.getElementById('uploadProgressContainer');

    if (metadataForm) metadataForm.style.display = 'none';
    if (progressContainer) progressContainer.style.display = 'none';

    pendingFile = null;
    pendingFileBase64 = null;

    // Reset file input
    var fileInput = document.getElementById('assetFileInput');
    if (fileInput) fileInput.value = '';
  }

  /**
   * Upload file with metadata
   */
  function saveUploadedAsset() {
    if (!pendingFile || !pendingFileBase64) {
      showToast('No file selected', 'error');
      return;
    }

    var title = document.getElementById('uploadAssetTitle').value.trim();
    var solution = document.getElementById('uploadAssetSolution').value;
    var description = document.getElementById('uploadAssetDescription').value.trim();
    var rights = document.getElementById('uploadAssetRights').value;
    var tags = document.getElementById('uploadAssetTags').value.trim();

    if (!title) {
      showToast('Title is required', 'error');
      return;
    }

    // Show progress
    var metadataForm = document.getElementById('uploadMetadataForm');
    var progressContainer = document.getElementById('uploadProgressContainer');
    var filenameEl = document.getElementById('uploadFilename');
    var progressFill = document.getElementById('uploadProgressFill');
    var statusEl = document.getElementById('uploadStatus');

    if (metadataForm) metadataForm.style.display = 'none';
    if (progressContainer) progressContainer.style.display = '';
    if (filenameEl) filenameEl.textContent = pendingFile.name;
    if (progressFill) progressFill.style.width = '30%';
    if (statusEl) {
      statusEl.textContent = 'Uploading to Drive...';
      statusEl.className = 'upload-status';
    }

    // Build metadata object
    var metadata = {
      title: title,
      content: description || title,
      solution_ids: solution,
      usage_rights: rights,
      tags: tags
    };

    // Upload with metadata
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Upload result:', result);
        if (progressFill) progressFill.style.width = '100%';

        if (result && result.success) {
          if (statusEl) {
            statusEl.textContent = 'Uploaded!';
            statusEl.className = 'upload-status success';
          }
          showToast('Asset uploaded successfully');

          // Clear and refresh after short delay
          setTimeout(function() {
            if (progressContainer) progressContainer.style.display = 'none';
            pendingFile = null;
            pendingFileBase64 = null;
            var fileInput = document.getElementById('assetFileInput');
            if (fileInput) fileInput.value = '';
            loadAssetsView();  // Refresh the grid
          }, 1000);
        } else {
          var errorMsg = result ? result.error : 'Upload failed';
          console.error('Upload error:', errorMsg);
          if (statusEl) {
            statusEl.textContent = errorMsg;
            statusEl.className = 'upload-status error';
          }
          showToast(errorMsg, 'error');
        }
      })
      .withFailureHandler(function(error) {
        console.error('Upload failure:', error);
        if (progressFill) progressFill.style.width = '100%';
        var errorMsg = error.message || 'Upload failed';
        if (statusEl) {
          statusEl.textContent = errorMsg;
          statusEl.className = 'upload-status error';
        }
        showToast(errorMsg, 'error');
      })
      .uploadCommsAssetWithMetadata(pendingFileBase64, pendingFile.name, pendingFile.type, metadata);
  }

  /**
   * Show upload asset modal (legacy - now toggles dropzone)
   */
  function showUploadAssetModal() {
    toggleUploadDropzone();
  }

  // ========================================================================
  // MANAGE VIEW FUNCTIONS
  // ========================================================================

  /**
   * Render priorities view within Manage tab
   */
  function renderManagePrioritiesView() {
    // Reuse the existing priorities rendering logic
    renderPrioritiesView();

    // Move the chips to the manage panel
    var sourceChips = document.getElementById('priorityChips');
    var targetChips = document.getElementById('managePriorityChips');
    var sourceDetail = document.getElementById('priorityDetail');
    var targetDetail = document.getElementById('managePriorityDetail');

    // The existing renderPrioritiesView populates the messaging view elements
    // For now, just trigger the load - in a future iteration we could move the HTML
  }

  // Priority data cache
  var priorityData = {
    partnerships: [],
    citizens: [],
    ai_innovation: [],
    science_integrity: [],
    efficiency: [],
    untagged: []
  };

  var priorityConfig = {
    partnerships: { name: 'Partnerships & Decision Support', icon: 'group', id: 'Partnerships' },
    citizens: { name: 'Benefits to American Citizens', icon: 'home', id: 'Citizens' },
    ai_innovation: { name: 'AI Leadership & Tech Innovation', icon: 'memory', id: 'AiInnovation' },
    science_integrity: { name: 'Gold Standard Science & Research Integrity', icon: 'emoji_events', id: 'ScienceIntegrity' },
    efficiency: { name: 'Government Efficiency', icon: 'flash_on', id: 'Efficiency' },
    untagged: { name: 'Not Yet Aligned', icon: 'error', id: 'Untagged' }
  };

  function renderPrioritiesView() {
    // Reset counts
    priorityData = {
      partnerships: [],
      citizens: [],
      ai_innovation: [],
      science_integrity: [],
      efficiency: [],
      untagged: []
    };

    // Categorize stories by priority
    state.stories.forEach(function(story) {
      var priorities = story.admin_priorities ? story.admin_priorities.split(',').map(function(p) { return p.trim().toLowerCase(); }) : [];

      if (priorities.length === 0) {
        priorityData.untagged.push(story);
      } else {
        var matchedAny = false;
        priorities.forEach(function(p) {
          if (priorityData[p]) {
            priorityData[p].push(story);
            matchedAny = true;
          }
        });
        if (!matchedAny) {
          priorityData.untagged.push(story);
        }
      }
    });

    // Update chip counts
    Object.keys(priorityConfig).forEach(function(key) {
      var countEl = document.getElementById('priorityCount' + priorityConfig[key].id);
      if (countEl) {
        countEl.textContent = priorityData[key].length;
      }
    });
  }

  function togglePriorityDetail(priorityKey) {
    var panel = document.getElementById('priorityDetailPanel');
    var chips = document.querySelectorAll('.priority-chip');

    // If clicking the same chip that's active, close the panel
    var clickedChip = document.querySelector('.priority-chip[data-priority="' + priorityKey + '"]');
    if (clickedChip && clickedChip.classList.contains('active')) {
      closePriorityDetail();
      return;
    }

    // Remove active from all chips
    chips.forEach(function(c) { c.classList.remove('active'); });

    // Add active to clicked chip
    if (clickedChip) clickedChip.classList.add('active');

    // Get stories for this priority
    var stories = priorityData[priorityKey] || [];
    var config = priorityConfig[priorityKey];

    // Update panel header
    document.getElementById('priorityDetailIcon').textContent = config.icon;
    document.getElementById('priorityDetailTitle').textContent = config.name + ' (' + stories.length + ' stories)';

    // Render stories
    var content = document.getElementById('priorityDetailContent');
    if (stories.length === 0) {
      content.innerHTML = '<div class="empty-state" style="grid-column: 1/-1; padding: var(--space-lg);">' +
        '<span class="material-icons">check_circle</span>' +
        '<span>' + (priorityKey === 'untagged' ? 'All stories have priorities!' : 'No stories tagged with this priority') + '</span>' +
        '</div>';
    } else {
      content.innerHTML = stories.map(function(story) {
        var onclick = priorityKey === 'untagged'
          ? 'COMMS.editStory(\'' + escapeAttr(story.story_id) + '\')'
          : 'COMMS.showStoryDetail(\'' + escapeAttr(story.story_id) + '\')';
        return '<div class="priority-story-item" onclick="' + onclick + '">' +
          '<div class="priority-story-title">' + escapeHtml(story.title) + '</div>' +
          '<div class="priority-story-meta">' + escapeHtml(story.solution_id || 'No solution') + '  ' + capitalizeFirst(story.status || 'unknown') + '</div>' +
          '</div>';
      }).join('');
    }

    // Show panel
    panel.style.display = 'block';
  }

  function closePriorityDetail() {
    document.getElementById('priorityDetailPanel').style.display = 'none';
    document.querySelectorAll('.priority-chip').forEach(function(c) { c.classList.remove('active'); });
  }

  // ========== HIGHLIGHTER BLURBS (HQ REPORTING) ==========

  var blurbsState = {
    blurbs: [],
    filteredBlurbs: [],
    nextDeadline: null,
    showAll: false,
    view: 'table', // 'cards' or 'table' - default to table for readability
    searchTerm: '',
    statusFilter: ''
  };

  function loadBlurbs() {
    var container = document.getElementById('blurbsContainer');
    container.innerHTML = '<div class="loading-state" style="display: flex;"><span class="loading-spinner"></span><span>Loading blurbs...</span></div>';

    // Get next deadline
    google.script.run
      .withSuccessHandler(function(deadline) {
        blurbsState.nextDeadline = deadline;
        var deadlineEl = document.getElementById('nextDeadlineDate');
        if (deadlineEl && deadline) {
          var d = new Date(deadline);
          deadlineEl.textContent = d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }
      })
      .getNextBlurbDeadline();

    // Load blurbs
    google.script.run
      .withSuccessHandler(function(blurbs) {
        blurbsState.blurbs = blurbs || [];
        renderBlurbs();
      })
      .withFailureHandler(function(err) {
        container.innerHTML = '<div class="blurb-empty"><span class="material-icons">error</span><br>Failed to load blurbs</div>';
        console.error('Failed to load blurbs:', err);
      })
      .getHighlighterBlurbs(20);
  }

  function renderBlurbs() {
    var container = document.getElementById('blurbsContainer');
    var allBlurbs = blurbsState.blurbs;

    if (!allBlurbs || allBlurbs.length === 0) {
      container.innerHTML = '<div class="blurb-empty"><span class="material-icons">description</span><br>No highlighter blurbs yet.<br>Add your first blurb to start tracking HQ reporting.</div>';
      return;
    }

    // Apply filters
    var blurbs = allBlurbs.filter(function(b) {
      // Status filter
      if (blurbsState.statusFilter && b.status !== blurbsState.statusFilter) {
        return false;
      }
      // Search filter
      if (blurbsState.searchTerm) {
        var term = blurbsState.searchTerm.toLowerCase();
        var searchable = [
          b.title || '',
          b.solution_id || '',
          b.blurb_content || '',
          b.background_info || '',
          b.notes || ''
        ].join(' ').toLowerCase();
        if (!searchable.includes(term)) {
          return false;
        }
      }
      return true;
    });

    blurbsState.filteredBlurbs = blurbs;

    if (blurbs.length === 0) {
      container.innerHTML = '<div class="blurb-empty"><span class="material-icons">search_off</span><br>No blurbs match your search.</div>';
      return;
    }

    var today = new Date();
    today.setHours(0, 0, 0, 0);

    // Calculate days until next Tuesday
    var dayOfWeek = today.getDay();
    var daysUntilTuesday = (2 - dayOfWeek + 7) % 7;
    if (daysUntilTuesday === 0) daysUntilTuesday = 7;
    var nextTuesday = new Date(today);
    nextTuesday.setDate(today.getDate() + daysUntilTuesday);

    var displayBlurbs = blurbsState.showAll ? blurbs : blurbs.slice(0, 10);

    if (blurbsState.view === 'table') {
      container.innerHTML = renderBlurbsTable(displayBlurbs, nextTuesday, blurbs.length);
    } else {
      container.innerHTML = renderBlurbsCards(displayBlurbs, nextTuesday, blurbs.length);
    }
  }

  function filterBlurbs() {
    blurbsState.searchTerm = document.getElementById('blurbSearchInput').value;
    blurbsState.statusFilter = document.getElementById('blurbStatusFilter').value;
    blurbsState.showAll = false; // Reset pagination when filtering
    renderBlurbs();
  }

  function renderBlurbsTable(blurbs, nextTuesday, totalCount) {
    var html = '<table class="blurb-table">' +
      '<thead><tr>' +
        '<th style="width:30px;"></th>' +
        '<th>Title</th>' +
        '<th>Solution</th>' +
        '<th>Target</th>' +
        '<th>Status</th>' +
        '<th style="width:90px;"></th>' +
      '</tr></thead><tbody>';

    html += blurbs.map(function(blurb) {
      var targetDate = blurb.target_date ? new Date(blurb.target_date) : null;
      var isDueSoon = targetDate && targetDate <= nextTuesday && blurb.status !== 'published';
      var isSubmitted = blurb.status === 'published' || blurb.hq_submission_date;

      var rowClass = '';
      if (isDueSoon) rowClass = 'blurb-row-due';
      if (isSubmitted) rowClass = 'blurb-row-submitted';

      var dotClass = 'blurb-status-dot dot-' + (blurb.status || 'idea');
      if (isDueSoon && blurb.status !== 'published') dotClass = 'blurb-status-dot dot-due';

      var dateDisplay = targetDate ? targetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '-';

      var statusLabel = blurb.status === 'published' ? 'Submitted to HQ' :
        (blurb.status ? blurb.status.charAt(0).toUpperCase() + blurb.status.slice(1) : 'Idea');

      // Get blurb content for copy
      var blurbContent = blurb.blurb_content || blurb.content || blurb.notes || '';
      var escapedContent = blurbContent.replace(/'/g, "\\'").replace(/"/g, '&quot;');

      return '<tr class="' + rowClass + '" onclick="COMMS.showStoryDetail(\'' + escapeAttr(blurb.story_id) + '\')">' +
        '<td><span class="' + dotClass + '"></span></td>' +
        '<td class="blurb-title-cell">' + escapeHtml(blurb.title || 'Untitled') + '</td>' +
        '<td class="blurb-solution-cell">' + escapeHtml(blurb.solution_id || '-') + '</td>' +
        '<td class="blurb-date-cell">' + dateDisplay + '</td>' +
        '<td><span class="blurb-status status-' + escapeAttr(blurb.status || 'idea') + '">' + statusLabel + '</span></td>' +
        '<td class="blurb-actions-cell">' +
          '<button class="copy-btn" onclick="event.stopPropagation(); COMMS.copyMessageContent(this, \'' + escapedContent + '\')" title="Copy blurb">' +
            '<span class="material-icons" style="font-size:14px;">content_copy</span>' +
          '</button>' +
          '<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); COMMS.editStory(\'' + escapeAttr(blurb.story_id) + '\')" title="Edit">' +
            '<span class="material-icons" style="font-size:14px;">edit</span>' +
          '</button>' +
        '</td>' +
      '</tr>';
    }).join('');

    html += '</tbody></table>';

    if (totalCount > 10 && !blurbsState.showAll) {
      html += '<div class="blurbs-show-more"><button class="btn btn-secondary btn-sm" onclick="COMMS.showAllBlurbs()">Show All (' + totalCount + ')</button></div>';
    }

    return html;
  }

  function renderBlurbsCards(blurbs, nextTuesday, totalCount) {
    var html = blurbs.map(function(blurb) {
      var targetDate = blurb.target_date ? new Date(blurb.target_date) : null;
      var isDueSoon = targetDate && targetDate <= nextTuesday && blurb.status !== 'published';
      var isSubmitted = blurb.status === 'published';

      var cardClass = 'blurb-card';
      if (isDueSoon) cardClass += ' blurb-due-soon';
      if (isSubmitted) cardClass += ' blurb-submitted';

      var dateDisplay = targetDate ? targetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';

      var blurbText = blurb.blurb_content || blurb.notes || '';
      if (blurbText.length > 150) {
        blurbText = blurbText.substring(0, 150) + '...';
      }

      var statusLabel = blurb.status === 'published' ? 'Submitted to HQ' :
        (blurb.status ? blurb.status.charAt(0).toUpperCase() + blurb.status.slice(1) : 'Idea');

      return '<div class="' + cardClass + '" onclick="COMMS.showStoryDetail(\'' + blurb.story_id + '\')">' +
        '<div class="blurb-content">' +
          '<div class="blurb-title">' + escapeHtml(blurb.title || 'Untitled Blurb') + '</div>' +
          (blurb.solution_id ? '<div class="blurb-solution">' + escapeHtml(blurb.solution_id) + '</div>' : '') +
          (blurbText ? '<div class="blurb-text">' + escapeHtml(blurbText) + '</div>' : '') +
        '</div>' +
        '<div class="blurb-meta">' +
          (dateDisplay ? '<span class="blurb-date">' + dateDisplay + '</span>' : '') +
          '<span class="blurb-status status-' + (blurb.status || 'idea') + '">' + statusLabel + '</span>' +
        '</div>' +
      '</div>';
    }).join('');

    if (totalCount > 10 && !blurbsState.showAll) {
      html += '<div class="blurbs-show-more"><button class="btn btn-secondary btn-sm" onclick="COMMS.showAllBlurbs()">Show All (' + totalCount + ')</button></div>';
    }

    return html;
  }

  function setBlurbView(view) {
    blurbsState.view = view;
    // Update toggle buttons
    document.getElementById('blurbViewCards').classList.toggle('active', view === 'cards');
    document.getElementById('blurbViewTable').classList.toggle('active', view === 'table');
    renderBlurbs();
  }

  function showAllBlurbs() {
    blurbsState.showAll = true;
    renderBlurbs();
  }

  /**
   * Toggle visibility of Highlighter Blurb specific fields
   */
  function toggleBlurbFields() {
    var contentType = document.getElementById('storyContentType').value;
    var blurbFields = document.getElementById('blurbFields');
    if (blurbFields) {
      blurbFields.style.display = contentType === 'highlighter_blurb' ? 'block' : 'none';
    }
  }

  function showNewBlurbModal() {
    // Open the Add Asset modal pre-configured for blurb type
    showAddAssetModal('blurb');
  }

  // ============================================================================
  // ADD ASSET MODAL FUNCTIONS
  // ============================================================================

  /**
   * Show the Add Asset modal, optionally pre-selecting an asset type
   * @param {string} preselectedType - Optional asset type to pre-select
   */
  function showAddAssetModal(preselectedType) {
    // Reset form
    document.getElementById('addAssetForm').reset();
    document.getElementById('editAssetId').value = '';
    document.getElementById('addAssetModalTitle').textContent = 'Add Communications Asset';

    // Reset selections
    state.assetForm.selectedSolutions = [];
    state.assetForm.selectedContacts = [];
    state.assetForm.selectedTags = [];

    // Clear displays
    document.getElementById('assetSolutionTags').innerHTML = '';
    document.getElementById('assetSelectedContacts').innerHTML = '';

    // Reset tag suggestions
    document.querySelectorAll('.tag-suggestion').forEach(function(btn) {
      btn.classList.remove('selected');
    });

    // Reset section toggles
    document.getElementById('affiliationsSection').classList.remove('collapsed');
    document.getElementById('affiliationsToggleIcon').textContent = 'expand_more';
    document.getElementById('tagsSection').classList.remove('collapsed');
    document.getElementById('tagsToggleIcon').textContent = 'expand_more';
    document.getElementById('moreOptionsSection').classList.add('collapsed');
    document.getElementById('moreOptionsToggleIcon').textContent = 'chevron_right';

    // Update affiliation badge
    updateAffiliationsBadge();

    // Pre-select asset type if provided
    if (preselectedType) {
      document.getElementById('assetType').value = preselectedType;
      onAssetTypeChange();

      // Update title based on type
      var typeLabels = {
        'blurb': 'Add Highlighter Blurb',
        'talking_point': 'Add Talking Point',
        'quote': 'Add Quote',
        'fact': 'Add Fact/Statistic',
        'soundbite': 'Add Sound Bite',
        'boilerplate': 'Add Boilerplate',
        'connection': 'Add Connection'
      };
      document.getElementById('addAssetModalTitle').textContent = typeLabels[preselectedType] || 'Add Communications Asset';
    }

    // Load dropdown data if not already loaded
    loadAssetFormData();

    // Show modal
    document.getElementById('addAssetModal').classList.add('active');
  }

  /**
   * Load solutions, contacts, and agencies for the asset form
   */
  function loadAssetFormData() {
    // Load solutions if not cached
    if (state.assetForm.solutions.length === 0) {
      google.script.run
        .withSuccessHandler(function(solutions) {
          state.assetForm.solutions = solutions || [];
          populateSolutionDropdowns();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load solutions:', error);
        })
        .getAllSolutions();
    } else {
      populateSolutionDropdowns();
    }

    // Load contacts if not cached
    if (state.assetForm.contacts.length === 0) {
      google.script.run
        .withSuccessHandler(function(contacts) {
          state.assetForm.contacts = contacts || [];
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load contacts:', error);
        })
        .getAllContacts();
    }

    // Load agencies if not cached
    if (state.assetForm.agencies.length === 0) {
      google.script.run
        .withSuccessHandler(function(agencies) {
          state.assetForm.agencies = agencies || [];
          populateAgencyDropdown();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load agencies:', error);
        })
        .getAllAgencies();
    } else {
      populateAgencyDropdown();
    }
  }

  /**
   * Populate solution dropdowns (Primary and Additional)
   */
  function populateSolutionDropdowns() {
    var primarySelect = document.getElementById('assetPrimarySolution');
    var additionalSelect = document.getElementById('addAssetSolution');

    var options = '<option value="">-- Select Solution --</option>';
    var addOptions = '<option value="">+ Add solution...</option>';

    state.assetForm.solutions.forEach(function(sol) {
      var name = sol.core_official_name || sol.core_id;
      options += '<option value="' + escapeHtml(sol.core_id) + '">' + escapeHtml(name) + '</option>';
      addOptions += '<option value="' + escapeHtml(sol.core_id) + '">' + escapeHtml(name) + '</option>';
    });

    primarySelect.innerHTML = options;
    additionalSelect.innerHTML = addOptions;
  }

  /**
   * Handle primary solution change
   */
  function onPrimarySolutionChange() {
    updateAffiliationsBadge();
  }

  /**
   * Add an additional solution tag
   */
  function addAssetSolution(solutionId) {
    if (!solutionId) return;

    // Don't add duplicates
    if (state.assetForm.selectedSolutions.includes(solutionId)) return;

    // Don't add if it's the primary solution
    var primary = document.getElementById('assetPrimarySolution').value;
    if (solutionId === primary) return;

    state.assetForm.selectedSolutions.push(solutionId);
    renderAssetSolutionTags();
    updateAffiliationsBadge();
  }

  /**
   * Remove an additional solution
   */
  function removeAssetSolution(solutionId) {
    var index = state.assetForm.selectedSolutions.indexOf(solutionId);
    if (index > -1) {
      state.assetForm.selectedSolutions.splice(index, 1);
      renderAssetSolutionTags();
      updateAffiliationsBadge();
    }
  }

  /**
   * Render additional solution tags
   */
  function renderAssetSolutionTags() {
    var container = document.getElementById('assetSolutionTags');
    if (state.assetForm.selectedSolutions.length === 0) {
      container.innerHTML = '';
      return;
    }

    var html = state.assetForm.selectedSolutions.map(function(id) {
      var sol = state.assetForm.solutions.find(function(s) { return s.core_id === id; });
      var name = sol ? (sol.core_official_name || id) : id;
      return '<span class="asset-solution-tag">' +
        escapeHtml(name) +
        '<button type="button" class="asset-solution-tag-remove" onclick="COMMS.removeAssetSolution(\'' + escapeHtml(id) + '\')">' +
          '<span class="material-icons">close</span>' +
        '</button>' +
      '</span>';
    }).join('');

    container.innerHTML = html;
  }

  /**
   * Populate agency dropdown with readable names
   */
  function populateAgencyDropdown() {
    var select = document.getElementById('assetAgency');
    var html = '<option value="">-- Select Agency --</option>';

    state.assetForm.agencies.forEach(function(agency) {
      // Use abbreviation/acronym first, then name, then agency_id as fallback
      var label = agency.abbreviation || agency.acronym || agency.name || agency.agency_name || agency.agency_id;
      // If there's a full name that differs, append it
      var fullName = agency.full_name || agency.agency_name;
      if (fullName && fullName !== label && label.length < 10) {
        label += ' - ' + fullName;
      }
      html += '<option value="' + escapeHtml(agency.agency_id) + '">' + escapeHtml(label) + '</option>';
    });

    select.innerHTML = html;
  }

  // Contact Picker Functions (like SEP engagement modal)
  var assetContactSearchTimeout = null;

  function searchAssetContacts(query) {
    clearTimeout(assetContactSearchTimeout);
    assetContactSearchTimeout = setTimeout(function() {
      renderAssetContactResults(query);
    }, 150);
  }

  function showAssetContactResults() {
    document.getElementById('assetContactResults').classList.add('active');
    renderAssetContactResults(document.getElementById('assetContactSearchInput').value);
  }

  function hideAssetContactResults() {
    // Delay to allow click events on results
    setTimeout(function() {
      document.getElementById('assetContactResults').classList.remove('active');
    }, 200);
  }

  function renderAssetContactResults(query) {
    var container = document.getElementById('assetContactResults');
    var contacts = state.assetForm.contacts;

    if (!query || query.length < 2) {
      container.innerHTML = '<div class="asset-contact-results-empty">Type to search contacts...</div>';
      return;
    }

    var lowerQuery = query.toLowerCase();
    var filtered = contacts.filter(function(c) {
      // Exclude already selected
      if (state.assetForm.selectedContacts.includes(c.email)) return false;

      var searchText = ((c.first_name || '') + ' ' + (c.last_name || '') + ' ' + (c.email || '')).toLowerCase();
      return searchText.includes(lowerQuery);
    }).slice(0, 10);

    if (filtered.length === 0) {
      container.innerHTML = '<div class="asset-contact-results-empty">No contacts found</div>';
      return;
    }

    var html = filtered.map(function(c) {
      var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim() || c.email;
      var org = c.organization || c.agency || '';
      return '<div class="asset-contact-result-item" onmousedown="COMMS.selectAssetContact(\'' + escapeHtml(c.email) + '\')">' +
        '<div class="asset-contact-result-info">' +
          '<div class="asset-contact-result-name">' + escapeHtml(name) + '</div>' +
          '<div class="asset-contact-result-detail">' + escapeHtml(c.email) + (org ? '  ' + escapeHtml(org) : '') + '</div>' +
        '</div>' +
      '</div>';
    }).join('');

    container.innerHTML = html;
  }

  function selectAssetContact(email) {
    if (state.assetForm.selectedContacts.includes(email)) return;

    state.assetForm.selectedContacts.push(email);
    renderAssetSelectedContacts();
    updateAffiliationsBadge();

    // Clear search
    document.getElementById('assetContactSearchInput').value = '';
    document.getElementById('assetContactResults').classList.remove('active');
  }

  function removeAssetContact(email) {
    var index = state.assetForm.selectedContacts.indexOf(email);
    if (index > -1) {
      state.assetForm.selectedContacts.splice(index, 1);
      renderAssetSelectedContacts();
      updateAffiliationsBadge();
    }
  }

  function renderAssetSelectedContacts() {
    var container = document.getElementById('assetSelectedContacts');
    if (state.assetForm.selectedContacts.length === 0) {
      container.innerHTML = '';
      return;
    }

    var html = state.assetForm.selectedContacts.map(function(email) {
      var contact = state.assetForm.contacts.find(function(c) { return c.email === email; });
      var name = contact ? ((contact.first_name || '') + ' ' + (contact.last_name || '')).trim() : email;
      name = name || email;
      return '<span class="asset-contact-chip">' +
        '<span class="asset-contact-chip-name">' + escapeHtml(name) + '</span>' +
        '<button type="button" class="asset-contact-chip-remove" onclick="COMMS.removeAssetContact(\'' + escapeHtml(email) + '\')">' +
          '<span class="material-icons">close</span>' +
        '</button>' +
      '</span>';
    }).join('');

    container.innerHTML = html;
  }

  /**
   * Update the affiliations badge count
   */
  function updateAffiliationsBadge() {
    var primarySol = document.getElementById('assetPrimarySolution') ? document.getElementById('assetPrimarySolution').value : '';
    var agency = document.getElementById('assetAgency') ? document.getElementById('assetAgency').value : '';

    var total = (primarySol ? 1 : 0) +
                state.assetForm.selectedSolutions.length +
                state.assetForm.selectedContacts.length +
                (agency ? 1 : 0);

    var badge = document.getElementById('affiliationsBadge');
    if (badge) {
      badge.textContent = total;
      badge.dataset.count = total;
    }
  }

  /**
   * Toggle collapsible form sections
   */
  function toggleAssetSection(sectionId) {
    var section = document.getElementById(sectionId + 'Section');
    var icon = document.getElementById(sectionId + 'ToggleIcon');
    if (!section || !icon) return;

    var isCollapsed = section.classList.contains('collapsed');
    section.classList.toggle('collapsed');
    icon.textContent = isCollapsed ? 'expand_more' : 'chevron_right';
  }

  /**
   * Toggle a thematic tag
   */
  function toggleTag(tag) {
    var btn = document.querySelector('.tag-suggestion[data-tag="' + tag + '"]');
    var index = state.assetForm.selectedTags.indexOf(tag);

    if (index === -1) {
      state.assetForm.selectedTags.push(tag);
      if (btn) btn.classList.add('selected');
    } else {
      state.assetForm.selectedTags.splice(index, 1);
      if (btn) btn.classList.remove('selected');
    }
  }

  /**
   * Update content hint based on asset type
   */
  function onAssetTypeChange() {
    var type = document.getElementById('assetType').value;
    var hint = document.getElementById('assetContentHint');

    var hints = {
      'blurb': '2-3 sentences recommended for HQ updates',
      'talking_point': 'Key message with supporting detail',
      'quote': 'Include attribution in Source Name field',
      'fact': 'Include data source in Source Name field',
      'soundbite': 'Short and punchy - 1-2 sentences max',
      'boilerplate': 'Standard program description',
      'connection': 'Describe the relationship between solution and user/agency'
    };

    hint.textContent = hints[type] || '';
  }

  /**
   * Show the Add Contact for Asset modal
   */
  function showAddContactForAsset() {
    document.getElementById('addContactForAssetForm').reset();
    document.getElementById('addContactForAssetModal').classList.add('active');
  }

  /**
   * Submit new contact and add to selection
   */
  function submitContactForAsset(event) {
    event.preventDefault();

    var contactData = {
      first_name: document.getElementById('assetContactFirstName').value.trim(),
      last_name: document.getElementById('assetContactLastName').value.trim(),
      email: document.getElementById('assetContactEmail').value.trim(),
      organization: document.getElementById('assetContactOrg').value.trim(),
      title: document.getElementById('assetContactTitle').value.trim()
    };

    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success) {
          // Add to contacts cache
          state.assetForm.contacts.push(contactData);
          // Select the new contact
          state.assetForm.selectedContacts.push(contactData.email);
          renderAssetSelectedContacts();
          updateAffiliationsBadge();
          closeModal('addContactForAssetModal');
          window.showSuccess('Contact added and selected');
        } else {
          window.showError(result ? result.error : 'Failed to add contact');
        }
      })
      .withFailureHandler(function(error) {
        window.showError('Failed to add contact: ' + error);
      })
      .createContact(contactData);
  }

  /**
   * Submit the asset form
   */
  function submitAsset(event) {
    event.preventDefault();
    if (state.isSavingAsset) return;

    var assetType = document.getElementById('assetType').value;
    var title = document.getElementById('assetTitle').value.trim();
    var content = document.getElementById('assetContent').value.trim();

    if (!assetType || !title || !content) {
      window.showError('Please fill in all required fields');
      return;
    }

    state.isSavingAsset = true;
    var btn = document.getElementById('saveAssetBtn');
    var originalText = btn.innerHTML;
    btn.innerHTML = '<span class="loading-spinner-sm"></span> Saving...';
    btn.disabled = true;

    // Collect all tags (suggested + custom)
    var allTags = state.assetForm.selectedTags.slice();
    var customTags = document.getElementById('customTags').value.trim();
    if (customTags) {
      customTags.split(',').forEach(function(t) {
        var tag = t.trim();
        if (tag && !allTags.includes(tag)) {
          allTags.push(tag);
        }
      });
    }

    // Collect channels
    var channels = [];
    document.querySelectorAll('input[name="assetChannel"]:checked').forEach(function(cb) {
      channels.push(cb.value);
    });

    // Collect solution IDs (primary + additional)
    var solutionIds = [];
    var primarySol = document.getElementById('assetPrimarySolution').value;
    if (primarySol) solutionIds.push(primarySol);
    state.assetForm.selectedSolutions.forEach(function(id) {
      if (!solutionIds.includes(id)) solutionIds.push(id);
    });

    var assetData = {
      asset_type: assetType,
      title: title,
      content: content,
      status: document.getElementById('assetStatus').value,
      solution_ids: solutionIds.join(','),
      agency_ids: document.getElementById('assetAgency').value,
      contact_ids: state.assetForm.selectedContacts.join(','),
      tags: allTags.join(','),
      source_name: document.getElementById('assetSourceName').value.trim(),
      source_type: document.getElementById('assetSourceType').value,
      source_url: document.getElementById('assetSourceUrl').value.trim(),
      attribution_text: document.getElementById('assetAttribution').value.trim(),
      audience: document.getElementById('assetAudience').value,
      tone: document.getElementById('assetTone').value,
      channels: channels.join(',') || 'all',
      usage_notes: document.getElementById('assetUsageNotes').value.trim(),
      expiration_date: document.getElementById('assetExpirationDate').value
    };

    var assetId = document.getElementById('editAssetId').value;

    if (assetId) {
      // Update existing
      google.script.run
        .withSuccessHandler(function(result) {
          state.isSavingAsset = false;
          btn.innerHTML = originalText;
          btn.disabled = false;

          if (result && result.success) {
            closeModal('addAssetModal');
            loadBlurbs();
            window.showSuccess('Asset updated successfully');
          } else {
            window.showError(result ? result.error : 'Failed to update asset');
          }
        })
        .withFailureHandler(function(error) {
          state.isSavingAsset = false;
          btn.innerHTML = originalText;
          btn.disabled = false;
          window.showError('Failed to update asset: ' + error);
        })
        .updateCommsAsset(assetId, assetData);
    } else {
      // Create new
      google.script.run
        .withSuccessHandler(function(result) {
          state.isSavingAsset = false;
          btn.innerHTML = originalText;
          btn.disabled = false;

          if (result && result.success) {
            closeModal('addAssetModal');
            loadBlurbs();
            window.showSuccess('Asset created successfully');
          } else {
            window.showError(result ? result.error : 'Failed to create asset');
          }
        })
        .withFailureHandler(function(error) {
          state.isSavingAsset = false;
          btn.innerHTML = originalText;
          btn.disabled = false;
          window.showError('Failed to create asset: ' + error);
        })
        .createCommsAsset(assetData);
    }
  }

  // ============================================================================
  // END ADD ASSET MODAL FUNCTIONS
  // ============================================================================

  function showNewBlurbModalLegacy() {
    // Legacy: Open the story modal pre-configured for highlighter blurb
    document.getElementById('editStoryModalTitle').textContent = 'New Highlighter Blurb';
    document.getElementById('editStoryId').value = '';
    document.getElementById('storyTitle').value = '';
    document.getElementById('storyContentType').value = 'highlighter_blurb';
    document.getElementById('storyStatus').value = 'idea';
    document.getElementById('storyChannel').value = 'web';
    document.getElementById('storyOutlet').value = '';
    document.getElementById('storyAuthor').value = '';
    document.getElementById('storyPriority').value = 'medium';
    document.getElementById('storySolution').value = '';
    setRichTextContent('storyNotes', '');

    // Clear Highlighter Blurb specific fields
    document.getElementById('storyBackgroundInfo').value = '';
    document.getElementById('storyBlurbContent').value = '';
    document.getElementById('storyHqSubmissionDate').value = '';

    // Set target date to next Tuesday by default
    var today = new Date();
    var dayOfWeek = today.getDay();
    var daysUntilTuesday = (2 - dayOfWeek + 7) % 7;
    if (daysUntilTuesday === 0) daysUntilTuesday = 7;
    var nextTuesday = new Date(today);
    nextTuesday.setDate(today.getDate() + daysUntilTuesday);
    document.getElementById('storyTargetDate').value = nextTuesday.toISOString().split('T')[0];

    // Clear admin priorities
    document.querySelectorAll('.admin-priority-checkbox').forEach(function(cb) {
      cb.checked = false;
    });

    // Show blurb-specific fields
    toggleBlurbFields();

    document.getElementById('editStoryModal').classList.add('active');
  }

  // Key Messages state
  var messagesState = {
    solutions: [],
    summary: null,
    searchQuery: ''
  };

  function renderMessagesView() {
    var grid = document.getElementById('messagesGrid');
    grid.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><span>Loading key messages...</span></div>';

    // Load summary
    google.script.run
      .withSuccessHandler(function(summary) {
        messagesState.summary = summary;
        document.getElementById('msgTotalSolutions').textContent = summary.with_key_messages;
        document.getElementById('msgCoverage').textContent = summary.coverage_percent + '%';
        document.getElementById('msgByFocus').textContent = Object.keys(summary.by_focus_type || {}).length;
      })
      .withFailureHandler(function(err) {
        console.error('Failed to load messages summary:', err);
      })
      .getKeyMessagesSummary();

    // Load solutions with messages
    google.script.run
      .withSuccessHandler(function(solutions) {
        messagesState.solutions = solutions || [];
        renderMessagesGrid(messagesState.solutions);
      })
      .withFailureHandler(function(err) {
        grid.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><span>Failed to load key messages</span></div>';
      })
      .getSolutionsWithKeyMessages();
  }

  function renderMessagesGrid(solutions) {
    var grid = document.getElementById('messagesGrid');

    if (!solutions || solutions.length === 0) {
      grid.innerHTML = '<div class="empty-state"><span class="material-icons">chat</span><span>No solutions have key messages yet</span></div>';
      return;
    }

    var html = solutions.map(function(sol) {
      var focusBadge = sol.comms_focus_type ?
        '<span class="focus-badge focus-' + sol.comms_focus_type.toLowerCase().replace(/\s+/g, '-') + '">' + escapeHtml(sol.comms_focus_type) + '</span>' : '';

      // Build collapsible sections
      var sections = '';

      if (sol.comms_key_messages) {
        sections += buildMessageSection('Key Messages', sol.comms_key_messages, false);
      }
      if (sol.comms_science) {
        sections += buildMessageSection('Scientific Advancement', sol.comms_science, false);
      }
      if (sol.comms_agency_impact) {
        sections += buildMessageSection('Agency Use & Impact', sol.comms_agency_impact, false);
      }
      if (sol.comms_industry) {
        sections += buildMessageSection('Industry Connections', sol.comms_industry, false);
      }

      return '<div class="message-card">' +
        '<div class="message-card-header">' +
          '<h3 class="message-solution-name">' + escapeHtml(sol.core_official_name || sol.core_id) + '</h3>' +
          focusBadge +
        '</div>' +
        '<div class="message-card-body">' +
          sections +
        '</div>' +
        (sol.comms_public_links ? '<div class="message-card-footer"><a href="' + escapeAttr(sol.comms_public_links) + '" target="_blank" class="message-link"><span class="material-icons">open_in_new</span> View Public Page</a></div>' : '') +
      '</div>';
    }).join('');

    grid.innerHTML = html;
  }

  /**
   * Build a collapsible message section with formatted text
   */
  function buildMessageSection(title, content, openByDefault) {
    var formattedContent = formatMessageText(content);
    var openClass = openByDefault ? ' open' : '';
    // Escape content for data attribute
    var escapedContent = content.replace(/'/g, "\\'").replace(/"/g, '&quot;');

    return '<div class="message-section-collapsible' + openClass + '">' +
      '<div class="message-section-header">' +
        '<span class="material-icons" onclick="COMMS.toggleMessageSection(this.parentElement)">expand_more</span>' +
        '<span onclick="COMMS.toggleMessageSection(this.parentElement)">' + escapeHtml(title) + '</span>' +
        '<button class="copy-btn" onclick="event.stopPropagation(); COMMS.copyMessageContent(this, \'' + escapedContent + '\')" title="Copy to clipboard">' +
          '<span class="material-icons">content_copy</span>Copy' +
        '</button>' +
      '</div>' +
      '<div class="message-section-content">' + formattedContent + '</div>' +
    '</div>';
  }

  /**
   * Format message text - convert bullet characters to proper HTML lists
   */
  function formatMessageText(text) {
    if (!text) return '';

    // Escape HTML first
    var escaped = escapeHtml(text);

    // Split by common bullet patterns and newlines
    var lines = escaped.split(/[\n\r]+/);

    // Check if content has bullets
    var bulletPattern = /^[\s]*[\-\*]\s*/;
    var hasBullets = lines.some(function(line) { return bulletPattern.test(line); });

    if (hasBullets) {
      var inList = false;
      var result = '';

      lines.forEach(function(line) {
        var trimmed = line.trim();
        if (!trimmed) return;

        if (bulletPattern.test(trimmed)) {
          // This is a bullet item
          var itemText = trimmed.replace(bulletPattern, '');
          if (!inList) {
            result += '<ul>';
            inList = true;
          }
          result += '<li>' + itemText + '</li>';
        } else {
          // Regular text
          if (inList) {
            result += '</ul>';
            inList = false;
          }
          result += '<p>' + trimmed + '</p>';
        }
      });

      if (inList) {
        result += '</ul>';
      }

      return result || '<p>' + escaped + '</p>';
    } else {
      // No bullets - just wrap in paragraph, preserving line breaks
      return '<p>' + lines.filter(function(l) { return l.trim(); }).join('<br>') + '</p>';
    }
  }

  /**
   * Toggle message section open/closed
   */
  function toggleMessageSection(header) {
    var section = header.closest('.message-section-collapsible');
    section.classList.toggle('open');
  }

  function copyMessageContent(button, content) {
    // Decode HTML entities and clean up the content
    var text = content
      .replace(/&quot;/g, '"')
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .replace(/\\'/g, "'");
    copyToClipboard(text, button);
  }

  function searchMessages() {
    var query = document.getElementById('messagesSearchInput').value.toLowerCase().trim();
    messagesState.searchQuery = query;

    if (!query) {
      renderMessagesGrid(messagesState.solutions);
      return;
    }

    var filtered = messagesState.solutions.filter(function(sol) {
      var searchText = [
        sol.core_official_name,
        sol.core_id,
        sol.comms_key_messages,
        sol.comms_science,
        sol.comms_agency_impact,
        sol.comms_industry,
        sol.comms_focus_type
      ].join(' ').toLowerCase();
      return searchText.includes(query);
    });

    renderMessagesGrid(filtered);
  }

  function showStoryDetail(storyId) {
    // Check stories cache first
    var story = state.stories.find(function(s) { return s.story_id === storyId; });
    // Also check blurbs cache
    if (!story && blurbsState.blurbs) {
      story = blurbsState.blurbs.find(function(b) { return b.story_id === storyId; });
    }
    if (!story) {
      // Fallback to server if not in cache
      google.script.run
        .withSuccessHandler(function(s) {
          if (s) renderStoryDetailModal(s);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load story:', error);
          window.showError('Failed to load story details');
        })
        .getStoryById(storyId);
      return;
    }
    renderStoryDetailModal(story);
  }

  function renderStoryDetailModal(story) {
    document.getElementById('modalStoryTitle').textContent = story.title || 'Story Details';

    var typeNames = {
      'story': 'Impact Story',
      'web_content': 'Web Content',
      'social_media': 'Social Media',
      'external_mention': 'External Mention',
      'nugget': 'Nugget Slide',
      'key_date': 'Key Date',
      'highlighter_blurb': 'Highlighter Blurb'
    };

    var isBlurb = story.content_type === 'highlighter_blurb';
    var statusInfo = {
      'idea': { name: 'Idea', color: '#9E9E9E' },
      'researching': { name: 'Researching', color: '#2196F3' },
      'drafting': { name: 'Drafting', color: '#FF9800' },
      'review': { name: 'Review', color: '#9C27B0' },
      'published': { name: isBlurb ? 'Submitted to HQ' : 'Published', color: '#4CAF50' },
      'archived': { name: 'Archived', color: '#607D8B' }
    };

    var priorityInfo = {
      'high': { name: 'High', color: '#f44336' },
      'medium': { name: 'Medium', color: '#FF9800' },
      'low': { name: 'Low', color: '#9E9E9E' }
    };

    var status = statusInfo[story.status] || { name: story.status, color: '#9E9E9E' };
    var priority = priorityInfo[story.priority] || { name: story.priority || 'Medium', color: '#FF9800' };

    var html = '<div class="story-detail">';

    // Header with type, priority and status
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md); padding-bottom: var(--space-md); border-bottom: 1px solid var(--color-border-light);">';
    html += '<div style="display: flex; align-items: center; gap: var(--space-sm);">';
    html += '<span style="font-size: var(--font-size-sm); color: var(--color-comms);">' + (typeNames[story.content_type] || 'Story') + '</span>';
    html += '<span style="padding: 2px 8px; background: ' + priority.color + '22; color: ' + priority.color + '; border-radius: 4px; font-size: var(--font-size-xs); font-weight: 600;">' + priority.name + ' Priority</span>';
    html += '</div>';
    html += '<span style="padding: 4px 12px; background: ' + status.color + '; color: white; border-radius: 12px; font-size: var(--font-size-sm);">' + status.name + '</span>';
    html += '</div>';

    // Admin Priorities tags
    if (story.admin_priorities) {
      var priorityLabels = {
        'partnerships': 'Partnerships & Decision Support',
        'citizens': 'Benefits to American Citizens',
        'ai_innovation': 'AI Leadership & Tech Innovation',
        'science_integrity': 'Gold Standard Science',
        'efficiency': 'Government Efficiency'
      };
      var priorities = story.admin_priorities.split(',').map(function(p) { return p.trim(); }).filter(function(p) { return p; });
      if (priorities.length > 0) {
        html += '<div style="margin-bottom: var(--space-md);">';
        html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs);">ADMIN PRIORITIES</div>';
        html += '<div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">';
        priorities.forEach(function(p) {
          var label = priorityLabels[p] || p;
          html += '<span style="padding: 4px 8px; background: var(--color-comms); color: white; border-radius: 4px; font-size: var(--font-size-xs);">' + escapeHtml(label) + '</span>';
        });
        html += '</div></div>';
      }
    }

    // Details grid
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';

    if (story.solution_id) {
      // Look up solution name
      var solutionDisplay = story.solution_id;
      if (state.solutions) {
        var sol = state.solutions.find(function(s) { return s.core_id === story.solution_id; });
        if (sol) solutionDisplay = sol.core_official_name || story.solution_id;
      }
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">SOLUTION</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(solutionDisplay) + '</div></div>';
    }

    if (story.channel) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">CHANNEL</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + capitalizeFirst(story.channel) + '</div></div>';
    }

    if (story.author) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">AUTHOR</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(story.author) + '</div></div>';
    }

    if (story.platform) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">PLATFORM</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(story.platform) + '</div></div>';
    }

    if (story.source) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">SOURCE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(story.source) + '</div></div>';
    }

    if (story.target_date) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">TARGET DATE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(story.target_date) + '</div></div>';
    }

    if (story.publish_date) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">PUBLISH DATE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(story.publish_date) + '</div></div>';
    }

    if (story.idea_date) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">CREATED</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(story.idea_date) + '</div></div>';
    }

    if (story.last_updated) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">LAST UPDATED</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(story.last_updated) + '</div></div>';
    }

    // HQ Submission date for blurbs
    if (isBlurb && story.hq_submission_date) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">SUBMITTED TO HQ</div>';
      html += '<div style="font-size: var(--font-size-sm); color: var(--color-success);">' + formatDate(story.hq_submission_date) + '</div></div>';
    }

    html += '</div>';

    // Links
    if (story.published_url || story.pitch_doc_url) {
      html += '<div style="margin-bottom: var(--space-md);">';
      if (story.published_url) {
        html += '<a href="' + escapeHtml(story.published_url) + '" target="_blank" class="btn btn-secondary" style="margin-right: var(--space-sm);">';
        html += '<span class="material-icons">open_in_new</span> View Published</a>';
      }
      if (story.pitch_doc_url) {
        html += '<a href="' + escapeHtml(story.pitch_doc_url) + '" target="_blank" class="btn btn-secondary">';
        html += '<span class="material-icons">description</span> View Draft</a>';
      }
      html += '</div>';
    }

    // Blurb-specific content sections
    if (isBlurb && story.background_info) {
      html += '<div style="background: var(--color-surface-alt); padding: var(--space-md); border-radius: var(--radius-sm); margin-bottom: var(--space-md);">';
      html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs);">BACKGROUND INFORMATION</div>';
      html += '<div style="font-size: var(--font-size-sm); white-space: pre-wrap;">' + escapeHtml(story.background_info) + '</div>';
      html += '</div>';
    }

    if (isBlurb && story.blurb_content) {
      html += '<div style="background: var(--color-surface-alt); padding: var(--space-md); border-radius: var(--radius-sm); margin-bottom: var(--space-md); border-left: 3px solid var(--color-comms);">';
      html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs);">BLURB CONTENT</div>';
      html += '<div style="font-size: var(--font-size-sm); white-space: pre-wrap;">' + escapeHtml(story.blurb_content) + '</div>';
      html += '</div>';
    }

    // Notes
    if (story.notes) {
      html += '<div style="background: var(--color-surface-alt); padding: var(--space-md); border-radius: var(--radius-sm); margin-bottom: var(--space-md);">';
      html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs);">NOTES</div>';
      html += '<div style="font-size: var(--font-size-sm); white-space: pre-wrap;">' + formatTextWithLinks(story.notes) + '</div>';
      html += '</div>';
    }

    // Actions
    html += '<div style="display: flex; gap: var(--space-sm); padding-top: var(--space-md); border-top: 1px solid var(--color-border-light);">';
    html += '<button class="btn btn-primary" id="editStoryBtn" onclick="COMMS.editStory(\'' + escapeAttr(story.story_id) + '\')"><span class="material-icons">edit</span> Edit</button>';
    if (story.status !== 'published') {
      var nextStatus = getNextStatus(story.status);
      if (nextStatus) {
        var nextLabel = (isBlurb && nextStatus === 'published') ? 'Submit to HQ' : ('Move to ' + capitalizeFirst(nextStatus));
        html += '<button class="btn btn-secondary" id="advanceStatusBtn" onclick="COMMS.advanceStatus(\'' + escapeAttr(story.story_id) + '\', \'' + nextStatus + '\')"><span class="material-icons">arrow_forward</span> ' + nextLabel + '</button>';
      }
    }
    html += '<button class="btn btn-danger" id="deleteStoryBtn" style="margin-left: auto;" onclick="COMMS.deleteStory(\'' + escapeAttr(story.story_id) + '\')" aria-label="Delete story"><span class="material-icons" aria-hidden="true">delete</span></button>';
    html += '</div>';

    html += '</div>';

    document.getElementById('storyModalBody').innerHTML = html;
    document.getElementById('storyModal').classList.add('active');
}

  function getNextStatus(currentStatus) {
    var order = ['idea', 'researching', 'drafting', 'review', 'published'];
    var idx = order.indexOf(currentStatus);
    if (idx >= 0 && idx < order.length - 1) {
      return order[idx + 1];
    }
    return null;
  }

  function advanceStatus(storyId, newStatus) {
    var btn = document.getElementById('advanceStatusBtn');
    var originalHtml = btn ? btn.innerHTML : '';
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner" style="width: 14px; height: 14px;"></span> Moving...';
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (!result) {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
          }
          showError('Story not found. It may have been deleted. Please refresh and try again.');
          return;
        }
        closeModal('storyModal');
        loadStories();
        loadOverview();
      })
      .withFailureHandler(function(error) {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
        showError('Failed to update status: ' + error);
      })
      .updateStoryStatus(storyId, newStatus);
  }

  function showCreateStoryModal() {
    document.getElementById('editStoryModalTitle').textContent = 'New Story';
    document.getElementById('storyForm').reset();
    document.getElementById('editStoryId').value = '';
    // Clear admin priority checkboxes
    var checkboxes = document.querySelectorAll('#storyAdminPriorities input[type="checkbox"]');
    checkboxes.forEach(function(cb) { cb.checked = false; });
    // Hide blurb-specific fields (default content type is 'story')
    toggleBlurbFields();
    document.getElementById('editStoryModal').classList.add('active');
  }

  function editStory(storyId) {
    var story = state.stories.find(function(s) { return s.story_id === storyId; });
    // Also check blurbs cache
    if (!story && blurbsState.blurbs) {
      story = blurbsState.blurbs.find(function(b) { return b.story_id === storyId; });
    }
    if (!story) {
      // Fallback to server if not in cache
      google.script.run
        .withSuccessHandler(function(s) {
          if (s) populateStoryForm(s);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load story for editing:', error);
          window.showError('Failed to load story for editing');
        })
        .getStoryById(storyId);
      return;
    }
    populateStoryForm(story);
  }

  function populateStoryForm(story) {
    document.getElementById('editStoryModalTitle').textContent = 'Edit Story';
    document.getElementById('editStoryId').value = story.story_id;
    document.getElementById('storyTitle').value = story.title || '';
    document.getElementById('storyContentType').value = story.content_type || 'story';
    document.getElementById('storyStatus').value = story.status || 'idea';
    document.getElementById('storyChannel').value = story.channel || 'web';
    document.getElementById('storyOutlet').value = story.platform || '';
    document.getElementById('storyAuthor').value = story.author || '';
    document.getElementById('storyPriority').value = story.priority || 'medium';
    document.getElementById('storySource').value = story.source || '';
    document.getElementById('storySolution').value = story.solution_id || '';
    document.getElementById('storyTargetDate').value = story.target_date ? story.target_date.split('T')[0] : '';
    document.getElementById('storyPublishDate').value = story.publish_date ? story.publish_date.split('T')[0] : '';
    document.getElementById('storyPitchUrl').value = story.pitch_doc_url || '';
    document.getElementById('storyPublishedLink').value = story.published_url || '';
    setRichTextContent('storyNotes', story.notes || '');

    // Highlighter Blurb fields
    document.getElementById('storyBackgroundInfo').value = story.background_info || '';
    document.getElementById('storyBlurbContent').value = story.blurb_content || '';
    document.getElementById('storyHqSubmissionDate').value = story.hq_submission_date ? story.hq_submission_date.split('T')[0] : '';

    // Populate admin priorities checkboxes
    var priorities = story.admin_priorities ? story.admin_priorities.split(',').map(function(p) { return p.trim(); }) : [];
    var checkboxes = document.querySelectorAll('#storyAdminPriorities input[type="checkbox"]');
    checkboxes.forEach(function(cb) {
      cb.checked = priorities.includes(cb.value);
    });

    // Toggle blurb fields visibility based on content type
    toggleBlurbFields();

    closeModal('storyModal');
    document.getElementById('editStoryModal').classList.add('active');
  }

  function submitStory(event) {
    event.preventDefault();
    if (state.isSavingStory) return; // Prevent double-submit

    var storyId = document.getElementById('editStoryId').value;
    var solutionId = document.getElementById('storySolution').value;

    if (!solutionId) {
      showToast('Please select a solution', 'warning');
      return;
    }

    // Collect admin priorities from checkboxes
    var adminPriorities = [];
    var checkboxes = document.querySelectorAll('#storyAdminPriorities input[type="checkbox"]:checked');
    checkboxes.forEach(function(cb) {
      adminPriorities.push(cb.value);
    });

    var storyData = {
      title: document.getElementById('storyTitle').value,
      content_type: document.getElementById('storyContentType').value,
      status: document.getElementById('storyStatus').value,
      solution_id: solutionId,
      channel: document.getElementById('storyChannel').value,
      platform: document.getElementById('storyOutlet').value,
      author: document.getElementById('storyAuthor').value,
      priority: document.getElementById('storyPriority').value,
      source: document.getElementById('storySource').value,
      admin_priorities: adminPriorities.join(', '),
      target_date: document.getElementById('storyTargetDate').value,
      publish_date: document.getElementById('storyPublishDate').value,
      pitch_doc_url: document.getElementById('storyPitchUrl').value,
      published_url: document.getElementById('storyPublishedLink').value,
      notes: getRichTextContent('storyNotes'),
      // Highlighter Blurb fields
      background_info: document.getElementById('storyBackgroundInfo').value,
      blurb_content: document.getElementById('storyBlurbContent').value,
      hq_submission_date: document.getElementById('storyHqSubmissionDate').value
    };

    // Show loading state
    state.isSavingStory = true;
    var saveBtn = document.getElementById('saveStoryBtn');
    var originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    function resetButton() {
      state.isSavingStory = false;
      saveBtn.disabled = false;
      saveBtn.textContent = originalText;
    }

    if (storyId) {
      // Update existing
      google.script.run
        .withSuccessHandler(function(result) {
          resetButton();
          if (!result) {
            showError('Story not found. It may have been deleted. Please refresh and try again.');
            return;
          }
          closeModal('editStoryModal');
          loadStories();
          loadOverview();
          showSuccess('Story updated successfully!');
        })
        .withFailureHandler(function(error) {
          resetButton();
          showError('Failed to update story: ' + error);
        })
        .updateStory(storyId, storyData);
    } else {
      // Create new
      google.script.run
        .withSuccessHandler(function(result) {
          resetButton();
          // Check result object for success status
          if (!result || !result.success) {
            showError('Failed to create story: ' + (result ? result.error : 'Unknown error'));
            return;
          }
          closeModal('editStoryModal');
          loadStories();
          loadOverview();
          showSuccess('Story created successfully!');
        })
        .withFailureHandler(function(error) {
          resetButton();
          showError('Failed to create story: ' + error);
        })
        .createStory(storyData);
    }
  }

  function suggestStory(solutionId) {
    showCreateStoryModal();
    document.getElementById('storySolution').value = solutionId;
    document.getElementById('storySource').value = 'Coverage gap identified';
  }

  function createStoryFromOpportunity(type, value) {
    showCreateStoryModal();
    if (type === 'milestone') {
      // value is solution_id
      document.getElementById('storySolution').value = value;
      document.getElementById('storySource').value = 'Milestone opportunity';
    } else if (type === 't8') {
      document.getElementById('storySource').value = 'T8 Impact contact: ' + value;
    }
  }

  function refreshOpportunities() {
    document.getElementById('opportunitiesPanel').innerHTML = '<div class="loading-state"><span class="loading-spinner"></span></div>';
    loadOpportunities();
  }

  // Calendar functions
  function renderCalendar() {
    var date = state.calendarDate;
    var year = date.getFullYear();
    var month = date.getMonth();

    document.getElementById('calendarTitle').textContent =
      date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    var firstDay = new Date(year, month, 1);
    var lastDay = new Date(year, month + 1, 0);
    var startDay = firstDay.getDay();
    var daysInMonth = lastDay.getDate();

    var today = new Date();
    today.setHours(0, 0, 0, 0);

    // Get stories with dates in this month
    var monthStories = state.stories.filter(function(s) {
      var targetDate = s.target_date ? new Date(s.target_date) : null;
      var publishDate = s.publish_date ? new Date(s.publish_date) : null;
      if (targetDate && targetDate.getMonth() === month && targetDate.getFullYear() === year) return true;
      if (publishDate && publishDate.getMonth() === month && publishDate.getFullYear() === year) return true;
      return false;
    });

    // Group by day
    var storiesByDay = {};
    monthStories.forEach(function(s) {
      if (s.target_date) {
        var d = new Date(s.target_date).getDate();
        if (!storiesByDay[d]) storiesByDay[d] = [];
        storiesByDay[d].push({ story: s, type: 'target' });
      }
      if (s.publish_date && s.status === 'published') {
        var d = new Date(s.publish_date).getDate();
        if (!storiesByDay[d]) storiesByDay[d] = [];
        storiesByDay[d].push({ story: s, type: 'published' });
      }
    });

    var html = '';

    // Day headers
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(function(day) {
      html += '<div class="calendar-day-header">' + day + '</div>';
    });

    // Previous month days
    var prevMonth = new Date(year, month, 0);
    var prevMonthDays = prevMonth.getDate();
    for (var i = startDay - 1; i >= 0; i--) {
      html += '<div class="calendar-day other-month"><div class="calendar-day-number">' + (prevMonthDays - i) + '</div></div>';
    }

    // Current month days
    for (var day = 1; day <= daysInMonth; day++) {
      var isToday = (day === today.getDate() && month === today.getMonth() && year === today.getFullYear());
      html += '<div class="calendar-day' + (isToday ? ' today' : '') + '">';
      html += '<div class="calendar-day-number">' + day + '</div>';

      if (storiesByDay[day]) {
        storiesByDay[day].slice(0, 3).forEach(function(item) {
          html += '<div class="calendar-event ' + item.type + '" onclick="COMMS.showStoryDetail(\'' + escapeAttr(item.story.story_id) + '\')" title="' + escapeAttr(item.story.title) + '">';
          html += escapeHtml(item.story.title ? item.story.title.substring(0, 15) : 'Untitled');
          html += '</div>';
        });
        if (storiesByDay[day].length > 3) {
          html += '<div style="font-size: 10px; color: var(--color-text-muted);">+' + (storiesByDay[day].length - 3) + ' more</div>';
        }
      }

      html += '</div>';
    }

    // Next month days
    var totalCells = startDay + daysInMonth;
    var remaining = totalCells % 7;
    if (remaining > 0) {
      for (var i = 1; i <= 7 - remaining; i++) {
        html += '<div class="calendar-day other-month"><div class="calendar-day-number">' + i + '</div></div>';
      }
    }

    document.getElementById('calendarGrid').innerHTML = html;
  }

  function navigateCalendar(direction) {
    var date = state.calendarDate;
    date.setMonth(date.getMonth() + direction);
    renderCalendar();
  }

  function loadUpcomingTargets() {
    google.script.run
      .withSuccessHandler(function(targets) {
        var container = document.getElementById('upcomingTargetsList');
        if (!targets || targets.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No upcoming targets</p></div>';
          return;
        }

        var html = '';
        targets.slice(0, 10).forEach(function(t) {
          html += '<div class="target-item" onclick="COMMS.showStoryDetail(\'' + escapeAttr(t.story_id) + '\')">';
          html += '<div class="target-info">';
          html += '<div class="target-title">' + escapeHtml(t.title || 'Untitled') + '</div>';
          html += '<div class="target-date">' + formatDate(t.target_date) + '</div>';
          html += '</div></div>';
        });

        container.innerHTML = html;
      })
      .withFailureHandler(function(error) {
        document.getElementById('upcomingTargetsList').innerHTML =
          '<div class="empty-state"><p>Could not load targets</p></div>';
      })
      .getUpcomingTargets(60);
  }

  function renderCommsDue() {
    var container = document.getElementById('commsDueList');
    var coverage = state.coverage;

    if (!coverage) {
      // Coverage not loaded yet, load it
      google.script.run
        .withSuccessHandler(function(cov) {
          state.coverage = cov;
          renderCommsDue();
        })
        .withFailureHandler(function(error) {
          container.innerHTML = '<div class="empty-state-sm">Could not load coverage data</div>';
        })
        .getCoverageAnalysis(90);
      return;
    }

    // Combine gaps and uncovered solutions
    var needsAttention = [];

    if (coverage.gaps && coverage.gaps.length > 0) {
      coverage.gaps.forEach(function(g) {
        needsAttention.push({
          solution_name: g.solution_name || g.solution_id,
          solution_id: g.solution_id,
          days_since: g.days_since_story,
          last_date: g.last_story_date,
          type: 'gap'
        });
      });
    }

    if (coverage.uncovered && coverage.uncovered.length > 0) {
      coverage.uncovered.forEach(function(u) {
        needsAttention.push({
          solution_name: u.solution_name || u.solution_id,
          solution_id: u.solution_id,
          days_since: null,
          last_date: null,
          type: 'uncovered'
        });
      });
    }

    // Sort by urgency (uncovered first, then by days_since descending)
    needsAttention.sort(function(a, b) {
      if (a.type === 'uncovered' && b.type !== 'uncovered') return -1;
      if (a.type !== 'uncovered' && b.type === 'uncovered') return 1;
      var aDays = a.days_since || 9999;
      var bDays = b.days_since || 9999;
      return bDays - aDays;
    });

    if (needsAttention.length === 0) {
      container.innerHTML = '<div class="empty-state-sm"><span class="material-icons" style="color: var(--color-success);">check_circle</span> All solutions have recent coverage!</div>';
      return;
    }

    var html = '';
    needsAttention.slice(0, 8).forEach(function(item) {
      var isUrgent = item.type === 'uncovered' || (item.days_since && item.days_since > 180);
      var isWarning = !isUrgent && item.days_since && item.days_since > 90;
      var urgencyClass = isUrgent ? 'urgent' : (isWarning ? 'warning' : '');
      var daysClass = isUrgent ? 'urgent' : (isWarning ? 'warning' : '');

      var daysText = item.type === 'uncovered' ? 'No stories ever' :
                     (item.days_since ? item.days_since + ' days since last story' : 'Needs coverage');

      html += '<div class="comms-due-item ' + urgencyClass + '">';
      html += '<div class="comms-due-info">';
      html += '<div class="comms-due-solution">' + escapeHtml(item.solution_name) + '</div>';
      html += '<div class="comms-due-days ' + daysClass + '">' + daysText + '</div>';
      html += '</div>';
      html += '<button class="comms-due-action" onclick="event.stopPropagation(); COMMS.suggestStory(\'' + escapeAttr(item.solution_id || item.solution_name) + '\')">+ Story</button>';
      html += '</div>';
    });

    if (needsAttention.length > 8) {
      html += '<div style="text-align: center; margin-top: var(--space-sm);">';
      html += '<button class="btn btn-sm btn-secondary" onclick="COMMS.setView(\'coverage\')">';
      html += 'View all ' + needsAttention.length + ' solutions</button></div>';
    }

    container.innerHTML = html;
  }

  function closeModal(modalId, event) {
    window.closeModal(modalId, event);
  }

  // ============================================
  // Events Functions
  // ============================================

  function loadEvents() {
    google.script.run
      .withSuccessHandler(function(events) {
        state.events = events || [];
        renderEventsStats();
        renderEventsView();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load events:', error);
        document.getElementById('eventsTableBody').innerHTML =
          '<tr><td colspan="7" class="empty-state">Failed to load events</td></tr>';
      })
      .getAllEvents();

    // Also load overview for stats
    google.script.run
      .withSuccessHandler(function(overview) {
        state.eventsOverview = overview;
        renderEventsStats();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load events overview:', error);
      })
      .getOutreachOverview();
  }

  function renderEventsStats() {
    var overview = state.eventsOverview;
    if (overview && overview.stats) {
      document.getElementById('eventStatUpcoming').textContent = overview.stats.upcoming_events || 0;
      document.getElementById('eventStatConfirmed').textContent = overview.stats.confirmed_events || 0;
      document.getElementById('eventStatPotential').textContent = overview.stats.potential_events || 0;
      document.getElementById('eventStatDeadlines').textContent = overview.stats.deadlines_30_days || 0;
    }
  }

  function renderEventsView() {
    var events = filterEventsData(state.events);

    // Render upcoming events panel
    var upcomingEvents = events.filter(function(e) {
      return e.status === 'confirmed' && e.start_date && new Date(e.start_date) >= new Date();
    }).slice(0, 5);

    var upcomingHtml = '';
    if (upcomingEvents.length === 0) {
      upcomingHtml = '<div class="empty-state"><span class="material-icons">calendar_today</span><p>No upcoming events</p></div>';
    } else {
      upcomingEvents.forEach(function(e) {
        upcomingHtml += renderEventCard(e);
      });
    }
    document.getElementById('upcomingEventsPanel').innerHTML = upcomingHtml;

    // Render potential events panel
    var potentialEvents = events.filter(function(e) {
      return e.status === 'potential' || e.status === 'considering';
    }).slice(0, 5);

    var potentialHtml = '';
    if (potentialEvents.length === 0) {
      potentialHtml = '<div class="empty-state"><span class="material-icons">explore</span><p>No potential events</p></div>';
    } else {
      potentialEvents.forEach(function(e) {
        potentialHtml += renderEventCard(e, true);
      });
    }
    document.getElementById('potentialEventsPanel').innerHTML = potentialHtml;
    document.getElementById('potentialBadge').textContent = potentialEvents.length;

    // Render events table
    renderEventsTable(events);
}

  function renderEventCard(event, showActions) {
    var typeIcons = {
      'conference': 'users',
      'workshop': 'tool',
      'webinar': 'video',
      'meeting': 'briefcase',
      'site_visit': 'map-pin'
    };
    var icon = typeIcons[event.event_type] || 'calendar';

    var statusClass = event.status || 'potential';

    var html = '<div class="event-card" onclick="COMMS.showEventDetail(\'' + escapeAttr(event.event_id) + '\')">';

    // Header: type icon + status
    html += '<div class="event-card-header">';
    html += '<span class="event-type-icon"><span class="material-icons">' + icon + '</span></span>';
    html += '<span class="event-status ' + statusClass + '">' + (event.status || 'potential') + '</span>';
    html += '</div>';

    // Title
    html += '<div class="event-card-title">' + escapeHtml(event.name) + '</div>';

    // Details (date & location)
    var hasDetails = event.start_date || event.location;
    if (hasDetails) {
      html += '<div class="event-card-details">';
      if (event.start_date) {
        html += '<div class="event-card-date"><span class="material-icons">event</span>' + formatDate(event.start_date) + '</div>';
      }
      if (event.location) {
        html += '<div class="event-card-location"><span class="material-icons">place</span>' + escapeHtml(event.location.substring(0, 35)) + '</div>';
      }
      html += '</div>';
    }

    // Actions for potential events
    if (showActions && (event.status === 'potential' || event.status === 'considering')) {
      html += '<div class="event-card-actions">';
      html += '<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'confirmed\')">Confirm</button>';
      html += '<button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'cancelled\')">Decline</button>';
      html += '</div>';
    }

    html += '</div>';
    return html;
  }

  function renderEventsTable(events) {
    var tbody = document.getElementById('eventsTableBody');

    if (events.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No events found</td></tr>';
      return;
    }

    // Sort by date
    events.sort(function(a, b) {
      var dateA = a.start_date ? new Date(a.start_date) : new Date('9999-12-31');
      var dateB = b.start_date ? new Date(b.start_date) : new Date('9999-12-31');
      return dateA - dateB;
    });

    var html = '';
    events.slice(0, 50).forEach(function(e) {
      var statusClass = 'status-' + (e.status || 'potential');
      var typeIcons = {
        'conference': 'users',
        'workshop': 'tool',
        'webinar': 'video',
        'meeting': 'briefcase',
        'site_visit': 'map-pin'
      };
      var icon = typeIcons[e.event_type] || 'calendar';

      html += '<tr onclick="COMMS.showEventDetail(\'' + escapeAttr(e.event_id) + '\')" style="cursor: pointer;">';
      html += '<td><strong>' + escapeHtml(e.name) + '</strong></td>';
      html += '<td><span class="material-icons">' + icon + '</span> ' + capitalizeFirst(e.event_type || 'event') + '</td>';
      html += '<td>' + (e.start_date ? formatDate(e.start_date) : '--') + '</td>';
      html += '<td>' + escapeHtml(e.location || '--').substring(0, 25) + '</td>';
      html += '<td><span class="event-status ' + (e.status || 'potential') + '">' + (e.status || 'potential') + '</span></td>';
      html += '<td>' + escapeHtml(e.team_members || '--').substring(0, 20) + '</td>';
      html += '<td>';
      if (e.event_url) {
        html += '<a href="' + escapeHtml(e.event_url) + '" target="_blank" class="btn btn-sm btn-secondary" onclick="event.stopPropagation()"><span class="material-icons">open_in_new</span></a>';
      }
      html += '</td>';
      html += '</tr>';
    });

    tbody.innerHTML = html;
  }

  function filterEventsData(events) {
    var filters = state.eventFilters;
    return events.filter(function(e) {
      if (filters.year && e.year && e.year.toString() !== filters.year) return false;
      if (filters.status && e.status !== filters.status) return false;
      return true;
    });
  }

  function filterEvents() {
    state.eventFilters.year = document.getElementById('eventYearFilter').value;
    state.eventFilters.status = document.getElementById('eventStatusFilter').value;
    renderEventsView();
  }

  function showEventDetail(eventId) {
    var event = state.events.find(function(e) { return e.event_id === eventId; });
    if (!event) {
      google.script.run
        .withSuccessHandler(function(e) {
          if (e) renderEventDetailModal(e);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load event:', error);
          window.showError('Failed to load event details');
        })
        .getEventById(eventId);
      return;
    }
    renderEventDetailModal(event);
  }

  function renderEventDetailModal(event) {
    // Set current event for guest list functions
    currentEventId = event.event_id;
    currentEventDetail = event;
    currentEventGuests = [];

    // Reset to details tab
    switchEventTab('details');

    // Reset prep report
    document.getElementById('prepReportBody').innerHTML = '<div class="empty-state"><span class="material-icons">assignment</span><p>Click "Generate Prep Report" to create a preparation report for this event</p></div>';
    document.getElementById('exportPrepBtn').style.display = 'none';

    // Reset guest search
    document.getElementById('guestSearchInput').value = '';
    document.getElementById('guestSearchResults').innerHTML = '<div class="empty-state-sm">Search to find contacts</div>';
    document.getElementById('currentGuestList').innerHTML = '<div class="empty-state-sm">Switch to Guest List tab to load guests</div>';

    // Load guest count for badge
    google.script.run
      .withSuccessHandler(function(guests) {
        document.getElementById('guestCountBadge').textContent = (guests || []).length;
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load guest count:', error);
        document.getElementById('guestCountBadge').textContent = '?';
      })
      .getEventGuests(event.event_id);

    document.getElementById('modalEventName').textContent = event.name || 'Event Details';

    // Render the view mode content
    renderEventViewMode(event);
  }

  function renderEventViewMode(event) {
    currentEventDetail = event;

    var statusClass = event.status || 'potential';

    var html = '<div class="event-detail">';

    // Header with type, status, and edit/delete buttons
    html += '<div class="event-detail-header">';
    html += '<div class="event-detail-meta">';
    html += '<span class="event-type-label">' + capitalizeFirst(event.event_type || 'Event') + '</span>';
    html += '<span class="event-status ' + statusClass + '">' + (event.status || 'potential') + '</span>';
    html += '</div>';
    html += '<div class="event-detail-actions">';
    html += '<button class="btn btn-sm btn-secondary" onclick="COMMS.showEventEditForm()" aria-label="Edit event"><span class="material-icons" aria-hidden="true">edit</span></button>';
    html += '<button class="btn btn-sm btn-danger" onclick="COMMS.deleteEvent(\'' + escapeAttr(event.event_id) + '\')" aria-label="Delete event"><span class="material-icons" aria-hidden="true">delete</span></button>';
    html += '</div>';
    html += '</div>';

    // Details grid
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';

    if (event.start_date) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">DATE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(event.start_date);
      if (event.end_date && event.end_date !== event.start_date) {
        html += ' - ' + formatDate(event.end_date);
      }
      html += '</div></div>';
    }

    if (event.location) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">LOCATION</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.location) + '</div></div>';
    }

    if (event.deadline) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">DEADLINE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(event.deadline) + '</div></div>';
    }

    if (event.sector) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">SECTOR</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.sector) + '</div></div>';
    }

    if (event.solution_id) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">RELEVANT SOLUTIONS</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.solution_id) + '</div></div>';
    }

    if (event.team_members) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">TEAM</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.team_members) + '</div></div>';
    }

    if (event.stakeholders) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">AUDIENCE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.stakeholders) + '</div></div>';
    }

    if (event.priority) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">PRIORITY</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + capitalizeFirst(event.priority) + '</div></div>';
    }

    html += '</div>';

    // Purpose
    if (event.purpose) {
      html += '<div style="margin-bottom: var(--space-md);">';
      html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">PURPOSE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.purpose) + '</div>';
      html += '</div>';
    }

    // Links
    if (event.event_url || event.presentation_url) {
      html += '<div style="margin-bottom: var(--space-md);">';
      if (event.event_url) {
        html += '<a href="' + escapeHtml(event.event_url) + '" target="_blank" class="btn btn-secondary" style="margin-right: var(--space-sm);">';
        html += '<span class="material-icons">open_in_new</span> Event Website</a>';
      }
      if (event.presentation_url) {
        html += '<a href="' + escapeHtml(event.presentation_url) + '" target="_blank" class="btn btn-secondary">';
        html += '<span class="material-icons">description</span> Presentation</a>';
      }
      html += '</div>';
    }

    // Notes
    if (event.notes) {
      html += '<div style="background: var(--color-surface-alt); padding: var(--space-md); border-radius: var(--radius-sm); margin-bottom: var(--space-md);">';
      html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs);">NOTES</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatTextWithLinks(event.notes) + '</div>';
      html += '</div>';
    }

    // Actions
    html += '<div style="display: flex; gap: var(--space-sm); padding-top: var(--space-md); border-top: 1px solid var(--color-border-light);">';
    if (event.status === 'potential' || event.status === 'considering') {
      html += '<button class="btn btn-primary" onclick="COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'confirmed\')">Confirm Attendance</button>';
      html += '<button class="btn btn-secondary" onclick="COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'cancelled\')">Decline</button>';
    } else if (event.status === 'confirmed') {
      html += '<button class="btn btn-primary" onclick="COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'attended\')">Mark Attended</button>';
      html += '<button class="btn btn-secondary" onclick="COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'cancelled\')">Cancel</button>';
    }
    html += '</div>';

    html += '</div>';

    document.getElementById('eventModalBody').innerHTML = html;
    document.getElementById('eventModal').classList.add('active');
  }

  function formatDateForInput(dateStr) {
    return window.formatDateForInput(dateStr);
  }

  function showEventEditForm() {
    var event = currentEventDetail;
    if (!event) return;

    var html = '<form id="eventEditForm" onsubmit="COMMS.saveEventDetails(event); return false;">';

    // Row 1: Name and Type
    html += '<div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Event Name</label>';
    html += '<input type="text" id="editEventName" value="' + escapeAttr(event.name || '') + '" required class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Type</label>';
    html += '<select id="editEventType" class="form-control">';
    var types = ['conference', 'webinar', 'workshop', 'meeting', 'presentation', 'training', 'other'];
    types.forEach(function(t) {
      var selected = (event.event_type === t) ? ' selected' : '';
      html += '<option value="' + t + '"' + selected + '>' + capitalizeFirst(t) + '</option>';
    });
    html += '</select>';
    html += '</div>';
    html += '</div>';

    // Row 2: Dates
    html += '<div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Start Date</label>';
    html += '<input type="date" id="editEventStartDate" value="' + formatDateForInput(event.start_date) + '" class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">End Date</label>';
    html += '<input type="date" id="editEventEndDate" value="' + formatDateForInput(event.end_date) + '" class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Deadline</label>';
    html += '<input type="date" id="editEventDeadline" value="' + formatDateForInput(event.deadline) + '" class="form-control">';
    html += '</div>';
    html += '</div>';

    // Row 3: Location and Status
    html += '<div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Location</label>';
    html += '<input type="text" id="editEventLocation" value="' + escapeAttr(event.location || '') + '" class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Status</label>';
    html += '<select id="editEventStatus" class="form-control">';
    var statuses = ['potential', 'considering', 'confirmed', 'attended', 'cancelled'];
    statuses.forEach(function(s) {
      var selected = (event.status === s) ? ' selected' : '';
      html += '<option value="' + s + '"' + selected + '>' + capitalizeFirst(s) + '</option>';
    });
    html += '</select>';
    html += '</div>';
    html += '</div>';

    // Row 4: Sector and Priority
    html += '<div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Sector</label>';
    html += '<input type="text" id="editEventSector" value="' + escapeAttr(event.sector || '') + '" class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Priority</label>';
    html += '<select id="editEventPriority" class="form-control">';
    html += '<option value="">-- Select --</option>';
    var priorities = ['high', 'medium', 'low'];
    priorities.forEach(function(p) {
      var selected = (event.priority === p) ? ' selected' : '';
      html += '<option value="' + p + '"' + selected + '>' + capitalizeFirst(p) + '</option>';
    });
    html += '</select>';
    html += '</div>';
    html += '</div>';

    // Row 5: Solutions and Team
    html += '<div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Relevant Solutions</label>';
    html += '<input type="text" id="editEventSolutions" value="' + escapeAttr(event.solution_id || '') + '" class="form-control" placeholder="e.g., FIRMS, LANCE">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Team Members</label>';
    html += '<input type="text" id="editEventTeam" value="' + escapeAttr(event.team_members || '') + '" class="form-control">';
    html += '</div>';
    html += '</div>';

    // Row 6: Stakeholders
    html += '<div class="form-group" style="margin-bottom: var(--space-md);">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Audience/Stakeholders</label>';
    html += '<input type="text" id="editEventStakeholders" value="' + escapeAttr(event.stakeholders || '') + '" class="form-control">';
    html += '</div>';

    // Row 7: Purpose
    html += '<div class="form-group" style="margin-bottom: var(--space-md);">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Purpose</label>';
    html += '<textarea id="editEventPurpose" rows="2" class="form-control">' + escapeHtml(event.purpose || '') + '</textarea>';
    html += '</div>';

    // Row 8: URLs
    html += '<div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Event URL</label>';
    html += '<input type="url" id="editEventUrl" value="' + escapeAttr(event.event_url || '') + '" class="form-control" placeholder="https://">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Presentation URL</label>';
    html += '<input type="url" id="editEventPresentation" value="' + escapeAttr(event.presentation_url || '') + '" class="form-control" placeholder="https://">';
    html += '</div>';
    html += '</div>';

    // Row 9: Notes
    html += '<div class="form-group" style="margin-bottom: var(--space-md);">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Notes</label>';
    html += '<textarea id="editEventNotes" rows="3" class="form-control">' + escapeHtml(event.notes || '') + '</textarea>';
    html += '</div>';

    // Actions
    html += '<div style="display: flex; gap: var(--space-sm); justify-content: flex-end; padding-top: var(--space-md); border-top: 1px solid var(--color-border-light);">';
    html += '<button type="button" class="btn btn-secondary" onclick="COMMS.renderEventViewMode(COMMS.getCurrentEventDetail())">Cancel</button>';
    html += '<button type="submit" class="btn btn-primary" id="saveEventBtn">Save Changes</button>';
    html += '</div>';

    html += '</form>';

    document.getElementById('eventModalBody').innerHTML = html;
  }

  function getCurrentEventDetail() {
    return currentEventDetail;
  }

  function saveEventDetails(e) {
    if (e) e.preventDefault();
    if (!currentEventDetail) return;
    if (state.isSavingEvent) return; // Prevent double-submit
    state.isSavingEvent = true;

    var updates = {
      name: document.getElementById('editEventName').value.trim(),
      event_type: document.getElementById('editEventType').value,
      start_date: document.getElementById('editEventStartDate').value || null,
      end_date: document.getElementById('editEventEndDate').value || null,
      deadline: document.getElementById('editEventDeadline').value || null,
      location: document.getElementById('editEventLocation').value.trim(),
      status: document.getElementById('editEventStatus').value,
      sector: document.getElementById('editEventSector').value.trim(),
      priority: document.getElementById('editEventPriority').value,
      solution_id: document.getElementById('editEventSolutions').value.trim(),
      team_members: document.getElementById('editEventTeam').value.trim(),
      stakeholders: document.getElementById('editEventStakeholders').value.trim(),
      purpose: document.getElementById('editEventPurpose').value.trim(),
      event_url: document.getElementById('editEventUrl').value.trim(),
      presentation_url: document.getElementById('editEventPresentation').value.trim(),
      notes: document.getElementById('editEventNotes').value.trim()
    };

    if (!updates.name) {
      showToast('Event name is required', 'warning');
      return;
    }

    var saveBtn = document.getElementById('saveEventBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    google.script.run
      .withSuccessHandler(function(result) {
        state.isSavingEvent = false;
        // Check if elements still exist (modal may have closed)
        var btn = document.getElementById('saveEventBtn');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Save Changes';
        }
        if (!result || !result.success) {
          showError(result && result.error ? result.error : 'Event not found or failed to update');
          return;
        }
        // Update local state
        currentEventDetail = result.data;
        var idx = state.events.findIndex(function(ev) { return ev.event_id === result.data.event_id; });
        if (idx !== -1) {
          state.events[idx] = result.data;
        }
        // Update modal title (check element exists)
        var modalTitle = document.getElementById('modalEventName');
        if (modalTitle) {
          modalTitle.textContent = result.data.name || 'Event Details';
        }
        // Switch back to view mode (only if modal still open)
        var modal = document.getElementById('eventModal');
        if (modal && modal.classList.contains('active')) {
          renderEventViewMode(result.data);
        }
        loadEvents(); // Refresh the events list
      })
      .withFailureHandler(function(error) {
        state.isSavingEvent = false;
        var btn = document.getElementById('saveEventBtn');
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Save Changes';
        }
        showError('Failed to save event: ' + error);
      })
      .updateEvent(currentEventDetail.event_id, updates);
  }

  function deleteEvent(eventId) {
    if (!confirm('Are you sure you want to delete this event? This cannot be undone.')) {
      return;
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success) {
          closeModal('eventModal');
          loadEvents();
          showSuccess('Event deleted');
        } else {
          showError(result && result.error ? result.error : 'Failed to delete event');
        }
      })
      .withFailureHandler(function(error) {
        showError('Failed to delete event: ' + error);
      })
      .deleteEvent(eventId);
  }

  function updateEventStatus(eventId, newStatus) {
    // Disable all status buttons (modal and card) and show loading
    var buttons = document.querySelectorAll('#eventModal .btn, .event-card-actions .btn');
    buttons.forEach(function(btn) {
      btn.disabled = true;
      if (btn.textContent.includes('Confirm') ||
          btn.textContent.includes('Decline') ||
          btn.textContent.includes('Cancel') ||
          btn.textContent.includes('Attended')) {
        btn.dataset.originalText = btn.textContent;
        btn.textContent = 'Updating...';
      }
    });

    google.script.run
      .withSuccessHandler(function(result) {
        if (!result || !result.success) {
          // Re-enable buttons on error
          buttons.forEach(function(btn) {
            btn.disabled = false;
            if (btn.dataset.originalText) {
              btn.textContent = btn.dataset.originalText;
            }
          });
          showError(result && result.error ? result.error : 'Failed to update event status');
          return;
        }
        closeModal('eventModal');
        loadEvents();
        // Show brief success notification
        var statusNames = { confirmed: 'confirmed', cancelled: 'declined', attended: 'marked as attended' };
        showSuccess('Event ' + (statusNames[newStatus] || 'updated') + ' successfully!');
      })
      .withFailureHandler(function(error) {
        // Re-enable buttons
        buttons.forEach(function(btn) {
          btn.disabled = false;
          if (btn.dataset.originalText) {
            btn.textContent = btn.dataset.originalText;
          }
        });
        showError('Failed to update event status: ' + error);
      })
      .updateEventStatus(eventId, newStatus);
  }

  function showAddEventModal() {
    document.getElementById('addEventForm').reset();
    setRichTextContent('newEventNotes', ''); // Clear rich text field
    document.getElementById('addEventModal').classList.add('active');
  }

  function submitNewEvent(e) {
    e.preventDefault();
    if (state.isSubmittingNewEvent) return; // Prevent double-submit

    var name = document.getElementById('newEventName').value.trim();
    if (!name) {
      showToast('Please enter an event name', 'warning');
      return;
    }

    var startDate = document.getElementById('newEventStartDate').value || null;
    var endDate = document.getElementById('newEventEndDate').value || null;

    // Derive year from start_date, fallback to current year
    var year = startDate ? new Date(startDate).getFullYear() : new Date().getFullYear();

    // Check for duplicate event (same name and year)
    var duplicate = state.events.find(function(evt) {
      return evt.name && evt.name.toLowerCase() === name.toLowerCase() && evt.year === year;
    });
    if (duplicate) {
      showToast('An event with this name already exists for ' + year + '. Please use a different name or edit the existing event.', 'warning');
      return;
    }

    var eventData = {
      name: name,
      event_type: document.getElementById('newEventType').value,
      status: document.getElementById('newEventStatus').value,
      year: year,
      start_date: startDate,
      end_date: endDate,
      priority_sector: document.getElementById('newEventSector').value || null,
      event_url: document.getElementById('newEventUrl').value.trim() || null,
      notes: getRichTextContent('newEventNotes') || null,
      source: 'manual_entry'
    };

    state.isSubmittingNewEvent = true;
    var submitBtn = document.querySelector('#addEventForm button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    google.script.run
      .withSuccessHandler(function(result) {
        state.isSubmittingNewEvent = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Event';
        if (result && result.success && result.data) {
          closeModal('addEventModal');
          loadEvents();
        } else {
          showError(result && result.error ? result.error : 'Failed to create event');
        }
      })
      .withFailureHandler(function(error) {
        state.isSubmittingNewEvent = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Event';
        showError('Failed to add event: ' + error);
      })
      .createEvent(eventData);
  }

  // ============================================
  // Utility functions
  function formatDate(dateStr) {
    return window.formatDateShort(dateStr);
  }

  function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // escapeHtml() and escapeAttr() - use globals from index.html

  function showPipelineError(message) {
    var statuses = ['Idea', 'Researching', 'Drafting', 'Review', 'Published'];
    statuses.forEach(function(status) {
      document.getElementById('cards' + status).innerHTML =
        '<div class="empty-state"><p style="font-size: var(--font-size-xs);">Error</p></div>';
    });
  }

  // ============================================
  // Guest List & Prep Report Functions
  // ============================================

  var currentEventId = null;
  var currentEventDetail = null;
  var currentEventGuests = [];
  var guestSearchTimeout = null;

  function switchEventTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.modal-tab').forEach(function(tab) {
      tab.classList.toggle('active', tab.dataset.tab === tabName);
    });

    // Update tab panels
    document.getElementById('eventDetailsTab').classList.toggle('active', tabName === 'details');
    document.getElementById('eventGuestsTab').classList.toggle('active', tabName === 'guests');
    document.getElementById('eventPrepTab').classList.toggle('active', tabName === 'prep');

    // Load guest list if switching to guests tab
    if (tabName === 'guests' && currentEventId) {
      loadEventGuests();
    }
  }

  function loadEventGuests() {
    var listContainer = document.getElementById('currentGuestList');
    listContainer.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span></div>';

    google.script.run
      .withSuccessHandler(function(guests) {
        currentEventGuests = guests || [];
        renderGuestList(guests);
        document.getElementById('guestCountBadge').textContent = guests.length;
      })
      .withFailureHandler(function(error) {
        listContainer.innerHTML = '<div class="empty-state-sm">Failed to load guests</div>';
      })
      .getEventGuests(currentEventId);
  }

  function renderGuestList(guests) {
    var container = document.getElementById('currentGuestList');

    if (!guests || guests.length === 0) {
      container.innerHTML = '<div class="empty-state-sm">No guests added yet</div>';
      return;
    }

    // Check if event date has passed
    var event = state.events.find(function(e) { return e.event_id === currentEventId; });
    var isPastEvent = event && event.start_date && new Date(event.start_date) < new Date();

    var html = '';

    if (isPastEvent) {
      html += '<div class="attendance-section">';
      html += '<h4><span class="material-icons">fact_check</span> Mark Attendance</h4>';
    }

    guests.forEach(function(guest) {
      var name = (guest.first_name || '') + ' ' + (guest.last_name || '');

      if (isPastEvent) {
        // Show attendance checkboxes for past events
        html += '<div class="attendance-checkbox' + (guest.attended ? ' attended' : '') + '">';
        html += '<input type="checkbox" id="attend_' + escapeAttr(guest.email) + '" ' +
                (guest.attended ? 'checked' : '') +
                ' onchange="COMMS.toggleAttendance(\'' + escapeAttr(guest.email) + '\', this.checked)">';
        html += '<label for="attend_' + escapeAttr(guest.email) + '">';
        html += '<span class="guest-name">' + escapeHtml(name.trim() || guest.email) + '</span>';
        html += '</label>';
        html += '</div>';
      } else {
        // Show regular guest list for upcoming events
        html += '<div class="guest-list-item">';
        html += '<div class="guest-info">';
        html += '<div class="guest-name">' + escapeHtml(name.trim() || guest.email) + '</div>';
        html += '<div class="guest-email">' + escapeHtml(guest.email) + '</div>';
        if (guest.agency) {
          html += '<div class="guest-agency">' + escapeHtml(guest.agency) + '</div>';
        }
        html += '</div>';
        html += '<div class="guest-actions">';
        html += '<button class="guest-remove-btn" onclick="COMMS.removeGuest(\'' + escapeAttr(guest.email) + '\')" title="Remove">';
        html += '<span class="material-icons">close</span></button>';
        html += '</div>';
        html += '</div>';
      }
    });

    if (isPastEvent) {
      html += '<button class="btn btn-secondary" style="margin-top: var(--space-md); width: 100%;" onclick="COMMS.showNewContactFromEvent()">';
      html += '<span class="material-icons">person_add</span> Add New Contact Met at Event';
      html += '</button>';
      html += '</div>';
    }

    container.innerHTML = html;
  }

  function searchContactsForGuest() {
    var query = document.getElementById('guestSearchInput').value.trim();
    var resultsContainer = document.getElementById('guestSearchResults');

    if (query.length < 2) {
      resultsContainer.innerHTML = '<div class="empty-state-sm">Search to find contacts</div>';
      return;
    }

    // Debounce
    clearTimeout(guestSearchTimeout);
    guestSearchTimeout = setTimeout(function() {
      resultsContainer.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span></div>';

      google.script.run
        .withSuccessHandler(function(contacts) {
          renderGuestSearchResults(contacts);
        })
        .withFailureHandler(function(error) {
          resultsContainer.innerHTML = '<div class="empty-state-sm">Search failed</div>';
        })
        .searchContacts(query);
    }, 300);
  }

  function renderGuestSearchResults(contacts) {
    var container = document.getElementById('guestSearchResults');

    if (!contacts || contacts.length === 0) {
      container.innerHTML = '<div class="empty-state-sm">No contacts found</div>';
      return;
    }

    // Filter out contacts already in guest list
    var guestEmails = currentEventGuests.map(function(g) { return g.email.toLowerCase(); });
    var available = contacts.filter(function(c) {
      return guestEmails.indexOf(c.email.toLowerCase()) === -1;
    });

    if (available.length === 0) {
      container.innerHTML = '<div class="empty-state-sm">All matching contacts already added</div>';
      return;
    }

    var html = '';
    available.slice(0, 10).forEach(function(contact) {
      var name = (contact.first_name || '') + ' ' + (contact.last_name || '');
      html += '<div class="guest-result-item">';
      html += '<div class="guest-info">';
      html += '<div class="guest-name">' + escapeHtml(name.trim() || contact.email) + '</div>';
      html += '<div class="guest-email">' + escapeHtml(contact.email) + '</div>';
      if (contact.agency || contact.organization) {
        html += '<div class="guest-agency">' + escapeHtml(contact.agency || contact.organization) + '</div>';
      }
      html += '</div>';
      html += '<button class="guest-add-btn" onclick="COMMS.addGuest(\'' + escapeAttr(contact.email) + '\')" title="Add to guest list">';
      html += '<span class="material-icons">add</span></button>';
      html += '</div>';
    });

    container.innerHTML = html;
  }

  function addGuest(email) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          loadEventGuests();
          document.getElementById('guestSearchInput').value = '';
          document.getElementById('guestSearchResults').innerHTML = '<div class="empty-state-sm">Search to find contacts</div>';
        } else {
          showError(result.error || 'Failed to add guest');
        }
      })
      .withFailureHandler(function(error) {
        showError('Failed to add guest: ' + error);
      })
      .addGuestToEvent(currentEventId, email);
  }

  function addSuggestedGuest(email) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // Refresh both the guest list and prep report
          loadEventGuests();
          generatePrepReport();
        } else {
          showError(result.error || 'Failed to add guest');
        }
      })
      .withFailureHandler(function(error) {
        showError('Failed to add guest: ' + error);
      })
      .addGuestToEvent(currentEventId, email);
  }

  function removeGuest(email) {
    if (!confirm('Remove this guest from the list?')) return;

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          loadEventGuests();
        } else {
          showError(result.error || 'Failed to remove guest');
        }
      })
      .withFailureHandler(function(error) {
        showError('Failed to remove guest: ' + error);
      })
      .removeGuestFromEvent(currentEventId, email);
  }

  function toggleAttendance(email, attended) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (!result.success) {
          showError(result.error || 'Failed to update attendance');
          loadEventGuests(); // Reload to reset checkbox
        }
      })
      .withFailureHandler(function(error) {
        showError('Failed to update attendance: ' + error);
        loadEventGuests();
      })
      .markGuestAttended(currentEventId, email, attended);
  }

  function generatePrepReport() {
    var container = document.getElementById('prepReportBody');
    container.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><p>Generating prep report...</p></div>';

    google.script.run
      .withSuccessHandler(function(report) {
        renderPrepReport(report);
      })
      .withFailureHandler(function(error) {
        container.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>Failed to generate report: ' + escapeHtml(error) + '</p></div>';
      })
      .getEventPrepReport(currentEventId);
  }

  function renderPrepReport(report) {
    var container = document.getElementById('prepReportBody');

    if (report.error) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>' + escapeHtml(report.error) + '</p></div>';
      return;
    }

    if (!report.guests || report.guests.length === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">people</span><p>No guests in the guest list. Add guests first to generate a prep report.</p></div>';
      return;
    }

    var html = '';

    // Summary Stats
    html += '<div class="prep-section">';
    html += '<h3><span class="material-icons">summarize</span> Summary</h3>';
    html += '<div class="prep-summary-stats">';
    html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.total_guests + '</div><div class="prep-stat-label">Guests</div></div>';
    html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.total_agencies + '</div><div class="prep-stat-label">Agencies</div></div>';
    html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.total_connections + '</div><div class="prep-stat-label">Connections</div></div>';
    if (report.summary.linked_solutions > 0) {
      html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.linked_solutions + '</div><div class="prep-stat-label">Solutions</div></div>';
    }
    if (report.summary.total_potential_guests > 0) {
      html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.total_potential_guests + '</div><div class="prep-stat-label">Suggested</div></div>';
    }
    html += '</div>';
    html += '</div>';

    // Agencies Represented
    if (report.agencies_represented && report.agencies_represented.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">business</span> Agencies Represented</h3>';
      html += '<div class="prep-agency-list">';
      report.agencies_represented.forEach(function(agency) {
        html += '<div class="prep-agency-item">';
        html += '<div class="prep-agency-name">' + escapeHtml(agency.name) + '</div>';
        html += '<div class="prep-agency-count">' + agency.count + ' ' + (agency.count === 1 ? 'contact' : 'contacts') + '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    }

    // Potential Connections
    if (report.potential_connections && report.potential_connections.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">connect_without_contact</span> Potential Connections</h3>';
      report.potential_connections.slice(0, 10).forEach(function(conn) {
        html += '<div class="prep-connection-item">';
        html += '<span class="material-icons prep-connection-icon">link</span>';
        html += '<div>';
        html += '<div class="prep-connection-names">' + escapeHtml(conn.contact1.name) + ' & ' + escapeHtml(conn.contact2.name) + '</div>';
        html += '<div class="prep-connection-reason">' + escapeHtml(conn.reason) + '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Conversation Starters
    if (report.conversation_starters && report.conversation_starters.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">chat_bubble</span> Conversation Starters</h3>';
      report.conversation_starters.forEach(function(starter) {
        html += '<div class="prep-starter-item">';
        html += '<div class="prep-starter-name">' + escapeHtml(starter.name) + '</div>';
        html += '<div class="prep-starter-topics">';
        starter.topics.slice(0, 4).forEach(function(topic) {
          html += '<span class="prep-topic-tag ' + topic.type + '">' + escapeHtml(topic.text) + '</span>';
        });
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Linked Solutions & Event Context
    if (report.event.linked_solutions && report.event.linked_solutions.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">hub</span> Linked Solutions</h3>';
      html += '<div class="prep-solution-tags">';
      report.event.linked_solutions.forEach(function(sol) {
        html += '<span class="prep-solution-tag">' + escapeHtml(sol) + '</span>';
      });
      html += '</div>';
      html += '</div>';
    }

    // Potential Guests (from solution engagements)
    if (report.potential_guests && report.potential_guests.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">person_add</span> Suggested Attendees</h3>';
      html += '<p class="prep-section-desc">These contacts have engaged with the event\'s linked solutions but aren\'t on the guest list yet.</p>';
      html += '<div class="potential-guests-list">';
      report.potential_guests.forEach(function(pg) {
        html += '<div class="potential-guest-item">';
        html += '<div class="potential-guest-info">';
        html += '<div class="potential-guest-name">' + escapeHtml(pg.name) + '</div>';
        if (pg.agency) html += '<div class="potential-guest-agency">' + escapeHtml(pg.agency) + '</div>';
        html += '<div class="potential-guest-reason">' + escapeHtml(pg.reason) + '</div>';
        if (pg.touchpoints && pg.touchpoints.length > 0) {
          html += '<div class="potential-guest-touchpoints">Touchpoints: ' + escapeHtml(pg.touchpoints.join(', ')) + '</div>';
        }
        html += '</div>';
        html += '<button class="btn btn-sm btn-primary" onclick="COMMS.addSuggestedGuest(\'' + escapeAttr(pg.email) + '\')">';
        html += '<span class="material-icons">add</span> Add</button>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    }

    // Guest Profiles
    html += '<div class="prep-section">';
    html += '<h3><span class="material-icons">person</span> Guest Profiles</h3>';
    report.guests.forEach(function(guest) {
      html += '<div class="prep-guest-card">';
      html += '<div class="prep-guest-header">';
      html += '<div>';
      html += '<div class="prep-guest-name">' + escapeHtml(guest.name) + '</div>';
      if (guest.title) html += '<div class="prep-guest-title">' + escapeHtml(guest.title) + '</div>';
      if (guest.agency) html += '<div class="prep-guest-agency">' + escapeHtml(guest.agency) + '</div>';
      html += '</div>';
      html += '</div>';

      var hasDetails = guest.education || guest.hobbies || guest.goals || guest.professional_skills || guest.early_job || guest.relax;
      if (hasDetails) {
        html += '<div class="prep-guest-details">';
        if (guest.education) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Education</div>' + escapeHtml(guest.education) + '</div>';
        }
        if (guest.hobbies) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Hobbies</div>' + escapeHtml(guest.hobbies) + '</div>';
        }
        if (guest.goals) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Goals</div>' + escapeHtml(guest.goals) + '</div>';
        }
        if (guest.early_job) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">First Job</div>' + escapeHtml(guest.early_job) + '</div>';
        }
        if (guest.relax) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Unwinds By</div>' + escapeHtml(guest.relax) + '</div>';
        }
        if (guest.solutions && guest.solutions.length > 0) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Solutions</div>' + escapeHtml(guest.solutions.join(', ')) + '</div>';
        }
        html += '</div>';
      }

      html += '</div>';
    });
    html += '</div>';

    container.innerHTML = html;

    // Show export button now that report is generated
    document.getElementById('exportPrepBtn').style.display = 'inline-flex';
  }

  function exportPrepToDoc() {
    var exportBtn = document.getElementById('exportPrepBtn');
    var originalText = exportBtn.innerHTML;
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<span class="loading-spinner"></span> Exporting...';

    google.script.run
      .withSuccessHandler(function(result) {
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalText;

        if (result.success) {
          // Open the doc in a new tab
          window.open(result.url, '_blank');
        } else {
          showError('Export failed: ' + (result.error || 'Unknown error'));
        }
      })
      .withFailureHandler(function(error) {
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalText;
        showError('Export failed: ' + error.message);
      })
      .exportPrepReportToDoc(currentEventId);
  }

  function showNewContactFromEvent() {
    document.getElementById('newContactFromEventForm').reset();
    document.getElementById('addToGuestList').checked = true;
    document.getElementById('newContactFromEventModal').classList.add('active');
  }

  function submitNewContactFromEvent(e) {
    e.preventDefault();

    var contactData = {
      first_name: document.getElementById('newContactFirstName').value.trim(),
      last_name: document.getElementById('newContactLastName').value.trim(),
      email: document.getElementById('newContactEmail').value.trim().toLowerCase(),
      agency: document.getElementById('newContactAgency').value.trim(),
      title: document.getElementById('newContactTitle').value.trim(),
      notes: document.getElementById('newContactNotes').value.trim()
    };

    var addToGuests = document.getElementById('addToGuestList').checked;

    var submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    // First create the contact
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // If checkbox is checked, add to guest list
          if (addToGuests) {
            google.script.run
              .withSuccessHandler(function(guestResult) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Contact';
                closeModal('newContactFromEventModal');
                loadEventGuests();
                showSuccess('Contact added successfully!');
              })
              .withFailureHandler(function(error) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Contact';
                closeModal('newContactFromEventModal');
                showToast('Contact created but failed to add to guest list: ' + error, 'warning');
              })
              .addGuestToEvent(currentEventId, contactData.email);
          } else {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Contact';
            closeModal('newContactFromEventModal');
            showSuccess('Contact added successfully!');
          }
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Add Contact';
          showError(result.error || 'Failed to create contact');
        }
      })
      .withFailureHandler(function(error) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Contact';
        showError('Failed to create contact: ' + error);
      })
      .createContactForAgency(contactData);
  }

  // ========================================================================
  // DRAG AND DROP FOR STORY PIPELINE
  // ========================================================================

  var dragState = {
    draggingStoryId: null
  };

  function handleDragStart(event, storyId) {
    dragState.draggingStoryId = storyId;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', storyId);
  }

  function handleDragEnd(event) {
    event.target.classList.remove('dragging');
    dragState.draggingStoryId = null;
    // Remove drop-target class from all columns
    document.querySelectorAll('.pipeline-column').forEach(function(col) {
      col.classList.remove('drop-target');
    });
  }

  function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    var column = event.target.closest('.pipeline-column');
    if (column) {
      column.classList.add('drop-target');
    }
  }

  function handleDragLeave(event) {
    var column = event.target.closest('.pipeline-column');
    if (column && !column.contains(event.relatedTarget)) {
      column.classList.remove('drop-target');
    }
  }

  function handleDrop(event, newStatus) {
    event.preventDefault();
    var column = event.target.closest('.pipeline-column');
    if (column) {
      column.classList.remove('drop-target');
    }

    var storyId = dragState.draggingStoryId || event.dataTransfer.getData('text/plain');
    if (!storyId) return;

    // Find the story to get current status
    var story = state.stories.find(function(s) { return s.story_id === storyId; });
    if (!story) return;

    // Don't update if dropped in same column
    if (story.status === newStatus) return;

    // Update status via API
    google.script.run
      .withSuccessHandler(function(result) {
        if (result) {
          // Update local state
          story.status = newStatus;
          renderPipeline();
          loadOverview(); // Refresh stats
        } else {
          showError('Failed to update story status');
          renderPipeline(); // Re-render to reset position
        }
      })
      .withFailureHandler(function(error) {
        showError('Error updating status: ' + error);
        renderPipeline(); // Re-render to reset position
      })
      .updateStoryStatus(storyId, newStatus);
  }

  function deleteStory(storyId) {
    if (!confirm('Are you sure you want to delete this story?')) return;

    var btn = document.getElementById('deleteStoryBtn');
    var originalHtml = btn ? btn.innerHTML : '';
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner" style="width: 14px; height: 14px;"></span>';
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result) {
          closeModal('storyModal');
          loadStories();
          loadOverview();
        } else {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
          }
          showError('Failed to delete story');
        }
      })
      .withFailureHandler(function(error) {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
        showError('Error deleting story: ' + error);
      })
      .deleteStory(storyId);
  }

  function toggleSearchBar() {
    var searchBar = document.getElementById('pipelineSearchBar');
    if (searchBar) {
      searchBar.classList.toggle('expanded');
    }
  }

  function filterStories() {
    applyFilters();
  }

  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterChannel').value = '';
    applyFilters();
  }

  function toggleSidebar() {
    var sidebar = document.getElementById('insightsSidebar');
    var icon = document.getElementById('sidebarToggleIcon');
    if (sidebar) {
      sidebar.classList.toggle('collapsed');
      if (icon) {
        icon.textContent = sidebar.classList.contains('collapsed') ? 'chevron_right' : 'chevron_left';
      }
    }
  }

  function togglePublishedPanel() {
    var sidebar = document.getElementById('publishedSidebar');
    var icon = document.getElementById('publishedToggleIcon');
    if (sidebar) {
      sidebar.classList.toggle('collapsed');
      if (icon) {
        icon.textContent = sidebar.classList.contains('collapsed') ? 'chevron_left' : 'chevron_right';
      }
    }
  }

  // ============================================
  // Presentation Builder Functions
  // ============================================

  var presentationState = {
    solutions: [],
    isGenerating: false
  };

  function showPresentationBuilder() {
    // Reset to form state
    resetPresentationBuilder();

    // Load solutions if not already loaded
    if (presentationState.solutions.length === 0) {
      loadSolutionsForPresentation();
    }

    // Show modal
    var modal = document.getElementById('presentationBuilderModal');
    if (modal) {
      modal.classList.add('active');
    }
  }

  function loadSolutionsForPresentation() {
    var select = document.getElementById('presentationSolution');
    if (!select) return;

    select.innerHTML = '<option value="">Loading...</option>';

    google.script.run
      .withSuccessHandler(function(solutions) {
        presentationState.solutions = solutions || [];

        // Sort alphabetically by core_id
        var sorted = solutions.slice().sort(function(a, b) {
          var idA = (a.core_id || '').toLowerCase();
          var idB = (b.core_id || '').toLowerCase();
          return idA.localeCompare(idB);
        });

        var html = '<option value="">-- Select Solution --</option>';
        sorted.forEach(function(sol) {
          // Display core_id as readable acronym
          html += '<option value="' + escapeAttr(sol.core_id) + '">' + escapeHtml(sol.core_id) + '</option>';
        });
        select.innerHTML = html;
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load solutions:', error);
        select.innerHTML = '<option value="">-- Error loading solutions --</option>';
      })
      .getAllSolutions();
  }

  function generatePresentation() {
    // Validate inputs
    var solutionId = document.getElementById('presentationSolution').value;
    var audienceRadio = document.querySelector('input[name="presentationAudience"]:checked');

    if (!solutionId) {
      showToast('Please select a solution.', 'error');
      return;
    }
    if (!audienceRadio) {
      showToast('Please select an audience type.', 'error');
      return;
    }

    if (presentationState.isGenerating) return;
    presentationState.isGenerating = true;

    var audienceType = audienceRadio.value;

    // Show loading state (use 'flex' to preserve centering styles)
    document.getElementById('presentationForm').style.display = 'none';
    document.getElementById('presentationLoading').style.display = 'flex';
    document.getElementById('presentationSuccess').style.display = 'none';
    document.getElementById('presentationError').style.display = 'none';

    google.script.run
      .withSuccessHandler(function(result) {
        presentationState.isGenerating = false;
        document.getElementById('presentationLoading').style.display = 'none';

        if (result && result.success) {
          // Show success state
          document.getElementById('presentationSuccessName').textContent = result.data.name;
          document.getElementById('presentationOpenLink').href = result.data.url;

          // Show mode note if basic mode (no slide filtering/placeholder replacement)
          var modeNote = document.getElementById('presentationModeNote');
          if (result.data.mode === 'basic') {
            modeNote.textContent = 'Note: Template was copied without slide filtering or placeholder replacement (presentations scope not authorized).';
            modeNote.style.display = 'block';
          } else {
            modeNote.style.display = 'none';
          }

          document.getElementById('presentationSuccess').style.display = 'block';
        } else {
          // Show error state
          var errorMsg = (result && result.error) ? result.error : 'Unknown error occurred';
          document.getElementById('presentationErrorMessage').textContent = errorMsg;
          document.getElementById('presentationError').style.display = 'block';
        }
      })
      .withFailureHandler(function(error) {
        presentationState.isGenerating = false;
        document.getElementById('presentationLoading').style.display = 'none';
        document.getElementById('presentationErrorMessage').textContent = error.message || 'An unexpected error occurred';
        document.getElementById('presentationError').style.display = 'block';
      })
      .generatePresentation(solutionId, audienceType, null);
  }

  function resetPresentationBuilder() {
    // Reset form values
    var solutionSelect = document.getElementById('presentationSolution');
    if (solutionSelect) solutionSelect.value = '';

    var internalRadio = document.querySelector('input[name="presentationAudience"][value="internal"]');
    if (internalRadio) internalRadio.checked = true;

    presentationState.isGenerating = false;

    // Show form, hide other states
    document.getElementById('presentationForm').style.display = 'block';
    document.getElementById('presentationLoading').style.display = 'none';
    document.getElementById('presentationSuccess').style.display = 'none';
    document.getElementById('presentationError').style.display = 'none';

    // Hide mode note
    var modeNote = document.getElementById('presentationModeNote');
    if (modeNote) modeNote.style.display = 'none';
  }

  return {
    init: init,
    setView: setView,
    applyFilters: applyFilters,
    showStoryDetail: showStoryDetail,
    showCreateStoryModal: showCreateStoryModal,
    editStory: editStory,
    submitStory: submitStory,
    advanceStatus: advanceStatus,
    suggestStory: suggestStory,
    createStoryFromOpportunity: createStoryFromOpportunity,
    refreshOpportunities: refreshOpportunities,
    navigateCalendar: navigateCalendar,
    closeModal: closeModal,
    // Events functions
    filterEvents: filterEvents,
    showEventDetail: showEventDetail,
    showEventEditForm: showEventEditForm,
    saveEventDetails: saveEventDetails,
    deleteEvent: deleteEvent,
    renderEventViewMode: renderEventViewMode,
    getCurrentEventDetail: getCurrentEventDetail,
    updateEventStatus: updateEventStatus,
    showAddEventModal: showAddEventModal,
    submitNewEvent: submitNewEvent,
    // Messaging view functions
    searchMessages: searchMessages,
    togglePriorityDetail: togglePriorityDetail,
    closePriorityDetail: closePriorityDetail,
    // Highlighter Blurbs functions
    showNewBlurbModal: showNewBlurbModal,
    showAllBlurbs: showAllBlurbs,
    toggleBlurbFields: toggleBlurbFields,
    setBlurbView: setBlurbView,
    filterBlurbs: filterBlurbs,
    // Key Messages section toggle and copy
    toggleMessageSection: toggleMessageSection,
    copyMessageContent: copyMessageContent,
    // Guest List & Prep Report functions
    switchEventTab: switchEventTab,
    searchContactsForGuest: searchContactsForGuest,
    addGuest: addGuest,
    addSuggestedGuest: addSuggestedGuest,
    removeGuest: removeGuest,
    toggleAttendance: toggleAttendance,
    generatePrepReport: generatePrepReport,
    exportPrepToDoc: exportPrepToDoc,
    showNewContactFromEvent: showNewContactFromEvent,
    submitNewContactFromEvent: submitNewContactFromEvent,
    // Drag and drop functions
    handleDragStart: handleDragStart,
    handleDragEnd: handleDragEnd,
    handleDragOver: handleDragOver,
    handleDragLeave: handleDragLeave,
    handleDrop: handleDrop,
    // Delete story
    deleteStory: deleteStory,
    // Sidebar toggles
    toggleSidebar: toggleSidebar,
    togglePublishedPanel: togglePublishedPanel,
    // Search bar
    toggleSearchBar: toggleSearchBar,
    filterStories: filterStories,
    clearFilters: clearFilters,
    // Presentation Builder functions
    showPresentationBuilder: showPresentationBuilder,
    generatePresentation: generatePresentation,
    resetPresentationBuilder: resetPresentationBuilder,
    // Add Asset functions
    showAddAssetModal: showAddAssetModal,
    submitAsset: submitAsset,
    onAssetTypeChange: onAssetTypeChange,
    toggleAssetSection: toggleAssetSection,
    toggleTag: toggleTag,
    // Asset affiliation functions
    onPrimarySolutionChange: onPrimarySolutionChange,
    addAssetSolution: addAssetSolution,
    removeAssetSolution: removeAssetSolution,
    // Asset contact picker functions
    searchAssetContacts: searchAssetContacts,
    showAssetContactResults: showAssetContactResults,
    hideAssetContactResults: hideAssetContactResults,
    selectAssetContact: selectAssetContact,
    removeAssetContact: removeAssetContact,
    // Add contact for asset
    showAddContactForAsset: showAddContactForAsset,
    submitContactForAsset: submitContactForAsset,
    // Content view functions (NEW)
    searchContent: searchContent,
    selectContentSolution: selectContentSolution,
    copyContentItem: copyContentItem,
    copyAllContent: copyAllContent,
    showRecentBlurbs: showRecentBlurbs,
    showMostUsed: showMostUsed,
    showByType: showByType,
    resetContentView: resetContentView,
    // Assets view functions (NEW)
    filterAssets: filterAssets,
    showAssetDetail: showAssetDetail,
    closeAssetDetailModal: closeAssetDetailModal,
    copyAssetLink: copyAssetLink,
    showUploadAssetModal: showUploadAssetModal,
    toggleUploadDropzone: toggleUploadDropzone,
    handleUploadDragOver: handleUploadDragOver,
    handleUploadDragLeave: handleUploadDragLeave,
    handleUploadDrop: handleUploadDrop,
    handleFileSelect: handleFileSelect,
    cancelUploadMetadata: cancelUploadMetadata,
    saveUploadedAsset: saveUploadedAsset,
    // Manage view functions (NEW)
    setManageSubtab: setManageSubtab
  };
})();

// Initialize
if (typeof google !== 'undefined' && google.script) {
  COMMS.init();
} else {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() { COMMS.init(); }, 500);
  });
}
</script>
