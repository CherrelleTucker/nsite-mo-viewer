<!-- Comms-NSITE: Communications Pipeline -->
<!-- Story tracking, opportunity detection, and coverage analysis -->

<div class="comms-viewer">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title">
      <h1>Comms-NSITE</h1>
    </div>
    <div class="page-actions">
      <div class="view-toggle">
        <button class="view-btn active" data-view="pipeline" onclick="COMMS.setView('pipeline')">
          <span class="material-icons">view_column</span>
          <span>Pipeline</span>
        </button>
        <button class="view-btn" data-view="events" onclick="COMMS.setView('events')">
          <span class="material-icons">place</span>
          <span>Events</span>
        </button>
        <button class="view-btn" data-view="coverage" onclick="COMMS.setView('coverage')">
          <span class="material-icons">pie_chart</span>
          <span>Coverage</span>
        </button>
        <button class="view-btn" data-view="calendar" onclick="COMMS.setView('calendar')">
          <span class="material-icons">calendar_today</span>
          <span>Calendar</span>
        </button>
        <button class="view-btn" data-view="priorities" onclick="COMMS.setView('priorities')">
          <span class="material-icons">flag</span>
          <span>Priorities</span>
        </button>
        <button class="view-btn" data-view="messages" onclick="COMMS.setView('messages')">
          <span class="material-icons">chat</span>
          <span>Messages</span>
        </button>
      </div>
      <button class="btn btn-primary" onclick="COMMS.showCreateStoryModal()">
        <span class="material-icons">add</span>
        New Story
      </button>
    </div>
  </div>

  <!-- Stats Row (Pipeline only) -->
  <div class="stats-row" id="pipelineStatsRow">
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">description</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statTotalStories">--</span>
        <span class="stat-label">Total Stories</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><span class="material-icons">trending_up</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statInPipeline">--</span>
        <span class="stat-label">In Pipeline</span>
      </div>
    </div>
    <div class="stat-card stat-success">
      <div class="stat-icon"><span class="material-icons">check_circle</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statPublishedQtr">--</span>
        <span class="stat-label">Published (Q)</span>
      </div>
    </div>
    <div class="stat-card stat-warning">
      <div class="stat-icon"><span class="material-icons">warning</span></div>
      <div class="stat-info">
        <span class="stat-value" id="statCoverageGaps">--</span>
        <span class="stat-label">Coverage Gaps</span>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="comms-content">
    <!-- Pipeline View -->
    <div class="view-panel active" id="pipelineView">
      <div class="pipeline-layout">
        <!-- Collapsible Sidebar: Opportunities + Coverage Gaps -->
        <div class="insights-sidebar" id="insightsSidebar">
          <div class="sidebar-toggle" onclick="COMMS.toggleSidebar()">
            <span class="material-icons" id="sidebarToggleIcon">chevron_left</span>
          </div>
          <div class="sidebar-content">
            <!-- Story Opportunities -->
            <div class="sidebar-section">
              <div class="sidebar-section-header">
                <h4>Story Opportunities</h4>
              </div>
              <div class="sidebar-section-content" id="opportunitiesPanel">
                <div class="loading-state">
                  <span class="loading-spinner"></span>
                </div>
              </div>
            </div>

            <!-- Coverage Gaps -->
            <div class="sidebar-section">
              <div class="sidebar-section-header">
                <h4>Coverage Gaps</h4>
                <button class="btn btn-sm btn-icon" onclick="COMMS.setView('coverage')" title="Full View">
                  <span class="material-icons">fullscreen</span>
                </button>
              </div>
              <div class="sidebar-section-content" id="coverageGapsPanel">
                <div class="loading-state">
                  <span class="loading-spinner"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Pipeline Area -->
        <div class="pipeline-main">
      <!-- Story Pipeline -->
      <div class="pipeline-section">
        <!-- Collapsible Search/Filter Bar -->
        <div class="pipeline-search-bar" id="pipelineSearchBar">
          <button class="search-toggle-btn" onclick="COMMS.toggleSearchBar()" title="Search & Filter">
            <span class="material-icons">search</span>
          </button>
          <div class="search-bar-content" id="searchBarContent">
            <div class="search-input-wrapper">
              <input type="text" id="searchInput" placeholder="Search stories..." oninput="COMMS.filterStories()">
            </div>
            <select id="filterType" onchange="COMMS.filterStories()">
              <option value="">All Types</option>
              <option value="press_release">Press Release</option>
              <option value="web_content">Web Content</option>
              <option value="social_media">Social Media</option>
              <option value="nugget">Nugget</option>
              <option value="external_mention">External Mention</option>
              <option value="key_date">Key Date</option>
            </select>
            <select id="filterChannel" onchange="COMMS.filterStories()">
              <option value="">All Channels</option>
              <option value="nasa_gov">nasa.gov</option>
              <option value="social">Social</option>
              <option value="internal">Internal</option>
              <option value="media">Media</option>
            </select>
            <button class="btn btn-sm btn-secondary" onclick="COMMS.clearFilters()" title="Clear filters">
              <span class="material-icons">clear</span>
            </button>
          </div>
        </div>

        <div class="pipeline-board" id="pipelineBoard">
          <!-- Idea Column -->
          <div class="pipeline-column" data-status="idea" ondragover="COMMS.handleDragOver(event)" ondrop="COMMS.handleDrop(event, 'idea')" ondragleave="COMMS.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title">Idea</span>
              <span class="column-count" id="countIdea">0</span>
            </div>
            <div class="column-cards" id="cardsIdea"></div>
          </div>
          <!-- Researching Column -->
          <div class="pipeline-column" data-status="researching" ondragover="COMMS.handleDragOver(event)" ondrop="COMMS.handleDrop(event, 'researching')" ondragleave="COMMS.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title">Researching</span>
              <span class="column-count" id="countResearching">0</span>
            </div>
            <div class="column-cards" id="cardsResearching"></div>
          </div>
          <!-- Drafting Column -->
          <div class="pipeline-column" data-status="drafting" ondragover="COMMS.handleDragOver(event)" ondrop="COMMS.handleDrop(event, 'drafting')" ondragleave="COMMS.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title">Drafting</span>
              <span class="column-count" id="countDrafting">0</span>
            </div>
            <div class="column-cards" id="cardsDrafting"></div>
          </div>
          <!-- Review Column -->
          <div class="pipeline-column" data-status="review" ondragover="COMMS.handleDragOver(event)" ondrop="COMMS.handleDrop(event, 'review')" ondragleave="COMMS.handleDragLeave(event)">
            <div class="column-header">
              <span class="column-title">Review</span>
              <span class="column-count" id="countReview">0</span>
            </div>
            <div class="column-cards" id="cardsReview"></div>
          </div>
        </div>
      </div><!-- /.pipeline-section -->
        </div><!-- /.pipeline-main -->

        <!-- Collapsible Published Panel -->
        <div class="published-sidebar" id="publishedSidebar">
          <div class="sidebar-toggle" onclick="COMMS.togglePublishedPanel()">
            <span class="material-icons" id="publishedToggleIcon">chevron_right</span>
          </div>
          <div class="sidebar-content">
            <div class="sidebar-section">
              <div class="sidebar-section-header">
                <h4>Published</h4>
                <span class="column-count" id="countPublished">0</span>
              </div>
              <div class="sidebar-section-content published-cards" id="cardsPublished"
                   ondragover="COMMS.handleDragOver(event)"
                   ondrop="COMMS.handleDrop(event, 'published')"
                   ondragleave="COMMS.handleDragLeave(event)">
              </div>
            </div>
          </div>
        </div>
      </div><!-- /.pipeline-layout -->
    </div>

    <!-- Coverage View -->
    <div class="view-panel" id="coverageView">
      <div class="coverage-layout">
        <!-- Coverage Summary -->
        <div class="coverage-summary">
          <div class="summary-card">
            <div class="summary-icon covered"><span class="material-icons">check_circle</span></div>
            <div class="summary-info">
              <span class="summary-value" id="coverageWellCovered">--</span>
              <span class="summary-label">Well Covered</span>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon attention"><span class="material-icons">error</span></div>
            <div class="summary-info">
              <span class="summary-value" id="coverageNeedsAttention">--</span>
              <span class="summary-label">Needs Attention</span>
            </div>
          </div>
          <div class="summary-card">
            <div class="summary-icon uncovered"><span class="material-icons">cancel</span></div>
            <div class="summary-info">
              <span class="summary-value" id="coverageNoStories">--</span>
              <span class="summary-label">No Stories</span>
            </div>
          </div>
        </div>

        <!-- Coverage Table -->
        <div class="coverage-table-container">
          <table class="coverage-table" id="coverageTable">
            <thead>
              <tr>
                <th>Solution</th>
                <th>Phase</th>
                <th>Total Stories</th>
                <th>Recent (90d)</th>
                <th>Last Story</th>
                <th>Days Since</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="coverageTableBody">
              <tr>
                <td colspan="8" class="loading-state">
                  <span class="loading-spinner"></span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Calendar View -->
    <div class="view-panel" id="calendarView">
      <div class="calendar-layout">
        <div class="calendar-header">
          <button class="btn btn-sm btn-secondary" onclick="COMMS.navigateCalendar(-1)">
            <span class="material-icons">chevron_left</span>
          </button>
          <h3 id="calendarTitle">January 2026</h3>
          <button class="btn btn-sm btn-secondary" onclick="COMMS.navigateCalendar(1)">
            <span class="material-icons">chevron_right</span>
          </button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar will be rendered here -->
        </div>
        <div class="calendar-sidebar">
          <div class="upcoming-targets">
            <h4>Upcoming Targets</h4>
            <div id="upcomingTargetsList">
              <div class="loading-state">
                <span class="loading-spinner"></span>
              </div>
            </div>
          </div>
          <div class="comms-due-section">
            <h4><span class="material-icons" style="font-size: 18px; vertical-align: text-bottom;">notification_important</span> Communications Due</h4>
            <div id="commsDueList">
              <div class="loading-state">
                <span class="loading-spinner"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Priorities View -->
    <div class="view-panel" id="prioritiesView">
      <div class="priorities-layout">
        <div class="priorities-header">
          <h2>Admin Priorities Alignment</h2>
          <p class="priorities-subtitle">Track story coverage across administration priorities</p>
        </div>

        <!-- Priority Cards -->
        <div class="priorities-grid" id="prioritiesGrid">
          <!-- Partnerships -->
          <div class="priority-card" data-priority="partnerships">
            <div class="priority-header">
              <span class="material-icons">group</span>
              <h3>Partnerships & Decision Support</h3>
            </div>
            <div class="priority-stats">
              <span class="priority-count" id="priorityCountPartnerships">0</span>
              <span class="priority-label">stories</span>
            </div>
            <div class="priority-stories" id="priorityStoriesPartnerships">
              <div class="empty-state">No stories tagged</div>
            </div>
          </div>

          <!-- Citizens -->
          <div class="priority-card" data-priority="citizens">
            <div class="priority-header">
              <span class="material-icons">home</span>
              <h3>Benefits to American Citizens</h3>
            </div>
            <div class="priority-stats">
              <span class="priority-count" id="priorityCountCitizens">0</span>
              <span class="priority-label">stories</span>
            </div>
            <div class="priority-stories" id="priorityStoriesCitizens">
              <div class="empty-state">No stories tagged</div>
            </div>
          </div>

          <!-- AI Innovation -->
          <div class="priority-card" data-priority="ai_innovation">
            <div class="priority-header">
              <span class="material-icons">memory</span>
              <h3>AI Leadership & Tech Innovation</h3>
            </div>
            <div class="priority-stats">
              <span class="priority-count" id="priorityCountAiInnovation">0</span>
              <span class="priority-label">stories</span>
            </div>
            <div class="priority-stories" id="priorityStoriesAiInnovation">
              <div class="empty-state">No stories tagged</div>
            </div>
          </div>

          <!-- Science Integrity -->
          <div class="priority-card" data-priority="science_integrity">
            <div class="priority-header">
              <span class="material-icons">emoji_events</span>
              <h3>Gold Standard Science & Research Integrity</h3>
            </div>
            <div class="priority-stats">
              <span class="priority-count" id="priorityCountScienceIntegrity">0</span>
              <span class="priority-label">stories</span>
            </div>
            <div class="priority-stories" id="priorityStoriesScienceIntegrity">
              <div class="empty-state">No stories tagged</div>
            </div>
          </div>

          <!-- Efficiency -->
          <div class="priority-card" data-priority="efficiency">
            <div class="priority-header">
              <span class="material-icons">flash_on</span>
              <h3>Government Efficiency</h3>
            </div>
            <div class="priority-stats">
              <span class="priority-count" id="priorityCountEfficiency">0</span>
              <span class="priority-label">stories</span>
            </div>
            <div class="priority-stories" id="priorityStoriesEfficiency">
              <div class="empty-state">No stories tagged</div>
            </div>
          </div>

          <!-- Untagged -->
          <div class="priority-card priority-card-warning" data-priority="untagged">
            <div class="priority-header">
              <span class="material-icons">error</span>
              <h3>Not Yet Aligned</h3>
            </div>
            <div class="priority-stats">
              <span class="priority-count" id="priorityCountUntagged">0</span>
              <span class="priority-label">stories need tagging</span>
            </div>
            <div class="priority-stories" id="priorityStoriesUntagged">
              <div class="empty-state">All stories tagged!</div>
            </div>
          </div>
        </div>

        <!-- Priority Summary -->
        <div class="priorities-summary">
          <h3>Coverage Summary</h3>
          <div class="priority-bars" id="priorityBars">
            <!-- Will be rendered by JS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Key Messages View -->
    <div class="view-panel" id="messagesView">
      <div class="messages-layout">
        <div class="messages-header">
          <h2>Solution Key Messages</h2>
          <p class="messages-subtitle">Approved messaging for communications and outreach</p>
          <div class="messages-search">
            <span class="material-icons">search</span>
            <input type="text" id="messagesSearchInput" placeholder="Search messages..." oninput="COMMS.searchMessages()">
          </div>
        </div>

        <!-- Messages Summary -->
        <div class="messages-summary" id="messagesSummary">
          <div class="summary-stat">
            <span class="summary-value" id="msgTotalSolutions">--</span>
            <span class="summary-label">Solutions with Messages</span>
          </div>
          <div class="summary-stat">
            <span class="summary-value" id="msgCoverage">--</span>
            <span class="summary-label">Coverage</span>
          </div>
          <div class="summary-stat">
            <span class="summary-value" id="msgByFocus">--</span>
            <span class="summary-label">Focus Types</span>
          </div>
        </div>

        <!-- Messages Grid -->
        <div class="messages-grid" id="messagesGrid">
          <div class="loading-state">
            <span class="loading-spinner"></span>
            <span>Loading key messages...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Events View -->
    <div class="view-panel" id="eventsView">
      <div class="events-layout">
        <!-- Events Header -->
        <div class="events-header">
          <div class="events-stats">
            <div class="event-stat">
              <span class="event-stat-value" id="eventStatUpcoming">--</span>
              <span class="event-stat-label">Upcoming</span>
            </div>
            <div class="event-stat">
              <span class="event-stat-value" id="eventStatConfirmed">--</span>
              <span class="event-stat-label">Confirmed</span>
            </div>
            <div class="event-stat">
              <span class="event-stat-value" id="eventStatPotential">--</span>
              <span class="event-stat-label">Potential</span>
            </div>
            <div class="event-stat">
              <span class="event-stat-value" id="eventStatDeadlines">--</span>
              <span class="event-stat-label">Deadlines (30d)</span>
            </div>
          </div>
          <div class="events-actions">
            <select id="eventYearFilter" onchange="COMMS.filterEvents()">
              <option value="">All Years</option>
              <option value="2025">2025</option>
              <option value="2026" selected>2026</option>
              <option value="2027">2027</option>
            </select>
            <select id="eventStatusFilter" onchange="COMMS.filterEvents()">
              <option value="">All Status</option>
              <option value="potential">Potential</option>
              <option value="considering">Considering</option>
              <option value="confirmed">Confirmed</option>
              <option value="attended">Attended</option>
            </select>
            <button class="btn btn-primary" onclick="COMMS.showAddEventModal()">
              <span class="material-icons">add</span>
              Add Event
            </button>
          </div>
        </div>

        <!-- Events Grid -->
        <div class="events-content">
          <!-- Upcoming Events -->
          <div class="events-panel">
            <div class="panel-header">
              <h3>Upcoming Events</h3>
            </div>
            <div class="panel-content" id="upcomingEventsPanel">
              <div class="loading-state">
                <span class="loading-spinner"></span>
              </div>
            </div>
          </div>

          <!-- Event Opportunities (Potential) -->
          <div class="events-panel">
            <div class="panel-header">
              <h3>Event Opportunities</h3>
              <span class="badge" id="potentialBadge">0</span>
            </div>
            <div class="panel-content" id="potentialEventsPanel">
              <div class="loading-state">
                <span class="loading-spinner"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Events Table -->
        <div class="events-table-container">
          <table class="events-table" id="eventsTable">
            <thead>
              <tr>
                <th>Event</th>
                <th>Type</th>
                <th>Date</th>
                <th>Location</th>
                <th>Status</th>
                <th>Team</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="eventsTableBody">
              <tr>
                <td colspan="7" class="loading-state">
                  <span class="loading-spinner"></span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Story Detail Modal -->
<div class="modal-overlay" id="storyModal" onclick="COMMS.closeModal('storyModal', event)">
  <div class="modal-content modal-lg" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="modalStoryTitle">Story Details</h2>
      <button class="modal-close" onclick="COMMS.closeModal('storyModal')">&times;</button>
    </div>
    <div class="modal-body" id="storyModalBody">
      <!-- Dynamic content -->
    </div>
  </div>
</div>

<!-- Create/Edit Story Modal -->
<div class="modal-overlay" id="editStoryModal" onclick="COMMS.closeModal('editStoryModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="editStoryModalTitle">New Story</h2>
      <button class="modal-close" onclick="COMMS.closeModal('editStoryModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="storyForm" onsubmit="COMMS.submitStory(event)">
        <input type="hidden" id="editStoryId">
        <div class="form-row">
          <div class="form-group form-group-wide">
            <label>Title *</label>
            <input type="text" id="storyTitle" required placeholder="Story title">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Content Type</label>
            <select id="storyContentType">
              <option value="story">Impact Story</option>
              <option value="web_content">Web Content</option>
              <option value="social_media">Social Media</option>
              <option value="external_mention">External Mention</option>
              <option value="nugget">Nugget Slide</option>
              <option value="key_date">Key Date</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="storyStatus">
              <option value="idea">Idea</option>
              <option value="researching">Researching</option>
              <option value="drafting">Drafting</option>
              <option value="review">Review</option>
              <option value="published">Published</option>
            </select>
          </div>
          <div class="form-group">
            <label>Priority</label>
            <select id="storyPriority">
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="low">Low</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Channel</label>
            <select id="storyChannel">
              <option value="web">Web</option>
              <option value="social">Social</option>
              <option value="slide">Slide</option>
              <option value="external">External</option>
              <option value="newsletter">Newsletter</option>
            </select>
          </div>
          <div class="form-group">
            <label>Primary Outlet</label>
            <input type="text" id="storyOutlet" placeholder="Target publication">
          </div>
          <div class="form-group">
            <label>Author</label>
            <input type="text" id="storyAuthor" placeholder="Story author">
          </div>
        </div>
        <div class="form-group">
          <label>Solution</label>
          <select id="storySolution" required>
            <option value="">-- Select Solution --</option>
            <option value="3d-topo">3D Topographic Mapping</option>
            <option value="admg">ADMG</option>
            <option value="aq">Air Quality</option>
            <option value="aq_gmao">Air Quality - GMAO</option>
            <option value="aq_pandora">Pandora</option>
            <option value="aq_pandora-ongoing">Pandora Ongoing</option>
            <option value="aq_pm">Air Quality - PM</option>
            <option value="csda">CSDA</option>
            <option value="dcd">DCD</option>
            <option value="firms-2g">FIRMS-2G</option>
            <option value="gaban">GABAN</option>
            <option value="gacr">GACR</option>
            <option value="gcc">GCC</option>
            <option value="global-et">Evapotranspiration (ET)</option>
            <option value="grace-fo">GRACE-FO</option>
            <option value="harm-tir">Harmonized TIR</option>
            <option value="hls">HLS</option>
            <option value="hls_10m">HLS 10-m</option>
            <option value="hls_et">HLS ET</option>
            <option value="hls_ll">HLS Low Latency</option>
            <option value="hls_lst">HLS Land Surface Temperature</option>
            <option value="hls_vi">HLS Vegetation Indices</option>
            <option value="icesat">ICESat-2 Lake Ice/Freeboard</option>
            <option value="ioa">Internet of Animals</option>
            <option value="mo">MO General</option>
            <option value="mo_assess">MO Assessment</option>
            <option value="mo_comms">MO Comms</option>
            <option value="mo_impl">MO Implementation</option>
            <option value="mo_sep">MO SEP</option>
            <option value="mwow">MWOW</option>
            <option value="nga">NGA</option>
            <option value="nisar_dl">NISAR Downlink</option>
            <option value="nisar_hi_res">NISAR High Resolution</option>
            <option value="nisar_sm">NISAR Soil Moisture</option>
            <option value="opera">OPERA</option>
            <option value="opera_disp">OPERA DISP</option>
            <option value="opera_dist">OPERA DIST</option>
            <option value="opera_dswx">OPERA DSWx</option>
            <option value="pbl">PBL</option>
            <option value="pbl_height">PBL Height</option>
            <option value="sss">Sea Surface Salinity</option>
            <option value="targeted_rs">Remote Sensing Training</option>
            <option value="tempo_enhanced">TEMPO Enhanced</option>
            <option value="tempo_nrt">TEMPO NRT</option>
            <option value="vlm">VLM</option>
            <option value="volcano">Volcano Monitoring</option>
            <option value="water-quality">Water Quality</option>
          </select>
        </div>
        <div class="form-group">
          <label>Admin Priorities (check all that apply)</label>
          <div class="checkbox-group" id="storyAdminPriorities">
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="partnerships">
              <span>Partnerships & Decision Support</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="citizens">
              <span>Benefits to American Citizens</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="ai_innovation">
              <span>AI Leadership & Tech Innovation</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="science_integrity">
              <span>Gold Standard Science & Research Integrity</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="adminPriority" value="efficiency">
              <span>Government Efficiency</span>
            </label>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Target Date</label>
            <input type="date" id="storyTargetDate">
          </div>
          <div class="form-group">
            <label>Publish Date</label>
            <input type="date" id="storyPublishDate">
          </div>
        </div>
        <div class="form-group">
          <label>Source / Origin</label>
          <input type="text" id="storySource" placeholder="Where did this idea come from?">
        </div>
        <div class="form-group">
          <label>Pitch/Draft Document URL</label>
          <input type="url" id="storyPitchUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Published Link</label>
          <input type="url" id="storyPublishedLink" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="storyNotes" rows="3" maxlength="2000" placeholder="Additional notes..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="COMMS.closeModal('editStoryModal')">Cancel</button>
          <button type="submit" id="saveStoryBtn" class="btn btn-primary">Save Story</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Event Modal -->
<div class="modal-overlay" id="addEventModal" onclick="COMMS.closeModal('addEventModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Add New Event</h2>
      <button class="modal-close" onclick="COMMS.closeModal('addEventModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addEventForm" onsubmit="COMMS.submitNewEvent(event)">
        <div class="form-group">
          <label>Event Name *</label>
          <input type="text" id="newEventName" required placeholder="e.g., AGU Fall Meeting 2026">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Event Type</label>
            <select id="newEventType">
              <option value="conference">Conference</option>
              <option value="workshop">Workshop</option>
              <option value="webinar">Webinar</option>
              <option value="meeting">Meeting</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="newEventStatus">
              <option value="potential">Potential</option>
              <option value="researching">Researching</option>
              <option value="confirmed">Confirmed</option>
              <option value="declined">Declined</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="newEventStartDate">
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="date" id="newEventEndDate">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Sector</label>
            <select id="newEventSector">
              <option value="">-- Select Sector --</option>
              <option value="Agriculture">Agriculture</option>
              <option value="Water Resources">Water Resources</option>
              <option value="Disasters">Disasters</option>
              <option value="Ecological Conservation">Ecological Conservation</option>
              <option value="Climate">Climate</option>
              <option value="Wildland Fires">Wildland Fires</option>
              <option value="Land Use">Land Use</option>
              <option value="Energy">Energy</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Event URL</label>
          <input type="url" id="newEventUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="newEventNotes" rows="3" maxlength="2000" placeholder="Any additional details..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="COMMS.closeModal('addEventModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Event</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Event Detail Modal (Tabbed) -->
<div class="modal-overlay" id="eventModal" onclick="COMMS.closeModal('eventModal', event)">
  <div class="modal-content modal-lg" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="modalEventName">Event Details</h2>
      <button class="modal-close" onclick="COMMS.closeModal('eventModal')">&times;</button>
    </div>
    <!-- Modal Tabs -->
    <div class="modal-tabs">
      <button class="modal-tab active" data-tab="details" onclick="COMMS.switchEventTab('details')">
        <span class="material-icons">info</span> Details
      </button>
      <button class="modal-tab" data-tab="guests" onclick="COMMS.switchEventTab('guests')">
        <span class="material-icons">people</span> Guest List
        <span class="tab-badge" id="guestCountBadge">0</span>
      </button>
      <button class="modal-tab" data-tab="prep" onclick="COMMS.switchEventTab('prep')">
        <span class="material-icons">assignment</span> Prep Report
      </button>
    </div>
    <div class="modal-body">
      <!-- Details Tab -->
      <div class="tab-panel active" id="eventDetailsTab">
        <div id="eventModalBody">
          <!-- Dynamic content -->
        </div>
      </div>
      <!-- Guest List Tab -->
      <div class="tab-panel" id="eventGuestsTab">
        <div class="guest-list-container">
          <!-- Search contacts to add -->
          <div class="guest-search-section">
            <h4>Add Guests</h4>
            <div class="guest-search-input">
              <span class="material-icons">search</span>
              <input type="text" id="guestSearchInput" placeholder="Search contacts by name or email..." oninput="COMMS.searchContactsForGuest()">
            </div>
            <div class="guest-search-results" id="guestSearchResults">
              <div class="empty-state-sm">Search to find contacts</div>
            </div>
          </div>
          <!-- Current guest list -->
          <div class="guest-list-section">
            <h4>Expected Guests</h4>
            <div class="guest-list" id="currentGuestList">
              <div class="empty-state-sm">No guests added yet</div>
            </div>
          </div>
        </div>
      </div>
      <!-- Prep Report Tab -->
      <div class="tab-panel" id="eventPrepTab">
        <div class="prep-report-container" id="prepReportContent">
          <div class="prep-actions">
            <button class="btn btn-primary" onclick="COMMS.generatePrepReport()">
              <span class="material-icons">description</span>
              Generate Prep Report
            </button>
            <button class="btn btn-secondary" id="exportPrepBtn" onclick="COMMS.exportPrepToDoc()" style="display:none;">
              <span class="material-icons">open_in_new</span>
              Export to Doc
            </button>
          </div>
          <div id="prepReportBody">
            <div class="empty-state">
              <span class="material-icons">assignment</span>
              <p>Click "Generate Prep Report" to create a preparation report for this event</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Contact from Event Modal -->
<div class="modal-overlay" id="newContactFromEventModal" onclick="COMMS.closeModal('newContactFromEventModal', event)">
  <div class="modal-content modal-md" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Add New Contact</h2>
      <button class="modal-close" onclick="COMMS.closeModal('newContactFromEventModal')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="newContactFromEventForm" onsubmit="COMMS.submitNewContactFromEvent(event)">
        <div class="form-row">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" id="newContactFirstName" required>
          </div>
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" id="newContactLastName" required>
          </div>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="newContactEmail" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Agency/Organization</label>
            <input type="text" id="newContactAgency">
          </div>
          <div class="form-group">
            <label>Title</label>
            <input type="text" id="newContactTitle">
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="newContactNotes" rows="2" placeholder="How did you meet? Any follow-up needed?"></textarea>
        </div>
        <div class="form-group">
          <label class="checkbox-item">
            <input type="checkbox" id="addToGuestList" checked>
            <span>Add to this event's guest list</span>
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="COMMS.closeModal('newContactFromEventModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Contact</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Comms Styles -->
<style>
  /* Page accent color for shared styles */
  .comms-viewer {
    --page-accent: var(--color-comms);
    max-width: 1600px;
    margin: 0 auto;
  }

  /* Header Search (like SEP's cycle filter) */
  .header-search {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
  }
  .header-search .material-icons {
    font-size: 18px;
    color: var(--color-text-muted);
  }
  .header-search input {
    border: none;
    outline: none;
    font-size: var(--font-size-sm);
    width: 180px;
    background: transparent;
  }

  /* Pipeline Filters (inline in section header) */
  .pipeline-filters {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }
  .pipeline-filters select {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    background: var(--color-surface);
  }
  .pipeline-filters select:focus {
    outline: none;
    border-color: var(--color-comms);
  }

  /* Comms Pipeline Customizations */

  /* Comms dot colors (story status) */
  .dot-idea { background: #9E9E9E; }
  .dot-research { background: #2196F3; }
  .dot-draft { background: #FF9800; }
  .dot-review { background: #9C27B0; }
  .dot-published { background: #4CAF50; }

  /* Comms column customizations */
  .comms-viewer .pipeline-column { min-width: 200px; }
  .comms-viewer .column-header {
    border-top: 3px solid var(--color-comms);
  }

  /* Drag and drop styles */
  .comms-viewer .story-card {
    cursor: grab;
    transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
  }
  .comms-viewer .story-card:active {
    cursor: grabbing;
  }
  .comms-viewer .story-card.dragging {
    opacity: 0.5;
    transform: rotate(2deg);
    box-shadow: var(--shadow-lg);
  }
  .comms-viewer .pipeline-column.drop-target {
    background: rgba(233, 30, 99, 0.08);
    border: 2px dashed var(--color-comms);
  }
  .comms-viewer .pipeline-column.drop-target .column-cards {
    min-height: 100px;
  }

  /* Collapsible Sidebar Layout */
  .pipeline-layout {
    display: flex;
    gap: var(--space-md);
    height: 100%;
  }
  .insights-sidebar {
    width: 280px;
    min-width: 280px;
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    position: relative;
    transition: width 0.3s ease, min-width 0.3s ease;
    overflow: hidden;
  }
  .insights-sidebar.collapsed {
    width: 40px;
    min-width: 40px;
  }
  .insights-sidebar.collapsed .sidebar-content {
    opacity: 0;
    visibility: hidden;
  }
  .sidebar-toggle {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface-alt);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    cursor: pointer;
    z-index: 1;
    transition: transform 0.3s ease;
  }
  .sidebar-toggle:hover {
    background: var(--color-border-light);
  }
  .insights-sidebar.collapsed .sidebar-toggle {
    right: 8px;
    transform: rotate(180deg);
  }
  .sidebar-content {
    padding: var(--space-md);
    padding-top: 40px;
    overflow-y: auto;
    flex: 1;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }
  .sidebar-section {
    margin-bottom: var(--space-md);
  }
  .sidebar-section:last-child {
    margin-bottom: 0;
  }
  .sidebar-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--color-border-light);
  }
  .sidebar-section-header h4 {
    margin: 0;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-comms);
  }
  .sidebar-section-content {
    max-height: 250px;
    overflow-y: auto;
  }
  .pipeline-main {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }

  /* Override pipeline-board to use 4 columns (Published is in sidebar) */
  .comms-viewer .pipeline-board {
    grid-template-columns: repeat(4, 1fr);
    flex: 1;
  }

  /* Collapsible Search Bar */
  .pipeline-search-bar {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
    height: 36px;
  }
  .search-toggle-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    cursor: pointer;
    color: var(--color-text-secondary);
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  .search-toggle-btn:hover {
    background: var(--color-surface-alt);
    color: var(--color-comms);
    border-color: var(--color-comms);
  }
  .pipeline-search-bar.expanded .search-toggle-btn {
    background: var(--color-comms);
    color: white;
    border-color: var(--color-comms);
  }
  .search-bar-content {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    overflow: hidden;
    max-width: 0;
    opacity: 0;
    transition: max-width 0.3s ease, opacity 0.2s ease;
  }
  .pipeline-search-bar.expanded .search-bar-content {
    max-width: 600px;
    opacity: 1;
  }
  .search-input-wrapper {
    position: relative;
  }
  .search-input-wrapper input {
    width: 180px;
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }
  .search-input-wrapper input:focus {
    outline: none;
    border-color: var(--color-comms);
    box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.1);
  }
  .search-bar-content select {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    background: var(--color-surface);
    cursor: pointer;
  }
  .search-bar-content select:focus {
    outline: none;
    border-color: var(--color-comms);
  }
  /* Published Sidebar (right side) */
  .published-sidebar {
    width: 250px;
    min-width: 250px;
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    position: relative;
    transition: width 0.3s ease, min-width 0.3s ease;
    overflow: hidden;
  }
  .published-sidebar.collapsed {
    width: 40px;
    min-width: 40px;
  }
  .published-sidebar.collapsed .sidebar-content {
    opacity: 0;
    visibility: hidden;
  }
  .published-sidebar .sidebar-toggle {
    left: 8px;
    right: auto;
  }
  .published-sidebar.collapsed .sidebar-toggle {
    transform: rotate(180deg);
  }
  .published-sidebar .sidebar-section-header {
    border-bottom-color: var(--color-success);
  }
  .published-sidebar .sidebar-section-header h4 {
    color: var(--color-success);
  }
  .published-sidebar .sidebar-section-content {
    max-height: none;
    flex: 1;
  }
  .published-cards {
    min-height: 200px;
    padding: var(--space-xs);
    border-radius: var(--radius-sm);
    transition: background 0.2s;
  }
  .published-cards.drop-target {
    background: rgba(76, 175, 80, 0.08);
    border: 2px dashed var(--color-success);
  }

  /* Comms story card header */
  .story-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 4px;
  }
  .card-type {
    font-size: var(--font-size-xs);
    padding: 2px 6px;
    background: rgba(123, 31, 162, 0.1);
    color: var(--color-comms);
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    font-weight: 500;
  }
  .card-type.type-web_content { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
  .card-type.type-social_media { background: rgba(0, 150, 136, 0.1); color: #009688; }
  .card-type.type-external_mention { background: rgba(96, 125, 139, 0.1); color: #607D8B; }
  .card-type.type-nugget { background: rgba(255, 152, 0, 0.1); color: #FF9800; }
  .card-type.type-key_date { background: rgba(244, 67, 54, 0.1); color: #F44336; }
  .card-date { font-size: var(--font-size-xs); color: var(--color-text-muted); }
  .card-title {
    font-weight: 600;
    font-size: var(--font-size-sm);
    color: var(--color-text);
    margin-bottom: 4px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .card-solutions {
    font-size: var(--font-size-xs);
    color: var(--color-comms);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 4px;
  }
  .card-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 10px;
    color: var(--color-text-muted);
    padding-top: 4px;
    border-top: 1px solid var(--color-border-light);
  }
  .card-channel {
    display: flex;
    align-items: center;
    gap: 2px;
  }
  .card-channel svg { width: 12px; height: 12px; }

  /* Bottom Panels */
  .bottom-panels,
  .top-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
  }
  .top-panels {
    margin-bottom: var(--space-lg);
  }
  .panel {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-bottom: 1px solid var(--color-border-light);
  }
  .panel-header h3 { font-size: var(--font-size-md); font-weight: 600; margin: 0; }
  .panel-content { padding: var(--space-md); max-height: 300px; overflow-y: auto; }

  /* Opportunity Items */
  .opportunity-item {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--color-comms);
    margin-bottom: var(--space-sm);
    background: var(--color-surface-alt);
    cursor: pointer;
    transition: background var(--transition-fast);
  }
  .opportunity-item:hover { background: var(--color-border-light); }
  .opportunity-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(123, 31, 162, 0.1);
    border-radius: var(--radius-sm);
    color: var(--color-comms);
    flex-shrink: 0;
  }
  .opportunity-icon svg { width: 16px; height: 16px; }
  .opportunity-icon.milestone { background: rgba(76, 175, 80, 0.1); color: var(--color-success); }
  .opportunity-icon.t8 { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
  .opportunity-info { flex: 1; min-width: 0; }
  .opportunity-title { font-weight: 500; font-size: var(--font-size-sm); margin-bottom: 2px; }
  .opportunity-desc { font-size: var(--font-size-xs); color: var(--color-text-secondary); }

  /* Coverage Gap Items */
  .gap-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
    background: var(--color-surface-alt);
  }
  .gap-item.severe { border-left: 3px solid var(--color-error); }
  .gap-item.moderate { border-left: 3px solid var(--color-warning); }
  .gap-info { flex: 1; }
  .gap-solution { font-weight: 500; font-size: var(--font-size-sm); }
  .gap-days { font-size: var(--font-size-xs); color: var(--color-text-muted); }
  .gap-action {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-xs);
    background: var(--color-comms);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
  }

  /* Coverage View */
  .coverage-layout { padding: var(--space-md); }
  .coverage-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }
  .summary-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }
  .summary-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
  }
  .summary-icon.covered { background: rgba(76, 175, 80, 0.1); color: var(--color-success); }
  .summary-icon.attention { background: rgba(255, 152, 0, 0.1); color: var(--color-warning); }
  .summary-icon.uncovered { background: rgba(244, 67, 54, 0.1); color: var(--color-error); }
  .summary-icon svg { width: 24px; height: 24px; }
  .summary-value { font-size: var(--font-size-xl); font-weight: 700; }
  .summary-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); }

  .coverage-table-container {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .coverage-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-sm);
  }
  .coverage-table th {
    background: var(--color-surface-alt);
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid var(--color-border);
  }
  .coverage-table td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
  }
  .coverage-table tr:hover { background: var(--color-surface-alt); }
  .status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: var(--font-size-xs);
    font-weight: 500;
  }
  .status-badge.covered { background: rgba(76, 175, 80, 0.1); color: var(--color-success); }
  .status-badge.attention { background: rgba(255, 152, 0, 0.1); color: var(--color-warning); }
  .status-badge.uncovered { background: rgba(244, 67, 54, 0.1); color: var(--color-error); }

  /* Calendar View */
  .calendar-layout {
    padding: var(--space-md);
    display: grid;
    grid-template-columns: 1fr 300px;
    grid-template-rows: auto 1fr;
    gap: var(--space-md);
  }
  .calendar-layout .calendar-header {
    grid-column: 1 / -1;
  }
  .calendar-layout .calendar-grid {
    grid-column: 1;
  }
  .calendar-layout .calendar-sidebar {
    grid-column: 2;
    grid-row: 2;
  }
  @media (max-width: 1000px) {
    .calendar-layout {
      grid-template-columns: 1fr;
    }
    .calendar-layout .calendar-sidebar {
      grid-column: 1;
      grid-row: 3;
    }
  }
  .calendar-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-lg);
    margin-bottom: var(--space-md);
  }
  .calendar-header h3 { margin: 0; min-width: 200px; text-align: center; }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    margin-bottom: var(--space-lg);
  }
  .calendar-day-header {
    background: var(--color-surface-alt);
    padding: var(--space-sm);
    text-align: center;
    font-weight: 600;
    font-size: var(--font-size-sm);
  }
  .calendar-day {
    background: var(--color-surface);
    min-height: 80px;
    padding: var(--space-xs);
  }
  .calendar-day.other-month { background: var(--color-surface-alt); opacity: 0.5; }
  .calendar-day.today { background: rgba(123, 31, 162, 0.05); }
  .calendar-day-number {
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-bottom: var(--space-xs);
  }
  .calendar-event {
    font-size: var(--font-size-xs);
    padding: 2px 4px;
    background: var(--color-comms);
    color: white;
    border-radius: 2px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
  }
  .calendar-event.published { background: var(--color-success); }
  .calendar-event.target { background: var(--color-warning); }

  .upcoming-targets {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-sm);
  }
  .upcoming-targets h4 { margin: 0 0 var(--space-md) 0; }
  .target-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    border-left: 3px solid var(--color-warning);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .target-info { flex: 1; }
  .target-title { font-weight: 500; font-size: var(--font-size-sm); }
  .target-date { font-size: var(--font-size-xs); color: var(--color-text-muted); }

  /* Calendar Sidebar */
  .calendar-sidebar {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  /* Comms Due Section */
  .comms-due-section {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    box-shadow: var(--shadow-sm);
  }
  .comms-due-section h4 {
    margin: 0 0 var(--space-md) 0;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    color: var(--color-warning);
  }
  .comms-due-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
  }
  .comms-due-item:hover { background: var(--color-border-light); }
  .comms-due-item.urgent { border-left: 3px solid var(--color-error); }
  .comms-due-item.warning { border-left: 3px solid var(--color-warning); }
  .comms-due-info { flex: 1; min-width: 0; }
  .comms-due-solution {
    font-weight: 500;
    font-size: var(--font-size-sm);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .comms-due-days {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .comms-due-days.urgent { color: var(--color-error); font-weight: 500; }
  .comms-due-days.warning { color: var(--color-warning); }
  .comms-due-action {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-xs);
    background: var(--color-comms);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    white-space: nowrap;
  }
  .comms-due-action:hover { background: #6a1b9a; }

  /* Modal & Forms */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: var(--space-md);
  }
  .modal-overlay.active { display: flex; }
  .modal-content {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .modal-content.modal-lg { max-width: 900px; }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }
  .modal-title { font-size: var(--font-size-lg); font-weight: 600; margin: 0; }
  .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-muted); }
  .modal-close:hover { color: var(--color-text); }
  .modal-body { padding: var(--space-lg); overflow-y: auto; }

  .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); }
  .form-group { margin-bottom: var(--space-md); }
  .form-group-wide { grid-column: span 3; }
  .form-group label { display: block; font-size: var(--font-size-sm); font-weight: 500; margin-bottom: var(--space-xs); }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: var(--space-sm);
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: inherit;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--color-comms);
  }
  .form-actions { display: flex; justify-content: flex-end; gap: var(--space-sm); margin-top: var(--space-md); }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: none;
  }
  .btn svg { width: 16px; height: 16px; }
  .btn-primary { background: var(--color-comms); color: white; }
  .btn-primary:hover { background: #6a1b9a; }
  .btn-secondary { background: var(--color-surface-alt); color: var(--color-text); border: 1px solid var(--color-border); }
  .btn-secondary:hover { background: var(--color-border-light); }
  .btn-sm { padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-xs); }

  /* Empty State (loading states now in global styles.html) */
  .empty-state { text-align: center; padding: var(--space-lg); color: var(--color-text-muted); }
  .empty-state svg { width: 48px; height: 48px; margin-bottom: var(--space-sm); opacity: 0.5; }

  /* Events View */
  .events-layout { display: flex; flex-direction: column; gap: var(--space-md); }
  .events-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }
  .events-stats { display: flex; gap: var(--space-lg); }
  .event-stat { text-align: center; }
  .event-stat-value { display: block; font-size: var(--font-size-xl); font-weight: 700; color: var(--color-comms); }
  .event-stat-label { font-size: var(--font-size-xs); color: var(--color-text-secondary); }
  .events-actions { display: flex; gap: var(--space-sm); align-items: center; }
  .events-actions select {
    padding: var(--space-xs) var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }
  .events-content { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); }
  .events-panel {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .events-panel .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .events-panel .panel-content { max-height: 300px; overflow-y: auto; }
  .badge {
    padding: 2px 8px;
    background: var(--color-comms);
    color: white;
    border-radius: 12px;
    font-size: var(--font-size-xs);
    font-weight: 600;
  }
  .event-card {
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: 1px solid var(--color-border-light);
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .event-card:hover {
    border-color: var(--color-border);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transform: translateY(-1px);
  }
  .event-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
  }
  .event-type-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: rgba(123, 31, 162, 0.08);
    border-radius: var(--radius-sm);
    color: var(--color-comms);
  }
  .event-type-icon .material-icons {
    font-size: 18px;
  }
  .event-card-title {
    font-weight: 600;
    font-size: var(--font-size-md);
    color: var(--color-text);
    line-height: 1.3;
    margin-bottom: var(--space-sm);
  }
  .event-card-details {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .event-card-date,
  .event-card-location {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }
  .event-card-date .material-icons,
  .event-card-location .material-icons {
    font-size: 16px;
    color: var(--color-text-muted);
  }
  .event-card-actions {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    padding-top: var(--space-sm);
    border-top: 1px solid var(--color-border-light);
  }
  .event-card-actions .btn {
    flex: 1;
  }
  .events-table-container {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .events-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-sm);
  }
  .events-table th {
    background: var(--color-surface-alt);
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid var(--color-border);
  }
  .events-table td {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
  }
  .events-table tr:hover { background: var(--color-surface-alt); }

  /* Event Status - uses shared badge pattern */
  .event-status {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 500;
    text-transform: capitalize;
  }
  .event-status.potential {
    background: var(--color-surface-alt);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
  }
  .event-status.considering {
    background: rgba(33, 150, 243, 0.12);
    color: #1565C0;
  }
  .event-status.confirmed {
    background: rgba(76, 175, 80, 0.12);
    color: #2E7D32;
  }
  .event-status.attended {
    background: var(--color-surface-alt);
    color: var(--color-text-muted);
  }
  .event-status.cancelled {
    background: rgba(158, 158, 158, 0.12);
    color: var(--color-text-muted);
    text-decoration: line-through;
  }

  /* Event Detail Modal Header */
  .event-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
  }
  .event-detail-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
  .event-type-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }
  .event-detail-actions {
    display: flex;
    gap: var(--space-xs);
  }
  .event-detail-actions .btn .material-icons {
    font-size: 16px;
  }

  /* Discover Events */
  .discover-search { margin-bottom: var(--space-lg); }
  .discover-results { max-height: 400px; overflow-y: auto; }
  .discover-result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .discover-result-info { flex: 1; min-width: 0; }
  .discover-result-title { font-weight: 500; font-size: var(--font-size-sm); margin-bottom: 2px; }
  .discover-result-url { font-size: var(--font-size-xs); color: var(--color-text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Checkbox Group */
  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
  }
  .checkbox-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
    font-size: var(--font-size-sm);
  }
  .checkbox-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }
  .checkbox-item span { flex: 1; }

  /* Priorities View */
  .priorities-layout { padding: var(--space-md); }
  .priorities-header {
    margin-bottom: var(--space-lg);
  }
  .priorities-header h2 {
    margin: 0 0 var(--space-xs) 0;
    font-size: var(--font-size-xl);
  }
  .priorities-subtitle {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    margin: 0;
  }
  .priorities-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }
  .priority-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    transition: box-shadow 0.2s;
  }
  .priority-card:hover { box-shadow: var(--shadow-sm); }
  .priority-card-warning {
    background: rgba(255, 152, 0, 0.05);
    border-color: rgba(255, 152, 0, 0.3);
  }
  .priority-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
  }
  .priority-header h3 {
    margin: 0;
    font-size: var(--font-size-sm);
    font-weight: 600;
  }
  .priority-icon { color: var(--color-primary); }
  .priority-card-warning .priority-icon { color: #F57C00; }
  .priority-stats {
    display: flex;
    align-items: baseline;
    gap: var(--space-xs);
    margin-bottom: var(--space-sm);
  }
  .priority-count {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--color-primary);
  }
  .priority-card-warning .priority-count { color: #F57C00; }
  .priority-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }
  .priority-stories {
    max-height: 200px;
    overflow-y: auto;
  }
  .priority-story-item {
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: background 0.15s;
  }
  .priority-story-item:hover { background: var(--color-border-light); }
  .priority-story-title { font-weight: 500; margin-bottom: 2px; }
  .priority-story-meta {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .priorities-summary {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
  }
  .priorities-summary h3 {
    margin: 0 0 var(--space-md) 0;
    font-size: var(--font-size-md);
  }
  .priority-bar-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-sm);
  }
  .priority-bar-label {
    width: 200px;
    font-size: var(--font-size-sm);
    flex-shrink: 0;
  }
  .priority-bar-track {
    flex: 1;
    height: 20px;
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }
  .priority-bar-fill {
    height: 100%;
    background: var(--color-primary);
    border-radius: var(--radius-sm);
    transition: width 0.3s ease;
  }
  .priority-bar-value {
    width: 60px;
    text-align: right;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  /* Key Messages View */
  .messages-layout { padding: var(--space-md); }
  .messages-header {
    margin-bottom: var(--space-lg);
  }
  .messages-header h2 {
    margin: 0 0 var(--space-xs) 0;
    font-size: var(--font-size-xl);
  }
  .messages-subtitle {
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    margin: 0 0 var(--space-md) 0;
  }
  .messages-search {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-xs) var(--space-sm);
    max-width: 400px;
  }
  .messages-search input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: var(--font-size-sm);
    outline: none;
  }
  .messages-search svg {
    width: 16px;
    height: 16px;
    color: var(--color-text-muted);
  }
  .messages-summary {
    display: flex;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
  }
  .summary-stat {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }
  .summary-value {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--color-primary);
  }
  .summary-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }
  .messages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: var(--space-md);
  }
  .message-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .message-card:hover { box-shadow: var(--shadow-md); }
  .message-card-header {
    padding: var(--space-md);
    background: var(--color-surface-alt);
    border-bottom: 1px solid var(--color-border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .message-solution-name {
    margin: 0;
    font-size: var(--font-size-md);
    font-weight: 600;
  }
  .focus-badge {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    background: var(--color-primary);
    color: white;
    font-weight: 500;
  }
  .focus-science { background: #2196F3; }
  .focus-operations { background: #4CAF50; }
  .focus-applications { background: #9C27B0; }
  .message-card-body {
    padding: var(--space-md);
  }
  .message-section {
    margin-bottom: var(--space-md);
  }
  .message-section:last-child { margin-bottom: 0; }
  .message-section h4 {
    margin: 0 0 var(--space-xs) 0;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .message-section p {
    margin: 0;
    font-size: var(--font-size-sm);
    line-height: 1.5;
    color: var(--color-text);
  }
  .message-card-footer {
    padding: var(--space-sm) var(--space-md);
    border-top: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }
  .message-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-sm);
    color: var(--color-primary);
    text-decoration: none;
  }
  .message-link:hover { text-decoration: underline; }
  .message-link svg { width: 14px; height: 14px; }

  /* Modal Tabs */
  .modal-tabs {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }
  .modal-tab {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-muted);
    border-bottom: 2px solid transparent;
    transition: all var(--transition-fast);
  }
  .modal-tab:hover {
    color: var(--color-text);
    background: var(--color-surface);
  }
  .modal-tab.active {
    color: var(--color-comms);
    border-bottom-color: var(--color-comms);
    background: var(--color-surface);
  }
  .modal-tab .material-icons {
    font-size: 18px;
  }
  .tab-badge {
    padding: 2px 6px;
    background: var(--color-comms);
    color: white;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .tab-panel {
    display: none;
  }
  .tab-panel.active {
    display: block;
  }

  /* Guest List Styles */
  .guest-list-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
  }
  .guest-search-section h4,
  .guest-list-section h4 {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .guest-search-input {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .guest-search-input .material-icons {
    color: var(--color-text-muted);
    font-size: 18px;
  }
  .guest-search-input input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: var(--font-size-sm);
    outline: none;
  }
  .guest-search-results,
  .guest-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
  }
  .guest-result-item,
  .guest-list-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm);
    background: var(--color-surface);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
    transition: background var(--transition-fast);
  }
  .guest-result-item:hover,
  .guest-list-item:hover {
    background: var(--color-border-light);
  }
  .guest-info {
    flex: 1;
    min-width: 0;
  }
  .guest-name {
    font-weight: 500;
    font-size: var(--font-size-sm);
    margin-bottom: 2px;
  }
  .guest-email {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .guest-agency {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }
  .guest-actions {
    display: flex;
    gap: var(--space-xs);
  }
  .guest-add-btn,
  .guest-remove-btn {
    padding: var(--space-xs);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  .guest-add-btn {
    background: var(--color-success);
    color: white;
  }
  .guest-add-btn:hover {
    filter: brightness(1.1);
  }
  .guest-remove-btn {
    background: var(--color-surface-alt);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
  }
  .guest-remove-btn:hover {
    background: var(--color-error);
    color: white;
    border-color: var(--color-error);
  }
  .empty-state-sm {
    padding: var(--space-md);
    text-align: center;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
  }

  /* Post-Event Attendance Section */
  .attendance-section {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border-light);
  }
  .attendance-section h4 {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--font-size-sm);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  .attendance-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
  }
  .attendance-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  .attendance-checkbox label {
    flex: 1;
    cursor: pointer;
    font-size: var(--font-size-sm);
  }
  .attendance-checkbox.attended {
    background: rgba(76, 175, 80, 0.1);
  }

  /* Prep Report Styles */
  .prep-report-container {
    padding: var(--space-md);
  }
  .prep-actions {
    margin-bottom: var(--space-lg);
  }
  .prep-section {
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
  }
  .prep-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  .prep-section h3 {
    margin: 0 0 var(--space-sm) 0;
    font-size: var(--font-size-md);
    color: var(--color-comms);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  .prep-section h3 .material-icons {
    font-size: 20px;
  }
  .prep-summary-stats {
    display: flex;
    gap: var(--space-lg);
    margin-bottom: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-md);
  }
  .prep-stat {
    text-align: center;
  }
  .prep-stat-value {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--color-comms);
  }
  .prep-stat-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .prep-guest-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    margin-bottom: var(--space-sm);
  }
  .prep-guest-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-sm);
  }
  .prep-guest-name {
    font-weight: 600;
    font-size: var(--font-size-md);
  }
  .prep-guest-title {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }
  .prep-guest-agency {
    font-size: var(--font-size-sm);
    color: var(--color-comms);
  }
  .prep-guest-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
  }
  .prep-detail-item {
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }
  .prep-detail-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
  }
  .prep-agency-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-sm);
  }
  .prep-agency-item {
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
  }
  .prep-agency-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
  }
  .prep-agency-count {
    font-size: var(--font-size-xs);
    color: var(--color-comms);
  }
  .prep-connection-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
  }
  .prep-connection-icon {
    color: var(--color-comms);
  }
  .prep-connection-names {
    font-weight: 500;
    font-size: var(--font-size-sm);
  }
  .prep-connection-reason {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }
  .prep-starter-item {
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-sm);
  }
  .prep-starter-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-xs);
  }
  .prep-starter-topics {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }
  .prep-topic-tag {
    padding: 2px 8px;
    background: var(--color-surface);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    border: 1px solid var(--color-border-light);
  }
  .prep-topic-tag.hobby { border-left: 3px solid #4CAF50; }
  .prep-topic-tag.icebreaker { border-left: 3px solid #FF9800; }
  .prep-topic-tag.professional { border-left: 3px solid #2196F3; }
  .prep-topic-tag.personal { border-left: 3px solid #9C27B0; }
  .prep-topic-tag.skill { border-left: 3px solid #00BCD4; }
  .prep-topic-tag.work { border-left: 3px solid var(--color-comms); }

  /* Linked Solutions */
  .prep-solution-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }
  .prep-solution-tag {
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-comms);
    color: white;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 500;
  }

  /* Potential Guests / Suggested Attendees */
  .prep-section-desc {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin: 0 0 var(--space-md) 0;
  }
  .potential-guests-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }
  .potential-guest-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--color-success);
  }
  .potential-guest-info {
    flex: 1;
    min-width: 0;
  }
  .potential-guest-name {
    font-weight: 600;
    font-size: var(--font-size-sm);
  }
  .potential-guest-agency {
    font-size: var(--font-size-xs);
    color: var(--color-comms);
  }
  .potential-guest-reason {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: 2px;
  }
  .potential-guest-touchpoints {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    margin-top: 2px;
  }

  /* Responsive */
  @media (max-width: 1400px) {
    .comms-viewer .pipeline-layout {
      flex-direction: column;
    }
    .comms-viewer .insights-sidebar,
    .comms-viewer .published-sidebar {
      width: 100%;
      min-width: 100%;
      max-height: 200px;
    }
    .comms-viewer .insights-sidebar.collapsed,
    .comms-viewer .published-sidebar.collapsed {
      width: 100%;
      min-width: 100%;
      max-height: 40px;
    }
  }
  @media (max-width: 1200px) {
    .comms-viewer .pipeline-board { grid-template-columns: repeat(2, 1fr); }
    .bottom-panels, .top-panels { grid-template-columns: 1fr; }
    .coverage-summary { grid-template-columns: 1fr; }
    .priorities-grid { grid-template-columns: repeat(2, 1fr); }
    .messages-grid { grid-template-columns: 1fr; }
    .guest-list-container { grid-template-columns: 1fr; }
    .prep-guest-details { grid-template-columns: 1fr; }
  }
  @media (max-width: 768px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .comms-viewer .pipeline-board { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
    .form-group-wide { grid-column: span 1; }
    .pipeline-filters { flex-wrap: wrap; }
    .priorities-grid { grid-template-columns: 1fr; }
    .priority-bar-label { width: 120px; }
    .messages-summary { flex-direction: column; gap: var(--space-sm); }
    .modal-tabs { flex-wrap: wrap; }
    .prep-summary-stats { flex-direction: column; }
    .header-search input { width: 120px; }
    .pipeline-search-bar.expanded .search-bar-content {
      max-width: 100%;
      flex-wrap: wrap;
    }
    .search-input-wrapper input {
      width: 140px;
    }
  }
</style>

<!-- Comms JavaScript -->
<script>
var COMMS = (function() {
  var state = {
    overview: null,
    stories: [],
    opportunities: null,
    coverage: null,
    currentView: 'pipeline',
    calendarDate: new Date(),
    filters: {
      type: '',
      status: '',
      channel: '',
      search: ''
    },
    // Events state
    events: [],
    eventsOverview: null,
    eventFilters: {
      year: '2026',
      status: ''
    }
  };

  function init() {
    loadOverview();
    loadStories();
    loadOpportunities();
    loadCoverage();
  }

  function loadOverview() {
    google.script.run
      .withSuccessHandler(function(overview) {
        state.overview = overview;
        renderStats(overview);
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load overview:', error);
      })
      .getCommsOverview();
  }

  function loadStories() {
    google.script.run
      .withSuccessHandler(function(stories) {
        state.stories = stories || [];
        renderPipeline();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load stories:', error);
        showPipelineError('Failed to load stories');
      })
      .getPipelineStoriesForUI();
  }

  function loadOpportunities() {
    google.script.run
      .withSuccessHandler(function(opportunities) {
        state.opportunities = opportunities;
        renderOpportunities();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load opportunities:', error);
        document.getElementById('opportunitiesPanel').innerHTML =
          '<div class="empty-state"><p>Could not load opportunities</p></div>';
      })
      .detectStoryOpportunities();
  }

  function loadCoverage() {
    google.script.run
      .withSuccessHandler(function(coverage) {
        state.coverage = coverage;
        renderCoverageGaps();
        renderCoverageView();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load coverage:', error);
        var panel = document.getElementById('coverageGapsPanel');
        if (panel) {
          panel.innerHTML = '<div class="empty-state"><p>Could not load coverage data</p></div>';
        }
      })
      .getCoverageAnalysis(90);
  }

  function renderStats(overview) {
    if (!overview) return;
    // Guard for SPA navigation
    var el1 = document.getElementById('statTotalStories');
    var el2 = document.getElementById('statInPipeline');
    var el3 = document.getElementById('statPublishedQtr');
    var el4 = document.getElementById('statCoverageGaps');
    if (!el1 || !el2 || !el3 || !el4) return;

    el1.textContent = overview.stats ? overview.stats.total_stories : 0;
    el2.textContent = overview.stats ? overview.stats.active_pipeline : 0;
    el3.textContent = overview.stats ? overview.stats.published_this_quarter : 0;
    el4.textContent = overview.coverage_gaps_count || 0;
  }

  function renderPipeline() {
    var statuses = ['idea', 'researching', 'drafting', 'review', 'published'];
    var storiesByStatus = {};

    statuses.forEach(function(s) {
      storiesByStatus[s] = [];
    });

    var filteredStories = applyFiltersToStories(state.stories);

    filteredStories.forEach(function(story) {
      var status = (story.status || 'idea').toLowerCase();
      if (storiesByStatus[status]) {
        storiesByStatus[status].push(story);
      }
    });

    statuses.forEach(function(status) {
      var containerId = 'cards' + capitalizeFirst(status);
      var countId = 'count' + capitalizeFirst(status);
      var container = document.getElementById(containerId);
      var countEl = document.getElementById(countId);
      if (!container || !countEl) return; // Guard for SPA navigation
      var stories = storiesByStatus[status];

      countEl.textContent = stories.length;

      if (stories.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: var(--space-md);"><p style="font-size: var(--font-size-xs);">No stories</p></div>';
      } else {
        container.innerHTML = stories.slice(0, 15).map(function(s) {
          return renderStoryCard(s);
        }).join('');
      }
    });
}

  function renderStoryCard(story) {
    var typeClass = 'type-' + (story.content_type || 'story');
    var typeNames = {
      'story': 'Story',
      'web_content': 'Web',
      'social_media': 'Social',
      'external_mention': 'External',
      'nugget': 'Nugget',
      'key_date': 'Key Date'
    };
    var typeName = typeNames[story.content_type] || 'Story';

    var channelIcons = {
      'web': 'language',
      'social': 'share',
      'slide': 'slideshow',
      'external': 'open_in_new',
      'newsletter': 'mail'
    };
    var channelIcon = channelIcons[story.channel] || 'description';

    var dateStr = story.target_date ? formatDate(story.target_date) : (story.idea_date ? formatDate(story.idea_date) : '');

    var priorityClass = story.priority === 'high' ? 'priority-high' : (story.priority === 'low' ? 'priority-low' : '');

    var html = '<div class="story-card ' + priorityClass + '" draggable="true" ' +
      'data-story-id="' + escapeAttr(story.story_id) + '" ' +
      'ondragstart="COMMS.handleDragStart(event, \'' + escapeAttr(story.story_id) + '\')" ' +
      'ondragend="COMMS.handleDragEnd(event)" ' +
      'onclick="COMMS.showStoryDetail(\'' + escapeAttr(story.story_id) + '\')">';
    html += '<div class="card-header">';
    html += '<span class="card-type ' + typeClass + '">' + typeName + '</span>';
    if (dateStr) html += '<span class="card-date">' + dateStr + '</span>';
    html += '</div>';
    html += '<div class="card-title">' + escapeHtml(story.title || 'Untitled') + '</div>';
    if (story.solution_id) {
      var solDisplay = story.solution_id.length > 30 ? story.solution_id.substring(0, 30) + '...' : story.solution_id;
      html += '<div class="card-solutions">' + escapeHtml(solDisplay) + '</div>';
    }
    html += '<div class="card-meta">';
    html += '<span class="card-channel"><span class="material-icons">' + channelIcon + '</span> ' + (story.channel || 'web') + '</span>';
    if (story.author) html += '<span>' + escapeHtml(story.author) + '</span>';
    html += '</div>';
    html += '</div>';
    return html;
  }

  function renderOpportunities() {
    var container = document.getElementById('opportunitiesPanel');
    if (!container) return; // Guard for SPA navigation
    var opp = state.opportunities;

    if (!opp || opp.summary.total_opportunities === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">flash_on</span><p>No new opportunities detected</p></div>';
      return;
    }

    var html = '';

    // Milestones
    opp.milestones.slice(0, 3).forEach(function(m) {
      html += '<div class="opportunity-item" onclick="COMMS.createStoryFromOpportunity(\'milestone\', \'' + escapeAttr(m.solution_id || '') + '\')">';
      html += '<div class="opportunity-icon milestone"><span class="material-icons">flag</span></div>';
      html += '<div class="opportunity-info">';
      html += '<div class="opportunity-title">' + escapeHtml(m.solution_name) + ' - ' + escapeHtml(m.type) + '</div>';
      html += '<div class="opportunity-desc">' + escapeHtml(m.description) + '</div>';
      html += '</div></div>';
    });

    // T8 Contacts
    opp.t8_contacts.slice(0, 3).forEach(function(c) {
      html += '<div class="opportunity-item" onclick="COMMS.createStoryFromOpportunity(\'t8\', \'' + escapeAttr(c.name) + '\')">';
      html += '<div class="opportunity-icon t8"><span class="material-icons">group</span></div>';
      html += '<div class="opportunity-info">';
      html += '<div class="opportunity-title">' + escapeHtml(c.name) + ' at T8 Impact</div>';
      html += '<div class="opportunity-desc">' + escapeHtml(c.agency || '') + (c.solutions && c.solutions.length ? ' - ' + c.solutions.slice(0, 2).join(', ') : '') + '</div>';
      html += '</div></div>';
    });

    if (!html) {
      html = '<div class="empty-state"><p>No new opportunities</p></div>';
    }

    container.innerHTML = html;
}

  function renderCoverageGaps() {
    var container = document.getElementById('coverageGapsPanel');
    if (!container) return; // Guard for SPA navigation
    var coverage = state.coverage;

    if (!coverage || (coverage.gaps.length === 0 && coverage.uncovered.length === 0)) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">check_circle</span><p>All solutions have recent coverage!</p></div>';
      return;
    }

    var html = '';

    // Gaps (solutions with old stories)
    coverage.gaps.slice(0, 4).forEach(function(g) {
      var severity = g.days_since_story > 180 ? 'severe' : 'moderate';
      html += '<div class="gap-item ' + severity + '">';
      html += '<div class="gap-info">';
      html += '<div class="gap-solution">' + escapeHtml(g.solution_name) + '</div>';
      html += '<div class="gap-days">No stories in ' + g.days_since_story + ' days</div>';
      html += '</div>';
      html += '<button class="gap-action" onclick="COMMS.suggestStory(\'' + escapeAttr(g.solution_id || '') + '\')">Suggest Story</button>';
      html += '</div>';
    });

    // Uncovered (no stories ever)
    coverage.uncovered.slice(0, 3).forEach(function(u) {
      html += '<div class="gap-item severe">';
      html += '<div class="gap-info">';
      html += '<div class="gap-solution">' + escapeHtml(u.solution_name) + '</div>';
      html += '<div class="gap-days">No stories ever</div>';
      html += '</div>';
      html += '<button class="gap-action" onclick="COMMS.suggestStory(\'' + escapeAttr(u.solution_id || '') + '\')">Suggest Story</button>';
      html += '</div>';
    });

    container.innerHTML = html;
  }

  function renderCoverageView() {
    var coverage = state.coverage;
    if (!coverage) return;

    // Guard for SPA navigation - elements may not exist
    var wellCoveredEl = document.getElementById('coverageWellCovered');
    var needsAttentionEl = document.getElementById('coverageNeedsAttention');
    var noStoriesEl = document.getElementById('coverageNoStories');
    var tbody = document.getElementById('coverageTableBody');

    if (!wellCoveredEl || !tbody) return; // Elements don't exist, user navigated away

    wellCoveredEl.textContent = coverage.well_covered || 0;
    if (needsAttentionEl) needsAttentionEl.textContent = coverage.needs_attention || 0;
    if (noStoriesEl) noStoriesEl.textContent = coverage.no_stories || 0;

    // Render table
    var allSolutions = []
      .concat(coverage.gaps || [])
      .concat(coverage.uncovered || [])
      .concat(coverage.covered || []);

    if (allSolutions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No coverage data available</td></tr>';
      return;
    }

    // Sort by days_since_story descending (worst first)
    allSolutions.sort(function(a, b) {
      var aVal = a.days_since_story != null ? a.days_since_story : 9999;
      var bVal = b.days_since_story != null ? b.days_since_story : 9999;
      return bVal - aVal;
    });

    var html = '';
    allSolutions.slice(0, 50).forEach(function(sol) {
      var statusClass, statusText;
      if (sol.total_stories === 0) {
        statusClass = 'uncovered';
        statusText = 'No Coverage';
      } else if (sol.days_since_story > 90) {
        statusClass = 'attention';
        statusText = 'Needs Attention';
      } else {
        statusClass = 'covered';
        statusText = 'Covered';
      }

      var displayName = sol.solution_name || sol.solution_id || '--';
      var solId = sol.solution_id || '';

      html += '<tr>';
      html += '<td><strong>' + escapeHtml(displayName) + '</strong></td>';
      html += '<td>' + escapeHtml(sol.phase || '--') + '</td>';
      html += '<td>' + (sol.total_stories || 0) + '</td>';
      html += '<td>' + (sol.recent_stories || 0) + '</td>';
      html += '<td>' + (sol.last_story_date ? formatDate(sol.last_story_date) : '--') + '</td>';
      html += '<td>' + (sol.days_since_story != null ? sol.days_since_story : '--') + '</td>';
      html += '<td><span class="status-badge ' + statusClass + '">' + statusText + '</span></td>';
      html += '<td><button class="btn btn-sm btn-secondary" onclick="COMMS.suggestStory(\'' + escapeAttr(solId) + '\')">+ Story</button></td>';
      html += '</tr>';
    });

    tbody.innerHTML = html;
  }

  function applyFiltersToStories(stories) {
    var filters = state.filters;
    return stories.filter(function(s) {
      if (filters.type && s.content_type !== filters.type) return false;
      if (filters.status && s.status !== filters.status) return false;
      if (filters.channel && s.channel !== filters.channel) return false;
      if (filters.search) {
        var searchLower = filters.search.toLowerCase();
        var titleMatch = s.title && s.title.toLowerCase().indexOf(searchLower) !== -1;
        var solMatch = s.solution_id && s.solution_id.toLowerCase().indexOf(searchLower) !== -1;
        if (!titleMatch && !solMatch) return false;
      }
      return true;
    });
  }

  function applyFilters() {
    var typeEl = document.getElementById('filterType');
    var statusEl = document.getElementById('filterStatus');
    var channelEl = document.getElementById('filterChannel');
    var searchEl = document.getElementById('searchInput');

    state.filters.type = typeEl ? typeEl.value : '';
    state.filters.status = statusEl ? statusEl.value : '';
    state.filters.channel = channelEl ? channelEl.value : '';
    state.filters.search = searchEl ? searchEl.value : '';
    renderPipeline();
  }

  function setView(view) {
    state.currentView = view;
    document.querySelectorAll('.view-btn').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.view === view);
    });
    document.getElementById('pipelineView').classList.toggle('active', view === 'pipeline');
    document.getElementById('eventsView').classList.toggle('active', view === 'events');
    document.getElementById('coverageView').classList.toggle('active', view === 'coverage');
    document.getElementById('calendarView').classList.toggle('active', view === 'calendar');
    document.getElementById('prioritiesView').classList.toggle('active', view === 'priorities');
    document.getElementById('messagesView').classList.toggle('active', view === 'messages');

    // Show pipeline stats only on pipeline view
    var pipelineStats = document.getElementById('pipelineStatsRow');
    if (pipelineStats) pipelineStats.style.display = (view === 'pipeline') ? '' : 'none';

    if (view === 'coverage') {
      // Refresh coverage view when switching to it
      if (state.coverage) {
        renderCoverageView();
      } else {
        loadCoverage();
      }
    }

    if (view === 'calendar') {
      renderCalendar();
      loadUpcomingTargets();
      renderCommsDue();
    }

    if (view === 'events') {
      loadEvents();
    }

    if (view === 'priorities') {
      renderPrioritiesView();
    }

    if (view === 'messages') {
      renderMessagesView();
    }
  }

  function renderPrioritiesView() {
    var priorityConfig = {
      partnerships: { name: 'Partnerships & Decision Support', id: 'Partnerships' },
      citizens: { name: 'Benefits to American Citizens', id: 'Citizens' },
      ai_innovation: { name: 'AI Leadership & Tech Innovation', id: 'AiInnovation' },
      science_integrity: { name: 'Gold Standard Science & Research Integrity', id: 'ScienceIntegrity' },
      efficiency: { name: 'Government Efficiency', id: 'Efficiency' }
    };

    var priorityCounts = {
      partnerships: [],
      citizens: [],
      ai_innovation: [],
      science_integrity: [],
      efficiency: [],
      untagged: []
    };

    // Categorize stories by priority
    state.stories.forEach(function(story) {
      var priorities = story.admin_priorities ? story.admin_priorities.split(',').map(function(p) { return p.trim().toLowerCase(); }) : [];

      if (priorities.length === 0) {
        priorityCounts.untagged.push(story);
      } else {
        var matchedAny = false;
        priorities.forEach(function(p) {
          if (priorityCounts[p]) {
            priorityCounts[p].push(story);
            matchedAny = true;
          }
        });
        // If priorities were set but none matched known keys, add to untagged
        if (!matchedAny) {
          priorityCounts.untagged.push(story);
        }
      }
    });

    // Render each priority card
    Object.keys(priorityConfig).forEach(function(key) {
      var config = priorityConfig[key];
      var stories = priorityCounts[key];

      document.getElementById('priorityCount' + config.id).textContent = stories.length;

      var container = document.getElementById('priorityStories' + config.id);
      if (stories.length === 0) {
        container.innerHTML = '<div class="empty-state">No stories tagged</div>';
      } else {
        container.innerHTML = stories.map(function(story) {
          return '<div class="priority-story-item" onclick="COMMS.showStoryDetail(\'' + escapeAttr(story.story_id) + '\')">' +
            '<div class="priority-story-title">' + escapeHtml(story.title) + '</div>' +
            '<div class="priority-story-meta">' + escapeHtml(story.solution_id || 'No solutions') + '  ' + capitalizeFirst(story.status) + '</div>' +
            '</div>';
        }).join('');
      }
    });

    // Render untagged
    document.getElementById('priorityCountUntagged').textContent = priorityCounts.untagged.length;
    var untaggedContainer = document.getElementById('priorityStoriesUntagged');
    if (priorityCounts.untagged.length === 0) {
      untaggedContainer.innerHTML = '<div class="empty-state">All stories tagged!</div>';
    } else {
      untaggedContainer.innerHTML = priorityCounts.untagged.map(function(story) {
        return '<div class="priority-story-item" onclick="COMMS.editStory(\'' + escapeAttr(story.story_id) + '\')">' +
          '<div class="priority-story-title">' + escapeHtml(story.title) + '</div>' +
          '<div class="priority-story-meta">Click to add priorities</div>' +
          '</div>';
      }).join('');
    }

    // Render summary bars
    var totalStories = state.stories.length || 1;
    var barsHtml = '';
    Object.keys(priorityConfig).forEach(function(key) {
      var config = priorityConfig[key];
      var count = priorityCounts[key].length;
      var percent = Math.round((count / totalStories) * 100);

      barsHtml += '<div class="priority-bar-item">' +
        '<div class="priority-bar-label">' + config.name + '</div>' +
        '<div class="priority-bar-track"><div class="priority-bar-fill" style="width: ' + percent + '%"></div></div>' +
        '<div class="priority-bar-value">' + count + ' (' + percent + '%)</div>' +
        '</div>';
    });
    document.getElementById('priorityBars').innerHTML = barsHtml;
}

  // Key Messages state
  var messagesState = {
    solutions: [],
    summary: null,
    searchQuery: ''
  };

  function renderMessagesView() {
    var grid = document.getElementById('messagesGrid');
    grid.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><span>Loading key messages...</span></div>';

    // Load summary
    google.script.run
      .withSuccessHandler(function(summary) {
        messagesState.summary = summary;
        document.getElementById('msgTotalSolutions').textContent = summary.with_key_messages;
        document.getElementById('msgCoverage').textContent = summary.coverage_percent + '%';
        document.getElementById('msgByFocus').textContent = Object.keys(summary.by_focus_type || {}).length;
      })
      .withFailureHandler(function(err) {
        console.error('Failed to load messages summary:', err);
      })
      .getKeyMessagesSummary();

    // Load solutions with messages
    google.script.run
      .withSuccessHandler(function(solutions) {
        messagesState.solutions = solutions || [];
        renderMessagesGrid(messagesState.solutions);
      })
      .withFailureHandler(function(err) {
        grid.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><span>Failed to load key messages</span></div>';
      })
      .getSolutionsWithKeyMessages();
  }

  function renderMessagesGrid(solutions) {
    var grid = document.getElementById('messagesGrid');

    if (!solutions || solutions.length === 0) {
      grid.innerHTML = '<div class="empty-state"><span class="material-icons">chat</span><span>No solutions have key messages yet</span></div>';
return;
    }

    var html = solutions.map(function(sol) {
      var focusBadge = sol.comms_focus_type ?
        '<span class="focus-badge focus-' + sol.comms_focus_type.toLowerCase().replace(/\s+/g, '-') + '">' + escapeHtml(sol.comms_focus_type) + '</span>' : '';

      return '<div class="message-card">' +
        '<div class="message-card-header">' +
          '<h3 class="message-solution-name">' + escapeHtml(sol.core_official_name || sol.core_id) + '</h3>' +
          focusBadge +
        '</div>' +
        '<div class="message-card-body">' +
          '<div class="message-section">' +
            '<h4>Key Messages</h4>' +
            '<p>' + escapeHtml(sol.comms_key_messages || 'No key messages defined') + '</p>' +
          '</div>' +
          (sol.comms_science ? '<div class="message-section"><h4>Scientific Advancement</h4><p>' + escapeHtml(sol.comms_science) + '</p></div>' : '') +
          (sol.comms_agency_impact ? '<div class="message-section"><h4>Agency Use & Impact</h4><p>' + escapeHtml(sol.comms_agency_impact) + '</p></div>' : '') +
          (sol.comms_industry ? '<div class="message-section"><h4>Industry Connections</h4><p>' + escapeHtml(sol.comms_industry) + '</p></div>' : '') +
        '</div>' +
        (sol.comms_public_links ? '<div class="message-card-footer"><a href="' + escapeAttr(sol.comms_public_links) + '" target="_blank" class="message-link"><span class="material-icons">open_in_new</span> View Public Page</a></div>' : '') +
      '</div>';
    }).join('');

    grid.innerHTML = html;
}

  function searchMessages() {
    var query = document.getElementById('messagesSearchInput').value.toLowerCase().trim();
    messagesState.searchQuery = query;

    if (!query) {
      renderMessagesGrid(messagesState.solutions);
      return;
    }

    var filtered = messagesState.solutions.filter(function(sol) {
      var searchText = [
        sol.core_official_name,
        sol.core_id,
        sol.comms_key_messages,
        sol.comms_science,
        sol.comms_agency_impact,
        sol.comms_industry,
        sol.comms_focus_type
      ].join(' ').toLowerCase();
      return searchText.indexOf(query) !== -1;
    });

    renderMessagesGrid(filtered);
  }

  function showStoryDetail(storyId) {
    var story = state.stories.find(function(s) { return s.story_id === storyId; });
    if (!story) {
      // Fallback to server if not in cache
      google.script.run
        .withSuccessHandler(function(s) {
          if (s) renderStoryDetailModal(s);
        })
        .getStoryById(storyId);
      return;
    }
    renderStoryDetailModal(story);
  }

  function renderStoryDetailModal(story) {
    document.getElementById('modalStoryTitle').textContent = story.title || 'Story Details';

    var typeNames = {
      'story': 'Impact Story',
      'web_content': 'Web Content',
      'social_media': 'Social Media',
      'external_mention': 'External Mention',
      'nugget': 'Nugget Slide',
      'key_date': 'Key Date'
    };

    var statusInfo = {
      'idea': { name: 'Idea', color: '#9E9E9E' },
      'researching': { name: 'Researching', color: '#2196F3' },
      'drafting': { name: 'Drafting', color: '#FF9800' },
      'review': { name: 'Review', color: '#9C27B0' },
      'published': { name: 'Published', color: '#4CAF50' },
      'archived': { name: 'Archived', color: '#607D8B' }
    };

    var priorityInfo = {
      'high': { name: 'High', color: '#f44336' },
      'medium': { name: 'Medium', color: '#FF9800' },
      'low': { name: 'Low', color: '#9E9E9E' }
    };

    var status = statusInfo[story.status] || { name: story.status, color: '#9E9E9E' };
    var priority = priorityInfo[story.priority] || { name: story.priority || 'Medium', color: '#FF9800' };

    var html = '<div class="story-detail">';

    // Header with type, priority and status
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md); padding-bottom: var(--space-md); border-bottom: 1px solid var(--color-border-light);">';
    html += '<div style="display: flex; align-items: center; gap: var(--space-sm);">';
    html += '<span style="font-size: var(--font-size-sm); color: var(--color-comms);">' + (typeNames[story.content_type] || 'Story') + '</span>';
    html += '<span style="padding: 2px 8px; background: ' + priority.color + '22; color: ' + priority.color + '; border-radius: 4px; font-size: var(--font-size-xs); font-weight: 600;">' + priority.name + ' Priority</span>';
    html += '</div>';
    html += '<span style="padding: 4px 12px; background: ' + status.color + '; color: white; border-radius: 12px; font-size: var(--font-size-sm);">' + status.name + '</span>';
    html += '</div>';

    // Admin Priorities tags
    if (story.admin_priorities) {
      var priorityLabels = {
        'partnerships': 'Partnerships & Decision Support',
        'citizens': 'Benefits to American Citizens',
        'ai_innovation': 'AI Leadership & Tech Innovation',
        'science_integrity': 'Gold Standard Science',
        'efficiency': 'Government Efficiency'
      };
      var priorities = story.admin_priorities.split(',').map(function(p) { return p.trim(); }).filter(function(p) { return p; });
      if (priorities.length > 0) {
        html += '<div style="margin-bottom: var(--space-md);">';
        html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs);">ADMIN PRIORITIES</div>';
        html += '<div style="display: flex; flex-wrap: wrap; gap: var(--space-xs);">';
        priorities.forEach(function(p) {
          var label = priorityLabels[p] || p;
          html += '<span style="padding: 4px 8px; background: var(--color-comms); color: white; border-radius: 4px; font-size: var(--font-size-xs);">' + escapeHtml(label) + '</span>';
        });
        html += '</div></div>';
      }
    }

    // Details grid
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';

    if (story.solution_id) {
      // Look up solution name
      var solutionDisplay = story.solution_id;
      if (state.solutions) {
        var sol = state.solutions.find(function(s) { return s.core_id === story.solution_id; });
        if (sol) solutionDisplay = sol.core_official_name || story.solution_id;
      }
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">SOLUTION</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(solutionDisplay) + '</div></div>';
    }

    if (story.channel) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">CHANNEL</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + capitalizeFirst(story.channel) + '</div></div>';
    }

    if (story.author) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">AUTHOR</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(story.author) + '</div></div>';
    }

    if (story.platform) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">PLATFORM</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(story.platform) + '</div></div>';
    }

    if (story.source) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">SOURCE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(story.source) + '</div></div>';
    }

    if (story.target_date) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">TARGET DATE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(story.target_date) + '</div></div>';
    }

    if (story.publish_date) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">PUBLISH DATE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(story.publish_date) + '</div></div>';
    }

    if (story.idea_date) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">CREATED</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(story.idea_date) + '</div></div>';
    }

    if (story.last_updated) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">LAST UPDATED</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(story.last_updated) + '</div></div>';
    }

    html += '</div>';

    // Links
    if (story.published_url || story.pitch_doc_url) {
      html += '<div style="margin-bottom: var(--space-md);">';
      if (story.published_url) {
        html += '<a href="' + escapeHtml(story.published_url) + '" target="_blank" class="btn btn-secondary" style="margin-right: var(--space-sm);">';
        html += '<span class="material-icons">open_in_new</span> View Published</a>';
      }
      if (story.pitch_doc_url) {
        html += '<a href="' + escapeHtml(story.pitch_doc_url) + '" target="_blank" class="btn btn-secondary">';
        html += '<span class="material-icons">description</span> View Draft</a>';
      }
      html += '</div>';
    }

    // Notes
    if (story.notes) {
      html += '<div style="background: var(--color-surface-alt); padding: var(--space-md); border-radius: var(--radius-sm); margin-bottom: var(--space-md);">';
      html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs);">NOTES</div>';
      html += '<div style="font-size: var(--font-size-sm); white-space: pre-wrap;">' + escapeHtml(story.notes) + '</div>';
      html += '</div>';
    }

    // Actions
    html += '<div style="display: flex; gap: var(--space-sm); padding-top: var(--space-md); border-top: 1px solid var(--color-border-light);">';
    html += '<button class="btn btn-primary" id="editStoryBtn" onclick="COMMS.editStory(\'' + escapeAttr(story.story_id) + '\')"><span class="material-icons">edit</span> Edit</button>';
    if (story.status !== 'published') {
      var nextStatus = getNextStatus(story.status);
      if (nextStatus) {
        html += '<button class="btn btn-secondary" id="advanceStatusBtn" onclick="COMMS.advanceStatus(\'' + escapeAttr(story.story_id) + '\', \'' + nextStatus + '\')"><span class="material-icons">arrow_forward</span> Move to ' + capitalizeFirst(nextStatus) + '</button>';
      }
    }
    html += '<button class="btn btn-danger" id="deleteStoryBtn" style="margin-left: auto;" onclick="COMMS.deleteStory(\'' + escapeAttr(story.story_id) + '\')"><span class="material-icons">delete</span></button>';
    html += '</div>';

    html += '</div>';

    document.getElementById('storyModalBody').innerHTML = html;
    document.getElementById('storyModal').classList.add('active');
}

  function getNextStatus(currentStatus) {
    var order = ['idea', 'researching', 'drafting', 'review', 'published'];
    var idx = order.indexOf(currentStatus);
    if (idx >= 0 && idx < order.length - 1) {
      return order[idx + 1];
    }
    return null;
  }

  function advanceStatus(storyId, newStatus) {
    var btn = document.getElementById('advanceStatusBtn');
    var originalHtml = btn ? btn.innerHTML : '';
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner" style="width: 14px; height: 14px;"></span> Moving...';
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (!result) {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
          }
          alert('Error: Story not found. It may have been deleted or the ID changed.\n\nPlease refresh the page and try again.');
          return;
        }
        closeModal('storyModal');
        loadStories();
        loadOverview();
      })
      .withFailureHandler(function(error) {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
        alert('Failed to update status: ' + error);
      })
      .updateStoryStatus(storyId, newStatus);
  }

  function showCreateStoryModal() {
    document.getElementById('editStoryModalTitle').textContent = 'New Story';
    document.getElementById('storyForm').reset();
    document.getElementById('editStoryId').value = '';
    // Clear admin priority checkboxes
    var checkboxes = document.querySelectorAll('#storyAdminPriorities input[type="checkbox"]');
    checkboxes.forEach(function(cb) { cb.checked = false; });
    document.getElementById('editStoryModal').classList.add('active');
  }

  function editStory(storyId) {
    var story = state.stories.find(function(s) { return s.story_id === storyId; });
    if (!story) {
      // Fallback to server if not in cache
      google.script.run
        .withSuccessHandler(function(s) {
          if (s) populateStoryForm(s);
        })
        .getStoryById(storyId);
      return;
    }
    populateStoryForm(story);
  }

  function populateStoryForm(story) {
    document.getElementById('editStoryModalTitle').textContent = 'Edit Story';
    document.getElementById('editStoryId').value = story.story_id;
    document.getElementById('storyTitle').value = story.title || '';
    document.getElementById('storyContentType').value = story.content_type || 'story';
    document.getElementById('storyStatus').value = story.status || 'idea';
    document.getElementById('storyChannel').value = story.channel || 'web';
    document.getElementById('storyOutlet').value = story.platform || '';
    document.getElementById('storyAuthor').value = story.author || '';
    document.getElementById('storyPriority').value = story.priority || 'medium';
    document.getElementById('storySource').value = story.source || '';
    document.getElementById('storySolution').value = story.solution_id || '';
    document.getElementById('storyTargetDate').value = story.target_date ? story.target_date.split('T')[0] : '';
    document.getElementById('storyPublishDate').value = story.publish_date ? story.publish_date.split('T')[0] : '';
    document.getElementById('storyPitchUrl').value = story.pitch_doc_url || '';
    document.getElementById('storyPublishedLink').value = story.published_url || '';
    document.getElementById('storyNotes').value = story.notes || '';

    // Populate admin priorities checkboxes
    var priorities = story.admin_priorities ? story.admin_priorities.split(',').map(function(p) { return p.trim(); }) : [];
    var checkboxes = document.querySelectorAll('#storyAdminPriorities input[type="checkbox"]');
    checkboxes.forEach(function(cb) {
      cb.checked = priorities.indexOf(cb.value) !== -1;
    });

    closeModal('storyModal');
    document.getElementById('editStoryModal').classList.add('active');
  }

  function submitStory(event) {
    event.preventDefault();

    var storyId = document.getElementById('editStoryId').value;
    var solutionId = document.getElementById('storySolution').value;

    if (!solutionId) {
      alert('Please select a solution');
      return;
    }

    // Collect admin priorities from checkboxes
    var adminPriorities = [];
    var checkboxes = document.querySelectorAll('#storyAdminPriorities input[type="checkbox"]:checked');
    checkboxes.forEach(function(cb) {
      adminPriorities.push(cb.value);
    });

    var storyData = {
      title: document.getElementById('storyTitle').value,
      content_type: document.getElementById('storyContentType').value,
      status: document.getElementById('storyStatus').value,
      solution_id: solutionId,
      channel: document.getElementById('storyChannel').value,
      platform: document.getElementById('storyOutlet').value,
      author: document.getElementById('storyAuthor').value,
      priority: document.getElementById('storyPriority').value,
      source: document.getElementById('storySource').value,
      admin_priorities: adminPriorities.join(', '),
      target_date: document.getElementById('storyTargetDate').value,
      publish_date: document.getElementById('storyPublishDate').value,
      pitch_doc_url: document.getElementById('storyPitchUrl').value,
      published_url: document.getElementById('storyPublishedLink').value,
      notes: document.getElementById('storyNotes').value
    };

    // Show loading state
    var saveBtn = document.getElementById('saveStoryBtn');
    var originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    function resetButton() {
      saveBtn.disabled = false;
      saveBtn.textContent = originalText;
    }

    if (storyId) {
      // Update existing
      google.script.run
        .withSuccessHandler(function(result) {
          resetButton();
          if (!result) {
            alert('Error: Story not found. It may have been deleted or the ID changed.\n\nPlease refresh the page and try again.');
            return;
          }
          closeModal('editStoryModal');
          loadStories();
          loadOverview();
          alert('Story updated successfully!');
        })
        .withFailureHandler(function(error) {
          resetButton();
          alert('Failed to update story: ' + error);
        })
        .updateStory(storyId, storyData);
    } else {
      // Create new
      google.script.run
        .withSuccessHandler(function(result) {
          resetButton();
          closeModal('editStoryModal');
          loadStories();
          loadOverview();
          alert('Story created successfully!');
        })
        .withFailureHandler(function(error) {
          resetButton();
          alert('Failed to create story: ' + error);
        })
        .createStory(storyData);
    }
  }

  function suggestStory(solutionId) {
    showCreateStoryModal();
    document.getElementById('storySolution').value = solutionId;
    document.getElementById('storySource').value = 'Coverage gap identified';
  }

  function createStoryFromOpportunity(type, value) {
    showCreateStoryModal();
    if (type === 'milestone') {
      // value is solution_id
      document.getElementById('storySolution').value = value;
      document.getElementById('storySource').value = 'Milestone opportunity';
    } else if (type === 't8') {
      document.getElementById('storySource').value = 'T8 Impact contact: ' + value;
    }
  }

  function refreshOpportunities() {
    document.getElementById('opportunitiesPanel').innerHTML = '<div class="loading-state"><span class="loading-spinner"></span></div>';
    loadOpportunities();
  }

  // Calendar functions
  function renderCalendar() {
    var date = state.calendarDate;
    var year = date.getFullYear();
    var month = date.getMonth();

    document.getElementById('calendarTitle').textContent =
      date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    var firstDay = new Date(year, month, 1);
    var lastDay = new Date(year, month + 1, 0);
    var startDay = firstDay.getDay();
    var daysInMonth = lastDay.getDate();

    var today = new Date();
    today.setHours(0, 0, 0, 0);

    // Get stories with dates in this month
    var monthStories = state.stories.filter(function(s) {
      var targetDate = s.target_date ? new Date(s.target_date) : null;
      var publishDate = s.publish_date ? new Date(s.publish_date) : null;
      if (targetDate && targetDate.getMonth() === month && targetDate.getFullYear() === year) return true;
      if (publishDate && publishDate.getMonth() === month && publishDate.getFullYear() === year) return true;
      return false;
    });

    // Group by day
    var storiesByDay = {};
    monthStories.forEach(function(s) {
      if (s.target_date) {
        var d = new Date(s.target_date).getDate();
        if (!storiesByDay[d]) storiesByDay[d] = [];
        storiesByDay[d].push({ story: s, type: 'target' });
      }
      if (s.publish_date && s.status === 'published') {
        var d = new Date(s.publish_date).getDate();
        if (!storiesByDay[d]) storiesByDay[d] = [];
        storiesByDay[d].push({ story: s, type: 'published' });
      }
    });

    var html = '';

    // Day headers
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(function(day) {
      html += '<div class="calendar-day-header">' + day + '</div>';
    });

    // Previous month days
    var prevMonth = new Date(year, month, 0);
    var prevMonthDays = prevMonth.getDate();
    for (var i = startDay - 1; i >= 0; i--) {
      html += '<div class="calendar-day other-month"><div class="calendar-day-number">' + (prevMonthDays - i) + '</div></div>';
    }

    // Current month days
    for (var day = 1; day <= daysInMonth; day++) {
      var isToday = (day === today.getDate() && month === today.getMonth() && year === today.getFullYear());
      html += '<div class="calendar-day' + (isToday ? ' today' : '') + '">';
      html += '<div class="calendar-day-number">' + day + '</div>';

      if (storiesByDay[day]) {
        storiesByDay[day].slice(0, 3).forEach(function(item) {
          html += '<div class="calendar-event ' + item.type + '" onclick="COMMS.showStoryDetail(\'' + escapeAttr(item.story.story_id) + '\')" title="' + escapeAttr(item.story.title) + '">';
          html += escapeHtml(item.story.title ? item.story.title.substring(0, 15) : 'Untitled');
          html += '</div>';
        });
        if (storiesByDay[day].length > 3) {
          html += '<div style="font-size: 10px; color: var(--color-text-muted);">+' + (storiesByDay[day].length - 3) + ' more</div>';
        }
      }

      html += '</div>';
    }

    // Next month days
    var totalCells = startDay + daysInMonth;
    var remaining = totalCells % 7;
    if (remaining > 0) {
      for (var i = 1; i <= 7 - remaining; i++) {
        html += '<div class="calendar-day other-month"><div class="calendar-day-number">' + i + '</div></div>';
      }
    }

    document.getElementById('calendarGrid').innerHTML = html;
  }

  function navigateCalendar(direction) {
    var date = state.calendarDate;
    date.setMonth(date.getMonth() + direction);
    renderCalendar();
  }

  function loadUpcomingTargets() {
    google.script.run
      .withSuccessHandler(function(targets) {
        var container = document.getElementById('upcomingTargetsList');
        if (!targets || targets.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No upcoming targets</p></div>';
          return;
        }

        var html = '';
        targets.slice(0, 10).forEach(function(t) {
          html += '<div class="target-item" onclick="COMMS.showStoryDetail(\'' + escapeAttr(t.story_id) + '\')">';
          html += '<div class="target-info">';
          html += '<div class="target-title">' + escapeHtml(t.title || 'Untitled') + '</div>';
          html += '<div class="target-date">' + formatDate(t.target_date) + '</div>';
          html += '</div></div>';
        });

        container.innerHTML = html;
      })
      .withFailureHandler(function(error) {
        document.getElementById('upcomingTargetsList').innerHTML =
          '<div class="empty-state"><p>Could not load targets</p></div>';
      })
      .getUpcomingTargets(60);
  }

  function renderCommsDue() {
    var container = document.getElementById('commsDueList');
    var coverage = state.coverage;

    if (!coverage) {
      // Coverage not loaded yet, load it
      google.script.run
        .withSuccessHandler(function(cov) {
          state.coverage = cov;
          renderCommsDue();
        })
        .withFailureHandler(function(error) {
          container.innerHTML = '<div class="empty-state-sm">Could not load coverage data</div>';
        })
        .getCoverageAnalysis(90);
      return;
    }

    // Combine gaps and uncovered solutions
    var needsAttention = [];

    if (coverage.gaps && coverage.gaps.length > 0) {
      coverage.gaps.forEach(function(g) {
        needsAttention.push({
          solution_name: g.solution_name || g.solution_id,
          solution_id: g.solution_id,
          days_since: g.days_since_story,
          last_date: g.last_story_date,
          type: 'gap'
        });
      });
    }

    if (coverage.uncovered && coverage.uncovered.length > 0) {
      coverage.uncovered.forEach(function(u) {
        needsAttention.push({
          solution_name: u.solution_name || u.solution_id,
          solution_id: u.solution_id,
          days_since: null,
          last_date: null,
          type: 'uncovered'
        });
      });
    }

    // Sort by urgency (uncovered first, then by days_since descending)
    needsAttention.sort(function(a, b) {
      if (a.type === 'uncovered' && b.type !== 'uncovered') return -1;
      if (a.type !== 'uncovered' && b.type === 'uncovered') return 1;
      var aDays = a.days_since || 9999;
      var bDays = b.days_since || 9999;
      return bDays - aDays;
    });

    if (needsAttention.length === 0) {
      container.innerHTML = '<div class="empty-state-sm"><span class="material-icons" style="color: var(--color-success);">check_circle</span> All solutions have recent coverage!</div>';
      return;
    }

    var html = '';
    needsAttention.slice(0, 8).forEach(function(item) {
      var isUrgent = item.type === 'uncovered' || (item.days_since && item.days_since > 180);
      var isWarning = !isUrgent && item.days_since && item.days_since > 90;
      var urgencyClass = isUrgent ? 'urgent' : (isWarning ? 'warning' : '');
      var daysClass = isUrgent ? 'urgent' : (isWarning ? 'warning' : '');

      var daysText = item.type === 'uncovered' ? 'No stories ever' :
                     (item.days_since ? item.days_since + ' days since last story' : 'Needs coverage');

      html += '<div class="comms-due-item ' + urgencyClass + '">';
      html += '<div class="comms-due-info">';
      html += '<div class="comms-due-solution">' + escapeHtml(item.solution_name) + '</div>';
      html += '<div class="comms-due-days ' + daysClass + '">' + daysText + '</div>';
      html += '</div>';
      html += '<button class="comms-due-action" onclick="event.stopPropagation(); COMMS.suggestStory(\'' + escapeAttr(item.solution_id || item.solution_name) + '\')">+ Story</button>';
      html += '</div>';
    });

    if (needsAttention.length > 8) {
      html += '<div style="text-align: center; margin-top: var(--space-sm);">';
      html += '<button class="btn btn-sm btn-secondary" onclick="COMMS.setView(\'coverage\')">';
      html += 'View all ' + needsAttention.length + ' solutions</button></div>';
    }

    container.innerHTML = html;
  }

  function closeModal(modalId, event) {
    if (!event || event.target === document.getElementById(modalId)) {
      document.getElementById(modalId).classList.remove('active');
    }
  }

  // ============================================
  // Events Functions
  // ============================================

  function loadEvents() {
    google.script.run
      .withSuccessHandler(function(events) {
        state.events = events || [];
        renderEventsStats();
        renderEventsView();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load events:', error);
        document.getElementById('eventsTableBody').innerHTML =
          '<tr><td colspan="7" class="empty-state">Failed to load events</td></tr>';
      })
      .getAllEvents();

    // Also load overview for stats
    google.script.run
      .withSuccessHandler(function(overview) {
        state.eventsOverview = overview;
        renderEventsStats();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load events overview:', error);
      })
      .getOutreachOverview();
  }

  function renderEventsStats() {
    var overview = state.eventsOverview;
    if (overview && overview.stats) {
      document.getElementById('eventStatUpcoming').textContent = overview.stats.upcoming_events || 0;
      document.getElementById('eventStatConfirmed').textContent = overview.stats.confirmed_events || 0;
      document.getElementById('eventStatPotential').textContent = overview.stats.potential_events || 0;
      document.getElementById('eventStatDeadlines').textContent = overview.stats.deadlines_30_days || 0;
    }
  }

  function renderEventsView() {
    var events = filterEventsData(state.events);

    // Render upcoming events panel
    var upcomingEvents = events.filter(function(e) {
      return e.status === 'confirmed' && e.start_date && new Date(e.start_date) >= new Date();
    }).slice(0, 5);

    var upcomingHtml = '';
    if (upcomingEvents.length === 0) {
      upcomingHtml = '<div class="empty-state"><span class="material-icons">calendar_today</span><p>No upcoming events</p></div>';
    } else {
      upcomingEvents.forEach(function(e) {
        upcomingHtml += renderEventCard(e);
      });
    }
    document.getElementById('upcomingEventsPanel').innerHTML = upcomingHtml;

    // Render potential events panel
    var potentialEvents = events.filter(function(e) {
      return e.status === 'potential' || e.status === 'considering';
    }).slice(0, 5);

    var potentialHtml = '';
    if (potentialEvents.length === 0) {
      potentialHtml = '<div class="empty-state"><span class="material-icons">explore</span><p>No potential events</p></div>';
    } else {
      potentialEvents.forEach(function(e) {
        potentialHtml += renderEventCard(e, true);
      });
    }
    document.getElementById('potentialEventsPanel').innerHTML = potentialHtml;
    document.getElementById('potentialBadge').textContent = potentialEvents.length;

    // Render events table
    renderEventsTable(events);
}

  function renderEventCard(event, showActions) {
    var typeIcons = {
      'conference': 'users',
      'workshop': 'tool',
      'webinar': 'video',
      'meeting': 'briefcase',
      'site_visit': 'map-pin'
    };
    var icon = typeIcons[event.event_type] || 'calendar';

    var statusClass = event.status || 'potential';

    var html = '<div class="event-card" onclick="COMMS.showEventDetail(\'' + escapeAttr(event.event_id) + '\')">';

    // Header: type icon + status
    html += '<div class="event-card-header">';
    html += '<span class="event-type-icon"><span class="material-icons">' + icon + '</span></span>';
    html += '<span class="event-status ' + statusClass + '">' + (event.status || 'potential') + '</span>';
    html += '</div>';

    // Title
    html += '<div class="event-card-title">' + escapeHtml(event.name) + '</div>';

    // Details (date & location)
    var hasDetails = event.start_date || event.location;
    if (hasDetails) {
      html += '<div class="event-card-details">';
      if (event.start_date) {
        html += '<div class="event-card-date"><span class="material-icons">event</span>' + formatDate(event.start_date) + '</div>';
      }
      if (event.location) {
        html += '<div class="event-card-location"><span class="material-icons">place</span>' + escapeHtml(event.location.substring(0, 35)) + '</div>';
      }
      html += '</div>';
    }

    // Actions for potential events
    if (showActions && (event.status === 'potential' || event.status === 'considering')) {
      html += '<div class="event-card-actions">';
      html += '<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'confirmed\')">Confirm</button>';
      html += '<button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'cancelled\')">Decline</button>';
      html += '</div>';
    }

    html += '</div>';
    return html;
  }

  function renderEventsTable(events) {
    var tbody = document.getElementById('eventsTableBody');

    if (events.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No events found</td></tr>';
      return;
    }

    // Sort by date
    events.sort(function(a, b) {
      var dateA = a.start_date ? new Date(a.start_date) : new Date('9999-12-31');
      var dateB = b.start_date ? new Date(b.start_date) : new Date('9999-12-31');
      return dateA - dateB;
    });

    var html = '';
    events.slice(0, 50).forEach(function(e) {
      var statusClass = 'status-' + (e.status || 'potential');
      var typeIcons = {
        'conference': 'users',
        'workshop': 'tool',
        'webinar': 'video',
        'meeting': 'briefcase',
        'site_visit': 'map-pin'
      };
      var icon = typeIcons[e.event_type] || 'calendar';

      html += '<tr onclick="COMMS.showEventDetail(\'' + escapeAttr(e.event_id) + '\')" style="cursor: pointer;">';
      html += '<td><strong>' + escapeHtml(e.name) + '</strong></td>';
      html += '<td><span class="material-icons">' + icon + '</span> ' + capitalizeFirst(e.event_type || 'event') + '</td>';
      html += '<td>' + (e.start_date ? formatDate(e.start_date) : '--') + '</td>';
      html += '<td>' + escapeHtml(e.location || '--').substring(0, 25) + '</td>';
      html += '<td><span class="event-status ' + (e.status || 'potential') + '">' + (e.status || 'potential') + '</span></td>';
      html += '<td>' + escapeHtml(e.team_members || '--').substring(0, 20) + '</td>';
      html += '<td>';
      if (e.event_url) {
        html += '<a href="' + escapeHtml(e.event_url) + '" target="_blank" class="btn btn-sm btn-secondary" onclick="event.stopPropagation()"><span class="material-icons">open_in_new</span></a>';
      }
      html += '</td>';
      html += '</tr>';
    });

    tbody.innerHTML = html;
  }

  function filterEventsData(events) {
    var filters = state.eventFilters;
    return events.filter(function(e) {
      if (filters.year && e.year && e.year.toString() !== filters.year) return false;
      if (filters.status && e.status !== filters.status) return false;
      return true;
    });
  }

  function filterEvents() {
    state.eventFilters.year = document.getElementById('eventYearFilter').value;
    state.eventFilters.status = document.getElementById('eventStatusFilter').value;
    renderEventsView();
  }

  function showEventDetail(eventId) {
    var event = state.events.find(function(e) { return e.event_id === eventId; });
    if (!event) {
      google.script.run
        .withSuccessHandler(function(e) {
          if (e) renderEventDetailModal(e);
        })
        .getEventById(eventId);
      return;
    }
    renderEventDetailModal(event);
  }

  function renderEventDetailModal(event) {
    // Set current event for guest list functions
    currentEventId = event.event_id;
    currentEventDetail = event;
    currentEventGuests = [];

    // Reset to details tab
    switchEventTab('details');

    // Reset prep report
    document.getElementById('prepReportBody').innerHTML = '<div class="empty-state"><span class="material-icons">assignment</span><p>Click "Generate Prep Report" to create a preparation report for this event</p></div>';
    document.getElementById('exportPrepBtn').style.display = 'none';

    // Reset guest search
    document.getElementById('guestSearchInput').value = '';
    document.getElementById('guestSearchResults').innerHTML = '<div class="empty-state-sm">Search to find contacts</div>';
    document.getElementById('currentGuestList').innerHTML = '<div class="empty-state-sm">Switch to Guest List tab to load guests</div>';

    // Load guest count for badge
    google.script.run
      .withSuccessHandler(function(guests) {
        document.getElementById('guestCountBadge').textContent = (guests || []).length;
      })
      .getEventGuests(event.event_id);

    document.getElementById('modalEventName').textContent = event.name || 'Event Details';

    // Render the view mode content
    renderEventViewMode(event);
  }

  function renderEventViewMode(event) {
    currentEventDetail = event;

    var statusClass = event.status || 'potential';

    var html = '<div class="event-detail">';

    // Header with type, status, and edit/delete buttons
    html += '<div class="event-detail-header">';
    html += '<div class="event-detail-meta">';
    html += '<span class="event-type-label">' + capitalizeFirst(event.event_type || 'Event') + '</span>';
    html += '<span class="event-status ' + statusClass + '">' + (event.status || 'potential') + '</span>';
    html += '</div>';
    html += '<div class="event-detail-actions">';
    html += '<button class="btn btn-sm btn-secondary" onclick="COMMS.showEventEditForm()" title="Edit"><span class="material-icons">edit</span></button>';
    html += '<button class="btn btn-sm btn-danger" onclick="COMMS.deleteEvent(\'' + escapeAttr(event.event_id) + '\')" title="Delete"><span class="material-icons">delete</span></button>';
    html += '</div>';
    html += '</div>';

    // Details grid
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';

    if (event.start_date) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">DATE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(event.start_date);
      if (event.end_date && event.end_date !== event.start_date) {
        html += ' - ' + formatDate(event.end_date);
      }
      html += '</div></div>';
    }

    if (event.location) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">LOCATION</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.location) + '</div></div>';
    }

    if (event.deadline) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">DEADLINE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + formatDate(event.deadline) + '</div></div>';
    }

    if (event.sector) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">SECTOR</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.sector) + '</div></div>';
    }

    if (event.solution_id) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">RELEVANT SOLUTIONS</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.solution_id) + '</div></div>';
    }

    if (event.team_members) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">TEAM</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.team_members) + '</div></div>';
    }

    if (event.stakeholders) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">AUDIENCE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.stakeholders) + '</div></div>';
    }

    if (event.priority) {
      html += '<div><div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">PRIORITY</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + capitalizeFirst(event.priority) + '</div></div>';
    }

    html += '</div>';

    // Purpose
    if (event.purpose) {
      html += '<div style="margin-bottom: var(--space-md);">';
      html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 2px;">PURPOSE</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.purpose) + '</div>';
      html += '</div>';
    }

    // Links
    if (event.event_url || event.presentation_url) {
      html += '<div style="margin-bottom: var(--space-md);">';
      if (event.event_url) {
        html += '<a href="' + escapeHtml(event.event_url) + '" target="_blank" class="btn btn-secondary" style="margin-right: var(--space-sm);">';
        html += '<span class="material-icons">open_in_new</span> Event Website</a>';
      }
      if (event.presentation_url) {
        html += '<a href="' + escapeHtml(event.presentation_url) + '" target="_blank" class="btn btn-secondary">';
        html += '<span class="material-icons">description</span> Presentation</a>';
      }
      html += '</div>';
    }

    // Notes
    if (event.notes) {
      html += '<div style="background: var(--color-surface-alt); padding: var(--space-md); border-radius: var(--radius-sm); margin-bottom: var(--space-md);">';
      html += '<div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: var(--space-xs);">NOTES</div>';
      html += '<div style="font-size: var(--font-size-sm);">' + escapeHtml(event.notes) + '</div>';
      html += '</div>';
    }

    // Actions
    html += '<div style="display: flex; gap: var(--space-sm); padding-top: var(--space-md); border-top: 1px solid var(--color-border-light);">';
    if (event.status === 'potential' || event.status === 'considering') {
      html += '<button class="btn btn-primary" onclick="COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'confirmed\')">Confirm Attendance</button>';
      html += '<button class="btn btn-secondary" onclick="COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'cancelled\')">Decline</button>';
    } else if (event.status === 'confirmed') {
      html += '<button class="btn btn-primary" onclick="COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'attended\')">Mark Attended</button>';
      html += '<button class="btn btn-secondary" onclick="COMMS.updateEventStatus(\'' + escapeAttr(event.event_id) + '\', \'cancelled\')">Cancel</button>';
    }
    html += '</div>';

    html += '</div>';

    document.getElementById('eventModalBody').innerHTML = html;
    document.getElementById('eventModal').classList.add('active');
  }

  function formatDateForInput(dateStr) {
    if (!dateStr) return '';
    // Handle ISO dates by extracting just the date part
    var dateOnly = String(dateStr).split('T')[0];
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateOnly)) {
      return dateOnly;
    }
    // Fallback
    try {
      var d = new Date(dateStr);
      return d.toISOString().split('T')[0];
    } catch (e) {
      return '';
    }
  }

  function showEventEditForm() {
    var event = currentEventDetail;
    if (!event) return;

    var html = '<form id="eventEditForm" onsubmit="COMMS.saveEventDetails(event); return false;">';

    // Row 1: Name and Type
    html += '<div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Event Name</label>';
    html += '<input type="text" id="editEventName" value="' + escapeAttr(event.name || '') + '" required class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Type</label>';
    html += '<select id="editEventType" class="form-control">';
    var types = ['conference', 'webinar', 'workshop', 'meeting', 'presentation', 'training', 'other'];
    types.forEach(function(t) {
      var selected = (event.event_type === t) ? ' selected' : '';
      html += '<option value="' + t + '"' + selected + '>' + capitalizeFirst(t) + '</option>';
    });
    html += '</select>';
    html += '</div>';
    html += '</div>';

    // Row 2: Dates
    html += '<div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Start Date</label>';
    html += '<input type="date" id="editEventStartDate" value="' + formatDateForInput(event.start_date) + '" class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">End Date</label>';
    html += '<input type="date" id="editEventEndDate" value="' + formatDateForInput(event.end_date) + '" class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Deadline</label>';
    html += '<input type="date" id="editEventDeadline" value="' + formatDateForInput(event.deadline) + '" class="form-control">';
    html += '</div>';
    html += '</div>';

    // Row 3: Location and Status
    html += '<div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Location</label>';
    html += '<input type="text" id="editEventLocation" value="' + escapeAttr(event.location || '') + '" class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Status</label>';
    html += '<select id="editEventStatus" class="form-control">';
    var statuses = ['potential', 'considering', 'confirmed', 'attended', 'cancelled'];
    statuses.forEach(function(s) {
      var selected = (event.status === s) ? ' selected' : '';
      html += '<option value="' + s + '"' + selected + '>' + capitalizeFirst(s) + '</option>';
    });
    html += '</select>';
    html += '</div>';
    html += '</div>';

    // Row 4: Sector and Priority
    html += '<div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Sector</label>';
    html += '<input type="text" id="editEventSector" value="' + escapeAttr(event.sector || '') + '" class="form-control">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Priority</label>';
    html += '<select id="editEventPriority" class="form-control">';
    html += '<option value="">-- Select --</option>';
    var priorities = ['high', 'medium', 'low'];
    priorities.forEach(function(p) {
      var selected = (event.priority === p) ? ' selected' : '';
      html += '<option value="' + p + '"' + selected + '>' + capitalizeFirst(p) + '</option>';
    });
    html += '</select>';
    html += '</div>';
    html += '</div>';

    // Row 5: Solutions and Team
    html += '<div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Relevant Solutions</label>';
    html += '<input type="text" id="editEventSolutions" value="' + escapeAttr(event.solution_id || '') + '" class="form-control" placeholder="e.g., FIRMS, LANCE">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Team Members</label>';
    html += '<input type="text" id="editEventTeam" value="' + escapeAttr(event.team_members || '') + '" class="form-control">';
    html += '</div>';
    html += '</div>';

    // Row 6: Stakeholders
    html += '<div class="form-group" style="margin-bottom: var(--space-md);">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Audience/Stakeholders</label>';
    html += '<input type="text" id="editEventStakeholders" value="' + escapeAttr(event.stakeholders || '') + '" class="form-control">';
    html += '</div>';

    // Row 7: Purpose
    html += '<div class="form-group" style="margin-bottom: var(--space-md);">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Purpose</label>';
    html += '<textarea id="editEventPurpose" rows="2" class="form-control">' + escapeHtml(event.purpose || '') + '</textarea>';
    html += '</div>';

    // Row 8: URLs
    html += '<div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Event URL</label>';
    html += '<input type="url" id="editEventUrl" value="' + escapeAttr(event.event_url || '') + '" class="form-control" placeholder="https://">';
    html += '</div>';
    html += '<div class="form-group">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Presentation URL</label>';
    html += '<input type="url" id="editEventPresentation" value="' + escapeAttr(event.presentation_url || '') + '" class="form-control" placeholder="https://">';
    html += '</div>';
    html += '</div>';

    // Row 9: Notes
    html += '<div class="form-group" style="margin-bottom: var(--space-md);">';
    html += '<label style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">Notes</label>';
    html += '<textarea id="editEventNotes" rows="3" class="form-control">' + escapeHtml(event.notes || '') + '</textarea>';
    html += '</div>';

    // Actions
    html += '<div style="display: flex; gap: var(--space-sm); justify-content: flex-end; padding-top: var(--space-md); border-top: 1px solid var(--color-border-light);">';
    html += '<button type="button" class="btn btn-secondary" onclick="COMMS.renderEventViewMode(COMMS.getCurrentEventDetail())">Cancel</button>';
    html += '<button type="submit" class="btn btn-primary" id="saveEventBtn">Save Changes</button>';
    html += '</div>';

    html += '</form>';

    document.getElementById('eventModalBody').innerHTML = html;
  }

  function getCurrentEventDetail() {
    return currentEventDetail;
  }

  function saveEventDetails(e) {
    if (e) e.preventDefault();
    if (!currentEventDetail) return;

    var updates = {
      name: document.getElementById('editEventName').value.trim(),
      event_type: document.getElementById('editEventType').value,
      start_date: document.getElementById('editEventStartDate').value || null,
      end_date: document.getElementById('editEventEndDate').value || null,
      deadline: document.getElementById('editEventDeadline').value || null,
      location: document.getElementById('editEventLocation').value.trim(),
      status: document.getElementById('editEventStatus').value,
      sector: document.getElementById('editEventSector').value.trim(),
      priority: document.getElementById('editEventPriority').value,
      solution_id: document.getElementById('editEventSolutions').value.trim(),
      team_members: document.getElementById('editEventTeam').value.trim(),
      stakeholders: document.getElementById('editEventStakeholders').value.trim(),
      purpose: document.getElementById('editEventPurpose').value.trim(),
      event_url: document.getElementById('editEventUrl').value.trim(),
      presentation_url: document.getElementById('editEventPresentation').value.trim(),
      notes: document.getElementById('editEventNotes').value.trim()
    };

    if (!updates.name) {
      alert('Event name is required.');
      return;
    }

    var saveBtn = document.getElementById('saveEventBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    google.script.run
      .withSuccessHandler(function(result) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
        if (!result) {
          alert('Error: Event not found. It may have been deleted.\n\nPlease refresh the page and try again.');
          return;
        }
        // Update local state
        currentEventDetail = result;
        var idx = state.events.findIndex(function(ev) { return ev.event_id === result.event_id; });
        if (idx !== -1) {
          state.events[idx] = result;
        }
        // Update modal title
        document.getElementById('modalEventName').textContent = result.name || 'Event Details';
        // Switch back to view mode
        renderEventViewMode(result);
        loadEvents(); // Refresh the events list
      })
      .withFailureHandler(function(error) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
        alert('Failed to save event: ' + error);
      })
      .updateEvent(currentEventDetail.event_id, updates);
  }

  function deleteEvent(eventId) {
    if (!confirm('Are you sure you want to delete this event? This cannot be undone.')) {
      return;
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result) {
          closeModal('eventModal');
          loadEvents();
          alert('Event deleted.');
        } else {
          alert('Failed to delete event. It may have already been deleted.');
        }
      })
      .withFailureHandler(function(error) {
        alert('Failed to delete event: ' + error);
      })
      .deleteEvent(eventId);
  }

  function updateEventStatus(eventId, newStatus) {
    // Disable all status buttons (modal and card) and show loading
    var buttons = document.querySelectorAll('#eventModal .btn, .event-card-actions .btn');
    buttons.forEach(function(btn) {
      btn.disabled = true;
      if (btn.textContent.indexOf('Confirm') !== -1 ||
          btn.textContent.indexOf('Decline') !== -1 ||
          btn.textContent.indexOf('Cancel') !== -1 ||
          btn.textContent.indexOf('Attended') !== -1) {
        btn.dataset.originalText = btn.textContent;
        btn.textContent = 'Updating...';
      }
    });

    google.script.run
      .withSuccessHandler(function(result) {
        if (!result) {
          // Re-enable buttons on error
          buttons.forEach(function(btn) {
            btn.disabled = false;
            if (btn.dataset.originalText) {
              btn.textContent = btn.dataset.originalText;
            }
          });
          alert('Error: Event not found. It may have been deleted or the ID changed.\n\nPlease refresh the page and try again.');
          return;
        }
        closeModal('eventModal');
        loadEvents();
        // Show brief success notification
        var statusNames = { confirmed: 'confirmed', cancelled: 'declined', attended: 'marked as attended' };
        alert('Event ' + (statusNames[newStatus] || 'updated') + ' successfully!');
      })
      .withFailureHandler(function(error) {
        // Re-enable buttons
        buttons.forEach(function(btn) {
          btn.disabled = false;
          if (btn.dataset.originalText) {
            btn.textContent = btn.dataset.originalText;
          }
        });
        alert('Failed to update event status: ' + error);
      })
      .updateEventStatus(eventId, newStatus);
  }

  function showAddEventModal() {
    document.getElementById('addEventForm').reset();
    document.getElementById('addEventModal').classList.add('active');
  }

  function submitNewEvent(e) {
    e.preventDefault();

    var name = document.getElementById('newEventName').value.trim();
    if (!name) {
      alert('Please enter an event name');
      return;
    }

    var startDate = document.getElementById('newEventStartDate').value || null;
    var endDate = document.getElementById('newEventEndDate').value || null;

    // Derive year from start_date, fallback to current year
    var year = startDate ? new Date(startDate).getFullYear() : new Date().getFullYear();

    // Check for duplicate event (same name and year)
    var duplicate = state.events.find(function(evt) {
      return evt.name && evt.name.toLowerCase() === name.toLowerCase() && evt.year === year;
    });
    if (duplicate) {
      alert('An event with this name already exists for ' + year + '. Please use a different name or edit the existing event.');
      return;
    }

    var eventData = {
      name: name,
      event_type: document.getElementById('newEventType').value,
      status: document.getElementById('newEventStatus').value,
      year: year,
      start_date: startDate,
      end_date: endDate,
      priority_sector: document.getElementById('newEventSector').value || null,
      event_url: document.getElementById('newEventUrl').value.trim() || null,
      notes: document.getElementById('newEventNotes').value.trim() || null,
      source: 'manual_entry'
    };

    var submitBtn = document.querySelector('#addEventForm button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    google.script.run
      .withSuccessHandler(function(result) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Event';
        if (result && result.event_id) {
          closeModal('addEventModal');
          loadEvents();
        } else {
          alert('Event created but no ID returned');
        }
      })
      .withFailureHandler(function(error) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Event';
        alert('Failed to add event: ' + error);
      })
      .createEvent(eventData);
  }

  // ============================================
  // Utility functions
  function formatDate(dateStr) {
    if (!dateStr) return '--';
    // Handle ISO dates (2026-01-23T00:00:00.000Z) by extracting just the date part
    // This avoids timezone conversion issues where UTC midnight becomes previous day locally
    var dateOnly = String(dateStr).split('T')[0];
    var parts = dateOnly.split('-');
    if (parts.length === 3) {
      var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    // Fallback for other formats
    var date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function escapeAttr(text) {
    if (!text) return '';
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function showPipelineError(message) {
    var statuses = ['Idea', 'Researching', 'Drafting', 'Review', 'Published'];
    statuses.forEach(function(status) {
      document.getElementById('cards' + status).innerHTML =
        '<div class="empty-state"><p style="font-size: var(--font-size-xs);">Error</p></div>';
    });
  }

  // ============================================
  // Guest List & Prep Report Functions
  // ============================================

  var currentEventId = null;
  var currentEventDetail = null;
  var currentEventGuests = [];
  var guestSearchTimeout = null;

  function switchEventTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.modal-tab').forEach(function(tab) {
      tab.classList.toggle('active', tab.dataset.tab === tabName);
    });

    // Update tab panels
    document.getElementById('eventDetailsTab').classList.toggle('active', tabName === 'details');
    document.getElementById('eventGuestsTab').classList.toggle('active', tabName === 'guests');
    document.getElementById('eventPrepTab').classList.toggle('active', tabName === 'prep');

    // Load guest list if switching to guests tab
    if (tabName === 'guests' && currentEventId) {
      loadEventGuests();
    }
  }

  function loadEventGuests() {
    var listContainer = document.getElementById('currentGuestList');
    listContainer.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span></div>';

    google.script.run
      .withSuccessHandler(function(guests) {
        currentEventGuests = guests || [];
        renderGuestList(guests);
        document.getElementById('guestCountBadge').textContent = guests.length;
      })
      .withFailureHandler(function(error) {
        listContainer.innerHTML = '<div class="empty-state-sm">Failed to load guests</div>';
      })
      .getEventGuests(currentEventId);
  }

  function renderGuestList(guests) {
    var container = document.getElementById('currentGuestList');

    if (!guests || guests.length === 0) {
      container.innerHTML = '<div class="empty-state-sm">No guests added yet</div>';
      return;
    }

    // Check if event date has passed
    var event = state.events.find(function(e) { return e.event_id === currentEventId; });
    var isPastEvent = event && event.start_date && new Date(event.start_date) < new Date();

    var html = '';

    if (isPastEvent) {
      html += '<div class="attendance-section">';
      html += '<h4><span class="material-icons">fact_check</span> Mark Attendance</h4>';
    }

    guests.forEach(function(guest) {
      var name = (guest.first_name || '') + ' ' + (guest.last_name || '');

      if (isPastEvent) {
        // Show attendance checkboxes for past events
        html += '<div class="attendance-checkbox' + (guest.attended ? ' attended' : '') + '">';
        html += '<input type="checkbox" id="attend_' + escapeAttr(guest.email) + '" ' +
                (guest.attended ? 'checked' : '') +
                ' onchange="COMMS.toggleAttendance(\'' + escapeAttr(guest.email) + '\', this.checked)">';
        html += '<label for="attend_' + escapeAttr(guest.email) + '">';
        html += '<span class="guest-name">' + escapeHtml(name.trim() || guest.email) + '</span>';
        html += '</label>';
        html += '</div>';
      } else {
        // Show regular guest list for upcoming events
        html += '<div class="guest-list-item">';
        html += '<div class="guest-info">';
        html += '<div class="guest-name">' + escapeHtml(name.trim() || guest.email) + '</div>';
        html += '<div class="guest-email">' + escapeHtml(guest.email) + '</div>';
        if (guest.agency) {
          html += '<div class="guest-agency">' + escapeHtml(guest.agency) + '</div>';
        }
        html += '</div>';
        html += '<div class="guest-actions">';
        html += '<button class="guest-remove-btn" onclick="COMMS.removeGuest(\'' + escapeAttr(guest.email) + '\')" title="Remove">';
        html += '<span class="material-icons">close</span></button>';
        html += '</div>';
        html += '</div>';
      }
    });

    if (isPastEvent) {
      html += '<button class="btn btn-secondary" style="margin-top: var(--space-md); width: 100%;" onclick="COMMS.showNewContactFromEvent()">';
      html += '<span class="material-icons">person_add</span> Add New Contact Met at Event';
      html += '</button>';
      html += '</div>';
    }

    container.innerHTML = html;
  }

  function searchContactsForGuest() {
    var query = document.getElementById('guestSearchInput').value.trim();
    var resultsContainer = document.getElementById('guestSearchResults');

    if (query.length < 2) {
      resultsContainer.innerHTML = '<div class="empty-state-sm">Search to find contacts</div>';
      return;
    }

    // Debounce
    clearTimeout(guestSearchTimeout);
    guestSearchTimeout = setTimeout(function() {
      resultsContainer.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span></div>';

      google.script.run
        .withSuccessHandler(function(contacts) {
          renderGuestSearchResults(contacts);
        })
        .withFailureHandler(function(error) {
          resultsContainer.innerHTML = '<div class="empty-state-sm">Search failed</div>';
        })
        .searchContacts(query);
    }, 300);
  }

  function renderGuestSearchResults(contacts) {
    var container = document.getElementById('guestSearchResults');

    if (!contacts || contacts.length === 0) {
      container.innerHTML = '<div class="empty-state-sm">No contacts found</div>';
      return;
    }

    // Filter out contacts already in guest list
    var guestEmails = currentEventGuests.map(function(g) { return g.email.toLowerCase(); });
    var available = contacts.filter(function(c) {
      return guestEmails.indexOf(c.email.toLowerCase()) === -1;
    });

    if (available.length === 0) {
      container.innerHTML = '<div class="empty-state-sm">All matching contacts already added</div>';
      return;
    }

    var html = '';
    available.slice(0, 10).forEach(function(contact) {
      var name = (contact.first_name || '') + ' ' + (contact.last_name || '');
      html += '<div class="guest-result-item">';
      html += '<div class="guest-info">';
      html += '<div class="guest-name">' + escapeHtml(name.trim() || contact.email) + '</div>';
      html += '<div class="guest-email">' + escapeHtml(contact.email) + '</div>';
      if (contact.agency || contact.organization) {
        html += '<div class="guest-agency">' + escapeHtml(contact.agency || contact.organization) + '</div>';
      }
      html += '</div>';
      html += '<button class="guest-add-btn" onclick="COMMS.addGuest(\'' + escapeAttr(contact.email) + '\')" title="Add to guest list">';
      html += '<span class="material-icons">add</span></button>';
      html += '</div>';
    });

    container.innerHTML = html;
  }

  function addGuest(email) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          loadEventGuests();
          document.getElementById('guestSearchInput').value = '';
          document.getElementById('guestSearchResults').innerHTML = '<div class="empty-state-sm">Search to find contacts</div>';
        } else {
          alert(result.error || 'Failed to add guest');
        }
      })
      .withFailureHandler(function(error) {
        alert('Failed to add guest: ' + error);
      })
      .addGuestToEvent(currentEventId, email);
  }

  function addSuggestedGuest(email) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // Refresh both the guest list and prep report
          loadEventGuests();
          generatePrepReport();
        } else {
          alert(result.error || 'Failed to add guest');
        }
      })
      .withFailureHandler(function(error) {
        alert('Failed to add guest: ' + error);
      })
      .addGuestToEvent(currentEventId, email);
  }

  function removeGuest(email) {
    if (!confirm('Remove this guest from the list?')) return;

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          loadEventGuests();
        } else {
          alert(result.error || 'Failed to remove guest');
        }
      })
      .withFailureHandler(function(error) {
        alert('Failed to remove guest: ' + error);
      })
      .removeGuestFromEvent(currentEventId, email);
  }

  function toggleAttendance(email, attended) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (!result.success) {
          alert(result.error || 'Failed to update attendance');
          loadEventGuests(); // Reload to reset checkbox
        }
      })
      .withFailureHandler(function(error) {
        alert('Failed to update attendance: ' + error);
        loadEventGuests();
      })
      .markGuestAttended(currentEventId, email, attended);
  }

  function generatePrepReport() {
    var container = document.getElementById('prepReportBody');
    container.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><p>Generating prep report...</p></div>';

    google.script.run
      .withSuccessHandler(function(report) {
        renderPrepReport(report);
      })
      .withFailureHandler(function(error) {
        container.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>Failed to generate report: ' + escapeHtml(error) + '</p></div>';
      })
      .getEventPrepReport(currentEventId);
  }

  function renderPrepReport(report) {
    var container = document.getElementById('prepReportBody');

    if (report.error) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>' + escapeHtml(report.error) + '</p></div>';
      return;
    }

    if (!report.guests || report.guests.length === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">people</span><p>No guests in the guest list. Add guests first to generate a prep report.</p></div>';
      return;
    }

    var html = '';

    // Summary Stats
    html += '<div class="prep-section">';
    html += '<h3><span class="material-icons">summarize</span> Summary</h3>';
    html += '<div class="prep-summary-stats">';
    html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.total_guests + '</div><div class="prep-stat-label">Guests</div></div>';
    html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.total_agencies + '</div><div class="prep-stat-label">Agencies</div></div>';
    html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.total_connections + '</div><div class="prep-stat-label">Connections</div></div>';
    if (report.summary.linked_solutions > 0) {
      html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.linked_solutions + '</div><div class="prep-stat-label">Solutions</div></div>';
    }
    if (report.summary.total_potential_guests > 0) {
      html += '<div class="prep-stat"><div class="prep-stat-value">' + report.summary.total_potential_guests + '</div><div class="prep-stat-label">Suggested</div></div>';
    }
    html += '</div>';
    html += '</div>';

    // Agencies Represented
    if (report.agencies_represented && report.agencies_represented.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">business</span> Agencies Represented</h3>';
      html += '<div class="prep-agency-list">';
      report.agencies_represented.forEach(function(agency) {
        html += '<div class="prep-agency-item">';
        html += '<div class="prep-agency-name">' + escapeHtml(agency.name) + '</div>';
        html += '<div class="prep-agency-count">' + agency.count + ' ' + (agency.count === 1 ? 'contact' : 'contacts') + '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    }

    // Potential Connections
    if (report.potential_connections && report.potential_connections.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">connect_without_contact</span> Potential Connections</h3>';
      report.potential_connections.slice(0, 10).forEach(function(conn) {
        html += '<div class="prep-connection-item">';
        html += '<span class="material-icons prep-connection-icon">link</span>';
        html += '<div>';
        html += '<div class="prep-connection-names">' + escapeHtml(conn.contact1.name) + ' & ' + escapeHtml(conn.contact2.name) + '</div>';
        html += '<div class="prep-connection-reason">' + escapeHtml(conn.reason) + '</div>';
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Conversation Starters
    if (report.conversation_starters && report.conversation_starters.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">chat_bubble</span> Conversation Starters</h3>';
      report.conversation_starters.forEach(function(starter) {
        html += '<div class="prep-starter-item">';
        html += '<div class="prep-starter-name">' + escapeHtml(starter.name) + '</div>';
        html += '<div class="prep-starter-topics">';
        starter.topics.slice(0, 4).forEach(function(topic) {
          html += '<span class="prep-topic-tag ' + topic.type + '">' + escapeHtml(topic.text) + '</span>';
        });
        html += '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    // Linked Solutions & Event Context
    if (report.event.linked_solutions && report.event.linked_solutions.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">hub</span> Linked Solutions</h3>';
      html += '<div class="prep-solution-tags">';
      report.event.linked_solutions.forEach(function(sol) {
        html += '<span class="prep-solution-tag">' + escapeHtml(sol) + '</span>';
      });
      html += '</div>';
      html += '</div>';
    }

    // Potential Guests (from solution engagements)
    if (report.potential_guests && report.potential_guests.length > 0) {
      html += '<div class="prep-section">';
      html += '<h3><span class="material-icons">person_add</span> Suggested Attendees</h3>';
      html += '<p class="prep-section-desc">These contacts have engaged with the event\'s linked solutions but aren\'t on the guest list yet.</p>';
      html += '<div class="potential-guests-list">';
      report.potential_guests.forEach(function(pg) {
        html += '<div class="potential-guest-item">';
        html += '<div class="potential-guest-info">';
        html += '<div class="potential-guest-name">' + escapeHtml(pg.name) + '</div>';
        if (pg.agency) html += '<div class="potential-guest-agency">' + escapeHtml(pg.agency) + '</div>';
        html += '<div class="potential-guest-reason">' + escapeHtml(pg.reason) + '</div>';
        if (pg.touchpoints && pg.touchpoints.length > 0) {
          html += '<div class="potential-guest-touchpoints">Touchpoints: ' + escapeHtml(pg.touchpoints.join(', ')) + '</div>';
        }
        html += '</div>';
        html += '<button class="btn btn-sm btn-primary" onclick="COMMS.addSuggestedGuest(\'' + escapeAttr(pg.email) + '\')">';
        html += '<span class="material-icons">add</span> Add</button>';
        html += '</div>';
      });
      html += '</div>';
      html += '</div>';
    }

    // Guest Profiles
    html += '<div class="prep-section">';
    html += '<h3><span class="material-icons">person</span> Guest Profiles</h3>';
    report.guests.forEach(function(guest) {
      html += '<div class="prep-guest-card">';
      html += '<div class="prep-guest-header">';
      html += '<div>';
      html += '<div class="prep-guest-name">' + escapeHtml(guest.name) + '</div>';
      if (guest.title) html += '<div class="prep-guest-title">' + escapeHtml(guest.title) + '</div>';
      if (guest.agency) html += '<div class="prep-guest-agency">' + escapeHtml(guest.agency) + '</div>';
      html += '</div>';
      html += '</div>';

      var hasDetails = guest.education || guest.hobbies || guest.goals || guest.professional_skills || guest.early_job || guest.relax;
      if (hasDetails) {
        html += '<div class="prep-guest-details">';
        if (guest.education) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Education</div>' + escapeHtml(guest.education) + '</div>';
        }
        if (guest.hobbies) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Hobbies</div>' + escapeHtml(guest.hobbies) + '</div>';
        }
        if (guest.goals) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Goals</div>' + escapeHtml(guest.goals) + '</div>';
        }
        if (guest.early_job) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">First Job</div>' + escapeHtml(guest.early_job) + '</div>';
        }
        if (guest.relax) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Unwinds By</div>' + escapeHtml(guest.relax) + '</div>';
        }
        if (guest.solutions && guest.solutions.length > 0) {
          html += '<div class="prep-detail-item"><div class="prep-detail-label">Solutions</div>' + escapeHtml(guest.solutions.join(', ')) + '</div>';
        }
        html += '</div>';
      }

      html += '</div>';
    });
    html += '</div>';

    container.innerHTML = html;

    // Show export button now that report is generated
    document.getElementById('exportPrepBtn').style.display = 'inline-flex';
  }

  function exportPrepToDoc() {
    var exportBtn = document.getElementById('exportPrepBtn');
    var originalText = exportBtn.innerHTML;
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<span class="loading-spinner"></span> Exporting...';

    google.script.run
      .withSuccessHandler(function(result) {
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalText;

        if (result.success) {
          // Open the doc in a new tab
          window.open(result.url, '_blank');
        } else {
          alert('Export failed: ' + (result.error || 'Unknown error'));
        }
      })
      .withFailureHandler(function(error) {
        exportBtn.disabled = false;
        exportBtn.innerHTML = originalText;
        alert('Export failed: ' + error.message);
      })
      .exportPrepReportToDoc(currentEventId);
  }

  function showNewContactFromEvent() {
    document.getElementById('newContactFromEventForm').reset();
    document.getElementById('addToGuestList').checked = true;
    document.getElementById('newContactFromEventModal').classList.add('active');
  }

  function submitNewContactFromEvent(e) {
    e.preventDefault();

    var contactData = {
      first_name: document.getElementById('newContactFirstName').value.trim(),
      last_name: document.getElementById('newContactLastName').value.trim(),
      email: document.getElementById('newContactEmail').value.trim().toLowerCase(),
      agency: document.getElementById('newContactAgency').value.trim(),
      title: document.getElementById('newContactTitle').value.trim(),
      notes: document.getElementById('newContactNotes').value.trim()
    };

    var addToGuests = document.getElementById('addToGuestList').checked;

    var submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';

    // First create the contact
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // If checkbox is checked, add to guest list
          if (addToGuests) {
            google.script.run
              .withSuccessHandler(function(guestResult) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Contact';
                closeModal('newContactFromEventModal');
                loadEventGuests();
                alert('Contact added successfully!');
              })
              .withFailureHandler(function(error) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Contact';
                closeModal('newContactFromEventModal');
                alert('Contact created but failed to add to guest list: ' + error);
              })
              .addGuestToEvent(currentEventId, contactData.email);
          } else {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Contact';
            closeModal('newContactFromEventModal');
            alert('Contact added successfully!');
          }
        } else {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Add Contact';
          alert(result.error || 'Failed to create contact');
        }
      })
      .withFailureHandler(function(error) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Contact';
        alert('Failed to create contact: ' + error);
      })
      .createContactForAgency(contactData);
  }

  // ========================================================================
  // DRAG AND DROP FOR STORY PIPELINE
  // ========================================================================

  var dragState = {
    draggingStoryId: null
  };

  function handleDragStart(event, storyId) {
    dragState.draggingStoryId = storyId;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', storyId);
  }

  function handleDragEnd(event) {
    event.target.classList.remove('dragging');
    dragState.draggingStoryId = null;
    // Remove drop-target class from all columns
    document.querySelectorAll('.pipeline-column').forEach(function(col) {
      col.classList.remove('drop-target');
    });
  }

  function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    var column = event.target.closest('.pipeline-column');
    if (column) {
      column.classList.add('drop-target');
    }
  }

  function handleDragLeave(event) {
    var column = event.target.closest('.pipeline-column');
    if (column && !column.contains(event.relatedTarget)) {
      column.classList.remove('drop-target');
    }
  }

  function handleDrop(event, newStatus) {
    event.preventDefault();
    var column = event.target.closest('.pipeline-column');
    if (column) {
      column.classList.remove('drop-target');
    }

    var storyId = dragState.draggingStoryId || event.dataTransfer.getData('text/plain');
    if (!storyId) return;

    // Find the story to get current status
    var story = state.stories.find(function(s) { return s.story_id === storyId; });
    if (!story) return;

    // Don't update if dropped in same column
    if (story.status === newStatus) return;

    // Update status via API
    google.script.run
      .withSuccessHandler(function(result) {
        if (result) {
          // Update local state
          story.status = newStatus;
          renderPipeline();
          loadOverview(); // Refresh stats
        } else {
          alert('Failed to update story status');
          renderPipeline(); // Re-render to reset position
        }
      })
      .withFailureHandler(function(error) {
        alert('Error updating status: ' + error);
        renderPipeline(); // Re-render to reset position
      })
      .updateStoryStatus(storyId, newStatus);
  }

  function deleteStory(storyId) {
    if (!confirm('Are you sure you want to delete this story?')) return;

    var btn = document.getElementById('deleteStoryBtn');
    var originalHtml = btn ? btn.innerHTML : '';
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner" style="width: 14px; height: 14px;"></span>';
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result) {
          closeModal('storyModal');
          loadStories();
          loadOverview();
        } else {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
          }
          alert('Failed to delete story');
        }
      })
      .withFailureHandler(function(error) {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHtml;
        }
        alert('Error deleting story: ' + error);
      })
      .deleteStory(storyId);
  }

  function toggleSearchBar() {
    var searchBar = document.getElementById('pipelineSearchBar');
    if (searchBar) {
      searchBar.classList.toggle('expanded');
    }
  }

  function filterStories() {
    applyFilters();
  }

  function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterChannel').value = '';
    applyFilters();
  }

  function toggleSidebar() {
    var sidebar = document.getElementById('insightsSidebar');
    var icon = document.getElementById('sidebarToggleIcon');
    if (sidebar) {
      sidebar.classList.toggle('collapsed');
      if (icon) {
        icon.textContent = sidebar.classList.contains('collapsed') ? 'chevron_right' : 'chevron_left';
      }
    }
  }

  function togglePublishedPanel() {
    var sidebar = document.getElementById('publishedSidebar');
    var icon = document.getElementById('publishedToggleIcon');
    if (sidebar) {
      sidebar.classList.toggle('collapsed');
      if (icon) {
        icon.textContent = sidebar.classList.contains('collapsed') ? 'chevron_left' : 'chevron_right';
      }
    }
  }

  return {
    init: init,
    setView: setView,
    applyFilters: applyFilters,
    showStoryDetail: showStoryDetail,
    showCreateStoryModal: showCreateStoryModal,
    editStory: editStory,
    submitStory: submitStory,
    advanceStatus: advanceStatus,
    suggestStory: suggestStory,
    createStoryFromOpportunity: createStoryFromOpportunity,
    refreshOpportunities: refreshOpportunities,
    navigateCalendar: navigateCalendar,
    closeModal: closeModal,
    // Events functions
    filterEvents: filterEvents,
    showEventDetail: showEventDetail,
    showEventEditForm: showEventEditForm,
    saveEventDetails: saveEventDetails,
    deleteEvent: deleteEvent,
    renderEventViewMode: renderEventViewMode,
    getCurrentEventDetail: getCurrentEventDetail,
    updateEventStatus: updateEventStatus,
    showAddEventModal: showAddEventModal,
    submitNewEvent: submitNewEvent,
    // Key Messages functions
    searchMessages: searchMessages,
    // Guest List & Prep Report functions
    switchEventTab: switchEventTab,
    searchContactsForGuest: searchContactsForGuest,
    addGuest: addGuest,
    addSuggestedGuest: addSuggestedGuest,
    removeGuest: removeGuest,
    toggleAttendance: toggleAttendance,
    generatePrepReport: generatePrepReport,
    exportPrepToDoc: exportPrepToDoc,
    showNewContactFromEvent: showNewContactFromEvent,
    submitNewContactFromEvent: submitNewContactFromEvent,
    // Drag and drop functions
    handleDragStart: handleDragStart,
    handleDragEnd: handleDragEnd,
    handleDragOver: handleDragOver,
    handleDragLeave: handleDragLeave,
    handleDrop: handleDrop,
    // Delete story
    deleteStory: deleteStory,
    // Sidebar toggles
    toggleSidebar: toggleSidebar,
    togglePublishedPanel: togglePublishedPanel,
    // Search bar
    toggleSearchBar: toggleSearchBar,
    filterStories: filterStories,
    clearFilters: clearFilters
  };
})();

// Initialize
if (typeof google !== 'undefined' && google.script) {
  COMMS.init();
} else {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() { COMMS.init(); }, 500);
  });
}
</script>
