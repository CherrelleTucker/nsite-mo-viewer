<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base target="_top">
  <title>Access Denied | MO-Viewer</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230B3D91'/%3E%3Crect x='5' y='5' width='9' height='9' rx='2' fill='white'/%3E%3Crect x='18' y='5' width='9' height='9' rx='2' fill='white'/%3E%3Crect x='5' y='18' width='9' height='9' rx='2' fill='white'/%3E%3Crect x='18' y='18' width='9' height='9' rx='2' fill='%2300A3E0'/%3E%3C/svg%3E">

  <style>
    :root {
      --color-primary: #0B3D91;
      --color-primary-light: #1E5BB8;
      --color-accent: #0095D9;
      --color-error: #D32F2F;
      --color-error-light: #FFEBEE;
      --color-error-dark: #B71C1C;
      --color-success: #2E7D32;
      --color-success-light: #E8F5E9;
      --color-info: #0288D1;
      --color-info-light: #E3F2FD;
      --color-surface: #FFFFFF;
      --color-surface-alt: #FAFAFA;
      --color-border: #E0E0E0;
      --color-text: #212121;
      --color-text-secondary: #666666;
      --color-text-muted: #999999;
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 50%, var(--color-accent) 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-lg);
    }

    .access-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 480px;
      width: 100%;
      overflow: hidden;
    }

    .card-header {
      background: var(--color-error-light);
      padding: var(--space-lg);
      text-align: center;
      border-bottom: 1px solid var(--color-border);
    }

    .lock-icon {
      width: 64px;
      height: 64px;
      background: var(--color-error);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-md);
    }

    .lock-icon svg {
      width: 32px;
      height: 32px;
      stroke: white;
      stroke-width: 2;
      fill: none;
    }

    .card-header h1 {
      color: var(--color-error-dark);
      font-size: 24px;
      font-weight: 600;
    }

    .card-body {
      padding: var(--space-lg);
    }

    .message {
      color: var(--color-text);
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: var(--space-lg);
      text-align: center;
    }

    .info-box {
      background: var(--color-info-light);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-lg);
    }

    .info-box h3 {
      color: var(--color-info);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: var(--space-sm);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .info-box h3 svg {
      width: 16px;
      height: 16px;
      stroke: var(--color-info);
      stroke-width: 2;
      fill: none;
    }

    .info-box p {
      color: var(--color-text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }

    .steps {
      margin-bottom: var(--space-lg);
    }

    .steps h3 {
      color: var(--color-text);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: var(--space-sm);
    }

    .steps ol {
      padding-left: 20px;
      color: var(--color-text-secondary);
      font-size: 14px;
      line-height: 1.8;
    }

    .steps li {
      margin-bottom: var(--space-sm);
    }

    .steps a {
      color: var(--color-primary);
      text-decoration: none;
    }

    .steps a:hover {
      text-decoration: underline;
    }

    .user-email {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 12px var(--space-md);
      font-family: monospace;
      font-size: 14px;
      color: var(--color-text-secondary);
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .user-email label {
      display: block;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: var(--color-text-muted);
      margin-bottom: var(--space-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-footer {
      background: var(--color-surface-alt);
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--color-border);
      text-align: center;
    }

    .card-footer a {
      color: var(--color-text-muted);
      font-size: 14px;
      text-decoration: none;
    }

    .card-footer a:hover {
      color: var(--color-primary);
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
    }

    .logo svg {
      width: 24px;
      height: 24px;
      stroke: var(--color-primary);
      stroke-width: 2;
      fill: none;
    }

    .logo span {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-primary);
    }

    /* Form elements */
    .request-textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
    }

    .request-btn {
      width: 100%;
      padding: var(--space-sm);
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .request-btn:hover {
      background: var(--color-primary-light);
    }

    .request-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .alert-success {
      padding: var(--space-md);
      background: var(--color-success-light);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      color: var(--color-success);
    }

    .alert-error {
      padding: var(--space-md);
      background: var(--color-error-light);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      color: var(--color-error);
    }
  </style>
</head>
<body>
  <div class="access-card">
    <div class="card-header">
      <div class="lock-icon">
        <!-- Lock icon -->
        <svg viewBox="0 0 24 24">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
      </div>
      <h1>Access Denied</h1>
    </div>

    <div class="card-body">
      <p class="message">
        You do not have permission to access MO-Viewer. This application is restricted to authorized NSITE MO team members.
      </p>

      <div class="user-email">
        <label>Your Account</label>
        <span id="userEmail">Loading...</span>
      </div>

      <div class="info-box">
        <h3>
          <!-- Info icon -->
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          Why am I seeing this?
        </h3>
        <p>
          MO-Viewer contains NSITE data that is restricted to team members. Access is managed through an approved users list - only users in the MO-DB_Access sheet can view this application.
        </p>
      </div>

      <div class="steps">
        <h3>Request Access:</h3>
        <div id="requestForm">
          <p style="margin-bottom: var(--space-sm); font-size: 14px; color: var(--color-text-secondary);">Click below to send an access request to the administrator.</p>
          <textarea id="requestReason" class="request-textarea" placeholder="Reason for access (optional)" maxlength="500"></textarea>
          <button id="requestBtn" class="request-btn" onclick="submitAccessRequest()">
            Request Access
          </button>
        </div>
        <div id="requestSuccess" class="alert-success" style="display: none;">
          <strong>Request Sent!</strong><br>
          The administrator has been notified. You'll receive an email once your access is approved.
        </div>
        <div id="requestError" class="alert-error" style="display: none;">
        </div>
      </div>
    </div>

    <div class="card-footer">
      <div class="logo">
        <!-- Grid icon -->
        <svg viewBox="0 0 24 24">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>MO-Viewer</span>
      </div>
      <span style="color: #999; font-size: 12px;">Internal team tool</span>
    </div>
  </div>

  <script>
    var userEmail = null;

    // Security: Escape HTML to prevent XSS
    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Get email from URL parameter
    function getUrlParam(name) {
      var url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // Validate email format
    function isValidEmail(email) {
      return email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Display the email from URL parameter
    userEmail = getUrlParam('email');
    if (userEmail) {
      document.getElementById('userEmail').textContent = decodeURIComponent(userEmail);
    } else {
      document.getElementById('userEmail').textContent = 'Unknown';
    }

    function submitAccessRequest() {
      var reason = document.getElementById('requestReason').value;
      var btn = document.getElementById('requestBtn');

      if (!userEmail) {
        var errorDiv = document.getElementById('requestError');
        errorDiv.textContent = 'Email address not available. Please go back and sign in again.';
        errorDiv.style.display = 'block';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Submitting...';

      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('requestForm').style.display = 'none';
          if (result.manualRequest) {
            // Show manual instructions if email couldn't be sent
            // Security: Escape user-controlled values to prevent XSS
            document.getElementById('requestSuccess').innerHTML =
              '<strong>Request Logged</strong><br>' +
              'Your request has been recorded. Please also contact the administrator directly:<br><br>' +
              '<strong>Email:</strong> ' + escapeHtml(result.adminEmail) + '<br>' +
              '<strong>Include:</strong> Your email (' + escapeHtml(userEmail) + ') and reason for access.';
          } else {
            document.getElementById('requestSuccess').innerHTML =
              '<strong>Request Sent!</strong><br>' +
              'The administrator has been notified. You\'ll receive an email once your access is approved.';
          }
          document.getElementById('requestSuccess').style.display = 'block';
        })
        .withFailureHandler(function(error) {
          btn.disabled = false;
          btn.textContent = 'Request Access';
          var errorDiv = document.getElementById('requestError');
          errorDiv.textContent = 'Could not send access request. Please try again.';
          errorDiv.style.display = 'block';
        })
        .submitAccessRequest(userEmail, reason);
    }
  </script>
</body>
</html>
