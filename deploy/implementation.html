<!-- Implementation-NSITE Viewer -->
<!-- Solution tracking dashboard for NSITE MO Implementation team -->

<div class="implementation-viewer">
  <!-- Top Row: Stats + MO Milestones + Document Administration -->
  <div class="dashboard-top-row">
    <!-- Stats Summary -->
    <div class="panel stats-panel">
      <div class="panel-header">
        <span class="material-icons">bar_chart</span>
        <span>Portfolio Overview</span>
      </div>
      <div class="stats-grid-compact" id="implementationStats">
        <div class="stat-item">
          <div class="stat-value" id="statTotalSolutions">--</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item stat-green">
          <div class="stat-value" id="statOperational">--</div>
          <div class="stat-label">Operational</div>
        </div>
        <div class="stat-item stat-blue">
          <div class="stat-value" id="statImplementation">--</div>
          <div class="stat-label">Implementation</div>
        </div>
        <div class="stat-item stat-orange">
          <div class="stat-value" id="statFormulation">--</div>
          <div class="stat-label">Formulation</div>
        </div>
      </div>
    </div>

    <!-- MO Milestones Panel -->
    <div class="panel milestones-panel">
      <div class="panel-header">
        <span class="material-icons">flag</span>
        <span>Implementation Milestones</span>
      </div>
      <div class="milestones-tracker">
        <div class="milestone-item" data-milestone="ATP">
          <span class="milestone-badge">ATP</span>
          <span class="milestone-label">Authority to Proceed DG</span>
          <span class="milestone-count" id="countATP">--</span>
        </div>
        <div class="milestone-item" data-milestone="F2I">
          <span class="milestone-badge">F2I</span>
          <span class="milestone-label">Formulation to Implementation DG</span>
          <span class="milestone-count" id="countF2I">--</span>
        </div>
        <div class="milestone-item" data-milestone="ORR">
          <span class="milestone-badge">ORR</span>
          <span class="milestone-label">Operational Readiness Review</span>
          <span class="milestone-count" id="countORR">--</span>
        </div>
        <div class="milestone-item" data-milestone="CLOSE">
          <span class="milestone-badge">CLOSE</span>
          <span class="milestone-label">Closeout DG</span>
          <span class="milestone-count" id="countCloseout">--</span>
        </div>
      </div>
    </div>

    <!-- Document Administration Panel -->
    <div class="panel docs-panel">
      <div class="panel-header">
        <span class="material-icons">description</span>
        <span>Document Administration</span>
      </div>
      <div class="docs-tracker" id="docsTracker">
        <div class="doc-item">
          <span class="doc-name">Project Plan</span>
          <span class="doc-status" id="docProjectPlan">--</span>
        </div>
        <div class="doc-item">
          <span class="doc-name">Science SOW</span>
          <span class="doc-status" id="docScienceSow">--</span>
        </div>
        <div class="doc-item">
          <span class="doc-name">IPA</span>
          <span class="doc-status" id="docIpa">--</span>
        </div>
        <div class="doc-item">
          <span class="doc-name">ICD</span>
          <span class="doc-status" id="docIcd">--</span>
        </div>
        <div class="doc-item">
          <span class="doc-name">TTA</span>
          <span class="doc-status" id="docTta">--</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <div class="filter-group solution-picker-group">
      <label class="filter-label">Solutions:</label>
      <button class="btn btn-secondary btn-sm solution-picker-btn" id="solutionPickerBtn" onclick="Implementation.toggleSolutionPicker()">
        <span id="solutionPickerLabel"><span class="loading-spinner" style="width:14px;height:14px;border-width:2px;vertical-align:middle;margin-right:4px;"></span> Loading...</span>
        <span class="material-icons">expand_more</span>
      </button>
      <div class="solution-picker-dropdown" id="solutionPickerDropdown">
        <div class="picker-actions">
          <button class="picker-action-btn" onclick="Implementation.selectActiveSolutions()">Default</button>
          <button class="picker-action-btn" onclick="Implementation.selectAllSolutions()">All</button>
          <button class="picker-action-btn" onclick="Implementation.clearSolutionSelection()">None</button>
        </div>
        <div class="picker-section">
          <div class="picker-section-header">Default Selection</div>
          <div class="picker-list" id="activePickerList"></div>
        </div>
        <div class="picker-section">
          <div class="picker-section-header">Other Solutions</div>
          <div class="picker-list" id="otherPickerList"></div>
        </div>
      </div>
    </div>
    <div class="filter-group">
      <label class="filter-label">Cycle:</label>
      <select class="form-select filter-select" id="filterCycle" onchange="Implementation.applyFilters()">
        <option value="">All Cycles</option>
        <option value="1">C1 (2016)</option>
        <option value="2">C2 (2018)</option>
        <option value="3">C3 (2020)</option>
        <option value="4">C4 (2022)</option>
        <option value="5">C5 (2024)</option>
        <option value="6">C6 (2026)</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Phase:</label>
      <select class="form-select filter-select" id="filterPhase" onchange="Implementation.applyFilters()">
        <option value="">All Phases</option>
        <option value="Pre-Formulation">Pre-Formulation</option>
        <option value="Formulation">Formulation</option>
        <option value="Implementation">Implementation</option>
        <option value="Production / Operational">Production / Operational</option>
        <option value="Completed">Completed</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Group:</label>
      <select class="form-select filter-select" id="filterGroup" onchange="Implementation.applyFilters()">
        <option value="">All Groups</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">DAAC:</label>
      <select class="form-select filter-select" id="filterDAAC" onchange="Implementation.applyFilters()">
        <option value="">All DAACs</option>
      </select>
    </div>
    <div class="filter-search">
      <span class="material-icons">search</span>
      <input type="text" class="form-input search-input" id="filterSearch"
             placeholder="Search solutions..."
             oninput="Implementation.applyFilters()">
    </div>
    <button class="btn btn-secondary btn-sm" onclick="Implementation.clearFilters()">
      Clear
    </button>
  </div>

  <!-- Solutions by Cycle -->
  <div class="solutions-container" id="solutionsContainer">
    <div class="loading-state">
      <span class="loading-spinner"></span>
      <p>Loading solutions...</p>
    </div>
  </div>
</div>

<!-- Solution Detail Modal -->
<div class="modal-overlay" id="solutionModal" role="dialog" aria-modal="true" aria-labelledby="solutionModalTitle" onclick="Implementation.closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="solutionModalTitle">Solution Details</h2>
      <button class="modal-close" onclick="Implementation.closeModal()" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Dynamic content -->
    </div>
  </div>
</div>

<!-- Team Folder Upload Dialog -->
<div class="modal-overlay" id="uploadModal" role="dialog" aria-modal="true" aria-labelledby="uploadModalTitle" onclick="Implementation.closeUploadModal(event)">
  <div class="modal-content upload-modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="uploadModalTitle">
        <span class="material-icons">upload_file</span>
        Share with Implementation Team
      </h2>
      <button class="modal-close" onclick="Implementation.closeUploadModal()" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body">
      <p class="upload-description">
        Upload files to share with the <strong id="uploadSolutionName">--</strong> implementation team.
        Files will be added to the team's shared Google Drive folder.
      </p>

      <div class="upload-dropzone" id="uploadDropzone">
        <div class="dropzone-content">
          <span class="material-icons dropzone-icon">cloud_upload</span>
          <p class="dropzone-text">Drag and drop files here</p>
          <p class="dropzone-subtext">or</p>
          <label class="btn btn-secondary dropzone-btn">
            <span class="material-icons">folder_open</span>
            Browse Files
            <input type="file" id="fileInput" multiple style="display: none;" onchange="Implementation.handleFileSelect(event)">
          </label>
        </div>
        <div class="dropzone-drag-active">
          <span class="material-icons">file_download</span>
          <p>Drop files to upload</p>
        </div>
      </div>

      <div class="upload-file-list" id="uploadFileList" style="display: none;">
        <div class="file-list-header">
          <span>Files to upload</span>
          <button class="btn btn-sm btn-text" onclick="Implementation.clearUploadFiles()">Clear all</button>
        </div>
        <div class="file-list-items" id="fileListItems"></div>
      </div>

      <div class="upload-status" id="uploadStatus" style="display: none;">
        <div class="upload-progress">
          <div class="upload-progress-bar" id="uploadProgressBar"></div>
        </div>
        <p class="upload-status-text" id="uploadStatusText">Uploading...</p>
      </div>

      <div class="upload-success" id="uploadSuccess" style="display: none;">
        <span class="material-icons success-icon">check_circle</span>
        <p class="success-text">Files uploaded successfully!</p>
        <p class="success-subtext">The team has been notified via email.</p>
      </div>

      <div class="upload-error" id="uploadError" style="display: none;">
        <span class="material-icons error-icon">error</span>
        <p class="error-text" id="uploadErrorText">Upload failed</p>
      </div>

      <div class="upload-actions">
        <a href="#" target="_blank" id="openDriveLink" class="btn btn-secondary">
          <span class="material-icons">folder_open</span>
          Open in Drive
        </a>
        <button class="btn btn-primary" id="uploadBtn" onclick="Implementation.uploadFiles()" disabled>
          <span class="material-icons">cloud_upload</span>
          <span id="uploadBtnText">Upload Files</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Contact Detail Modal -->
<div class="modal-overlay" id="contactDetailModal" role="dialog" aria-modal="true" aria-labelledby="contactDetailModalTitle" onclick="Implementation.closeContactModal(event)">
  <div class="modal-content" style="max-width: 480px;" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title" id="contactDetailModalTitle">Contact Details</h2>
      <button class="modal-close" onclick="Implementation.closeContactModal()" aria-label="Close dialog">&times;</button>
    </div>
    <div class="modal-body" id="contactModalBody">
      <div class="loading-state"><span class="loading-spinner"></span> Looking up contact...</div>
    </div>
  </div>
</div>

<!-- Implementation-NSITE Styles -->
<style>
  /* Page accent color for shared styles */
  .implementation-viewer {
    --page-accent: var(--color-implementation);
    max-width: 1600px;
    margin: 0 auto;
  }

  .clickable-name {
    color: var(--page-accent);
    cursor: pointer;
    text-decoration: underline;
  }
  .clickable-name:hover {
    opacity: 0.8;
  }

  /* Dashboard Top Row */
  .dashboard-top-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
  }

  /* Implementation-specific panel header (icon + label layout) */
  .implementation-viewer .panel-header {
    justify-content: flex-start;
    gap: var(--space-sm);
    font-weight: 600;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .implementation-viewer .panel-header svg { width: 16px; height: 16px; }

  /* Stats Panel */
  .stats-panel { border-top: 3px solid var(--color-implementation); }

  .stats-grid-compact {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    padding: var(--space-md);
    gap: var(--space-sm);
  }

  .stat-item {
    text-align: center;
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    background: var(--color-surface-alt);
  }

  .stat-item .stat-value { font-size: var(--font-size-xl); font-weight: 700; color: var(--color-text); }
  .stat-item .stat-label { font-size: var(--font-size-xs); color: var(--color-text-secondary); }
  .stat-item.stat-green .stat-value { color: var(--color-success); }
  .stat-item.stat-blue .stat-value { color: var(--color-info); }
  .stat-item.stat-orange .stat-value { color: var(--color-warning); }

  /* Milestones Panel */
  .milestones-panel { border-top: 3px solid var(--color-phase-operations); }

  .milestones-tracker {
    display: flex;
    flex-direction: column;
    padding: var(--space-sm);
    gap: var(--space-xs);
  }

  .milestone-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xs) var(--space-sm);
    background: rgba(16, 185, 129, 0.08);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--color-phase-operations);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .milestone-item:hover { background: rgba(16, 185, 129, 0.15); transform: translateX(2px); }

  .milestone-badge {
    font-family: monospace;
    font-size: var(--font-size-xs);
    font-weight: 700;
    color: var(--color-phase-operations);
    background: rgba(16, 185, 129, 0.2);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    min-width: 32px;
    text-align: center;
  }

  .milestone-label { flex: 1; font-size: var(--font-size-sm); color: var(--color-text-secondary); }
  .milestone-count { font-size: var(--font-size-sm); font-weight: 600; color: var(--color-phase-operations); }

  /* Document Administration Panel */
  .docs-panel { border-top: 3px solid var(--color-warning); }

  .docs-tracker {
    display: flex;
    flex-direction: column;
    padding: var(--space-sm);
    gap: var(--space-xs);
  }

  .doc-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
  }

  .doc-name { font-size: var(--font-size-sm); color: var(--color-text); }

  .doc-status {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
    background: var(--color-surface);
    color: var(--color-text-muted);
  }

  .doc-status.status-complete { background: rgba(16, 185, 129, 0.15); color: var(--color-phase-operations); }
  .doc-status.status-in-work { background: rgba(249, 115, 22, 0.15); color: var(--color-phase-formulation); }
  .doc-status.status-not-started { background: var(--color-surface); color: var(--color-text-muted); }

  /* Document Status Grid (modal) */
  .doc-status-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-sm);
  }
  @media (max-width: 768px) {
    .doc-status-grid { grid-template-columns: repeat(2, 1fr); }
  }

  .doc-status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
  }

  .doc-status-label {
    font-size: var(--font-size-sm);
    color: var(--color-text);
  }

  .doc-badge {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
  }

  .doc-badge-complete { background: rgba(16, 185, 129, 0.15); color: var(--color-phase-operations); }
  .doc-badge-in-work { background: rgba(249, 115, 22, 0.15); color: var(--color-phase-formulation); }
  .doc-badge-not-started { background: var(--color-surface); color: var(--color-text-muted); }

  .doc-link-badge {
    display: inline-flex;
    align-items: center;
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
    background: rgba(16, 185, 129, 0.15);
    color: var(--color-phase-operations);
    text-decoration: none;
    transition: background 0.2s;
  }
  .doc-link-badge:hover { background: rgba(16, 185, 129, 0.25); }

  /* Alignment Assessment Grid */
  .alignment-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-xs);
  }
  .alignment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }
  .alignment-badge {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
  }
  .alignment-badge-acceptable { background: rgba(16, 185, 129, 0.15); color: var(--color-phase-operations); }
  .alignment-badge-gap { background: rgba(239, 68, 68, 0.15); color: var(--color-danger-light); }
  .alignment-badge-na { background: var(--color-surface); color: var(--color-text-muted); }

  /* Collapsible section toggle */
  .section-toggle {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    user-select: none;
  }
  .section-toggle .material-icons {
    transition: transform 0.2s;
    font-size: 18px;
  }
  .section-toggle.collapsed .material-icons { transform: rotate(-90deg); }
  .section-collapsible { overflow: hidden; transition: max-height 0.3s ease; }
  .section-collapsible.collapsed { max-height: 0; margin: 0; padding: 0; }

  /* Tracking Summary Row */
  .tracking-summary-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .tracking-card {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-fast);
    cursor: pointer;
  }

  .tracking-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }

  .tracking-icon { width: 24px; height: 24px; color: var(--color-text-muted); }
  .tracking-info { flex: 1; }
  .tracking-title { display: block; font-weight: 600; font-size: var(--font-size-sm); color: var(--color-text); }
  .tracking-subtitle { display: block; font-size: var(--font-size-xs); color: var(--color-text-muted); }
  .tracking-value { font-size: var(--font-size-lg); font-weight: 700; color: var(--color-primary); }

  /* Filter Bar */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
  }

  .filter-group { display: flex; align-items: center; gap: var(--space-sm); }
  .filter-label { font-size: var(--font-size-sm); font-weight: 500; color: var(--color-text-secondary); }
  .filter-select { min-width: 120px; padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-sm); }
  .filter-search { flex: 1; min-width: 200px; position: relative; }
  .filter-search .search-icon { position: absolute; left: var(--space-sm); top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--color-text-muted); }
  .filter-search .search-input { padding-left: 36px; width: 100%; }

  /* Solution Picker */
  .solution-picker-group { position: relative; }
  .solution-picker-btn { display: flex; align-items: center; gap: var(--space-xs); min-width: 160px; justify-content: space-between; }
  .solution-picker-btn .picker-chevron { width: 14px; height: 14px; transition: transform var(--transition-fast); }
  .solution-picker-btn.active .picker-chevron { transform: rotate(180deg); }

  .solution-picker-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 100;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    min-width: 280px;
    max-height: 400px;
    overflow-y: auto;
    display: none;
    margin-top: var(--space-xs);
  }

  .solution-picker-dropdown.active { display: block; }

  .picker-actions {
    display: flex;
    gap: var(--space-xs);
    padding: var(--space-sm);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
    position: sticky;
    top: 0;
  }

  .picker-action-btn {
    flex: 1;
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-xs);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .picker-action-btn:hover { background: var(--color-primary); color: white; border-color: var(--color-primary); }

  .picker-section { padding: var(--space-xs) 0; }

  .picker-section-header {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--color-surface-alt);
    border-bottom: 1px solid var(--color-border-light);
  }

  .picker-list { display: flex; flex-direction: column; }

  .picker-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xs) var(--space-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .picker-item:hover { background: var(--color-surface-alt); }

  .picker-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--color-primary);
  }

  .picker-item-label {
    flex: 1;
    font-size: var(--font-size-sm);
    color: var(--color-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .picker-item-cycle {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    padding: 1px 6px;
    background: var(--color-surface-alt);
    border-radius: 10px;
  }

  /* Cycle Sections */
  .cycle-section { margin-bottom: var(--space-lg); }

  .cycle-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    margin-bottom: var(--space-md);
    transition: background var(--transition-fast);
  }

  .cycle-header:hover { background: var(--color-surface-alt); }
  .cycle-header .chevron { width: 20px; height: 20px; transition: transform var(--transition-fast); }
  .cycle-header.collapsed .chevron { transform: rotate(-90deg); }
  .cycle-badge { padding: 4px 10px; font-size: var(--font-size-sm); font-weight: 700; border-radius: var(--radius-sm); }
  .badge-c1 { background: #fee2e2; color: #991b1b; }
  .badge-c2 { background: #fef3c7; color: #92400e; }
  .badge-c3 { background: #d1fae5; color: #065f46; }
  .badge-c4 { background: #dbeafe; color: #1e40af; }
  .badge-c5 { background: #e0e7ff; color: #3730a3; }
  .badge-c6 { background: #f3e8ff; color: #6b21a8; border: 1px dashed #6b21a8; }
  .cycle-title { font-size: var(--font-size-lg); font-weight: 600; color: var(--color-text); }
  .cycle-count { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-left: auto; }
  .cycle-solutions { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: var(--space-md); }
  .cycle-solutions.collapsed { display: none; }

  /* Solution Cards */
  .solution-card {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    padding: var(--space-md);
    display: flex;
    flex-direction: column;
    transition: box-shadow var(--transition-fast), transform var(--transition-fast);
    border-left: 4px solid var(--color-border);
  }

  .solution-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
  .solution-card.phase-operational { border-left-color: var(--color-phase-operations); }
  .solution-card.phase-implementation { border-left-color: var(--color-phase-implementation); }
  .solution-card.phase-formulation { border-left-color: var(--color-phase-formulation); }
  .solution-card.phase-pre-formulation { border-left-color: var(--color-phase-pre-formulation); }

  .solution-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-sm); }
  .solution-name { font-weight: 600; font-size: var(--font-size-md); color: var(--color-text); cursor: pointer; }
  .solution-name:hover { color: var(--color-implementation); }
  .solution-id { font-size: var(--font-size-xs); color: var(--color-text-muted); font-family: monospace; }

  .solution-badges { display: flex; gap: var(--space-xs); flex-wrap: wrap; }
  .phase-badge { padding: 2px 8px; font-size: var(--font-size-xs); font-weight: 500; border-radius: 12px; white-space: nowrap; }
  .phase-pre-formulation { background: #fef9c3; color: #a16207; }
  .phase-formulation { background: #ffedd5; color: #c2410c; }
  .phase-implementation { background: #dbeafe; color: #1d4ed8; }
  .phase-operational { background: #dcfce7; color: #15803d; }
  .phase-completed { background: #f1f5f9; color: var(--color-phase-completed); }

  .solution-meta { display: flex; gap: var(--space-md); font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-sm); flex-wrap: wrap; }
  .solution-meta-item { display: flex; align-items: center; gap: var(--space-xs); }
  .solution-meta-item svg { width: 14px; height: 14px; }

  .solution-lead { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-sm); }
  .solution-lead strong { color: var(--color-text); }

  .solution-tracking {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
    margin-bottom: var(--space-sm);
  }

  .tracking-tag {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    background: var(--color-surface-alt);
  }

  .tracking-tag svg { width: 12px; height: 12px; }
  .tracking-tag.tag-daac { background: rgba(139, 92, 246, 0.1); color: #7c3aed; }
  .tracking-tag.tag-milestone { background: rgba(16, 185, 129, 0.1); color: #059669; }
  .tracking-tag.tag-deepdive { background: rgba(59, 130, 246, 0.1); color: #2563eb; }

  .solution-status { font-size: var(--font-size-sm); color: var(--color-text-secondary); flex: 1; margin-bottom: var(--space-sm); line-height: 1.4; max-height: 3.6em; overflow: hidden; }

  .solution-actions { display: flex; gap: var(--space-sm); margin-top: auto; padding-top: var(--space-sm); border-top: 1px solid var(--color-border-light); flex-wrap: wrap; }
  .solution-action-btn { display: flex; align-items: center; gap: var(--space-xs); padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-xs); color: var(--color-text-secondary); background: var(--color-surface-alt); border-radius: var(--radius-sm); cursor: pointer; transition: all var(--transition-fast); text-decoration: none; border: none; }
  .solution-action-btn:hover { background: var(--color-primary); color: white; }
  .solution-action-btn svg { width: 14px; height: 14px; }

  /* Modal */
  .modal-content { max-width: 800px; }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
  }

  .modal-title { font-size: var(--font-size-lg); font-weight: 600; color: var(--color-text); margin: 0; }
  .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-muted); padding: 0; line-height: 1; }
  .modal-close:hover { color: var(--color-text); }
  .modal-body { padding: var(--space-lg); overflow-y: auto; }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-lg);
  }

  .detail-section { margin-bottom: var(--space-md); }
  .detail-section:last-child { margin-bottom: 0; }
  .detail-section-title { font-size: var(--font-size-sm); font-weight: 600; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-sm); border-bottom: 1px solid var(--color-border-light); padding-bottom: var(--space-xs); }
  .detail-row { display: flex; justify-content: space-between; padding: var(--space-xs) 0; font-size: var(--font-size-sm); }
  .detail-label { color: var(--color-text-secondary); }
  .detail-value { color: var(--color-text); font-weight: 500; text-align: right; }
  .detail-text { font-size: var(--font-size-sm); color: var(--color-text); line-height: 1.6; }

  /* Stakeholder Styles */
  .stakeholder-summary {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
    margin-bottom: var(--space-md);
  }

  .stakeholder-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    min-width: 80px;
  }

  .stakeholder-stat .stat-number {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--color-primary);
  }

  .stakeholder-stat .stat-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    text-align: center;
  }

  .sme-list, .dept-list {
    font-size: var(--font-size-sm);
    color: var(--color-text);
    margin-bottom: var(--space-sm);
    line-height: 1.6;
  }

  .sme-link {
    color: var(--color-primary);
    text-decoration: none;
  }

  .sme-link:hover {
    text-decoration: underline;
  }

  .empty-stakeholders {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    font-style: italic;
    padding: var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    text-align: center;
  }


  /* Updates Styles */
  .updates-summary {
    display: flex;
    gap: var(--space-md);
    align-items: center;
    margin-bottom: var(--space-md);
    font-size: var(--font-size-sm);
  }

  .updates-count {
    color: var(--color-text-secondary);
  }

  .updates-recent-badge {
    background: var(--color-primary);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: var(--font-size-xs);
    font-weight: 500;
  }

  .updates-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .updates-extended.collapsed {
    display: none;
  }

  .update-item {
    display: grid;
    grid-template-columns: 90px 1fr;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--color-primary);
    font-size: var(--font-size-sm);
  }

  .update-date {
    color: var(--color-text-secondary);
    font-weight: 500;
    font-size: var(--font-size-xs);
  }

  .update-content {
    color: var(--color-text-primary);
    line-height: 1.5;
  }

  .update-source {
    grid-column: 1 / -1;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-xs);
    padding-top: var(--space-xs);
    border-top: 1px solid var(--color-border);
  }

  .updates-see-more-btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    background: none;
    border: 1px dashed var(--color-border);
    color: var(--color-primary);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: var(--font-size-sm);
    width: 100%;
    justify-content: center;
    margin: var(--space-md) 0;
    transition: all 0.2s;
  }

  .updates-see-more-btn:hover {
    background: var(--color-surface-alt);
    border-color: var(--color-primary);
  }

  .updates-see-more-btn .see-more-icon {
    width: 16px;
    height: 16px;
    transition: transform 0.2s;
  }

  .updates-empty-recent {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    font-style: italic;
    padding: var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    text-align: center;
  }

  .empty-updates {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    font-style: italic;
    padding: var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    text-align: center;
  }

  .updates-historical-note {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  .updates-historical-note svg {
    width: 14px;
    height: 14px;
    opacity: 0.7;
  }

  .updates-historical-note a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .updates-historical-note a:hover {
    text-decoration: underline;
  }

  /* Recent Activity Styles */
  .activity-summary {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
    font-size: var(--font-size-sm);
  }

  .activity-count {
    color: var(--color-text-secondary);
    font-weight: 500;
  }

  .activity-sources {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .activity-source-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: var(--font-size-xs);
    font-weight: 500;
    background: var(--color-surface-alt);
    color: var(--color-text-secondary);
  }

  .activity-source-badge .material-icons {
    font-size: 12px;
  }

  .activity-source-updates { background: #e3f2fd; color: var(--color-sep); }
  .activity-source-engagements { background: #e8f5e9; color: var(--color-success); }
  .activity-source-actions { background: #fff3e0; color: var(--color-actions); }
  .activity-source-stories { background: #f3e5f5; color: var(--color-comms); }
  .activity-source-milestones { background: #fce4ec; color: var(--color-milestones); }

  .activity-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .activity-item {
    display: grid;
    grid-template-columns: 32px 1fr;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--color-text-muted);
    font-size: var(--font-size-sm);
  }

  .activity-item.clickable {
    grid-template-columns: 32px 1fr 24px;
    transition: background 0.15s;
  }

  .activity-type-update { border-left-color: var(--color-sep); }
  .activity-type-engagement { border-left-color: var(--color-success); }
  .activity-type-action { border-left-color: var(--color-actions); }
  .activity-type-story { border-left-color: var(--color-comms); }
  .activity-type-milestone { border-left-color: var(--color-milestones); }

  .activity-icon {
    display: flex;
    align-items: flex-start;
    padding-top: 2px;
  }

  .activity-icon .material-icons {
    font-size: 18px;
    opacity: 0.7;
  }

  .activity-type-update .activity-icon .material-icons { color: var(--color-sep); }
  .activity-type-engagement .activity-icon .material-icons { color: var(--color-success); }
  .activity-type-action .activity-icon .material-icons { color: var(--color-actions); }
  .activity-type-story .activity-icon .material-icons { color: var(--color-comms); }
  .activity-type-milestone .activity-icon .material-icons { color: var(--color-milestones); }

  .activity-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .activity-date {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  .activity-title {
    font-weight: 500;
    color: var(--color-text-primary);
  }

  .activity-description {
    color: var(--color-text-secondary);
    line-height: 1.4;
    font-size: var(--font-size-xs);
  }

  .see-more-link {
    color: var(--color-implementation);
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
  }

  .see-more-link:hover {
    text-decoration: underline;
  }

  .activity-meta {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: 4px;
  }

  .activity-meta .material-icons {
    font-size: 12px;
  }

  .activity-status-done {
    color: var(--color-success);
  }

  .activity-status-open {
    color: var(--color-warning);
  }

  .activity-more-note {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  .activity-more-note .material-icons {
    font-size: 14px;
    opacity: 0.7;
  }

  .activity-more-note a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .activity-more-note a:hover {
    text-decoration: underline;
  }

  .empty-activity {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    font-style: italic;
    padding: var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    text-align: center;
  }

  /* Status Summary Collapsible Styles */
  .status-summary-wrapper {
    position: relative;
  }

  .status-full.collapsed {
    display: none;
  }

  .status-see-more-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    background: none;
    border: none;
    color: var(--color-primary);
    padding: var(--space-xs) 0;
    cursor: pointer;
    font-size: var(--font-size-sm);
    margin-top: var(--space-xs);
  }

  .status-see-more-btn:hover {
    text-decoration: underline;
  }

  .status-see-more-btn .see-more-icon {
    width: 14px;
    height: 14px;
  }

  /* Milestone Styles */
  .milestone-summary {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
    margin-bottom: var(--space-md);
  }

  .milestone-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    min-width: 80px;
  }

  .milestone-stat .stat-number {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--color-success);
  }

  .milestone-stat .stat-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    text-align: center;
  }

  .milestone-stat.milestone-overdue .stat-number {
    color: var(--color-error);
  }

  .next-milestone {
    font-size: var(--font-size-sm);
    padding: var(--space-sm) var(--space-md);
    background: rgba(59, 130, 246, 0.1);
    border-left: 3px solid var(--color-primary);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-md);
  }

  .milestone-date {
    color: var(--color-text-secondary);
    font-size: var(--font-size-xs);
  }

  .milestone-timeline {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .milestone-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }

  .milestone-item .milestone-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .milestone-item .milestone-type {
    flex: 1;
  }

  .milestone-item.milestone-completed {
    color: var(--color-success);
    background: rgba(16, 185, 129, 0.05);
  }

  .milestone-item.milestone-planned {
    color: var(--color-primary);
    background: rgba(59, 130, 246, 0.05);
  }

  .milestone-item.milestone-not_started {
    color: var(--color-text-muted);
    background: var(--color-surface-alt);
  }

  .empty-milestones {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    font-style: italic;
    padding: var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    text-align: center;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .dashboard-top-row { grid-template-columns: 1fr 1fr; }
    .docs-panel { grid-column: span 2; }
    .tracking-summary-row { grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 768px) {
    .page-header { flex-direction: column; gap: var(--space-md); }
    .page-actions { width: 100%; }
    .page-actions .btn { flex: 1; }
    .dashboard-top-row { grid-template-columns: 1fr; }
    .docs-panel { grid-column: span 1; }
    .stats-grid-compact { grid-template-columns: repeat(2, 1fr); }
    .tracking-summary-row { grid-template-columns: 1fr; }
    .filter-bar { flex-direction: column; align-items: stretch; }
    .filter-group { justify-content: space-between; }
    .cycle-solutions { grid-template-columns: 1fr; }
    .detail-grid { grid-template-columns: 1fr; }
  }

  /* Modal Loading */
  .modal-loading-simple {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-xxl);
    min-height: 200px;
  }

  .modal-loading-simple p {
    margin-top: var(--space-lg);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }

  .modal-loading-simple .loading-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Section Loading (for incremental loading in modals) */
  .section-loading {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }

  .loading-spinner-sm {
    width: 16px;
    height: 16px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
  }

  /* Progress Tracker for Modal Loading */
  .loading-progress-tracker {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs) var(--space-md);
    padding: var(--space-sm) var(--space-md);
    margin-bottom: var(--space-md);
    background: var(--color-surface-alt);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
  }

  .progress-step {
    display: flex;
    align-items: center;
    gap: 4px;
    color: var(--color-text-secondary);
    transition: color 0.2s ease;
  }

  .progress-step .material-icons {
    font-size: 16px;
  }

  .progress-step.loading .material-icons {
    color: var(--color-primary);
    animation: pulse 1s ease-in-out infinite;
  }

  .progress-step.complete {
    color: var(--color-success);
  }

  .progress-step.complete .material-icons {
    color: var(--color-success);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .loading-progress-tracker.all-complete {
    background: rgba(46, 125, 50, 0.08);
    animation: fadeOut 0.5s ease-in-out 1s forwards;
  }

  @keyframes fadeOut {
    to { opacity: 0; height: 0; padding: 0; margin: 0; overflow: hidden; }
  }

  /* Upload Modal Styles */
  .upload-modal-content {
    max-width: 520px;
  }

  .upload-modal-content .modal-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .upload-modal-content .modal-title .material-icons {
    color: var(--color-primary);
  }

  .upload-description {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-lg);
    line-height: 1.5;
  }

  .upload-dropzone {
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-xl);
    text-align: center;
    transition: all 0.2s;
    position: relative;
    background: var(--color-surface-alt);
  }

  .upload-dropzone:hover {
    border-color: var(--color-primary);
    background: rgba(11, 61, 145, 0.02);
  }

  .upload-dropzone.drag-active {
    border-color: var(--color-primary);
    background: rgba(11, 61, 145, 0.05);
  }

  .upload-dropzone.drag-active .dropzone-content {
    display: none;
  }

  .upload-dropzone.drag-active .dropzone-drag-active {
    display: flex;
  }

  .dropzone-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
  }

  .dropzone-drag-active {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    color: var(--color-primary);
  }

  .dropzone-drag-active .material-icons {
    font-size: 48px;
    animation: bounce 0.5s infinite alternate;
  }

  @keyframes bounce {
    from { transform: translateY(0); }
    to { transform: translateY(-8px); }
  }

  .dropzone-icon {
    font-size: 48px;
    color: var(--color-text-muted);
  }

  .dropzone-text {
    font-size: var(--font-size-md);
    font-weight: 500;
    color: var(--color-text);
    margin: 0;
  }

  .dropzone-subtext {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin: 0;
  }

  .dropzone-btn {
    margin-top: var(--space-sm);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .upload-file-list {
    margin-top: var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .file-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    border-bottom: 1px solid var(--color-border);
    font-size: var(--font-size-sm);
    font-weight: 500;
  }

  .file-list-items {
    max-height: 150px;
    overflow-y: auto;
  }

  .file-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--color-border-light);
    font-size: var(--font-size-sm);
  }

  .file-item:last-child {
    border-bottom: none;
  }

  .file-item .material-icons {
    color: var(--color-text-muted);
    font-size: 18px;
  }

  .file-item-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .file-item-size {
    color: var(--color-text-muted);
    font-size: var(--font-size-xs);
  }

  .file-item-remove {
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px;
    color: var(--color-text-muted);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .file-item-remove:hover {
    background: var(--color-error-light);
    color: var(--color-error);
  }

  .upload-status {
    margin-top: var(--space-md);
    text-align: center;
  }

  .upload-progress {
    height: 6px;
    background: var(--color-surface-alt);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: var(--space-sm);
  }

  .upload-progress-bar {
    height: 100%;
    background: var(--color-primary);
    border-radius: 3px;
    width: 0%;
    transition: width 0.3s;
  }

  .upload-status-text {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .upload-success {
    margin-top: var(--space-md);
    text-align: center;
    padding: var(--space-lg);
    background: rgba(16, 185, 129, 0.1);
    border-radius: var(--radius-md);
  }

  .upload-success .success-icon {
    font-size: 48px;
    color: var(--color-success);
  }

  .upload-success .success-text {
    font-size: var(--font-size-md);
    font-weight: 500;
    color: var(--color-success);
    margin: var(--space-sm) 0 0;
  }

  .upload-success .success-subtext {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: var(--space-xs) 0 0;
  }

  .upload-error {
    margin-top: var(--space-md);
    text-align: center;
    padding: var(--space-lg);
    background: rgba(211, 47, 47, 0.1);
    border-radius: var(--radius-md);
  }

  .upload-error .error-icon {
    font-size: 48px;
    color: var(--color-error);
  }

  .upload-error .error-text {
    font-size: var(--font-size-sm);
    color: var(--color-error);
    margin: var(--space-sm) 0 0;
  }

  .upload-actions {
    display: flex;
    justify-content: space-between;
    gap: var(--space-md);
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border-light);
  }

  .upload-actions .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .share-team-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-xs);
    color: white;
    background: var(--color-primary);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .share-team-btn:hover {
    background: var(--color-primary-dark);
  }

  .share-team-btn .material-icons {
    font-size: 14px;
  }
</style>

<!-- Implementation-NSITE JavaScript -->
<script>
var Implementation = (function() {
  var state = {
    solutions: [],
    filteredSolutions: [],
    groups: [],
    daacs: [],
    collapsedCycles: {},
    selectedSolutions: {} // Track which solutions are selected by solution_id
  };

  /**
   * Check if solution should be shown in default selection.
   * Uses the 'show_in_default' column from MO-DB_Solutions.
   * Values: 'Y' or 'y' = show in default, anything else = don't show
   */
  function isActivelyManaged(sol) {
    var value = (sol.admin_default_in_dashboard || '').toString().trim().toUpperCase();
    return value === 'Y';
  }

  /**
   * Get the primary/parent solution ID from a solution_id.
   * e.g., 'hls_vi' -> 'hls', 'opera_dswx' -> 'opera', 'nisar' -> 'nisar'
   */
  function getPrimarySolutionId(solutionId) {
    if (!solutionId) return null;
    var parts = solutionId.split('_');
    return parts[0]; // Return the part before the first underscore
  }

  /**
   * Check if a solution is selected, either directly or via its parent group.
   * If 'hls' is selected, 'hls_vi' and 'hls_ll' are also considered selected.
   */
  function isSolutionSelectedWithGrouping(solutionId) {
    // Check if directly selected
    if (state.selectedSolutions[solutionId]) return true;

    // Check if parent is selected (for subprojects)
    var primaryId = getPrimarySolutionId(solutionId);
    if (primaryId && primaryId !== solutionId && state.selectedSolutions[primaryId]) {
      return true;
    }

    return false;
  }

  function init() {
    // Capture navigation ID to detect if user navigates away during load
    var navId = getNavigationId();
    loadSolutions(navId);
  }

  function loadSolutions(navId) {
    // Use CachedAPI for solutions (60 min TTL, shared across pages)
    CachedAPI.getSolutions()
      .then(function(solutions) {
        // Abandon if user navigated away
        if (navId && !isNavigationCurrent(navId)) {
          console.log('[Implementation] Abandoning load - user navigated away');
          return;
        }

        state.solutions = solutions || [];
        extractFilters();
        updateStats();
        updateMilestones();
        updateTrackingStats();
        applyFilters();

        // Check if navigating from Top Sheet with a solution to open
        var openSolutionId = sessionStorage.getItem('openSolutionId');
        if (openSolutionId) {
          sessionStorage.removeItem('openSolutionId');
          // Find and open the solution
          var sol = state.solutions.find(function(s) {
            return s.solution_id && s.solution_id.toLowerCase() === openSolutionId.toLowerCase();
          });
          if (sol) {
            setTimeout(function() { openDetailModal(sol.solution_id); }, 100);
          }
        }
      })
      .catch(function(error) {
        if (navId && !isNavigationCurrent(navId)) return;
        console.error('FAILURE: Failed to load solutions:', error);
        showError('Failed to load solutions. Please try again.');
      });
  }

  function extractFilters() {
    var groups = {}, daacs = {};
    state.solutions.forEach(function(sol) {
      if (sol.core_group && sol.core_group.trim()) {
        groups[sol.core_group.trim()] = true;
      }
      if (sol.product_assigned_daac && sol.product_assigned_daac.trim()) {
        daacs[sol.product_assigned_daac.trim()] = true;
      }
    });
    state.groups = Object.keys(groups).sort();
    state.daacs = Object.keys(daacs).sort();
    populateFilterDropdowns();
    populateSolutionPicker();
    // Select actively managed by default
    selectActiveSolutions();
  }

  function populateFilterDropdowns() {
    // Guard against SPA navigation - elements may not exist
    var groupSelect = document.getElementById('filterGroup');
    var daacSelect = document.getElementById('filterDAAC');

    if (!groupSelect || !daacSelect) return;

    // Groups
    groupSelect.innerHTML = '<option value="">All Groups</option>';
    state.groups.forEach(function(group) {
      var option = document.createElement('option');
      option.value = group;
      option.textContent = group;
      groupSelect.appendChild(option);
    });

    // DAACs
    daacSelect.innerHTML = '<option value="">All DAACs</option>';
    state.daacs.forEach(function(daac) {
      var option = document.createElement('option');
      option.value = daac;
      option.textContent = daac;
      daacSelect.appendChild(option);
    });
  }

  function populateSolutionPicker() {
    var activeList = document.getElementById('activePickerList');
    var otherList = document.getElementById('otherPickerList');

    // Guard against SPA navigation - elements may not exist
    if (!activeList || !otherList) {
      // SPA navigation - elements no longer exist
      return;
    }

    activeList.innerHTML = '';
    otherList.innerHTML = '';

    // Sort solutions by ID - filter out invalid entries first
    var validSolutions = state.solutions.filter(function(s) { return s && s.solution_id; });
    var sortedSolutions = validSolutions.sort(function(a, b) {
      return (a.solution_id || '').localeCompare(b.solution_id || '');
    });

    sortedSolutions.forEach(function(sol) {
      var isActive = isActivelyManaged(sol);
      var html = '<label class="picker-item">';
      html += '<input type="checkbox" id="picker_' + sol.solution_id + '" onchange="Implementation.onSolutionToggle(\'' + sol.solution_id + '\')">';
      html += '<span class="picker-item-label">' + escapeHtml((sol.solution_id || '').toUpperCase()) + '</span>';
      html += '<span class="picker-item-cycle">C' + sol.core_cycle + '</span>';
      html += '</label>';

      if (isActive) {
        activeList.innerHTML += html;
      } else {
        otherList.innerHTML += html;
      }
    });
  }

  function toggleSolutionPicker() {
    var dropdown = document.getElementById('solutionPickerDropdown');
    var btn = document.getElementById('solutionPickerBtn');
    dropdown.classList.toggle('active');
    btn.classList.toggle('active');
  }

  function closeSolutionPicker() {
    document.getElementById('solutionPickerDropdown').classList.remove('active');
    document.getElementById('solutionPickerBtn').classList.remove('active');
  }

  function onSolutionToggle(solutionId) {
    var checkbox = document.getElementById('picker_' + solutionId);
    state.selectedSolutions[solutionId] = checkbox.checked;
    updatePickerLabel();
    applyFilters();
  }

  function selectActiveSolutions() {
    state.selectedSolutions = {};
    state.solutions.forEach(function(sol) {
      var checkbox = document.getElementById('picker_' + sol.solution_id);
      if (checkbox) {
        var isActive = isActivelyManaged(sol);
        checkbox.checked = isActive;
        state.selectedSolutions[sol.solution_id] = isActive;
      }
    });
    updatePickerLabel();
    applyFilters();
  }

  function selectAllSolutions() {
    state.selectedSolutions = {};
    state.solutions.forEach(function(sol) {
      var checkbox = document.getElementById('picker_' + sol.solution_id);
      if (checkbox) {
        checkbox.checked = true;
        state.selectedSolutions[sol.solution_id] = true;
      }
    });
    updatePickerLabel();
    applyFilters();
  }

  function clearSolutionSelection() {
    state.selectedSolutions = {};
    state.solutions.forEach(function(sol) {
      var checkbox = document.getElementById('picker_' + sol.solution_id);
      if (checkbox) {
        checkbox.checked = false;
      }
    });
    updatePickerLabel();
    applyFilters();
  }

  function updatePickerLabel() {
    var count = Object.keys(state.selectedSolutions).filter(function(k) {
      return state.selectedSolutions[k];
    }).length;
    var total = state.solutions.length;
    var label = document.getElementById('solutionPickerLabel');
    if (count === 0) {
      label.textContent = 'None selected';
    } else if (count === total) {
      label.textContent = 'All (' + total + ')';
    } else {
      label.textContent = count + ' of ' + total + ' selected';
    }
  }

  function updateStats() {
    // Guard against SPA navigation - elements may not exist
    var statTotal = document.getElementById('statTotalSolutions');
    var statOp = document.getElementById('statOperational');
    var statImpl = document.getElementById('statImplementation');
    var statForm = document.getElementById('statFormulation');
    if (!statTotal || !statOp || !statImpl || !statForm) {
      // SPA navigation - elements no longer exist
      return;
    }

    // Calculate stats based on filtered solutions (current view)
    var total = state.filteredSolutions.length;
    var operational = 0, implementation = 0, formulation = 0;

    state.filteredSolutions.forEach(function(sol) {
      var phase = (sol.admin_lifecycle_phase || '').toLowerCase();
      if (phase.includes('operational') || phase.includes('production')) operational++;
      else if (phase.includes('implementation')) implementation++;
      else if (phase.includes('formulation')) formulation++;
    });

    statTotal.textContent = total;
    statOp.textContent = operational;
    statImpl.textContent = implementation;
    statForm.textContent = formulation;
  }

  function updateMilestones() {
    // Guard against SPA navigation - elements may not exist
    var countATP = document.getElementById('countATP');
    var countF2I = document.getElementById('countF2I');
    var countORR = document.getElementById('countORR');
    var countCloseout = document.getElementById('countCloseout');
    if (!countATP || !countF2I || !countORR || !countCloseout) {
      // SPA navigation - elements no longer exist
      return;
    }

    // Count completed milestones from solution data (date in the past = completed)
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    var counts = { ATP: 0, F2I: 0, ORR: 0, Closeout: 0 };

    state.filteredSolutions.forEach(function(sol) {
      if (isDateCompleted(sol.milestone_atp_date, today)) counts.ATP++;
      if (isDateCompleted(sol.milestone_f2i_date, today)) counts.F2I++;
      if (isDateCompleted(sol.milestone_orr_date, today)) counts.ORR++;
      if (isDateCompleted(sol.milestone_closeout_date, today)) counts.Closeout++;
    });

    countATP.textContent = counts.ATP;
    countF2I.textContent = counts.F2I;
    countORR.textContent = counts.ORR;
    countCloseout.textContent = counts.Closeout;
  }

  function isDateCompleted(dateVal, today) {
    if (!dateVal) return false;
    var d = parseDate(dateVal);
    return d && d < today;
  }

  function parseDate(dateVal) {
    if (!dateVal) return null;
    if (dateVal instanceof Date) return dateVal;
    var str = String(dateVal).trim();
    if (!str) return null;
    // Handle ISO dates (2026-01-23T00:00:00.000Z) by extracting just the date part
    // This avoids timezone conversion issues where UTC midnight becomes previous day locally
    var dateOnly = str.split('T')[0];
    var parts = dateOnly.split('-');
    if (parts.length === 3) {
      return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    }
    // Fallback for other formats
    var d = new Date(str);
    return isNaN(d.getTime()) ? null : d;
  }

  function getMilestoneStatus(dateVal) {
    if (!dateVal) return 'not_started';
    var d = parseDate(dateVal);
    if (!d) return 'not_started';
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    return d < today ? 'completed' : 'planned';
  }

  function getDocStatus(val) {
    // In schema v2, status is derived from URL presence
    // Has URL = complete, no URL = not_started
    if (!val) return 'not_started';
    var str = String(val).trim();
    if (!str || str === 'nan' || str === 'NaN') return 'not_started';
    // Any URL or value = complete
    return 'complete';
  }

  function updateDocuments() {
    // Count document statuses across filtered solutions
    // In schema v2, status is derived from URL presence: complete or not_started (no in_work)
    var docs = {
      project_plan: { complete: 0, not_started: 0 },
      science_sow: { complete: 0, not_started: 0 },
      ipa: { complete: 0, not_started: 0 },
      icd: { complete: 0, not_started: 0 },
      tta: { complete: 0, not_started: 0 }
    };

    state.filteredSolutions.forEach(function(sol) {
      var ppStatus = getDocStatus(sol.docs_project_plan);
      var sowStatus = getDocStatus(sol.docs_science_sow);
      var ipaStatus = getDocStatus(sol.docs_ipa);
      var icdStatus = getDocStatus(sol.docs_icd);
      var ttaStatus = getDocStatus(sol.docs_tta);

      docs.project_plan[ppStatus]++;
      docs.science_sow[sowStatus]++;
      docs.ipa[ipaStatus]++;
      docs.icd[icdStatus]++;
      docs.tta[ttaStatus]++;
    });

    // Update UI - show counts as "X / Y / Z" (complete / in_work / not_started)
    updateDocElement('docProjectPlan', docs.project_plan);
    updateDocElement('docScienceSow', docs.science_sow);
    updateDocElement('docIpa', docs.ipa);
    updateDocElement('docIcd', docs.icd);
    updateDocElement('docTta', docs.tta);
  }

  function updateDocElement(elementId, counts) {
    var el = document.getElementById(elementId);
    if (!el) return;

    // In schema v2, status is derived from URL presence: complete or not_started (no in_work)
    var total = counts.complete + counts.not_started;
    if (total === 0) {
      el.textContent = '--';
      el.className = 'doc-status';
      return;
    }

    // Show as "complete / total"
    el.textContent = counts.complete + ' / ' + total;

    // Color based on completion status
    if (counts.complete > 0 && counts.complete === total) {
      el.className = 'doc-status status-complete';
    } else if (counts.complete > 0) {
      el.className = 'doc-status status-partial';
    } else {
      el.className = 'doc-status status-not-started';
    }
  }

  function renderDocStatusRow(label, value) {
    var status = getDocStatus(value);
    var badgeHtml = '';

    if (status === 'complete') {
      var url = String(value).trim();
      badgeHtml = '<a href="' + escapeAttr(url) + '" target="_blank" class="doc-link-badge">' +
        '<span class="material-icons" style="font-size: 14px; margin-right: 2px;">open_in_new</span>View</a>';
    } else {
      badgeHtml = '<span class="doc-badge doc-badge-not-started">--</span>';
    }

    return '<div class="doc-status-row">' +
      '<span class="doc-status-label">' + escapeHtml(label) + '</span>' +
      badgeHtml +
      '</div>';
  }

  function getAlignmentBadgeClass(value) {
    if (!value) return 'alignment-badge-na';
    var v = String(value).trim().toLowerCase();
    if (v === 'acceptable') return 'alignment-badge-acceptable';
    if (v === 'gap') return 'alignment-badge-gap';
    return 'alignment-badge-na';
  }

  function renderAlignmentItem(label, value) {
    var displayVal = value ? String(value).trim() : 'N/A';
    var badgeClass = getAlignmentBadgeClass(value);
    return '<div class="alignment-item">' +
      '<span>' + escapeHtml(label) + '</span>' +
      '<span class="alignment-badge ' + badgeClass + '">' + escapeHtml(displayVal) + '</span>' +
      '</div>';
  }

  function toggleCollapsibleSection(sectionId) {
    var content = document.getElementById(sectionId);
    var toggle = content ? content.previousElementSibling : null;
    if (content) content.classList.toggle('collapsed');
    if (toggle) toggle.classList.toggle('collapsed');
  }

  function updateTrackingStats() {
    // Guard against SPA navigation - elements may not exist
    var statDAAC = document.getElementById('statDAAC');
    var statDeepDives = document.getElementById('statDeepDives');
    if (!statDAAC || !statDeepDives) {
      // SPA navigation - elements no longer exist
      return;
    }

    // Calculate based on filtered solutions (current view)
    var daacCount = 0;
    var deepDiveCount = 0;
    var total = state.filteredSolutions.length;

    state.filteredSolutions.forEach(function(sol) {
      if (sol.product_assigned_daac && sol.product_assigned_daac.trim()) daacCount++;
      if (sol.milestone_deep_dive_date && String(sol.milestone_deep_dive_date).trim()) deepDiveCount++;
    });

    statDAAC.textContent = daacCount + '/' + total;
    statDeepDives.textContent = deepDiveCount + '/' + total;

    // Load open actions count
    google.script.run
      .withSuccessHandler(function(actions) {
        var el = document.getElementById('statActions');
        if (!el) return; // Guard for SPA navigation
        var count = (actions && actions.length) ? actions.length : 0;
        el.textContent = count;
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load actions:', error);
        var el = document.getElementById('statActions');
        if (el) el.textContent = '--';
      })
      .getOpenActions();

    // Load stakeholder stats from contacts database
    google.script.run
      .withSuccessHandler(function(stats) {
        var el = document.getElementById('statStakeholders');
        if (!el) return; // Guard for SPA navigation
        if (stats) {
          el.textContent = stats.unique_contacts || 0;
        } else {
          el.textContent = '0';
        }
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load contact stats:', error);
        var el = document.getElementById('statStakeholders');
        if (el) el.textContent = '--';
      })
      .getContactStats();
  }

  function applyFilters() {
    var cycleFilter = document.getElementById('filterCycle').value;
    var phaseFilter = document.getElementById('filterPhase').value;
    var groupFilter = document.getElementById('filterGroup').value;
    var daacFilter = document.getElementById('filterDAAC').value;
    var searchFilter = document.getElementById('filterSearch').value.toLowerCase().trim();

    state.filteredSolutions = state.solutions.filter(function(sol) {
      // Solution picker filter - only show selected solutions (with grouping support)
      if (!isSolutionSelectedWithGrouping(sol.solution_id)) return false;
      if (cycleFilter && String(sol.core_cycle) !== cycleFilter) return false;
      if (phaseFilter && sol.admin_lifecycle_phase !== phaseFilter) return false;
      if (groupFilter && sol.core_group !== groupFilter) return false;
      if (daacFilter && sol.product_assigned_daac !== daacFilter) return false;
      if (searchFilter) {
        var searchable = [sol.solution_id, sol.solution_id, sol.core_official_name, sol.lead_name, sol.core_group, sol.earthdata_purpose, sol.product_assigned_daac].join(' ').toLowerCase();
        if (searchable.indexOf(searchFilter) === -1) return false;
      }
      return true;
    });
    updateStats(); // Update stats based on filtered view
    updateMilestones(); // Update milestones based on filtered view
    updateTrackingStats(); // Update tracking stats based on filtered view
    updateDocuments(); // Update document administration panel
    render();
  }

  function clearFilters() {
    document.getElementById('filterCycle').value = '';
    document.getElementById('filterPhase').value = '';
    document.getElementById('filterGroup').value = '';
    document.getElementById('filterDAAC').value = '';
    document.getElementById('filterSearch').value = '';
    selectActiveSolutions(); // Reset to actively managed
  }

  function render() {
    var container = document.getElementById('solutionsContainer');

    if (state.filteredSolutions.length === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">inbox</span><p>No solutions match your filters</p></div>';
return;
    }

    var byCycle = {};
    state.filteredSolutions.forEach(function(sol) {
      var cycle = sol.core_cycle || 'Unknown';
      if (!byCycle[cycle]) byCycle[cycle] = [];
      byCycle[cycle].push(sol);
    });

    var cycles = Object.keys(byCycle).sort(function(a, b) { return parseInt(b) - parseInt(a); });
    var html = '';

    cycles.forEach(function(cycle) {
      var solutions = byCycle[cycle];
      var isCollapsed = state.collapsedCycles[cycle] || false;
      var cycleYear = getCycleYear(cycle);
      var isFuture = parseInt(cycle) >= 6;

      html += '<div class="cycle-section" data-cycle="' + cycle + '">';
      html += '<div class="cycle-header' + (isCollapsed ? ' collapsed' : '') + '" onclick="Implementation.toggleCycle(\'' + cycle + '\')">';
      html += '<span class="material-icons">expand_more</span>';
      html += '<span class="cycle-badge badge-c' + cycle + '">C' + cycle + '</span>';
      html += '<span class="cycle-title">Cycle ' + cycle + (cycleYear ? ' (' + cycleYear + ')' : '') + (isFuture ? ' - Assessment' : '') + '</span>';
      html += '<span class="cycle-count">' + solutions.length + ' solution' + (solutions.length !== 1 ? 's' : '') + '</span>';
      html += '</div>';
      html += '<div class="cycle-solutions' + (isCollapsed ? ' collapsed' : '') + '">';
      solutions.forEach(function(sol) { html += renderSolutionCard(sol); });
      html += '</div></div>';
    });

    container.innerHTML = html;
}

  function renderSolutionCard(sol) {
    var phaseClass = getPhaseClass(sol.admin_lifecycle_phase);
    var cardClass = 'solution-card ' + phaseClass;
    var statusSummary = truncateText(sol.earthdata_status_summary, 120);

    var html = '<div class="' + cardClass + '">';

    // Header
    html += '<div class="solution-card-header"><div>';
    html += '<div class="solution-name" onclick="Implementation.showDetail(\'' + escapeAttr(sol.solution_id) + '\')">' + escapeHtml((sol.solution_id || '').toUpperCase()) + '</div>';
    html += '</div><div class="solution-badges">';
    html += '<span class="phase-badge ' + phaseClass + '">' + escapeHtml(sol.admin_lifecycle_phase || 'Unknown') + '</span>';
    html += '</div></div>';

    // Meta info
    html += '<div class="solution-meta">';
    if (sol.funding_type === 'Y') html += '<span class="solution-meta-item"><span class="material-icons">attach_money</span>ISON</span>';
    html += '</div>';

    // Lead
    if (sol.lead_name) {
      html += '<div class="solution-lead"><strong>Lead:</strong> ' + escapeHtml(sol.lead_name);
      if (sol.lead_agency_name) html += ' <span style="opacity:0.7">(' + escapeHtml(truncateText(sol.lead_agency_name, 30)) + ')</span>';
      html += '</div>';
    }

    // Tracking tags
    html += '<div class="solution-tracking">';
    if (sol.product_assigned_daac) html += '<span class="tracking-tag tag-daac"><span class="material-icons">storage</span>' + escapeHtml(sol.product_assigned_daac) + '</span>';
    if (sol.admin_lifecycle_phase && sol.admin_lifecycle_phase.toLowerCase().includes('operational')) {
      html += '<span class="tracking-tag tag-milestone"><span class="material-icons">check_circle</span>OPS</span>';
    } else if (sol.admin_lifecycle_phase && sol.admin_lifecycle_phase.toLowerCase().includes('implementation')) {
      html += '<span class="tracking-tag tag-milestone"><span class="material-icons">play_circle</span>F2I</span>';
    }
    html += '</div>';

    // Status
    if (statusSummary) html += '<div class="solution-status">' + escapeHtml(statusSummary) + '</div>';

    // Actions
    html += '<div class="solution-actions">';
    if (sol.admin_drive_folder) html += '<a href="' + escapeHtml(sol.admin_drive_folder) + '" target="_blank" class="solution-action-btn"><span class="material-icons">folder</span>Drive</a>';
    if (sol.earthdata_solution_page_url) html += '<a href="' + escapeHtml(sol.earthdata_solution_page_url) + '" target="_blank" class="solution-action-btn"><span class="material-icons">open_in_new</span>Earthdata</a>';
    if (sol.docs_project_plan) html += '<a href="' + escapeHtml(sol.docs_project_plan) + '" target="_blank" class="solution-action-btn"><span class="material-icons">description</span>Plan</a>';
    html += '<button class="solution-action-btn" onclick="Implementation.showDetail(\'' + escapeAttr(sol.solution_id) + '\')"><span class="material-icons">info</span>Details</button>';
    html += '</div></div>';

    return html;
  }

  function toggleCycle(cycle) {
    state.collapsedCycles[cycle] = !state.collapsedCycles[cycle];
    var section = document.querySelector('.cycle-section[data-cycle="' + cycle + '"]');
    if (section) {
      var header = section.querySelector('.cycle-header');
      var solutions = section.querySelector('.cycle-solutions');
      if (state.collapsedCycles[cycle]) {
        header.classList.add('collapsed');
        solutions.classList.add('collapsed');
      } else {
        header.classList.remove('collapsed');
        solutions.classList.remove('collapsed');
      }
    }
  }

  function showDetail(solutionId) {
    var sol = state.solutions.find(function(s) { return s.solution_id === solutionId; });
    if (!sol) return;

    document.getElementById('solutionModalTitle').textContent = (sol.solution_id || '').toUpperCase();

    // Build milestone data from solution fields (instant - no API call)
    var milestoneData = buildMilestoneData(sol);

    // Render immediately with solution data we already have
    // Stakeholders and Activity sections show loading placeholders
    renderDetailModalIncremental(sol, milestoneData);
    document.getElementById('solutionModal').classList.add('active');

    // Load stakeholder data (updates section when complete)
    google.script.run
      .withSuccessHandler(function(stakeholders) {
        updateStakeholdersSection(stakeholders, sol);
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load stakeholders:', error);
        updateStakeholdersSection(null, sol);
      })
      .getSolutionStakeholderSummary(sol.solution_id || sol.core_official_name);

    // Load recent activity (updates section when complete)
    google.script.run
      .withSuccessHandler(function(activity) {
        updateActivitySection(activity);
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load activity:', error);
        updateActivitySection(null);
      })
      .getSolutionRecentActivity(sol.solution_id, 30);
  }

  // Update stakeholders section when data arrives
  function updateStakeholdersSection(stakeholders, sol) {
    var container = document.getElementById('stakeholdersContent');
    if (!container) return;

    // Mark progress step as complete
    markProgressStepComplete('step-stakeholders', 'Stakeholders');

    var html = '';
    var solutionName = sol ? (sol.solution_id || sol.core_official_name || '') : '';

    if (stakeholders && stakeholders.total_contacts > 0) {
      // Role breakdown stats
      html += '<div class="stakeholder-summary">';
      html += '<div class="stakeholder-stat"><span class="stat-number">' + stakeholders.total_contacts + '</span><span class="stat-label">Total Contacts</span></div>';
      if (stakeholders.by_role) {
        var roles = Object.keys(stakeholders.by_role);
        roles.forEach(function(role) {
          html += '<div class="stakeholder-stat"><span class="stat-number">' + stakeholders.by_role[role] + '</span><span class="stat-label">' + escapeHtml(role) + '</span></div>';
        });
      }
      html += '</div>';

      // Contact name list  first 5 visible, rest expandable
      var allContacts = stakeholders.top_contacts || [];
      if (allContacts.length > 0) {
        var limit = 5;
        var visible = allContacts.slice(0, limit);
        var overflow = allContacts.slice(limit);

        function contactLink(c) {
          if (c.contact_id) {
            return '<span class="clickable-name" onclick="Implementation.showContactDetail(\'' + escapeAttr(c.contact_id) + '\', \'' + escapeAttr(c.name) + '\')">' + escapeHtml(c.name) + '</span>';
          }
          return escapeHtml(c.name);
        }

        html += '<div class="sme-list">';
        html += '<span id="stakeholder-names-short">';
        html += visible.map(contactLink).join(', ');
        if (overflow.length > 0) {
          html += ' <a href="#" class="see-more-link" onclick="Implementation.toggleStakeholderNames(); return false;">...+' + overflow.length + ' more</a>';
        }
        html += '</span>';
        if (overflow.length > 0) {
          html += '<span id="stakeholder-names-full" style="display:none;">';
          html += allContacts.map(contactLink).join(', ');
          html += ' <a href="#" class="see-more-link" onclick="Implementation.toggleStakeholderNames(); return false;">show less</a>';
          html += '</span>';
        }
        html += '</div>';
      }

      // Agencies represented
      if (stakeholders.departments && stakeholders.departments.length > 0) {
        html += '<div class="dept-list">';
        html += '<strong>Agencies:</strong> ' + stakeholders.departments.slice(0, 5).map(escapeHtml).join(', ');
        if (stakeholders.departments.length > 5) {
          html += ' <span style="opacity:0.7">+' + (stakeholders.departments.length - 5) + ' more</span>';
        }
        html += '</div>';
      }

      // Discrete directory link
      if (solutionName) {
        html += '<div style="margin-top: var(--space-sm); text-align: right;">';
        html += '<a href="#" class="see-more-link" onclick="Implementation.viewSolutionContacts(\'' + escapeAttr(solutionName) + '\'); return false;" style="font-size: var(--font-size-xs);">';
        html += '<span class="material-icons" style="font-size: 12px; vertical-align: middle; margin-right: 2px;">open_in_new</span>Open in directory</a>';
        html += '</div>';
      }
    } else {
      html += '<div class="empty-stakeholders">';
      html += 'No stakeholder data available yet.';
      if (solutionName) {
        html += ' <span onclick="Implementation.viewSolutionContacts(\'' + escapeAttr(solutionName) + '\')" style="color: var(--color-primary); cursor: pointer; text-decoration: underline;">View Contacts page</span>';
      }
      html += '</div>';
    }

    container.innerHTML = html;
  }

  // Update activity section when data arrives
  function updateActivitySection(activity) {
    var container = document.getElementById('activityContent');
    if (!container) return;

    // Mark progress step as complete
    markProgressStepComplete('step-activity', 'Activity');

    var html = '';
    if (activity && activity.activities && activity.activities.length > 0) {
      // Show summary with source breakdown
      html += '<div class="activity-summary">';
      html += '<span class="activity-count">' + activity.totalCount + ' activities in last ' + activity.days + ' days</span>';
      // Source badges
      var sourceLabels = {
        updates: { label: 'Updates', icon: 'update' },
        engagements: { label: 'Engagements', icon: 'groups' },
        actions: { label: 'Actions', icon: 'task_alt' },
        stories: { label: 'Stories', icon: 'article' },
        milestones: { label: 'Milestones', icon: 'flag' }
      };
      html += '<div class="activity-sources">';
      Object.keys(activity.sources).forEach(function(source) {
        if (activity.sources[source] > 0) {
          var info = sourceLabels[source] || { label: source, icon: 'info' };
          html += '<span class="activity-source-badge activity-source-' + source + '">';
          html += '<span class="material-icons">' + info.icon + '</span>';
          html += activity.sources[source] + ' ' + info.label;
          html += '</span>';
        }
      });
      html += '</div>';
      html += '</div>';

      // Activity list
      html += '<div class="activity-list">';
      activity.activities.forEach(function(item) {
        html += renderActivityItem(item);
      });
      html += '</div>';

      // More indicator
      if (activity.hasMore) {
        html += '<div class="activity-more-note">';
        html += '<span class="material-icons">info</span>';
        html += 'Showing first 50 activities. Full history available in <a href="' + Platform.baseUrl + '?page=reports">Reports</a>.';
        html += '</div>';
      }
    } else {
      html += '<div class="empty-activity">No recent activity recorded for this solution.</div>';
    }
    container.innerHTML = html;
  }

  // Mark a progress step as complete and check if all steps are done
  function markProgressStepComplete(stepId, label) {
    var step = document.getElementById(stepId);
    if (step) {
      step.classList.remove('loading');
      step.classList.add('complete');
      step.innerHTML = '<span class="material-icons">check_circle</span>' + label;
    }

    // Check if all steps are now complete
    var tracker = document.getElementById('loadingProgressTracker');
    if (tracker) {
      var loadingSteps = tracker.querySelectorAll('.progress-step.loading');
      if (loadingSteps.length === 0) {
        tracker.classList.add('all-complete');
      }
    }
  }

  function buildMilestoneData(sol) {
    var milestones = [];
    var completed = 0, planned = 0;

    // ATP
    if (sol.milestone_atp_date) {
      var status = getMilestoneStatus(sol.milestone_atp_date);
      milestones.push({ type: 'ATP DG', date: formatDateDisplay(sol.milestone_atp_date), status: status });
      if (status === 'completed') completed++; else if (status === 'planned') planned++;
    }

    // F2I
    if (sol.milestone_f2i_date) {
      var status = getMilestoneStatus(sol.milestone_f2i_date);
      milestones.push({ type: 'F2I DG', date: formatDateDisplay(sol.milestone_f2i_date), status: status });
      if (status === 'completed') completed++; else if (status === 'planned') planned++;
    }

    // ORR
    if (sol.milestone_orr_date) {
      var status = getMilestoneStatus(sol.milestone_orr_date);
      milestones.push({ type: 'ORR', date: formatDateDisplay(sol.milestone_orr_date), status: status });
      if (status === 'completed') completed++; else if (status === 'planned') planned++;
    }

    // Closeout
    if (sol.milestone_closeout_date) {
      var status = getMilestoneStatus(sol.milestone_closeout_date);
      milestones.push({ type: 'Closeout DG', date: formatDateDisplay(sol.milestone_closeout_date), status: status });
      if (status === 'completed') completed++; else if (status === 'planned') planned++;
    }

    // Find next milestone (first planned one)
    var nextMilestone = milestones.find(function(m) { return m.status === 'planned'; });

    return {
      milestones: milestones,
      completed: completed,
      planned: planned,
      next_milestone: nextMilestone ? { type: nextMilestone.type, target_date: nextMilestone.date } : null
    };
  }

  function formatDateDisplay(dateVal) {
    var d = parseDate(dateVal);
    if (!d) return '';
    return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }

  // Render modal incrementally - show available data immediately, loading placeholders for async sections
  function renderDetailModalIncremental(sol, milestones) {
    // Progress tracker at top showing loading status
    var html = '<div class="loading-progress-tracker" id="loadingProgressTracker">';
    html += '<div class="progress-step complete" id="step-info"><span class="material-icons">check_circle</span>Solution Info</div>';
    html += '<div class="progress-step complete" id="step-docs"><span class="material-icons">check_circle</span>Documents</div>';
    html += '<div class="progress-step complete" id="step-milestones"><span class="material-icons">check_circle</span>Milestones</div>';
    html += '<div class="progress-step loading" id="step-stakeholders"><span class="material-icons">sync</span>Stakeholders...</div>';
    html += '<div class="progress-step loading" id="step-activity"><span class="material-icons">sync</span>Activity...</div>';
    html += '</div>';

    html += '<div class="detail-grid">';

    // Left column - Identity & Status (INSTANT - from solution data)
    html += '<div>';

    html += '<div class="detail-section">';
    html += '<div class="detail-section-title">Identity</div>';
    html += '<div class="detail-row"><span class="detail-label">Full Title</span><span class="detail-value">' + escapeHtml(sol.core_official_name || '-') + '</span></div>';
    html += '<div class="detail-row"><span class="detail-label">Group</span><span class="detail-value">' + escapeHtml(sol.core_group || '-') + '</span></div>';
    html += '</div>';

    html += '<div class="detail-section">';
    html += '<div class="detail-section-title">Lifecycle</div>';
    html += '<div class="detail-row"><span class="detail-label">Cycle</span><span class="detail-value">C' + sol.core_cycle + ' (' + getCycleYear(sol.core_cycle) + ')</span></div>';
    html += '<div class="detail-row"><span class="detail-label">Phase</span><span class="detail-value">' + escapeHtml(sol.admin_lifecycle_phase || '-') + '</span></div>';
    html += '<div class="detail-row"><span class="detail-label">Funding</span><span class="detail-value">' + (sol.funding_type === 'Y' ? 'ISON Funded' : sol.funding_status || '-') + '</span></div>';
    html += '</div>';

    html += '<div class="detail-section">';
    html += '<div class="detail-section-title">Per-Solution Tracking</div>';
    html += '<div class="detail-row"><span class="detail-label">DAAC Assignment</span><span class="detail-value">' + escapeHtml(sol.product_assigned_daac || 'TBD') + '</span></div>';
    // Stakeholder List - link to Contacts page filtered by solution
    var solutionName = sol.solution_id || sol.core_official_name || '';
    var stakeholderValue = '<span onclick="Implementation.viewSolutionContacts(\'' + escapeAttr(solutionName) + '\')" style="color: var(--color-primary); cursor: pointer; text-decoration: underline;">View Contacts</span>';
    html += '<div class="detail-row"><span class="detail-label">Stakeholder List</span><span class="detail-value">' + stakeholderValue + '</span></div>';
    html += '</div>';

    if (sol.earthdata_background) {
      html += '<div class="detail-section">';
      html += '<div class="detail-section-title">Background</div>';
      html += '<div class="detail-text">' + formatTextWithLinks(sol.earthdata_background) + '</div>';
      html += '</div>';
    }

    if (sol.earthdata_societal_impact) {
      html += '<div class="detail-section">';
      html += '<div class="detail-section-title">Societal Impact</div>';
      html += '<div class="detail-text">' + formatTextWithLinks(sol.earthdata_societal_impact) + '</div>';
      html += '</div>';
    }

    html += '</div>';

    // Right column - Team & Content (INSTANT - from solution data)
    html += '<div>';

    html += '<div class="detail-section">';
    html += '<div class="detail-section-title">Team</div>';
    var leadRef = sol.lead_contact_id;
    var leadDisplay = sol.lead_name || '';
    html += '<div class="detail-row"><span class="detail-label">Solution Lead</span><span class="detail-value">' + (leadRef ? '<span class="clickable-name" onclick="Implementation.showContactDetail(\'' + escapeAttr(leadRef) + '\', \'' + escapeAttr(leadDisplay) + '\')">' + escapeHtml(leadDisplay) + '</span>' : (leadDisplay || 'TBD')) + '</span></div>';
    html += '<div class="detail-row"><span class="detail-label">Affiliation</span><span class="detail-value">' + escapeHtml(sol.lead_agency_name || '-') + '</span></div>';
    var sciRef = sol.scientist_contact_id;
    var sciDisplay = sol.scientist_name || '';
    html += '<div class="detail-row"><span class="detail-label">Project Scientist</span><span class="detail-value">' + (sciRef ? '<span class="clickable-name" onclick="Implementation.showContactDetail(\'' + escapeAttr(sciRef) + '\', \'' + escapeAttr(sciDisplay) + '\')">' + escapeHtml(sciDisplay) + '</span>' : (sciDisplay || '-')) + '</span></div>';
    html += '<div class="detail-row"><span class="detail-label">Scientist Affiliation</span><span class="detail-value">' + escapeHtml(sol.scientist_agency_name || '-') + '</span></div>';
    var raRepRef = sol.ra_rep_contact_id;
    var raRepDisplay = sol.ra_rep_name || '';
    html += '<div class="detail-row"><span class="detail-label">RA Representative</span><span class="detail-value">' + (raRepRef ? '<span class="clickable-name" onclick="Implementation.showContactDetail(\'' + escapeAttr(raRepRef) + '\', \'' + escapeAttr(raRepDisplay) + '\')">' + escapeHtml(raRepDisplay) + '</span>' : (raRepDisplay || '-')) + '</span></div>';
    html += '<div class="detail-row"><span class="detail-label">RA Rep Affiliation</span><span class="detail-value">' + escapeHtml(sol.ra_rep_agency_name || '-') + '</span></div>';
    var eaRef = sol.ea_advocate_contact_id;
    var eaDisplay = sol.ea_advocate_name || '';
    html += '<div class="detail-row"><span class="detail-label">EA Advocate</span><span class="detail-value">' + (eaRef ? '<span class="clickable-name" onclick="Implementation.showContactDetail(\'' + escapeAttr(eaRef) + '\', \'' + escapeAttr(eaDisplay) + '\')">' + escapeHtml(eaDisplay) + '</span>' : (eaDisplay || '-')) + '</span></div>';
    html += '<div class="detail-row"><span class="detail-label">EA Affiliation</span><span class="detail-value">' + escapeHtml(sol.ea_advocate_agency_name || '-') + '</span></div>';
    html += '</div>';

    html += '<div class="detail-section">';
    html += '<div class="detail-section-title">Purpose</div>';
    html += '<div class="detail-text">' + formatTextWithLinks(sol.earthdata_purpose || 'No description available.') + '</div>';
    html += '</div>';

    html += '<div class="detail-section">';
    html += '<div class="detail-section-title">Status Summary</div>';
    var statusText = sol.earthdata_status_summary || 'No status update.';
    var statusCharLimit = 300;
    if (statusText.length > statusCharLimit) {
      var truncatedStatus = statusText.substring(0, statusCharLimit).trim();
      // Don't cut mid-word
      var lastSpace = truncatedStatus.lastIndexOf(' ');
      if (lastSpace > statusCharLimit - 50) {
        truncatedStatus = truncatedStatus.substring(0, lastSpace);
      }
      html += '<div class="status-summary-wrapper">';
      html += '<div class="detail-text status-truncated" id="statusTruncated">' + formatTextWithLinks(truncatedStatus) + '...</div>';
      html += '<div class="detail-text status-full collapsed" id="statusFull">' + formatTextWithLinks(statusText) + '</div>';
      html += '<button class="status-see-more-btn" onclick="Implementation.toggleStatusSummary()">';
      html += '<span class="material-icons">expand_more</span>';
      html += 'See more';
      html += '</button>';
      html += '</div>';
    } else {
      html += '<div class="detail-text">' + formatTextWithLinks(statusText) + '</div>';
    }
    html += '</div>';

    html += '</div>';
    html += '</div>';

    // Documents section - INSTANT (from solution data)
    html += '<div class="detail-section" style="margin-top: var(--space-lg);">';
    html += '<div class="detail-section-title">Documentation Links</div>';
    html += '<div style="display: flex; flex-wrap: wrap; gap: var(--space-sm);">';
    if (sol.admin_drive_folder) html += '<a href="' + escapeHtml(sol.admin_drive_folder) + '" target="_blank" class="solution-action-btn"><span class="material-icons">folder</span>Drive Folder</a>';
    if (sol.earthdata_solution_page_url) html += '<a href="' + escapeHtml(sol.earthdata_solution_page_url) + '" target="_blank" class="solution-action-btn"><span class="material-icons">public</span>Earthdata Page</a>';
    if (sol.docs_project_plan) html += '<a href="' + escapeHtml(sol.docs_project_plan) + '" target="_blank" class="solution-action-btn"><span class="material-icons">description</span>Project Plan</a>';
    if (sol.docs_science_sow) html += '<a href="' + escapeHtml(sol.docs_science_sow) + '" target="_blank" class="solution-action-btn"><span class="material-icons">insert_drive_file</span>Science SOW</a>';
    if (sol.docs_risk_register) html += '<a href="' + escapeHtml(sol.docs_risk_register) + '" target="_blank" class="solution-action-btn"><span class="material-icons">warning</span>Risk Register</a>';
    if (sol.product_data_products) html += '<a href="' + escapeHtml(sol.product_data_products) + '" target="_blank" class="solution-action-btn"><span class="material-icons">table_chart</span>Data Products</a>';
    // Share with Team button - only show if team folder is configured
    if (sol.admin_shared_team_folder) {
      html += '<button class="share-team-btn" onclick="Implementation.openUploadModal(\'' + escapeAttr(sol.solution_id) + '\', \'' + escapeAttr(sol.admin_shared_team_folder) + '\')">';
      html += '<span class="material-icons">upload_file</span>Share with Team';
      html += '</button>';
    }
    html += '</div></div>';

    // Document Status section - INSTANT (from solution data)
    html += '<div class="detail-section" style="margin-top: var(--space-lg);">';
    html += '<div class="detail-section-title">Document Status</div>';
    html += '<div class="doc-status-grid">';
    html += renderDocStatusRow('Project Plan', sol.docs_project_plan);
    html += renderDocStatusRow('Science SOW', sol.docs_science_sow);
    html += renderDocStatusRow('IPA', sol.docs_ipa);
    html += renderDocStatusRow('ICD', sol.docs_icd);
    html += renderDocStatusRow('TTA', sol.docs_tta);
    html += renderDocStatusRow('ATP Presentation', sol.milestone_atp_presentation_url);
    html += renderDocStatusRow('ATP Memo', sol.milestone_atp_memo_url);
    html += renderDocStatusRow('F2I Presentation', sol.milestone_f2i_presentation_url);
    html += renderDocStatusRow('F2I Memo', sol.milestone_f2i_memo_url);
    html += renderDocStatusRow('ORR Presentation', sol.milestone_orr_presentation_url);
    html += renderDocStatusRow('ORR Memo', sol.milestone_orr_memo_url);
    html += renderDocStatusRow('Closeout Presentation', sol.milestone_closeout_presentation_url);
    html += renderDocStatusRow('Closeout Memo', sol.milestone_closeout_memo_url);
    html += renderDocStatusRow('Deep Dive', sol.milestone_deep_dive_presentation_url);
    html += '</div></div>';

    // Need Alignment Assessment section - collapsible
    var hasAlignment = sol.alignment_horiz_resolution || sol.alignment_temporal_freq ||
      sol.alignment_geo_domain || sol.alignment_latency || sol.alignment_spectral_bands ||
      sol.alignment_vertical_resolution;
    if (hasAlignment) {
      html += '<div class="detail-section" style="margin-top: var(--space-lg);">';
      html += '<div class="detail-section-title section-toggle" onclick="Implementation.toggleCollapsibleSection(\'alignmentContent\')">';
      html += '<span class="material-icons">expand_more</span> Need Alignment Assessment</div>';
      html += '<div id="alignmentContent" class="section-collapsible">';
      html += '<div class="alignment-grid">';
      html += renderAlignmentItem('Horizontal Resolution', sol.alignment_horiz_resolution);
      html += renderAlignmentItem('Temporal Frequency', sol.alignment_temporal_freq);
      html += renderAlignmentItem('Geographic Domain', sol.alignment_geo_domain);
      html += renderAlignmentItem('Latency', sol.alignment_latency);
      html += renderAlignmentItem('Spectral Bands', sol.alignment_spectral_bands);
      html += renderAlignmentItem('Vertical Resolution', sol.alignment_vertical_resolution);
      html += '</div>';
      if (sol.alignment_notes) {
        html += '<div class="detail-row" style="margin-top: var(--space-sm);"><span class="detail-label">Notes</span><span class="detail-value">' + escapeHtml(sol.alignment_notes) + '</span></div>';
      }
      if (sol.alignment_last_reviewed) {
        html += '<div class="detail-row"><span class="detail-label">Last Reviewed</span><span class="detail-value">' + escapeHtml(sol.alignment_last_reviewed) + '</span></div>';
      }
      html += '</div></div>';
    }

    // Technical Specifications section - collapsible
    var hasTechSpecs = sol.product_platform || sol.product_temporal_freq ||
      sol.product_horiz_resolution || sol.product_geo_domain || sol.product_latency ||
      sol.product_spectral_bands || sol.product_vertical_resolution;
    if (hasTechSpecs) {
      html += '<div class="detail-section" style="margin-top: var(--space-lg);">';
      html += '<div class="detail-section-title section-toggle" onclick="Implementation.toggleCollapsibleSection(\'techSpecsContent\')">';
      html += '<span class="material-icons">expand_more</span> Technical Specifications</div>';
      html += '<div id="techSpecsContent" class="section-collapsible">';
      var specFields = [
        { label: 'Platform/Sensor', field: 'product_platform' },
        { label: 'Temporal Frequency', field: 'product_temporal_freq' },
        { label: 'Horizontal Resolution', field: 'product_horiz_resolution' },
        { label: 'Geographic Domain', field: 'product_geo_domain' },
        { label: 'Latency', field: 'product_latency' },
        { label: 'Spectral Bands', field: 'product_spectral_bands' },
        { label: 'Vertical Resolution', field: 'product_vertical_resolution' }
      ];
      specFields.forEach(function(spec) {
        if (sol[spec.field]) {
          html += '<div class="detail-row"><span class="detail-label">' + spec.label + '</span><span class="detail-value">' + escapeHtml(String(sol[spec.field])) + '</span></div>';
        }
      });
      html += '</div></div>';
    }

    // Milestones section - INSTANT (calculated from solution data)
    html += '<div class="detail-section" style="margin-top: var(--space-lg);">';
    html += '<div class="detail-section-title">Milestones</div>';

    if (milestones && milestones.milestones && milestones.milestones.length > 0) {
      html += '<div class="milestone-summary">';
      html += '<div class="milestone-stat"><span class="stat-number">' + milestones.completed + '</span><span class="stat-label">Completed</span></div>';
      html += '<div class="milestone-stat"><span class="stat-number">' + milestones.planned + '</span><span class="stat-label">Planned</span></div>';
      if (milestones.overdue > 0) {
        html += '<div class="milestone-stat milestone-overdue"><span class="stat-number">' + milestones.overdue + '</span><span class="stat-label">Overdue</span></div>';
      }
      html += '</div>';

      // Next milestone
      if (milestones.next_milestone) {
        html += '<div class="next-milestone">';
        html += '<strong>Next:</strong> ' + escapeHtml(milestones.next_milestone.type);
        if (milestones.next_milestone.target_date) {
          html += ' <span class="milestone-date">(' + milestones.next_milestone.target_date + ')</span>';
        }
        html += '</div>';
      }

      // Milestone timeline
      html += '<div class="milestone-timeline">';
      milestones.milestones.forEach(function(m) {
        var statusClass = 'milestone-' + (m.status || 'not_started');
        var icon = m.status === 'completed' ? 'check-circle' : (m.status === 'planned' ? 'clock' : 'circle');
        html += '<div class="milestone-item ' + statusClass + '">';
        html += '<span class="material-icons">' + icon + '</span>';
        html += '<span class="milestone-type">' + escapeHtml(m.type) + '</span>';
        if (m.date) {
          html += '<span class="milestone-date">' + m.date + '</span>';
        }
        html += '</div>';
      });
      html += '</div>';
    } else {
      html += '<div class="empty-milestones">No milestone dates set for this solution.</div>';
    }
    html += '</div>';

    // Stakeholders section - ASYNC (shows loading, updated when data arrives)
    html += '<div class="detail-section" style="margin-top: var(--space-lg);">';
    html += '<div class="detail-section-title">';
    html += '<span class="material-icons" style="font-size: 18px; margin-right: 6px;">groups</span>';
    html += 'Stakeholders';
    html += '</div>';
    html += '<div id="stakeholdersContent">';
    html += '<div class="section-loading"><span class="loading-spinner-sm"></span> Loading stakeholders...</div>';
    html += '</div>';
    html += '</div>';

    // Recent Activity section - ASYNC (shows loading, updated when data arrives)
    html += '<div class="detail-section" style="margin-top: var(--space-lg);">';
    html += '<div class="detail-section-title">';
    html += '<span class="material-icons" style="font-size: 18px; margin-right: 6px;">history</span>';
    html += 'Recent Activity';
    html += '</div>';
    html += '<div id="activityContent">';
    html += '<div class="section-loading"><span class="loading-spinner-sm"></span> Loading activity...</div>';
    html += '</div>';
    html += '</div>';

    document.getElementById('modalBody').innerHTML = html;
  }

  // Safely render text with markdown links
  // Extracts links first, escapes remaining text, then reinserts links
  function renderUpdateText(text) {
    if (!text) return '';

    // Find all markdown links and store them with placeholders
    var links = [];
    var placeholder = '\u0000LINK';
    var processed = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, linkText, url) {
      var index = links.length;
      links.push({ text: linkText, url: url });
      return placeholder + index + '\u0000';
    });

    // Escape the remaining text
    processed = escapeHtml(processed);

    // Convert newlines to <br>
    processed = processed.replace(/\n/g, '<br>');

    // Reinsert links as HTML
    links.forEach(function(link, index) {
      var safeUrl = escapeHtml(link.url);
      var safeText = escapeHtml(link.text);
      var anchor = '<a href="' + safeUrl + '" target="_blank" rel="noopener">' + safeText + '</a>';
      processed = processed.replace(placeholder + index + '\u0000', anchor);
    });

    return processed;
  }

  function renderUpdateItem(update) {
    var html = '<div class="update-item">';
    html += '<div class="update-date">';
    if (update.meeting_date) {
      var d = new Date(update.meeting_date);
      html += d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    html += '</div>';
    html += '<div class="update-content">';
    // Render with clickable markdown links
    html += renderUpdateText(update.update_text);
    html += '</div>';
    if (update.source_document) {
      html += '<div class="update-source">' + escapeHtml(update.source_document);
      if (update.source_tab) {
        html += ' (' + escapeHtml(update.source_tab) + ')';
      }
      html += '</div>';
    }
    html += '</div>';
    return html;
  }

  function renderActivityItem(item) {
    var html = '<div class="activity-item activity-type-' + (item.type || 'unknown') + '">';

    // Icon and type indicator
    html += '<div class="activity-icon">';
    html += '<span class="material-icons">' + escapeHtml(item.icon || 'info') + '</span>';
    html += '</div>';

    // Main content
    html += '<div class="activity-content">';

    // Date
    html += '<div class="activity-date">';
    if (item.date) {
      var d = new Date(item.date);
      html += d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    html += '</div>';

    // Title
    html += '<div class="activity-title">' + escapeHtml(item.title || '') + '</div>';

    // Description  render as rich content (HTML or plain text)
    if (item.description) {
      var desc = item.description;
      // Strip HTML tags to get plain text length for truncation check
      var plainText = desc.replace(/<[^>]+>/g, '').trim();
      var charLimit = 200;
      if (plainText.length > charLimit) {
        var itemId = 'activity-desc-' + Math.random().toString(36).substr(2, 9);
        // Truncate the plain text for preview
        var truncated = plainText.substring(0, charLimit);
        var lastSpace = truncated.lastIndexOf(' ');
        if (lastSpace > charLimit - 50) {
          truncated = truncated.substring(0, lastSpace);
        }
        html += '<div class="activity-description">';
        html += '<span id="' + itemId + '-short">' + escapeHtml(truncated) + '... ';
        html += '<a href="#" class="see-more-link" onclick="Implementation.toggleActivityDesc(\'' + itemId + '\'); return false;">see more</a></span>';
        html += '<span id="' + itemId + '-full" style="display:none;">' + displayRichContent(desc) + ' ';
        html += '<a href="#" class="see-more-link" onclick="Implementation.toggleActivityDesc(\'' + itemId + '\'); return false;">see less</a></span>';
        html += '</div>';
      } else {
        html += '<div class="activity-description">' + displayRichContent(desc) + '</div>';
      }
    }

    // Type-specific metadata
    if (item.type === 'engagement' && item.participants) {
      html += '<div class="activity-meta"><span class="material-icons">person</span>' + escapeHtml(item.participants) + '</div>';
    }
    if (item.type === 'action') {
      if (item.status) {
        var statusClass = item.status === 'done' ? 'activity-status-done' : 'activity-status-open';
        html += '<div class="activity-meta ' + statusClass + '"><span class="material-icons">check_circle</span>' + escapeHtml(item.status) + '</div>';
      }
      if (item.assignee) {
        html += '<div class="activity-meta"><span class="material-icons">person</span>' + escapeHtml(item.assignee) + '</div>';
      }
    }
    if (item.type === 'story' && item.status) {
      html += '<div class="activity-meta"><span class="material-icons">label</span>' + escapeHtml(item.status) + '</div>';
    }
    if (item.type === 'milestone' && item.phase) {
      html += '<div class="activity-meta"><span class="material-icons">trending_up</span>' + escapeHtml(item.phase) + '</div>';
    }
    if (item.type === 'update' && item.source) {
      html += '<div class="activity-meta"><span class="material-icons">source</span>' + escapeHtml(item.source) + '</div>';
    }

    html += '</div>';
    html += '</div>';
    return html;
  }

  function toggleExtendedUpdates() {
    var extended = document.getElementById('extendedUpdates');
    var btn = document.querySelector('.updates-see-more-btn');
    if (extended && btn) {
      extended.classList.toggle('collapsed');
      var isCollapsed = extended.classList.contains('collapsed');
      var icon = btn.querySelector('.see-more-icon');
      if (icon) {
        icon.style.transform = isCollapsed ? 'rotate(0deg)' : 'rotate(180deg)';
      }
      btn.innerHTML = isCollapsed
        ? '<span class="material-icons">expand_more</span>See more (' + extended.children.length + ' updates from past 6 months)'
        : '<span class="material-icons">expand_less</span>Show less';
}
  }

  function toggleStatusSummary() {
    var truncated = document.getElementById('statusTruncated');
    var full = document.getElementById('statusFull');
    var btn = document.querySelector('.status-see-more-btn');
    if (truncated && full && btn) {
      var isExpanded = !full.classList.contains('collapsed');
      if (isExpanded) {
        // Collapse
        full.classList.add('collapsed');
        truncated.style.display = 'block';
        btn.innerHTML = '<span class="material-icons">expand_more</span>See more';
      } else {
        // Expand
        full.classList.remove('collapsed');
        truncated.style.display = 'none';
        btn.innerHTML = '<span class="material-icons">expand_less</span>Show less';
      }
}
  }

  function closeModal(event) {
    window.closeModal('solutionModal', event);
  }

  function syncSolutions() { loadSolutions(); }

  function getCycleYear(cycle) {
    var years = { '1': '2016', '2': '2018', '3': '2020', '4': '2022', '5': '2024', '6': '2026' };
    return years[String(cycle)] || '';
  }

  function getPhaseClass(phase) {
    if (!phase) return 'phase-unknown';
    var p = phase.toLowerCase();
    if (p.includes('pre-formulation')) return 'phase-pre-formulation';
    if (p.includes('formulation')) return 'phase-formulation';
    if (p.includes('implementation')) return 'phase-implementation';
    if (p.includes('operational') || p.includes('production')) return 'phase-operational';
    if (p.includes('complete')) return 'phase-completed';
    return 'phase-unknown';
  }

  function truncateText(text, maxLength) {
    if (!text) return '';
    text = text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength).trim() + '...';
  }

  // escapeHtml() - uses global from index.html

  function viewSolutionContacts(solutionName) {
    // Store solution filter in sessionStorage for Contacts page to read
    sessionStorage.setItem('contactsSolutionFilter', solutionName);
    // Close modal and navigate to contacts
    closeModal();
    navigateTo('contacts');
  }

  function showContactDetail(nameOrId, fallbackName) {
    if (!nameOrId) return;
    var modal = document.getElementById('contactDetailModal');
    var body = document.getElementById('contactModalBody');
    body.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span> Looking up contact...</div>';
    modal.classList.add('active');

    if (nameOrId.indexOf('CON_') === 0) {
      // Look up by contact_id
      var titleEl = document.getElementById('contactDetailModalTitle');
      titleEl.textContent = fallbackName || 'Loading...';
      google.script.run
        .withSuccessHandler(function(contact) {
          if (!contact) {
            // CON_ ID not found  fall back to name-based lookup
            if (fallbackName) {
              lookupContactByName_(fallbackName, body);
              return;
            }
            body.innerHTML = '<p class="text-muted">Contact not found.</p>';
            return;
          }
          var displayName = (contact.first_name || '') + ' ' + (contact.last_name || '');
          titleEl.textContent = displayName;
          renderContactDetailBody_(contact, [contact], body);
        })
        .withFailureHandler(function(error) {
          // API error  fall back to name-based lookup
          if (fallbackName) {
            lookupContactByName_(fallbackName, body);
            return;
          }
          body.innerHTML = '<p class="text-muted">Could not load contact details.</p>';
        })
        .getContactById(nameOrId);
    } else {
      // Name-based lookup
      document.getElementById('contactDetailModalTitle').textContent = nameOrId;
      lookupContactByName_(nameOrId, body);
    }
  }

  function lookupContactByName_(name, body) {
    document.getElementById('contactDetailModalTitle').textContent = name;
    var parts = name.trim().split(/\s+/);
    var firstName = parts[0] || '';
    var lastName = parts.length > 1 ? parts[parts.length - 1] : '';

    google.script.run
      .withSuccessHandler(function(contacts) {
        if (!contacts || !contacts.length) {
          body.innerHTML = '<p class="text-muted">Contact "' + escapeHtml(name) + '" not found in the database.</p>';
          return;
        }
        renderContactDetailBody_(contacts[0], contacts, body);
      })
      .withFailureHandler(function(error) {
        body.innerHTML = '<p class="text-muted">Could not look up contact.</p>';
      })
      .getContactsByName(firstName, lastName);
  }

  function renderContactDetailBody_(contact, allRecords, body) {
    var initials = ((contact.first_name || '')[0] || '') + ((contact.last_name || '')[0] || '');
    var html = '<div class="contact-detail-header" style="display:flex; gap:var(--space-md); align-items:center; margin-bottom:var(--space-md);">';
    html += '<div style="width:48px; height:48px; border-radius:50%; background:var(--page-accent); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:16px;">' + initials.toUpperCase() + '</div>';
    html += '<div>';
    html += '<div style="font-weight:600; font-size:var(--font-size-lg);">' + escapeHtml((contact.first_name || '') + ' ' + (contact.last_name || '')) + '</div>';
    if (contact.title) html += '<div style="color:var(--color-text-muted);">' + escapeHtml(contact.title) + '</div>';
    html += '</div></div>';

    var solutions = [];
    var roles = [];
    allRecords.forEach(function(c) {
      if (c.solution_id && !solutions.includes(c.solution_id)) solutions.push(c.solution_id);
      if (c.role && !roles.includes(c.role)) roles.push(c.role);
    });

    html += '<div class="detail-section" style="display:grid; grid-template-columns:1fr 1fr; gap:var(--space-sm);">';
    if (contact.contact_id) html += '<div><span class="detail-label">Contact ID</span><div>' + escapeHtml(contact.contact_id) + '</div></div>';
    if (contact.email) html += '<div><span class="detail-label">Email</span><div><a href="mailto:' + escapeHtml(contact.email) + '">' + escapeHtml(contact.email) + '</a></div></div>';
    if (contact.department) html += '<div><span class="detail-label">Department</span><div>' + escapeHtml(contact.department) + '</div></div>';
    if (contact.agency) html += '<div><span class="detail-label">Agency</span><div>' + escapeHtml(contact.agency) + '</div></div>';
    if (contact.organization) html += '<div><span class="detail-label">Organization</span><div>' + escapeHtml(contact.organization) + '</div></div>';
    if (roles.length) html += '<div><span class="detail-label">Roles</span><div>' + escapeHtml(roles.join(', ')) + '</div></div>';
    if (solutions.length) html += '<div style="grid-column: 1 / -1;"><span class="detail-label">Solutions (' + solutions.length + ')</span><div>' + escapeHtml(solutions.join(', ')) + '</div></div>';
    html += '</div>';

    body.innerHTML = html;
  }

  function closeContactModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('contactDetailModal').classList.remove('active');
  }

  function escapeAttr(text) {
    if (!text) return '';
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function showError(message) {
    var container = document.getElementById('solutionsContainer');
    container.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>' + escapeHtml(message) + '</p></div>';
  }

  // ============================================================================
  // TEAM FOLDER UPLOAD FUNCTIONALITY
  // ============================================================================

  var uploadState = {
    solutionId: null,
    folderId: null,
    files: []
  };

  function openUploadModal(solutionId, folderUrl) {
    // Extract folder ID from URL
    // Handles: https://drive.google.com/drive/folders/FOLDER_ID
    var folderId = extractFolderId(folderUrl);
    if (!folderId) {
      showError('Invalid team folder URL configured for this solution.');
      return;
    }

    uploadState.solutionId = solutionId;
    uploadState.folderId = folderId;
    uploadState.files = [];

    // Reset UI
    document.getElementById('uploadSolutionName').textContent = solutionId.toUpperCase();
    document.getElementById('openDriveLink').href = folderUrl;
    document.getElementById('uploadDropzone').style.display = 'block';
    document.getElementById('uploadFileList').style.display = 'none';
    document.getElementById('uploadStatus').style.display = 'none';
    document.getElementById('uploadSuccess').style.display = 'none';
    document.getElementById('uploadError').style.display = 'none';
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('uploadBtnText').textContent = 'Upload Files';
    document.getElementById('fileInput').value = '';

    // Show modal
    document.getElementById('uploadModal').classList.add('active');

    // Setup drag-and-drop
    setupDropzone();
  }

  function extractFolderId(url) {
    if (!url) return null;
    // Handle direct folder ID
    if (!url.includes('/')) return url;
    // Handle URLs like: https://drive.google.com/drive/folders/1abc123xyz
    var match = url.match(/folders\/([a-zA-Z0-9_-]+)/);
    return match ? match[1] : null;
  }

  function setupDropzone() {
    var dropzone = document.getElementById('uploadDropzone');

    dropzone.ondragenter = function(e) {
      e.preventDefault();
      dropzone.classList.add('drag-active');
    };

    dropzone.ondragover = function(e) {
      e.preventDefault();
      dropzone.classList.add('drag-active');
    };

    dropzone.ondragleave = function(e) {
      e.preventDefault();
      // Only remove class if leaving the dropzone itself
      if (e.target === dropzone) {
        dropzone.classList.remove('drag-active');
      }
    };

    dropzone.ondrop = function(e) {
      e.preventDefault();
      dropzone.classList.remove('drag-active');
      var files = e.dataTransfer.files;
      addFilesToUpload(files);
    };
  }

  function handleFileSelect(event) {
    var files = event.target.files;
    addFilesToUpload(files);
  }

  function addFilesToUpload(files) {
    for (var i = 0; i < files.length; i++) {
      var file = files[i];
      // Check for duplicates
      var exists = uploadState.files.some(function(f) { return f.name === file.name; });
      if (!exists) {
        uploadState.files.push(file);
      }
    }
    updateFileList();
  }

  function updateFileList() {
    var listContainer = document.getElementById('uploadFileList');
    var listItems = document.getElementById('fileListItems');

    if (uploadState.files.length === 0) {
      listContainer.style.display = 'none';
      document.getElementById('uploadBtn').disabled = true;
      return;
    }

    listContainer.style.display = 'block';
    document.getElementById('uploadBtn').disabled = false;

    var html = '';
    uploadState.files.forEach(function(file, index) {
      html += '<div class="file-item">';
      html += '<span class="material-icons">' + getFileIcon(file.type) + '</span>';
      html += '<span class="file-item-name">' + escapeHtml(file.name) + '</span>';
      html += '<span class="file-item-size">' + formatFileSize(file.size) + '</span>';
      html += '<button class="file-item-remove" onclick="Implementation.removeUploadFile(' + index + ')">';
      html += '<span class="material-icons">close</span>';
      html += '</button>';
      html += '</div>';
    });
    listItems.innerHTML = html;
  }

  function getFileIcon(mimeType) {
    if (!mimeType) return 'insert_drive_file';
    if (mimeType.includes('image')) return 'image';
    if (mimeType.includes('pdf')) return 'picture_as_pdf';
    if (mimeType.includes('spreadsheet') || mimeType.includes('excel')) return 'table_chart';
    if (mimeType.includes('document') || mimeType.includes('word')) return 'description';
    if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return 'slideshow';
    return 'insert_drive_file';
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    var k = 1024;
    var sizes = ['B', 'KB', 'MB', 'GB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  function removeUploadFile(index) {
    uploadState.files.splice(index, 1);
    updateFileList();
  }

  function clearUploadFiles() {
    uploadState.files = [];
    updateFileList();
  }

  function uploadFiles() {
    if (uploadState.files.length === 0) return;

    // Show progress
    document.getElementById('uploadDropzone').style.display = 'none';
    document.getElementById('uploadFileList').style.display = 'none';
    document.getElementById('uploadStatus').style.display = 'block';
    document.getElementById('uploadSuccess').style.display = 'none';
    document.getElementById('uploadError').style.display = 'none';
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('uploadBtnText').textContent = 'Uploading...';

    var totalFiles = uploadState.files.length;
    var uploadedCount = 0;
    var failedFiles = [];

    // Upload files sequentially
    function uploadNext(index) {
      if (index >= totalFiles) {
        // All done
        if (failedFiles.length === 0) {
          showUploadSuccess();
        } else {
          showUploadError('Failed to upload: ' + failedFiles.join(', '));
        }
        return;
      }

      var file = uploadState.files[index];
      var progressPercent = Math.round((index / totalFiles) * 100);
      document.getElementById('uploadProgressBar').style.width = progressPercent + '%';
      document.getElementById('uploadStatusText').textContent = 'Uploading ' + (index + 1) + ' of ' + totalFiles + ': ' + file.name;

      // Read file as base64
      var reader = new FileReader();
      reader.onload = function(e) {
        var base64Data = e.target.result.split(',')[1]; // Remove data:mime;base64, prefix

        google.script.run
          .withSuccessHandler(function(result) {
            if (result && result.success) {
              uploadedCount++;
            } else {
              failedFiles.push(file.name);
            }
            uploadNext(index + 1);
          })
          .withFailureHandler(function(error) {
            console.error('Upload failed for ' + file.name + ':', error);
            failedFiles.push(file.name);
            uploadNext(index + 1);
          })
          .uploadFileToTeamFolder(uploadState.folderId, file.name, base64Data, file.type, uploadState.solutionId);
      };

      reader.onerror = function() {
        failedFiles.push(file.name);
        uploadNext(index + 1);
      };

      reader.readAsDataURL(file);
    }

    uploadNext(0);
  }

  function showUploadSuccess() {
    document.getElementById('uploadStatus').style.display = 'none';
    document.getElementById('uploadSuccess').style.display = 'block';
    document.getElementById('uploadProgressBar').style.width = '100%';
    document.getElementById('uploadBtn').style.display = 'none';
  }

  function showUploadError(message) {
    document.getElementById('uploadStatus').style.display = 'none';
    document.getElementById('uploadError').style.display = 'block';
    document.getElementById('uploadErrorText').textContent = message;
    document.getElementById('uploadBtn').disabled = false;
    document.getElementById('uploadBtnText').textContent = 'Retry';
  }

  function closeUploadModal(event) {
    if (!event || event.target === document.getElementById('uploadModal')) {
      document.getElementById('uploadModal').classList.remove('active');
      uploadState.files = [];
    }
  }

  // Close picker when clicking outside (only if picker exists and is open)
  document.addEventListener('click', function(e) {
    var picker = document.getElementById('solutionPickerDropdown');
    var btn = document.getElementById('solutionPickerBtn');
    // Only process if picker exists, is open, and click is outside
    if (picker && picker.classList.contains('active') && btn &&
        !picker.contains(e.target) && !btn.contains(e.target)) {
      closeSolutionPicker();
    }
  });

  function toggleActivityDesc(itemId) {
    var shortEl = document.getElementById(itemId + '-short');
    var fullEl = document.getElementById(itemId + '-full');
    if (shortEl && fullEl) {
      if (shortEl.style.display === 'none') {
        shortEl.style.display = '';
        fullEl.style.display = 'none';
      } else {
        shortEl.style.display = 'none';
        fullEl.style.display = '';
      }
    }
  }

  function toggleStakeholderNames() {
    var shortEl = document.getElementById('stakeholder-names-short');
    var fullEl = document.getElementById('stakeholder-names-full');
    if (shortEl && fullEl) {
      if (shortEl.style.display === 'none') {
        shortEl.style.display = '';
        fullEl.style.display = 'none';
      } else {
        shortEl.style.display = 'none';
        fullEl.style.display = '';
      }
    }
  }

  return {
    init: init,
    loadSolutions: loadSolutions,
    applyFilters: applyFilters,
    clearFilters: clearFilters,
    toggleCycle: toggleCycle,
    showDetail: showDetail,
    closeModal: closeModal,
    syncSolutions: syncSolutions,
    toggleSolutionPicker: toggleSolutionPicker,
    onSolutionToggle: onSolutionToggle,
    selectActiveSolutions: selectActiveSolutions,
    selectAllSolutions: selectAllSolutions,
    clearSolutionSelection: clearSolutionSelection,
    toggleExtendedUpdates: toggleExtendedUpdates,
    toggleStatusSummary: toggleStatusSummary,
    toggleCollapsibleSection: toggleCollapsibleSection,
    toggleActivityDesc: toggleActivityDesc,
    toggleStakeholderNames: toggleStakeholderNames,
    viewSolutionContacts: viewSolutionContacts,
    showContactDetail: showContactDetail,
    closeContactModal: closeContactModal,
    // Team folder upload
    openUploadModal: openUploadModal,
    closeUploadModal: closeUploadModal,
    handleFileSelect: handleFileSelect,
    removeUploadFile: removeUploadFile,
    clearUploadFiles: clearUploadFiles,
    uploadFiles: uploadFiles
  };
})();

// Initialize  queued so CachedAPI is available (defined in index.html main script)
queuePageInit(function() { Implementation.init(); });
</script>
