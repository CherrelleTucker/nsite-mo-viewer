<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base target="_top">
  <title>NSITE MO Viewer</title>

  <!-- Favicon - hosted on GitHub (also set via setFaviconUrl in Code.gs) -->
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/CherrelleTucker/nsite-mo-viewer/main/favicon.png">
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/CherrelleTucker/nsite-mo-viewer/main/favicon.png">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/CherrelleTucker/nsite-mo-viewer/main/favicon.png">

  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Platform Styles (inline for Apps Script) -->
  <?!= include('styles'); ?>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1 class="logo">
        <span class="material-icons">grid_view</span>
        NSITE MO Viewer
      </h1>
    </div>
    <div class="header-right">
      <button class="btn-icon search-trigger" onclick="openGlobalSearch()" title="Search (Ctrl+K)">
        <span class="material-icons">search</span>
      </button>
      <span class="date-display" id="dateDisplay"></span>
    </div>
  </header>

  <!-- Global Search Modal -->
  <div class="search-modal-overlay" id="searchModal" onclick="closeGlobalSearch(event)">
    <div class="search-modal" onclick="event.stopPropagation()">
      <div class="search-input-wrapper">
        <span class="material-icons">search</span>
        <input type="text" id="globalSearchInput" placeholder="Search solutions, contacts, actions..."
               onkeyup="handleSearchInput(event)" autocomplete="off">
        <button class="search-close-btn" onclick="closeGlobalSearch()" title="Close (Esc)">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="search-results" id="searchResults">
        <div class="search-hint">
          <p>Start typing to search across all data</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <?!= include('navigation'); ?>

  <!-- Main Content Area -->
  <main class="main-content">
    <div class="content-wrapper" id="contentArea">
      <? if (activePage === 'implementation') { ?>
        <?!= include('implementation'); ?>
      <? } else if (activePage === 'sep') { ?>
        <?!= include('sep'); ?>
      <? } else if (activePage === 'comms') { ?>
        <?!= include('comms'); ?>
      <? } else if (activePage === 'quick-update') { ?>
        <?!= include('quick-update'); ?>
      <? } else if (activePage === 'contacts') { ?>
        <?!= include('contacts'); ?>
      <? } else if (activePage === 'schedule') { ?>
        <?!= include('schedule'); ?>
      <? } else if (activePage === 'reports') { ?>
        <?!= include('reports'); ?>
      <? } else if (activePage === 'actions') { ?>
        <?!= include('actions'); ?>
      <? } else if (activePage === 'team') { ?>
        <?!= include('team'); ?>
      <? } else if (activePage === 'about') { ?>
        <?!= include('about'); ?>
      <? } else { ?>
        <!-- Placeholder for pages not yet built -->
        <div class="page-placeholder">
          <h2><?= pageConfig ? pageConfig.title : activePage ?>-NSITE</h2>
          <p class="page-description">This viewer is coming soon.</p>
          <div class="placeholder-box">
            <span class="material-icons">build</span>
            <p>Component under development</p>
            <p class="text-sm text-muted mt-md">Use the navigation above to access available features.</p>
          </div>
        </div>
      <? } ?>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <span>NSITE MO Viewer v1.0.0</span>
    <span class="separator">|</span>
    <span id="lastSync">Last sync: --</span>
  </footer>

  <!-- Platform JavaScript -->
  <script>
    // ========================================================================
    // PLATFORM CONFIGURATION
    // ========================================================================

    var Platform = {
      activePage: '<?= activePage ?>',
      baseUrl: '<?= ScriptApp.getService().getUrl() ?>',
      config: null,
      user: null
    };

    // ========================================================================
    // INITIALIZATION
    // ========================================================================

    document.addEventListener('DOMContentLoaded', function() {
      // Load platform config (don't overwrite baseUrl - server value is authoritative)
      google.script.run
        .withSuccessHandler(function(config) {
          Platform.config = config;
        })
        .withFailureHandler(handleError)
        .getPlatformConfig();

      // Load date info
      google.script.run
        .withSuccessHandler(function(dateInfo) {
          document.getElementById('dateDisplay').textContent =
            dateInfo.dayOfWeek + ', ' + dateInfo.formatted;
        })
        .withFailureHandler(handleError)
        .getDateInfo();

      // Update navigation active state
      updateNavActiveState();
    });

    // ========================================================================
    // SPA NAVIGATION (avoids iframe sandbox blank page issue)
    // ========================================================================

    var isNavigating = false;

    /**
     * Navigate to a page using SPA pattern (no full page reload)
     */
    function navigateTo(page) {
      // Prevent double-clicks and multiple navigations
      if (isNavigating) {
        console.log('Navigation already in progress');
        return;
      }

      // Don't navigate to current page
      if (page === Platform.activePage) {
        console.log('Already on page:', page);
        return;
      }

      console.log('SPA navigating to:', page);
      isNavigating = true;

      // Show loading state
      showLoadingState(page);

      // Update browser URL and history (no page reload)
      google.script.history.push(null, {page: page});

      // Load page content dynamically
      loadPageContent(page);
    }

    /**
     * Load page content via google.script.run (SPA style)
     */
    function loadPageContent(page) {
      google.script.run
        .withSuccessHandler(function(html) {
          // Update content area and execute scripts
          setInnerHTMLWithScripts(document.getElementById('contentArea'), html);

          // Update active page
          Platform.activePage = page;

          // Re-initialize Feather icons for new content
// Update nav active state
          updateNavActiveState();

          // Clear loading state
          clearLoadingState();
          isNavigating = false;

          console.log('Page loaded:', page);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load page:', error);
          document.getElementById('contentArea').innerHTML =
            '<div class="page-placeholder"><h2>Error</h2><p>Failed to load page. Please refresh.</p></div>';
          clearLoadingState();
          isNavigating = false;
        })
        .getPageHTML(page);
    }

    /**
     * Set innerHTML and execute any script tags (innerHTML alone won't run scripts)
     */
    function setInnerHTMLWithScripts(element, html) {
      element.innerHTML = html;

      // Find and execute all script tags
      var scripts = element.querySelectorAll('script');
      scripts.forEach(function(oldScript) {
        var newScript = document.createElement('script');

        // Copy attributes
        Array.from(oldScript.attributes).forEach(function(attr) {
          newScript.setAttribute(attr.name, attr.value);
        });

        // Copy content
        newScript.textContent = oldScript.textContent;

        // Replace old script with new one (this executes it)
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });
    }

    /**
     * Initialize page-specific JavaScript after content loads
     */
    function initializePage(page) {
      // Each page may have an init function - call it if exists
      switch(page) {
        case 'implementation':
          if (typeof Implementation !== 'undefined' && Implementation.init) {
            Implementation.init();
          }
          break;
        case 'sep':
          if (typeof SEP !== 'undefined' && SEP.init) {
            SEP.init();
          }
          break;
        case 'contacts':
          if (typeof Contacts !== 'undefined' && Contacts.init) {
            Contacts.init();
          }
          break;
        case 'reports':
          if (typeof Reports !== 'undefined' && Reports.init) {
            Reports.init();
          }
          break;
        case 'schedule':
          if (typeof Schedule !== 'undefined' && Schedule.init) {
            Schedule.init();
          }
          break;
        case 'actions':
          if (typeof Actions !== 'undefined' && Actions.init) {
            Actions.init();
          }
          break;
        case 'quick-update':
          if (typeof QuickUpdate !== 'undefined' && QuickUpdate.init) {
            QuickUpdate.init();
          }
          break;
        // about and comms don't need special init
      }
    }

    /**
     * Handle browser back/forward buttons
     */
    google.script.history.setChangeHandler(function(e) {
      var page = (e.location && e.location.parameter && e.location.parameter.page)
        ? e.location.parameter.page
        : 'implementation';

      console.log('History change, loading:', page);

      if (page !== Platform.activePage) {
        isNavigating = true;
        showLoadingState(page);
        loadPageContent(page);
      }
    });

    /**
     * Show loading state on navigation
     */
    function showLoadingState(page) {
      var clickedTab = document.querySelector('[data-page="' + page + '"]');
      if (clickedTab) {
        clickedTab.classList.add('loading');
      }
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.disabled = true;
      });
    }

    /**
     * Clear loading state after navigation completes
     */
    function clearLoadingState() {
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.disabled = false;
        tab.classList.remove('loading');
      });
    }

    /**
     * Update navigation active state
     */
    function updateNavActiveState() {
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.classList.remove('active');
      });

      var activeTab = document.querySelector('[data-page="' + Platform.activePage + '"]');
      if (activeTab) {
        activeTab.classList.add('active');
      }
    }

    // ========================================================================
    // UI UTILITIES
    // ========================================================================

    /**
     * Show a toast notification
     * @param {string} message - Message to display
     * @param {string} type - 'success' or 'error'
     * @param {number} duration - Time in ms before auto-hide (default 3000)
     */
    function showToast(message, type, duration) {
      type = type || 'success';
      duration = duration || 3000;

      // Remove any existing toasts
      var existing = document.querySelector('.toast');
      if (existing) existing.remove();

      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(function() {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        toast.style.transition = 'all 0.3s ease-out';
        setTimeout(function() { toast.remove(); }, 300);
      }, duration);
    }

    /**
     * Set button loading state
     * @param {HTMLElement} btn - Button element
     * @param {boolean} loading - Whether to show loading state
     */
    function setButtonLoading(btn, loading) {
      if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }

    // ========================================================================
    // GLOBAL SEARCH
    // ========================================================================

    var searchDebounceTimer = null;

    function openGlobalSearch() {
      document.getElementById('searchModal').classList.add('active');
      document.getElementById('globalSearchInput').focus();
      document.getElementById('searchResults').innerHTML =
        '<div class="search-hint"><p>Start typing to search across all data</p></div>';
    }

    function closeGlobalSearch(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('searchModal').classList.remove('active');
      document.getElementById('globalSearchInput').value = '';
    }

    function handleSearchInput(event) {
      // Close on Escape
      if (event.key === 'Escape') {
        closeGlobalSearch();
        return;
      }

      var query = event.target.value.trim();

      // Clear previous timer
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
      }

      // Show hint if empty
      if (!query) {
        document.getElementById('searchResults').innerHTML =
          '<div class="search-hint"><p>Start typing to search across all data</p></div>';
        return;
      }

      // Require at least 2 characters
      if (query.length < 2) {
        document.getElementById('searchResults').innerHTML =
          '<div class="search-hint"><p>Type at least 2 characters to search</p></div>';
        return;
      }

      // Show loading
      document.getElementById('searchResults').innerHTML =
        '<div class="search-loading"><span class="loading-spinner"></span></div>';

      // Debounce search
      searchDebounceTimer = setTimeout(function() {
        performGlobalSearch(query);
      }, 300);
    }

    function performGlobalSearch(query) {
      google.script.run
        .withSuccessHandler(function(results) {
          renderSearchResults(results, query);
        })
        .withFailureHandler(function(error) {
          document.getElementById('searchResults').innerHTML =
            '<div class="search-no-results"><p>Search failed. Please try again.</p></div>';
          console.error('Search error:', error);
        })
        .globalSearch(query);
    }

    function renderSearchResults(results, query) {
      var container = document.getElementById('searchResults');

      if (!results || (results.solutions.length === 0 && results.contacts.length === 0 && results.actions.length === 0)) {
        container.innerHTML = '<div class="search-no-results"><p>No results found for "' + escapeHtml(query) + '"</p></div>';
        return;
      }

      var html = '';

      // Solutions
      if (results.solutions && results.solutions.length > 0) {
        html += '<div class="search-group">';
        html += '<div class="search-group-header">Solutions (' + results.solutions.length + ')</div>';
        results.solutions.forEach(function(sol) {
          html += '<div class="search-result" onclick="goToSearchResult(\'implementation\', \'' + escapeHtml(sol.solution_id || '') + '\')">';
          html += '<span class="material-icons">storage</span>';
          html += '<div class="search-result-content">';
          html += '<div class="search-result-title">' + escapeHtml(sol.short_name || sol.solution_name) + '</div>';
          html += '<div class="search-result-subtitle">' + escapeHtml(sol.lifecycle_phase || '') + ' · ' + escapeHtml(sol.solution_group || '') + '</div>';
          html += '</div>';
          html += '<span class="material-icons search-result-action">chevron_right</span>';
          html += '</div>';
        });
        html += '</div>';
      }

      // Contacts
      if (results.contacts && results.contacts.length > 0) {
        html += '<div class="search-group">';
        html += '<div class="search-group-header">Contacts (' + results.contacts.length + ')</div>';
        results.contacts.forEach(function(contact) {
          html += '<div class="search-result" onclick="goToSearchResult(\'contacts\', \'' + escapeHtml(contact.email || '') + '\')">';
          html += '<span class="material-icons">person</span>';
          html += '<div class="search-result-content">';
          html += '<div class="search-result-title">' + escapeHtml(contact.full_name || contact.first_name + ' ' + contact.last_name) + '</div>';
          html += '<div class="search-result-subtitle">' + escapeHtml(contact.organization || '') + '</div>';
          html += '</div>';
          html += '<span class="material-icons search-result-action">chevron_right</span>';
          html += '</div>';
        });
        html += '</div>';
      }

      // Actions
      if (results.actions && results.actions.length > 0) {
        html += '<div class="search-group">';
        html += '<div class="search-group-header">Actions (' + results.actions.length + ')</div>';
        results.actions.forEach(function(action) {
          html += '<div class="search-result" onclick="goToSearchResult(\'actions\', \'' + escapeHtml(action.action_id || '') + '\')">';
          html += '<span class="material-icons">check_circle</span>';
          html += '<div class="search-result-content">';
          html += '<div class="search-result-title">' + escapeHtml((action.task || '').substring(0, 60)) + '</div>';
          html += '<div class="search-result-subtitle">' + escapeHtml(action.assigned_to || '') + ' · ' + escapeHtml(action.status || '') + '</div>';
          html += '</div>';
          html += '<span class="material-icons search-result-action">chevron_right</span>';
          html += '</div>';
        });
        html += '</div>';
      }

      container.innerHTML = html;
    }

    function goToSearchResult(page, id) {
      closeGlobalSearch();
      // Navigate to page - the page will need to handle highlighting/scrolling to the item
      navigateTo(page);
      // Store search result ID for the page to use
      if (id) {
        sessionStorage.setItem('searchResultId', id);
        sessionStorage.setItem('searchResultPage', page);
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Keyboard shortcut: Ctrl+K or Cmd+K to open search
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openGlobalSearch();
      }
    });

    // ========================================================================
    // ERROR HANDLING
    // ========================================================================

    function handleError(error) {
      console.error('Platform error:', error);
      showToast('An error occurred: ' + (error.message || error), 'error');
    }
  </script>
</body>
</html>
