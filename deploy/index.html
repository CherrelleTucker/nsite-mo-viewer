<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base target="_top">
  <title>NSITE MO Viewer</title>

  <!-- Favicon - hosted on GitHub (also set via setFaviconUrl in Code.gs) -->
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/CherrelleTucker/nsite-mo-viewer/main/favicon.png">
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/CherrelleTucker/nsite-mo-viewer/main/favicon.png">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/CherrelleTucker/nsite-mo-viewer/main/favicon.png">

  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Platform Styles (inline for Apps Script) -->
  <?!= include('styles'); ?>
  <?!= include('shared-page-styles'); ?>

  <!-- Dynamic Branding Colors (overrides defaults from styles.html) -->
  <style>
    :root {
      --color-primary: <?= branding.colors.primary ?>;
      --color-primary-light: <?= branding.colors.primaryLight ?>;
      --color-primary-dark: <?= branding.colors.primaryDark ?>;
      --color-accent: <?= branding.colors.accent ?>;
      --color-implementation: <?= branding.colors.page1 ?>;
      --color-sep: <?= branding.colors.page2 ?>;
      --color-comms: <?= branding.colors.page3 ?>;
    }
  </style>
</head>
<body>
  <!-- Skip to main content link for keyboard users -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1 class="logo">
        <span class="material-icons">grid_view</span>
        <?= branding.appName ?>
      </h1>
      <? if (branding.tagline) { ?>
        <span class="subtitle"><?= branding.tagline ?></span>
      <? } ?>
    </div>
    <div class="header-right">
      <button class="btn-icon search-trigger" onclick="openGlobalSearch()" title="Search (Ctrl+K)">
        <span class="material-icons">search</span>
      </button>
      <span class="date-display" id="dateDisplay"></span>
    </div>
  </header>
  <div class="header-spacer"></div>

  <!-- Global Search Modal -->
  <div class="search-modal-overlay" id="searchModal" onclick="closeGlobalSearch(event)">
    <div class="search-modal" onclick="event.stopPropagation()">
      <div class="search-input-wrapper">
        <span class="material-icons" id="searchIcon">search</span>
        <span class="loading-spinner-sm" id="searchSpinner" style="display:none;"></span>
        <input type="text" id="globalSearchInput" placeholder="Search solutions, contacts, actions..."
               onkeyup="handleSearchInput(event)" autocomplete="off">
        <button class="search-close-btn" onclick="closeGlobalSearch()" title="Close (Esc)">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="search-results" id="searchResults">
        <div class="search-hint">
          <p>Start typing to search across all data</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <?!= includeWithData('navigation', {activePage: activePage, branding: branding}); ?>

  <!-- Core utilities needed by page scripts (must load before page includes) -->
  <script>
    // Platform stub ‚Äî full Platform object defined in main script below
    var Platform = window.Platform || { navigationId: 0 };
    function getNavigationId() { return Platform.navigationId; }
    function isNavigationCurrent(navId) { return navId === Platform.navigationId; }

    // Deferred init queue ‚Äî pages call queuePageInit() instead of directly calling init().
    // The main script block (below content area) flushes this queue after DataCache,
    // CachedAPI, and all other utilities are defined.
    var _pageInitQueue = [];
    function queuePageInit(initFn) {
      if (typeof CachedAPI !== 'undefined') {
        // Main script already loaded ‚Äî run immediately
        initFn();
      } else {
        _pageInitQueue.push(initFn);
      }
    }
  </script>

  <!-- Main Content Area -->
  <main class="main-content" id="main-content">
    <div class="content-wrapper" id="contentArea">
      <? if (activePage === 'implementation') { ?>
        <?!= include('implementation'); ?>
      <? } else if (activePage === 'sep') { ?>
        <?!= include('sep'); ?>
      <? } else if (activePage === 'comms') { ?>
        <?!= include('comms'); ?>
      <? } else if (activePage === 'quick-update') { ?>
        <?!= include('quick-update'); ?>
      <? } else if (activePage === 'contacts') { ?>
        <?!= include('contacts'); ?>
      <? } else if (activePage === 'schedule') { ?>
        <?!= include('schedule'); ?>
      <? } else if (activePage === 'reports') { ?>
        <?!= include('reports'); ?>
      <? } else if (activePage === 'topsheet') { ?>
        <?!= include('topsheet'); ?>
      <? } else if (activePage === 'team') { ?>
        <?!= include('team'); ?>
      <? } else if (activePage === 'about') { ?>
        <?!= include('about'); ?>
      <? } else { ?>
        <!-- Placeholder for pages not yet built -->
        <div class="page-placeholder">
          <h2><?= pageConfig ? pageConfig.title : activePage ?>-NSITE</h2>
          <p class="page-description">This viewer is coming soon.</p>
          <div class="placeholder-box">
            <span class="material-icons">build</span>
            <p>Component under development</p>
            <p class="text-sm text-muted mt-md">Use the navigation above to access available features.</p>
          </div>
        </div>
      <? } ?>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <span><?= branding.appName ?></span>
    <span class="separator">|</span>
    <a href="#" onclick="openFeedbackModal(); return false;" class="footer-link">
      <span class="material-icons" style="font-size: 14px; vertical-align: middle;">feedback</span>
      Report Bug / Suggest Feature
    </a>
  </footer>

  <!-- Feedback Modal -->
  <div class="modal-overlay" id="feedbackModal" role="dialog" aria-modal="true" aria-labelledby="feedbackModalTitle" onclick="closeFeedbackModal(event)">
    <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title" id="feedbackModalTitle">Send Feedback</h2>
        <button class="modal-close" onclick="closeFeedbackModal()" aria-label="Close dialog">&times;</button>
      </div>
      <div class="modal-body">
        <form id="feedbackForm" onsubmit="submitFeedback(event)">
          <div class="form-group">
            <label>Type</label>
            <select id="feedbackType" required onchange="toggleStepsField()">
              <option value="bug">üêõ Bug Report</option>
              <option value="feature">üí° Feature Suggestion</option>
              <option value="other">üí¨ Other Feedback</option>
            </select>
          </div>

          <div class="form-group">
            <label>Current Page</label>
            <input type="text" id="feedbackPage" readonly style="background: var(--color-surface-alt);">
            <input type="hidden" id="feedbackSubpage">
          </div>

          <div class="form-group" id="categoryGroup" style="display:none;">
            <label>Category</label>
            <select id="feedbackCategory">
              <option value="functional">Functional (broken feature)</option>
              <option value="cosmetic">Cosmetic (visual/UI issue)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Description <span style="color: var(--color-error);">*</span></label>
            <textarea id="feedbackDescription" rows="4" required
                      placeholder="Describe the bug or feature..."></textarea>
          </div>

          <div class="form-group" id="stepsGroup" style="display:none;">
            <label>Steps to Reproduce (for bugs)</label>
            <textarea id="feedbackSteps" rows="3"
                      placeholder="1. Go to...&#10;2. Click on...&#10;3. See error..."></textarea>
          </div>

          <div class="form-group">
            <label>Your Name (optional)</label>
            <input type="text" id="feedbackName" placeholder="So I know who to follow up with">
          </div>

          <div style="background: var(--color-surface-alt); padding: var(--space-sm); border-radius: var(--radius-sm); margin-bottom: var(--space-md);">
            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin: 0;">
              <span class="material-icons" style="font-size: 14px; vertical-align: middle;">tips_and_updates</span>
              <strong>Tip:</strong> For bugs, screenshots help! Press <kbd style="background: var(--color-surface); padding: 2px 6px; border-radius: 3px; font-size: 11px;">Win+Shift+S</kbd> to capture and paste in Slack.
            </p>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="feedbackSubmitBtn">
              <span class="material-icons">send</span> Send Feedback
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Platform JavaScript -->
  <script>
    // ========================================================================
    // DATA CACHE - SessionStorage-based caching for API responses
    // ========================================================================

    /**
     * DataCache provides transparent caching for API calls using sessionStorage.
     * Data persists across SPA page navigations but clears when browser closes.
     *
     * Usage:
     *   DataCache.get('solutions', fetchSolutionsFn, 60)
     *     .then(function(data) { ... });
     *
     * Cache invalidation:
     *   DataCache.clear('solutions');  // After saving a solution
     *   DataCache.clearAll();          // Force full refresh
     */
    var DataCache = (function() {
      var CACHE_PREFIX = 'mo_cache_';
      var stats = { hits: 0, misses: 0 };

      /**
       * Get data from cache or fetch fresh
       * @param {string} key - Cache key (e.g., 'solutions', 'contacts')
       * @param {function} fetchFn - Function that returns a Promise with fresh data
       * @param {number} ttlMinutes - Time-to-live in minutes (default: 60)
       * @returns {Promise} Resolves with cached or fresh data
       */
      function get(key, fetchFn, ttlMinutes) {
        ttlMinutes = ttlMinutes || 60;
        var ttlMs = ttlMinutes * 60 * 1000;
        var cacheKey = CACHE_PREFIX + key;

        return new Promise(function(resolve, reject) {
          // Try to get from cache
          try {
            var cached = sessionStorage.getItem(cacheKey);
            if (cached) {
              var parsed = JSON.parse(cached);
              var age = Date.now() - parsed.timestamp;

              // Check if still valid
              if (age < ttlMs) {
                stats.hits++;
                console.log('[DataCache] HIT: ' + key + ' (age: ' + Math.round(age/1000) + 's)');
                resolve(parsed.data);
                return;
              } else {
                console.log('[DataCache] EXPIRED: ' + key + ' (age: ' + Math.round(age/1000) + 's)');
              }
            }
          } catch (e) {
            console.warn('[DataCache] Error reading cache:', e);
          }

          // Cache miss or expired - fetch fresh data
          stats.misses++;
          console.log('[DataCache] MISS: ' + key + ' - fetching fresh data');

          fetchFn()
            .then(function(data) {
              // Store in cache
              try {
                var cacheEntry = {
                  data: data,
                  timestamp: Date.now(),
                  ttl: ttlMs
                };
                sessionStorage.setItem(cacheKey, JSON.stringify(cacheEntry));
                console.log('[DataCache] STORED: ' + key);
              } catch (e) {
                // sessionStorage full or unavailable - continue without caching
                console.warn('[DataCache] Could not store:', e);
              }
              resolve(data);
            })
            .catch(function(error) {
              reject(error);
            });
        });
      }

      /**
       * Clear a specific cache entry
       * Call this after saving/updating data to ensure fresh fetch next time
       * @param {string} key - Cache key to clear
       */
      function clear(key) {
        var cacheKey = CACHE_PREFIX + key;
        sessionStorage.removeItem(cacheKey);
        console.log('[DataCache] CLEARED: ' + key);
      }

      /**
       * Clear all cache entries
       * Call this for "Refresh All" button or after bulk operations
       */
      function clearAll() {
        var keys = Object.keys(sessionStorage);
        var cleared = 0;
        keys.forEach(function(key) {
          if (key.indexOf(CACHE_PREFIX) === 0) {
            sessionStorage.removeItem(key);
            cleared++;
          }
        });
        stats.hits = 0;
        stats.misses = 0;
        console.log('[DataCache] CLEARED ALL: ' + cleared + ' entries');
      }

      /**
       * Get cache statistics for debugging
       * @returns {object} {hits, misses, hitRate, entries}
       */
      function getStats() {
        var entries = [];
        var keys = Object.keys(sessionStorage);
        keys.forEach(function(key) {
          if (key.indexOf(CACHE_PREFIX) === 0) {
            try {
              var parsed = JSON.parse(sessionStorage.getItem(key));
              var age = Date.now() - parsed.timestamp;
              entries.push({
                key: key.replace(CACHE_PREFIX, ''),
                age: Math.round(age / 1000) + 's',
                ttl: Math.round(parsed.ttl / 60000) + 'min',
                expired: age >= parsed.ttl,
                sizeKB: Math.round(sessionStorage.getItem(key).length / 1024)
              });
            } catch (e) {}
          }
        });

        var total = stats.hits + stats.misses;
        return {
          hits: stats.hits,
          misses: stats.misses,
          hitRate: total > 0 ? Math.round((stats.hits / total) * 100) + '%' : 'N/A',
          entries: entries
        };
      }

      /**
       * Check if a key exists in cache and is not expired
       * @param {string} key - Cache key
       * @returns {boolean}
       */
      function has(key) {
        var cacheKey = CACHE_PREFIX + key;
        try {
          var cached = sessionStorage.getItem(cacheKey);
          if (cached) {
            var parsed = JSON.parse(cached);
            return (Date.now() - parsed.timestamp) < parsed.ttl;
          }
        } catch (e) {}
        return false;
      }

      /**
       * Preload multiple cache entries in parallel
       * Useful for warming cache on app startup
       * @param {Array} configs - [{key, fetchFn, ttl}, ...]
       * @returns {Promise} Resolves when all entries are cached
       */
      function preload(configs) {
        var promises = configs.map(function(config) {
          return get(config.key, config.fetchFn, config.ttl);
        });
        return Promise.all(promises);
      }

      // Public API
      return {
        get: get,
        clear: clear,
        clearAll: clearAll,
        getStats: getStats,
        has: has,
        preload: preload
      };
    })();

    // Expose for debugging in browser console
    window.DataCache = DataCache;

    // ========================================================================
    // CACHED API HELPERS - Wrapper functions for common API calls with caching
    // ========================================================================

    /**
     * CachedAPI provides Promise-wrapped versions of google.script.run calls
     * that integrate with DataCache for transparent caching.
     *
     * Usage (in page scripts):
     *   CachedAPI.getSolutions().then(function(data) { ... });
     *   CachedAPI.getContacts().then(function(data) { ... });
     *
     * Force fresh fetch (bypass cache):
     *   CachedAPI.getSolutions(true).then(function(data) { ... });
     */
    var CachedAPI = {
      // Cache TTL configuration (in minutes)
      TTL: {
        solutions: 60,      // Solutions rarely change mid-session
        contacts: 60,       // Contacts are relatively stable
        agencies: 60,       // Agency hierarchy rarely changes
        sepInit: 15,        // SEP data includes recent engagements
        commsOverview: 15,  // Stories/events may update
        commsStories: 15,   // Pipeline stories update during edits
        commsOpportunities: 15, // Story opportunities
        commsCoverage: 15,  // Coverage analysis
        teamMembers: 30,    // Team info moderately stable
        meetings: 30,       // Meeting schedule
        currentUser: 60,    // User info rarely changes
        availability: 30,   // Availability updates moderately
        directingDocs: 60,  // Documents rarely change
        kudos: 30,          // Kudos may be added during session
        kudosStats: 30      // Stats change with kudos
      },

      /**
       * Get all solutions (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getSolutions: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('solutions');
        return DataCache.get('solutions', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getSolutions();
          });
        }, this.TTL.solutions);
      },

      /**
       * Get all unique contacts (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getContacts: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('contacts');
        return DataCache.get('contacts', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getUniqueContacts();
          });
        }, this.TTL.contacts);
      },

      /**
       * Get all contacts (alias for getContacts for compatibility)
       */
      getAllContacts: function(forceRefresh) {
        return this.getContacts(forceRefresh);
      },

      /**
       * Get agency hierarchy (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getAgencies: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('agencies');
        return DataCache.get('agencies', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getAgencyHierarchy();
          });
        }, this.TTL.agencies);
      },

      /**
       * Get SEP init data bundle (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Object>}
       */
      getSEPInitData: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('sepInit');
        return DataCache.get('sepInit', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getSEPInitData();
          });
        }, this.TTL.sepInit);
      },

      /**
       * Get comms overview data (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Object>}
       */
      getCommsOverview: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('commsOverview');
        return DataCache.get('commsOverview', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getCommsOverview();
          });
        }, this.TTL.commsOverview);
      },

      /**
       * Get team members (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getTeamMembers: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('teamMembers');
        return DataCache.get('teamMembers', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getInternalTeamWithProfiles();
          });
        }, this.TTL.teamMembers);
      },

      /**
       * Get all meetings (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getMeetings: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('meetings');
        return DataCache.get('meetings', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getAllMeetings();
          });
        }, this.TTL.meetings);
      },

      /**
       * Get comms pipeline stories (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getCommsStories: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('commsStories');
        return DataCache.get('commsStories', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getPipelineStoriesForUI();
          });
        }, this.TTL.commsStories);
      },

      /**
       * Get comms story opportunities (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getCommsOpportunities: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('commsOpportunities');
        return DataCache.get('commsOpportunities', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .detectStoryOpportunities();
          });
        }, this.TTL.commsOpportunities);
      },

      /**
       * Get comms coverage analysis (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Object>}
       */
      getCommsCoverage: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('commsCoverage');
        return DataCache.get('commsCoverage', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getCoverageAnalysis(90);
          });
        }, this.TTL.commsCoverage);
      },

      /**
       * Get current user info (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Object>}
       */
      getCurrentUser: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('currentUser');
        return DataCache.get('currentUser', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getCurrentUserInfo();
          });
        }, this.TTL.currentUser);
      },

      /**
       * Get team availability (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getAvailability: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('availability');
        return DataCache.get('availability', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getAvailability();
          });
        }, this.TTL.availability);
      },

      /**
       * Get directing documents (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getDirectingDocuments: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('directingDocs');
        return DataCache.get('directingDocs', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getDirectingDocuments();
          });
        }, this.TTL.directingDocs);
      },

      /**
       * Get recent kudos (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Array>}
       */
      getKudos: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('kudos');
        return DataCache.get('kudos', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getAllKudos({ days: 30, limit: 50 });
          });
        }, this.TTL.kudos);
      },

      /**
       * Get kudos statistics (cached)
       * @param {boolean} forceRefresh - Skip cache and fetch fresh
       * @returns {Promise<Object>}
       */
      getKudosStats: function(forceRefresh) {
        if (forceRefresh) DataCache.clear('kudosStats');
        return DataCache.get('kudosStats', function() {
          return new Promise(function(resolve, reject) {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getKudosStats(90);
          });
        }, this.TTL.kudosStats);
      },

      /**
       * Invalidate caches related to a specific data type
       * Call after save/update operations
       */
      invalidate: {
        solutions: function() {
          DataCache.clear('solutions');
          DataCache.clear('sepInit');  // SEP init includes solutions
        },
        contacts: function() {
          DataCache.clear('contacts');
          DataCache.clear('sepInit');  // SEP init may include contact counts
        },
        engagements: function() {
          DataCache.clear('sepInit');  // SEP init includes recent engagements
        },
        comms: function() {
          DataCache.clear('commsOverview');
          DataCache.clear('commsStories');
          DataCache.clear('commsOpportunities');
          DataCache.clear('commsCoverage');
        },
        team: function() {
          DataCache.clear('teamMembers');
          DataCache.clear('availability');
          DataCache.clear('directingDocs');
          DataCache.clear('currentUser');
        },
        kudos: function() {
          DataCache.clear('kudos');
          DataCache.clear('kudosStats');
        },
        all: function() {
          DataCache.clearAll();
        }
      },

      /**
       * Preload commonly used data for faster page switches
       * Call this on app startup or after long idle
       */
      preloadCommon: function() {
        return DataCache.preload([
          { key: 'solutions', fetchFn: function() {
            return new Promise(function(resolve, reject) {
              google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getSolutions();
            });
          }, ttl: CachedAPI.TTL.solutions },
          { key: 'contacts', fetchFn: function() {
            return new Promise(function(resolve, reject) {
              google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getUniqueContacts();
            });
          }, ttl: CachedAPI.TTL.contacts }
        ]);
      }
    };

    // Expose for page scripts
    window.CachedAPI = CachedAPI;

    // ========================================================================
    // PLATFORM CONFIGURATION
    // ========================================================================

    var Platform = {
      activePage: '<?= activePage ?>',
      baseUrl: '<?= ScriptApp.getService().getUrl() ?>',
      config: null,
      user: null,
      sessionToken: null,  // Will be populated from URL on load
      navigationId: 0      // Increments on each navigation, used to abandon stale loads
    };

    // Extract session token from URL on initial load
    // This preserves the session across SPA navigation
    (function() {
      var urlParams = new URLSearchParams(window.location.search);
      var token = urlParams.get('session');
      if (token) {
        Platform.sessionToken = token;
      }
    })();

    // ========================================================================
    // INITIALIZATION
    // ========================================================================

    document.addEventListener('DOMContentLoaded', function() {
      // Load platform config (don't overwrite baseUrl - server value is authoritative)
      google.script.run
        .withSuccessHandler(function(config) {
          Platform.config = config;
        })
        .withFailureHandler(handleError)
        .getPlatformConfig();

      // Load date info
      google.script.run
        .withSuccessHandler(function(dateInfo) {
          document.getElementById('dateDisplay').textContent =
            dateInfo.dayOfWeek + ', ' + dateInfo.formatted;
        })
        .withFailureHandler(handleError)
        .getDateInfo();

      // Update navigation active state
      updateNavActiveState();
    });

    // ========================================================================
    // SPA NAVIGATION (avoids iframe sandbox blank page issue)
    // ========================================================================

    var isNavigating = false;

    /**
     * Navigate to a page using SPA pattern (no full page reload)
     */
    function navigateTo(page) {
      // Don't navigate to current page (but allow if currently navigating - user changed mind)
      if (page === Platform.activePage && !isNavigating) {
        return;
      }

      // Increment navigation ID to invalidate any in-flight loads from previous page
      Platform.navigationId++;
      console.log('[Navigation] Starting navigation #' + Platform.navigationId + ' to ' + page);

      isNavigating = true;

      // Show loading state
      showLoadingState(page);

      // Update browser URL and history (no page reload)
      // IMPORTANT: Include session token to preserve authentication across navigation
      var historyParams = {page: page};
      if (Platform.sessionToken) {
        historyParams.session = Platform.sessionToken;
      }
      google.script.history.push(null, historyParams);

      // Load page content dynamically
      loadPageContent(page);
    }

    /**
     * Check if a navigation is still current (hasn't been superseded)
     * Pages should call this before processing async results
     * @param {number} navId - The navigation ID captured when the load started
     * @returns {boolean} True if this navigation is still current
     */
    function isNavigationCurrent(navId) {
      return navId === Platform.navigationId;
    }

    /**
     * Get the current navigation ID
     * Pages should capture this at init() and check it in async callbacks
     * @returns {number}
     */
    function getNavigationId() {
      return Platform.navigationId;
    }

    /**
     * Load page content via google.script.run (SPA style)
     */
    function loadPageContent(page) {
      google.script.run
        .withSuccessHandler(function(html) {
          // Update content area and execute scripts
          setInnerHTMLWithScripts(document.getElementById('contentArea'), html);

          // Update active page
          Platform.activePage = page;

          // Re-initialize Feather icons for new content
// Update nav active state
          updateNavActiveState();

          // Clear loading state
          clearLoadingState();
          isNavigating = false;
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load page:', error);
          document.getElementById('contentArea').innerHTML =
            '<div class="page-placeholder"><h2>Error</h2><p>Failed to load page. Please refresh.</p></div>';
          clearLoadingState();
          isNavigating = false;
        })
        .getPageHTML(page);
    }

    /**
     * Set innerHTML and execute any script tags (innerHTML alone won't run scripts)
     */
    function setInnerHTMLWithScripts(element, html) {
      element.innerHTML = html;

      // Find and execute all script tags
      var scripts = element.querySelectorAll('script');
      scripts.forEach(function(oldScript) {
        var newScript = document.createElement('script');

        // Copy attributes
        Array.from(oldScript.attributes).forEach(function(attr) {
          newScript.setAttribute(attr.name, attr.value);
        });

        // Copy content
        newScript.textContent = oldScript.textContent;

        // Replace old script with new one (this executes it)
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });
    }

    /**
     * Initialize page-specific JavaScript after content loads
     */
    function initializePage(page) {
      // Each page may have an init function - call it if exists
      switch(page) {
        case 'implementation':
          if (typeof Implementation !== 'undefined' && Implementation.init) {
            Implementation.init();
          }
          break;
        case 'sep':
          if (typeof SEP !== 'undefined' && SEP.init) {
            SEP.init();
          }
          break;
        case 'contacts':
          if (typeof Contacts !== 'undefined' && Contacts.init) {
            Contacts.init();
          }
          break;
        case 'reports':
          if (typeof Reports !== 'undefined' && Reports.init) {
            Reports.init();
          }
          break;
        case 'schedule':
          if (typeof Schedule !== 'undefined' && Schedule.init) {
            Schedule.init();
          }
          break;
        case 'actions':
          // Actions moved to Team page - redirect
          navigateTo('team');
          setTimeout(function() {
            if (typeof Team !== 'undefined' && Team.setView) {
              Team.setView('capacity');
            }
          }, 100);
          break;
        case 'quick-update':
          if (typeof QuickUpdate !== 'undefined' && QuickUpdate.init) {
            QuickUpdate.init();
          }
          break;
        // about and comms don't need special init
      }
    }

    /**
     * Handle browser back/forward buttons
     */
    google.script.history.setChangeHandler(function(e) {
      var page = (e.location && e.location.parameter && e.location.parameter.page)
        ? e.location.parameter.page
        : 'implementation';

      // Preserve session token from history state if available
      if (e.location && e.location.parameter && e.location.parameter.session) {
        Platform.sessionToken = e.location.parameter.session;
      }

      if (page !== Platform.activePage) {
        isNavigating = true;
        showLoadingState(page);
        loadPageContent(page);
      }
    });

    /**
     * Show loading state on navigation
     */
    function showLoadingState(page) {
      var clickedTab = document.querySelector('[data-page="' + page + '"]');
      if (clickedTab) {
        clickedTab.classList.add('loading');
      }
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.disabled = true;
      });
    }

    /**
     * Clear loading state after navigation completes
     */
    function clearLoadingState() {
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.disabled = false;
        tab.classList.remove('loading');
      });
    }

    /**
     * Update navigation active state
     */
    function updateNavActiveState() {
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.classList.remove('active');
      });

      var activeTab = document.querySelector('[data-page="' + Platform.activePage + '"]');
      if (activeTab) {
        activeTab.classList.add('active');
      }
    }

    // ========================================================================
    // UI UTILITIES
    // ========================================================================

    /**
     * Show a toast notification
     * @param {string} message - Message to display
     * @param {string} type - 'success' or 'error'
     * @param {number} duration - Time in ms before auto-hide (default 3000)
     */
    function showToast(message, type, duration) {
      type = type || 'success';
      duration = duration || 3000;

      // Remove any existing toasts
      var existing = document.querySelector('.toast');
      if (existing) existing.remove();

      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(function() {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        toast.style.transition = 'all 0.3s ease-out';
        setTimeout(function() { toast.remove(); }, 300);
      }, duration);
    }

    /**
     * Set button loading state
     * @param {HTMLElement} btn - Button element
     * @param {boolean} loading - Whether to show loading state
     */
    function setButtonLoading(btn, loading) {
      if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }

    /**
     * Close a modal by ID
     * @param {string} modalId - The ID of the modal element
     * @param {Event} event - Optional click event (closes only if clicking overlay)
     */
    function closeModal(modalId, event) {
      var modal = document.getElementById(modalId);
      if (!modal) return;
      if (!event || event.target === modal) {
        modal.classList.remove('active');
        modal.classList.remove('show');
      }
    }

    /**
     * Close any open modal (for Escape key handling)
     */
    function closeActiveModal() {
      // Check for modals with 'active' class
      var activeModal = document.querySelector('.modal.active, .modal-overlay.active');
      if (activeModal) {
        activeModal.classList.remove('active');
        return true;
      }
      // Check for modals with 'show' class (team.html pattern)
      var showModal = document.querySelector('.modal.show');
      if (showModal) {
        showModal.classList.remove('show');
        return true;
      }
      return false;
    }

    // Global Escape key handler for modals
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeActiveModal();
      }
    });

    // ========================================================================
    // DATE UTILITIES
    // ========================================================================

    /**
     * Format a date string for display (short format without year)
     * @param {string} dateStr - Date string (ISO format or other)
     * @returns {string} Formatted date like "Jan 29" or "--" if empty
     */
    function formatDateShort(dateStr) {
      if (!dateStr) return '--';
      // Handle ISO dates by extracting just the date part to avoid timezone issues
      var dateOnly = String(dateStr).split('T')[0];
      var parts = dateOnly.split('-');
      if (parts.length === 3) {
        var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
      // Fallback for other formats
      var date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    /**
     * Format a date string for display (full format with year)
     * @param {string} dateStr - Date string (ISO format or other)
     * @returns {string} Formatted date like "Jan 29, 2026" or "" if empty
     */
    function formatDateFull(dateStr) {
      if (!dateStr) return '';
      var dateOnly = String(dateStr).split('T')[0];
      var parts = dateOnly.split('-');
      if (parts.length === 3) {
        var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }
      var date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    /**
     * Format a date string for HTML date input (YYYY-MM-DD)
     * @param {string} dateStr - Date string (ISO format or other)
     * @returns {string} Formatted date like "2026-01-29" or "" if empty
     */
    function formatDateForInput(dateStr) {
      if (!dateStr) return '';

      // Handle string dates
      var str = String(dateStr);

      // If it's already YYYY-MM-DD format, return it directly
      var dateOnly = str.split('T')[0];
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateOnly)) {
        return dateOnly;
      }

      // Try parsing as date and extract local date components
      // This avoids timezone conversion issues with toISOString()
      try {
        var d = new Date(dateStr);
        if (isNaN(d.getTime())) return '';

        var year = d.getFullYear();
        var month = String(d.getMonth() + 1).padStart(2, '0');
        var day = String(d.getDate()).padStart(2, '0');
        return year + '-' + month + '-' + day;
      } catch (e) {
        return '';
      }
    }

    // ========================================================================
    // GLOBAL SEARCH
    // ========================================================================

    var searchDebounceTimer = null;

    function openGlobalSearch() {
      document.getElementById('searchModal').classList.add('active');
      document.getElementById('globalSearchInput').focus();
      document.getElementById('searchResults').innerHTML =
        '<div class="search-hint"><p>Start typing to search across all data</p></div>';
    }

    function closeGlobalSearch(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('searchModal').classList.remove('active');
      document.getElementById('globalSearchInput').value = '';
      document.getElementById('searchIcon').style.display = 'inline';
      document.getElementById('searchSpinner').style.display = 'none';
    }

    function handleSearchInput(event) {
      // Close on Escape
      if (event.key === 'Escape') {
        closeGlobalSearch();
        return;
      }

      var query = event.target.value.trim();

      // Clear previous timer
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
      }

      // Show hint if empty
      if (!query) {
        document.getElementById('searchIcon').style.display = 'inline';
        document.getElementById('searchSpinner').style.display = 'none';
        document.getElementById('searchResults').innerHTML =
          '<div class="search-hint"><p>Start typing to search across all data</p></div>';
        return;
      }

      // Require at least 2 characters
      if (query.length < 2) {
        document.getElementById('searchIcon').style.display = 'inline';
        document.getElementById('searchSpinner').style.display = 'none';
        document.getElementById('searchResults').innerHTML =
          '<div class="search-hint"><p>Type at least 2 characters to search</p></div>';
        return;
      }

      // Show loading
      document.getElementById('searchIcon').style.display = 'none';
      document.getElementById('searchSpinner').style.display = 'inline-block';
      document.getElementById('searchResults').innerHTML = '';

      // Debounce search
      searchDebounceTimer = setTimeout(function() {
        performGlobalSearch(query);
      }, 300);
    }

    function performGlobalSearch(query) {
      google.script.run
        .withSuccessHandler(function(results) {
          document.getElementById('searchIcon').style.display = 'inline';
          document.getElementById('searchSpinner').style.display = 'none';
          renderSearchResults(results, query);
        })
        .withFailureHandler(function(error) {
          document.getElementById('searchIcon').style.display = 'inline';
          document.getElementById('searchSpinner').style.display = 'none';
          document.getElementById('searchResults').innerHTML =
            '<div class="search-no-results"><p>Search failed. Please try again.</p></div>';
          console.error('Search error:', error);
        })
        .globalSearch(query);
    }

    var SEARCH_INITIAL_SHOW = 5;
    var SEARCH_SHOW_MORE = 10;

    function renderSearchResults(results, query) {
      var container = document.getElementById('searchResults');

      if (!results || (results.solutions.length === 0 && results.contacts.length === 0 && results.actions.length === 0)) {
        container.innerHTML = '<div class="search-no-results"><p>No results found for "' + escapeHtml(query) + '"</p></div>';
        return;
      }

      // Store results globally for "show more" functionality
      window.searchResultsData = results;

      var html = '<ul class="search-list">';

      // Solutions
      if (results.solutions && results.solutions.length > 0) {
        html += '<li class="search-group-title">Solutions (' + results.solutions.length + ')</li>';
        html += renderGroupItems(results.solutions, 'solutions', SEARCH_INITIAL_SHOW);
      }

      // Contacts
      if (results.contacts && results.contacts.length > 0) {
        html += '<li class="search-group-title">Contacts (' + results.contacts.length + ')</li>';
        html += renderGroupItems(results.contacts, 'contacts', SEARCH_INITIAL_SHOW);
      }

      // Actions
      if (results.actions && results.actions.length > 0) {
        html += '<li class="search-group-title">Actions (' + results.actions.length + ')</li>';
        html += renderGroupItems(results.actions, 'actions', SEARCH_INITIAL_SHOW);
      }

      html += '</ul>';
      container.innerHTML = html;
    }

    function renderGroupItems(items, groupType, showCount) {
      var html = '';
      var visibleItems = items.slice(0, showCount);
      var hiddenCount = items.length - showCount;

      visibleItems.forEach(function(item, index) {
        html += renderSearchItem(item, groupType, index);
      });

      if (hiddenCount > 0) {
        html += '<li class="search-show-more" onclick="showMoreResults(\'' + groupType + '\', ' + showCount + ')">';
        html += 'Show ' + Math.min(hiddenCount, SEARCH_SHOW_MORE) + ' more...';
        if (hiddenCount > SEARCH_SHOW_MORE) html += ' (' + hiddenCount + ' remaining)';
        html += '</li>';
      }

      return html;
    }

    function renderSearchItem(item, groupType, index) {
      var html = '';
      if (groupType === 'solutions') {
        var label = escapeHtml(item.solution_id || item.core_official_name);
        var subtitle = [item.admin_lifecycle_phase, item.core_group].filter(Boolean).join(' ¬∑ ');
        if (subtitle) label += ' <span class="search-item-meta">(' + escapeHtml(subtitle) + ')</span>';
        html = '<li class="search-item" data-group="solutions" data-index="' + index + '" onclick="goToSearchResult(\'implementation\', \'' + escapeHtml(item.solution_id || '') + '\')">' + label + '</li>';
      } else if (groupType === 'contacts') {
        var name = escapeHtml(item.full_name || (item.first_name + ' ' + item.last_name));
        if (item.organization) name += ' <span class="search-item-meta">(' + escapeHtml(item.organization) + ')</span>';
        html = '<li class="search-item" data-group="contacts" data-index="' + index + '" onclick="goToSearchResult(\'contacts\', \'' + escapeHtml(item.email || '') + '\')">' + name + '</li>';
      } else if (groupType === 'actions') {
        var task = escapeHtml((item.task || '').substring(0, 80));
        var meta = [item.assigned_to, item.status].filter(Boolean).join(' ¬∑ ');
        if (meta) task += ' <span class="search-item-meta">(' + escapeHtml(meta) + ')</span>';
        html = '<li class="search-item" data-group="actions" data-index="' + index + '" onclick="goToSearchResult(\'actions\', \'' + escapeHtml(item.action_id || '') + '\')">' + task + '</li>';
      }
      return html;
    }

    function showMoreResults(groupType, currentCount) {
      var items = window.searchResultsData[groupType];
      var newCount = currentCount + SEARCH_SHOW_MORE;

      // Find and replace the group's items
      var showMoreBtn = document.querySelector('.search-show-more[onclick*="' + groupType + '"]');
      if (!showMoreBtn) return;

      var newHtml = '';
      var visibleItems = items.slice(currentCount, newCount);
      visibleItems.forEach(function(item, i) {
        newHtml += renderSearchItem(item, groupType, currentCount + i);
      });

      var hiddenCount = items.length - newCount;
      if (hiddenCount > 0) {
        newHtml += '<li class="search-show-more" onclick="showMoreResults(\'' + groupType + '\', ' + newCount + ')">';
        newHtml += 'Show ' + Math.min(hiddenCount, SEARCH_SHOW_MORE) + ' more...';
        if (hiddenCount > SEARCH_SHOW_MORE) newHtml += ' (' + hiddenCount + ' remaining)';
        newHtml += '</li>';
      }

      showMoreBtn.insertAdjacentHTML('beforebegin', newHtml);
      showMoreBtn.remove();
    }

    function goToSearchResult(page, id) {
      closeGlobalSearch();
      // Navigate to page - the page will need to handle highlighting/scrolling to the item
      navigateTo(page);
      // Store search result ID for the page to use
      if (id) {
        sessionStorage.setItem('searchResultId', id);
        sessionStorage.setItem('searchResultPage', page);
      }
    }

    // Note: escapeHtml is defined globally below (line ~766)

    // Keyboard shortcut: Ctrl+K or Cmd+K to open search
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openGlobalSearch();
      }
    });

    // ========================================================================
    // CSV EXPORT UTILITY
    // ========================================================================

    /**
     * Export data to CSV file
     * @param {Array} data - Array of objects to export
     * @param {Array} columns - Column definitions [{key: 'field', label: 'Header'}]
     * @param {string} filename - Output filename (without .csv)
     */
    function exportToCSV(data, columns, filename) {
      if (!data || data.length === 0) {
        showToast('No data to export', 'error');
        return;
      }

      // Build header row
      var csv = columns.map(function(col) {
        return '"' + col.label + '"';
      }).join(',') + '\n';

      // Build data rows
      data.forEach(function(row) {
        var values = columns.map(function(col) {
          var val = row[col.key];
          if (val === null || val === undefined) val = '';
          // Escape quotes and wrap in quotes
          return '"' + String(val).replace(/"/g, '""') + '"';
        });
        csv += values.join(',') + '\n';
      });

      // Download
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Exported ' + data.length + ' rows to ' + filename + '.csv', 'success');
    }

    // ========================================================================
    // STRING UTILITIES
    // ========================================================================

    function capitalizeFirst(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // ========================================================================
    // ERROR HANDLING
    // ========================================================================

    /**
     * Standard error handler for API calls
     * @param {Error|string} error - The error object or message
     * @param {string} [userMessage] - Optional user-friendly message to display instead
     */
    function handleError(error, userMessage) {
      console.error('Platform error:', error);
      var displayMessage = userMessage || (error && error.message) || String(error) || 'An unexpected error occurred';
      showToast(displayMessage, 'error');
    }

    /**
     * Create a failure handler for google.script.run with custom user message
     * @param {string} userMessage - User-friendly error message
     * @returns {function} Failure handler function
     */
    function createErrorHandler(userMessage) {
      return function(error) {
        handleError(error, userMessage);
      };
    }

    // ========================================================================
    // FEEDBACK FORM
    // ========================================================================

    /**
     * Get the current sub-view/tab for the active page
     * Each page object tracks its own currentView property
     */
    function getCurrentSubView() {
      var page = Platform.activePage;
      try {
        switch(page) {
          case 'sep':
            return (typeof SEP !== 'undefined' && SEP.currentView) ? SEP.currentView : null;
          case 'team':
            return (typeof Team !== 'undefined' && Team.currentView) ? Team.currentView : null;
          case 'comms':
            return (typeof COMMS !== 'undefined' && COMMS.currentView) ? COMMS.currentView : null;
          case 'implementation':
            return (typeof Implementation !== 'undefined' && Implementation.currentView) ? Implementation.currentView : null;
          case 'contacts':
            return (typeof Contacts !== 'undefined' && Contacts.currentView) ? Contacts.currentView : null;
          case 'reports':
            return (typeof Reports !== 'undefined' && Reports.currentView) ? Reports.currentView : null;
          default:
            return null;
        }
      } catch (e) {
        return null;
      }
    }

    function openFeedbackModal() {
      // Auto-fill current page with sub-view if available
      var pageName = Platform.activePage || 'unknown';
      var pageDisplay = pageName.charAt(0).toUpperCase() + pageName.slice(1);

      var subView = getCurrentSubView();
      var subViewDisplay = '';
      if (subView) {
        // Capitalize first letter of sub-view
        subViewDisplay = subView.charAt(0).toUpperCase() + subView.slice(1);
        // Convert camelCase to Title Case (e.g., "parkingLot" -> "Parking Lot")
        subViewDisplay = subViewDisplay.replace(/([A-Z])/g, ' $1').trim();
        pageDisplay += ' > ' + subViewDisplay;
      }

      // Reset form first
      document.getElementById('feedbackForm').reset();

      // Then set values
      document.getElementById('feedbackPage').value = pageDisplay;
      document.getElementById('feedbackSubpage').value = subViewDisplay;
      toggleStepsField();

      // Show modal
      document.getElementById('feedbackModal').classList.add('active');
    }

    function closeFeedbackModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('feedbackModal').classList.remove('active');
    }

    function toggleStepsField() {
      var type = document.getElementById('feedbackType').value;
      var isBug = (type === 'bug');
      document.getElementById('stepsGroup').style.display = isBug ? 'block' : 'none';
      document.getElementById('categoryGroup').style.display = isBug ? 'block' : 'none';
    }

    function submitFeedback(event) {
      event.preventDefault();

      var btn = document.getElementById('feedbackSubmitBtn');
      var originalHtml = btn.innerHTML;
      btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Sending...';
      btn.disabled = true;

      var feedbackType = document.getElementById('feedbackType').value;
      var feedback = {
        type: feedbackType,
        page: document.getElementById('feedbackPage').value,
        subpage: document.getElementById('feedbackSubpage').value || '',
        category: (feedbackType === 'bug') ? document.getElementById('feedbackCategory').value : '',
        description: document.getElementById('feedbackDescription').value,
        steps: document.getElementById('feedbackSteps').value || '',
        name: document.getElementById('feedbackName').value || 'Anonymous',
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent
      };

      google.script.run
        .withSuccessHandler(function(result) {
          btn.innerHTML = originalHtml;
          btn.disabled = false;

          if (result && result.success) {
            closeFeedbackModal();
            var msg = 'Feedback sent! Thank you for helping improve the platform.';
            if (result.bugId) {
              msg += ' (Reference: ' + result.bugId + ')';
            }
            showToast(msg, 'success');
          } else {
            showToast('Failed to send feedback. Please try again.', 'error');
          }
        })
        .withFailureHandler(function(error) {
          btn.innerHTML = originalHtml;
          btn.disabled = false;
          showToast('Could not send feedback. Please try again.', 'error');
        })
        .submitFeedback(feedback);
    }

    // ========================================================================
    // SHARED UTILITY FUNCTIONS
    // ========================================================================

    /**
     * Global HTML escape function - available to all pages
     * Use for escaping text content in innerHTML
     */
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /**
     * Global attribute escape function - available to all pages
     * Use for escaping values in HTML attributes (onclick, href, etc.)
     */
    function escapeAttr(text) {
      if (text === null || text === undefined) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    /**
     * Global URL linkification function - available to all pages
     * Converts URLs in pre-escaped HTML text to clickable links
     * Call AFTER escapeHtml() since this adds HTML anchor tags
     */
    function linkifyUrls(text) {
      if (!text) return '';
      // Match URLs (http, https, or www) - note: text is already HTML-escaped
      // so & appears as &amp; in query strings
      var urlPattern = /(https?:\/\/[^\s<]+|www\.[^\s<]+)/gi;
      return text.replace(urlPattern, function(url) {
        var href = url;
        // Add protocol if www. link
        if (url.indexOf('www.') === 0) {
          href = 'https://' + url;
        }
        return '<a href="' + href + '" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary); word-break: break-all;">' + url + '</a>';
      });
    }

    /**
     * Global text formatter that handles markdown links and plain URLs
     * Use this instead of escapeHtml() when displaying user content that may contain links
     * Handles: [link text](url) markdown syntax and plain http/https/www URLs
     */
    function formatTextWithLinks(text) {
      if (!text) return '';

      // Step 1: Extract markdown links [text](url) before escaping
      var links = [];
      var placeholder = '\u0000LINK';
      var processed = String(text).replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, linkText, url) {
        var index = links.length;
        links.push({ text: linkText, url: url });
        return placeholder + index + '\u0000';
      });

      // Step 2: Escape HTML for security
      processed = escapeHtml(processed);

      // Step 3: Linkify plain URLs (http, https, www)
      processed = linkifyUrls(processed);

      // Step 4: Restore markdown links as HTML anchor tags
      links.forEach(function(link, index) {
        var safeUrl = escapeHtml(link.url);
        var safeText = escapeHtml(link.text);
        var anchor = '<a href="' + safeUrl + '" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary);">' + safeText + '</a>';
        processed = processed.replace(placeholder + index + '\u0000', anchor);
      });

      return processed;
    }

    /**
     * Sanitize HTML to allow only safe formatting elements
     * Used for rich text fields that accept pasted formatted content
     */
    function sanitizeHtml(html) {
      if (!html) return '';
      // Strip HTML comments (e.g., <!--StartFragment-->)
      html = html.replace(/<!--[\s\S]*?-->/g, '');
      var div = document.createElement('div');
      div.innerHTML = html;

      // Remove script tags and event handlers
      var scripts = div.querySelectorAll('script, style');
      scripts.forEach(function(el) { el.remove(); });

      // Walk through all elements and clean them
      var allElements = div.querySelectorAll('*');
      allElements.forEach(function(el) {
        // Remove unsafe/unnecessary attributes (keep only href, target, rel for links)
        var safeAttrs = ['href', 'target', 'rel'];
        Array.from(el.attributes).forEach(function(attr) {
          if (!safeAttrs.includes(attr.name)) {
            el.removeAttribute(attr.name);
          }
        });

        // Only allow safe tags
        var safeTags = ['A', 'B', 'STRONG', 'I', 'EM', 'U', 'UL', 'OL', 'LI', 'BR', 'P', 'DIV', 'SPAN'];
        if (!safeTags.includes(el.tagName)) {
          // Replace with text content or children
          var parent = el.parentNode;
          while (el.firstChild) {
            parent.insertBefore(el.firstChild, el);
          }
          parent.removeChild(el);
        }

        // For links, ensure they open in new tab and have safe attributes
        if (el.tagName === 'A') {
          var href = el.getAttribute('href') || '';
          // Only allow http, https, mailto links
          if (!href.match(/^(https?:|mailto:)/i)) {
            el.removeAttribute('href');
          }
          el.setAttribute('target', '_blank');
          el.setAttribute('rel', 'noopener noreferrer');
        }
      });

      return div.innerHTML;
    }

    /**
     * Initialize a rich text field (contenteditable div)
     * Handles paste sanitization and placeholder behavior
     */
    function initRichTextField(fieldId, placeholderText) {
      var field = document.getElementById(fieldId);
      if (!field) return;

      // Set placeholder via data attribute
      field.setAttribute('data-placeholder', placeholderText || 'Enter text...');

      // Handle paste - sanitize HTML
      field.addEventListener('paste', function(e) {
        e.preventDefault();
        var html = e.clipboardData.getData('text/html');
        var text = e.clipboardData.getData('text/plain');

        if (html) {
          // Paste as sanitized HTML
          var clean = sanitizeHtml(html);
          document.execCommand('insertHTML', false, clean);
        } else {
          // Paste as plain text
          document.execCommand('insertText', false, text);
        }
      });

      // Handle placeholder visibility
      field.addEventListener('focus', function() {
        if (field.textContent.trim() === '') {
          field.classList.add('has-focus');
        }
      });

      field.addEventListener('blur', function() {
        field.classList.remove('has-focus');
      });

      field.addEventListener('input', function() {
        if (field.textContent.trim() === '') {
          field.classList.remove('has-content');
        } else {
          field.classList.add('has-content');
        }
      });
    }

    /**
     * Get content from a rich text field
     */
    function getRichTextContent(fieldId) {
      var field = document.getElementById(fieldId);
      if (!field) return '';
      // Check if field is effectively empty (just whitespace or <br> tags)
      if (!field.textContent.trim()) return '';
      return sanitizeHtml(field.innerHTML);
    }

    /**
     * Set content in a rich text field
     */
    function setRichTextContent(fieldId, html) {
      var field = document.getElementById(fieldId);
      if (!field) return;
      field.innerHTML = sanitizeHtml(html || '');
      if (html && html.trim()) {
        field.classList.add('has-content');
      } else {
        field.classList.remove('has-content');
      }
    }

    /**
     * Display rich content - handles both HTML (new) and plain text (legacy) data
     * If content contains HTML tags, sanitizes and displays as HTML
     * If content is plain text, uses formatTextWithLinks for URL detection
     */
    function displayRichContent(content) {
      if (!content) return '';
      // Check if content appears to be HTML (contains tags)
      if (/<[a-z][\s\S]*>/i.test(content)) {
        return sanitizeHtml(content);
      }
      // Plain text - use formatTextWithLinks for URL/markdown detection
      return formatTextWithLinks(content);
    }

    /**
     * Global notes formatter - renders HTML content or converts plain text.
     * If content contains HTML tags, renders as-is (trusted internal content).
     * If plain text, converts URLs to links and newlines to <br>.
     */
    function formatNotesHtml(text) {
      if (text === null || text === undefined) return '';
      var str = String(text);

      // Check if content already contains HTML tags (trusted rich content)
      if (/<[a-z][\s\S]*>/i.test(str)) {
        // Already HTML - render as-is, just ensure links open in new tab
        return str.replace(/<a\s+(?![^>]*target=)/gi, '<a target="_blank" rel="noopener" ');
      }

      // Plain text - escape HTML and convert URLs/newlines
      var escaped = escapeHtml(str);
      var urlRegex = /(https?:\/\/[^\s<]+)/g;
      var linked = escaped.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
      return linked.replace(/\n/g, '<br>');
    }

    /**
     * Global Toast Notification System
     * Usage: showToast('Message', 'success|error|warning|info', duration)
     * BACKLOG: Not executing in GAS environment - needs investigation
     */
    window.showToast = function(message, type, duration) {
      type = type || 'info';
      duration = duration || 5000;

      var container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container';
        container.setAttribute('role', 'status');
        container.setAttribute('aria-live', 'polite');
        container.setAttribute('aria-label', 'Notifications');
        document.body.appendChild(container);
      }

      var icons = {
        success: 'check_circle',
        error: 'error',
        warning: 'warning',
        info: 'info'
      };

      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      // Security: Escape message to prevent XSS injection
      var safeMessage = escapeHtml(message);
      toast.innerHTML =
        '<span class="toast-icon"><span class="material-icons">' + icons[type] + '</span></span>' +
        '<span class="toast-content">' + safeMessage + '</span>' +
        '<button class="toast-close" onclick="this.parentElement.remove()" aria-label="Dismiss notification"><span class="material-icons" aria-hidden="true">close</span></button>';

      container.appendChild(toast);

      setTimeout(function() {
        toast.classList.add('removing');
        setTimeout(function() {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 300);
      }, duration);

      return toast;
    };

    window.showSuccess = function(message, duration) {
      return showToast(message, 'success', duration);
    };

    window.showError = function(message, duration) {
      return showToast(message, 'error', duration || 8000);
    };

    // ========================================================================
    // FLUSH DEFERRED PAGE INIT QUEUE
    // ========================================================================
    // Page scripts (server-side includes above) queue their init calls
    // because DataCache/CachedAPI aren't defined yet when they execute.
    // Now that everything is defined, run them.
    (function() {
      if (window._pageInitQueue && _pageInitQueue.length > 0) {
        console.log('[Platform] Flushing ' + _pageInitQueue.length + ' queued page init(s)');
        for (var i = 0; i < _pageInitQueue.length; i++) {
          try {
            _pageInitQueue[i]();
          } catch (e) {
            console.error('[Platform] Page init error:', e);
          }
        }
        _pageInitQueue = [];
      }
    })();

  </script>
</body>
</html>
