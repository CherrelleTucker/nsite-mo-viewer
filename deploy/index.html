<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base target="_top">
  <title>MO-Viewer | NSITE MO Dashboard</title>

  <!-- Favicon - Blue grid icon to distinguish from Apps Script -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230B3D91'/%3E%3Crect x='5' y='5' width='9' height='9' rx='2' fill='white'/%3E%3Crect x='18' y='5' width='9' height='9' rx='2' fill='white'/%3E%3Crect x='5' y='18' width='9' height='9' rx='2' fill='white'/%3E%3Crect x='18' y='18' width='9' height='9' rx='2' fill='%2300A3E0'/%3E%3C/svg%3E">

  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- Platform Styles (inline for Apps Script) -->
  <?!= include('styles'); ?>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1 class="logo">
        <span class="logo-icon" data-feather="grid"></span>
        MO-Viewer
      </h1>
      <span class="subtitle">NSITE MO Dashboard</span>
    </div>
    <div class="header-right">
      <span class="date-display" id="dateDisplay"></span>
      <span class="user-email" id="userEmail"></span>
    </div>
  </header>

  <!-- Navigation -->
  <?!= include('navigation'); ?>

  <!-- Main Content Area -->
  <main class="main-content">
    <div class="content-wrapper" id="contentArea">
      <? if (activePage === 'implementation') { ?>
        <?!= include('implementation'); ?>
      <? } else if (activePage === 'sep') { ?>
        <?!= include('sep'); ?>
      <? } else if (activePage === 'quick-update') { ?>
        <?!= include('quick-update'); ?>
      <? } else if (activePage === 'contacts') { ?>
        <?!= include('contacts'); ?>
      <? } else if (activePage === 'schedule') { ?>
        <?!= include('schedule'); ?>
      <? } else if (activePage === 'reports') { ?>
        <?!= include('reports'); ?>
      <? } else { ?>
        <!-- Placeholder for pages not yet built -->
        <div class="page-placeholder">
          <h2><?= pageConfig ? pageConfig.title : activePage ?>-NSITE</h2>
          <p class="page-description">This viewer is coming soon.</p>
          <div class="placeholder-box">
            <span data-feather="tool"></span>
            <p>Component under development</p>
            <p class="text-sm text-muted mt-md">Use the navigation above to access available features.</p>
          </div>
        </div>
      <? } ?>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <span>MO-Viewer v1.0.0</span>
    <span class="separator">|</span>
    <span>NSITE MO</span>
    <span class="separator">|</span>
    <span id="lastSync">Last sync: --</span>
  </footer>

  <!-- Platform JavaScript -->
  <script>
    // ========================================================================
    // PLATFORM CONFIGURATION
    // ========================================================================

    var Platform = {
      activePage: '<?= activePage ?>',
      baseUrl: '<?= ScriptApp.getService().getUrl() ?>',
      config: null,
      user: null
    };

    // ========================================================================
    // INITIALIZATION
    // ========================================================================

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Feather Icons
      feather.replace();

      // Load platform config
      google.script.run
        .withSuccessHandler(function(config) {
          Platform.config = config;
          Platform.baseUrl = config.baseUrl;
          updateNavActiveState();
        })
        .withFailureHandler(handleError)
        .getPlatformConfig();

      // Load user info
      google.script.run
        .withSuccessHandler(function(user) {
          Platform.user = user;
          document.getElementById('userEmail').textContent = user.email;
        })
        .withFailureHandler(handleError)
        .getCurrentUser();

      // Load date info
      google.script.run
        .withSuccessHandler(function(dateInfo) {
          document.getElementById('dateDisplay').textContent =
            dateInfo.dayOfWeek + ', ' + dateInfo.formatted;
        })
        .withFailureHandler(handleError)
        .getDateInfo();

      // Update navigation active state
      updateNavActiveState();
    });

    // ========================================================================
    // NAVIGATION
    // ========================================================================

    var isNavigating = false;

    function navigateTo(page) {
      // Prevent double-clicks and multiple navigations
      if (isNavigating) {
        console.log('Navigation already in progress');
        return;
      }

      // Don't navigate to current page
      if (page === Platform.activePage) {
        console.log('Already on page:', page);
        return;
      }

      isNavigating = true;

      // Show loading state on clicked tab
      var clickedTab = document.querySelector('[data-page="' + page + '"]');
      if (clickedTab) {
        clickedTab.classList.add('loading');
      }

      // Disable all nav tabs during navigation
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.disabled = true;
      });

      // Get base URL - prefer the server-rendered value, fall back to current URL
      var baseUrl = Platform.baseUrl;
      if (!baseUrl || baseUrl === 'undefined' || baseUrl === '') {
        // Extract base URL from current location (remove any existing query params)
        baseUrl = window.location.href.split('?')[0];
      }

      console.log('Navigating to:', page, 'baseUrl:', baseUrl);
      window.location.href = baseUrl + '?page=' + page;
    }

    function updateNavActiveState() {
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.classList.remove('active');
      });

      var activeTab = document.querySelector('[data-page="' + Platform.activePage + '"]');
      if (activeTab) {
        activeTab.classList.add('active');
      }
    }

    // ========================================================================
    // ERROR HANDLING
    // ========================================================================

    function handleError(error) {
      console.error('Platform error:', error);
    }
  </script>
</body>
</html>
