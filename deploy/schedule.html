<!-- Schedule View -->
<!-- Timeline and Gantt view of milestones across solutions -->

<!-- Google Charts -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<div class="schedule-viewer">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title">
      <h1>Schedule</h1>
    </div>
    <div class="page-actions">
      <!-- View Toggle -->
      <div class="view-toggle">
        <button class="view-btn active" id="btnTimeline" data-view="timeline" onclick="Schedule.setView('timeline')">
          <span class="material-icons">list</span>
          <span>Timeline</span>
        </button>
        <button class="view-btn" id="btnGantt" data-view="gantt" onclick="Schedule.setView('gantt')">
          <span class="material-icons">bar_chart</span>
          <span>Gantt</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Stats Summary -->
  <div class="schedule-stats">
    <div class="stat-card">
      <div class="stat-icon icon-warning">
        <span class="material-icons">schedule</span>
      </div>
      <div class="stat-info">
        <span class="stat-value" id="statUpcoming">--</span>
        <span class="stat-label">Upcoming (90 days)</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon icon-error">
        <span class="material-icons">error</span>
      </div>
      <div class="stat-info">
        <span class="stat-value" id="statOverdue">--</span>
        <span class="stat-label">Overdue</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon icon-success">
        <span class="material-icons">check_circle</span>
      </div>
      <div class="stat-info">
        <span class="stat-value" id="statCompleted">--</span>
        <span class="stat-label">Completed (YTD)</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon icon-info">
        <span class="material-icons">calendar_today</span>
      </div>
      <div class="stat-info">
        <span class="stat-value" id="statTotal">--</span>
        <span class="stat-label">Total Scheduled</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <div class="filter-group" id="filterViewGroup">
      <label class="filter-label">View:</label>
      <select class="form-select filter-select" id="filterView" onchange="Schedule.applyFilters()">
        <option value="upcoming">Upcoming</option>
        <option value="all">All Milestones</option>
        <option value="overdue">Overdue</option>
        <option value="completed">Completed</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Type:</label>
      <select class="form-select filter-select" id="filterType" onchange="Schedule.applyFilters()">
        <option value="">All Types</option>
        <option value="atp">ATP DG</option>
        <option value="f2i">F2I DG</option>
        <option value="orr">ORR</option>
        <option value="closeout">Closeout DG</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Cycle:</label>
      <select class="form-select filter-select" id="filterCycle" onchange="Schedule.applyFilters()">
        <option value="">All Cycles</option>
        <option value="1">C1</option>
        <option value="2">C2</option>
        <option value="3">C3</option>
        <option value="4">C4</option>
        <option value="5">C5</option>
      </select>
    </div>
    <div class="filter-search">
      <span class="material-icons">search</span>
      <input type="text" class="form-input search-input" id="filterSearch"
             placeholder="Search solutions..."
             oninput="Schedule.applyFilters()">
    </div>
    <button class="btn btn-secondary btn-sm" onclick="Schedule.clearFilters()">
      Clear
    </button>
    <button class="btn btn-secondary btn-sm" onclick="Schedule.exportData()">
      <span class="material-icons">download</span>
      Export
    </button>
  </div>

  <!-- Timeline View -->
  <div class="schedule-timeline" id="scheduleTimeline">
    <div class="loading-state">
      <span class="loading-spinner"></span>
      <p>Loading schedule...</p>
    </div>
  </div>

  <!-- Gantt View -->
  <div class="schedule-gantt" id="scheduleGantt" style="display: none;">
    <div class="gantt-container" id="ganttChart">
      <div class="loading-state">
        <span class="loading-spinner"></span>
        <p>Loading Gantt chart...</p>
      </div>
    </div>
    <div class="gantt-legend">
      <span class="legend-item"><span class="legend-color" style="background: #eab308;"></span> Formulation (ATP → F2I)</span>
      <span class="legend-item"><span class="legend-color" style="background: #f97316;"></span> Implementation (F2I → ORR)</span>
      <span class="legend-item"><span class="legend-color" style="background: #3b82f6;"></span> Operations (ORR → Closeout)</span>
    </div>
  </div>
</div>

<!-- Schedule Styles -->
<style>
  .schedule-viewer {
    --page-accent: var(--color-primary);
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Stats */
  .schedule-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .stat-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .stat-icon svg { width: 24px; height: 24px; }

  .stat-icon.icon-warning { background: rgba(237, 108, 2, 0.1); color: var(--color-warning); }
  .stat-icon.icon-error { background: rgba(211, 47, 47, 0.1); color: var(--color-error); }
  .stat-icon.icon-success { background: rgba(46, 125, 50, 0.1); color: var(--color-success); }
  .stat-icon.icon-info { background: rgba(2, 136, 209, 0.1); color: var(--color-info); }

  .stat-info { display: flex; flex-direction: column; }
  .stat-value { font-size: var(--font-size-xl); font-weight: 700; color: var(--color-text); }
  .stat-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); }

  /* Filter Bar */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
  }

  .filter-group { display: flex; align-items: center; gap: var(--space-sm); }
  .filter-label { font-size: var(--font-size-sm); font-weight: 500; color: var(--color-text-secondary); }
  .filter-select { min-width: 120px; padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-sm); }
  .filter-search { flex: 1; min-width: 200px; position: relative; }
  .filter-search .search-icon { position: absolute; left: var(--space-sm); top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--color-text-muted); }
  .filter-search .search-input { padding-left: 36px; width: 100%; }

  /* Timeline */
  .schedule-timeline {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .timeline-month {
    border-bottom: 1px solid var(--color-border-light);
  }

  .timeline-month:last-child { border-bottom: none; }

  .timeline-month-header {
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface-alt);
    font-weight: 600;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .timeline-month-header:hover { background: var(--color-border-light); }

  .timeline-month-count {
    font-size: var(--font-size-xs);
    background: var(--color-primary);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
  }

  .timeline-items { padding: var(--space-sm); }

  .timeline-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
    transition: background var(--transition-fast);
  }

  .timeline-item:last-child { margin-bottom: 0; }
  .timeline-item:hover { background: var(--color-surface-alt); }

  .timeline-date {
    min-width: 80px;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
  }

  .timeline-type {
    min-width: 80px;
    padding: 4px 10px;
    font-size: var(--font-size-xs);
    font-weight: 600;
    border-radius: var(--radius-sm);
    text-align: center;
  }

  .type-atp { background: rgba(234, 179, 8, 0.15); color: #ca8a04; }
  .type-f2i { background: rgba(249, 115, 22, 0.15); color: #ea580c; }
  .type-orr { background: rgba(59, 130, 246, 0.15); color: #2563eb; }
  .type-closeout { background: rgba(16, 185, 129, 0.15); color: #059669; }

  .timeline-solution {
    flex: 1;
    font-size: var(--font-size-sm);
    color: var(--color-text);
  }

  .timeline-solution-name { font-weight: 500; }
  .timeline-solution-cycle { color: var(--color-text-muted); font-size: var(--font-size-xs); margin-left: var(--space-xs); }

  .timeline-status {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: 10px;
  }

  .status-upcoming { background: rgba(2, 136, 209, 0.1); color: var(--color-info); }
  .status-overdue { background: rgba(211, 47, 47, 0.1); color: var(--color-error); }
  .status-completed { background: rgba(46, 125, 50, 0.1); color: var(--color-success); }
  .status-today { background: rgba(237, 108, 2, 0.15); color: var(--color-warning); font-weight: 600; }

  /* Gantt */
  .schedule-gantt {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .gantt-container {
    min-height: 400px;
    padding: var(--space-md);
  }

  .gantt-legend {
    display: flex;
    gap: var(--space-lg);
    padding: var(--space-md);
    border-top: 1px solid var(--color-border-light);
    background: var(--color-surface-alt);
    justify-content: center;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .legend-color {
    width: 16px;
    height: 16px;
    border-radius: var(--radius-xs);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-xxl);
    color: var(--color-text-muted);
  }

  .empty-state svg { width: 48px; height: 48px; margin-bottom: var(--space-md); opacity: 0.5; }

  /* Responsive */
  @media (max-width: 1024px) {
    .schedule-stats { grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 768px) {
    .schedule-stats { grid-template-columns: 1fr; }
    .filter-bar { flex-direction: column; align-items: stretch; }
    .filter-group { justify-content: space-between; }
    .timeline-item { flex-wrap: wrap; }
    .timeline-date { min-width: 100%; margin-bottom: var(--space-xs); }
  }
</style>

<!-- Schedule JavaScript -->
<script>
var Schedule = (function() {
  var state = {
    solutions: [],
    milestones: [],
    filteredMilestones: [],
    filteredSolutions: [],
    currentView: 'timeline',
    chartsLoaded: false
  };

  // Phase colors for Gantt
  var PHASE_COLORS = {
    formulation: '#eab308',    // Yellow - ATP to F2I
    implementation: '#f97316', // Orange - F2I to ORR
    operations: '#3b82f6'      // Blue - ORR to Closeout
  };

  function init() {
    loadGoogleCharts();
    loadSolutions();
  }

  function loadGoogleCharts() {
    if (typeof google !== 'undefined' && google.charts) {
      google.charts.load('current', { packages: ['gantt'] });
      google.charts.setOnLoadCallback(function() {
        state.chartsLoaded = true;
        if (state.currentView === 'gantt' && state.solutions.length > 0) {
          renderGantt();
        }
      });
    }
  }

  function loadSolutions() {
    google.script.run
      .withSuccessHandler(function(solutions) {
        state.solutions = solutions || [];
        buildMilestoneList();
        updateStats();
        applyFilters();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load solutions:', error);
        showError('Failed to load schedule data.');
      })
      .getSolutions();
  }

  function buildMilestoneList() {
    state.milestones = [];
    var today = new Date();
    today.setHours(0, 0, 0, 0);

    state.solutions.forEach(function(sol) {
      if (sol.milestone_atp_date) {
        state.milestones.push(createMilestone(sol, 'atp', 'ATP DG', sol.milestone_atp_date, today));
      }
      if (sol.milestone_f2i_date) {
        state.milestones.push(createMilestone(sol, 'f2i', 'F2I DG', sol.milestone_f2i_date, today));
      }
      if (sol.milestone_orr_date) {
        state.milestones.push(createMilestone(sol, 'orr', 'ORR', sol.milestone_orr_date, today));
      }
      if (sol.milestone_closeout_date) {
        state.milestones.push(createMilestone(sol, 'closeout', 'Closeout DG', sol.milestone_closeout_date, today));
      }
    });

    state.milestones.sort(function(a, b) {
      return a.dateObj - b.dateObj;
    });
  }

  function createMilestone(sol, type, label, dateVal, today) {
    var dateObj = parseDate(dateVal);
    var status = 'upcoming';

    if (dateObj) {
      if (dateObj < today) {
        status = 'completed';
      } else if (dateObj.getTime() === today.getTime()) {
        status = 'today';
      }
    }

    return {
      solution_id: sol.core_id,
      solution_name: sol.core_id || sol.core_id,
      cycle: sol.core_cycle,
      type: type,
      label: label,
      date: dateVal,
      dateObj: dateObj,
      dateFormatted: formatDate(dateObj),
      monthKey: dateObj ? dateObj.getFullYear() + '-' + String(dateObj.getMonth() + 1).padStart(2, '0') : 'Unknown',
      monthLabel: dateObj ? formatMonthYear(dateObj) : 'Unknown',
      status: status
    };
  }

  function parseDate(val) {
    if (!val) return null;
    if (val instanceof Date) return val;
    var d = new Date(val);
    return isNaN(d.getTime()) ? null : d;
  }

  function formatDate(d) {
    if (!d) return '--';
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function formatMonthYear(d) {
    if (!d) return 'Unknown';
    return d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  }

  function updateStats() {
    var upcoming = 0, overdue = 0, completed = 0, total = 0;

    state.milestones.forEach(function(m) {
      if (!m.dateObj) return;
      total++;

      if (m.status === 'completed') {
        completed++;
      } else if (m.status === 'overdue') {
        overdue++;
      } else if (m.status === 'upcoming' || m.status === 'today') {
        upcoming++;
      }
    });

    document.getElementById('statUpcoming').textContent = upcoming;
    document.getElementById('statOverdue').textContent = overdue;
    document.getElementById('statCompleted').textContent = completed;
    document.getElementById('statTotal').textContent = total;
  }

  function setView(view) {
    state.currentView = view;

    // Update toggle buttons
    document.getElementById('btnTimeline').classList.toggle('active', view === 'timeline');
    document.getElementById('btnGantt').classList.toggle('active', view === 'gantt');

    // Update filter visibility (Type filter doesn't apply to Gantt)
    var filterViewGroup = document.getElementById('filterViewGroup');
    var filterType = document.getElementById('filterType').parentElement;
    if (view === 'gantt') {
      filterViewGroup.style.display = 'none';
      filterType.style.display = 'none';
    } else {
      filterViewGroup.style.display = 'flex';
      filterType.style.display = 'flex';
    }

    // Show/hide views
    document.getElementById('scheduleTimeline').style.display = view === 'timeline' ? 'block' : 'none';
    document.getElementById('scheduleGantt').style.display = view === 'gantt' ? 'block' : 'none';

    // Render appropriate view
    if (view === 'gantt') {
      renderGantt();
    } else {
      render();
    }
  }

  function applyFilters() {
    var viewFilter = document.getElementById('filterView').value;
    var typeFilter = document.getElementById('filterType').value;
    var cycleFilter = document.getElementById('filterCycle').value;
    var searchFilter = document.getElementById('filterSearch').value.toLowerCase().trim();

    var today = new Date();
    today.setHours(0, 0, 0, 0);

    // Filter milestones (for timeline view)
    state.filteredMilestones = state.milestones.filter(function(m) {
      if (viewFilter === 'upcoming' && (!m.dateObj || m.dateObj < today)) return false;
      if (viewFilter === 'overdue' && m.status !== 'overdue') return false;
      if (viewFilter === 'completed' && m.status !== 'completed') return false;
      if (typeFilter && m.type !== typeFilter) return false;
      if (cycleFilter && String(m.cycle) !== cycleFilter) return false;
      if (searchFilter && m.solution_name.toLowerCase().indexOf(searchFilter) === -1) return false;
      return true;
    });

    // Filter solutions (for gantt view)
    state.filteredSolutions = state.solutions.filter(function(sol) {
      if (cycleFilter && String(sol.core_cycle) !== cycleFilter) return false;
      var name = (sol.core_id || sol.core_id || '').toLowerCase();
      if (searchFilter && name.indexOf(searchFilter) === -1) return false;
      // Must have at least two dates to show on gantt
      var dates = [sol.milestone_atp_date, sol.milestone_f2i_date, sol.milestone_orr_date, sol.milestone_closeout_date].filter(function(d) { return !!d; });
      return dates.length >= 2;
    });

    if (state.currentView === 'timeline') {
      render();
    } else {
      renderGantt();
    }
  }

  function clearFilters() {
    document.getElementById('filterView').value = 'upcoming';
    document.getElementById('filterType').value = '';
    document.getElementById('filterCycle').value = '';
    document.getElementById('filterSearch').value = '';
    applyFilters();
  }

  function render() {
    var container = document.getElementById('scheduleTimeline');

    if (state.filteredMilestones.length === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">calendar_today</span><p>No milestones match your filters</p></div>';
      return;
    }

    var byMonth = {};
    state.filteredMilestones.forEach(function(m) {
      if (!byMonth[m.monthKey]) {
        byMonth[m.monthKey] = { label: m.monthLabel, items: [] };
      }
      byMonth[m.monthKey].items.push(m);
    });

    var monthKeys = Object.keys(byMonth).sort();

    var html = '';
    monthKeys.forEach(function(key) {
      var month = byMonth[key];
      html += '<div class="timeline-month">';
      html += '<div class="timeline-month-header">';
      html += '<span>' + escapeHtml(month.label) + '</span>';
      html += '<span class="timeline-month-count">' + month.items.length + '</span>';
      html += '</div>';
      html += '<div class="timeline-items">';

      month.items.forEach(function(m) {
        html += '<div class="timeline-item">';
        html += '<span class="timeline-date">' + m.dateFormatted + '</span>';
        html += '<span class="timeline-type type-' + m.type + '">' + m.label + '</span>';
        html += '<span class="timeline-solution">';
        html += '<span class="timeline-solution-name">' + escapeHtml(m.solution_name) + '</span>';
        html += '<span class="timeline-solution-cycle">C' + m.cycle + '</span>';
        html += '</span>';
        html += '<span class="timeline-status status-' + m.status + '">' + capitalizeFirst(m.status) + '</span>';
        html += '</div>';
      });

      html += '</div></div>';
    });

    container.innerHTML = html;
  }

  function renderGantt() {
    var container = document.getElementById('ganttChart');

    if (!state.chartsLoaded) {
      container.innerHTML = '<div class="loading-state"><span class="loading-spinner"></span><p>Loading chart library...</p></div>';
      return;
    }

    if (state.filteredSolutions.length === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">bar_chart</span><p>No solutions with multiple milestones match your filters</p></div>';
      return;
    }

    // Build Gantt data
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Task ID');
    data.addColumn('string', 'Task Name');
    data.addColumn('string', 'Resource');
    data.addColumn('date', 'Start Date');
    data.addColumn('date', 'End Date');
    data.addColumn('number', 'Duration');
    data.addColumn('number', 'Percent Complete');
    data.addColumn('string', 'Dependencies');

    var rows = [];
    var today = new Date();
    today.setHours(0, 0, 0, 0);

    state.filteredSolutions.forEach(function(sol) {
      var atp = parseDate(sol.milestone_atp_date);
      var f2i = parseDate(sol.milestone_f2i_date);
      var orr = parseDate(sol.milestone_orr_date);
      var closeout = parseDate(sol.milestone_closeout_date);
      var name = sol.core_id || sol.core_id;
      var cycle = 'C' + sol.core_cycle;

      // Formulation phase: ATP → F2I
      if (atp && f2i) {
        var pct = calculateProgress(atp, f2i, today);
        rows.push([
          sol.core_id + '_form',
          name + ' - Formulation',
          cycle,
          atp,
          f2i,
          null,
          pct,
          null
        ]);
      }

      // Implementation phase: F2I → ORR
      if (f2i && orr) {
        var pct = calculateProgress(f2i, orr, today);
        var dep = (atp && f2i) ? sol.core_id + '_form' : null;
        rows.push([
          sol.core_id + '_impl',
          name + ' - Implementation',
          cycle,
          f2i,
          orr,
          null,
          pct,
          dep
        ]);
      }

      // Operations phase: ORR → Closeout
      if (orr && closeout) {
        var pct = calculateProgress(orr, closeout, today);
        var dep = (f2i && orr) ? sol.core_id + '_impl' : null;
        rows.push([
          sol.core_id + '_ops',
          name + ' - Operations',
          cycle,
          orr,
          closeout,
          null,
          pct,
          dep
        ]);
      }
    });

    if (rows.length === 0) {
      container.innerHTML = '<div class="empty-state"><span class="material-icons">bar_chart</span><p>No phase data available for selected solutions</p></div>';
      return;
    }

    data.addRows(rows);

    var options = {
      height: Math.max(400, rows.length * 42 + 50),
      gantt: {
        trackHeight: 36,
        barHeight: 24,
        labelStyle: {
          fontName: 'Inter, system-ui, sans-serif',
          fontSize: 12,
          color: '#374151'
        },
        palette: [
          { color: PHASE_COLORS.formulation, dark: '#ca8a04', light: '#fef3c7' },
          { color: PHASE_COLORS.implementation, dark: '#ea580c', light: '#ffedd5' },
          { color: PHASE_COLORS.operations, dark: '#2563eb', light: '#dbeafe' }
        ],
        criticalPathEnabled: false,
        innerGridHorizLine: { stroke: '#e5e7eb', strokeWidth: 1 },
        innerGridTrack: { fill: '#f9fafb' },
        innerGridDarkTrack: { fill: '#f3f4f6' }
      }
    };

    var chart = new google.visualization.Gantt(container);
    chart.draw(data, options);
  }

  function calculateProgress(startDate, endDate, today) {
    if (today >= endDate) return 100;
    if (today <= startDate) return 0;
    var total = endDate - startDate;
    var elapsed = today - startDate;
    return Math.round((elapsed / total) * 100);
  }

  function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // escapeHtml() - uses global from index.html

  function showError(message) {
    var container = document.getElementById('scheduleTimeline');
    container.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>' + message + '</p></div>';
  }

  function exportToCSV(data, columns, filename) {
    if (!data || data.length === 0) {
      alert('No data to export');
      return;
    }

    // Build CSV header
    var csv = columns.map(function(col) { return '"' + col.label + '"'; }).join(',') + '\n';

    // Build CSV rows
    data.forEach(function(row) {
      var values = columns.map(function(col) {
        var val = row[col.key];
        if (val === null || val === undefined) val = '';
        // Escape quotes and wrap in quotes
        return '"' + String(val).replace(/"/g, '""') + '"';
      });
      csv += values.join(',') + '\n';
    });

    // Download
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename + '_' + new Date().toISOString().slice(0, 10) + '.csv';
    link.click();
  }

  function exportData() {
    // Export milestones to CSV
    var columns = [
      { key: 'solution_name', label: 'Solution' },
      { key: 'type', label: 'Milestone Type' },
      { key: 'label', label: 'Label' },
      { key: 'dateFormatted', label: 'Date' },
      { key: 'status', label: 'Status' },
      { key: 'cycle', label: 'Selection Cycle' }
    ];

    var dataToExport = state.filteredMilestones && state.filteredMilestones.length > 0
      ? state.filteredMilestones
      : state.milestones;
    exportToCSV(dataToExport, columns, 'milestones_export');
  }

  return {
    init: init,
    setView: setView,
    applyFilters: applyFilters,
    clearFilters: clearFilters,
    exportData: exportData
  };
})();

// Initialize
if (typeof google !== 'undefined' && google.script) {
  Schedule.init();
} else {
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof google !== 'undefined' && google.script) {
      Schedule.init();
    }
  });
}
</script>
