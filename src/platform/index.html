<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base target="_top">
  <title>MO-Viewer | NSITE MO Dashboard</title>

  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- Platform Styles -->
  <?!= includeCSS('platform/styles'); ?>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1 class="logo">
        <span class="logo-icon" data-feather="grid"></span>
        MO-Viewer
      </h1>
      <span class="subtitle">NSITE MO Dashboard</span>
    </div>
    <div class="header-right">
      <span class="date-display" id="dateDisplay"></span>
      <span class="user-email" id="userEmail"></span>
    </div>
  </header>

  <!-- Navigation -->
  <?!= include('platform/navigation'); ?>

  <!-- Main Content Area -->
  <main class="main-content">
    <div class="content-wrapper" id="contentArea">
      <!-- Page content loaded here -->
      <div class="loading-state">
        <span class="loading-spinner"></span>
        <p>Loading...</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <span>MO-Viewer v1.0.0</span>
    <span class="separator">|</span>
    <span>NSITE MO</span>
    <span class="separator">|</span>
    <span id="lastSync">Last sync: --</span>
  </footer>

  <!-- Platform JavaScript -->
  <script>
    // ========================================================================
    // PLATFORM CONFIGURATION
    // ========================================================================

    var Platform = {
      activePage: '<?= activePage ?>',
      baseUrl: '',
      config: null,
      user: null
    };

    // ========================================================================
    // INITIALIZATION
    // ========================================================================

    /**
     * Initialize platform on page load
     */
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Feather Icons
      feather.replace();

      // Load platform config
      google.script.run
        .withSuccessHandler(function(config) {
          Platform.config = config;
          Platform.baseUrl = config.baseUrl;
          updateNavActiveState();
        })
        .withFailureHandler(handleError)
        .getPlatformConfig();

      // Load user info
      google.script.run
        .withSuccessHandler(function(user) {
          Platform.user = user;
          document.getElementById('userEmail').textContent = user.email;
        })
        .withFailureHandler(handleError)
        .getCurrentUser();

      // Load date info
      google.script.run
        .withSuccessHandler(function(dateInfo) {
          document.getElementById('dateDisplay').textContent =
            dateInfo.dayOfWeek + ', ' + dateInfo.formatted;
        })
        .withFailureHandler(handleError)
        .getDateInfo();

      // Load active page content
      loadPageContent(Platform.activePage);
    });

    // ========================================================================
    // NAVIGATION
    // ========================================================================

    /**
     * Navigate to a page
     * @param {string} page - Page identifier
     */
    function navigateTo(page) {
      // Update URL without reload (for bookmarking)
      var newUrl = Platform.baseUrl + '?page=' + page;
      history.pushState({ page: page }, '', newUrl);

      // Update active state
      Platform.activePage = page;
      updateNavActiveState();

      // Load content
      loadPageContent(page);
    }

    /**
     * Update navigation active state
     */
    function updateNavActiveState() {
      // Remove active from all tabs
      document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.classList.remove('active');
      });

      // Add active to current tab
      var activeTab = document.querySelector('[data-page="' + Platform.activePage + '"]');
      if (activeTab) {
        activeTab.classList.add('active');
      }
    }

    /**
     * Handle browser back/forward
     */
    window.addEventListener('popstate', function(event) {
      if (event.state && event.state.page) {
        Platform.activePage = event.state.page;
        updateNavActiveState();
        loadPageContent(Platform.activePage);
      }
    });

    // ========================================================================
    // CONTENT LOADING
    // ========================================================================

    /**
     * Load page content into main area
     * @param {string} page - Page identifier
     */
    function loadPageContent(page) {
      var contentArea = document.getElementById('contentArea');

      // Show loading state
      contentArea.innerHTML = '<div class="loading-state">' +
        '<span class="loading-spinner"></span>' +
        '<p>Loading ' + page + '...</p></div>';

      // Load viewer content based on page
      if (page === 'implementation') {
        // Load Implementation-NSITE viewer
        google.script.run
          .withSuccessHandler(function(html) {
            contentArea.innerHTML = html;
            feather.replace();
            // Initialize the Implementation module if it exists
            if (typeof Implementation !== 'undefined' && Implementation.init) {
              Implementation.init();
            }
          })
          .withFailureHandler(function(error) {
            contentArea.innerHTML = '<div class="empty-state">' +
              '<span data-feather="alert-circle"></span>' +
              '<p>Failed to load Implementation-NSITE: ' + error.message + '</p></div>';
            feather.replace();
          })
          .getImplementationViewerHTML();
      } else {
        // Show placeholder for other pages (coming soon)
        setTimeout(function() {
          var pageContent = getPagePlaceholder(page);
          contentArea.innerHTML = pageContent;
          feather.replace();
        }, 300);
      }
    }

    /**
     * Get placeholder content for page
     * @param {string} page - Page identifier
     * @returns {string} HTML content
     */
    function getPagePlaceholder(page) {
      var titles = {
        'implementation': 'Implementation-NSITE',
        'sep': 'SEP-NSITE',
        'comms': 'Comms-NSITE',
        'quick-update': 'Quick Update Form',
        'contacts': 'Contacts',
        'reports': 'Reports',
        'schedule': 'Schedule',
        'actions': 'Action Tracker'
      };

      var descriptions = {
        'implementation': 'Solution and project tracking for NSITE MO Implementation team',
        'sep': 'Stakeholder engagement tracking - SEP is in sight',
        'comms': 'Communications and story tracking - Comms is in sight',
        'quick-update': 'Submit updates to meeting notes documents',
        'contacts': 'Stakeholder, admin, and outreach contact lists',
        'reports': 'Milestone reports and status exports',
        'schedule': 'Deep dives, decision gates, and events calendar',
        'actions': 'Unified action tracker across all sources'
      };

      return '<div class="page-placeholder">' +
        '<h2>' + (titles[page] || page) + '</h2>' +
        '<p class="page-description">' + (descriptions[page] || '') + '</p>' +
        '<div class="placeholder-box">' +
        '<span data-feather="tool"></span>' +
        '<p>Component coming in Phase ' + getPhaseNumber(page) + '</p>' +
        '</div></div>';
    }

    /**
     * Get phase number for page
     * @param {string} page - Page identifier
     * @returns {number} Phase number
     */
    function getPhaseNumber(page) {
      var phases = {
        'implementation': 2,
        'quick-update': 3,
        'sep': 4,
        'comms': 5,
        'contacts': 6,
        'reports': 6,
        'schedule': 6,
        'actions': 6
      };
      return phases[page] || 0;
    }

    // ========================================================================
    // ERROR HANDLING
    // ========================================================================

    /**
     * Handle errors from server calls
     * @param {Error} error - Error object
     */
    function handleError(error) {
      console.error('Platform error:', error);
      // Could show toast notification here
    }

    // ========================================================================
    // UTILITY FUNCTIONS
    // ========================================================================

    /**
     * Format date for display
     * @param {string} isoDate - ISO date string
     * @returns {string} Formatted date
     */
    function formatDate(isoDate) {
      var date = new Date(isoDate);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    /**
     * Debounce function for search inputs
     * @param {Function} func - Function to debounce
     * @param {number} wait - Wait time in ms
     * @returns {Function} Debounced function
     */
    function debounce(func, wait) {
      var timeout;
      return function() {
        var context = this;
        var args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(function() {
          func.apply(context, args);
        }, wait);
      };
    }
  </script>
</body>
</html>
