<!-- Implementation-NSITE Viewer -->
<!-- Solution tracking dashboard for NSITE MO Implementation team -->

<div class="implementation-viewer">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title">
      <h1>Implementation-NSITE</h1>
      <p class="page-subtitle">Solution tracking and status dashboard</p>
    </div>
    <div class="page-actions">
      <button class="btn btn-secondary" onclick="Implementation.exportData()">
        <span data-feather="download"></span>
        Export
      </button>
      <button class="btn btn-primary" onclick="Implementation.syncSolutions()">
        <span data-feather="refresh-cw"></span>
        Sync
      </button>
    </div>
  </div>

  <!-- Stats Summary -->
  <div class="stats-grid" id="implementationStats">
    <div class="stat-card">
      <div class="stat-value" id="statTotalSolutions">--</div>
      <div class="stat-label">Total Solutions</div>
    </div>
    <div class="stat-card stat-green">
      <div class="stat-value" id="statOperational">--</div>
      <div class="stat-label">Production / Operational</div>
    </div>
    <div class="stat-card stat-blue">
      <div class="stat-value" id="statImplementation">--</div>
      <div class="stat-label">In Implementation</div>
    </div>
    <div class="stat-card stat-orange">
      <div class="stat-value" id="statFormulation">--</div>
      <div class="stat-label">Pre-Formulation / Formulation</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <div class="filter-group">
      <label class="filter-label">Cycle:</label>
      <select class="form-select filter-select" id="filterCycle" onchange="Implementation.applyFilters()">
        <option value="">All Cycles</option>
        <option value="1">Cycle 1 (2016)</option>
        <option value="2">Cycle 2 (2018)</option>
        <option value="3">Cycle 3 (2020)</option>
        <option value="4">Cycle 4 (2022)</option>
        <option value="5">Cycle 5 (2024)</option>
        <option value="6">Cycle 6 (2026)</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Phase:</label>
      <select class="form-select filter-select" id="filterPhase" onchange="Implementation.applyFilters()">
        <option value="">All Phases</option>
        <option value="Pre-Formulation">Pre-Formulation</option>
        <option value="Formulation">Formulation</option>
        <option value="Implementation">Implementation</option>
        <option value="Production / Operational">Production / Operational</option>
        <option value="Completed">Completed</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Group:</label>
      <select class="form-select filter-select" id="filterGroup" onchange="Implementation.applyFilters()">
        <option value="">All Groups</option>
        <!-- Populated dynamically -->
      </select>
    </div>
    <div class="filter-search">
      <span data-feather="search" class="search-icon"></span>
      <input type="text" class="form-input search-input" id="filterSearch"
             placeholder="Search solutions..."
             oninput="Implementation.applyFilters()">
    </div>
    <button class="btn btn-secondary btn-sm" onclick="Implementation.clearFilters()">
      Clear
    </button>
  </div>

  <!-- Solutions by Cycle -->
  <div class="solutions-container" id="solutionsContainer">
    <!-- Loading state -->
    <div class="loading-state">
      <span class="loading-spinner"></span>
      <p>Loading solutions...</p>
    </div>
  </div>
</div>

<!-- Implementation-NSITE Styles -->
<style>
  .implementation-viewer {
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Page Header */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-lg);
  }

  .page-title h1 {
    font-size: var(--font-size-xxl);
    color: var(--color-implementation);
    margin-bottom: var(--space-xs);
  }

  .page-subtitle {
    color: var(--color-text-secondary);
    font-size: var(--font-size-md);
  }

  .page-actions {
    display: flex;
    gap: var(--space-sm);
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .stat-card {
    background: var(--color-surface);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    text-align: center;
    border-left: 4px solid var(--color-border);
  }

  .stat-card.stat-green { border-left-color: var(--color-success); }
  .stat-card.stat-blue { border-left-color: var(--color-info); }
  .stat-card.stat-orange { border-left-color: var(--color-warning); }

  .stat-value {
    font-size: var(--font-size-xxl);
    font-weight: 700;
    color: var(--color-text);
  }

  .stat-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-top: var(--space-xs);
  }

  /* Filter Bar */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .filter-label {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .filter-select {
    min-width: 150px;
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
  }

  .filter-search {
    flex: 1;
    min-width: 200px;
    position: relative;
  }

  .filter-search .search-icon {
    position: absolute;
    left: var(--space-sm);
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    color: var(--color-text-muted);
  }

  .filter-search .search-input {
    padding-left: 36px;
    width: 100%;
  }

  /* Cycle Section */
  .cycle-section {
    margin-bottom: var(--space-lg);
  }

  .cycle-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    cursor: pointer;
    margin-bottom: var(--space-md);
    transition: background var(--transition-fast);
  }

  .cycle-header:hover {
    background: var(--color-surface-alt);
  }

  .cycle-header .chevron {
    width: 20px;
    height: 20px;
    transition: transform var(--transition-fast);
  }

  .cycle-header.collapsed .chevron {
    transform: rotate(-90deg);
  }

  .cycle-title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--color-text);
  }

  .cycle-count {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-left: auto;
  }

  .cycle-solutions {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-md);
  }

  .cycle-solutions.collapsed {
    display: none;
  }

  /* Solution Card */
  .solution-card {
    background: var(--color-surface);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    padding: var(--space-md);
    display: flex;
    flex-direction: column;
    transition: box-shadow var(--transition-fast), transform var(--transition-fast);
  }

  .solution-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .solution-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-sm);
  }

  .solution-name {
    font-weight: 600;
    font-size: var(--font-size-md);
    color: var(--color-text);
    cursor: pointer;
  }

  .solution-name:hover {
    color: var(--color-implementation);
  }

  .solution-id {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    font-family: monospace;
  }

  .solution-badges {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
  }

  .phase-badge {
    padding: 2px 8px;
    font-size: var(--font-size-xs);
    font-weight: 500;
    border-radius: 12px;
    white-space: nowrap;
  }

  .phase-pre-formulation { background: #FFF8E1; color: #F57F17; }
  .phase-formulation { background: #FFF3E0; color: #E65100; }
  .phase-implementation { background: #E3F2FD; color: #1565C0; }
  .phase-operational { background: #E8F5E9; color: #2E7D32; }
  .phase-completed { background: #ECEFF1; color: #546E7A; }

  .solution-meta {
    display: flex;
    gap: var(--space-md);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-sm);
    flex-wrap: wrap;
  }

  .solution-meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .solution-meta-item svg {
    width: 14px;
    height: 14px;
  }

  .solution-lead {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-sm);
  }

  .solution-lead strong {
    color: var(--color-text);
  }

  .solution-status {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    flex: 1;
    margin-bottom: var(--space-sm);
    line-height: 1.4;
    max-height: 3.6em;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .solution-actions {
    display: flex;
    gap: var(--space-sm);
    margin-top: auto;
    padding-top: var(--space-sm);
    border-top: 1px solid var(--color-border-light);
  }

  .solution-action-btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    background: var(--color-surface-alt);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .solution-action-btn:hover {
    background: var(--color-primary);
    color: white;
  }

  .solution-action-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--space-xxl);
    color: var(--color-text-muted);
  }

  .empty-state svg {
    width: 48px;
    height: 48px;
    margin-bottom: var(--space-md);
    opacity: 0.5;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      gap: var(--space-md);
    }

    .page-actions {
      width: 100%;
    }

    .page-actions .btn {
      flex: 1;
    }

    .stats-grid {
      grid-template-columns: 1fr 1fr;
    }

    .filter-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-group {
      justify-content: space-between;
    }

    .cycle-solutions {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Implementation-NSITE JavaScript -->
<script>
  // ========================================================================
  // IMPLEMENTATION-NSITE MODULE
  // ========================================================================

  var Implementation = (function() {
    // State
    var state = {
      solutions: [],
      filteredSolutions: [],
      groups: [],
      collapsedCycles: {}
    };

    // ======================================================================
    // INITIALIZATION
    // ======================================================================

    /**
     * Initialize the Implementation viewer
     */
    function init() {
      loadSolutions();
    }

    /**
     * Load solutions from database
     */
    function loadSolutions() {
      google.script.run
        .withSuccessHandler(function(solutions) {
          state.solutions = solutions || [];
          extractGroups();
          updateStats();
          applyFilters();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load solutions:', error);
          showError('Failed to load solutions. Please try again.');
        })
        .getSolutions();
    }

    /**
     * Extract unique solution groups for filter
     */
    function extractGroups() {
      var groups = {};
      state.solutions.forEach(function(sol) {
        if (sol.solution_group && sol.solution_group.trim()) {
          groups[sol.solution_group.trim()] = true;
        }
      });
      state.groups = Object.keys(groups).sort();
      populateGroupFilter();
    }

    /**
     * Populate group filter dropdown
     */
    function populateGroupFilter() {
      var select = document.getElementById('filterGroup');
      var currentValue = select.value;

      // Keep "All Groups" option
      select.innerHTML = '<option value="">All Groups</option>';

      state.groups.forEach(function(group) {
        var option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        select.appendChild(option);
      });

      // Restore previous selection if still valid
      if (currentValue && state.groups.indexOf(currentValue) !== -1) {
        select.value = currentValue;
      }
    }

    // ======================================================================
    // STATS
    // ======================================================================

    /**
     * Update statistics display
     */
    function updateStats() {
      var total = state.solutions.length;
      var operational = 0;
      var implementation = 0;
      var formulation = 0;

      state.solutions.forEach(function(sol) {
        var phase = (sol.phase || '').toLowerCase();
        if (phase.indexOf('operational') !== -1 || phase.indexOf('production') !== -1) {
          operational++;
        } else if (phase.indexOf('implementation') !== -1) {
          implementation++;
        } else if (phase.indexOf('formulation') !== -1) {
          formulation++;
        }
      });

      document.getElementById('statTotalSolutions').textContent = total;
      document.getElementById('statOperational').textContent = operational;
      document.getElementById('statImplementation').textContent = implementation;
      document.getElementById('statFormulation').textContent = formulation;
    }

    // ======================================================================
    // FILTERING
    // ======================================================================

    /**
     * Apply filters and re-render
     */
    function applyFilters() {
      var cycleFilter = document.getElementById('filterCycle').value;
      var phaseFilter = document.getElementById('filterPhase').value;
      var groupFilter = document.getElementById('filterGroup').value;
      var searchFilter = document.getElementById('filterSearch').value.toLowerCase().trim();

      state.filteredSolutions = state.solutions.filter(function(sol) {
        // Cycle filter
        if (cycleFilter && String(sol.cycle) !== cycleFilter) {
          return false;
        }

        // Phase filter
        if (phaseFilter && sol.phase !== phaseFilter) {
          return false;
        }

        // Group filter
        if (groupFilter && sol.solution_group !== groupFilter) {
          return false;
        }

        // Search filter
        if (searchFilter) {
          var searchable = [
            sol.solution_id,
            sol.name,
            sol.full_title,
            sol.solution_lead,
            sol.solution_group,
            sol.purpose_mission
          ].join(' ').toLowerCase();

          if (searchable.indexOf(searchFilter) === -1) {
            return false;
          }
        }

        return true;
      });

      render();
    }

    /**
     * Clear all filters
     */
    function clearFilters() {
      document.getElementById('filterCycle').value = '';
      document.getElementById('filterPhase').value = '';
      document.getElementById('filterGroup').value = '';
      document.getElementById('filterSearch').value = '';
      applyFilters();
    }

    // ======================================================================
    // RENDERING
    // ======================================================================

    /**
     * Render solutions organized by cycle
     */
    function render() {
      var container = document.getElementById('solutionsContainer');

      if (state.filteredSolutions.length === 0) {
        container.innerHTML = '<div class="empty-state">' +
          '<span data-feather="inbox"></span>' +
          '<p>No solutions match your filters</p>' +
          '</div>';
        feather.replace();
        return;
      }

      // Group solutions by cycle
      var byCycle = {};
      state.filteredSolutions.forEach(function(sol) {
        var cycle = sol.cycle || 'Unknown';
        if (!byCycle[cycle]) {
          byCycle[cycle] = [];
        }
        byCycle[cycle].push(sol);
      });

      // Sort cycles (most recent first)
      var cycles = Object.keys(byCycle).sort(function(a, b) {
        return parseInt(b) - parseInt(a);
      });

      // Build HTML
      var html = '';
      cycles.forEach(function(cycle) {
        var solutions = byCycle[cycle];
        var isCollapsed = state.collapsedCycles[cycle] || false;
        var cycleYear = getCycleYear(cycle);

        html += '<div class="cycle-section" data-cycle="' + cycle + '">';
        html += '<div class="cycle-header' + (isCollapsed ? ' collapsed' : '') + '" onclick="Implementation.toggleCycle(\'' + cycle + '\')">';
        html += '<span data-feather="chevron-down" class="chevron"></span>';
        html += '<span class="badge badge-c' + cycle + '">C' + cycle + '</span>';
        html += '<span class="cycle-title">Cycle ' + cycle + (cycleYear ? ' (' + cycleYear + ')' : '') + '</span>';
        html += '<span class="cycle-count">' + solutions.length + ' solution' + (solutions.length !== 1 ? 's' : '') + '</span>';
        html += '</div>';

        html += '<div class="cycle-solutions' + (isCollapsed ? ' collapsed' : '') + '">';
        solutions.forEach(function(sol) {
          html += renderSolutionCard(sol);
        });
        html += '</div>';
        html += '</div>';
      });

      container.innerHTML = html;
      feather.replace();
    }

    /**
     * Render a single solution card
     */
    function renderSolutionCard(sol) {
      var phaseClass = getPhaseClass(sol.phase);
      var statusSummary = truncateText(sol.status_summary, 150);

      var html = '<div class="solution-card">';

      // Header
      html += '<div class="solution-card-header">';
      html += '<div>';
      html += '<div class="solution-name" onclick="Implementation.showDetail(\'' + sol.solution_id + '\')">' + escapeHtml(sol.name) + '</div>';
      html += '<div class="solution-id">' + escapeHtml(sol.solution_id) + '</div>';
      html += '</div>';
      html += '<div class="solution-badges">';
      html += '<span class="phase-badge ' + phaseClass + '">' + escapeHtml(sol.phase || 'Unknown') + '</span>';
      html += '</div>';
      html += '</div>';

      // Meta info
      html += '<div class="solution-meta">';
      if (sol.solution_group) {
        html += '<span class="solution-meta-item"><span data-feather="folder"></span>' + escapeHtml(sol.solution_group) + '</span>';
      }
      if (sol.funded_by_ison === 'Y') {
        html += '<span class="solution-meta-item"><span data-feather="dollar-sign"></span>ISON Funded</span>';
      }
      html += '</div>';

      // Lead
      if (sol.solution_lead) {
        html += '<div class="solution-lead"><strong>Lead:</strong> ' + escapeHtml(sol.solution_lead);
        if (sol.solution_lead_affiliation) {
          html += ' (' + escapeHtml(sol.solution_lead_affiliation) + ')';
        }
        html += '</div>';
      }

      // Status summary
      if (statusSummary) {
        html += '<div class="solution-status">' + escapeHtml(statusSummary) + '</div>';
      }

      // Actions
      html += '<div class="solution-actions">';
      if (sol.drive_folder_url) {
        html += '<a href="' + escapeHtml(sol.drive_folder_url) + '" target="_blank" class="solution-action-btn">';
        html += '<span data-feather="folder"></span>Drive</a>';
      }
      if (sol.snwg_solution_page_url) {
        html += '<a href="' + escapeHtml(sol.snwg_solution_page_url) + '" target="_blank" class="solution-action-btn">';
        html += '<span data-feather="external-link"></span>Earthdata</a>';
      }
      html += '<button class="solution-action-btn" onclick="Implementation.showDetail(\'' + sol.solution_id + '\')">';
      html += '<span data-feather="info"></span>Details</button>';
      html += '</div>';

      html += '</div>';
      return html;
    }

    /**
     * Toggle cycle section collapse
     */
    function toggleCycle(cycle) {
      state.collapsedCycles[cycle] = !state.collapsedCycles[cycle];

      var section = document.querySelector('.cycle-section[data-cycle="' + cycle + '"]');
      if (section) {
        var header = section.querySelector('.cycle-header');
        var solutions = section.querySelector('.cycle-solutions');

        if (state.collapsedCycles[cycle]) {
          header.classList.add('collapsed');
          solutions.classList.add('collapsed');
        } else {
          header.classList.remove('collapsed');
          solutions.classList.remove('collapsed');
        }
      }
    }

    // ======================================================================
    // SOLUTION DETAIL
    // ======================================================================

    /**
     * Show solution detail modal/panel
     */
    function showDetail(solutionId) {
      var solution = state.solutions.find(function(s) {
        return s.solution_id === solutionId;
      });

      if (!solution) {
        console.error('Solution not found:', solutionId);
        return;
      }

      // For now, show in an alert. In future, this will be a modal.
      var info = [
        '=== ' + solution.name + ' ===',
        '',
        'ID: ' + solution.solution_id,
        'Cycle: ' + solution.cycle + ' (' + getCycleYear(solution.cycle) + ')',
        'Phase: ' + solution.phase,
        'Funding: ' + (solution.funded_by_ison === 'Y' ? 'ISON Funded' : 'Not ISON'),
        '',
        'Solution Lead: ' + (solution.solution_lead || 'TBD'),
        'Affiliation: ' + (solution.solution_lead_affiliation || '-'),
        '',
        'RA Representative: ' + (solution.ra_representative || '-'),
        '',
        '--- Purpose ---',
        solution.purpose_mission || 'No description available.',
        '',
        '--- Status ---',
        solution.status_summary || 'No status update.'
      ].join('\n');

      alert(info);
    }

    // ======================================================================
    // ACTIONS
    // ======================================================================

    /**
     * Sync solutions from source
     */
    function syncSolutions() {
      alert('Sync functionality coming soon. Will refresh data from MO-DB_Solutions.');
      loadSolutions();
    }

    /**
     * Export solutions data
     */
    function exportData() {
      alert('Export functionality coming soon. Will export filtered solutions to CSV.');
    }

    // ======================================================================
    // HELPERS
    // ======================================================================

    /**
     * Get cycle year from cycle number
     */
    function getCycleYear(cycle) {
      var years = {
        '1': '2016',
        '2': '2018',
        '3': '2020',
        '4': '2022',
        '5': '2024',
        '6': '2026'
      };
      return years[String(cycle)] || '';
    }

    /**
     * Get CSS class for phase badge
     */
    function getPhaseClass(phase) {
      if (!phase) return 'phase-unknown';
      var p = phase.toLowerCase();
      if (p.indexOf('pre-formulation') !== -1) return 'phase-pre-formulation';
      if (p.indexOf('formulation') !== -1) return 'phase-formulation';
      if (p.indexOf('implementation') !== -1) return 'phase-implementation';
      if (p.indexOf('operational') !== -1 || p.indexOf('production') !== -1) return 'phase-operational';
      if (p.indexOf('complete') !== -1) return 'phase-completed';
      return 'phase-unknown';
    }

    /**
     * Truncate text with ellipsis
     */
    function truncateText(text, maxLength) {
      if (!text) return '';
      // Strip HTML tags first
      text = text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength).trim() + '...';
    }

    /**
     * Escape HTML for safe display
     */
    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * Show error message
     */
    function showError(message) {
      var container = document.getElementById('solutionsContainer');
      container.innerHTML = '<div class="empty-state">' +
        '<span data-feather="alert-circle"></span>' +
        '<p>' + message + '</p>' +
        '</div>';
      feather.replace();
    }

    // ======================================================================
    // PUBLIC API
    // ======================================================================

    return {
      init: init,
      loadSolutions: loadSolutions,
      applyFilters: applyFilters,
      clearFilters: clearFilters,
      toggleCycle: toggleCycle,
      showDetail: showDetail,
      syncSolutions: syncSolutions,
      exportData: exportData
    };
  })();

  // Initialize when content loads
  if (typeof google !== 'undefined' && google.script) {
    Implementation.init();
  }
</script>
